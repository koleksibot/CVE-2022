<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>About Service Worker and Pwa - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Service Worker is a script that the browser runs in the background independent of the web page. A PWA (Progressive Web App) is a web application, but similar in look and feel to a native app. Before we talk about Service Worker and PWA, let&amp;rsquo;s take a brief look at what Web Worker is. Web Worker What is Web Worker? The Web Worker is a built-in thread in the browser" /><meta name="keywords" content="service-worker,pwa" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-06/about-service-worker-and-pwa/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="About Service Worker and Pwa" />
<meta property="og:description" content="Service Worker is a script that the browser runs in the background independent of the web page. A PWA (Progressive Web App) is a web application, but similar in look and feel to a native app. Before we talk about Service Worker and PWA, let&rsquo;s take a brief look at what Web Worker is. Web Worker What is Web Worker? The Web Worker is a built-in thread in the browser" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-06/about-service-worker-and-pwa/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-27T18:18:13+08:00" />
<meta property="article:modified_time" content="2021-06-27T18:18:13+08:00" />

<meta itemprop="name" content="About Service Worker and Pwa">
<meta itemprop="description" content="Service Worker is a script that the browser runs in the background independent of the web page. A PWA (Progressive Web App) is a web application, but similar in look and feel to a native app. Before we talk about Service Worker and PWA, let&rsquo;s take a brief look at what Web Worker is. Web Worker What is Web Worker? The Web Worker is a built-in thread in the browser"><meta itemprop="datePublished" content="2021-06-27T18:18:13+08:00" />
<meta itemprop="dateModified" content="2021-06-27T18:18:13+08:00" />
<meta itemprop="wordCount" content="2761">
<meta itemprop="keywords" content="service-worker,pwa," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="About Service Worker and Pwa"/>
<meta name="twitter:description" content="Service Worker is a script that the browser runs in the background independent of the web page. A PWA (Progressive Web App) is a web application, but similar in look and feel to a native app. Before we talk about Service Worker and PWA, let&rsquo;s take a brief look at what Web Worker is. Web Worker What is Web Worker? The Web Worker is a built-in thread in the browser"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">About Service Worker and Pwa</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-27 18:18:13 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/web/"> web </a>
            </div>
          <span class="more-meta"> 2761 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#web-worker">Web Worker</a>
          <ul>
            <li><a href="#what-is-web-worker">What is Web Worker?</a></li>
            <li><a href="#type">Type</a></li>
            <li><a href="#restrictions">Restrictions</a></li>
          </ul>
        </li>
        <li><a href="#service-worker">Service Worker</a>
          <ul>
            <li><a href="#what-is-service-worker">What is Service Worker?</a></li>
            <li><a href="#advantages--disadvantages">Advantages / Disadvantages</a></li>
            <li><a href="#life-cycle">Life Cycle</a></li>
            <li><a href="#caching-and-return-requests">Caching and return requests</a></li>
            <li><a href="#browser-compatibility">Browser Compatibility</a></li>
          </ul>
        </li>
        <li><a href="#pwa">PWA</a>
          <ul>
            <li><a href="#what-is-a-pwa">What is a PWA?</a></li>
            <li><a href="#advantages--disadvantages-1">Advantages / Disadvantages</a></li>
            <li><a href="#core-technology">Core Technology</a></li>
            <li><a href="#app-shell">App Shell</a></li>
            <li><a href="#main-functions---all-depend-on-service-worker">Main functions - all depend on Service Worker</a></li>
          </ul>
        </li>
        <li><a href="#angular-based-pwa-message-notifications">Angular-based PWA message notifications</a>
          <ul>
            <li><a href="#in-the-first-step-the-client-requests-a-subscriber">In the first step, the client requests a subscriber.</a></li>
            <li><a href="#in-the-second-step-the-application-server-sends-the-api-of-the-web-push-protocol-standard-which-triggers-the-push-server-to-push-the-message">In the second step, the application server sends the api of the web push protocol standard, which triggers the push server to push the message.</a></li>
            <li><a href="#in-the-third-step-the-browser-side-receives-the-message-push-triggers-the-push-event-and-displays-it">In the third step, the browser side receives the message push, triggers the push event and displays it:</a></li>
            <li><a href="#main-code">Main Code</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><code>Service Worker</code> is a script that the browser runs in the background independent of the web page. A <code>PWA</code> (Progressive Web App) is a <code>web</code> application, but similar in look and feel to a native app. Before we talk about Service Worker and PWA, let&rsquo;s take a brief look at what Web Worker is.</p>
<h2 id="web-worker">Web Worker</h2>
<h3 id="what-is-web-worker">What is Web Worker?</h3>
<p>The <code>Web Worker</code> is a built-in thread in the browser so it can be used to execute non-blocking event loop <code>JavaScript</code> code. <code>js</code> is single-threaded and can only do one thing at a time. If there is a complex task, the thread will be blocked, which will seriously affect the user experience, <code>Web Worker</code> is used to allow the main thread to create <code>worker</code> threads that will work simultaneously with the main thread. The <code>worker</code> thread is only responsible for complex calculations, and then returns the results to the main thread. The simple understanding is that the <code>worker</code> thread performs complex calculations and the page (main thread) <code>ui</code> is smooth and does not block.</p>
<h3 id="type">Type</h3>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">Dedicated Workers</a>: [Dedicated <code>Worker</code>] are instantiated by the main process and can only communicate with the main thread.</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker">Shared Workers</a>: can be accessed by all processes running in the same source.</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API">Service workers</a>: [Service <code>Worker</code>] can control the web pages it is associated with, interpret and modify navigation, resource requests, and cache resources to give you great flexibility in controlling the behavior of the program in certain situations.</li>
</ol>
<h3 id="restrictions">Restrictions</h3>
<h4 id="homologous-restrictions">Homologous restrictions</h4>
<p>The script file assigned to the <code>Worker</code> thread to run must be the same source as the main thread&rsquo;s script file, which is usually placed under the project.</p>
<h4 id="dom-restrictions">DOM restrictions</h4>
<p><code>Web Workers</code> cannot access some very critical <code>JavaScript</code> features</p>
<ul>
<li><code>DOM</code> (it causes thread insecurity)</li>
<li><code>window</code> object</li>
<li><code>document</code> object
<code>parent</code> object</li>
</ul>
<h4 id="file-restrictions">File Restrictions</h4>
<p>For security reasons, the <code>worker</code> thread cannot read local files; the scripts it loads must come from the network and need to be the same source as the main thread&rsquo;s scripts.</p>
<h2 id="service-worker">Service Worker</h2>
<h3 id="what-is-service-worker">What is Service Worker?</h3>
<p>Introduction to <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API">MDN</a>: <code>Service workers</code> essentially acts as a proxy server between the <code>Web</code> application, the browser and the network (when available). This <code>API</code> is designed to create an effective offline experience by intercepting network requests and taking appropriate actions to update resources from the server based on network availability. It also provides a portal to push notifications and access to the backend synchronization <code>API</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/1750e37b6f0445a7bb9d8f61287bf90d.png" alt=" "></p>
<h3 id="advantages--disadvantages">Advantages / Disadvantages</h3>
<h4 id="优点">优点</h4>
<ul>
<li>Intercept network requests</li>
<li>Return cached content when cache is available</li>
<li>Manage cached content</li>
<li>Push information to clients</li>
<li>Backend data synchronization</li>
<li>Resource prefetching</li>
</ul>
<h4 id="disadvantages">Disadvantages</h4>
<ul>
<li>Limitations of Web Worker</li>
</ul>
<h3 id="life-cycle">Life Cycle</h3>
<p>The lifecycle of the <code>Service Worker</code> is completely separate from the <code>web</code> page. It consists of the following phases:</p>
<ul>
<li>Download</li>
<li>Install</li>
<li>Activate</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/4890e6eba42f481ba67830060604b39b.png" alt=" "></p>
<h4 id="download">Download</h4>
<p>The first time a user visits a website or page controlled by a <code>service worker</code>, the <code>service worker</code> is immediately downloaded. The browser will download the <code>.js</code> file containing the <code>Service Worker</code>.</p>
<h4 id="install">Install</h4>
<p>You need to register on the web page to install it. Before installation, you need to check if <code>serviceWorker</code> is supported, if it is, call <code>register()</code> every time the page is loaded and the browser will determine if it is registered. An important detail of the <code>register()</code> method is the location of the <code>Service Worker</code> file. In this case, you can see that the <code>Service Worker</code> file is located at the root of the domain, which means that the <code>Service Worker</code> scope will be under this domain. In other words, this <code>Service Worker</code> will receive <code>fetch</code> events for everything in this domain. If we register the <code>Service Worker</code> file with <code>/example/sw/sw.js</code>, then the <code>Service Worker</code> will only see <code>fetch</code> events for pages starting with <code>/example/</code> (e.g. <code>/example/page1/</code>, <code>/ example/page2/</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="s1">&#39;serviceWorker&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;/sw/sw.js&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Register successfully
</span><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ServiceWorker registration successful with scope: &#39;</span><span class="p">,</span> <span class="nx">registration</span><span class="p">.</span><span class="nx">scope</span><span class="p">);</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Registration failed
</span><span class="c1"></span>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ServiceWorker registration failed: &#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After successful registration, the <code>install</code> event will be triggered, which will call <code>caches.open()</code> with the cache name we want, followed by <code>cache.addAll()</code> and pass in an array of files. This is a <code>promise</code> chain (<code>caches.open()</code> and <code>cache.addAll()</code>). The <code>event.waitUntil()</code> method takes a <code>promise</code> and uses it to know how long the installation will take and whether it succeeded. If all files are successfully cached, then <code>Service Worker</code> will be installed. If one of the files fails to download, then the installation step will fail. If the list of cached files is too long, it will increase the chances of failure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">CACHE_NAME</span> <span class="o">=</span> <span class="s1">&#39;my-cache&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">urlsToCache</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">&#39;/&#39;</span><span class="p">,</span>
  <span class="s1">&#39;/styles/main.css&#39;</span><span class="p">,</span>
  <span class="s1">&#39;/script/main.js&#39;</span>
<span class="p">];</span>

<span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Opened cache&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">addAll</span><span class="p">(</span><span class="nx">urlsToCache</span><span class="p">);</span>
      <span class="p">})</span>
  <span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="activate">Activate</h4>
<p>The next step is to enter the activation state: <code>Activate</code>. In this state, you can update the <code>Service Worker</code>.</p>
<ul>
<li>When the user navigates to the site, the browser tries to re-download the script file that defines the <code>Service Worker</code> in the background. If there is a byte difference between the <code>Service Worker</code> file and the file it is currently using, it is treated as a new <code>Service Worker</code>.</li>
<li>The new <code>Service Worker</code> will start and the <code>install</code> event will be fired.</li>
<li>The old <code>Service Worker</code> is still in control of the current page, so the new <code>Service Worker will enter the waiting</code> state.</li>
<li>When the currently open page on the site is closed, the old <code>Service Worker</code> will be terminated and the new <code>Service Worker</code> will take control.</li>
<li>When the new <code>Service Worker</code> takes control, it will trigger its <code>activate</code> event.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;activate&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">cacheAllowlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pages-cache-v1&#39;</span><span class="p">,</span> <span class="s1">&#39;blog-posts-cache-v1&#39;</span><span class="p">];</span>
<span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cacheNames</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
        <span class="nx">cacheNames</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">cacheAllowlist</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">caches</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">);</span>
    <span class="p">})</span>
  <span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="caching-and-return-requests">Caching and return requests</h3>
<p>Strategies</p>
<ul>
<li>Cache Priority</li>
<li>Network First</li>
<li>Cache Only</li>
<li>Network Only</li>
<li>Speed Priority</li>
</ul>
<p>After the <code>Service Worker</code> is installed and the user goes to another page or refreshes the current page, the <code>Service Worker</code> will start receiving <code>fetch</code> events. Here is the cache-first strategy: first listen to the browser <code>fetch</code> event and intercept the original request. Check if the requested resource exists in the <code>cache</code>, and return it to the cache if it does. Then the resource is requested remotely, cached, and returned.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
     
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">fetchRequest</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">fetchRequest</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
       
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">response</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;basic&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">responseToCache</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

            <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">responseToCache</span><span class="p">);</span>
              <span class="p">});</span>

            <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">);</span>
      <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="browser-compatibility">Browser Compatibility</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/74124ff592cb4383bfb2a48e56c9a9f9.png" alt=" "></p>
<h2 id="pwa">PWA</h2>
<h3 id="what-is-a-pwa">What is a PWA?</h3>
<p><code>PWA</code> (<code>Progressive Web Apps</code>) uses modern <code>Web API</code> and traditional progressive enhancement strategies to create cross-platform <code>Web applications</code>.</p>
<h3 id="advantages--disadvantages-1">Advantages / Disadvantages</h3>
<h4 id="advantages">Advantages</h4>
<p>Discoverable, easy to install, linkable, network independent, progressive, reusable, responsive and secure.</p>
<ul>
<li>Progressive - works with all browsers, as it was developed with progressive enhancement in mind</li>
<li>Connection-agnostic - able to be accessed offline or in poor network conditions with the help of <code>Service Worker</code>.</li>
<li>Native-like - Since it is developed on the <code>App Shell</code> model, it should have the interaction of a <code>Native App</code> and give the user a <code>Native App</code> experience</li>
<li>Continuous updates - always up-to-date, no versioning and updating issues</li>
<li>Secure - Served over the <code>HTTPS</code> protocol to prevent snooping and ensure that content is not tampered with</li>
<li>Indexable - <code>manifest</code> files and <code>Service Worker</code> can be indexed by search engines to identify them as <code>apps</code></li>
<li>Sticky - users can be brought back by pushing offline notifications, etc.</li>
<li>Installable - users can add popular <code>Web Apps</code> to their desktops, eliminating the need to go to an app store to download them</li>
<li>Linkable - content can be shared through links without downloading and installing</li>
</ul>
<h4 id="disadvantages-1">Disadvantages</h4>
<ul>
<li>Low access to system functions</li>
<li>No review criteria</li>
</ul>
<h3 id="core-technology">Core Technology</h3>
<ol>
<li>
<p><code>Web App Manifest Web App Manifest</code> in a nutshell, a file that centrally writes page related information and configuration in the form of <code>JSON</code>.
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/29e9a296d1a146a690c6fcf28884fef7.png" alt=" "></p>
<ul>
<li><code>start_url</code> can set the start URL</li>
<li><code>icons</code> will help me set the page icons for each resolution</li>
<li><code>background_color</code> will set the background color, <code>Chrome</code> will use this color immediately after the web application is launched, and this color will remain on the screen until the web application is first presented</li>
<li><code>theme_color</code> sets the theme color</li>
<li><code>display</code> sets the startup style</li>
</ul>
</li>
<li>
<p>Service Worker</p>
</li>
<li>
<p>Notifications API</p>
</li>
<li>
<p>Push API, The Push API can be used to push new content from the server without client intervention, and is implemented by the application&rsquo;s Service Worker; the notifications can be sent to the client via the
<code>Service Worker</code> to show the user some new information, or at least to alert the user that the application has been updated with some features.</p>
</li>
</ol>
<h3 id="app-shell">App Shell</h3>
<p>An <code>App Shell</code> is the smallest collection of resources required for a page to be presented, i.e. the smallest collection of static resources such as <code>HTML</code>, <code>CSS</code> and <code>JavaScript</code> needed to support the user interface. The <code>App</code> <code>Shell</code> architecture is a way to build a <code>PWA</code> that loads reliably and instantly onto your user&rsquo;s screen, similar to a native <code>app</code>. Most <code>PWA</code>s are written as <code>Single Page Application</code>, which reduces the overhead of page bounces and allows developers to add transition animations on page transitions to avoid white screens on loading. The content on the page that is fixed during the page switch is then part of the <code>App Shell</code>. The application can be roughly divided into a content part and a shell part in terms of display content. The <code>App Shell</code> is the shell part, that is, the basic structure of the page. For example, <code>header</code>, <code>sidebar</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/e48703035a7641978a15607786e40353.png" alt=" "></p>
<h3 id="main-functions---all-depend-on-service-worker">Main functions - all depend on Service Worker</h3>
<h4 id="offline">Offline</h4>
<ul>
<li>Instead of displaying a &ldquo;no network connection&rdquo; error page, we can make our <code>Web App</code> accessible and even use some of its features without a network (offline).</li>
<li>In normal network conditions, it is also possible to save some of the requested bandwidth through various spontaneous and controlled caching methods</li>
<li>When the network is bad, we can use caching to access our application quickly and improve the experience.</li>
</ul>
<h4 id="back-office-synchronization">Back-office synchronization</h4>
<p>Background sync allows you to perform some interrupted requests or operations after closing the website. You need to listen to the <code>sync</code> event in the <code>Service Worker</code>. Launching a background sync <code>sync</code> in the browser will trigger the <code>sync</code> event in the <code>Service Worker</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// index.js
</span><span class="c1"></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">ready</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="s2">&#34;sample_sync&#34;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;js-sync-btn&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">registration</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">tag</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Background synchronization has been triggered&#39;</span><span class="p">,</span> <span class="nx">tag</span><span class="p">);</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Background synchronization trigger failure&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// sw.js
</span><span class="c1"></span><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`The service worker needs to perform background synchronization, tag: </span><span class="si">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;sample_sync&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="sb">`sync?name=AlienZHOU`</span><span class="p">,</span> <span class="nx">init</span><span class="p">);</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
            <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">));</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
            <span class="p">})</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="message-pushnotification">Message push/notification</h4>
<p>The <code>Push API</code> and the <code>Notification API</code> are different but complementary functions, the <code>Push API</code> is used to subscribe and push messages to the <code>Service Worker</code>, while the <code>Notification API</code> is used to send messages from the Service Worker to the user.</p>
<p>To complete a message push and display it, the following steps are required.</p>
<ol>
<li>web client registers SW and initiates a message subscription request to the push service, and saves the subscription information (subscription)</li>
<li>web server gets the subscription from the web client</li>
<li>web server sends a message to the destination in the subscription (endpoint, which contains the address of the push service)</li>
<li>push service receives the message and forwards it to browser</li>
<li>browser wakes up SW and sends the message to it</li>
<li>SW receives the message and displays it</li>
</ol>
<h5 id="push-service">push service</h5>
<p>A service associated with <code>browser</code> that is dedicated to handling notifications and is used to receive push messages from the <code>web server</code>. Each browser has its own <code>push service</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/49be3c886e6f452aa75bc41fd3936947.png" alt=" "></p>
<h2 id="angular-based-pwa-message-notifications">Angular-based PWA message notifications</h2>
<p>Use web-push to complete subscriptions and pushes.</p>
<h3 id="in-the-first-step-the-client-requests-a-subscriber">In the first step, the client requests a subscriber.</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/4a69886bd32842708f9274b8008b5bce.png" alt=" "></p>
<p>Once the user authorizes, the browser generates a <code>PushScription, pushSubscription</code> containing the public key and <code>endpointURL</code>, which can be used by the application server to encrypt the message when pushing, and <code>endpointURL</code> is a URL containing a unique identifier generated by the push server, which the push server The push server uses it to determine which client to send the message to.</p>
<h3 id="in-the-second-step-the-application-server-sends-the-api-of-the-web-push-protocol-standard-which-triggers-the-push-server-to-push-the-message">In the second step, the application server sends the api of the web push protocol standard, which triggers the push server to push the message.</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/6fdd21879a8046ca98dbbafad6a9e40a.png" alt=" "></p>
<p>The application server sends a message push request (for the purpose of pushing updates to the user&rsquo;s browser), and in order to send a request to the push server, it needs to look at the <code>PushScription</code> previously obtained and take out the <code>endpoint</code> in it, which is the access point configured by the push server for that user.</p>
<p>A <code>PushScription</code> object is as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;https://random-push-service.com/some-kind-of-unique-id-1234/v2/&#34;</span><span class="p">,</span>
  <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;p256dh&#34;</span> <span class="p">:</span>
<span class="s2">&#34;BNcRdreALRFXTkOOUHK1EtK2wtaz5Ry4YfYCA_0QTpQtUbVlUls0VJXg7A8u-Ts1XbjhazAkj7I99e8QcYP7DkM=&#34;</span><span class="p">,</span>
    <span class="nt">&#34;auth&#34;</span>   <span class="p">:</span> <span class="s2">&#34;tBHItJI5svbpez7KI4CCXg==&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>endpoint</code> is the destination of the message sent by the <code>web server</code>.</p>
<p>You can see that <code>chrome</code>&rsquo;s <code>push service</code> is running at <code>https://fcm.googleapis.com</code>, which is different for each browser, <code>firefox</code> is at <code>https://updates.push.services.mozilla.com</code> and <code> edge</code> is <code>https://sg2p.notify.windows.com</code>.</p>
<h3 id="in-the-third-step-the-browser-side-receives-the-message-push-triggers-the-push-event-and-displays-it">In the third step, the browser side receives the message push, triggers the push event and displays it:</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/0c513298cee64a8ebc694777e2f64a23.png" alt=" "></p>
<p>When the <code>push service</code> receives the message, it will notify the browser (if the browser is currently closed, it will receive a notification when it is opened next time), and the browser will wake up the corresponding <code>SW</code>, specifically by sending a <code>push</code> event to <code>SW</code>, which will handle the <code>push</code> event and pop up a small box to display the The message will be displayed.</p>
<h3 id="main-code">Main Code</h3>
<p>The user is first asked if subscription is turned on: <code>requestSubscription</code>, and if so, a <code>PushScription</code> object is obtained. When <code>subscribe</code> is called to generate <code>PushScription</code>, the browser sends a request to the staging server it specifies to generate the endpoint and the rest. After getting the <code>PushScription</code> object, it sends it to the application server for storage.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">subscribeToNotifications</span><span class="p">()</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">swPush</span><span class="p">.</span><span class="nx">requestSubscription</span><span class="p">({</span>
            <span class="nx">serverPublicKey</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">VAPID_PUBLIC_KEY</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">sub</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sub</span> <span class="o">=</span> <span class="nx">sub</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Notification Subscription: &#34;</span><span class="p">,</span> <span class="nx">sub</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">newsletterService</span><span class="p">.</span><span class="nx">addPushSubscriber</span><span class="p">(</span><span class="nx">sub</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span>
                <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sent push subscription object to server.&#39;</span><span class="p">),</span>
                <span class="nx">err</span> <span class="p">=&gt;</span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Could not send subscription object to server, reason: &#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Could not subscribe to notifications&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">));</span>

    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The application server sends a message, the <code>push service</code> receives the message and notifies the browser (if the browser is currently closed, it will receive a notification when it is opened next time), the browser wakes up the corresponding <code>SW</code>, specifically by sending a <code>push</code> event to the SW, the <code>SW</code> handles the <code>push</code> event, and pop up a small box to display the message. You can also set <code>action</code> or handle user clicks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"> <span class="kr">const</span> <span class="nx">notificationPayload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;notification&#34;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;Angular News&#34;</span><span class="p">,</span>
            <span class="s2">&#34;body&#34;</span><span class="o">:</span> <span class="s2">&#34;Newsletter Available!&#34;</span><span class="p">,</span>
            <span class="s2">&#34;icon&#34;</span><span class="o">:</span> <span class="s2">&#34;assets/main-page-logo-small-hat.png&#34;</span><span class="p">,</span>
            <span class="s2">&#34;vibrate&#34;</span><span class="o">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
            <span class="s2">&#34;data&#34;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&#34;dateOfArrival&#34;</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
                <span class="s2">&#34;primaryKey&#34;</span><span class="o">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&#34;actions&#34;</span><span class="o">:</span> <span class="p">[{</span>
                <span class="s2">&#34;action&#34;</span><span class="o">:</span> <span class="s2">&#34;explore&#34;</span><span class="p">,</span>
                <span class="s2">&#34;title&#34;</span><span class="o">:</span> <span class="s2">&#34;Go to the site&#34;</span>
            <span class="p">}]</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">USER_SUBSCRIPTIONS</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">sub</span> <span class="p">=&gt;</span> <span class="nx">webpush</span><span class="p">.</span><span class="nx">sendNotification</span><span class="p">(</span>
        <span class="nx">sub</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">notificationPayload</span><span class="p">)</span> <span class="p">)))</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Newsletter sent successfully.&#39;</span><span class="p">}))</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Error sending notification, reason: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
        <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/27/3a9eb7eac7dd47e59576fc9ccbb78068.png" alt=" "></p>
<p>VAPID</p>
<p>VAPID is used to distinguish the legitimate pushers. In short, we generate a key pair for the web server, including public and private keys, and add an email address so that the push service can contact the pusher in case of problems. Just add the vapidKeys before using them. Use <code>web-push generate-vapid-keys --json</code> to get the vapidKeys.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">webpush</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;web-push&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">vapidKeys</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&#34;publicKey&#34;</span><span class="o">:</span><span class="s2">&#34;BPCvPoAV6Msm4Y_uWb6H-8SAwKMN2JpuhkYIEKEqfVPSzH4krH7_-M14HGcnG7mWC153aUDMw74LRHVKcYCDujI&#34;</span><span class="p">,</span>
    <span class="s2">&#34;privateKey&#34;</span><span class="o">:</span><span class="s2">&#34;I6gFHumIGU_wTr8SvfLYsiX4u8bplzBlQJJM88kOrYw&#34;</span>
<span class="p">};</span>
<span class="nx">webpush</span><span class="p">.</span><span class="nx">setVapidDetails</span><span class="p">(</span>
    <span class="s1">&#39;mailto:example@yourdomain.org&#39;</span><span class="p">,</span>
    <span class="nx">vapidKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span>
    <span class="nx">vapidKeys</span><span class="p">.</span><span class="nx">privateKey</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>Service Worker and PWA are very powerful. If you are interested, you can try the offline and background synchronization function by yourself.</p>
<hr>
<p>Reference <code>https://blog.dteam.top/posts/2021-05/service-worker-and-pwa.html</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/service-worker/">service-worker</a>
          <a href="/tags/pwa/">pwa</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-06/installing-sonarqube-in-centos7/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Installing SonarQube in Centos7</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-06/fixing-the-problem-of-lost-code-after-git-revert-and-merge-again/">
            <span class="next-text nav-default">Fixing the Problem of Lost Code After Git Revert and Merge Again</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
