<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang Cron V3 Timed Tasks - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Recently I need to use the timed task function in golang, I use a cron library, the current version is v3, the Internet is quite a lot of v2 tutorials, record the use of the method.
In the old version of the library, the default cron expression is not the standard format, the first bit is the definition of the second level. Now the v3 version can use the standard cron expression directly, mainly see the godoc documentation section" /><meta name="keywords" content="go,cron,timed-task" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-06/golang-cron-v3-timed-tasks/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Golang Cron V3 Timed Tasks" />
<meta property="og:description" content="Recently I need to use the timed task function in golang, I use a cron library, the current version is v3, the Internet is quite a lot of v2 tutorials, record the use of the method.
In the old version of the library, the default cron expression is not the standard format, the first bit is the definition of the second level. Now the v3 version can use the standard cron expression directly, mainly see the godoc documentation section" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-06/golang-cron-v3-timed-tasks/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-30T12:06:17+08:00" />
<meta property="article:modified_time" content="2021-06-30T12:06:17+08:00" />

<meta itemprop="name" content="Golang Cron V3 Timed Tasks">
<meta itemprop="description" content="Recently I need to use the timed task function in golang, I use a cron library, the current version is v3, the Internet is quite a lot of v2 tutorials, record the use of the method.
In the old version of the library, the default cron expression is not the standard format, the first bit is the definition of the second level. Now the v3 version can use the standard cron expression directly, mainly see the godoc documentation section"><meta itemprop="datePublished" content="2021-06-30T12:06:17+08:00" />
<meta itemprop="dateModified" content="2021-06-30T12:06:17+08:00" />
<meta itemprop="wordCount" content="1509">
<meta itemprop="keywords" content="golang,cron," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang Cron V3 Timed Tasks"/>
<meta name="twitter:description" content="Recently I need to use the timed task function in golang, I use a cron library, the current version is v3, the Internet is quite a lot of v2 tutorials, record the use of the method.
In the old version of the library, the default cron expression is not the standard format, the first bit is the definition of the second level. Now the v3 version can use the standard cron expression directly, mainly see the godoc documentation section"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang Cron V3 Timed Tasks</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-30 12:06:17 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/tools/"> tools </a>
            </div>
          <span class="more-meta"> 1509 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#cron-expressions">cron Expressions</a></li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#create-configuration">Create Configuration</a></li>
        <li><a href="#add-task">Add task</a></li>
        <li><a href="#pass-in-function">Pass-in function</a></li>
        <li><a href="#incoming-tasks">Incoming tasks</a></li>
        <li><a href="#code-example">Code example</a></li>
        <li><a href="#summary">Summary</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently I need to use the timed task function in golang, I use a <a href="https://github.com/robfig/cron">cron</a> library, the current version is v3, the Internet is quite a lot of v2 tutorials, record the use of the method.</p>
<p>In the old version of the library, the default cron expression is not the standard format, the first bit is the definition of the second level.
Now the v3 version can use the standard cron expression directly, mainly see the godoc <a href="https://godoc.org/github.com/robfig/cron">documentation</a> section</p>
<h2 id="cron-expressions">cron Expressions</h2>
<p>It is recommended to use online tools to see if the cron you write is right or wrong, simple expressions written directly are generally not a big problem. Here we recommend <a href="crontab.guru">crontab.guru</a>, which allows you to view your written timing rules in a visual way.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/30/1b230ad83f2c4cbf9996f703a33fd33b.png" alt=" "></p>
<blockquote>
<p>The following is taken from Wikipedia - <a href="https://en.wikipedia.org/wiki/Cron">Cron</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># ┌───────────── minute (0 - 59)
# │ ┌───────────── hour (0 - 23)
# │ │ ┌───────────── day of the month (1 - 31)
# │ │ │ ┌───────────── month (1 - 12)
# │ │ │ │ ┌───────────── day of the week (0 - 6) (Sunday to Saturday;
# │ │ │ │ │                                   7 is also Sunday on some systems)
# │ │ │ │ │
# │ │ │ │ │
# * * * * * &lt;command to execute&gt;
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Notes.
In some systems, Sunday can also be 7
Not very intuitive usage: If both the date and the day of the week are set, the command is executed when one of the conditions is met. Please refer to the following example.
The first 5 fields are called the time, day, month and week, and can be easily remembered by individuals.
From the sixth field onwards, the command to be executed is specified.</p>
</blockquote>
<h2 id="installation">Installation</h2>
<p>Nowadays we use <code>Go module</code> for module management, use alt + enter in goland to synchronize the corresponding package <code>github.com/robfig/cron/v3</code></p>
<p>Use go get to install it as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">robfig</span><span class="o">/</span><span class="nx">cron</span><span class="o">/</span><span class="nx">v3</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="create-configuration">Create Configuration</h2>
<p>It is recommended to use the standard cron expressions</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Use the default configuration
</span><span class="c1"></span><span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
<span class="c1">// It can be configured to skip if the current task is in progress
</span><span class="c1"></span><span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithChain</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">SkipIfStillRunning</span><span class="p">(</span><span class="nx">logger</span><span class="p">)))</span>
<span class="c1">// The official definition of seconds for older versions is also available, and this note that the cron expressions you need to pass in are no longer standard cron expressions
</span><span class="c1"></span><span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithSeconds</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code there is a logger, I am using logrus, and in the source code you can see the definition of the logger needed for cron</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Logger is the interface used in this package for logging, so that any backend
</span><span class="c1">// can be plugged in. It is a subset of the github.com/go-logr/logr interface.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Logger</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Info logs routine messages about cron&#39;s operation.
</span><span class="c1"></span>	<span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
	<span class="c1">// Error logs an error condition.
</span><span class="c1"></span>	<span class="nf">Error</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then we define a Clog structure and just implement the corresponding interface</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/robfig/cron/v3&#34;</span>
	<span class="nx">log</span> <span class="s">&#34;github.com/sirupsen/logrus&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">CLog</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">clog</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">CLog</span><span class="p">)</span> <span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">l</span><span class="p">.</span><span class="nx">clog</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span>
		<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">keysAndValues</span><span class="p">,</span>
	<span class="p">}).</span><span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">CLog</span><span class="p">)</span> <span class="nf">Error</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">l</span><span class="p">.</span><span class="nx">clog</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span>
		<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="nx">msg</span><span class="p">,</span>
		<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">keysAndValues</span><span class="p">,</span>
	<span class="p">}).</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="add-task">Add task</h2>
<p>There are two ways to start a timed task, passing in a function and passing in a task.</p>
<h2 id="pass-in-function">Pass-in function</h2>
<p>We see the example given in the documentation, you can see that the task is added through <code>c.AddFunc ()</code> this function to directly pass a function can see the definition is <code>func (c *Cron) AddFunc (spec string, cmd func ()) (EntryID, error)</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span> <span class="nx">Runs</span> <span class="nx">at</span> <span class="mi">6</span><span class="nx">am</span> <span class="nx">in</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Local</span>
<span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;0 6 * * ?&#34;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="err">#</span> <span class="nx">Runs</span> <span class="nx">at</span> <span class="mi">6</span><span class="nx">am</span> <span class="nx">in</span> <span class="nx">America</span><span class="o">/</span><span class="nx">New_York</span>
<span class="nx">nyc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">LoadLocation</span><span class="p">(</span><span class="s">&#34;America/New_York&#34;</span><span class="p">)</span>
<span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithLocation</span><span class="p">(</span><span class="nx">nyc</span><span class="p">))</span>
<span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;0 6 * * ?&#34;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="c1">// AddFunc adds a func to the Cron to be run on the given schedule.
</span><span class="c1">// The spec is parsed using the time zone of this Cron instance as the default.
</span><span class="c1">// An opaque ID is returned that can be used to later remove it.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddFunc</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="kd">func</span><span class="p">())</span> <span class="p">(</span><span class="nx">EntryID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="nx">cmd</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For example, if you pass in a task that is just a simple function to execute, using <code>AddFunc()</code> will work, and you can also refer to variables outside the function via closures, here is a complete example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;github.com/robfig/cron/v3&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestCron</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
	<span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;*/1 * * * *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Execute every minute&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
		<span class="nx">i</span><span class="o">++</span>
	<span class="p">})</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nf">TestCron</span><span class="p">()</span>
<span class="p">}</span>

<span class="cm">/* output
</span><span class="cm">
</span><span class="cm">Execute every minute 1
</span><span class="cm">Execute every minute 2
</span><span class="cm">Execute every minute 3
</span><span class="cm">Execute every minute 4
</span><span class="cm">Execute every minute 5
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="incoming-tasks">Incoming tasks</h2>
<p>But what if we need to keep other information inside the defined task, we can use the <code>AddJob()</code> function and trace the source code definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// AddJob adds a Job to the Cron to be run on the given schedule.
</span><span class="c1">// The spec is parsed using the time zone of this Cron instance as the default.
</span><span class="c1">// An opaque ID is returned that can be used to later remove it.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span> <span class="p">(</span><span class="nx">EntryID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">schedule</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Schedule</span><span class="p">(</span><span class="nx">schedule</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// You can see that you need to pass two parameters, `spec` is the cron expression, Job type we do not seem to have seen, click in to see
</span><span class="c1">// Job is an interface for submitted cron jobs.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we know that our timed task only needs to implement the <code>Run()</code> function, so we can give our own <code>Job</code> definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">A</span>    <span class="kt">int</span>      <span class="s">`json:&#34;a&#34;`</span>
	<span class="nx">B</span>    <span class="kt">int</span>      <span class="s">`json:&#34;b&#34;`</span>
	<span class="nx">C</span>    <span class="kt">string</span>   <span class="s">`json:&#34;c&#34;`</span>
	<span class="nx">Shut</span> <span class="kd">chan</span> <span class="kt">int</span> <span class="s">`json:&#34;shut&#34;`</span>
<span class="p">}</span>

<span class="c1">// implement Run() interface to start rsync job
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">this</span> <span class="nx">Job</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">this</span><span class="p">.</span><span class="nx">A</span><span class="o">++</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;A: %d\n&#34;</span><span class="p">,</span> <span class="nx">this</span><span class="p">.</span><span class="nx">A</span><span class="p">)</span>
	<span class="o">*</span><span class="nx">this</span><span class="p">.</span><span class="nx">B</span><span class="o">++</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;B: %d\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">this</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
	<span class="o">*</span><span class="nx">this</span><span class="p">.</span><span class="nx">C</span> <span class="o">+=</span> <span class="s">&#34;str&#34;</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;C: %s\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">this</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="code-example">Code example</h2>
<p>I wrapped a <code>StartJob</code> function to facilitate my own management, but of course multiple tasks can be added at <code>c.AddJob()</code>, all of which will be executed at the request of cron</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;github.com/robfig/cron/v3&#34;</span>
	<span class="nx">log</span> <span class="s">&#34;github.com/sirupsen/logrus&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="c1">// Timed task planning
</span><span class="c1"></span><span class="cm">/*
</span><span class="cm">- spec，Pass in the cron time settings
</span><span class="cm">- job，Corresponding tasks
</span><span class="cm">*/</span>
<span class="kd">func</span> <span class="nf">StartJob</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">job</span> <span class="nx">Job</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CLog</span><span class="p">{</span><span class="nx">clog</span><span class="p">:</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">()}</span>
	<span class="nx">logger</span><span class="p">.</span><span class="nx">clog</span><span class="p">.</span><span class="nf">SetFormatter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">log</span><span class="p">.</span><span class="nx">TextFormatter</span><span class="p">{</span>
		<span class="nx">FullTimestamp</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
		<span class="nx">TimestampFormat</span><span class="p">:</span> <span class="s">&#34;2006-01-02 15:04:05&#34;</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">WithChain</span><span class="p">(</span><span class="nx">cron</span><span class="p">.</span><span class="nf">SkipIfStillRunning</span><span class="p">(</span><span class="nx">logger</span><span class="p">)))</span>

	<span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">job</span><span class="p">)</span>

	<span class="c1">// Initiate execution tasks
</span><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
	<span class="c1">// Close scheduled tasks on exit
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>

	<span class="c1">// If you use select{} then it will always loop
</span><span class="c1"></span>	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">job</span><span class="p">.</span><span class="nx">Shut</span><span class="p">:</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">StopJob</span><span class="p">(</span><span class="nx">shut</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">shut</span> <span class="o">&lt;-</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">CLog</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">clog</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">CLog</span><span class="p">)</span> <span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">l</span><span class="p">.</span><span class="nx">clog</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span>
		<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">keysAndValues</span><span class="p">,</span>
	<span class="p">}).</span><span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">CLog</span><span class="p">)</span> <span class="nf">Error</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">keysAndValues</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">l</span><span class="p">.</span><span class="nx">clog</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span>
		<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="nx">msg</span><span class="p">,</span>
		<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">keysAndValues</span><span class="p">,</span>
	<span class="p">}).</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Job</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">A</span>    <span class="kt">int</span>      <span class="s">`json:&#34;a&#34;`</span>
	<span class="nx">B</span>    <span class="kt">int</span>      <span class="s">`json:&#34;b&#34;`</span>
	<span class="nx">C</span>    <span class="kt">string</span>   <span class="s">`json:&#34;c&#34;`</span>
	<span class="nx">Shut</span> <span class="kd">chan</span> <span class="kt">int</span> <span class="s">`json:&#34;shut&#34;`</span>
<span class="p">}</span>

<span class="c1">// implement Run() interface to start job
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">j</span> <span class="o">*</span><span class="nx">Job</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">j</span><span class="p">.</span><span class="nx">A</span><span class="o">++</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;A: %d\n&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">A</span><span class="p">)</span>
	<span class="nx">j</span><span class="p">.</span><span class="nx">B</span><span class="o">++</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;B: %d\n&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
	<span class="nx">j</span><span class="p">.</span><span class="nx">C</span> <span class="o">+=</span> <span class="s">&#34;str&#34;</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;C: %s\n&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">job1</span> <span class="o">:=</span> <span class="nx">Job</span><span class="p">{</span>
		<span class="nx">A</span><span class="p">:</span>    <span class="mi">0</span><span class="p">,</span>
		<span class="nx">B</span><span class="p">:</span>    <span class="mi">1</span><span class="p">,</span>
		<span class="nx">C</span><span class="p">:</span>    <span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="nx">Shut</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="c1">// Execute every minute
</span><span class="c1"></span>	<span class="k">go</span> <span class="nf">StartJob</span><span class="p">(</span><span class="s">&#34;*/1 * * * *&#34;</span><span class="p">,</span> <span class="nx">job1</span><span class="p">)</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/*
</span><span class="cm">output
</span><span class="cm">
</span><span class="cm">A: 1
</span><span class="cm">B: 2
</span><span class="cm">C: str
</span><span class="cm">A: 2
</span><span class="cm">B: 3
</span><span class="cm">C: strstr
</span><span class="cm">A: 3
</span><span class="cm">B: 4
</span><span class="cm">C: strstrstr
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<ul>
<li>The v3 version of this cron library uses the standard cron expressions directly</li>
<li>There are two ways to start a cron task, passing in a function and passing in a job.</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/robfig/cron">robfig/cron</a></li>
<li><a href="http://godoc.org/github.com/robfig/cron">godoc-cron</a></li>
<li><a href="https://crontab.guru/">crontab.guru</a></li>
</ul>
<hr>
<p>Reference <code>https://blog.cugxuan.cn/2020/06/04/Go/golang-cron-v3/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/cron/">cron</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-06/finding-the-kth-largest-number-in-a-large-amount-of-unordered-data/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Finding the Kth Largest Number in a Large Amount of Unordered Data</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-06/web-components-getting-started-example-tutorial/">
            <span class="next-text nav-default">Web Components Getting Started Example Tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
