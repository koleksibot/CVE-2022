<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Memory Leak Monitoring on Flutter - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The dart language used by Flutter has a garbage collection mechanism, and with garbage collection, memory leaks are inevitable. There is a memory leak detection tool LeakCanary on the Android platform that can easily detect if the current page is leaking in a debug environment. This article will take you through the implementation of a flutter-ready LeakCanary and tell you how I used it to detect two leaks on the 1." /><meta name="keywords" content="flutter,MemoryLeak" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-06/memory-leak-monitoring-on-flutter/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Memory Leak Monitoring on Flutter" />
<meta property="og:description" content="The dart language used by Flutter has a garbage collection mechanism, and with garbage collection, memory leaks are inevitable. There is a memory leak detection tool LeakCanary on the Android platform that can easily detect if the current page is leaking in a debug environment. This article will take you through the implementation of a flutter-ready LeakCanary and tell you how I used it to detect two leaks on the 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-06/memory-leak-monitoring-on-flutter/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-15T18:14:26+08:00" />
<meta property="article:modified_time" content="2021-06-15T18:14:26+08:00" />

<meta itemprop="name" content="Memory Leak Monitoring on Flutter">
<meta itemprop="description" content="The dart language used by Flutter has a garbage collection mechanism, and with garbage collection, memory leaks are inevitable. There is a memory leak detection tool LeakCanary on the Android platform that can easily detect if the current page is leaking in a debug environment. This article will take you through the implementation of a flutter-ready LeakCanary and tell you how I used it to detect two leaks on the 1."><meta itemprop="datePublished" content="2021-06-15T18:14:26+08:00" />
<meta itemprop="dateModified" content="2021-06-15T18:14:26+08:00" />
<meta itemprop="wordCount" content="2764">
<meta itemprop="keywords" content="flutter," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Memory Leak Monitoring on Flutter"/>
<meta name="twitter:description" content="The dart language used by Flutter has a garbage collection mechanism, and with garbage collection, memory leaks are inevitable. There is a memory leak detection tool LeakCanary on the Android platform that can easily detect if the current page is leaking in a debug environment. This article will take you through the implementation of a flutter-ready LeakCanary and tell you how I used it to detect two leaks on the 1."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Memory Leak Monitoring on Flutter</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-15 18:14:26 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2764 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-the-weak-reference-in-dart">1, the weak reference in Dart</a></li>
        <li><a href="#3-dart-vm_service">3, Dart vm_service</a>
          <ul>
            <li><a href="#the-role-of-objref-obj-and-id">The role of ObjRef, Obj and id</a></li>
            <li><a href="#how-to-use-the-vm_service-service">How to use the vm_service service</a></li>
          </ul>
        </li>
        <li><a href="#3-leak-detection-implementation">3, Leak detection implementation</a>
          <ul>
            <li><a href="#get-isolateid">Get IsolateId</a></li>
            <li><a href="#obtaining-the-objectid">Obtaining the ObjectId</a></li>
            <li><a href="#object-leakage-determination">Object Leakage Determination</a></li>
            <li><a href="#forced-gc">Forced GC</a></li>
          </ul>
        </li>
        <li><a href="#4get-the-leak-path">4，Get the leak path</a>
          <ul>
            <li><a href="#expando-holds-questions">Expando holds questions</a></li>
            <li><a href="#id-expiration-issue">id expiration issue</a></li>
          </ul>
        </li>
        <li><a href="#5-memory-leak-on-191-framework">5, Memory leak on <code>1.9.1 framework</code></a>
          <ul>
            <li><a href="#how-to-shorten-the-citation-chain">How to shorten the citation chain</a></li>
            <li><a href="#identification-191-framework-leakage-root-cause">Identification 1.9.1 framework Leakage root cause</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The <code>dart</code> language used by <code>Flutter</code> has a garbage collection mechanism, and with garbage collection, memory leaks are inevitable. There is a memory leak detection tool <a href="https://github.com/square/leakcanary">LeakCanary</a> on the <code>Android</code> platform that can easily detect if the current page is leaking in a <code>debug</code> environment. This article will take you through the implementation of a <code>flutter</code>-ready <code>LeakCanary</code> and tell you how I used it to detect two leaks on the 1.9.1 framework.</p>
<h2 id="1-the-weak-reference-in-dart">1, the weak reference in Dart</h2>
<p>In languages with garbage collection, weak references are a good way to detect if an object is leaking. We just weakly reference the observed object and wait for the next Full GC, if the object is null after the gc, it is recycled, if it is not null, it is probably leaking.
Dart language also has a weak reference, it is called ``Expando<T>`, look at its api:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">Expando</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">external</span> <span class="n">T</span> <span class="kd">operator</span> <span class="p">[](</span><span class="kt">Object</span> <span class="n">object</span><span class="p">);</span>
  <span class="n">external</span> <span class="kt">void</span> <span class="kd">operator</span> <span class="p">[]</span><span class="o">=</span><span class="p">(</span><span class="kt">Object</span> <span class="n">object</span><span class="p">,</span> <span class="n">T</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>You may wonder where the above code is weakly referenced? It&rsquo;s actually in the assignment statement <code>expando[key]=value</code>. `Expando will hold the key in a weak reference, and this is where the weak reference is.</p>
<p>The problem is that the <code>Expando</code> weak reference holds a <code>key</code>, but it does not provide an <code>api</code> like <code>getKey()</code>, so we have no way to know if the `key object has been recycled.</p>
<p>To solve this problem, let&rsquo;s look at the specific implementation of <code>Expando</code> in <a href="https://github.com/dart-lang/sdk/blob/master/sdk/lib/_internal/vm/lib/expando_patch.dart">expando_path.dart</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="err">@</span><span class="n">path</span>
<span class="kd">class</span> <span class="nc">Expando</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="n">T</span> <span class="kd">operator</span> <span class="p">[](</span><span class="n">Objet</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">_size</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="n">_identityHashCode</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
    <span class="c1">// sdk is putting the key into a _data array, and this wp is a _WeakProperty
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">wp</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

    <span class="c1">// ... Omit part of the code
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">wp</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
   	<span class="c1">// ... Omit part of the code
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: This patch code is not available for the web platform</p>
</blockquote>
<p>We can find that the <code>key</code> object is put into the <code>_data</code> array, wrapped with a <code>_WeakProperty</code>, then this <code>_WeakProperty</code> is the key class, look at its implementation, on behalf of &hellip; code in <a href="https://github.com/dart-lang/sdk/blob/master/sdk_nnbd/lib/_internal/vm/lib/weak_property.dart">weak_property.dart</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&#34;vm:entry-point&#34;</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">_WeakProperty</span> <span class="p">{</span>

  <span class="kd">get</span> <span class="n">key</span> <span class="o">=&gt;</span> <span class="n">_getKey</span><span class="p">();</span>
  <span class="c1">// ... Omit part of the code
</span><span class="c1"></span>  <span class="n">_getKey</span><span class="p">()</span> <span class="kd">native</span> <span class="s2">&#34;WeakProperty_getKey&#34;</span><span class="p">;</span>
  <span class="c1">// ... Omit part of the code
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This class has the <code>key</code> that we want to use to determine if the object is still there!
How to get such private properties and variables? The <code>dart</code> in <code>flutter</code> does not support reflection (reflection is turned off to optimize packing <code>size</code>), is there any other way to get such private properties?
The answer is definitely &ldquo;yes&rdquo;. To solve the above problem, I introduce a service that comes with dart from my side, <strong><code>Dart VM Service</code></strong>.</p>
<h2 id="3-dart-vm_service">3, Dart vm_service</h2>
<p>The <a href="https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md">Dart VM Service</a> (later referred to as <code>vm_service</code>) is a set of web services provided internally by the dart VM, and the data transfer protocol is JSON-RPC 2.0. However, we do not need to implement the data request parsing ourselves, as an official dart sdk has been written for us to use <a href="https://pub.dev/packages/vm_service">vm_service</a>.</p>
<h3 id="the-role-of-objref-obj-and-id">The role of ObjRef, Obj and id</h3>
<p>Let&rsquo;s introduce the core content in <code>vm_service</code>: <code>ObjRef</code>, <code>Obj</code>, <code>id</code>.</p>
<p>The data returned by <code>vm_service</code> is divided into two main categories, <code>ObjRef</code> (reference type) and <code>Obj</code> (object instance type). Where <code>Obj</code> contains the complete data of <code>ObjRef</code> and adds additional information on top of it (<code>ObjRef</code> contains only some basic information, such as: <code>id</code>, <code>name</code>&hellip;). .).</p>
<p>Basically all the data returned by <code>api</code> is <code>ObjRef</code>, when the information inside <code>ObjRef</code> doesn&rsquo;t satisfy you, then call <code>getObject(,,,,)</code> to get <code>Obj</code>.</p>
<p>About <code>id: Obj</code> and <code>ObjRef</code> both contain <code>id</code>, this <code>id</code> is an identifier of the object instance in <code>vm_service</code>, almost all api of <code>vm_service</code> need to operate by id, for example: <code>getInstance( isolateId, classId, ...)</code>, <code>getIsolate(isolateId)</code>, <code>getObject(isolateId, objectId, ...)</code>.</p>
<h3 id="how-to-use-the-vm_service-service">How to use the vm_service service</h3>
<p><code>vm_service</code> opens a websocket service locally when it starts, and the service uri is available in the corresponding platform at:</p>
<ul>
<li><code>Android</code> in <code>FlutterJNI.getObservatoryUri()</code></li>
<li><code>iOS</code> in <code>FlutterEngine.observatoryUrl</code></li>
</ul>
<p>Once we have the uri, we can use the <code>vm_service</code> service. There is an official <code>sdk vm_service</code> written for us, and we can use the internal <code>vmServiceConnectUri</code> to get an available <code>VmService</code> object.</p>
<blockquote>
<p>The parameter of <code>vmServiceConnectUri</code> needs to be a uri of the ws protocol, which is obtained by default with the http protocol and needs to be converted with the <code>convertToWebSocketUrl</code> method</p>
</blockquote>
<h2 id="3-leak-detection-implementation">3, Leak detection implementation</h2>
<p>With <code>vm_service</code>, we can use it to make up for the lack of <code>Expando</code>. According to the previous analysis, we want to get <code>_data</code>, a private field of <code>Expando</code>. Here we can use the <a href="https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md#getobject">getObject(isolateId, objectId)</a> api, whose return value is <a href="https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md#instance">Instance</a>, and the internal <code>fields</code> field holds all the properties of the current object. This allows us to iterate through the properties to get <code>_data</code> to achieve the effect of reflection.</p>
<p>Now the question is what is <code>isoateId</code> and <code>objectId</code> in the api parameter, which is the identifier of the object in <code>vm_serive</code> according to the id related content I described earlier. That is, we can only get these two parameters through <code>vm_service</code>.</p>
<h3 id="get-isolateid">Get IsolateId</h3>
<p>Isolates are a very important concept in <code>dart</code>, basically an <code>isolate</code> is equivalent to a thread, but different from our usual threads: memory is not shared between different <code>isolates</code>.</p>
<p>Because of the above feature, we also need to bring <code>isolateId</code> when looking for objects. The <code>getVM()</code> api of <code>vm_service</code> can get the VM object data, and then the <code>isolates</code> field can get all the <code>isolates</code> of the current VM.</p>
<p>So how do we filter the <code>isolate</code> we want? For simplicity, only the main <code>isolate</code> is filtered, and you can check the source code of <a href="https://github.com/flutter/devtools">dev_tools</a>: <a href="https://github.com/flutter/devtools/blob/v0.2.5/packages/devtools_app/lib/src/service_manager.dart#L450">service_manager.dart#_initSelectedIsolate</a> function.</p>
<h3 id="obtaining-the-objectid">Obtaining the ObjectId</h3>
<p>The <code>objectId</code> we want to get is the id of <code>expando</code> in <code>vm_service</code>, and here we can extend the question.</p>
<h4 id="how-to-get-the-id-of-the-specified-object-in-vm_service">How to get the id of the specified object in vm_service?</h4>
<p>There is no api for instance object and id conversion in <code>vm_service</code>, there is an api <code>getInstance(isolateId, classId, limit)</code> which can get all subclass instances of a classId, not to mention how to get the desired <code>classId</code>, the performance and limit of this api are worrying.</p>
<p>Is there no good way? Actually, we can use the top-level functions of <code>Library</code> (written directly in the current file, not in the class, such as the `main function) to achieve this function.</p>
<blockquote>
<p>In general, a dart file is a <code>Library</code>, but there are exceptions, such as <code>part of</code> and <code>export</code>.</p>
</blockquote>
<p><code>vm_service</code> has an <code>invoke(isolateId, targetId, selector, argumentIds) api</code> that can be used to execute a regular function (<code>getter</code>, <code>setter</code>, constructor, private function are unconventional functions), where if <code>targetId</code> is the id of <code>Library</code>, then <code>invoke</code> executes the top-level function of <code>Library</code>.</p>
<p>With the path to the `invoke Library top-level function, you can use it to implement object-to-id, the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">int</span> <span class="n">_key</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
<span class="c1">/// The top-level function, which must be a regular method, is used to generate the key
</span><span class="c1"></span><span class="kt">String</span> <span class="n">generateNewKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">&#34;</span><span class="si">${</span><span class="o">++</span><span class="n">_key</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">_objCache</span> <span class="o">=</span> <span class="n">Map</span><span class="p">();</span>
<span class="c1">/// Top-level function that returns a specified object based on key
</span><span class="c1"></span><span class="kt">dynamic</span> <span class="n">keyToObj</span><span class="p">(</span><span class="kt">String</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">_objCache</span><span class="p">[</span><span class="n">key</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">/// Object to id
</span><span class="c1"></span><span class="kt">String</span> <span class="n">obj2Id</span><span class="p">(</span><span class="n">VMService</span> <span class="n">service</span><span class="p">,</span> <span class="kt">dynamic</span> <span class="n">obj</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  
  <span class="c1">// Find the isolateId, the method here is the isolateId get method described earlier
</span><span class="c1"></span>  <span class="kt">String</span> <span class="n">isolateId</span> <span class="o">=</span> <span class="n">findMainIsolateId</span><span class="p">();</span>
  <span class="c1">// Find the current Library. Here you can iterate through the libraries field of isolate
</span><span class="c1"></span>  <span class="c1">// According to the uri filter out the current Library can be, the specific does not expand the
</span><span class="c1"></span>  <span class="kt">String</span> <span class="n">libraryId</span> <span class="o">=</span> <span class="n">findLibraryId</span><span class="p">();</span>
  
  <span class="c1">// Execute the `generateNewKey function with `vm service`.
</span><span class="c1"></span>  <span class="n">InstanceRef</span> <span class="n">keyRef</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">service</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="n">isolateId</span><span class="p">,</span>
    <span class="n">libraryId</span><span class="p">,</span>
    <span class="s2">&#34;generateNewKey&#34;</span><span class="p">,</span>
    <span class="c1">// No parameters, so it is an empty array
</span><span class="c1"></span>    <span class="p">[]</span>
  <span class="p">);</span>
  <span class="c1">// Get the String value of the keyRef
</span><span class="c1"></span>  <span class="c1">// This is the only api that converts ObjRef types to values
</span><span class="c1"></span>  <span class="kt">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyRef</span><span class="p">.</span><span class="n">valueAsString</span><span class="p">;</span>
  
  <span class="n">_objCache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Call the keyToObj top-level function, pass in the key, get the obj
</span><span class="c1"></span>    <span class="n">InstanceRef</span> <span class="n">valueRef</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">service</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span>
      <span class="n">isolateId</span><span class="p">,</span>
      <span class="n">libraryId</span><span class="p">,</span>
      <span class="s2">&#34;keyToObj&#34;</span><span class="p">,</span>
      <span class="c1">// Note here that vm_service requires the id, not the value
</span><span class="c1"></span>      <span class="p">[</span><span class="n">keyRef</span><span class="p">.</span><span class="n">id</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1">// The id here is the id corresponding to the obj
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">valueRef</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="n">_objCache</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="object-leakage-determination">Object Leakage Determination</h3>
<p>Now that we can get the id of the <code>expando</code> instance in <code>vm_service</code>, the next step is simple</p>
<p>First get <code>Instance</code> through <code>vm_service</code>, traverse the <code>fields</code> property inside, find the <code>_data</code> field (note that _data is of type ObjRef), and convert the <code>_data</code> field to type <code>Instance</code> in the same way (_data is an array, Obj has the child information of the array).</p>
<p>Iterate through the _data field, if it is all null, it means that the key object we are observing has been released. If item is not null, turn item into Instance again and take its <code>propertyKey</code> (because item is of type <code>_WeakProperty</code>, <code>Instance</code> has this field specifically for <code>_WeakProperty</code>).</p>
<h3 id="forced-gc">Forced GC</h3>
<p>As mentioned at the beginning of the article, if you want to determine whether an object is leaking, you need to determine whether the weak reference is still there after Full GC. Is there any way to trigger gc manually?</p>
<p>The answer is yes, <code>vm_service</code> doesn&rsquo;t have an api to force gc, but there is a GC button in the top right corner of the dev_tools memory icon, so we can just follow it! dev_tools calls the vm_service <a href="https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md#getallocationprofile">getAllocationProfile( isolateId, gc: true)</a> api of vm_service to achieve manual gc.</p>
<p>As for whether this api triggers a FULL GC or not, it is not specified, all my tests trigger a FULL GC.
So far, we have been able to implement leak monitoring, and we can get the id of the leak target in vm_serive, so we will start to get the analysis of the leak path.</p>
<h2 id="4get-the-leak-path">4，Get the leak path</h2>
<p>For getting the leak path, vm_service provides an api called <a href="https://github.com/dart-lang/sdk/blob/master/runtime/vm/service/service.md#getretainingpath">getRetainingPath(isolateId, objectId, limit)</a>. This api can be used directly to get the reference chain information of the leaked object to the gc root. But this alone won&rsquo;t work, because it has the following pitfalls.</p>
<h3 id="expando-holds-questions">Expando holds questions</h3>
<p>If the leaked object is held by expando while executing <code>getRetainingPath</code>, the following two problems arise</p>
<ul>
<li>
<p>Because the api returns only one reference chain, the returned reference chain goes through expando, making it impossible to get the real leaked node information</p>
</li>
<li>
<p>Native crash on arm devices, specifically on utf8 character decoding</p>
</li>
<li>
<p>Native crash on arm devices, specifically on utf8 character decoding</p>
</li>
</ul>
<p>This problem can be solved easily by releasing the expando after the leak detection in the front.</p>
<h3 id="id-expiration-issue">id expiration issue</h3>
<p>The <code>Instance</code> type id is different from the <code>Class</code>, <code>Library</code>, <code>Isolate</code> ids, which will expire. vm_service has a cache size of 8192 by default for such temporary ids, which is a circular queue.</p>
<p>Because of this problem, when we detect a leak, we can&rsquo;t just save the id of the leaked object, we need to save the original object, and we can&rsquo;t hold the object by strong reference. So here we still need to use expando to save our detected leak object, and wait until we need to analyze the leak path, and then dedicate the object to id.</p>
<h2 id="5-memory-leak-on-191-framework">5, Memory leak on <code>1.9.1 framework</code></h2>
<p>After completing leak detection and path fetching, I got a rudimentary leakcanary tool. When I tested this tool under framework version 1.9.1, I found that it leaked a page when I observed a page!</p>
<blockquote>
<p>Looking at the objects dumped by dev_tools, there is indeed a leak!</p>
</blockquote>
<p>That is, there is a leak in the <code>1.9.1 framework</code>, and the leak is leaking the whole page.</p>
<p>Next, we started to investigate the cause of the leak, and here we ran into a problem: the leak path was too long. The link length returned by <code>getRetainingPath</code> is 300+, and I couldn&rsquo;t find the root cause of the problem even after an afternoon of troubleshooting.</p>
<p>Conclusion: It is difficult to analyze the source of the problem directly based on the data returned by vm_service, so we need to process the information of the leak path twice.</p>
<h3 id="how-to-shorten-the-citation-chain">How to shorten the citation chain</h3>
<p>First look at why the leak path is so long, by observing the returned link found that the majority of nodes are flutter UI component nodes (for example: widget, element, state, renderObject).</p>
<p>That is, the reference chain goes through the flutter component tree, and those who have played with flutter should know that the flutter component tree is very deep. Since the reference chain is long because it contains the component tree, and the component tree basically appears in blocks, we can significantly shorten the leak path by simply sorting and aggregating the nodes in the reference chain according to their types.</p>
<h4 id="classification">Classification</h4>
<p>The nodes are divided into the following types based on flutter&rsquo;s component types.</p>
<ul>
<li>element: corresponds to the Element node</li>
<li>widget: corresponds to a widget node</li>
<li>renderObject: corresponds to the RenderObject node</li>
<li>state: corresponds to the <code>State&lt;T extends StatefulWdget&gt;</code> node</li>
<li>collection: corresponding collection type node, for example: List, Map, Set</li>
<li>other: corresponds to other nodes</li>
</ul>
<h4 id="polymerization">Polymerization</h4>
<p>Once the nodes are well classified, you can aggregate the nodes of the same type. Here is my aggregation method</p>
<p>If two collections of the same type are connected by a collection node, continue to merge the two collections into one, recursively.</p>
<blockquote>
<p>With classification-aggregation, a link length of 300+ can be reduced to 100+.</p>
</blockquote>
<p>Continue to investigate the 1.9.1 framework leaks, although the path is shortened, you can find the problem appears in the FocusManager node! But the specific problem is still difficult to locate, mainly the following two points.</p>
<ul>
<li>
<p>Lack of code location for reference chain nodes: Because the RetainingObject data only has three fields, parentField, parentIndex and parentKey, to represent the information of the current object referencing the next object, it is inefficient to find the code location through this information.</p>
</li>
<li>
<p>No information about the current flutter component node: for example, the text information of the Text, the widget where the element is located, the lifecycle state of the state, which page the current component belongs to. etc.</p>
</li>
</ul>
<p>Between the above two pain points, the information of the leaking nodes also needs to be extended.</p>
<ul>
<li>
<p>Code location: the reference code location of the node actually only needs to resolve the parentField, through the vm_serive parsing class, take the internal field, find the corresponding script and other information. This method can get the source code</p>
</li>
<li>
<p>Component node information: flutter&rsquo;s UI components are all inherited from Diagnosticable, which means that as long as the nodes of Diagnosticable type can get very detailed information (during dev_tools debugging, the component tree information is obtained through the <code>Diagnosticable. debugFillProperties</code> method). In addition to this, you need to extend the route information of the current component, which is very important to determine the page where the component is located</p>
</li>
</ul>
<h3 id="identification-191-framework-leakage-root-cause">Identification 1.9.1 framework Leakage root cause</h3>
<p>After all the above optimizations, I got the following tool, which found problems in two <code>_InkResponseState</code> nodes.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/15/0aacb41221d347788d4905c8a5fe2037.jpg" alt="_InkResponseState node"></p>
<p>There are two _InkResponseState nodes in the leak path that have different route information, indicating that they are in two different pages. The description of the top <code>_InkResponseState</code> shows that the lifecycle is not mounted, indicating that the component has been destroyed, but is still referenced by the FocusManager! Here&rsquo;s the problem, take a look at this part of the code</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/15/769be492b41f4a8aba3b1c53353dc1e3.jpg" alt="code"></p>
<p>The code clearly shows that addListener has a wrong understanding of the lifecycle of StatefulWidget. didChangeDependencies is called multiple times, while dispose is called only once, so here the listener is not removed cleanly.</p>
<p>After fixing the above leak, I found one more leak. After troubleshooting, we found that the source of the leak is in TransitionRoute.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/15/e6c6c48407f942db9618a38e268c9941.jpg" alt="code"></p>
<p>When a new page is opened, the Route of that page (that is, the nextRoute in the code) will be held by the animation of the previous page, and if the page jumps are all TransitionRoute, then all the routes will leak!</p>
<blockquote>
<p>The good news is that the above leaks have been fixed since version 1.12</p>
</blockquote>
<p>After fixing the above two leaks, I tested again and Route and Widget can be recycled, so the 1.9.1 framework is finished.</p>
<hr>
<p>Referenece <code>https://juejin.cn/post/6844904191828164615</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flutter/">flutter</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-06/use-of-the-go-empty-struct/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Use of the Go Empty Struct</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-06/how-to-import-local-packages-using-go-module/">
            <span class="next-text nav-default">How to Import Local Packages Using Go Module</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
