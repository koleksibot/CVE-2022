<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Exploring the React Native Startup Version Checking Mechanism - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Colleague&amp;rsquo;s feedback React Native project startup reported an error indicating version mismatch, the error screenshot is as follows.
After some troubleshooting, we finally found that the old version of js file was packed locally, and the project itself depends on a different version, so we can delete the old version of the local file.
We can find out that RN has a version check at startup through this error, how is the specific mechanism, let&amp;rsquo;s follow the source code together." /><meta name="keywords" content="react-native" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-06/exploring-the-react-native-startup-version-checking-mechanism/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Exploring the React Native Startup Version Checking Mechanism" />
<meta property="og:description" content="Colleague&rsquo;s feedback React Native project startup reported an error indicating version mismatch, the error screenshot is as follows.
After some troubleshooting, we finally found that the old version of js file was packed locally, and the project itself depends on a different version, so we can delete the old version of the local file.
We can find out that RN has a version check at startup through this error, how is the specific mechanism, let&rsquo;s follow the source code together." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-06/exploring-the-react-native-startup-version-checking-mechanism/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-13T18:22:17+08:00" />
<meta property="article:modified_time" content="2021-06-13T18:22:17+08:00" />

<meta itemprop="name" content="Exploring the React Native Startup Version Checking Mechanism">
<meta itemprop="description" content="Colleague&rsquo;s feedback React Native project startup reported an error indicating version mismatch, the error screenshot is as follows.
After some troubleshooting, we finally found that the old version of js file was packed locally, and the project itself depends on a different version, so we can delete the old version of the local file.
We can find out that RN has a version check at startup through this error, how is the specific mechanism, let&rsquo;s follow the source code together."><meta itemprop="datePublished" content="2021-06-13T18:22:17+08:00" />
<meta itemprop="dateModified" content="2021-06-13T18:22:17+08:00" />
<meta itemprop="wordCount" content="1587">
<meta itemprop="keywords" content="react-native," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploring the React Native Startup Version Checking Mechanism"/>
<meta name="twitter:description" content="Colleague&rsquo;s feedback React Native project startup reported an error indicating version mismatch, the error screenshot is as follows.
After some troubleshooting, we finally found that the old version of js file was packed locally, and the project itself depends on a different version, so we can delete the old version of the local file.
We can find out that RN has a version check at startup through this error, how is the specific mechanism, let&rsquo;s follow the source code together."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Exploring the React Native Startup Version Checking Mechanism</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-13 18:22:17 </span>
        <div class="post-category">
            <a href="/categories/frontend/"> frontend </a>
            <a href="/categories/implementation-details/"> implementation-details </a>
            </div>
          <span class="more-meta"> 1587 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#version-detection-mechanism">Version detection mechanism</a>
          <ul>
            <li><a href="#location-of-the-error-report">Location of the error report</a></li>
            <li><a href="#reactnativeversionversion">ReactNativeVersion.version</a></li>
            <li><a href="#platformconstantsreactnativeversion">Platform.constants.reactNativeVersion</a></li>
          </ul>
        </li>
        <li><a href="#phase-summary">Phase Summary</a>
          <ul>
            <li><a href="#how-to-set-the-version-number">How to set the version number</a></li>
            <li><a href="#what-happens-when-this-error-occurs">What happens when this error occurs</a></li>
            <li><a href="#why-is-there-this-check">Why is there this check</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Colleague&rsquo;s feedback React Native project startup reported an error indicating version mismatch, the error screenshot is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/13/376b3a989a6940d5b970802b374d833d.png" alt="err"></p>
<p>After some troubleshooting, we finally found that the old version of js file was packed locally, and the project itself depends on a different version, so we can delete the old version of the local file.</p>
<p>We can find out that RN has a version check at startup through this error, how is the specific mechanism, let&rsquo;s follow the source code together.</p>
<blockquote>
<p>As for why an old js file is packaged locally and why it&rsquo;s only a problem today after so many years, that&rsquo;s a topic for another day, so ignore it for now</p>
</blockquote>
<h2 id="version-detection-mechanism">Version detection mechanism</h2>
<h3 id="location-of-the-error-report">Location of the error report</h3>
<p>By searching for the keyword <code>React Native version mismatch</code> you can find the final code for the check in <code>Libraries/Core/ReactNativeVersionCheck.js</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">Platform</span> <span class="nx">from</span> <span class="s1">&#39;../Utilities/Platform&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">ReactNativeVersion</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./ReactNativeVersion&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">checkVersions</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">checkVersions</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">nativeVersion</span> <span class="o">=</span> <span class="nx">Platform</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">reactNativeVersion</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nx">ReactNativeVersion</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">major</span> <span class="o">!==</span> <span class="nx">nativeVersion</span><span class="p">.</span><span class="nx">major</span> <span class="o">||</span>
        <span class="nx">ReactNativeVersion</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">minor</span> <span class="o">!==</span> <span class="nx">nativeVersion</span><span class="p">.</span><span class="nx">minor</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span>
            <span class="sb">`React Native version mismatch.\n\nJavaScript version: </span><span class="si">${</span><span class="nx">_formatVersion</span><span class="p">(</span>
        <span class="nx">ReactNativeVersion</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
      <span class="p">)</span><span class="si">}</span><span class="sb">\n`</span> <span class="o">+</span>
<span class="sb">`Native version: </span><span class="si">${</span><span class="nx">_formatVersion</span><span class="p">(</span><span class="nx">nativeVersion</span><span class="p">)</span><span class="si">}</span><span class="sb">\n\n`</span> <span class="o">+</span>
            <span class="s1">&#39;Make sure that you have rebuilt the native code. If the problem &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;persists try clearing the Watchman and packager caches with &#39;</span> <span class="o">+</span>
            <span class="s1">&#39; `watchman watch-del-all &amp;&amp; react-native start --reset-cache` .&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>This method compares the major and minor of <code>ReactNativeVersion.version</code> and <code>Platform.constants.reactNativeVersion</code> and throws an exception when the two values do not match.</p>
<blockquote>
<p>If the version number is 0.59.9, then major is 59 and minor is 9. It feels like RN didn&rsquo;t intend to remove the first 0.
Meanwhile, checkVersion is loaded at startup, this part of the code you can search for yourself to see, not to analyze</p>
</blockquote>
<h3 id="reactnativeversionversion">ReactNativeVersion.version</h3>
<p>So what do each of these two values represent? First, look at <code>ReactNativeVersion.version</code>, which is declared in <a href="https://github.com/facebook/react-native/blob/master/Libraries/Core/ReactNativeVersion.js">Libraries/Core/ReactNativeVersion.js</a> in the same directory as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">exports</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">major</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">minor</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">prerelease</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>Well, it&rsquo;s very clear and unambiguous. It&rsquo;s like writing the same thing as not writing, no rush, we know anyway, the value is in the js file, will be with the final package into the bundle.js.</p>
<h3 id="platformconstantsreactnativeversion">Platform.constants.reactNativeVersion</h3>
<p>According to the reference, we find the file <a href="https://github.com/facebook/react-native/blob/master/Libraries/Utilities/Platform.android.js">Libraries/Utilities/Platform.android.js</a> with the following key content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">NativePlatformConstantsAndroid</span> <span class="nx">from</span> <span class="s1">&#39;./NativePlatformConstantsAndroid&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">Platform</span> <span class="o">=</span> <span class="p">{</span>

    <span class="p">...</span>

    <span class="nx">get</span> <span class="nx">constants</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__constants</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">__constants</span> <span class="o">=</span> <span class="nx">NativePlatformConstantsAndroid</span><span class="p">.</span><span class="nx">getConstants</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__constants</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">...</span>

<span class="p">};</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Platform</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>is also directed to <code>NativePlatformConstantsAndroid.getConstants()</code>, in <a href="https://github.com/facebook/react-native/blob/master/Libraries/Utilities/NativePlatformConstantsAndroid.js">Libraries/Utilities/NativePlatformConstantsAndroid.js</a>, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">TurboModuleRegistry</span> <span class="nx">from</span> <span class="s1">&#39;../TurboModule/TurboModuleRegistry&#39;</span><span class="p">;</span>

<span class="p">...</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">(</span><span class="nx">TurboModuleRegistry</span><span class="p">.</span><span class="nx">getEnforcing</span> <span class="o">&lt;</span> <span class="nx">Spec</span> <span class="o">&gt;</span> <span class="p">(</span>
    <span class="s1">&#39;PlatformConstants&#39;</span><span class="p">,</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Spec</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Obtained via <code>TurboModuleRegistry.getEnforcing('PlatformConstants')</code>, continue down <a href="https://github.com/facebook/react-native/blob/master/Libraries/TurboModule/TurboModuleRegistry.js">Libraries/TurboModule/TurboModuleRegistry.js</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">NativeModules</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../BatchedBridge/NativeModules&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">turboModuleProxy</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">__turboModuleProxy</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">get</span> <span class="o">&lt;</span> <span class="nx">T</span><span class="o">:</span> <span class="nx">TurboModule</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="o">?</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">RN$Bridgeless</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Backward compatibility layer during migration.
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">legacyModule</span> <span class="o">=</span> <span class="nx">NativeModules</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">legacyModule</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">((</span><span class="nx">legacyModule</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">T</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">turboModuleProxy</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">module</span><span class="o">:</span> <span class="o">?</span> <span class="nx">T</span> <span class="o">=</span> <span class="nx">turboModuleProxy</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">module</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">getEnforcing</span> <span class="o">&lt;</span> <span class="nx">T</span><span class="o">:</span> <span class="nx">TurboModule</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">module</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>A big pile of stuff, just one goal, to get a native module named <code>PlatformConstants</code>, that find this native module can reveal the secret, by searching <code>PlatformConstants</code>, you can find its native implementation in <a href="https://github.com/facebook/react-native/blob/3b6f6ca4d5fcee6f1bc6d6242e3e2ef136e4d546/ReactAndroid/src/main/java/com/facebook/react/modules/systeminfo/AndroidInfoModule.java">ReactAndroid/src/main/java/com/facebook/react/modules/systeminfo/AndroidInfoModule.java</a>, key code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="err">@</span><span class="nx">Override</span>
<span class="kr">public</span> <span class="err">@</span><span class="nx">Nullable</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Object</span><span class="o">&gt;</span> <span class="nx">getConstants</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Object</span><span class="o">&gt;</span> <span class="nx">constants</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="p">...</span>

    <span class="nx">constants</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&#34;reactNativeVersion&#34;</span><span class="p">,</span> <span class="nx">ReactNativeVersion</span><span class="p">.</span><span class="nx">VERSION</span><span class="p">);</span>

    <span class="p">...</span>

    <span class="k">return</span> <span class="nx">constants</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Continue to <a href="https://github.com/facebook/react-native/blob/3b6f6ca4d5/ReactAndroid/src/main/java/com/facebook/react/modules/systeminfo/ReactNativeVersion.java">ReactAndroid/src/main/java/com/facebook/react/modules/systeminfo/ReactNativeVersion.java</a> in the same directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">public</span> <span class="kr">class</span> <span class="nx">ReactNativeVersion</span> <span class="p">{</span>
    <span class="kr">public</span> <span class="kr">static</span> <span class="kr">final</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Object</span><span class="o">&gt;</span> <span class="nx">VERSION</span> <span class="o">=</span> <span class="nx">MapBuilder</span><span class="p">.</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Object</span><span class="o">&gt;</span><span class="k">of</span><span class="p">(</span>
        <span class="s2">&#34;major&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&#34;minor&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&#34;patch&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&#34;prerelease&#34;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s the same as the js side, both are 0, which we&rsquo;ll discuss later. As you can see, <code>Platform.constants.reactNativeVersion</code> is defined on the java side, and eventually in the native code, the <code>com.facebook.react:react-native:0.59.9</code> we referenced in the build.gradle file contains this code. contains this code.</p>
<h2 id="phase-summary">Phase Summary</h2>
<p>As you can see, there is a version number on the js side and also a version number on the java side, both will be judged at startup and an error will be thrown if they are not the same.</p>
<p>The js and java are two dependencies, the js part is dependent in <code>package.json</code> and the java part is dependent in <code>android/app/build.gradle</code>, the two must match to work well, hence the above check work.</p>
<blockquote>
<p>By analyzing the startup source code, we found that the check is actually performed only in the development environment, while the production environment does not have this section</p>
</blockquote>
<blockquote>
<p>Generally speaking, the development environment performs stricter checks than the production environment to ensure that development errors are exposed in a timely manner, while the production environment removes code that has nothing to do with the main function to ensure maximum efficiency at runtime. This can be said to be a means of handling most libraries, strict development and release, worth learning from</p>
</blockquote>
<h3 id="how-to-set-the-version-number">How to set the version number</h3>
<p>If you look at the source code, you can see that the version number is 0. Then you can check the directory <a href="https://github.com/facebook/react-native/tree/3b6f6ca4d5fcee6f1bc6d6242e3e2ef136e4d546/scripts/versiontemplates">scripts/versiontemplates</a>`, under which is the template for setting the version number, and the real operation is done in <a href="https://github.com/facebook/react-native/tree/3b6f6ca4d5fcee6f1bc6d6242e3e2ef136e4d546/scripts/versiontemplates">scripts/bump-oss-version.js#L60</a>. This script takes a version number, fills in the previous template and overwrites the corresponding file in the project. This script is executed at release time, see <a href="https://github.com/facebook/react-native/blob/master/Releases.md#step-2-cut-a-release-branch-and-push-to-github">step-2-cut-a-release-branch-and-push-to-github</a> for details, and everything is clear up to that point.</p>
<p>So the version number is set up by script at release time, and is set up uniformly by way of templates to avoid manual changes and omissions</p>
<blockquote>
<p>Template part is a simple replacement, did not refer to the additional template engine, can be simple to deal with will never get complicated, this is worth learning</p>
</blockquote>
<blockquote>
<p>A lot of scripts are written in js, so it is very easy to read and modify, we can also use js to deal with scripts, not to mention scripts on bash, python, in fact, js is also very popular</p>
</blockquote>
<h3 id="what-happens-when-this-error-occurs">What happens when this error occurs</h3>
<p>I encountered this case because the colleague used RN 0.55.4 to do manual packaging and uploaded the packaged js file to the repository, and then upgraded RN to 0.59.9.</p>
<p>From the previous source code analysis, if the wrong version of packager is started during development, it is also possible to generate this problem. We can understand that this mechanism is to ensure that the version of the js file downloaded from packager is the same for the currently running App, so that we can avoid continuing development on the wrong version, which will lead to the spread of the problem and not facilitate the troubleshooting of the final problem.</p>
<p>When we run into this problem, it is usually caused by the packager starting the wrong version. Secondly, unless you know what you are doing, it is strictly forbidden to generate js packages manually, and this part should be left to RN&rsquo;s packaging scripts to execute and maintain, and cannot be submitted to the repository.</p>
<h3 id="why-is-there-this-check">Why is there this check</h3>
<p>I didn&rsquo;t find the relevant instructions, but I can speculate. Personally, I think it is the RN development model that leads to the development stage, the computer will start a server, which is the packager mentioned above, used to distribute the latest js file, which is also the basis for the RN development stage can quickly update the code, because the distribution is independent, so this part is likely to happen version inconsistent problem, and version inconsistent is not affect most of the development, because the API is mostly compatible design, if you let this behavior, to the late development problems, troubleshooting will be very difficult. This is the basis for the rapid update of code in the development phase. And in the release phase, because all scripts are automatically executed, this part is relatively safe a lot.</p>
<blockquote>
<p>Very often, some hard problems are caused by low-level errors, only the problems are hidden at the beginning and explode in the middle and late stages, when it is very time-consuming to troubleshoot them. Especially for open source projects like RN, it is a huge waste of resources if there are a lot of &ldquo;hard problems&rdquo; in issues that are caused by low-level errors. From this point of view, these basic tests are still necessary</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>In the development environment, the version numbers of both js and java are checked during the RN startup phase and matched before the actual system startup process begins. Adding this step of checking is to ensure the consistency of the development base environment and to ensure the development goes smoothly.</p>
<p>Also in the process of tracing the source code, you can learn a lot, including the design of the library, the differentiation between the development environment and the production environment, the template design, etc. For open source project errors, many times we can understand the nature of the problem through the source code, which is a great help to our development and learning.</p>
<hr>
<p>Reference <code>https://xiaomi-info.github.io/2020/01/02/react-native-version-check/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/react-native/">react-native</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-06/angular-or-ionic-exception-handling-errorhandler/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Angular or Ionic Exception Handling ErrorHandler</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-06/clipboard-operations-clipboard-api-tutorial/">
            <span class="next-text nav-default">Clipboard Operations Clipboard Api Tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
