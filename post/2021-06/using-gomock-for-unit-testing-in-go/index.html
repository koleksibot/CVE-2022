<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Using Gomock for Unit Testing in Go - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In real projects, when you need to do unit testing. But often you find that there are a lot of dependencies. That&amp;rsquo;s where Gomock comes in handy!
Gomock is an official mock framework for the Go language
Installation 1 2  $ go get -u github.com/golang/mock/gomock $ go install github.com/golang/mock/mockgen     Step 1: We will install the gomock third-party library and the mock code generation tool, mockgen, which will save us a lot of work." /><meta name="keywords" content="golang,gomock,test" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-06/using-gomock-for-unit-testing-in-go/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Using Gomock for Unit Testing in Go" />
<meta property="og:description" content="In real projects, when you need to do unit testing. But often you find that there are a lot of dependencies. That&rsquo;s where Gomock comes in handy!
Gomock is an official mock framework for the Go language
Installation 1 2  $ go get -u github.com/golang/mock/gomock $ go install github.com/golang/mock/mockgen     Step 1: We will install the gomock third-party library and the mock code generation tool, mockgen, which will save us a lot of work." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-06/using-gomock-for-unit-testing-in-go/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-17T20:27:57+08:00" />
<meta property="article:modified_time" content="2021-06-17T20:27:57+08:00" />

<meta itemprop="name" content="Using Gomock for Unit Testing in Go">
<meta itemprop="description" content="In real projects, when you need to do unit testing. But often you find that there are a lot of dependencies. That&rsquo;s where Gomock comes in handy!
Gomock is an official mock framework for the Go language
Installation 1 2  $ go get -u github.com/golang/mock/gomock $ go install github.com/golang/mock/mockgen     Step 1: We will install the gomock third-party library and the mock code generation tool, mockgen, which will save us a lot of work."><meta itemprop="datePublished" content="2021-06-17T20:27:57+08:00" />
<meta itemprop="dateModified" content="2021-06-17T20:27:57+08:00" />
<meta itemprop="wordCount" content="1355">
<meta itemprop="keywords" content="golang,gomock,test," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Gomock for Unit Testing in Go"/>
<meta name="twitter:description" content="In real projects, when you need to do unit testing. But often you find that there are a lot of dependencies. That&rsquo;s where Gomock comes in handy!
Gomock is an official mock framework for the Go language
Installation 1 2  $ go get -u github.com/golang/mock/gomock $ go install github.com/golang/mock/mockgen     Step 1: We will install the gomock third-party library and the mock code generation tool, mockgen, which will save us a lot of work."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Using Gomock for Unit Testing in Go</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-06-17 20:27:57 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/tools/"> tools </a>
            </div>
          <span class="more-meta"> 1355 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#usage">Usage</a></li>
          </ul>
        </li>
        <li><a href="#writing-test-cases">Writing test cases</a>
          <ul>
            <li><a href="#steps">Steps</a></li>
            <li><a href="#catalog">Catalog</a></li>
            <li><a href="#writing">Writing</a></li>
            <li><a href="#view-the-test">View the test</a></li>
          </ul>
        </li>
        <li><a href="#more">More</a>
          <ul>
            <li><a href="#1-common-mock-methods">1. Common mock methods</a></li>
            <li><a href="#parameter-matching">Parameter Matching</a></li>
            <li><a href="#2-generate-multiple-mock-files">2. Generate multiple mock files</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In real projects, when you need to do unit testing. But often you find that there are a lot of dependencies. That&rsquo;s where Gomock comes in handy!</p>
<p>Gomock is an official mock framework for the Go language</p>
<h2 id="installation">Installation</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go get -u github.com/golang/mock/gomock
$ go install github.com/golang/mock/mockgen
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Step 1: We will install the gomock third-party library and the mock code generation tool, mockgen, which will save us a lot of work. Just to understand how to use it</p>
</li>
<li>
<p>Step 2: Enter mockgen to verify that the code generation tool is installed correctly. If it does not respond properly, please check if the bin directory contains the binary file</p>
</li>
</ul>
<h3 id="usage">Usage</h3>
<p>In the <code>mockgen</code> command, two generation modes are supported</p>
<ol>
<li><code>source</code>: generate <code>mock</code> interface from source files (enabled via <code>-source</code>)</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">mockgen -source<span class="o">=</span>foo.go <span class="o">[</span>other options<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><code>reflect</code>: generates the <code>mock</code> interface by using a reflection procedure. It is enabled by passing two non-flagged parameters: the import path and a comma-separated list of interfaces</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">mockgen database/sql/driver Conn,Driver
</code></pre></td></tr></table>
</div>
</div><p>In essence, there is no difference between the mock code generated by the two approaches. So just choose the right one</p>
<h2 id="writing-test-cases">Writing test cases</h2>
<p>In this article, we will simulate a simple demo to write test cases and get familiar with the overall testing process.</p>
<h3 id="steps">Steps</h3>
<ol>
<li>Figure out the overall logic</li>
<li>Define the interface for the desired (simulated) dependencies</li>
<li>Use the <code>mockgen</code> command to generate a mock file for the <code>interface</code> of the required <code>mock</code></li>
<li>Write the logic for the unit tests and use mock in the tests</li>
<li>Perform unit test validation</li>
</ol>
<h3 id="catalog">Catalog</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">â”œâ”€â”€ mock
â”œâ”€â”€ person
â”‚   â””â”€â”€ male.go
â””â”€â”€ user
    â”œâ”€â”€ user.go
    â””â”€â”€ user_test.go
</code></pre></td></tr></table>
</div>
</div><h3 id="writing">Writing</h3>
<h4 id="interface-method">interface method</h4>
<p>Open the person/male.go file and write the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">person</span>

<span class="kd">type</span> <span class="nx">Male</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="calling-methods">Calling Methods</h4>
<p>Open the user/user.go file and write the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">user</span>

<span class="kn">import</span> <span class="s">&#34;github.com/EDDYCJY/mockd/person&#34;</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Person</span> <span class="nx">person</span><span class="p">.</span><span class="nx">Male</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewUser</span><span class="p">(</span><span class="nx">p</span> <span class="nx">person</span><span class="p">.</span><span class="nx">Male</span><span class="p">)</span> <span class="o">*</span><span class="nx">User</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span><span class="nx">Person</span><span class="p">:</span> <span class="nx">p</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Person</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="generate-a-mock-file">Generate a mock file</h4>
<p>Go back to the root directory of <code>mockd/</code> and execute the following command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ mockgen -source<span class="o">=</span>./person/male.go -destination<span class="o">=</span>./mock/male_mock.go -package<span class="o">=</span>mock
</code></pre></td></tr></table>
</div>
</div><p>After the execution, you can find the <code>male_mock.go</code> file in the <code>mock/</code> directory, which is the <code>mock</code> file. What is the purpose of the commands in the command? As follows.</p>
<ul>
<li><code>-source</code>: set the interface file to be mocked</li>
<li><code>-destination</code>: set where the mock file is output, or print to standard output if not set</li>
<li><code>-package</code>: set the package name of the mock file, if not set it will be the <code>mock_</code> prefix plus the file name (e.g. the package name in this article will be mock_person)</li>
</ul>
<p>For more information on the command line, see the <a href="https://github.com/golang/mock#running-mockgen">official documentation</a></p>
<h5 id="the-output-mock-file">The output mock file</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by MockGen. DO NOT EDIT.
</span><span class="c1">// Source: ./person/male.go
</span><span class="c1"></span>
<span class="c1">// Package mock is a generated GoMock package.
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">mock</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="nx">gomock</span> <span class="s">&#34;github.com/golang/mock/gomock&#34;</span>
	<span class="nx">reflect</span> <span class="s">&#34;reflect&#34;</span>
<span class="p">)</span>

<span class="c1">// MockMale is a mock of Male interface
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MockMale</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ctrl</span>     <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Controller</span>
	<span class="nx">recorder</span> <span class="o">*</span><span class="nx">MockMaleMockRecorder</span>
<span class="p">}</span>

<span class="c1">// MockMaleMockRecorder is the mock recorder for MockMale
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MockMaleMockRecorder</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">mock</span> <span class="o">*</span><span class="nx">MockMale</span>
<span class="p">}</span>

<span class="c1">// NewMockMale creates a new mock instance
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewMockMale</span><span class="p">(</span><span class="nx">ctrl</span> <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Controller</span><span class="p">)</span> <span class="o">*</span><span class="nx">MockMale</span> <span class="p">{</span>
	<span class="nx">mock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">MockMale</span><span class="p">{</span><span class="nx">ctrl</span><span class="p">:</span> <span class="nx">ctrl</span><span class="p">}</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nx">recorder</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">MockMaleMockRecorder</span><span class="p">{</span><span class="nx">mock</span><span class="p">}</span>
	<span class="k">return</span> <span class="nx">mock</span>
<span class="p">}</span>

<span class="c1">// EXPECT returns an object that allows the caller to indicate expected use
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MockMale</span><span class="p">)</span> <span class="nf">EXPECT</span><span class="p">()</span> <span class="o">*</span><span class="nx">MockMaleMockRecorder</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">recorder</span>
<span class="p">}</span>

<span class="c1">// Get mocks base method
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MockMale</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;Get&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
	<span class="nx">ret0</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="kt">error</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ret0</span>
<span class="p">}</span>

<span class="c1">// Get indicates an expected call of Get
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">mr</span> <span class="o">*</span><span class="nx">MockMaleMockRecorder</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Call</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">mr</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">RecordCallWithMethodType</span><span class="p">(</span><span class="nx">mr</span><span class="p">.</span><span class="nx">mock</span><span class="p">,</span> <span class="s">&#34;Get&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">((</span><span class="o">*</span><span class="nx">MockMale</span><span class="p">)(</span><span class="kc">nil</span><span class="p">).</span><span class="nx">Get</span><span class="p">),</span> <span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="test-cases">Test cases</h4>
<p>Open the <code>user/user_test.go</code> file and write the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">user</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;testing&#34;</span>

	<span class="s">&#34;github.com/EDDYCJY/mockd/mock&#34;</span>

	<span class="s">&#34;github.com/golang/mock/gomock&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestUser_GetUserInfo</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ctl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ctl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>

	<span class="kd">var</span> <span class="nx">id</span> <span class="kt">int64</span> <span class="p">=</span> <span class="mi">1</span>
	<span class="nx">mockMale</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">NewMockMale</span><span class="p">(</span><span class="nx">ctl</span><span class="p">)</span>
	<span class="nx">gomock</span><span class="p">.</span><span class="nf">InOrder</span><span class="p">(</span>
		<span class="nx">mockMale</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="nx">user</span> <span class="o">:=</span> <span class="nf">NewUser</span><span class="p">(</span><span class="nx">mockMale</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.</span><span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;user.GetUserInfo err: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li><code>gomock.NewController</code>: Returns <code>gomock.Controller</code>, which represents the top-level control in the mock ecosystem. Defines the scope, lifecycle and expected values of a mock object. In addition it is safe across multiple goroutines</li>
<li><code>mock.NewMockMale</code>: Creates a new mock instance</li>
<li><code>gomock.InOrder</code>: declares that the given calls should be made in order (is a secondary wrapper around gomock.</li>
<li><code>mockMale.EXPECT().Get(id).Return(nil)</code>: There are three steps here, EXPECT() returns an object that allows the caller to set the expectation and return value. get(id) sets the input and calls the method in the mock instance. return(nil) sets the output of the previously called method. Return(nil) is to set the reference of the previously called method. In short, it sets the entry and calls it, and finally sets the return value</li>
<li><code>NewUser(mockMale)</code>: creates the User instance, notably, the mock object is injected here, so it&rsquo;s actually in the subsequent user.GetUserInfo(id) call (input: id is 1). It calls the mock method that we have mocked beforehand</li>
<li><code>ctl.Finish()</code>: asserts the expected value of the mock use case, usually with <code>deferral</code> to prevent us from forgetting this operation</li>
</ol>
<h4 id="testing">Testing</h4>
<p>Go back to the root directory of <code>mockd/</code> and execute the following command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go <span class="nb">test</span> ./user
ok  	github.com/EDDYCJY/mockd/user
</code></pre></td></tr></table>
</div>
</div><p>When you see the result like this, you&rsquo;re done! You can adjust the return value of Return() yourself to get different test results ðŸ˜„</p>
<h3 id="view-the-test">View the test</h3>
<h4 id="test-coverage">Test Coverage</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go <span class="nb">test</span> -cover ./user
ok  	github.com/EDDYCJY/mockd/user	<span class="o">(</span>cached<span class="o">)</span>	coverage: 100.0% of statements
</code></pre></td></tr></table>
</div>
</div><p>Coverage statistics can be turned on by setting the <code>-cover</code> flag to display <code>coverage: 100.0%</code>.</p>
<h4 id="visualization-interface">Visualization interface</h4>
<ol>
<li>Generate a test coverage profile file</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go <span class="nb">test</span> ./... -coverprofile<span class="o">=</span>cover.out
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Generating visual interfaces with profile files</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">go tool cover -html<span class="o">=</span>cover.out
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>View visual interface to analyze coverage</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/06/17/a43aec6a317b426d9d3c4f38e2112cf1.png" alt="-"></p>
<h2 id="more">More</h2>
<h3 id="1-common-mock-methods">1. Common mock methods</h3>
<h4 id="calling-methods-1">Calling Methods</h4>
<ul>
<li><code>Call.Do()</code>: declares the action to be run when matching</li>
<li><code>Call.DoAndReturn()</code>: declares the action to be run when matching the call and simulates returning the return value of the function</li>
<li><code>MaxTimes()</code>: set the maximum number of calls to n</li>
<li><code>Call.MinTimes()</code>: sets the minimum number of calls to n</li>
<li><code>AnyTimes()</code>: allow 0 or more calls</li>
<li><code>Times()</code>: set the number of calls to n</li>
</ul>
<h3 id="parameter-matching">Parameter Matching</h3>
<ul>
<li><code>gomock.Any()</code>: match any value</li>
<li><code>gomock.Eq()</code>: match to the specified type value by reflection, no need to set it manually</li>
<li><code>gomock.Nil()</code>: return nil</li>
</ul>
<p>More suggested methods can be found in the <a href="https://godoc.org/github.com/golang/mock/gomock#pkg-index">official documentation</a></p>
<h3 id="2-generate-multiple-mock-files">2. Generate multiple mock files</h3>
<p>Officially, we can use <code>go:generate</code> to do batch processing in a more convenient way</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">go generate <span class="o">[</span>-run regexp<span class="o">]</span> <span class="o">[</span>-n<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-x<span class="o">]</span> <span class="o">[</span>build flags<span class="o">]</span> <span class="o">[</span>file.go... <span class="p">|</span> packages<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="modify-the-interface-method">Modify the interface method</h4>
<p>Open the <code>person/male.go</code> file and change it to the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">person</span>

<span class="c1">//go:generate mockgen -destination=../mock/male_mock.go -package=mock github.com/EDDYCJY/mockd/person Male
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Male</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We focus on the statement <code>go:generate</code>, which can be divided into the following parts.</p>
<ul>
<li>Declare <code>//go:generate</code> (be careful not to leave spaces)</li>
<li>Use the <code>mockgen</code> command</li>
<li>Define <code>-destination</code></li>
<li>Define <code>-package</code></li>
<li>Define <code>source</code>, in this case the package path for <code>person</code></li>
<li>Define <code>-interfaces</code>, in this case <code>Male</code></li>
</ul>
<h4 id="regenerate-the-mock-file">Regenerate the mock file</h4>
<p>Go back to the root directory of <code>mockd/</code> and execute the following command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go generate ./...
</code></pre></td></tr></table>
</div>
</div><p>Checking <code>mock/</code> again shows that it has also been generated correctly, which is convenient when there are multiple files ðŸ¤©</p>
<h2 id="summary">Summary</h2>
<p>In the unit testing loop, <code>gomock</code> gives us a great deal of convenience. The ability to <code>mock</code> a lot of dependencies</p>
<p>There are a lot of ways to use it and a lot of features. You can mark it and read the official documentation to remember it better</p>
<hr>
<p>Reference <code>https://eddycjy.com/posts/go/talk/2018-11-25-gomock/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/gomock/">gomock</a>
          <a href="/tags/test/">test</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-06/postgresql-jsonpath-usage-in-practice/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">PostgreSQL Jsonpath Usage in Practice</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-06/rsync-usage-tutorial/">
            <span class="next-text nav-default">Rsync Usage Tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
