<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Does the original TCP connection still exist after disconnecting the network cable? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Today, let&amp;rsquo;s talk about an interesting question: Unplug the cable for a few seconds, then plug it back in, does the original TCP connection still exist?
Some people may say that if the cable is unplugged, it means the physical layer is disconnected, so the upper transport layer should also be disconnected, so the original TCP connection will not exist. Just like when we make a wired phone call, if one party&amp;rsquo;s phone line is unplugged, the call is completely disconnected." /><meta name="keywords" content="tcp, linux" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/tcp-connection/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Does the original TCP connection still exist after disconnecting the network cable?" />
<meta property="og:description" content="Today, let&rsquo;s talk about an interesting question: Unplug the cable for a few seconds, then plug it back in, does the original TCP connection still exist?
Some people may say that if the cable is unplugged, it means the physical layer is disconnected, so the upper transport layer should also be disconnected, so the original TCP connection will not exist. Just like when we make a wired phone call, if one party&rsquo;s phone line is unplugged, the call is completely disconnected." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/tcp-connection/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-13T11:08:23+08:00" />
<meta property="article:modified_time" content="2022-02-13T11:08:23+08:00" />

<meta itemprop="name" content="Does the original TCP connection still exist after disconnecting the network cable?">
<meta itemprop="description" content="Today, let&rsquo;s talk about an interesting question: Unplug the cable for a few seconds, then plug it back in, does the original TCP connection still exist?
Some people may say that if the cable is unplugged, it means the physical layer is disconnected, so the upper transport layer should also be disconnected, so the original TCP connection will not exist. Just like when we make a wired phone call, if one party&rsquo;s phone line is unplugged, the call is completely disconnected."><meta itemprop="datePublished" content="2022-02-13T11:08:23+08:00" />
<meta itemprop="dateModified" content="2022-02-13T11:08:23+08:00" />
<meta itemprop="wordCount" content="1801">
<meta itemprop="keywords" content="tcp,linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Does the original TCP connection still exist after disconnecting the network cable?"/>
<meta name="twitter:description" content="Today, let&rsquo;s talk about an interesting question: Unplug the cable for a few seconds, then plug it back in, does the original TCP connection still exist?
Some people may say that if the cable is unplugged, it means the physical layer is disconnected, so the upper transport layer should also be disconnected, so the original TCP connection will not exist. Just like when we make a wired phone call, if one party&rsquo;s phone line is unplugged, the call is completely disconnected."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Does the original TCP connection still exist after disconnecting the network cable?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-13 11:08:23 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1801 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#data-transmission-after-unplugging-the-network-cable">Data transmission after unplugging the network cable</a></li>
        <li><a href="#no-data-transfer-after-disconnecting-the-network-cable">No data transfer after disconnecting the network cable</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Today, let&rsquo;s talk about an interesting question: <strong>Unplug the cable for a few seconds, then plug it back in, does the original TCP connection still exist?</strong></p>
<p>Some people may say that if the cable is unplugged, it means the physical layer is disconnected, so the upper transport layer should also be disconnected, so the original TCP connection will not exist. Just like when we make a wired phone call, if one party&rsquo;s phone line is unplugged, the call is completely disconnected.</p>
<p>Is this really the case?</p>
<p>There is a problem with this logic. The problem is that the wrong assumption is made that unplugging the cable affects the transport layer, when in fact it does not.</p>
<p>In fact, a TCP connection is a structure in the Linux kernel called <code>struct socket</code>, which contains information such as the state of the TCP connection. When the cable is unplugged, the OS doesn&rsquo;t change anything in that structure, so the state of the TCP connection doesn&rsquo;t change either.</p>
<p>I did a small experiment on my computer, I connected to my cloud server with ssh terminal, then I simulated the disconnection scenario by disconnecting the wifi, at this time the status of the TCP connection did not change, it was still in ESTABLISHED state.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/24714ce4cfe24dba9088fc25e0985c27.png" alt="sobyte"></p>
<p>From the results of this experiment, we know that the action of unplugging the cable does not affect the state of the TCP connection.</p>
<p>The next step is to see what the two parties do after the cable is unplugged.</p>
<p>To address this issue, we need to discuss it in different scenarios.</p>
<ul>
<li>After unplugging the network cable, there is data transmission.</li>
<li>After unplugging the network cable, there is no data transfer.</li>
</ul>
<h2 id="data-transmission-after-unplugging-the-network-cable">Data transmission after unplugging the network cable</h2>
<p>After the client unplugs the network cable, the data message sent by the server to the client will not get any response. After waiting for a certain length of time, the server will trigger the <strong>timeout retransmission</strong> mechanism to retransmit the unansmitted data message.</p>
<p><strong>If the client happens to plug the network cable back in during the retransmission of the message from the server</strong>, since unplugging the network cable does not change the TCP connection status of the client, and it is still in ESTABLISHED state, the client can normally receive the data message from the server, and then the client will return the ACK response message.</p>
<p>At this point, the TCP connection between the client and the server still exists, and it feels like nothing has happened.</p>
<p>However, <strong>if the client does not plug the cable back in during the retransmission of the message from the server</strong> and the number of retransmissions from the server reaches a certain threshold, the kernel will determine that there is a problem with the TCP and tell the application through the socket interface that there is a problem with the TCP connection, and the TCP connection from the server will be disconnected.</p>
<p>After the client is plugged back in, if the client sends data to the server, the kernel on the server side will reply with an RST message, and the client will release the TCP connection after receiving it, since there is no more TCP connection with the same quaternion as the client.</p>
<p>At this point, both the client and server TCP connections are disconnected.</p>
<blockquote>
<p>How many times are the TCP data messages retransmitted?</p>
</blockquote>
<p>On Linux systems, a configuration item called tcp_retries2 is provided, and the default value is 15, as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/12c6886f74f94aab9635d151be57787f.png" alt="sobyte"></p>
<p>This kernel parameter controls the maximum number of timeout retransmissions in case a TCP connection is established.</p>
<p>However, just because tcp_retries2 is set 15 times, it does not mean that the TCP connection will be terminated after 15 retransmissions, but the kernel also determines this based on the &ldquo;maximum timeout&rdquo;.</p>
<p>Each timeout round is multiplied, for example, the first timeout retransmission is triggered after 2s, the second after 4s, the third after 8s, and so on.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/b8351f9331da4b07ac2200eaa4ca8c57.png" alt="sobyte"></p>
<p>The kernel will calculate a maximum timeout based on the value set by tcp_retries2.</p>
<p>If a message is retransmitted and no response is received from the other party, the retransmission will be stopped and the TCP connection will be disconnected after one of the two conditions, &ldquo;maximum number of retransmissions&rdquo; or &ldquo;maximum timeout&rdquo;, is reached first.</p>
<h2 id="no-data-transfer-after-disconnecting-the-network-cable">No data transfer after disconnecting the network cable</h2>
<p>For the scenario where there is no data transfer after the cable is unplugged, it depends on whether the TCP keepalive mechanism (TCP keepalive mechanism) is enabled or not.</p>
<p>If <strong>TCP keepalive is not enabled</strong>, the TCP connection between the client and the server will always exist after the client is unplugged and no data is transferred from either side.</p>
<p>If <strong>TCP keepalive is enabled</strong>, after the client is unplugged, even if neither side is transmitting, TCP will send probe messages after a period of time.</p>
<ul>
<li>
<p>if <strong>the opposite end is working properly</strong>. When a TCP alive probe message is sent to the other side, the other side will respond normally so that <strong>TCP alive time will be reset</strong> and wait for the next TCP alive time to come.</p>
</li>
<li>
<p>If <strong>the peer host crashes, or the peer is unreachable for other reasons</strong>. When a TCP alive probe message is sent to the other end and sinks in stone with no response, several times in a row, after reaching the number of alive probes, <strong>TCP reports that the TCP connection is dead</strong>.</p>
</li>
</ul>
<p>Therefore, the TCP keepalive mechanism can be used to determine if the other TCP connection is alive by probing messages when there is no data interaction between the two parties.</p>
<blockquote>
<p>What exactly does the TCP keepalive mechanism look like?</p>
</blockquote>
<p>The mechanism works like this.</p>
<p>If there is no connection-related activity during this time period, the TCP keepalive mechanism kicks in and sends a probe message every time interval, which contains very little data. If there is no response to several consecutive probe messages, the current TCP connection is considered dead and the kernel notifies the higher-level application of the error.</p>
<p>There are parameters in the Linux kernel to set the live time, the number of live probes, and the time interval of live probes, the following are the default values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">net.ipv4.tcp_keepalive_time=7200
net.ipv4.tcp_keepalive_intvl=75  
net.ipv4.tcp_keepalive_probes=9
</code></pre></td></tr></table>
</div>
</div><ul>
<li>tcp_keepalive_time=7200: indicates that the keepalive time is 7200 seconds (2 hours), which means that if there is no connection-related activity for 2 hours, the keepalive mechanism will be activated.</li>
<li>tcp_keepalive_intvl=75: indicates that the interval between each detection is 75 seconds.</li>
<li>tcp_keepalive_probes=9: means that if there is no response after 9 detections, the other side is considered unreachable and the connection is broken.</li>
</ul>
<p>In other words, it takes at least 2 hours, 11 minutes and 15 seconds to find a &ldquo;dead&rdquo; connection on a Linux system.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/ff5a9feda50c49c6bf9f3277daf738aa.png" alt="sobyte"></p>
<p>Note that applications that want to use the TCP keep-alive mechanism need to set the <code>SO_KEEPALIVE</code> option through the socket interface for it to take effect. If it is not set, then the TCP keepalive mechanism cannot be used.</p>
<blockquote>
<p>The TCP keepalive mechanism takes too long to detect, right?</p>
</blockquote>
<p>Yes, it is a bit long.</p>
<p>TCP keepalive is implemented at the <strong>TCP layer (kernel state)</strong> as a bottom-up solution for all TCP-based transport protocols.</p>
<p>In fact, our application layer can implement its own detection mechanism that can detect whether the other side is alive or not in a shorter period of time.</p>
<p>For example, web service software generally provides the <code>keepalive_timeout</code> parameter to specify the timeout for HTTP long connections. If the timeout for HTTP long connections is set to 60 seconds, the web service software will <strong>start a timer</strong> and if the client does not initiate a new request within 60 seconds after sending an HTTP request, <strong>the timer will trigger a callback function to release the connection when the time is up.</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/fb3ed441111e4b608164dd180bc1ea19.png" alt="sobyte"></p>
<h2 id="summary">Summary</h2>
<p>When the client unplugs the network cable, it does not directly affect the TCP connection status. Therefore, whether the TCP connection still exists after the cable is unplugged depends on whether there is data transfer after the cable is unplugged.</p>
<p>Cases with data transfer.</p>
<ul>
<li>
<p>After the client unplugs the cable, if the server sends a data message, then the client plugs back in the cable before the number of retransmissions from the server reaches the maximum, then the original TCP connection between the two sides can still exist normally as if nothing has happened.</p>
</li>
<li>
<p>If the server sends a data message after the client unplugs the cable, the server will disconnect the TCP connection when the number of retransmissions reaches the maximum before the client plugs the cable back in. When the client sends data to the server after plugging back in the network cable, the server will return the RST message because it has already disconnected the TCP connection with the same quaternion as the client, and the client will disconnect the TCP connection after receiving it. At this point, both TCP connections are disconnected.</p>
</li>
</ul>
<p>In case of no data transfer.</p>
<ul>
<li>
<p>If both sides do not enable TCP keepalive mechanism, then after the client unplugs the network cable, if the client does not plug back the network cable, then the TCP connection status between the client and the server will always exist.</p>
</li>
<li>
<p>If both sides have enabled TCP keepalive mechanism, then after the client unplugs the cable, if the client does not plug back in, the TCP keepalive mechanism will detect that the TCP connection of the other side is not alive, and will disconnect the TCP connection. If the client plugs back in during the TCP probe, the original TCP connection between the two parties can still exist normally.</p>
</li>
</ul>
<p>In addition to the scenario where the client unplugs the network cable, there are also two scenarios where the client &ldquo;goes down and kills the process&rdquo;.</p>
<p>In the first scenario, the fact that the client is down is not perceived by the server as well as the unplugged cable, so if there is no data transfer and the TCP keepalive mechanism is not enabled, <strong>the TCP connection on the server will remain in ESTABLISHED connection</strong> until the server restarts the process.</p>
<p>So, we can learn one point. In the case where the TCP keepalive mechanism is not used and both sides are not transferring data, just because one side&rsquo;s TCP connection is in the ESTABLISHED state does not mean that the other side&rsquo;s TCP connection is still normal.</p>
<p>In the second scenario, after killing the client&rsquo;s process, the client&rsquo;s kernel sends a FIN message to the server, <strong>with four waves</strong> from the client.</p>
<p>So, even if TCP keepalive is not enabled and there is no data interaction between the two sides, if one of the processes crashes, the operating system can sense this process and will send a FIN message to the other side and then perform four TCP waves with the other side.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/tcp/">tcp</a>
          <a href="/tags/linux/">linux</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/kubernetes-scheduling-framework-and-extender/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes Scheduling Framework and Extender Comparison and Details</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/cpp-json/">
            <span class="next-text nav-default">C&#43;&#43; implementation for friendly handling of Json data</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
