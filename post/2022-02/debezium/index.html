<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Database synchronization tool Debezium - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The data in our database is always changing, and sometimes we want to listen to the changes in the database data and react according to the changes, such as updating the cache corresponding to the changed data, incrementally synchronizing to other data sources, detecting and auditing the data, and so on. And this technology is called Change Data Capture. For this technology we may know a well-known domestic framework Canal" /><meta name="keywords" content="Debezium" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/debezium/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Database synchronization tool Debezium" />
<meta property="og:description" content="The data in our database is always changing, and sometimes we want to listen to the changes in the database data and react according to the changes, such as updating the cache corresponding to the changed data, incrementally synchronizing to other data sources, detecting and auditing the data, and so on. And this technology is called Change Data Capture. For this technology we may know a well-known domestic framework Canal" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/debezium/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-11T09:42:04+08:00" />
<meta property="article:modified_time" content="2022-02-11T09:42:04+08:00" />

<meta itemprop="name" content="Database synchronization tool Debezium">
<meta itemprop="description" content="The data in our database is always changing, and sometimes we want to listen to the changes in the database data and react according to the changes, such as updating the cache corresponding to the changed data, incrementally synchronizing to other data sources, detecting and auditing the data, and so on. And this technology is called Change Data Capture. For this technology we may know a well-known domestic framework Canal"><meta itemprop="datePublished" content="2022-02-11T09:42:04+08:00" />
<meta itemprop="dateModified" content="2022-02-11T09:42:04+08:00" />
<meta itemprop="wordCount" content="1463">
<meta itemprop="keywords" content="debezium," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Database synchronization tool Debezium"/>
<meta name="twitter:description" content="The data in our database is always changing, and sometimes we want to listen to the changes in the database data and react according to the changes, such as updating the cache corresponding to the changed data, incrementally synchronizing to other data sources, detecting and auditing the data, and so on. And this technology is called Change Data Capture. For this technology we may know a well-known domestic framework Canal"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Database synchronization tool Debezium</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-11 09:42:04 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1463 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#debezium">Debezium</a></li>
        <li><a href="#spring-boot-integration-with-debezium">Spring Boot Integration with Debezium</a>
          <ul>
            <li><a href="#mysql-with-binlog-logging-turned-on">MySQL with binlog logging turned on</a></li>
            <li><a href="#spring-boot-integration-with-embedded-debezium">Spring Boot integration with embedded Debezium</a></li>
            <li><a href="#debezium-dependencies">Debezium dependencies</a></li>
            <li><a href="#declare-the-configuration">Declare the configuration</a></li>
            <li><a href="#instantiating-the-debezium-engine">Instantiating the Debezium Engine</a></li>
          </ul>
        </li>
        <li><a href="#start">Start</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The data in our database is always changing, and sometimes we want to listen to the changes in the database data and react according to the changes, such as updating the cache corresponding to the changed data, incrementally synchronizing to other data sources, detecting and auditing the data, and so on. And this technology is called <strong>Change Data Capture</strong>. For this technology we may know a well-known domestic framework <strong>Canal</strong> , very good! But one limitation of <strong>Canal</strong> is that it can only be used for <strong>Mysql</strong> change data capture. Today to introduce another more powerful distributed CDC framework <strong>Debezium</strong> .</p>
<h2 id="debezium">Debezium</h2>
<p>I&rsquo;m sure most casual developers are unfamiliar with the <strong>Debezium</strong> framework, but the company it belongs to will be no stranger to you.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/e0f6416583274c5487adcc6d80a1cec6.png" alt="redhat"></p>
<p>That&rsquo;s right the most successful in the open source world, <strong>Red Hat</strong>. <strong>Debezium</strong> is a streaming processing framework for capturing data changes, open source and free. <strong>Debezium</strong> monitors database row-level (row-level) data changes in near real-time and can react to changes. And only committed changes are visible , so do not worry about transaction problems or changes are rolled back . <strong>Debezium</strong> provides a unified model for all database change events, so there is no need to worry about the complexity of each database system. <strong>Debezium</strong> provides support for databases such as <strong>MongoDB</strong>, <strong>MySQL</strong>, <strong>PostgreSQL</strong>, <strong>SQL Server</strong>, <strong>Oracle</strong>, <strong>DB2</strong>, etc.</p>
<p>In addition, the <strong>Kafka Connector</strong> enables the development of an event stream-based change capture platform with high fault tolerance and extreme scalability.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/4b7fb57b88e44c4d931375c41f486760.png" alt="Debezium"></p>
<p>As shown in the figure, Debezium Kafka Connectors for MySQL and PostgresSQL are deployed to capture change events to both types of databases and then transfer those changes to other systems or databases (e.g. <strong>Elasticsearch</strong>, data warehouses, analytics systems) or caches via a downstream Kafka Connector.</p>
<p>Another way to play with this is to build <strong>Debezium</strong> into the application to make a message bus-like facility to pass data change events to subscribed downstream systems.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/9b73f7bfcabc4210b65621763289cdf0.png" alt="Debezium"></p>
<p><strong>Debezium</strong> also does a lot of work on data integrity and availability. <strong>Debezium</strong> keeps a history of database data changes with persistent, copy-backed logs, so your application can be stopped and restarted at any time without missing events that happened when it stopped running, ensuring that all events are handled correctly and completely.</p>
<blockquote>
<p>Later I will demonstrate a <strong>Spring Boot</strong> data capture system integrated with <strong>Debezium</strong>.</p>
</blockquote>
<h2 id="spring-boot-integration-with-debezium">Spring Boot Integration with Debezium</h2>
<p>A theoretical introduction doesn&rsquo;t give you a visual sense of what <strong>Debezium</strong> can do, so next I&rsquo;ll use the <strong>Embedded Debezium engine</strong> to demonstrate it.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/6bd84b7245e94513b15166569f517311.png" alt="Debezium"></p>
<p>As shown above, when we change a row of data in the MySQL database, the change event is captured by <strong>Debezium</strong> listening to <strong>binlog</strong> log changes in real time, and then the change event model is obtained and responded (consumed). Next, let&rsquo;s set up the environment.</p>
<h3 id="mysql-with-binlog-logging-turned-on">MySQL with binlog logging turned on</h3>
<p>To facilitate the use of MySQL&rsquo;s Docker container here, the corresponding script is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 运行mysql容器 </span>
docker run --name mysql-service -v d:/mysql/data:/var/lib/mysql -p 3306:3306 -e <span class="nv">TZ</span><span class="o">=</span>Asia/Shanghai -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="m">123456</span> -d mysql:5.7 --character-set-server<span class="o">=</span>utf8mb4 --collation-server<span class="o">=</span>utf8mb4_unicode_ci --default-time_zone<span class="o">=</span><span class="s2">&#34;+8:00&#34;</span>
<span class="c1"># 设置binlog位置</span>
docker <span class="nb">exec</span> mysql-service bash -c <span class="s2">&#34;echo &#39;log-bin=/var/lib/mysql/mysql-bin&#39; &gt;&gt; /etc/mysql/mysql.conf.d/mysqld.cnf&#34;</span>
<span class="c1"># 配置 mysql的server-id</span>
docker <span class="nb">exec</span> mysql-service bash -c <span class="s2">&#34;echo &#39;server-id=123454&#39; &gt;&gt; /etc/mysql/mysql.conf.d/mysqld.cnf&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>The above script runs a MySQL container with user name <code>root</code> and password <code>123456</code> and mounts data to local path <code>d:/mysql/data</code> with <strong>binlog</strong> logging enabled and <code>server-id</code> set to <code>123454</code>, which will be used later in the configuration.</p>
<blockquote>
<p>Note that if you don&rsquo;t use the <code>root</code> user, you need to ensure that the user has <code>SELECT</code> , <code>RELOAD</code> , <code>SHOW DATABASES</code> , <code>REPLICATION SLAVE</code> , <code>REPLICATION CLIENT</code> privileges.</p>
</blockquote>
<h3 id="spring-boot-integration-with-embedded-debezium">Spring Boot integration with embedded Debezium</h3>
<h3 id="debezium-dependencies">Debezium dependencies</h3>
<p>The following dependencies are added to the <strong>Spring Boot</strong> application.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.debezium<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>debezium-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${debezium.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.debezium<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>debezium-embedded<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${debezium.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.debezium<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>debezium-connector-mysql<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${debezium.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="declare-the-configuration">Declare the configuration</h3>
<p>Then declare the required configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">     * Debezium 配置.
</span><span class="cm">     *
</span><span class="cm">     * @return configuration
</span><span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="n">io</span><span class="o">.</span><span class="na">debezium</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">Configuration</span> <span class="nf">debeziumConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="na">debezium</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">Configuration</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
<span class="c1">//            连接器的Java类名称
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;connector.class&#34;</span><span class="o">,</span> <span class="n">MySqlConnector</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
<span class="c1">//            偏移量持久化，用来容错 默认值
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;offset.storage&#34;</span><span class="o">,</span> <span class="s">&#34;org.apache.kafka.connect.storage.FileOffsetBackingStore&#34;</span><span class="o">)</span>
<span class="c1">//                偏移量持久化文件路径 默认/tmp/offsets.dat  如果路径配置不正确可能导致无法存储偏移量 可能会导致重复消费变更
</span><span class="c1">//                如果连接器重新启动，它将使用最后记录的偏移量来知道它应该恢复读取源信息中的哪个位置。
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;offset.storage.file.filename&#34;</span><span class="o">,</span> <span class="s">&#34;C:/Users/n1/IdeaProjects/spring-boot-debezium/tmp/offsets.dat&#34;</span><span class="o">)</span>
<span class="c1">//                捕获偏移量的周期
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;offset.flush.interval.ms&#34;</span><span class="o">,</span> <span class="s">&#34;6000&#34;</span><span class="o">)</span>
<span class="c1">//               连接器的唯一名称
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;mysql-connector&#34;</span><span class="o">)</span>
<span class="c1">//                数据库的hostname
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.hostname&#34;</span><span class="o">,</span> <span class="s">&#34;localhost&#34;</span><span class="o">)</span>
<span class="c1">//                端口
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.port&#34;</span><span class="o">,</span> <span class="s">&#34;3306&#34;</span><span class="o">)</span>
<span class="c1">//                用户名
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.user&#34;</span><span class="o">,</span> <span class="s">&#34;root&#34;</span><span class="o">)</span>
<span class="c1">//                密码
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.password&#34;</span><span class="o">,</span> <span class="s">&#34;123456&#34;</span><span class="o">)</span>
<span class="c1">//                 包含的数据库列表
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.include.list&#34;</span><span class="o">,</span> <span class="s">&#34;etl&#34;</span><span class="o">)</span>
<span class="c1">//                是否包含数据库表结构层面的变更，建议使用默认值true
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;include.schema.changes&#34;</span><span class="o">,</span> <span class="s">&#34;false&#34;</span><span class="o">)</span>
<span class="c1">//                mysql.cnf 配置的 server-id
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.server.id&#34;</span><span class="o">,</span> <span class="s">&#34;123454&#34;</span><span class="o">)</span>
<span class="c1">//                 MySQL 服务器或集群的逻辑名称
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.server.name&#34;</span><span class="o">,</span> <span class="s">&#34;customer-mysql-db-server&#34;</span><span class="o">)</span>
<span class="c1">//                历史变更记录
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.history&#34;</span><span class="o">,</span> <span class="s">&#34;io.debezium.relational.history.FileDatabaseHistory&#34;</span><span class="o">)</span>
<span class="c1">//                历史变更记录存储位置 
</span><span class="c1"></span>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;database.history.file.filename&#34;</span><span class="o">,</span> <span class="s">&#34;C:/Users/n1/IdeaProjects/spring-boot-debezium/tmp/dbhistory.dat&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The configuration is divided into two parts.</p>
<ul>
<li>One part is the configuration properties of <strong>Debezium Engine</strong>, see <a href="https://debezium.io/documentation/reference/1.5/development/engine.html#engine-properties">Debezium Engine Configuration</a>.</li>
<li>One part is the configuration properties of <strong>Mysql Connector</strong>, see <a href="https://debezium.io/documentation/reference/1.5/connectors/mysql.html#mysql-connector-properties">Mysql Connector Configuration</a>.</li>
</ul>
<h3 id="instantiating-the-debezium-engine">Instantiating the Debezium Engine</h3>
<p>The application needs to start a <strong>Debezium</strong> engine for the running <strong>Mysql Connector</strong>, which runs as an asynchronous thread that wraps the entire <strong>Mysql Connector</strong> connector lifecycle. Declaring an engine requires the following steps.</p>
<ul>
<li>Declare the format of the received data change capture message, <code>JSON</code>, <code>Avro</code>, <code>Protobuf</code>, <code>Connect</code>, <code>CloudEvents</code>, etc. are provided.</li>
<li>Load the configuration defined above.</li>
<li>Declare the function method for consuming data change events.</li>
</ul>
<p>Pseudocode for the declaration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">DebeziumEngine</span><span class="o">&lt;</span><span class="n">RecordChangeEvent</span><span class="o">&lt;</span><span class="n">SourceRecord</span><span class="o">&gt;&gt;</span> <span class="n">debeziumEngine</span> <span class="o">=</span> <span class="n">DebeziumEngine</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ChangeEventFormat</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Connect</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
        <span class="o">.</span><span class="na">using</span><span class="o">(</span><span class="n">configuration</span><span class="o">.</span><span class="na">asProperties</span><span class="o">())</span>
        <span class="o">.</span><span class="na">notifying</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">handlePayload</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>handlePayload</code> method is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handlePayload</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RecordChangeEvent</span><span class="o">&lt;</span><span class="n">SourceRecord</span><span class="o">&gt;&gt;</span> <span class="n">recordChangeEvents</span><span class="o">,</span> <span class="n">DebeziumEngine</span><span class="o">.</span><span class="na">RecordCommitter</span><span class="o">&lt;</span><span class="n">RecordChangeEvent</span><span class="o">&lt;</span><span class="n">SourceRecord</span><span class="o">&gt;&gt;</span> <span class="n">recordCommitter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">recordChangeEvents</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">SourceRecord</span> <span class="n">sourceRecord</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">record</span><span class="o">();</span>
        <span class="n">Struct</span> <span class="n">sourceRecordChangeValue</span> <span class="o">=</span> <span class="o">(</span><span class="n">Struct</span><span class="o">)</span> <span class="n">sourceRecord</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">sourceRecordChangeValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 判断操作的类型 过滤掉读 只处理增删改   这个其实可以在配置中设置
</span><span class="c1"></span>            <span class="n">Envelope</span><span class="o">.</span><span class="na">Operation</span> <span class="n">operation</span> <span class="o">=</span> <span class="n">Envelope</span><span class="o">.</span><span class="na">Operation</span><span class="o">.</span><span class="na">forCode</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">sourceRecordChangeValue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">OPERATION</span><span class="o">));</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">Envelope</span><span class="o">.</span><span class="na">Operation</span><span class="o">.</span><span class="na">READ</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">record</span> <span class="o">=</span> <span class="n">operation</span> <span class="o">==</span> <span class="n">Envelope</span><span class="o">.</span><span class="na">Operation</span><span class="o">.</span><span class="na">DELETE</span> <span class="o">?</span> <span class="n">BEFORE</span> <span class="o">:</span> <span class="n">AFTER</span><span class="o">;</span>
                <span class="c1">// 获取增删改对应的结构体数据
</span><span class="c1"></span>                <span class="n">Struct</span> <span class="n">struct</span> <span class="o">=</span> <span class="o">(</span><span class="n">Struct</span><span class="o">)</span> <span class="n">sourceRecordChangeValue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
                <span class="c1">// 将变更的行封装为Map
</span><span class="c1"></span>                <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="na">schema</span><span class="o">().</span><span class="na">fields</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">Field</span><span class="o">::</span><span class="n">name</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">fieldName</span> <span class="o">-&gt;</span> <span class="n">struct</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fieldName</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">fieldName</span> <span class="o">-&gt;</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">fieldName</span><span class="o">,</span> <span class="n">struct</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fieldName</span><span class="o">)))</span>
                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toMap</span><span class="o">(</span><span class="n">Pair</span><span class="o">::</span><span class="n">getKey</span><span class="o">,</span> <span class="n">Pair</span><span class="o">::</span><span class="n">getValue</span><span class="o">));</span>
                <span class="c1">// 这里简单打印一下
</span><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;payload = &#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The engine is started and closed to fit the Spring bean lifecycle.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DebeziumServerBootstrap</span> <span class="kd">implements</span> <span class="n">InitializingBean</span><span class="o">,</span> <span class="n">SmartLifecycle</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
    <span class="kd">private</span> <span class="n">DebeziumEngine</span><span class="o">&lt;?&gt;</span> <span class="n">debeziumEngine</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">debeziumEngine</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@SneakyThrows</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">debeziumEngine</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRunning</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">debeziumEngine</span><span class="o">,</span> <span class="s">&#34;debeziumEngine must not be null&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="start">Start</h2>
<p>Start the Spring Boot project and you can add, delete and change data to the database using various means and observe that it will print something like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">payload = {user_id=1123213, username=felord.cn, age=11 , gender=0, enabled=1}
</code></pre></td></tr></table>
</div>
</div><p>It means that <strong>Debezium</strong> has listened for changes to the database. You can think of scenarios in which this technique is useful.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/debezium/">debezium</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/java-vavr/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Functional programming class library vavr</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/redis7-multi-part-aof/">
            <span class="next-text nav-default">Design and Implementation of Redis 7.0 Multi Part AOF</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
