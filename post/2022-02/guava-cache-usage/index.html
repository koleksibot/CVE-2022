<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Usage of Guava Cache - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Preface &amp;ldquo;Caching&amp;rdquo; has always been one of the most talked about technologies among programmers, such as Redis, Encache, and Guava Cache. It&amp;rsquo;s important to acknowledge that Redis distributed caching is the most popular caching technology today, both in terms of interviewing and frequency of use, but from my personal project experience, local caching is also a very common technology. There are many articles analyzing Redis caching, such as Redis avalanche," /><meta name="keywords" content="guava, Cache, Usage" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/guava-cache-usage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Usage of Guava Cache" />
<meta property="og:description" content="Preface &ldquo;Caching&rdquo; has always been one of the most talked about technologies among programmers, such as Redis, Encache, and Guava Cache. It&rsquo;s important to acknowledge that Redis distributed caching is the most popular caching technology today, both in terms of interviewing and frequency of use, but from my personal project experience, local caching is also a very common technology. There are many articles analyzing Redis caching, such as Redis avalanche," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/guava-cache-usage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-24T19:19:12+08:00" />
<meta property="article:modified_time" content="2022-02-24T19:19:12+08:00" />

<meta itemprop="name" content="Usage of Guava Cache">
<meta itemprop="description" content="Preface &ldquo;Caching&rdquo; has always been one of the most talked about technologies among programmers, such as Redis, Encache, and Guava Cache. It&rsquo;s important to acknowledge that Redis distributed caching is the most popular caching technology today, both in terms of interviewing and frequency of use, but from my personal project experience, local caching is also a very common technology. There are many articles analyzing Redis caching, such as Redis avalanche,"><meta itemprop="datePublished" content="2022-02-24T19:19:12+08:00" />
<meta itemprop="dateModified" content="2022-02-24T19:19:12+08:00" />
<meta itemprop="wordCount" content="2148">
<meta itemprop="keywords" content="guava," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Usage of Guava Cache"/>
<meta name="twitter:description" content="Preface &ldquo;Caching&rdquo; has always been one of the most talked about technologies among programmers, such as Redis, Encache, and Guava Cache. It&rsquo;s important to acknowledge that Redis distributed caching is the most popular caching technology today, both in terms of interviewing and frequency of use, but from my personal project experience, local caching is also a very common technology. There are many articles analyzing Redis caching, such as Redis avalanche,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Usage of Guava Cache</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-24 19:19:12 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2148 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preface">Preface</a></li>
        <li><a href="#basic-usage">Basic Usage</a></li>
        <li><a href="#preload-cache">Preload Cache</a></li>
        <li><a href="#cache-expiration">Cache expiration</a>
          <ul>
            <li><a href="#cache-a-fixed-number-of-values">Cache a fixed number of values</a></li>
            <li><a href="#lru-expiration-policy">LRU expiration policy</a></li>
            <li><a href="#cache-fixed-time">Cache fixed time</a></li>
          </ul>
        </li>
        <li><a href="#cache-invalidation">Cache Invalidation</a></li>
        <li><a href="#cache-refresh">Cache Refresh</a>
          <ul>
            <li><a href="#manual-refresh">Manual refresh</a></li>
            <li><a href="#automatic-refresh">Automatic refresh</a></li>
          </ul>
        </li>
        <li><a href="#cache-hit-statistics">Cache hit statistics</a></li>
        <li><a href="#notification-mechanism-for-cache-removal">Notification mechanism for cache removal</a></li>
        <li><a href="#weak-keys--soft-values">Weak Keys &amp; Soft Values</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="preface">Preface</h2>
<p>&ldquo;Caching&rdquo; has always been one of the most talked about technologies among programmers, such as Redis, Encache, and Guava Cache. It&rsquo;s important to acknowledge that Redis distributed caching is the most popular caching technology today, both in terms of interviewing and frequency of use, but from my personal project experience, local caching is also a very common technology.</p>
<p>There are many articles analyzing Redis caching, such as Redis avalanche, Redis expiration mechanism, and so on. However, there are very few articles that analyze local caching in my image.</p>
<p>In a recent project, a new colleague used Guava Cache to cache the responses of an RPC interface, and when I reviewed his code, I happened to find a not-so-sensible way of writing it, hence this article.</p>
<p>This article will introduce some common operations of Guava Cache: basic API usage, expiration policy, and refresh policy. As is my habit, I will also include some summaries from actual development. It is important to note that I have not read the source code of Guava Cache, so I will not go into too much depth about it, as it is just some usage experience or best practices.</p>
<p>First, let&rsquo;s briefly introduce Guava Cache, which is a memory caching module in guava, the basic toolkit packaged by Google, that provides the following capabilities.</p>
<ul>
<li>Encapsulates the flow of cache-data source interaction, making development more focused on business operations</li>
<li>Provides thread-safe access operations (analogous to ConcurrentHashMap)</li>
<li>Provides common cache expiration policies and cache refresh policies</li>
<li>Provides cache hit rate monitoring</li>
</ul>
<h2 id="basic-usage">Basic Usage</h2>
<p>Introduces basic usage of Guava Cache using an example - caching case-converted return values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">String</span> <span class="nf">fetchValueFromServer</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenCacheMiss_thenFetchValueFromServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;HELLO&#34;</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">getUnchecked</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">));</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;HELLO&#34;</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">));</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The benefits of using Guava Cache are already on paper, as it decouples cache access from business operations. The <code>load</code> method of the <code>CacheLoader</code> can be understood as the entry point for loading raw data from a data source, and when the <code>getUnchecked</code> or <code>get</code> method of the LoadingCache is called, the Guava Cache behaves as follows.</p>
<ul>
<li>When the cache is not hit, the load interface is called synchronously to load into the cache and return the cache value</li>
<li>If the cache is hit, the cache value is returned directly.</li>
<li>When the multithreaded cache is not hit, thread A will block thread B&rsquo;s request when it loads until the cache is loaded</li>
</ul>
<p>Note that Guava provides two <code>getUnchecked</code> or <code>get</code> load methods, there is no big difference, no matter which one you use, you need to pay attention to the data source whether it is the return value of the RPC interface or the database, you should consider the access timeout or failure, and do a good job of handling exceptions.</p>
<h2 id="preload-cache">Preload Cache</h2>
<p>Common usage scenarios for preload caching.</p>
<ul>
<li>&ldquo;Product promotion&rdquo; scenario, cache preheating, adding hot products to the cache.</li>
<li>Preload the cache after a system restart to avoid real requests from breaking through the cache.</li>
</ul>
<p>Guava Cache provides <code>put</code> and <code>putAll</code> methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenPreloadCache_thenPut</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&#34;kirito&#34;</span><span class="o">;</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The operation is exactly the same as HashMap.</p>
<p>Here&rsquo;s a misconception that my new colleague just happened to step on, and that&rsquo;s why I wrote this article in the first place. Make sure you only use put in the preload cache scenario, and use load to trigger the load cache in any other scenario. See the following <strong>contrarian example</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 注意这是一个反面示例
</span><span class="c1"></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">wrong_usage_whenCacheMiss_thenPut</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&#34;kirito&#34;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">cacheValue</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cacheValue</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">cacheValue</span> <span class="o">=</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">cacheValue</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">cacheValue</span><span class="o">);</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This way, a null value is set in the load method, and the cache is subsequently used by manual put + get, which is more like operating a HashMap, but is not recommended for use in a Cache. As described earlier get and load are thread-safe by the Guava Cache, ensuring that when multiple threads access the cache, the first request loads the cache while blocking subsequent requests, which is not an elegant way to use a HashMap, and in extreme cases can lead to cache-penetration and thread-safety problems.</p>
<p>Be sure to use the put method only as a preload cache scenario.</p>
<h2 id="cache-expiration">Cache expiration</h2>
<p>The first difference between Cache and ConcurrentHashMap can be seen in the &ldquo;cache expiration&rdquo; scenario. This section introduces some common cache expiration behaviors and policies in Guava.</p>
<h3 id="cache-a-fixed-number-of-values">Cache a fixed number of values</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenReachMaxSize_thenEviction</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">3</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;three&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="n">assertNull</span><span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">));</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;FOUR&#34;</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>One of the biggest problems with using <code>ConcurrentHashMap</code> for caching is that we don&rsquo;t have an easy and effective way to stop it from growing indefinitely, and Guava Cache can configure <code>maximumSize</code> by initializing the LoadingCache to ensure that cached content doesn&rsquo;t cause OOM on your system.</p>
<p>It is worth noting that my test case here uses a third way to get the cache besides <code>get</code> and <code>getUnchecked</code>, and as literally described, <code>getIfPresent</code> does not trigger the <code>load</code> method to load the data source when the cache does not exist.</p>
<h3 id="lru-expiration-policy">LRU expiration policy</h3>
<p>Using the same example as above, when we set the capacity to 3, we only learn that the LoadingCache can store 3 values, but we do not know which old value needs to be eliminated to make room for the new value after the 4th value is deposited. In fact, Guava Cache adopts the LRU cache elimination policy by default, Least Recently Used, an algorithm you may not have implemented but will have heard of, and the semantics of Used in Guava Cache stands for any one access, such as put, get. Continue with the following example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenReachMaxSize_thenEviction</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">3</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;three&#34;</span><span class="o">);</span>
    <span class="c1">// access one
</span><span class="c1"></span>    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="n">assertNull</span><span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">));</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;ONE&#34;</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note the difference between this example and the previous one: after the fourth get access to one, two becomes the longest unused value, and when the fourth value of four is stored, the eliminated object becomes two and not one anymore.</p>
<h3 id="cache-fixed-time">Cache fixed time</h3>
<p>Setting an expiration time for the cache is also an important feature that distinguishes HashMap from Cache. Guava Cache provides the <code>expireAfterAccess</code> and <code>expireAfterWrite</code> schemes to set the expiration time for cache values in LoadingCache.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenEntryIdle_thenEviction</span><span class="o">()</span>
    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>

    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">expireAfterAccess</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">cache</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>

    <span class="n">assertNull</span><span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="cache-invalidation">Cache Invalidation</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenInvalidate_thenGetNull</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>

    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&#34;KIRITO&#34;</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">invalidate</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">assertNull</span><span class="o">(</span><span class="n">cache</span><span class="o">.</span><span class="na">getIfPresent</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Use <code>void invalidate(Object key)</code> to remove a single cache and <code>void invalidateAll()</code> to remove all caches.</p>
<h2 id="cache-refresh">Cache Refresh</h2>
<p>Cache refresh is commonly used to overwrite old cache values with new values from the data source. Guava Cache provides two types of refresh mechanisms: manual refresh and scheduled refresh.</p>
<h3 id="manual-refresh">Manual refresh</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">cache</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>The refresh method will trigger the load logic to try to load the cache from the data source.</p>
<p>Note that the refresh method does not block the get method, so the old cache values will still be accessible during the refresh period until the load is complete, see the example below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenCacheRefresh_thenLoad</span><span class="o">()</span>
    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span> <span class="o">{</span>

    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">expireAfterWrite</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">String</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>

    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

    <span class="c1">// make sure another refresh thread is scheduling
</span><span class="c1"></span>    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">val1</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="n">oldValue</span><span class="o">,</span> <span class="n">val1</span><span class="o">);</span>

    <span class="c1">// make sure refresh cache 
</span><span class="c1"></span>    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">oldValue</span><span class="o">,</span> <span class="n">val2</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In fact, in any case, the cached value may be inconsistent with the data source, and the business level needs to do a good job of accessing the fault-tolerant logic to the old value.</p>
<h3 id="automatic-refresh">Automatic refresh</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenTTL_thenRefresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">refreshAfterWrite</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>
    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;kirito&#34;</span><span class="o">);</span>

    <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">first</span><span class="o">,</span> <span class="n">second</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As with the refresh mechanism in the previous section, <code>refreshAfterWrite</code> also does not block the get thread and still has the possibility of accessing the old value.</p>
<h2 id="cache-hit-statistics">Cache hit statistics</h2>
<p>The Guava Cache does not keep hit statistics by default, so you need to explicitly configure <code>recordStats</code> when building the CacheBuilder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenRecordStats_thenPrint</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">100</span><span class="o">).</span><span class="na">recordStats</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;three&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">);</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">);</span>

    <span class="n">CacheStats</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">stats</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">stats</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">---</span>
<span class="n">CacheStats</span><span class="o">{</span><span class="n">hitCount</span><span class="o">=</span><span class="n">2</span><span class="o">,</span> <span class="n">missCount</span><span class="o">=</span><span class="n">4</span><span class="o">,</span> <span class="n">loadSuccessCount</span><span class="o">=</span><span class="n">4</span><span class="o">,</span> <span class="n">loadExceptionCount</span><span class="o">=</span><span class="n">0</span><span class="o">,</span> <span class="n">totalLoadTime</span><span class="o">=</span><span class="n">1184001</span><span class="o">,</span> <span class="n">evictionCount</span><span class="o">=</span><span class="n">0</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="notification-mechanism-for-cache-removal">Notification mechanism for cache removal</h2>
<p>In some business scenarios where we want to do some monitoring of cache invalidation or do some callback processing for invalidated caches, we can use the <code>RemovalNotification</code> mechanism.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenRemoval_thenNotify</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ExecutionException</span> <span class="o">{</span>
    <span class="n">LoadingCache</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
        <span class="n">CacheBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">maximumSize</span><span class="o">(</span><span class="n">3</span><span class="o">)</span>
            <span class="o">.</span><span class="na">removalListener</span><span class="o">(</span>
                <span class="n">cacheItem</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cacheItem</span> <span class="o">+</span> <span class="s">&#34; is removed, cause by &#34;</span> <span class="o">+</span> <span class="n">cacheItem</span><span class="o">.</span><span class="na">getCause</span><span class="o">()))</span>
            <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">CacheLoader</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">String</span> <span class="nf">load</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">fetchValueFromServer</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>

    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;three&#34;</span><span class="o">);</span>
    <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;four&#34;</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">---</span>
<span class="n">one</span><span class="o">=</span><span class="n">ONE</span> <span class="n">is</span> <span class="n">removed</span><span class="o">,</span> <span class="n">cause</span> <span class="n">by</span> <span class="n">SIZE</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>removalListener</code> can add a callback handler to the LoadingCache, and the <code>RemovalNotification</code> instance contains the cached key-value pairs and the reason for their removal.</p>
<h2 id="weak-keys--soft-values">Weak Keys &amp; Soft Values</h2>
<p>I&rsquo;m sure you&rsquo;ve all studied the concepts of weak and soft references in Java Basics, so here&rsquo;s a refresher.</p>
<ul>
<li>
<p><strong>Soft References</strong>: If an object has only <strong>soft references</strong>, the <strong>garbage collector</strong> will <strong>not</strong> recycle it when <strong>memory space is sufficient</strong>; if <strong>memory space is insufficient</strong>, it will <strong>recover</strong> these objects. As long as the garbage collector does not recycle it, the object can be used by the program.</p>
</li>
<li>
<p><strong>weak references</strong>: Only objects with <strong>weak references</strong> have a <strong>shorter</strong> <strong>lifecycle</strong>. As the garbage collector thread scans the memory area under its jurisdiction, it will <strong>reclaim</strong> the memory of an object with only <strong>weak references</strong> once it is found, regardless of whether there is enough <strong>memory space</strong> available.</p>
</li>
</ul>
<p>In Guava Cache, CacheBuilder provides three methods, weakKeys, weakValues, and softValues, to associate cached key-value pairs with the JVM garbage collection mechanism.</p>
<p>This operation may have its own scenarios, such as maximizing the use of JVM memory for caching, but relies on GC cleanup, which is conceivably low performance. Anyway, I don&rsquo;t rely on the JVM mechanism to clean up the cache, so I don&rsquo;t dare to use this feature, and stability is still first on the line.</p>
<p>If you need to set a cleanup strategy, you can refer to the cache expiration summary in the introduction of the fixed number and fixed time two programs, combined to ensure that the use of cache to obtain high performance at the same time, not to explode the memory.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/guava/">guava</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/rsc-critique-on-the-recent-aws/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go development team leader criticizes AWS article for being seriously misleading about Go</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/why-you-should-add-swap-space/">
            <span class="next-text nav-default">Linux Performance: Why you should add swap space</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
