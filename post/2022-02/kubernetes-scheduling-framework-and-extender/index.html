<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubernetes Scheduling Framework and Extender Comparison and Details - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Kubernetes started out by providing only Extender. The Extender scheduler plugin, which enables non-intrusive extensions by deploying a web service, has several problems.
 The number of Extender extensions is limited: only &amp;ldquo;Filter&amp;rdquo; and &amp;ldquo;Prioritize&amp;rdquo; extensions are available during scheduling. The &amp;ldquo;Preempt&amp;rdquo; extension is called after running the default preemption mechanism. &amp;ldquo;Extender cannot be called at other points, e.g. not before running the predicate function. Performance issues: Each call to an extender involves JSON coding and decoding." /><meta name="keywords" content="Kubernetes Scheduling Framework, Extender" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/kubernetes-scheduling-framework-and-extender/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kubernetes Scheduling Framework and Extender Comparison and Details" />
<meta property="og:description" content="Kubernetes started out by providing only Extender. The Extender scheduler plugin, which enables non-intrusive extensions by deploying a web service, has several problems.
 The number of Extender extensions is limited: only &ldquo;Filter&rdquo; and &ldquo;Prioritize&rdquo; extensions are available during scheduling. The &ldquo;Preempt&rdquo; extension is called after running the default preemption mechanism. &ldquo;Extender cannot be called at other points, e.g. not before running the predicate function. Performance issues: Each call to an extender involves JSON coding and decoding." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/kubernetes-scheduling-framework-and-extender/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-13T11:19:59+08:00" />
<meta property="article:modified_time" content="2022-02-13T11:19:59+08:00" />

<meta itemprop="name" content="Kubernetes Scheduling Framework and Extender Comparison and Details">
<meta itemprop="description" content="Kubernetes started out by providing only Extender. The Extender scheduler plugin, which enables non-intrusive extensions by deploying a web service, has several problems.
 The number of Extender extensions is limited: only &ldquo;Filter&rdquo; and &ldquo;Prioritize&rdquo; extensions are available during scheduling. The &ldquo;Preempt&rdquo; extension is called after running the default preemption mechanism. &ldquo;Extender cannot be called at other points, e.g. not before running the predicate function. Performance issues: Each call to an extender involves JSON coding and decoding."><meta itemprop="datePublished" content="2022-02-13T11:19:59+08:00" />
<meta itemprop="dateModified" content="2022-02-13T11:19:59+08:00" />
<meta itemprop="wordCount" content="4442">
<meta itemprop="keywords" content="kubernetes,extender," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes Scheduling Framework and Extender Comparison and Details"/>
<meta name="twitter:description" content="Kubernetes started out by providing only Extender. The Extender scheduler plugin, which enables non-intrusive extensions by deploying a web service, has several problems.
 The number of Extender extensions is limited: only &ldquo;Filter&rdquo; and &ldquo;Prioritize&rdquo; extensions are available during scheduling. The &ldquo;Preempt&rdquo; extension is called after running the default preemption mechanism. &ldquo;Extender cannot be called at other points, e.g. not before running the predicate function. Performance issues: Each call to an extender involves JSON coding and decoding."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubernetes Scheduling Framework and Extender Comparison and Details</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-13 11:19:59 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4442 words </span>
          <span class="more-meta"> 21 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#extender">Extender</a>
          <ul>
            <li><a href="#design">Design</a></li>
          </ul>
        </li>
        <li><a href="#scheduling-framework">Scheduling Framework</a>
          <ul>
            <li><a href="#design-goals">Design Goals</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Kubernetes started out by providing only Extender. The Extender scheduler plugin, which enables non-intrusive extensions by deploying a web service, has several problems.</p>
<ul>
<li>The number of Extender extensions is limited: only &ldquo;Filter&rdquo; and &ldquo;Prioritize&rdquo; extensions are available during scheduling. The &ldquo;Preempt&rdquo; extension is called after running the default preemption mechanism. &ldquo;Extender cannot be called at other points, e.g. not before running the predicate function.</li>
<li>Performance issues: Each call to an extender involves JSON coding and decoding. Calling a webhook (HTTP request) is also slower than calling a native function.</li>
<li>The scheduler cannot notify Extender that Pod scheduling has been aborted. For example, if an Extender provides a clustered resource, and the scheduler contacts the Extender and asks it to provide an instance of the resource for the pod being scheduled, and then the scheduler encounters an error while scheduling the pod and decides to abort the scheduling, it will be difficult to communicate the error to the Extender and ask it to withdraw the configuration of the resource.</li>
<li>Since the current Extender runs as a separate process, it cannot use the scheduler&rsquo;s cache. Either build their own cache from the API Server or process only the information they receive from the scheduler.</li>
</ul>
<p>Scheduling Framework The Scheduling Framework is a new set of &ldquo;plug-in&rdquo; APIs that allow many scheduling features to be implemented using plug-ins while keeping the scheduler &ldquo;core&rdquo; simple and maintainable. Scheduler plugins must be written in Go and compiled with Kubernetes scheduler code, which has a learning cost.</p>
<p>Although Extender is simple, in the long run, try to choose Scheduling Framework. here is a detailed compilation of these 2 extensions based on the official design documentation.</p>
<h2 id="extender">Extender</h2>
<p>Scheduler Extender is actually an additional web service that extends the default scheduler to adjust scheduling decisions at different stages by registering an external webhook. Filter method, Prioritize method, Bind method implemented according to your needs.</p>
<p>Advantages.</p>
<ol>
<li>the functionality of the existing scheduler can be extended without recompiling the binaries.</li>
<li>The extender can be written in any language.</li>
<li>Once implemented, it can be used to extend different versions of kube-scheduler.</li>
</ol>
<h3 id="design">Design</h3>
<p>When scheduling pods, Extender allows external processes to filter nodes and prioritize them. Two separate http/https calls are made to Extender, the &ldquo;filter&rdquo; and &ldquo;prioritize&rdquo; operations. If the pod cannot be scheduled, the scheduler will try to preempt lower priority pods from the node and send them to Extender&rsquo;s &ldquo;preempt&rdquo; interface (if configured) Extender can return a subset of nodes and new evictees to the scheduler. In addition, Extender can optionally bind the pod to the apiserver by implementing a &ldquo;bind&rdquo; operation.</p>
<h4 id="configuration">Configuration</h4>
<p>To use Extender, a scheduler configuration file must be created. Configure whether the access method is http or https and the timeout configuration, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Holds the parameters used to communicate with the extender. If a verb is unspecified/empty,
</span><span class="c1">// it is assumed that the extender chose not to provide that extension.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// URLPrefix at which the extender is available
</span><span class="c1"></span>	<span class="nx">URLPrefix</span> <span class="kt">string</span> <span class="s">`json:&#34;urlPrefix&#34;`</span>
	<span class="c1">// Verb for the filter call, empty if not supported. This verb is appended to the URLPrefix when issuing the filter call to extender.
</span><span class="c1"></span>	<span class="nx">FilterVerb</span> <span class="kt">string</span> <span class="s">`json:&#34;filterVerb,omitempty&#34;`</span>
	<span class="c1">// Verb for the preempt call, empty if not supported. This verb is appended to the URLPrefix when issuing the preempt call to extender.
</span><span class="c1"></span>	<span class="nx">PreemptVerb</span> <span class="kt">string</span> <span class="s">`json:&#34;preemptVerb,omitempty&#34;`</span>
	<span class="c1">// Verb for the prioritize call, empty if not supported. This verb is appended to the URLPrefix when issuing the prioritize call to extender.
</span><span class="c1"></span>	<span class="nx">PrioritizeVerb</span> <span class="kt">string</span> <span class="s">`json:&#34;prioritizeVerb,omitempty&#34;`</span>
	<span class="c1">// Verb for the bind call, empty if not supported. This verb is appended to the URLPrefix when issuing the bind call to extender.
</span><span class="c1"></span>	<span class="c1">// If this method is implemented by the extender, it is the extender&#39;s responsibility to bind the pod to apiserver.
</span><span class="c1"></span>	<span class="nx">BindVerb</span> <span class="kt">string</span> <span class="s">`json:&#34;bindVerb,omitempty&#34;`</span>
	<span class="c1">// The numeric multiplier for the node scores that the prioritize call generates.
</span><span class="c1"></span>	<span class="c1">// The weight should be a positive integer
</span><span class="c1"></span>	<span class="nx">Weight</span> <span class="kt">int</span> <span class="s">`json:&#34;weight,omitempty&#34;`</span>
	<span class="c1">// EnableHttps specifies whether https should be used to communicate with the extender
</span><span class="c1"></span>	<span class="nx">EnableHttps</span> <span class="kt">bool</span> <span class="s">`json:&#34;enableHttps,omitempty&#34;`</span>
	<span class="c1">// TLSConfig specifies the transport layer security config
</span><span class="c1"></span>	<span class="nx">TLSConfig</span> <span class="o">*</span><span class="nx">ExtenderTLSConfig</span> <span class="s">`json:&#34;tlsConfig,omitempty&#34;`</span>
	<span class="c1">// HTTPTimeout specifies the timeout duration for a call to the extender. Filter timeout fails the scheduling of the pod. Prioritize
</span><span class="c1"></span>	<span class="c1">// timeout is ignored, k8s/other extenders priorities are used to select the node.
</span><span class="c1"></span>	<span class="nx">HTTPTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="s">`json:&#34;httpTimeout,omitempty&#34;`</span>
	<span class="c1">// NodeCacheCapable specifies that the extender is capable of caching node information,
</span><span class="c1"></span>	<span class="c1">// so the scheduler should only send minimal information about the eligible nodes
</span><span class="c1"></span>	<span class="c1">// assuming that the extender already cached full details of all nodes in the cluster
</span><span class="c1"></span>	<span class="nx">NodeCacheCapable</span> <span class="kt">bool</span> <span class="s">`json:&#34;nodeCacheCapable,omitempty&#34;`</span>
	<span class="c1">// ManagedResources is a list of extended resources that are managed by
</span><span class="c1"></span>	<span class="c1">// this extender.
</span><span class="c1"></span>	<span class="c1">// - A pod will be sent to the extender on the Filter, Prioritize and Bind
</span><span class="c1"></span>	<span class="c1">//   (if the extender is the binder) phases iff the pod requests at least
</span><span class="c1"></span>	<span class="c1">//   one of the extended resources in this list. If empty or unspecified,
</span><span class="c1"></span>	<span class="c1">//   all pods will be sent to this extender.
</span><span class="c1"></span>	<span class="c1">// - If IgnoredByScheduler is set to true for a resource, kube-scheduler
</span><span class="c1"></span>	<span class="c1">//   will skip checking the resource in filter plugins.
</span><span class="c1"></span>	<span class="c1">// +optional
</span><span class="c1"></span>	<span class="nx">ManagedResources</span> <span class="p">[]</span><span class="nx">ExtenderManagedResource</span> <span class="s">`json:&#34;managedResources,omitempty&#34;`</span>
	<span class="c1">// Ignorable specifies if the extender is ignorable, i.e. scheduling should not
</span><span class="c1"></span>	<span class="c1">// fail when the extender returns an error or is not reachable.
</span><span class="c1"></span>	<span class="nx">Ignorable</span> <span class="kt">bool</span> <span class="err">`</span><span class="nx">json</span><span class="p">:</span><span class="s">&#34;ignorable,omitempty&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Example configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span><span class="w"></span><span class="nt">extenders</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">urlPrefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://127.0.0.1:12345/api/scheduler&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">filterVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;filter&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">preemptVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;preempt&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">prioritizeVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;prioritize&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">bindVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;bind&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">enableHttps</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">nodeCacheCapable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">managedResources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">opaqueFooResource</span><span class="w">
</span><span class="w">    </span><span class="nt">ignoredByScheduler</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">ignorable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Multiple Extenders can be configured and the scheduler will call them in order.</p>
<h4 id="interface">Interface</h4>
<p>The Extender Web module can implement the following 4 interfaces as needed, each with a corresponding request and response.</p>
<h5 id="filter">Filter</h5>
<p><strong>Request</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ExtenderArgs represents the arguments needed by the extender to filter/prioritize
</span><span class="c1">// nodes for a pod.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderArgs</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Pod being scheduled
</span><span class="c1"></span>	<span class="nx">Pod</span>   <span class="nx">api</span><span class="p">.</span><span class="nx">Pod</span>      <span class="s">`json:&#34;pod&#34;`</span>
	<span class="c1">// List of candidate nodes where the pod can be scheduled
</span><span class="c1"></span>	<span class="nx">Nodes</span> <span class="nx">api</span><span class="p">.</span><span class="nx">NodeList</span> <span class="s">`json:&#34;nodes&#34;`</span>
	<span class="c1">// List of candidate node names where the pod can be scheduled; to be
</span><span class="c1"></span>	<span class="c1">// populated only if Extender.NodeCacheCapable == true
</span><span class="c1"></span>	<span class="nx">NodeNames</span> <span class="o">*</span><span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Response</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FailedNodesMap represents the filtered out nodes, with node names and failure messages
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">FailedNodesMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>

<span class="c1">// ExtenderFilterResult represents the results of a filter call to an extender
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderFilterResult</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Filtered set of nodes where the pod can be scheduled; to be populated
</span><span class="c1"></span>	<span class="c1">// only if Extender.NodeCacheCapable == false
</span><span class="c1"></span>	<span class="nx">Nodes</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">NodeList</span>
	<span class="c1">// Filtered set of nodes where the pod can be scheduled; to be populated
</span><span class="c1"></span>	<span class="c1">// only if Extender.NodeCacheCapable == true
</span><span class="c1"></span>	<span class="nx">NodeNames</span> <span class="o">*</span><span class="p">[]</span><span class="kt">string</span>
	<span class="c1">// Filtered out nodes where the pod can&#39;t be scheduled and the failure messages
</span><span class="c1"></span>	<span class="nx">FailedNodes</span> <span class="nx">FailedNodesMap</span>
	<span class="c1">// Filtered out nodes where the pod can&#39;t be scheduled and preemption would
</span><span class="c1"></span>	<span class="c1">// not change anything. The value is the failure message same as FailedNodes.
</span><span class="c1"></span>	<span class="c1">// Nodes specified here takes precedence over FailedNodes.
</span><span class="c1"></span>	<span class="nx">FailedAndUnresolvableNodes</span> <span class="nx">FailedNodesMap</span>
	<span class="c1">// Error message indicating failure
</span><span class="c1"></span>	<span class="nx">Error</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="prioritize">Prioritize</h5>
<p><strong>Request</strong></p>
<p>Same as Filter Request</p>
<p><strong>Response</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// HostPriority represents the priority of scheduling to a particular host, higher priority is better.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">HostPriority</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Name of the host
</span><span class="c1"></span>	<span class="nx">Host</span> <span class="kt">string</span>
	<span class="c1">// Score associated with the host
</span><span class="c1"></span>	<span class="nx">Score</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="c1">// HostPriorityList declares a []HostPriority type.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">HostPriorityList</span> <span class="p">[]</span><span class="nx">HostPriority</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="bind">Bind</h5>
<p><strong>Request</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ExtenderBindingArgs represents the arguments to an extender for binding a pod to a node.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderBindingArgs</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// PodName is the name of the pod being bound
</span><span class="c1"></span>	<span class="nx">PodName</span> <span class="kt">string</span>
	<span class="c1">// PodNamespace is the namespace of the pod being bound
</span><span class="c1"></span>	<span class="nx">PodNamespace</span> <span class="kt">string</span>
	<span class="c1">// PodUID is the UID of the pod being bound
</span><span class="c1"></span>	<span class="nx">PodUID</span> <span class="nx">types</span><span class="p">.</span><span class="nx">UID</span>
	<span class="c1">// Node selected by the scheduler
</span><span class="c1"></span>	<span class="nx">Node</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Response</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ExtenderBindingResult represents the result of binding of a pod to a node from an extender.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderBindingResult</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Error message indicating failure
</span><span class="c1"></span>	<span class="nx">Error</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="preempt">Preempt</h5>
<p><strong>Request</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ExtenderPreemptionArgs represents the arguments needed by the extender to preempt pods on nodes.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderPreemptionArgs</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Pod being scheduled
</span><span class="c1"></span>	<span class="nx">Pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span>
	<span class="c1">// Victims map generated by scheduler preemption phase
</span><span class="c1"></span>	<span class="c1">// Only set NodeNameToMetaVictims if Extender.NodeCacheCapable == true. Otherwise, only set NodeNameToVictims.
</span><span class="c1"></span>	<span class="nx">NodeNameToVictims</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Victims</span>
	<span class="nx">NodeNameToMetaVictims</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">MetaVictims</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Response</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ExtenderPreemptionResult represents the result returned by preemption phase of extender.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtenderPreemptionResult</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">NodeNameToMetaVictims</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">MetaVictims</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="scheduling-framework">Scheduling Framework</h2>
<p>The Scheduling Framework is a set of new &ldquo;plug-in&rdquo; APIs added to the existing Kubernetes scheduler that allow many scheduling features to be implemented as plug-ins and compiled into the scheduler, while keeping the scheduling &ldquo;core&rdquo; simple and maintainable. maintainable.</p>
<p>As more and more features are added to the Kubernetes scheduler. These new features continue to make the code larger and the logic more complex. This makes the scheduler harder to maintain, bugs harder to find and fix, and those running custom schedulers have difficulty catching up and integrating new changes. While the current Kubernetes scheduler provides webhooks to extend its functionality. However, these are limited in several ways.</p>
<ol>
<li>The number of Extender extensions is limited: only &ldquo;Filter&rdquo; and &ldquo;Prioritize&rdquo; extensions are available during scheduling. The &ldquo;Preempt&rdquo; extension is called after running the default preemption mechanism. The &ldquo;Bind&rdquo; extension is used to bind Pods, and the Bind extension can only bind one extension, which replaces the scheduler&rsquo;s bind operation.</li>
<li>Performance issues: Each call to an extender involves JSON coding and decoding. Calling a webhook (HTTP request) is also slower than calling a native function.</li>
<li>The scheduler cannot notify Extender that Pod scheduling has been aborted. For example, if an Extender provides a clustered resource and the scheduler contacts the Extender and asks it to provide an instance of the resource for the pod being scheduled, and then the scheduler encounters an error while scheduling the pod and decides to abort the scheduling, it will be difficult to communicate the error to the Extender and ask it to withdraw the configuration of the resource.</li>
<li>Since the current Extender is running as a separate process, it cannot use the scheduler&rsquo;s cache. Either build their own cache from the API Server or process only the information they receive from the scheduler.</li>
</ol>
<p>The above limitations prevent building a high-performance and more functional scheduler. Ideally, it would be desirable to have an extension mechanism that is fast enough to allow conversion of existing functions to plugins, such as predicate and priority functions. Such plugins would be compiled into the scheduler binaries. In addition, authors of custom schedulers can compile custom schedulers using (unmodified) scheduler code and their own plugins.</p>
<h3 id="design-goals">Design Goals</h3>
<ol>
<li>Make the scheduler more extensible.</li>
<li>Make the scheduler core simpler by moving some of the scheduler core functionality to plugins.</li>
<li>To propose extension points in the framework.</li>
<li>propose a mechanism to receive plug-in results and continue or abort depending on the results received.</li>
<li>propose a mechanism to handle errors and communicate with plug-ins.</li>
</ol>
<p>The scheduling framework defines new extension points and Go APIs in the Kubernetes scheduler for use by &ldquo;plugins&rdquo;. Plugins add scheduling behavior to the scheduler and include it at compile time. The scheduler&rsquo;s ComponentConfig will allow plugins to be enabled, disabled, and reordered. Custom schedulers can write their plugins &ldquo;out-of-tree&rdquo; and compile a scheduler binary containing their own plugins.</p>
<h4 id="scheduling-cycles-and-binding-cycles">Scheduling cycles and binding cycles</h4>
<p>Each dispatch of a pod is divided into two phases: the dispatch cycle and the binding cycle. The scheduling cycle selects a node for the pod, and the binding cycle applies that scheduling result to the cluster. The scheduling cycle and the binding cycle together are called the &ldquo;scheduling context&rdquo;. Scheduling cycles run serially, while binding cycles may run concurrently.</p>
<p>If a pod is determined to be unschedulable or there is an internal error, either the scheduling cycle or the binding cycle can be aborted. The pod will return to the queue and retry. If the binding cycle is aborted, it will trigger the Unreserve method in the Reserve plug-in.</p>
<h4 id="extension-points">Extension Points</h4>
<p>The following diagram shows the dispatching context of Pod and the extension points exposed by the dispatching framework. In this diagram, &ldquo;Filter&rdquo; is equivalent to Extender&rsquo;s &ldquo;Predicate&rdquo; and &ldquo;Scoring&rdquo; is equivalent to &ldquo;Priority&rdquo;. Plugins are registered to be called at one or more of these extension points. In the following sections, we describe each extension point in the same order in which they are called.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/0df28efaaa354371b828300a636fe16d.png" alt="sobyte"></p>
<h5 id="queue-sort">Queue sort</h5>
<p>These plugins are used to sort the pods in the scheduling queue. They will essentially provide <code>less(pod1, pod2)</code> functionality. Only one queue sort plugin can be enabled at a time.</p>
<h5 id="prefilter">PreFilter</h5>
<p>PreFilter is called once in each scheduling cycle. These plugins are used to preprocess information about pods or to check clusters, certain conditions that pods must meet. A pre-filter plugin should implement a PreFilter interface, and if the pre-filter returns an error, the scheduling cycle is aborted.</p>
<p>The Pre-filter plugin may implement the optional PreFilterExtensions interface, which defines AddPod and RemovePod methods to incrementally modify its pre-processing information. The framework guarantees that these functions will only be called after the PreFilter, on the cloned CycleState, and possibly multiple times before calling the Filter on a particular node.</p>
<h5 id="filter-1">Filter</h5>
<p>Used to filter out nodes that are unable to run Pods. For each node, the scheduler will invoke the filter plugins in the configured order. If any filter plugin marks the node as infeasible, the remaining plugins will not be called for that node. Nodes may be evaluated concurrently, and filter may be called multiple times in the same scheduling cycle.</p>
<h5 id="postfilter">PostFilter</h5>
<p>Called after the Filter phase, and only if no feasible nodes are found for the pod. Plugins are invoked in the order they are configured. If any PostFilter plugin marks the node as dispatchable, the rest of the plugins are not called. A typical PostFilter implementation is preemption, which attempts to make a Pod dispatchable by preempting other Pods.</p>
<h5 id="prescore">PreScore</h5>
<p>Information extension point for performing PreScore. Plugins will be invoked using the list of nodes in the filtering phase Plugins can use this data to update internal state or generate logs/metrics.</p>
<h5 id="scoring">Scoring</h5>
<p>The plugin here has two phases.</p>
<p>The first stage is called &ldquo;score&rdquo; and is used to rank the nodes that have passed the filtering stage. The scheduler will call the Score function of each scoring plugin for each node.</p>
<p>The second phase is &ldquo;normalize scoring&rdquo;, which is used to modify the score before the scheduler calculates the final ranking of the nodes, and each scoring plugin receives the score given to all nodes by the same plugin during the &ldquo;normalize scoring&rdquo; phase. Each scoring plugin receives scores from the same plugin for all nodes in the &ldquo;normalize scoring&rdquo; phase. NormalizeScore is optional and can be provided by implementing the ScoreExtensions interface.</p>
<p>The output of the score plugin must be an integer in the range <strong>[MinNodeScore, MaxNodeScore]</strong>. If it is not, the scheduling cycle is aborted. This is the output after running the optional NormalizeScore function of the plugin. If NormalizeScore is not provided, the output of Score must be within this range. After the optional NormalizeScore, the scheduler will combine the node scores from all plugins based on the configured plugin weights.</p>
<p>For example, suppose the plugin BlinkingLightScorer ranks nodes based on the number of blinking lights they have.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">BlinkingLightScorer</span><span class="p">)</span> <span class="nf">Score</span><span class="p">(</span><span class="nx">state</span> <span class="o">*</span><span class="nx">CycleState</span><span class="p">,</span> <span class="nx">_</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="o">*</span><span class="nx">Status</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nf">getBlinkingLightCount</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, the maximum count of blinking lights may be small compared to the MaxNodeScore. To solve this problem, BlinkingLightScorer should also implement NormalizeScore.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">BlinkingLightScorer</span><span class="p">)</span> <span class="nf">NormalizeScore</span><span class="p">(</span><span class="nx">state</span> <span class="o">*</span><span class="nx">CycleState</span><span class="p">,</span> <span class="nx">_</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeScores</span> <span class="nx">NodeScoreList</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span> <span class="p">{</span>
   <span class="nx">highest</span> <span class="o">:=</span> <span class="mi">0</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">nodeScore</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodeScores</span> <span class="p">{</span>
      <span class="nx">highest</span> <span class="p">=</span> <span class="nf">max</span><span class="p">(</span><span class="nx">highest</span><span class="p">,</span> <span class="nx">nodeScore</span><span class="p">.</span><span class="nx">Score</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">nodeScore</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodeScores</span> <span class="p">{</span>
      <span class="nx">nodeScores</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Score</span> <span class="p">=</span> <span class="nx">nodeScore</span><span class="p">.</span><span class="nx">Score</span><span class="o">*</span><span class="nx">MaxNodeScore</span><span class="o">/</span><span class="nx">highest</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If Score or NormalizeScore returns an error, the scheduling cycle is aborted.</p>
<h5 id="reserve">Reserve</h5>
<p>Plugins that implement the Reserve extension have two approaches, Reserve and Unreserve, which support two information scheduling phases called Reserve and Unreserve, respectively. plugins that maintain runtime state (aka &ldquo;stateful plugins&rdquo;) should use these phases to notify the scheduler when resources on a node are being reserved and unreserved for a given Pod. ) should use these phases to notify the scheduler when resources on a node are being Reserve and Unreserve for a given Pod.</p>
<p>The Reserve phase occurs before the scheduler actually binds the Pod to its specified node. It exists to prevent contention conditions while the scheduler waits for a successful binding. The Reserve method of each Reserve plug-in may succeed or fail; if a Reserve method call fails, subsequent plug-ins are not executed and the Reserve phase is considered to have failed. If the Reserve methods of all plug-ins succeed, the Reserve phase is considered successful and the remaining scheduling cycles and binding cycles are executed.</p>
<p>If the Reserve phase or subsequent phases fail, the Unreserve phase is triggered. When this happens, the Unreserve methods of all Reserve plugins are executed in the reverse order of the Reserve method calls. This phase exists to clean up the state associated with the Reserve Pod.</p>
<p>Note: The implementation of the Unreserve method in the Reserve plugin must be idempotent and cannot fail.</p>
<h5 id="permit">Permit</h5>
<p>These plugins are used to block or delay the binding of Pods. The Permit plugin can do one of three things.</p>
<ol>
<li>
<p>approve Approve</p>
<p>Once all Permit plugins have approved a pod, it will be sent for binding.</p>
</li>
<li>
<p>deny Deny</p>
<p>If any Permit plugin denies a pod, it will be returned to the scheduling queue. This will trigger the Unreserve method in the Reserve plugin.</p>
</li>
<li>
<p>wait wait (timeout)</p>
<p>If the permit plugin returns &ldquo;wait&rdquo;, the pod will remain in the Permit phase until the plugin approves it. If it times out, wait becomes deny and the pod returns to the scheduling queue, triggering the unreserve method during the Reserve phase.</p>
</li>
</ol>
<p>The Permit plugin is executed as the last step of the scheduling cycle, but the wait in the Permit phase occurs at the beginning of the binding cycle, before the PreBind plugin is executed.</p>
<p><strong>Approve pod bindings</strong></p>
<p>While any plugin can receive a list of reserved Pods from the cache and approve them (see FrameworkHandle), we expect only permission plugins to approve bindings to reserved Pods that are in the &ldquo;waiting&rdquo; state. Once a Pod is approved, it is sent to the pre-binding phase.</p>
<h5 id="prebind">PreBind</h5>
<p>Used to perform any work required before binding a pod. For example, a prebind plugin might provide a network volume and mount it on the target node before allowing the pod to run.</p>
<p>If any PreBind plugin returns an error, the pod will be rejected and returned to the scheduling queue.</p>
<h5 id="bind-1">Bind</h5>
<p>Used to bind a pod to a node. Bind plugins are not invoked until all PreBind plugins have completed. Each bind plugin is called in the configured order. Bind plugins can choose whether to process a given Pod. if a bind plugin chooses to process a Pod, the remaining bind plugins are skipped.</p>
<h5 id="postbind">PostBind</h5>
<p>This is an information extension point. the PostBind plugin is called after a Pod has been successfully bound. This is the end of the binding cycle and can be used to clean up the associated resources.</p>
<h4 id="plugin-api">Plugin API</h4>
<p>The Plugin API has two steps. 1. register and configure, and 2. use the extension point interface. The extension point interface has the following forms.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Plugin</span> <span class="kd">interface</span> <span class="p">{</span>
   <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">QueueSortPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
   <span class="nx">Plugin</span>
   <span class="nf">Less</span><span class="p">(</span><span class="o">*</span><span class="nx">PodInfo</span><span class="p">,</span> <span class="o">*</span><span class="nx">PodInfo</span><span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PreFilterPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
   <span class="nx">Plugin</span>
   <span class="nf">PreFilter</span><span class="p">(</span><span class="nx">CycleState</span><span class="p">,</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// ... 
</span></code></pre></td></tr></table>
</div>
</div><h5 id="cyclestate">CycleState</h5>
<p>Most plugin functions (except for the Queue Sort plugin) will be called with the CycleState parameter. cycleState represents the current scheduling context.</p>
<p>CycleState will provide an API for accessing data scoped to the current scheduling context. Because binding loops may execute concurrently, plugins can use CycleState to ensure they are processing the correct requests.</p>
<p>CycleState also provides an API similar to context.WithValue that can be used to pass data between plugins with different extension points. Multiple plugins can share state or communicate through this mechanism. This state is only retained for the duration of a single dispatch context. Note that plugins are assumed to be trusted. The scheduler does not prevent a plug-in from accessing or modifying the state of another plug-in.</p>
<p>Warning: Data referenced via CycleState is invalid after the scheduling context ends, and plugins should not hold a reference to this data for longer than necessary.</p>
<h5 id="frameworkhandle">FrameworkHandle</h5>
<p>CycleState provides APIs related to individual scheduling contexts, while FrameworkHandle provides APIs related to the plugin lifecycle. this is how the plugin gets the client (kubernetes.Interface) and SharedInformerFactory, or from the scheduler&rsquo;s cluster state cache of the scheduler. The handle will also provide the API to list and approve/reject waiting pods.</p>
<p>Warning: FrameworkHandle provides access to the kubernetes API Server and the scheduler&rsquo;s internal cache. However, the two are not guaranteed to be synchronized, so extra care should be taken when writing plugins that use data from both of them.</p>
<p>Providing plug-in access to the API Server is necessary to implement useful features, especially if those features use object types that are not normally considered by the scheduler. Providing a SharedInformerFactory allows plugins to share caches securely.</p>
<h5 id="plugin-registration">Plugin Registration</h5>
<p>Each plugin must define a constructor and add it to the hard-coded registry.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">PluginFactory</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Unknown</span><span class="p">,</span> <span class="nx">FrameworkHandle</span><span class="p">)</span> <span class="p">(</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Registry</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">PluginFactory</span>

<span class="kd">func</span> <span class="nf">NewRegistry</span><span class="p">()</span> <span class="nx">Registry</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">Registry</span><span class="p">{</span>
      <span class="nx">fooplugin</span><span class="p">.</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">fooplugin</span><span class="p">.</span><span class="nx">New</span><span class="p">,</span>
      <span class="nx">barplugin</span><span class="p">.</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">barplugin</span><span class="p">.</span><span class="nx">New</span><span class="p">,</span>
      <span class="c1">// New plugins are registered here.
</span><span class="c1"></span>   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Plugins can also be added to a registry object and injected into the scheduler.</p>
<h4 id="plugin-lifecycle">Plugin Lifecycle</h4>
<h5 id="initialization">Initialization</h5>
<p>Plugin initialization has two steps. First, the plugin is registered. Second, the scheduler uses its configuration to determine which plugins to instantiate. If a plugin is registered with multiple extensions, it will only be instantiated once.</p>
<p>When a plugin is instantiated, it is passed config args and a FrameworkHandle.</p>
<h5 id="concurrency">Concurrency</h5>
<p>Plugin writers should consider two types of concurrency. When evaluating multiple nodes, a plugin may be called multiple times at the same time, and a plugin may be called simultaneously from different scheduling contexts.</p>
<p>Note: In a scheduling context, each extension point is evaluated serially.</p>
<p>In the main thread of the scheduler, only one scheduling cycle is processed at a time. Any extensions up to and including permit will be completed before the start of the next scheduling cycle (the queue sorting extension is a special case. It is not part of the scheduling context and can be called for many pod pairs simultaneously). After the permit extension point, the binding cycle is executed asynchronously. This means that the plugin may be invoked by two different scheduling contexts at the same time. Stateful plugins should be careful to handle these cases.</p>
<p>Finally, the Unreserve method in the Reserve plugin can be called from either the main thread or the bind thread, depending on how the pod is rejected.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/13/045e78f1fb5f483db90fc6283e4af3cd.png" alt="sobyte"></p>
<h4 id="configuring-plugins">Configuring Plugins</h4>
<p>The scheduler&rsquo;s component configuration will allow plugins to be enabled, disabled, or otherwise configured. Plugin configuration is divided into two parts.</p>
<ol>
<li>a list of enabled plugins for each extension point (and the order in which they should be run). If one of these lists is omitted, the default list will be used.</li>
<li>Each plugin has an optional set of custom parameters. Omitting a plugin&rsquo;s parameters is equivalent to using that plugin&rsquo;s default configuration.</li>
</ol>
<p>Plugin configurations are organized by extension points. Each list must contain plugins that register multiple points.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">KubeSchedulerConfiguration</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// ... other fields
</span><span class="c1"></span>    <span class="nx">Plugins</span>      <span class="nx">Plugins</span>
    <span class="nx">PluginConfig</span> <span class="p">[]</span><span class="nx">PluginConfig</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Plugins</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">QueueSort</span>      <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">PreFilter</span>      <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">Filter</span>         <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">PostFilter</span>     <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">PreScore</span>       <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">Score</span>          <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">Reserve</span>        <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">Permit</span>         <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">PreBind</span>        <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">Bind</span>           <span class="p">[]</span><span class="nx">Plugin</span>
    <span class="nx">PostBind</span>       <span class="p">[]</span><span class="nx">Plugin</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Plugin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span>   <span class="kt">string</span>
    <span class="nx">Weight</span> <span class="kt">int</span> <span class="c1">// Only valid for Score plugins
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">PluginConfig</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Args</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Unknown</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;plugins&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;preFilter&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginA&#34;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginB&#34;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginC&#34;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;score&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginA&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">30</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginX&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">50</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginY&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">10</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">&#34;pluginConfig&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PluginX&#34;</span><span class="p">,</span>
      <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;favorite_color&#34;</span><span class="p">:</span> <span class="s2">&#34;#326CE5&#34;</span><span class="p">,</span>
        <span class="nt">&#34;favorite_number&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="nt">&#34;thanks_to&#34;</span><span class="p">:</span> <span class="s2">&#34;thockin&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="enabledisable">Enable/Disable</h5>
<p>The configuration uniquely enables the list of plugins for a given extension point. If an extension omits the configuration, the extension uses the default set of plugins.</p>
<h5 id="change-evaluation-order">Change Evaluation Order</h5>
<p>The order of plugin execution is determined by the order in which the plugins appear in the configuration. Plugins that register multiple extension points can have a different order at each extension point.</p>
<h5 id="optional-args">Optional Args</h5>
<p>Plugins can receive parameters with arbitrary structure from their configuration. Because a plugin may appear in multiple extensions, the configuration is located in a separate list in PluginConfig.</p>
<p>Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ServiceAffinity&#34;</span><span class="p">,</span>
   <span class="nt">&#34;args&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;LabelName&#34;</span><span class="p">:</span> <span class="s2">&#34;app&#34;</span><span class="p">,</span>
      <span class="nt">&#34;LabelValue&#34;</span><span class="p">:</span> <span class="s2">&#34;mysql&#34;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewServiceAffinity</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Unknown</span><span class="p">,</span> <span class="nx">h</span> <span class="nx">FrameworkHandle</span><span class="p">)</span> <span class="p">(</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">args</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot find service affinity plugin config&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ContentType</span> <span class="o">!=</span> <span class="s">&#34;application/json&#34;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot parse content type: %v&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ContentType</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">config</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">LabelName</span><span class="p">,</span> <span class="nx">LabelValue</span> <span class="kt">string</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;could not parse args&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="backward-compatibility">Backward Compatibility</h5>
<p>The current KubeSchedulerConfiguration type has <code>apiVersion:kubescheduler.config.k8s.io/v1alpha1</code>. This new configuration format is <code>v1alpha2</code> or <code>v1beta1</code>. When newer versions of the scheduler parse <code>v1alpha1</code>, the <code>policy</code> section will be used to construct the equivalent plugin configuration.</p>
<h4 id="interaction-with-cluster-autoscaler">Interaction with Cluster Autoscaler</h4>
<p>Cluster Autoscaler must run Filter plugins instead of predicates. This can be done by creating a Framework instance and calling RunFilterPlugins.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/extender/">extender</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/linux-file-system-and-file-caching/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Linux file system and file caching knowledge collation</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/tcp-connection/">
            <span class="next-text nav-default">Does the original TCP connection still exist after disconnecting the network cable?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
