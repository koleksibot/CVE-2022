<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Design and Implementation of Redis 7.0 Multi Part AOF - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Redis is a very popular in-memory database that allows for very high read and write performance by keeping data in memory. However, once a process exits, all of Redis&#39; data is lost. To solve this problem, Redis provides two persistence schemes, RDB and AOF, to save data in memory to disk and avoid data loss. In this article, we will focus on the AOF persistence scheme, some of its problems," /><meta name="keywords" content="Redis7, Multi Part Aof" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/redis7-multi-part-aof/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Design and Implementation of Redis 7.0 Multi Part AOF" />
<meta property="og:description" content="Redis is a very popular in-memory database that allows for very high read and write performance by keeping data in memory. However, once a process exits, all of Redis&#39; data is lost. To solve this problem, Redis provides two persistence schemes, RDB and AOF, to save data in memory to disk and avoid data loss. In this article, we will focus on the AOF persistence scheme, some of its problems," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/redis7-multi-part-aof/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-11T09:08:52+08:00" />
<meta property="article:modified_time" content="2022-02-11T09:08:52+08:00" />

<meta itemprop="name" content="Design and Implementation of Redis 7.0 Multi Part AOF">
<meta itemprop="description" content="Redis is a very popular in-memory database that allows for very high read and write performance by keeping data in memory. However, once a process exits, all of Redis&#39; data is lost. To solve this problem, Redis provides two persistence schemes, RDB and AOF, to save data in memory to disk and avoid data loss. In this article, we will focus on the AOF persistence scheme, some of its problems,"><meta itemprop="datePublished" content="2022-02-11T09:08:52+08:00" />
<meta itemprop="dateModified" content="2022-02-11T09:08:52+08:00" />
<meta itemprop="wordCount" content="4919">
<meta itemprop="keywords" content="redis," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Design and Implementation of Redis 7.0 Multi Part AOF"/>
<meta name="twitter:description" content="Redis is a very popular in-memory database that allows for very high read and write performance by keeping data in memory. However, once a process exits, all of Redis&#39; data is lost. To solve this problem, Redis provides two persistence schemes, RDB and AOF, to save data in memory to disk and avoid data loss. In this article, we will focus on the AOF persistence scheme, some of its problems,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Design and Implementation of Redis 7.0 Multi Part AOF</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-11 09:08:52 </span>
        <div class="post-category">
            <a href="/categories/news/"> news </a>
            </div>
          <span class="more-meta"> 4919 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-aof">1. AOF</a></li>
        <li><a href="#2-aofrw">2. AOFRW</a></li>
        <li><a href="#3-problems-with-aofrw">3. Problems with AOFRW</a>
          <ul>
            <li><a href="#1-memory-overhead">1. Memory overhead</a></li>
            <li><a href="#2-cpu-overhead">2. CPU Overhead</a></li>
            <li><a href="#3-disk-io-overhead">3. Disk IO Overhead</a></li>
            <li><a href="#4-code-complexity">4. Code Complexity</a></li>
          </ul>
        </li>
        <li><a href="#4-mp-aof-implementation">4. MP-AOF Implementation</a>
          <ul>
            <li><a href="#1-solution-overview">1. Solution Overview</a></li>
            <li><a href="#2-key-implementations">2. Key implementations</a></li>
          </ul>
        </li>
        <li><a href="#5-summary">5. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Redis is a very popular in-memory database that allows for very high read and write performance by keeping data in memory. However, once a process exits, all of Redis' data is lost.</p>
<p>To solve this problem, Redis provides two persistence schemes, RDB and AOF, to save data in memory to disk and avoid data loss. In this article, we will focus on the AOF persistence scheme, some of its problems, and discuss the design and implementation details of Multi Part AOF (hereinafter referred to as MP-AOF, a feature contributed by the AliCloud Database Tair team) in Redis 7.0 (released in RC1).</p>
<h2 id="1-aof">1. AOF</h2>
<p>AOF ( append only file ) persistence records each write command as a separate log file, and plays back the commands in the AOF file for data recovery purposes when Redis starts.</p>
<p>Since AOF records each redis write command as an append, as Redis processes more write commands, the AOF file becomes larger and the time to replay the commands increases, to solve this problem, Redis introduces the AOF rewrite mechanism (hereafter called AOFRW). AOFRW removes redundant writes from the AOF and rewrites them in an equivalent manner, generating a new AOF file to reduce the size of the AOF file.</p>
<h2 id="2-aofrw">2. AOFRW</h2>
<p>Figure 1 shows the principle of AOFRW implementation. When AOFRW is triggered, Redis first forks a child process to perform a background rewrite operation, which rewrites a snapshot of Redis data at the moment of the fork to a temporary AOF file called temp-rewriteaof-bg-pid.aof.</p>
<p>Since the rewrite operation is performed in the background by the child process, the master process can still respond to user commands during the AOF rewrite. Therefore, in order for the child process to eventually also get the incremental changes generated by the master process during the rewrite, the master process will write a copy of the executed write commands to the aof_buf in addition to writing them to the aof_rewrite_buf for caching. At a later stage of rewriting by the child process, the master process sends the accumulated data in the aof_rewrite_buf to the child process using pipe, and the child process appends this data to the temporary AOF file.</p>
<p>When the master process takes on a large amount of write traffic, aof_rewrite_buf may accumulate a very large amount of data, resulting in the child process not being able to consume all the data in aof_rewrite_buf during the rewrite period. In this case, the remaining data in the aof_rewrite_buf will be processed by the master process at the end of the rewrite.</p>
<p>When the child process finishes the rewrite operation and exits, the main process will handle the rest in the backgroundRewriteDoneHandler. First, the unconsumed data in the aof_rewrite_buf during the rewrite is appended to the temporary AOF file. Second, when everything is ready, Redis will use the rename operation to atomically rename the temporary AOF file to server.aof_filename, at which point the original AOF file will be overwritten. At this point, the entire AOFRW process is complete.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/f639ec979ecf4d86b02358cd6cacd1d4.png" alt="sobyte"></p>
<h2 id="3-problems-with-aofrw">3. Problems with AOFRW</h2>
<h3 id="1-memory-overhead">1. Memory overhead</h3>
<p>As you can see from Figure 1, during AOFRW, the main process writes the data changes after fork into aof_rewrite_buf. The vast majority of the contents of aof_rewrite_buf and aof_buf are duplicated, so this introduces additional memory redundancy overhead.</p>
<p>The size of the memory occupied by aof_rewrite_buf at the current moment can be seen in the aof_rewrite_buffer_length field in Redis INFO. As shown below, at high write traffic aof_rewrite_buffer_length takes up almost as much memory space as aof_buffer_length, almost doubling the amount of memory wasted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">aof_pending_rewrite:0
aof_buffer_length:35500
aof_rewrite_buffer_length:34000
aof_pending_bio_fsync:0
</code></pre></td></tr></table>
</div>
</div><p>When the memory size occupied by aof_rewrite_buf exceeds a certain threshold, we will see the following message in the Redis log. As you can see, aof_rewrite_buf is taking up 100MB of memory space and 2135MB of data is being transferred between the main process and the child process (the child process also has internal memory overhead for reading the buffer when it reads this data via pipe).</p>
<p>This is a significant amount of overhead for Redis, an in-memory database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">3351:M 25 Jan 2022 09:55:39.655 * Background append only file rewriting started by pid 6817
3351:M 25 Jan 2022 09:57:51.864 * AOF rewrite child asks to stop sending diffs.
6817:C 25 Jan 2022 09:57:51.864 * Parent agreed to stop sending diffs. Finalizing AOF...
6817:C 25 Jan 2022 09:57:51.864 * Concatenating 2135.60 MB of AOF diff received from parent.
3351:M 25 Jan 2022 09:57:56.545 * Background AOF buffer size: 100 MB
</code></pre></td></tr></table>
</div>
</div><p>When the memory size occupied by aof_rewrite_buf exceeds a certain threshold, we will see the following message in the Redis log. As you can see, aof_rewrite_buf is taking up 100MB of memory space and 2135MB of data is being transferred between the main process and the child process (the child process also has internal memory overhead for reading the buffer when it reads this data via pipe).</p>
<p>This is a significant amount of overhead for Redis, an in-memory database.</p>
<p>The memory overhead from AOFRW can cause Redis memory to suddenly reach the maxmemory limit, which can affect normal command writes and even trigger the OS limit to be killed by the OOM Killer, making Redis unserviceable.</p>
<h3 id="2-cpu-overhead">2. CPU Overhead</h3>
<p>There are three main areas of CPU overhead, each explained as follows.</p>
<ol>
<li>
<p>during AOFRW, the master process spends CPU time writing data to the aof_rewrite_buf and sending the data in the aof_rewrite_buf to the child processes using the eventloop event loop.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Append data to the AOF rewrite buffer, allocating new blocks if needed. */</span>
<span class="kt">void</span> <span class="nf">aofRewriteBufferAppend</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* Install a file event to send data to the rewrite child if there is
</span><span class="cm">    * not one already. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">aof_stop_sending_diff</span> <span class="o">&amp;&amp;</span>
        <span class="n">aeGetFileEvents</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_write_data_to_child</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">aeCreateFileEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_write_data_to_child</span><span class="p">,</span>
            <span class="n">AE_WRITABLE</span><span class="p">,</span> <span class="n">aofChildWriteDiffData</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span> 

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>At the later stage of the rewrite operation performed by the child process, the incremental data sent by the main process in the pipe is read cyclically and then appended and written to the temporary AOF file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">rewriteAppendOnlyFile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* Read again a few times to get more data from the parent.
</span><span class="cm">    * We can&#39;t read forever (the server may receive data from clients
</span><span class="cm">    * faster than it is able to send data to the child), so we try to read
</span><span class="cm">    * some more data in a loop as soon as there is a good chance more data
</span><span class="cm">    * will come. If it looks like we are wasting time, we abort (this
</span><span class="cm">    * happens after 20 ms without new data). */</span>
    <span class="kt">int</span> <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">mstime_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="n">mstime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">nodata</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aeWait</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_read_data_from_parent</span><span class="p">,</span> <span class="n">AE_READABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">nodata</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Start counting from zero, we stop on N *contiguous*
</span><span class="cm">                    timeouts. */</span>
        <span class="n">aofReadDiffFromParent</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>After the child process completes the rewrite operation, the master process performs the finishing work in the backgroundRewriteDoneHandler. One of the tasks is to write the data in aof_rewrite_buf that was not consumed during the rewrite to a temporary AOF file. If there is a lot of data left in the aof_rewrite_buf, CPU time will be consumed here as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="kt">void</span> <span class="nf">backgroundRewriteDoneHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">exitcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bysignal</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* Flush the differences accumulated by the parent to the rewritten AOF. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aofRewriteBufferWrite</span><span class="p">(</span><span class="n">newfd</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span>
                <span class="s">&#34;Error trying to flush the parent diff to the rewritten AOF: %s&#34;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">close</span><span class="p">(</span><span class="n">newfd</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>The CPU overhead from AOFRW may cause Redis to experience jitter on RT when executing commands, or even cause client timeouts.</p>
<h3 id="3-disk-io-overhead">3. Disk IO Overhead</h3>
<p>As mentioned earlier, during AOFRW, the master process writes a copy of the executed write command to aof_buf in addition to a copy to aof_rewrite_buf. The data in aof_buf is eventually written to the old AOF file currently in use, generating disk IO. at the same time, the data in aof_rewrite_buf is also written to the Therefore, the same data will generate disk IO twice.</p>
<h3 id="4-code-complexity">4. Code Complexity</h3>
<p>Redis uses the six pipes shown below for data transfer and control interactions between the master and child processes, which makes the entire AOFRW logic more complex and difficult to understand.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
 <span class="cm">/* AOF pipes used to communicate between parent and child during rewrite. */</span>
 <span class="kt">int</span> <span class="n">aof_pipe_write_data_to_child</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">aof_pipe_read_data_from_parent</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">aof_pipe_write_ack_to_parent</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">aof_pipe_read_ack_from_child</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">aof_pipe_write_ack_to_child</span><span class="p">;</span>
 <span class="kt">int</span> <span class="n">aof_pipe_read_ack_from_parent</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="4-mp-aof-implementation">4. MP-AOF Implementation</h2>
<h3 id="1-solution-overview">1. Solution Overview</h3>
<p>As the name implies, MP-AOF is to split the original single AOF file into multiple AOF files. In MP-AOF, we divide AOF into three types, which are.</p>
<ul>
<li>BASE: denotes base AOF, which is generally generated by child processes through rewriting, and there is at most one of this file.</li>
<li>INCR: denotes incremental AOF, which is generally created when AOFRW starts execution, and this file may exist more than one.</li>
<li>HISTORY: denotes historical AOF, which is changed from BASE and INCR AOF. Each time AOFRW completes successfully, the corresponding BASE and INCR AOFs before this AOFRW will be changed to HISTORY, and AOFs of HISTORY type will be deleted automatically by Redis.</li>
</ul>
<p>To manage these AOF files, we introduce a manifest file to track and manage these AOFs, and to facilitate AOF backup and copying, we put all AOF files and manifest files into a single directory with a name determined by the appenddirname configuration (a new configuration item in Redis 7.0) The name of the directory is determined by the appenddirname configuration (new in Redis 7.0).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/11/d9db3a3d8c674eebb7110eada908e48a.png" alt="redis"></p>
<p>Figure 2 shows the general flow of executing an AOFRW in MP-AOF. At the beginning we still fork a child process for the rewrite operation, and in the main process we open a new INCR type AOF file at the same time. During the rewrite operation of the child process, all data changes are written to this newly opened INCR AOF. At the end of the AOFRW, the master process is responsible for updating the manifest file with the newly generated BASE AOF and the newly opened INCR AOF, which represents all the data in Redis at the current moment. At the end of AOFRW, the master process is responsible for updating the manifest file, adding the newly generated BASE AOF and INCR AOF information to it, and marking the previous BASE AOF and INCR AOF as HISTORY (these HISTORY AOFs are deleted by Redis asynchronously). Once the manifest file is updated, it marks the end of the entire AOFRW process.</p>
<p>As can be seen in Figure 2, we no longer need the aof_rewrite_buf during AOFRW, so the corresponding memory consumption is removed. At the same time, there is no more data transfer and control interaction between the main process and the child process, so the corresponding CPU overhead is also removed. Correspondingly, the six pipes and their corresponding code are also removed, making the AOFRW logic simpler and clearer.</p>
<h3 id="2-key-implementations">2. Key implementations</h3>
<h4 id="manifest">Manifest</h4>
<h5 id="1-representation-in-memory">1) Representation in memory</h5>
<p>MP-AOF strongly depends on the manifest file. The manifest is represented in memory as the following structure, where</p>
<ul>
<li>aofInfo: represents an AOF file information, currently only includes file name, file serial number and file type</li>
<li>base_aof_info: indicates BASE AOF information, when no BASE AOF exists, this field is NULL</li>
<li>incr_aof_list: used to store the information of all INCR AOF files, all INCR AOF will be discharged according to the file opening order</li>
<li>history_aof_list: used to store HISTORY AOF information, the elements in history_aof_list are moved from base_aof_info and incr_aof_list.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">sds</span>           <span class="n">file_name</span><span class="p">;</span>  <span class="cm">/* file name */</span>
    <span class="kt">long</span> <span class="kt">long</span>     <span class="n">file_seq</span><span class="p">;</span>   <span class="cm">/* file sequence */</span>
    <span class="n">aof_file_type</span> <span class="n">file_type</span><span class="p">;</span>  <span class="cm">/* file type */</span>
<span class="p">}</span> <span class="n">aofInfo</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">aofInfo</span>     <span class="o">*</span><span class="n">base_aof_info</span><span class="p">;</span>       <span class="cm">/* BASE file information. NULL if there is no BASE file. */</span>
    <span class="n">list</span>        <span class="o">*</span><span class="n">incr_aof_list</span><span class="p">;</span>       <span class="cm">/* INCR AOFs list. We may have multiple INCR AOF when rewrite fails. */</span>
    <span class="n">list</span>        <span class="o">*</span><span class="n">history_aof_list</span><span class="p">;</span>    <span class="cm">/* HISTORY AOF list. When the AOFRW success, The aofInfo contained in
</span><span class="cm">                                         `base_aof_info` and `incr_aof_list` will be moved to this list. We
</span><span class="cm">                                         will delete these AOF files when AOFRW finish. */</span>
    <span class="kt">long</span> <span class="kt">long</span>   <span class="n">curr_base_file_seq</span><span class="p">;</span>   <span class="cm">/* The sequence number used by the current BASE file. */</span>
    <span class="kt">long</span> <span class="kt">long</span>   <span class="n">curr_incr_file_seq</span><span class="p">;</span>   <span class="cm">/* The sequence number used by the current INCR file. */</span>
    <span class="kt">int</span>         <span class="n">dirty</span><span class="p">;</span>                <span class="cm">/* 1 Indicates that the aofManifest in the memory is inconsistent with
</span><span class="cm">                                         disk, we need to persist it immediately. */</span>
<span class="p">}</span> <span class="n">aofManifest</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>To facilitate atomic modification and rollback operations, we use a pointer reference to aofManifest in the redisServer structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="n">aofManifest</span> <span class="o">*</span><span class="n">aof_manifest</span><span class="p">;</span>       <span class="cm">/* Used to track AOFs. */</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="2-representation-on-disk">2) Representation on disk</h5>
<p>A manifest is essentially a text file containing multiple lines of records, each line of which corresponds to an AOF file of information that is presented in key/value pairs for Redis processing, easy reading and modification. The following is a possible manifest file content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">file appendonly.aof.1.base.rdb seq 1 type b
file appendonly.aof.1.incr.aof seq 1 type i
file appendonly.aof.2.incr.aof seq 2 type i
</code></pre></td></tr></table>
</div>
</div><p>The Manifest format itself needs to be extensible to add or support other features in the future. For example, it can easily support new key/value and annotations (similar to the annotations in AOF), which can ensure better forward compatibility.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">file appendonly.aof.1.base.rdb seq 1 type b newkey newvalue
file appendonly.aof.1.incr.aof type i seq 1 
# this is annotations
seq 2 type i file appendonly.aof.2.incr.aof
</code></pre></td></tr></table>
</div>
</div><h4 id="file-naming-rules">File Naming Rules</h4>
<p>Before MP-AOF, the AOF file name was the value set by the appendfilename parameter (default is appendonly.aof).</p>
<p>In MP-AOF, we use basename.suffix to name multiple AOF files. Where the appendfilename configuration content will be used as the basename part and the suffix will consist of three parts in the format seq.type.format , where.</p>
<ul>
<li>seq is the file serial number, starting from 1 monotonically increasing, BASE and INCR have separate file serial numbers</li>
<li>type is the type of the AOF, indicating whether the AOF file is a BASE or an INCR</li>
<li>format is the internal encoding of the AOF. Since Redis supports the RDB preamble mechanism, the BASE AOF may be encoded in RDB format or AOF format.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#define BASE_FILE_SUFFIX           &#34;.base&#34;
#define INCR_FILE_SUFFIX           &#34;.incr&#34;
#define RDB_FORMAT_SUFFIX          &#34;.rdb&#34;
#define AOF_FORMAT_SUFFIX          &#34;.aof&#34;
#define MANIFEST_NAME_SUFFIX       &#34;.manifest&#34;
</code></pre></td></tr></table>
</div>
</div><p>Therefore, when using the appendfilename default configuration, the possible naming of the BASE, INCR and manifest files are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">appendonly.aof.1.base.rdb // 开启RDB preamble
appendonly.aof.1.base.aof // 关闭RDB preamble
appendonly.aof.1.incr.aof
appendonly.aof.2.incr.aof
</code></pre></td></tr></table>
</div>
</div><h4 id="is-compatible-with-old-version-upgrades">is compatible with old version upgrades</h4>
<p>Since MP-AOF is strongly dependent on the manifest file, Redis will load the corresponding AOF file strictly according to the manifest instructions when it starts. However, when upgrading from an older version of Redis (meaning versions prior to Redis 7.0) to Redis 7.0, since there is no manifest file at this time, the ability for Redis to correctly recognize that this is an upgrade process and to load the old AOF correctly and safely is a capability that must be supported.</p>
<p>The ability to recognize this is the first part of this important process, and before we actually load the AOF file, we check to see if an AOF file named server.aof_filename exists in the Redis working directory. If it exists, then we are probably performing an upgrade from an older version of Redis. Next, we proceed to determine that we consider this to be an upgrade launch when one of the following three conditions is met.</p>
<ol>
<li>if the appenddirname directory does not exist.</li>
<li>or the appenddirname directory exists, but there is no corresponding manifest file in the directory.</li>
<li>if the appenddirname directory exists and there is a manifest file in the directory, and there is only BASE AOF information in the manifest file, and the name of this BASE AOF is the same as server.aof_filename, and there is no file named server.aof_filename in the appenddirname directory. filename.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="cm">/* Load the AOF files according the aofManifest pointed by am. */</span>
<span class="kt">int</span> <span class="nf">loadAppendOnlyFiles</span><span class="p">(</span><span class="n">aofManifest</span> <span class="o">*</span><span class="n">am</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* If the &#39;server.aof_filename&#39; file exists in dir, we may be starting
</span><span class="cm">     * from an old redis version. We will use enter upgrade mode in three situations.
</span><span class="cm">     *
</span><span class="cm">     * 1. If the &#39;server.aof_dirname&#39; directory not exist
</span><span class="cm">     * 2. If the &#39;server.aof_dirname&#39; directory exists but the manifest file is missing
</span><span class="cm">     * 3. If the &#39;server.aof_dirname&#39; directory exists and the manifest file it contains
</span><span class="cm">     *    has only one base AOF record, and the file name of this base AOF is &#39;server.aof_filename&#39;,
</span><span class="cm">     *    and the &#39;server.aof_filename&#39; file not exist in &#39;server.aof_dirname&#39; directory
</span><span class="cm">     * */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fileExist</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dirExists</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_dirname</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">listLength</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">incr_aof_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">listLength</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">incr_aof_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
             <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aofFileExist</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">aofUpgradePrepare</span><span class="p">(</span><span class="n">am</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once this is recognized as an upgrade launch, we will use the aofUpgradePrepare function to do the pre-upgrade preparation.</p>
<p>The upgrade preparation is divided into three main parts.</p>
<ol>
<li>construct a BASE AOF message using server.aof_filename as the filename.</li>
<li>persist the BASE AOF information to the manifest file.</li>
<li>use rename to move the old AOF file to the appenddirname directory.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="kt">void</span> <span class="nf">aofUpgradePrepare</span><span class="p">(</span><span class="n">aofManifest</span> <span class="o">*</span><span class="n">am</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* 1. Manually construct a BASE type aofInfo and add it to aofManifest. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span><span class="p">)</span> <span class="n">aofInfoFree</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span><span class="p">);</span>
    <span class="n">aofInfo</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">aofInfoCreate</span><span class="p">();</span>
    <span class="n">ai</span><span class="o">-&gt;</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">sdsnew</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">);</span>
    <span class="n">ai</span><span class="o">-&gt;</span><span class="n">file_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ai</span><span class="o">-&gt;</span><span class="n">file_type</span> <span class="o">=</span> <span class="n">AOF_FILE_TYPE_BASE</span><span class="p">;</span>
    <span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span> <span class="o">=</span> <span class="n">ai</span><span class="p">;</span>
    <span class="n">am</span><span class="o">-&gt;</span><span class="n">curr_base_file_seq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">am</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* 2. Persist the manifest file to AOF directory. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">persistAofManifest</span><span class="p">(</span><span class="n">am</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* 3. Move the old AOF file to AOF directory. */</span>
    <span class="n">sds</span> <span class="n">aof_filepath</span> <span class="o">=</span> <span class="n">makePath</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_dirname</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">,</span> <span class="n">aof_filepath</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sdsfree</span><span class="p">(</span><span class="n">aof_filepath</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);;</span>
    <span class="p">}</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The upgrade preparation operation is Crash Safe, and a Crash in any of the above three steps will allow us to correctly identify and retry the entire upgrade operation in the next boot.</p>
<h4 id="multi-file-loading-and-progress-calculation">Multi-file loading and progress calculation</h4>
<p>Redis keeps track of the loading progress when loading an AOF, and displays it in the loading_loaded_perc field of the Redis INFO. In MP-AOF, the loadAppendOnlyFiles function performs AOF file loading based on the aofManifest passed in. Before doing the loading, we need to calculate the total size of all the AOF files to be loaded in advance and pass it to the startLoading function, and then keep reporting the loading progress in loadSingleAppendOnlyFile.</p>
<p>Next, loadAppendOnlyFiles will load BASE AOF and INCR AOF in order according to aofManifest. stopLoading will be used to end the loading state after all AOF files are currently loaded.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">
<span class="kt">int</span> <span class="nf">loadAppendOnlyFiles</span><span class="p">(</span><span class="n">aofManifest</span> <span class="o">*</span><span class="n">am</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span>
    <span class="cm">/* Here we calculate the total size of all BASE and INCR files in
</span><span class="cm">     * advance, it will be set to `server.loading_total_bytes`. */</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="n">getBaseAndIncrAppendOnlyFilesSize</span><span class="p">(</span><span class="n">am</span><span class="p">);</span>
    <span class="n">startLoading</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/* Load BASE AOF if needed. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aof_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">base_aof_info</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">;</span>
        <span class="n">updateLoadingFileName</span><span class="p">(</span><span class="n">aof_name</span><span class="p">);</span>
        <span class="n">loadSingleAppendOnlyFile</span><span class="p">(</span><span class="n">aof_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Load INCR AOFs if needed. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listLength</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">incr_aof_list</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>

        <span class="n">listRewind</span><span class="p">(</span><span class="n">am</span><span class="o">-&gt;</span><span class="n">incr_aof_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">aofInfo</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="p">(</span><span class="n">aofInfo</span><span class="o">*</span><span class="p">)</span><span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
            <span class="n">aof_name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">;</span>
            <span class="n">updateLoadingFileName</span><span class="p">(</span><span class="n">aof_name</span><span class="p">);</span>
            <span class="n">loadSingleAppendOnlyFile</span><span class="p">(</span><span class="n">aof_name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_base_size</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_fsync_offset</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">;</span>

    <span class="n">stopLoading</span><span class="p">();</span>

    <span class="c1">// 此处省略其他细节...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="aofrw-crash-safety">AOFRW Crash Safety</h4>
<p>When the child process completes the rewrite operation, it creates a temporary AOF file called temp-rewriteaof-bg-pid.aof, which is still not visible to Redis because it has not yet been added to the manifest file. To make it visible to Redis and load it correctly when Redis starts, we need to rename it and add its information to the manifest file according to the naming convention mentioned earlier.</p>
<p>Although AOF file rename and manifest file modification are two separate operations, we must ensure atomicity in both operations so that Redis can load the corresponding AOF correctly at startup. MP-AOF uses two designs to solve this problem.</p>
<ol>
<li>the name of the BASE AOF contains the file serial number, ensuring that each BASE AOF created does not conflict with previous BASE AOFs.</li>
<li>executing the rename operation of the AOF first, and then modifying the manifest file.</li>
</ol>
<p>For the sake of illustration, let&rsquo;s assume that before AOFRW starts, the contents of the manifest file are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">file appendonly.aof.1.base.rdb seq <span class="m">1</span> <span class="nb">type</span> b
file appendonly.aof.1.incr.aof seq <span class="m">1</span> <span class="nb">type</span> i
</code></pre></td></tr></table>
</div>
</div><p>The content of the manifest file after the execution of AOFRW starts is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">file appendonly.aof.1.base.rdb seq <span class="m">1</span> <span class="nb">type</span> b
file appendonly.aof.1.incr.aof seq <span class="m">1</span> <span class="nb">type</span> i
file appendonly.aof.2.incr.aof seq <span class="m">2</span> <span class="nb">type</span> i
</code></pre></td></tr></table>
</div>
</div><p>After the subprocess rewrite is finished, in the main process, we will rename temp-rewriteaof-bg-pid.aof to appendonly.aof.2.base.rdb and add it to the manifest, and will mark the previous BASE and INCR AOF as HISTORY. at this point the manifest file will look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">file appendonly.aof.2.base.rdb seq <span class="m">2</span> <span class="nb">type</span> b
file appendonly.aof.1.base.rdb seq <span class="m">1</span> <span class="nb">type</span> h
file appendonly.aof.1.incr.aof seq <span class="m">1</span> <span class="nb">type</span> h
file appendonly.aof.2.incr.aof seq <span class="m">2</span> <span class="nb">type</span> i
</code></pre></td></tr></table>
</div>
</div><p>At this point, the results of this AOFRW are visible to Redis, and the HISTORY AOF is cleaned up asynchronously by Redis.</p>
<p>The backgroundRewriteDoneHandler function implements the above logic in seven steps.</p>
<ol>
<li>dup a temporary manifest structure before modifying the server.aof_manifest in memory, and all subsequent modifications will be made to this temporary manifest. The advantage of this is that if the later steps fail, we can simply destroy the temporary manifest and thus roll back the entire operation, avoiding contaminating the server.aof_manifest global data structure.</li>
<li>get the new BASE AOF filename (noted as new_base_filename) from the temporary manifest and mark the previous (if any) BASE AOF as HISTORY.</li>
<li>renaming the temp-rewriteaof-bg-pid.aof temporary file generated by the child process to new_base_filename.</li>
<li>mark all the previous INCR AOFs in the temporary manifest structure as type HISTORY.</li>
<li>persist the information corresponding to the temporary manifest to disk (persistAofManifest internally will ensure atomicity of the modifications to the manifest itself).</li>
<li>if all the above steps are successful, we can safely point the server.aof_manifest pointer in memory to the temporary manifest structure (and release the previous manifest structure), up to which point the entire modification is visible to Redis.</li>
<li>clear the AOF of type HISTORY, this step is allowed to fail because it does not cause data consistency problems.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">backgroundRewriteDoneHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">exitcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bysignal</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s">&#34;temp-rewriteaof-bg-%d.aof&#34;</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">server</span><span class="p">.</span><span class="n">child_pid</span><span class="p">);</span>

    <span class="cm">/* 1. Dup a temporary aof_manifest for subsequent modifications. */</span>
    <span class="n">temp_am</span> <span class="o">=</span> <span class="n">aofManifestDup</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_manifest</span><span class="p">);</span>

    <span class="cm">/* 2. Get a new BASE file name and mark the previous (if we have)
</span><span class="cm">     * as the HISTORY type. */</span>
    <span class="n">new_base_filename</span> <span class="o">=</span> <span class="n">getNewBaseFileNameAndMarkPreAsHistory</span><span class="p">(</span><span class="n">temp_am</span><span class="p">);</span>

    <span class="cm">/* 3. Rename the temporary aof file to &#39;new_base_filename&#39;. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="n">new_base_filename</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aofManifestFree</span><span class="p">(</span><span class="n">temp_am</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 4. Change the AOF file type in &#39;incr_aof_list&#39; from AOF_FILE_TYPE_INCR
</span><span class="cm">     * to AOF_FILE_TYPE_HIST, and move them to the &#39;history_aof_list&#39;. */</span>
    <span class="n">markRewrittenIncrAofAsHistory</span><span class="p">(</span><span class="n">temp_am</span><span class="p">);</span>

    <span class="cm">/* 5. Persist our modifications. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">persistAofManifest</span><span class="p">(</span><span class="n">temp_am</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bg_unlink</span><span class="p">(</span><span class="n">new_base_filename</span><span class="p">);</span>
        <span class="n">aofManifestFree</span><span class="p">(</span><span class="n">temp_am</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* 6. We can safely let `server.aof_manifest` point to &#39;temp_am&#39; and free the previous one. */</span>
    <span class="n">aofManifestFreeAndUpdate</span><span class="p">(</span><span class="n">temp_am</span><span class="p">);</span>

    <span class="cm">/* 7. We don&#39;t care about the return value of `aofDelHistoryFiles`, because the history
</span><span class="cm">     * deletion failure will not cause any problems. */</span>
    <span class="n">aofDelHistoryFiles</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="supports-aof-truncate">supports AOF truncate</h4>
<p>By default, Redis cannot load such incomplete AOFs, but Redis supports the AOF truncate feature (turned on via the aof-load- truncated configuration). The principle is to use server.aof_current_size to track the last correct file offset of the AOF, and then use the ftruncate function to remove all file contents after that offset, which may lose some data, but ensures the integrity of the AOF.</p>
<p>In MP-AOF, server.aof_current_size no longer indicates the size of a single AOF file but the total size of all AOF files. Since only the last INCR AOF is likely to have incomplete writes, we have introduced a separate field server.aof_last_incr_size to track the size of the last INCR AOF file. When the last INCR AOF has an incomplete write, we simply remove the contents of the file after server.aof_last_incr_size.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"> <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_last_incr_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//此处省略其他细节...
</span><span class="c1"></span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="aofrw-flow-limiting">AOFRW Flow Limiting</h4>
<p>Redis supports automatic execution of AOFRW when the AOF size exceeds a certain threshold. When a disk failure occurs or a code bug is triggered that causes AOFRW to fail, Redis will keep executing AOFRW repeatedly until it succeeds. Before MP-AOF, this didn&rsquo;t seem like a big deal (at best, it consumed some CPU time and fork overhead). But in MP-AOF, because each AOFRW opens an INCR AOF, and only when the AOFRW succeeds will the previous INCR and BASE be converted to HISTORY and deleted. Therefore, successive AOFRW failures will inevitably lead to the problem of multiple INCR AOFs co-existing. In extreme cases, if AOFRW retries are frequent we will see hundreds or thousands of INCR AOF files.</p>
<p>For this reason, we have introduced the AOFRW flow limitation mechanism. That is, when AOFRW has failed three times in a row, the next AOFRW will be forcibly delayed by 1 minute, and if the next AOFRW still fails, it will be delayed by 2 minutes, and so on for 4, 8, 16&hellip; , the current maximum delay time is 1 hour.</p>
<p>During the AOFRW restriction period, we can still use the bgrewriteaof command to execute an AOFRW immediately.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">==</span> <span class="n">AOF_ON</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="n">hasActiveChildProcess</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_perc</span> <span class="o">&amp;&amp;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_min_size</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="n">aofRewriteLimited</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_base_size</span> <span class="o">?</span>
        <span class="n">server</span><span class="p">.</span><span class="nl">aof_rewrite_base_size</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">growth</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">base</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">growth</span> <span class="o">&gt;=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_perc</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rewriteAppendOnlyFileBackground</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The introduction of the AOFRW flow-limiting mechanism also effectively avoids the CPU and fork overhead associated with high-frequency retries in AOFRW. a lot of RT jitter in Redis is related to fork.</p>
<p>The introduction of the AOFRW flow-limiting mechanism also effectively avoids the CPU and fork overhead associated with high-frequency retries in AOFRW. a lot of RT jitter in Redis is related to fork.</p>
<h2 id="5-summary">5. Summary</h2>
<p>The introduction of MP-AOF has successfully solved the memory and CPU overheads of AOFRW, which had a negative impact on Redis instances and even business access. At the same time, in the process of solving these problems, we encountered many unforeseen challenges, mainly from Redis' large user base and diverse usage scenarios, so we had to consider the problems that users might encounter in using MP-AOF in various scenarios. Such as compatibility, ease of use, and minimizing intrusiveness into Redis code. This is a top priority for the Redis community in terms of feature evolution.</p>
<p>At the same time, the introduction of MP-AOF has brought more imagination to data persistence in Redis. For example, when aof-use-rdb-preamble is enabled, BASE AOF is essentially an RDB file, so we don&rsquo;t need to perform a separate BGSAVE operation when performing a full backup. MP-AOF supports the ability to turn off automatic cleanup of the HISTORY AOF, so those historical AOFs have a chance to be preserved, and Redis now supports adding timestamp annotations to the AOF, so we can even implement a simple PITR capability based on this (point-in-time recovery). point-in-time recovery).</p>
<p>The design prototype of MP-AOF comes from the binlog implementation of <a href="https://help.aliyun.com/document_detail/145956.html">Tair for redis Enterprise Edition</a>, which is a set of core features proven on AliCloud Tair service. Today we are contributing this core capability to the Redis community, hoping that community users can also enjoy these enterprise-class features and create their own business code through better optimization with these enterprise-class features. For more details on MP-AOF, please move to the related PR ([#9788]), where more original designs and full code are available.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/redis/">redis</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/debezium/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Database synchronization tool Debezium</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/nginx-debian-10/">
            <span class="next-text nav-default">How to set up an Nginx server on Debian 10</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
