<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Android list scrolling optimization of OverScroller revealed - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. Introduction OverScroller in Android is responsible for calculating the real-time sliding position for ListView, RecyclerView, ScrollView and other scrolling controls, and these position algorithms directly affect the experience of each scroll. As we all know, Android&amp;rsquo;s animation experience is ~far~ inferior to iOS, and even now that Android generally supports 120Hz high swipe, the experience is not very comfortable. The reason for this is no longer hardware performance limitations," /><meta name="keywords" content="Android, Over Scroller" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/android-over-scroller/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Android list scrolling optimization of OverScroller revealed" />
<meta property="og:description" content="1. Introduction OverScroller in Android is responsible for calculating the real-time sliding position for ListView, RecyclerView, ScrollView and other scrolling controls, and these position algorithms directly affect the experience of each scroll. As we all know, Android&rsquo;s animation experience is ~far~ inferior to iOS, and even now that Android generally supports 120Hz high swipe, the experience is not very comfortable. The reason for this is no longer hardware performance limitations," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/android-over-scroller/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-15T09:12:37+08:00" />
<meta property="article:modified_time" content="2022-02-15T09:12:37+08:00" />

<meta itemprop="name" content="Android list scrolling optimization of OverScroller revealed">
<meta itemprop="description" content="1. Introduction OverScroller in Android is responsible for calculating the real-time sliding position for ListView, RecyclerView, ScrollView and other scrolling controls, and these position algorithms directly affect the experience of each scroll. As we all know, Android&rsquo;s animation experience is ~far~ inferior to iOS, and even now that Android generally supports 120Hz high swipe, the experience is not very comfortable. The reason for this is no longer hardware performance limitations,"><meta itemprop="datePublished" content="2022-02-15T09:12:37+08:00" />
<meta itemprop="dateModified" content="2022-02-15T09:12:37+08:00" />
<meta itemprop="wordCount" content="3816">
<meta itemprop="keywords" content="android," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android list scrolling optimization of OverScroller revealed"/>
<meta name="twitter:description" content="1. Introduction OverScroller in Android is responsible for calculating the real-time sliding position for ListView, RecyclerView, ScrollView and other scrolling controls, and these position algorithms directly affect the experience of each scroll. As we all know, Android&rsquo;s animation experience is ~far~ inferior to iOS, and even now that Android generally supports 120Hz high swipe, the experience is not very comfortable. The reason for this is no longer hardware performance limitations,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Android list scrolling optimization of OverScroller revealed</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-15 09:12:37 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3816 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction">1. Introduction</a></li>
        <li><a href="#2-introduction-to-use">2. Introduction to use</a></li>
        <li><a href="#3-deep-inside-the-overscroller">3. Deep inside the OverScroller</a>
          <ul>
            <li><a href="#31-startscroll">3.1 startScroll</a></li>
            <li><a href="#32-fling--springback">3.2 fling &amp; springBack</a></li>
          </ul>
        </li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-introduction">1. Introduction</h2>
<p><code>OverScroller</code> in Android is responsible for calculating the real-time sliding position for ListView, RecyclerView, ScrollView and other scrolling controls, and these position algorithms directly affect the experience of each scroll.</p>
<p>As we all know, Android&rsquo;s animation experience is ~far~ inferior to iOS, and even now that Android generally supports 120Hz high swipe, the experience is not very comfortable. The reason for this is no longer hardware performance limitations, but the design of many of these animations is inherently problematic. Apple released <a href="https://developer.apple.com/videos/play/wwdc2018/803">Designing Fluid Interfaces</a> a long time ago to create a silky smooth user experience, on the contrary, Android, for a daily use of the most used swipe tool class Odel The most used sliding tool class on Android, <code>OverScroller</code>, has seen very few improvements in recent years, almost none, which is really something I want to spit out.</p>
<p>This series is divided into two articles, the first one is about the usage and principle of <code>OverScroller</code>, the core tool class for Android scrolling, and the second one will explore how to improve it, hoping that each exploration will bring improvement to the user experience.</p>
<h2 id="2-introduction-to-use">2. Introduction to use</h2>
<p>Before we use it, let&rsquo;s see what OverScroller can do.</p>
<ul>
<li>startScroll: Scrolls a specified distance from a specified position and then stops, the scrolling effect is related to the set scroll distance, scroll time, interpolator, <strong>not related to the off-hand speed</strong>. Generally used to control the View scrolling to the <strong>specified</strong> position.</li>
<li>fling: slide a position from the specified position and then stop, the scrolling effect is only related to the <strong>off-hand speed</strong> and sliding boundary, <strong>not</strong> set the scrolling distance, scrolling time and interpolator. Generally used to continue to let the View slide for a while after touching the raised hand.</li>
<li>springBack: spring back from the specified position to the specified position, generally used to achieve the spring back effect after dragging, can not specify the spring back time and interpolator.</li>
</ul>
<table>
<thead>
<tr>
<th>startScroll</th>
<th>fling</th>
<th>springBack</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/76c24ea9073a44939fdc360c02110731.gif" alt="startScroll"></td>
<td><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/43829412953e492998f2f438d2121b8b.gif" alt="fling"></td>
<td><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/a6ce1586b4594969844107102b105551.gif" alt="springBack"></td>
</tr>
</tbody>
</table>
<p>It is also simple to use in code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 1. 启动一个滚动
</span><span class="c1"></span><span class="n">mOverScroller</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1600</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="o">-</span><span class="n">1000</span><span class="o">,</span> <span class="n">1000</span><span class="o">);</span>
<span class="c1">// 2. 启动定时刷新任务
</span><span class="c1"></span><span class="n">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 3. 计算当前最新位置信息
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mOverScroller</span><span class="o">.</span><span class="na">computeScrollOffset</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 4. 根据最新位置更新 View 状态
</span><span class="c1"></span>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&#34;OverScroller&#34;</span><span class="o">,</span> <span class="s">&#34;x=&#34;</span> <span class="o">+</span> <span class="n">mOverScroller</span><span class="o">.</span><span class="na">getCurrX</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, y=&#34;</span> <span class="o">+</span> <span class="n">mOverScroller</span><span class="o">.</span><span class="na">getCurrY</span><span class="o">());</span>
            <span class="n">invalidate</span><span class="o">();</span>
            <span class="c1">// 5. 判断滚动是否停止，没有停止的话启动下一轮刷新任务
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">mOverScroller</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">postDelayed</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">16</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></td></tr></table>
</div>
</div><p>The above is the minimal logic to start a constantly scrolling and refreshing View (of course a more engineering approach could also put the Runnable logic in View#computeScroll and trigger it via invalidate). <code>fling</code> and <code>springBack</code> are started in the same way, so we won&rsquo;t go into details here.</p>
<h2 id="3-deep-inside-the-overscroller">3. Deep inside the OverScroller</h2>
<p>As you can see in the above code, after starting a scrolling task, the position is computed by calling computeScrollOffset again and again, so let&rsquo;s look at the code implementation</p>
<h3 id="31-startscroll">3.1 startScroll</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OverScroller</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startScroll</span><span class="o">(</span><span class="kt">int</span> <span class="n">startX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startY</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 标记当前模式为 SCROLL_MODE
</span><span class="c1"></span>        <span class="n">mMode</span> <span class="o">=</span> <span class="n">SCROLL_MODE</span><span class="o">;</span>
        <span class="c1">// mScrollerX 和 mScrollerY 均是 SplineOverScroller 实例
</span><span class="c1"></span>        <span class="c1">// OverScroller 把参数分别传给 mScrollerX 和 mScrollerY，在里面做真正的计算
</span><span class="c1"></span>        <span class="n">mScrollerX</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">startX</span><span class="o">,</span> <span class="n">dx</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
        <span class="n">mScrollerY</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">startY</span><span class="o">,</span> <span class="n">dy</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplineOverScroller</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">startScroll</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">distance</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mFinished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// 标记起始点和结束点
</span><span class="c1"></span>            <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
            <span class="n">mFinal</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">distance</span><span class="o">;</span>

            <span class="c1">// 标记起始时间和动画时长
</span><span class="c1"></span>            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
            <span class="n">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>

            <span class="c1">// Unused
</span><span class="c1"></span>            <span class="n">mDeceleration</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
            <span class="n">mVelocity</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The logic of startScroll is very simple, it just marks the start position, end position, start time and animation duration according to the parameters, it doesn&rsquo;t involve the position calculation (because the position calculation is placed in the computeScrollOffset).</p>
<p>And look at the logic of computeScrollOffset called at regular intervals.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OverScroller</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">OverScroller</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Interpolator</span> <span class="n">interpolator</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flywheel</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 初始化插值器
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">interpolator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mInterpolator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scroller</span><span class="o">.</span><span class="na">ViscousFluidInterpolator</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">mInterpolator</span> <span class="o">=</span> <span class="n">interpolator</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">computeScrollOffset</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">mMode</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">SCROLL_MODE</span><span class="o">:</span>
                <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
                <span class="c1">// 计算已过去的时间
</span><span class="c1"></span>                <span class="kd">final</span> <span class="kt">long</span> <span class="n">elapsedTime</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">mScrollerX</span><span class="o">.</span><span class="na">mStartTime</span><span class="o">;</span>

                <span class="kd">final</span> <span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">mScrollerX</span><span class="o">.</span><span class="na">mDuration</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">elapsedTime</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 用插值器对时间比做一个变换
</span><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">q</span> <span class="o">=</span> <span class="n">mInterpolator</span><span class="o">.</span><span class="na">getInterpolation</span><span class="o">(</span><span class="n">elapsedTime</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">duration</span><span class="o">);</span>
                    <span class="n">mScrollerX</span><span class="o">.</span><span class="na">updateScroll</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                    <span class="n">mScrollerY</span><span class="o">.</span><span class="na">updateScroll</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">abortAnimation</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplineOverScroller</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">updateScroll</span><span class="o">(</span><span class="kt">float</span> <span class="n">q</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 根据比值计算最新位置
</span><span class="c1"></span>            <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">q</span> <span class="o">*</span> <span class="o">(</span><span class="n">mFinal</span> <span class="o">-</span> <span class="n">mStart</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Logic is also very simple, there is really not much to say &hellip;&hellip; is to map the interpolator curve to the displacement curve, the duration if not specified, the default is 250ms, the interpolator needs to be passed through the construction method, if not specified, the system will specify a <code>ViscousFluidInterpolator</code> by default, the following is the curve of this interpolator, you can see is a first slow then fast then slow animation.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/3168997260e14a0c89042cae6d0155a3.png" alt="ViscousFluidInterpolator"></p>
<h3 id="32-fling--springback">3.2 fling &amp; springBack</h3>
<p>Why do <code>fling</code> and <code>springBack</code> need to be mentioned together? Because the animation of <code>fling</code> is more complex, and <code>springBack</code> is sort of a sub-state of <code>fling</code>, consider the following case.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/bfc14471f6e84623aefa723fdeca05ce.gif" alt="sobyte"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/41629ef35d904257a52a2ded8369e515.png" alt="sobyte"></p>
<p>We see that when fling is executed at a relatively large speed, it is very easy to hit the boundary, and fling will execute the boundary crossing and bounce back according to the preset boundary value, which can decompose the whole animation process into three stages.</p>
<ul>
<li>SPLINE: that is, the normal sliding stage</li>
<li>BALLISTIC: The deceleration phase of boundary crossing</li>
<li>CUBIC: the rebound phase</li>
</ul>
<p>The animation executed after <code>springBack</code> is actually the <code>CUBIC</code> phase of <code>fling</code>, so we simply put it together.</p>
<p>The naming is actually quite interesting, these three are sample curve, ballistic curve, and three times curve, from the naming, we can roughly infer that the &ldquo;time-position&rdquo; curves used in the three phases are different.</p>
<p>Of course, a lot of Android controls will cancel the boundary rebound effect when flinging, and display an <code>EdgeEffect</code> instead. In other words, after executing the SPLINE stage animation, you can&rsquo;t see <code>BALLISTIC</code> and <code>CUBIC</code>, you can only see an edge glow effect, and when the list reaches the top/bottom, it often stops there at once~.</p>
<h4 id="321-spline">3.2.1 SPLINE</h4>
<p>First, let&rsquo;s look at the entry function that starts fling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OverScroller</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fling</span><span class="o">(</span><span class="kt">int</span> <span class="n">startX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startY</span><span class="o">,</span> <span class="kt">int</span> <span class="n">velocityX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">velocityY</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">minX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">minY</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxY</span><span class="o">,</span> <span class="kt">int</span> <span class="n">overX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">overY</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 标记滚动模式，主要和 startScroll 进行区分
</span><span class="c1"></span>        <span class="n">mMode</span> <span class="o">=</span> <span class="n">FLING_MODE</span><span class="o">;</span>
        <span class="n">mScrollerX</span><span class="o">.</span><span class="na">fling</span><span class="o">(</span><span class="n">startX</span><span class="o">,</span> <span class="n">velocityX</span><span class="o">,</span> <span class="n">minX</span><span class="o">,</span> <span class="n">maxX</span><span class="o">,</span> <span class="n">overX</span><span class="o">);</span>
        <span class="n">mScrollerY</span><span class="o">.</span><span class="na">fling</span><span class="o">(</span><span class="n">startY</span><span class="o">,</span> <span class="n">velocityY</span><span class="o">,</span> <span class="n">minY</span><span class="o">,</span> <span class="n">maxY</span><span class="o">,</span> <span class="n">overY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplineOverScroller</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">fling</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">velocity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">min</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">,</span> <span class="kt">int</span> <span class="n">over</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mOver</span> <span class="o">=</span> <span class="n">over</span><span class="o">;</span>
            <span class="n">mFinished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">mCurrVelocity</span> <span class="o">=</span> <span class="n">mVelocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">;</span>
            <span class="n">mDuration</span> <span class="o">=</span> <span class="n">mSplineDuration</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">mStartTime</span> <span class="o">=</span> <span class="n">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
            <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>

            <span class="n">mState</span> <span class="o">=</span> <span class="n">SPLINE</span><span class="o">;</span>
            <span class="kt">double</span> <span class="n">totalDistance</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">0</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">velocity</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 根据速度计算滑动时长
</span><span class="c1"></span>                <span class="n">mDuration</span> <span class="o">=</span> <span class="n">mSplineDuration</span> <span class="o">=</span> <span class="n">getSplineFlingDuration</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span>
                <span class="c1">// 根据速度计算滑动距离
</span><span class="c1"></span>                <span class="n">totalDistance</span> <span class="o">=</span> <span class="n">getSplineFlingDistance</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">mSplineDistance</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">totalDistance</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">velocity</span><span class="o">));</span>
            <span class="n">mFinal</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">mSplineDistance</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mFinal</span> <span class="o">&lt;</span> <span class="n">min</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 如果计算出的滑动距离超过 min 边界，则重新计算到达 min 边界时的滑动时长
</span><span class="c1"></span>                <span class="n">adjustDuration</span><span class="o">(</span><span class="n">mStart</span><span class="o">,</span> <span class="n">mFinal</span><span class="o">,</span> <span class="n">min</span><span class="o">);</span>
                <span class="n">mFinal</span> <span class="o">=</span> <span class="n">min</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">mFinal</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 如果计算出的滑动距离超过 max 边界，则重新计算到达 max 边界时的滑动时长
</span><span class="c1"></span>                <span class="n">adjustDuration</span><span class="o">(</span><span class="n">mStart</span><span class="o">,</span> <span class="n">mFinal</span><span class="o">,</span> <span class="n">max</span><span class="o">);</span>
                <span class="n">mFinal</span> <span class="o">=</span> <span class="n">max</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">double</span> <span class="nf">getSplineDeceleration</span><span class="o">(</span><span class="kt">int</span> <span class="n">velocity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">INFLEXION</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">velocity</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">mFlingFriction</span> <span class="o">*</span> <span class="n">mPhysicalCoeff</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * 计算滑动距离
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="nf">getSplineFlingDistance</span><span class="o">(</span><span class="kt">int</span> <span class="n">velocity</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">getSplineDeceleration</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">decelMinusOne</span> <span class="o">=</span> <span class="n">DECELERATION_RATE</span> <span class="o">-</span> <span class="n">1</span><span class="o">.</span><span class="na">0</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">mFlingFriction</span> <span class="o">*</span> <span class="n">mPhysicalCoeff</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">exp</span><span class="o">(</span><span class="n">DECELERATION_RATE</span> <span class="o">/</span> <span class="n">decelMinusOne</span> <span class="o">*</span> <span class="n">l</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * 计算滑动时长
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getSplineFlingDuration</span><span class="o">(</span><span class="kt">int</span> <span class="n">velocity</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">getSplineDeceleration</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span>
            <span class="kd">final</span> <span class="kt">double</span> <span class="n">decelMinusOne</span> <span class="o">=</span> <span class="n">DECELERATION_RATE</span> <span class="o">-</span> <span class="n">1</span><span class="o">.</span><span class="na">0</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">1000</span><span class="o">.</span><span class="na">0</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">exp</span><span class="o">(</span><span class="n">l</span> <span class="o">/</span> <span class="n">decelMinusOne</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/cc787438578a44fb934d46675e9e24a2.png" alt="sobyte"></p>
<p>Before looking at the code, let&rsquo;s take a look at the above diagram, which illustrates the meaning of start, min, max, over, etc. Here is a brief explanation</p>
<ul>
<li>The final stopping position after flinging must be between min and max</li>
<li>The BALLISTIC crossing phase cannot exceed the over position, i.e., over is the maximum crossing distance.</li>
<li>start can be located outside the [min, max] interval, if it is outside the interval, a decision will be made based on the direction and size of the velocity, there will be three cases as follows.
<ul>
<li>velocity pointing out of bounds: execute BALLISTIC to cross the bounds first and then execute CUBIC to bounce back to the bounds</li>
<li>Velocity pointing inside the boundary: If the velocity is enough to cross the boundary, the normal process will be executed, and SPLINE will be executed first.</li>
<li>Speed pointing inside the boundary: if the speed is not enough to cross the boundary, execute CUBIC directly back to the boundary</li>
</ul>
</li>
</ul>
<p>The main functions of the fling function are</p>
<ul>
<li>Calculate the duration and distance of the slide based on the starting speed.</li>
<li>If the final point is outside the [min, max] interval, recalculate the time to reach the boundary.</li>
<li>Mark the current state as SPLINE state</li>
</ul>
<p>The equations for the sliding distance and duration can be calculated by considering mPhysicalCoeff as a constant as well, listing the <strong>time-velocity equation</strong> and the image.</p>
<p>$$y=1000\cdot \exp \left( \frac{\ln \left( \frac{0.35x}{2140.47} \right)}{1.358} \right)$$</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/e25f887438d54014bb1a73b556446f40.png" alt="sobyte"></p>
<p>Look again at the <strong>distance-velocity equation</strong>.</p>
<p>$$y=2140.47\cdot \exp \left( 1.74\cdot \ln \left( \frac{0.35\cdot x}{2140.47} \right) \right)$$</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/cb14b66bcd6b4ffda9f7d15a303ee8e5.png" alt="sobyte"></p>
<p>As you can see, both distance and duration increase with speed, but the growth rate of duration converges at a later stage to ensure that the animation duration is not too long.</p>
<p>Another point to note is that the ratio of $ \frac{Distance} {Duration} $ is a linear function, that is, the larger the initial velocity, the larger the average velocity, and the two are growing linearly.</p>
<p>$$y=\frac{2140.47\cdot \exp \left( 1.74\cdot \ln \left( \frac{0.35\cdot x}{2140.47} \right) \right)}{1000\cdot \exp \left( \frac{\ln \left( \frac{0.35x}{2140.47} \right)}{1.358} \right)}$$</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/f3e8938af6c543a5a686951755edbaea.png" alt="sobyte"></p>
<p>But to be honest, at present I temporarily did not understand the physical meaning of these two formulas, there is an understanding of the big brother please tell ~ Is the use of the logarithmic function of convergence to determine the length of the formula, and then set the average speed of linear growth, after deducing the distance formula?</p>
<p>At present, only the total distance and length of the slide are determined, so how is the intermediate process to update the position.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OverScroller</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">computeScrollOffset</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">mMode</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">FLING_MODE</span><span class="o">:</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">mFinished</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 更新当前阶段的速度和位置
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">update</span><span class="o">())</span> <span class="o">{</span>
                        <span class="c1">// 判断是否需要进入下一动画阶段
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">continueWhenFinished</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">mScrollerY</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplineOverScroller</span> <span class="o">{</span>

        <span class="kt">boolean</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">mStartTime</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">mDuration</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 根据动画时长判断当前阶段的动画是否应该结束
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">currentTime</span> <span class="o">&gt;</span> <span class="n">mDuration</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kt">double</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">0</span><span class="o">;</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">SPLINE</span><span class="o">:</span> <span class="o">{</span>
                    <span class="c1">// 把当前时间映射到 100 个采样点的曲线之中
</span><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">currentTime</span> <span class="o">/</span> <span class="n">mSplineDuration</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">NB_SAMPLES</span> <span class="o">*</span> <span class="n">t</span><span class="o">);</span>
                    <span class="kt">float</span> <span class="n">distanceCoef</span> <span class="o">=</span> <span class="n">1</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
                    <span class="kt">float</span> <span class="n">velocityCoef</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">f</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">NB_SAMPLES</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="kt">float</span> <span class="n">t_inf</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">index</span> <span class="o">/</span> <span class="n">NB_SAMPLES</span><span class="o">;</span>
                        <span class="kd">final</span> <span class="kt">float</span> <span class="n">t_sup</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span> <span class="o">/</span> <span class="n">NB_SAMPLES</span><span class="o">;</span>
                        <span class="kd">final</span> <span class="kt">float</span> <span class="n">d_inf</span> <span class="o">=</span> <span class="n">SPLINE_POSITION</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
                        <span class="kd">final</span> <span class="kt">float</span> <span class="n">d_sup</span> <span class="o">=</span> <span class="n">SPLINE_POSITION</span><span class="o">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">1</span><span class="o">];</span>
                        <span class="c1">// 根据映射时间计算样条曲线的当前的斜率，即速度
</span><span class="c1"></span>                        <span class="n">velocityCoef</span> <span class="o">=</span> <span class="o">(</span><span class="n">d_sup</span> <span class="o">-</span> <span class="n">d_inf</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">t_sup</span> <span class="o">-</span> <span class="n">t_inf</span><span class="o">);</span>
                        <span class="c1">// 根据映射时间计算样条曲线的高度，即距离
</span><span class="c1"></span>                        <span class="n">distanceCoef</span> <span class="o">=</span> <span class="n">d_inf</span> <span class="o">+</span> <span class="o">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_inf</span><span class="o">)</span> <span class="o">*</span> <span class="n">velocityCoef</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// 把样条距离映射回真正的距离
</span><span class="c1"></span>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">distanceCoef</span> <span class="o">*</span> <span class="n">mSplineDistance</span><span class="o">;</span>
                    <span class="c1">// 把样条速递易映射回真正的速度
</span><span class="c1"></span>                    <span class="n">mCurrVelocity</span> <span class="o">=</span> <span class="n">velocityCoef</span> <span class="o">*</span> <span class="n">mSplineDistance</span> <span class="o">/</span> <span class="n">mSplineDuration</span> <span class="o">*</span> <span class="n">1000</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">case</span> <span class="n">BALLISTIC</span><span class="o">:</span> <span class="o">{</span>
                    <span class="c1">// 根据匀减速运动公式计算位置和速度
</span><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">currentTime</span> <span class="o">/</span> <span class="n">1000</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
                    <span class="n">mCurrVelocity</span> <span class="o">=</span> <span class="n">mVelocity</span> <span class="o">+</span> <span class="n">mDeceleration</span> <span class="o">*</span> <span class="n">t</span><span class="o">;</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">mVelocity</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">mDeceleration</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">2</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">case</span> <span class="n">CUBIC</span><span class="o">:</span> <span class="o">{</span>
                    <span class="c1">// 根据一个自定义的三次曲线计算位置和速度
</span><span class="c1"></span>                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">currentTime</span><span class="o">)</span> <span class="o">/</span> <span class="n">mDuration</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="o">;</span>
                    <span class="kd">final</span> <span class="kt">float</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">mVelocity</span><span class="o">);</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">mOver</span> <span class="o">*</span> <span class="o">(</span><span class="n">3</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">2</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t2</span><span class="o">);</span>
                    <span class="n">mCurrVelocity</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">mOver</span> <span class="o">*</span> <span class="n">6</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="o">(-</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t2</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">distance</span><span class="o">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="nf">continueWhenFinished</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">mState</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">SPLINE</span><span class="o">:</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">mDuration</span> <span class="o">&lt;</span> <span class="n">mSplineDuration</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// 如果时长小于 mSplineDuration ，说明 mDuration 被重新计算过，即上面说到的到达边界的时间。那么我们需要进入越界状态
</span><span class="c1"></span>                        <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">=</span> <span class="n">mFinal</span><span class="o">;</span>
                        <span class="n">mVelocity</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">mCurrVelocity</span><span class="o">;</span>
                        <span class="n">mDeceleration</span> <span class="o">=</span> <span class="n">getDeceleration</span><span class="o">(</span><span class="n">mVelocity</span><span class="o">);</span>
                        <span class="n">mStartTime</span> <span class="o">+=</span> <span class="n">mDuration</span><span class="o">;</span>
                        <span class="n">onEdgeReached</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="c1">// SPLINE 停止时未到达边界，结束动画
</span><span class="c1"></span>                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">BALLISTIC</span><span class="o">:</span>
                    <span class="c1">// 越界状态结束，进入回弹阶段
</span><span class="c1"></span>                    <span class="n">mStartTime</span> <span class="o">+=</span> <span class="n">mDuration</span><span class="o">;</span>
                    <span class="n">startSpringback</span><span class="o">(</span><span class="n">mFinal</span><span class="o">,</span> <span class="n">mStart</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">CUBIC</span><span class="o">:</span>
                    <span class="c1">// 回弹阶段结束，结束动画
</span><span class="c1"></span>                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">update</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The position and velocity of the <code>SPLINE</code> stage are determined entirely by the preset <code>SPLINE_POSITION</code> spline curve, which is an array of size 101 that stores the coordinate values of a curve sampled 100 times on average, initialized as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NB_SAMPLES</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">SPLINE_POSITION</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">NB_SAMPLES</span> <span class="o">+</span> <span class="n">1</span><span class="o">];</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">SPLINE_TIME</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">NB_SAMPLES</span> <span class="o">+</span> <span class="n">1</span><span class="o">];</span>

<span class="kd">static</span> <span class="o">{</span>
    <span class="kt">float</span> <span class="n">x_min</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
    <span class="kt">float</span> <span class="n">y_min</span> <span class="o">=</span> <span class="n">0</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NB_SAMPLES</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">i</span> <span class="o">/</span> <span class="n">NB_SAMPLES</span><span class="o">;</span>

        <span class="kt">float</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">1</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="n">tx</span><span class="o">,</span> <span class="n">coef</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_min</span> <span class="o">+</span> <span class="o">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="o">)</span> <span class="o">/</span> <span class="n">2</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">3</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="o">(</span><span class="n">1</span><span class="o">.</span><span class="na">0f</span> <span class="o">-</span> <span class="n">x</span><span class="o">);</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">coef</span> <span class="o">*</span> <span class="o">((</span><span class="n">1</span><span class="o">.</span><span class="na">0f</span> <span class="o">-</span> <span class="n">x</span><span class="o">)</span> <span class="o">*</span> <span class="n">P1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">P2</span><span class="o">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">tx</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">1E</span><span class="o">-</span><span class="n">5</span><span class="o">)</span> <span class="k">break</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tx</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="o">)</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
            <span class="k">else</span> <span class="n">x_min</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">SPLINE_POSITION</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">coef</span> <span class="o">*</span> <span class="o">((</span><span class="n">1</span><span class="o">.</span><span class="na">0f</span> <span class="o">-</span> <span class="n">x</span><span class="o">)</span> <span class="o">*</span> <span class="n">START_TENSION</span> <span class="o">+</span> <span class="n">x</span><span class="o">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">SPLINE_POSITION</span><span class="o">[</span><span class="n">NB_SAMPLES</span><span class="o">]</span> <span class="o">=</span> <span class="n">SPLINE_TIME</span><span class="o">[</span><span class="n">NB_SAMPLES</span><span class="o">]</span> <span class="o">=</span> <span class="n">1</span><span class="o">.</span><span class="na">0f</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s hard to imagine what it looks like by looking at the code, so let&rsquo;s look at the image directly.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/9bbb04b75a7248eda1eeb3d8d6234f68.png" alt="sobyte"></p>
<p>That is, SPLINE and startScroll are much like each other in that the position curve is determined by a preset curve that maps the preset curve to the true distance, except that instead of using an interpolator curve, SPLINE uses a slow-stop spline curve.</p>
<h4 id="322-ballistic">3.2.2 BALLISTIC</h4>
<p>At the end of the SPLINE phase, the next phase is continued by continueWhenFinished: the boundary crossing phase (provided that the boundary has been reached). The principle of the boundary crossing phase is relatively simple, it is a period of uniform deceleration (until the velocity drops to 0), and the default acceleration a is -2000.0f. The initialization logic to enter the BALLISTIC phase is in <code>onEdgeReached</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">onEdgeReached</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">float</span> <span class="n">velocitySquared</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">mVelocity</span> <span class="o">*</span> <span class="n">mVelocity</span><span class="o">;</span>
    <span class="c1">// 计算速度降为 0 时，运动的距离
</span><span class="c1"></span>    <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">velocitySquared</span> <span class="o">/</span> <span class="o">(</span><span class="n">2</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">mDeceleration</span><span class="o">));</span>
    <span class="kd">final</span> <span class="kt">float</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">mVelocity</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">mOver</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果距离大于最大距离 over，则重新计算加速度，使运动距离恰好为 over
</span><span class="c1"></span>            <span class="n">mDeceleration</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">velocitySquared</span> <span class="o">/</span> <span class="o">(</span><span class="n">2</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">mOver</span><span class="o">);</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">mOver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">mOver</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">distance</span><span class="o">;</span>
    <span class="c1">// 标记动画阶段
</span><span class="c1"></span>    <span class="n">mState</span> <span class="o">=</span> <span class="n">BALLISTIC</span><span class="o">;</span>
    <span class="n">mFinal</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">mVelocity</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">distance</span> <span class="o">:</span> <span class="o">-</span><span class="n">distance</span><span class="o">);</span>
    <span class="c1">// 根据初速度和加速度计算总时长
</span><span class="c1"></span>    <span class="n">mDuration</span> <span class="o">=</span> <span class="o">-</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">1000</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">mVelocity</span> <span class="o">/</span> <span class="n">mDeceleration</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Speed.</p>
<p>$$v_t=v_0+at$$</p>
<p>Distance.</p>
<p>$$s_t=v_0t + \frac{at^2} {2}$$</p>
<p>There is a small complaint here, the acceleration is fixed at 2000, which is too small, that is, if the crossing speed is 10000, then it takes 5s for the speed to drop to 0. A 5s animation you all know how long it means, right?</p>
<h4 id="323-cubic">3.2.3 CUBIC</h4>
<p>As we know from the previous section, the speed is reduced to 0 at the end of the BALLISTIC phase, and we finally come to the last section, where <code>startSpringback</code> is called from continueWhenFinished as the initialization of CUBIC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startSpringback</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">,</span> <span class="kt">int</span> <span class="n">velocity</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mFinished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="c1">// 标记动画阶段
</span><span class="c1"></span>    <span class="n">mState</span> <span class="o">=</span> <span class="n">CUBIC</span><span class="o">;</span>
    <span class="n">mCurrentPosition</span> <span class="o">=</span> <span class="n">mStart</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
    <span class="n">mFinal</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
    <span class="c1">// CUBIC 阶段运动总距离
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">end</span><span class="o">;</span>
    <span class="n">mDeceleration</span> <span class="o">=</span> <span class="n">getDeceleration</span><span class="o">(</span><span class="n">delta</span><span class="o">);</span>
    <span class="n">mVelocity</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="o">;</span> <span class="c1">// only sign is used
</span><span class="c1"></span>    <span class="n">mOver</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">delta</span><span class="o">);</span>
    <span class="c1">// 计算此阶段的动画时长
</span><span class="c1"></span>    <span class="n">mDuration</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">1000</span><span class="o">.</span><span class="na">0</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(-</span><span class="n">2</span><span class="o">.</span><span class="na">0</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">mDeceleration</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The time calculation still uses the logic of uniformly accelerated linear motion, imagining a section with initial velocity 0, acceleration a, and distance delta.</p>
<p>$$delta=\frac{(v_0 + v_t)} {2} t$$</p>
<p>Then.</p>
<p>$$ v_0=0，v_t=at $，那么 $ delta=\frac{at^2} {2} $，$ t=\sqrt{ \frac{2*delta} {a}}$$</p>
<p>In the <code>update</code> method, the core logic of updating CUBIC is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">case</span> <span class="n">CUBIC</span><span class="o">:</span> <span class="o">{</span>
    <span class="c1">// 根据一个自定义的三次曲线计算位置和速度
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">currentTime</span><span class="o">)</span> <span class="o">/</span> <span class="n">mDuration</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">float</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">float</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">signum</span><span class="o">(</span><span class="n">mVelocity</span><span class="o">);</span>
    <span class="c1">// 计算运动位置
</span><span class="c1"></span>    <span class="n">distance</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">mOver</span> <span class="o">*</span> <span class="o">(</span><span class="n">3</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">2</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t2</span><span class="o">);</span>
    <span class="c1">// 计算速度，对距离公式求导即可
</span><span class="c1"></span>    <span class="n">mCurrVelocity</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">mOver</span> <span class="o">*</span> <span class="n">6</span><span class="o">.</span><span class="na">0f</span> <span class="o">*</span> <span class="o">(-</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t2</span><span class="o">);</span>
    <span class="k">break</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The core logic is this <code>3.0f * t2 - 2.0f * t * t2</code> , which is actually a more commonly used cubic curve.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/15/bab4dfbcb8a448ffa22463db5d801e9e.png" alt="sobyte"></p>
<p>In the interval [0, 1], it is a slow-in and slow-out curve. At this point, the motion law of CUBIC is also clear, which maps the time to the interval [0, 1] at a fixed time, and then maps the y-coordinate to the actual position.</p>
<h2 id="4-summary">4. Summary</h2>
<p>So far, we have finally looked at the curves of <code>startScroll</code> and <code>fling</code> stages, as for <code>springBack</code> and some other cases, they are more or less the same, so we won&rsquo;t go into details.</p>
<p>Many times OverScroller just uses a fixed curve to map the real curve, such as <code>startScroll</code>, <code>SPLINE</code> and <code>CUBIC</code>, so if you want to change the effect, is it possible to modify the shape of the curve? But can a curve really perform better at different speeds? Maybe we have to have a lot of practice and experimentation to make a section to make the user comfortable sliding.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/android/">android</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/android-12-letterbox/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Android 12 - Letterbox mode</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/netty-startup-process/">
            <span class="next-text nav-default">Netty startup process analysis</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
