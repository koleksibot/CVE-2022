<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to quickly locate Flutter APP memory leaks - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="When an APP grows with business, useless features pile up, the team of developers grows, and the code expands in a big way, despite a series of process restraints such as manual review, code specification, static lint check and so on, it cannot stop the collapsing universe from evolving into an unfathomable black hole. Among them, there is no greater headache than &amp;ldquo;memory leak&amp;rdquo;. What is a memory leak? It&amp;rsquo;s" /><meta name="keywords" content="flutter, Memory Leaks" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/how-to-detecting-memory-leaks-in-flutter-app/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to quickly locate Flutter APP memory leaks" />
<meta property="og:description" content="When an APP grows with business, useless features pile up, the team of developers grows, and the code expands in a big way, despite a series of process restraints such as manual review, code specification, static lint check and so on, it cannot stop the collapsing universe from evolving into an unfathomable black hole. Among them, there is no greater headache than &ldquo;memory leak&rdquo;. What is a memory leak? It&rsquo;s" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/how-to-detecting-memory-leaks-in-flutter-app/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-28T10:28:12+08:00" />
<meta property="article:modified_time" content="2022-02-28T10:28:12+08:00" />

<meta itemprop="name" content="How to quickly locate Flutter APP memory leaks">
<meta itemprop="description" content="When an APP grows with business, useless features pile up, the team of developers grows, and the code expands in a big way, despite a series of process restraints such as manual review, code specification, static lint check and so on, it cannot stop the collapsing universe from evolving into an unfathomable black hole. Among them, there is no greater headache than &ldquo;memory leak&rdquo;. What is a memory leak? It&rsquo;s"><meta itemprop="datePublished" content="2022-02-28T10:28:12+08:00" />
<meta itemprop="dateModified" content="2022-02-28T10:28:12+08:00" />
<meta itemprop="wordCount" content="1926">
<meta itemprop="keywords" content="flutter," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to quickly locate Flutter APP memory leaks"/>
<meta name="twitter:description" content="When an APP grows with business, useless features pile up, the team of developers grows, and the code expands in a big way, despite a series of process restraints such as manual review, code specification, static lint check and so on, it cannot stop the collapsing universe from evolving into an unfathomable black hole. Among them, there is no greater headache than &ldquo;memory leak&rdquo;. What is a memory leak? It&rsquo;s"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to quickly locate Flutter APP memory leaks</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-28 10:28:12 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1926 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>When an APP grows with business, <del>useless</del> features pile up, the team of developers grows, and the code expands in a big way, despite a series of process restraints such as manual review, code specification, static lint check and so on, it cannot stop the collapsing universe from evolving into an unfathomable black hole. Among them, there is no greater headache than &ldquo;<strong>memory leak</strong>&rdquo;.</p>
<p>What is a <strong>memory leak</strong>? It&rsquo;s so common yet so insignificant that you and I can easily write a piece of code to make an object invisible to the <strong>garbage collector</strong> (GC).</p>
<p>For example, the following paragraph.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">WidgetA</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="n">_WidgetAState</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_WidgetAState</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">_WidgetAState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">WidgetA</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">GestureDetector</span><span class="p">(</span>
      <span class="nl">onTap:</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="n">r</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">fetchResult</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nl">child:</span> <span class="p">...</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Can you find the object that might be leaking while reading through this code?</p>
<p>Yes, <code>context</code> may <strong>leak for a short time</strong>.
But, thanks to Dart&rsquo;s aggressive and efficient GC strategy, this leak is a negligible and minor part of the <strong>memory leak</strong> problem. (Extended reading: <a href="https://medium.com/flutter/flutter-dont-fear-the-garbage-collector-">Flutter: Don&rsquo;t Fear the Garbage Collector</a> d69b3ff1ca30))</p>
<p>Another example is this piece of code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">_WidgetAState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">WidgetA</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
    <span class="n">Provider</span><span class="p">.</span><span class="n">of</span><span class="o">&lt;</span><span class="n">AuthStateBloc</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">stream</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="n">onAuthStateChanged</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">onAuthStateChanged</span><span class="p">(</span><span class="n">AuthState</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can easily see from your extensive Flutter development experience, the return object <code>StreamSubscription</code> of <code>stream.listen</code> is not properly <code>canceled</code>, causing <code>_WidgetAState</code> and its <code>Element</code> (context) to probably <strong>leak</strong> and may not be recovered by GC until the <code>Provider&lt;AuthStateBloc&gt;</code> of the ancestor node is unloaded.</p>
<p>So back to the title, is there a tool that can programmatically find <strong>memory leaks</strong>?</p>
<p>The first question to address is how to find <strong>memory leaks</strong>?</p>
<p>Is it possible to track an object <strong>code-logically discarded</strong> without affecting the reference count and see if it is eventually collected by the garbage collector?</p>
<p>If you&rsquo;ve written Java, you&rsquo;ll immediately think of <code>WeakReference</code>.
There is a similar one in Dart, except it implements Java&rsquo;s <a href="https://docs.oracle.com/javase/8/docs/api/java/util/WeakHashMap.html"><code>WeakHashMap</code></a> : <a href="https://api.flutter.dev/flutter/dart-core/Expando-class.html"><code>Expando</code></a>. It is similar to a normal Map in use, but has a feature that it does not increase the reference count of the key property, i.e. it does not prevent the key object from being GC&rsquo;d.</p>
<blockquote>
<p>An Expando does not hold on to the added property value after an object becomes inaccessible.</p>
</blockquote>
<p>Implement a <code>DeadObjectWatcher</code> with <code>Expando</code> to keep track of objects that theoretically need to be reclaimed by GC:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">DeadObjectWatcher</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="n">DeadObjectWatcher</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">DeadObjectWatcher</span><span class="p">.</span><span class="n">_</span><span class="p">();</span>

  <span class="n">DeadObjectWatcher</span><span class="p">.</span><span class="n">_</span><span class="p">();</span>
  <span class="kd">final</span> <span class="n">Expando</span><span class="o">&lt;</span><span class="kt">Object</span><span class="o">&gt;</span> <span class="n">weakRef</span> <span class="o">=</span> <span class="n">Expando</span><span class="p">(</span><span class="s1">&#39;weakreferences&#39;</span><span class="p">);</span>

  <span class="kt">void</span> <span class="n">watch</span><span class="p">(</span><span class="kt">Object</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">instance</span><span class="p">.</span><span class="n">weakRef</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">hashCode</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>DeadObjectWatcher</code> is a single instance used as a globally surviving object to keep track of the target object, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="n">mixin</span> <span class="n">LeakStateMixin</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span><span class="o">&gt;</span> <span class="n">on</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="kt">void</span> <span class="n">dispose</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// State 已经 dispose，它自己和它所属的 Element (context) 应该要被回收
</span><span class="c1"></span>    <span class="n">DeadObjectWatcher</span><span class="p">.</span><span class="n">instance</span>
      <span class="p">..</span><span class="n">watch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">context</span><span class="p">)</span>
      <span class="p">..</span><span class="n">watch</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If you are using <a href="https://pub.dev/packages/flutter_bloc"><code>flutter_bloc</code></a>, then you can register a global <code>BlocObserver</code> that automatically tracks bloc objects, as I did :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">DeadBlocObserver</span> <span class="kd">extends</span> <span class="n">BlocObserver</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="kt">void</span> <span class="n">onClose</span><span class="p">(</span><span class="n">BlocBase</span> <span class="n">bloc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onClose</span><span class="p">(</span><span class="n">bloc</span><span class="p">);</span>
    <span class="c1">// bloc 已经 close，这个对象应该要被回收
</span><span class="c1"></span>    <span class="n">DeadObjectWatcher</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">bloc</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The next question is how to analyze the objects in <code>Expando</code>?</p>
<p>As a senior Flutter developer, you must be using <a href="https://docs.flutter.dev/development/tools/devtools/overview">Dart DevTools</a> every day to analyze memory, Timeline, etc. Actually, this tool essentially communicates with the underlying Dart VM service via <a href="https://github.com/dart-lang/sdk/blob/main/runtime/vm/service/service.md">** Dart VM Service Protocol**</a> to communicate with Flutter&rsquo;s underlying Dart VM service. So it is certainly possible to write a simple memory leak analysis tool through this protocol.</p>
<p>Dart has provided us with a toolkit that implements <strong>Dart VM Service Protocol</strong>: <a href="https://pub.dev/packages/vm_service">vm_service</a>.</p>
<p>ps. Dart DevTools actually uses an extended implementation of the Dart VM Service Protocol: <a href="https://github.com/dart-lang/sdk/blob/master/pkg/">Dart Development Service Protocol</a> dds/dds_protocol.md)</p>
<p>Connect to the <a href="https://github.com/flutter/flutter/pull/41583">Observatory Uri</a> exposed by the Dart VM Service via the <code>vm_service</code> utility, and find the <code>Isolate</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">var</span> <span class="n">observatoryUri</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1:36489/g_8M0xR54Rg=/&#34;</span>
<span class="kd">var</span> <span class="n">wsUri</span> <span class="o">=</span> <span class="n">observatoryUri</span>
      <span class="p">.</span><span class="n">replace</span><span class="p">(</span>
        <span class="nl">scheme:</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span>
        <span class="nl">path:</span> <span class="n">observatoryUri</span><span class="p">.</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="n">toString</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">vmService</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmServiceConnectUri</span><span class="p">(</span><span class="n">wsUri</span><span class="p">)</span>
<span class="kd">var</span> <span class="n">vm</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="o">!</span><span class="p">.</span><span class="n">getVM</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">isolate</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">isolates</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhereOrNull</span><span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;main&#34;</span><span class="p">);</span>
<span class="k">assert</span><span class="p">(</span><span class="n">isolate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">isolateId</span> <span class="o">=</span> <span class="n">isolate</span><span class="o">!</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>It is important to find this isolateId because the object of the static <code>DeadObjectWatcher</code> lives in this <code>Isolate</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="o">&lt;</span><span class="n">Instance</span><span class="o">?&gt;</span> <span class="n">_findDeadObjectWatcher</span><span class="p">(</span><span class="n">VmService</span> <span class="n">vmService</span><span class="p">,</span> <span class="kt">String</span> <span class="n">isolateId</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// https://github.com/dart-lang/sdk/blob/main/runtime/vm/service/service.md#getclassList
</span><span class="c1"></span>    <span class="c1">// 找到名为目标isolate里 DeadObjectWatcher 的类引用
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">classList</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getClassList</span><span class="p">(</span><span class="n">isolateId</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">classRef</span> <span class="o">=</span>
        <span class="n">classList</span><span class="p">.</span><span class="n">classes</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhere</span><span class="p">((</span><span class="n">classRef</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">classRef</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;DeadObjectWatcher&#39;</span><span class="p">);</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">classRef</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
    <span class="c1">// 找到 DeadObjectWatcher 的类对象
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">deadObjectWatcherClass</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="n">classRef</span><span class="o">!</span><span class="p">.</span><span class="n">id</span><span class="o">!</span><span class="p">)</span> <span class="o">as</span> <span class="n">Class</span><span class="p">;</span>
    <span class="c1">// 找到 DeadObjectWatcher 类里的名为 instance 的静态字段
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">instanceFieldRef</span> <span class="o">=</span> <span class="n">deadObjectWatcherClass</span><span class="p">.</span><span class="n">fields</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhere</span><span class="p">((</span><span class="n">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">isStatic</span><span class="o">!</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">);</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">instanceField</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">instanceField</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="n">instanceFieldRef</span><span class="o">!</span><span class="p">.</span><span class="n">id</span><span class="o">!</span><span class="p">)</span> <span class="o">as</span> <span class="n">Field</span><span class="p">;</span>
    <span class="c1">// instance 是个 static field，它的值就是 staticValue，也就是 DeadObjectWatcher 的对象
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">instance</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="o">!</span><span class="p">,</span> <span class="n">instanceField</span><span class="p">.</span><span class="n">staticValue</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">instance</span> <span class="k">is</span> <span class="n">Instance</span> <span class="o">&amp;&amp;</span> <span class="n">instance</span><span class="p">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kNull</span> <span class="o">?</span> <span class="n">instance</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then find the <code>Expando</code> object in the <code>DeadObjectWatcher</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="o">&lt;</span><span class="n">Instance</span><span class="o">?&gt;</span> <span class="n">_findExpando</span><span class="p">(</span><span class="n">VmService</span> <span class="n">vmService</span><span class="p">,</span> <span class="kt">String</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">Instance</span> <span class="n">watcher</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 找到名为 weakRef field 的 value，其为 Expando 对象引用
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">watcher</span><span class="p">.</span><span class="n">fields</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhereOrNull</span><span class="p">((</span><span class="n">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">decl</span><span class="o">?</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;weakRef&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">// 
</span><span class="c1"></span>    <span class="kd">var</span> <span class="n">obj</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">id</span><span class="o">!</span><span class="p">);</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kNull</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>By reading the code <a href="https://github.com/dart-lang/sdk/blob/main/sdk/lib/_internal/vm/lib/expando_patch.dart">dart-sdk/lib/_internal/vm/lib/expando_patch.dart</a>, you can see that the tracked objects are wrapped in <code>_WeakProperty</code> and exist in a list called <code>_data</code>.</p>
<p>Then find this <code>_data</code> to find the object reference being tracked.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">InstanceRef</span><span class="o">&gt;&gt;</span> <span class="n">_findWatchingObjects</span><span class="p">(</span><span class="n">VmService</span> <span class="n">vmService</span><span class="p">,</span> <span class="kt">String</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">Instance</span> <span class="n">expando</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">dataField</span> <span class="o">=</span> <span class="n">expando</span><span class="p">.</span><span class="n">fields</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhereOrNull</span><span class="p">((</span><span class="n">f</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">decl</span><span class="o">?</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_data&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dataField</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
  <span class="kd">final</span> <span class="n">InstanceRef</span> <span class="n">value</span> <span class="o">=</span> <span class="n">dataField</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">_data</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_data</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">_data</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kNull</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
  <span class="c1">// 遍历 List 里的 _WeakProperty 对象
</span><span class="c1"></span>  <span class="n">List</span><span class="o">&lt;</span><span class="n">InstanceRef</span><span class="o">?&gt;</span> <span class="n">refs</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">Future</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span>
    <span class="n">_data</span><span class="p">.</span><span class="n">elements</span><span class="o">!</span>
        <span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kWeakProperty</span><span class="p">)</span>
        <span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">e</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="kd">final</span> <span class="n">instance</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getObject</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
      <span class="c1">// propertyKey 就是被 _WeakProperty 包裹的需要分析的对象
</span><span class="c1"></span>      <span class="n">InstanceRef</span><span class="o">?</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">instance</span><span class="o">?</span><span class="p">.</span><span class="n">propertyKey</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">ref</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kNull</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
    <span class="p">}),</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="n">refs</span><span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">).</span><span class="n">toList</span><span class="p">().</span><span class="n">cast</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Having found the object to be analyzed, the next step is to get the reference path of this object <code>RetainingPath</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="o">&lt;</span><span class="n">RetainingPath</span><span class="o">?&gt;</span> <span class="n">_getRetainPath</span><span class="p">(</span><span class="n">VmService</span> <span class="n">vmService</span><span class="p">,</span> <span class="kt">String</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">InstanceRef</span> <span class="n">ref</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getRetainingPath</span><span class="p">(</span><span class="n">isolateId</span><span class="o">!</span><span class="p">,</span> <span class="n">ref</span><span class="p">.</span><span class="n">id</span><span class="o">!</span><span class="p">,</span> <span class="m">500</span><span class="p">);</span>
  <span class="p">}</span> <span class="n">on</span> <span class="n">SentinelException</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 有可能已经被回收了 ~
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">sentinel</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">SentinelKind</span><span class="p">.</span><span class="n">kCollected</span> <span class="o">||</span> <span class="n">e</span><span class="p">.</span><span class="n">sentinel</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">SentinelKind</span><span class="p">.</span><span class="n">kExpired</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 其它错误
</span><span class="c1"></span>    <span class="n">rethrow</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The fact that the <code>RetainingPath</code> object is found by <code>InstanceRef</code> means that it has not been reclaimed by GC and there is still a reference path from the GC Root node to the target object! That is, the object that is logically supposed to be reclaimed belongs to a memory <strong>leak</strong>!</p>
<p>The <code>elements</code> in the <code>RetainingPath</code> object are the nodes in the reference path <code>RetainingObject</code>. The next task is to analyze each node and find the memory leak.</p>
<p>Analyzing <code>RetainingObject</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">_analyzeRetainingObject</span><span class="p">(</span><span class="n">RetainingObject</span> <span class="n">ele</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 引用路径其中一个节点
</span><span class="c1"></span>  <span class="kd">var</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="n">value</span><span class="o">!</span><span class="p">;</span>
  <span class="kt">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">name</span><span class="o">!</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="k">is</span> <span class="n">InstanceRef</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 函数引用，如匿名函数 &lt;anonymous closure&gt;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InstanceKind</span><span class="p">.</span><span class="n">kClosure</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">?&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref</span><span class="p">.</span><span class="n">closureFunction</span><span class="o">!</span><span class="p">.</span><span class="n">name</span><span class="p">];</span>
      <span class="kd">var</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">closureFunction</span><span class="o">!</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">owner</span> <span class="k">is</span> <span class="n">FuncRef</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">chain</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="n">owner</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">chain</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">reversed</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="k">is</span> <span class="n">FieldRef</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">isStatic</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 这是个全局静态field
</span><span class="c1"></span>      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">${</span><span class="n">ref</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (static)&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="k">is</span> <span class="n">ContextRef</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 匿名函数的 context
</span><span class="c1"></span>    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&lt;Closure Context&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 引用路径节点的父节点 field
</span><span class="c1"></span>  <span class="kd">final</span> <span class="kt">String</span> <span class="n">parentField</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="n">parentField</span> <span class="o">??</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;+ </span><span class="si">$</span><span class="n">name</span><span class="s1">   </span><span class="si">$</span><span class="n">parentField</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, one small detail to note is that finding the reference path of an object tracked in <code>Expando</code> doesn&rsquo;t mean it is necessarily leaking, it could just be that the GC task hasn&rsquo;t had time to execute yet.
So it is better to force the GC to be triggered before analyzing the reference path:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">triggerGC</span><span class="p">(</span><span class="n">VmService</span> <span class="n">vmService</span><span class="p">,</span> <span class="kt">String</span> <span class="n">isolateId</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">allocation</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">getAllocationProfile</span><span class="p">(</span><span class="n">isolateId</span><span class="p">,</span> <span class="nl">gc:</span> <span class="kc">true</span><span class="p">);</span>
  <span class="kd">var</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">allocation</span><span class="p">.</span><span class="n">memoryUsage</span><span class="o">!</span><span class="p">;</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;Memory Usage:</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="s1">&#39;  externalUsage: </span><span class="si">${</span><span class="n">usage</span><span class="p">.</span><span class="n">externalUsage</span><span class="o">!</span> <span class="o">&gt;&gt;</span> <span class="m">20</span><span class="si">}</span><span class="s1">MB</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="s1">&#39;  heapCapacity: </span><span class="si">${</span><span class="n">usage</span><span class="p">.</span><span class="n">heapCapacity</span><span class="o">!</span> <span class="o">&gt;&gt;</span> <span class="m">20</span><span class="si">}</span><span class="s1">MB</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="s1">&#39;  heapUsage: </span><span class="si">${</span><span class="n">usage</span><span class="p">.</span><span class="n">heapUsage</span><span class="o">!</span> <span class="o">&gt;&gt;</span> <span class="m">20</span><span class="si">}</span><span class="s1">MB&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The combination is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">wsUri</span> <span class="o">=</span> <span class="p">...</span>
  <span class="kd">var</span> <span class="n">vmService</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmServiceConnectUri</span><span class="p">(</span><span class="n">wsUri</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">vm</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">vmService</span><span class="o">!</span><span class="p">.</span><span class="n">getVM</span><span class="p">();</span>
  <span class="kd">var</span> <span class="n">isolate</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">isolates</span><span class="o">?</span><span class="p">.</span><span class="n">firstWhereOrNull</span><span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">i</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;main&#34;</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">isolate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
  <span class="kd">var</span> <span class="n">isolateId</span> <span class="o">=</span> <span class="n">isolate</span><span class="o">!</span><span class="p">.</span><span class="n">id</span><span class="o">!</span><span class="p">;</span>

  <span class="kd">var</span> <span class="n">watcher</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">_findDeadObjectWatcher</span><span class="p">(</span><span class="n">vmService</span><span class="o">!</span><span class="p">,</span> <span class="n">isolateId</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">watcher</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
  <span class="kd">var</span> <span class="n">expando</span> <span class="o">=</span> <span class="n">_findExpando</span><span class="p">(</span><span class="n">vmService</span><span class="o">!</span><span class="p">,</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">watcher</span><span class="o">!</span><span class="p">);</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">expando</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
  <span class="kd">var</span> <span class="n">objs</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">_findWatchingObjects</span><span class="p">(</span><span class="n">vmService</span><span class="o">!</span><span class="p">,</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">expando</span><span class="o">!</span><span class="p">);</span>
  <span class="kd">await</span> <span class="n">triggerGC</span><span class="p">(</span><span class="n">vmService</span><span class="o">!</span><span class="p">,</span> <span class="n">isolateId</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">objs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">path</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">_getRetainPath</span><span class="p">(</span><span class="n">vmService</span><span class="o">!</span><span class="p">,</span> <span class="n">isolateId</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">${</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> has been collected!&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">${</span><span class="n">obj</span><span class="p">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> leaks!&#39;</span><span class="p">);</span>
      <span class="n">print</span><span class="p">(</span><span class="s1">&#39;GC ROOT: </span><span class="si">${</span><span class="n">path</span><span class="p">.</span><span class="n">gcRootType</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
      <span class="n">path</span><span class="p">.</span><span class="n">elements</span><span class="o">?</span><span class="p">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">_analyzeRetainingObject</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">await</span> <span class="n">vmService</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Thus, with a simple object tracking class <code>DeadObjectWatcher</code>, and a simple tool to communicate with the target Flutter application&rsquo;s Dart VM Service to get the &ldquo;damn&rdquo; objects tracked by <code>Expando</code>, you can directly analyze whether a given target object is leaking memory without dumping all the memory like a needle in a haystack.</p>
<p>So how do you <strong>automate</strong> a memory leak to locate it? More on that in the next article.</p>
<p>PS. Note that <code>_findWatchingObjects</code> in this article is not available in the Flutter web environment, so you can find out why.
s</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flutter/">flutter</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/inherits-source-code/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Who inherits the code after the death of an open source author?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/flutter-raw-image-provider/">
            <span class="next-text nav-default">Flutter Raw Image Provider</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
