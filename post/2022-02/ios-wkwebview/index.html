<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>iOS WKWebView detailed explanation and JS Bridge synchronization call problem - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="WKWebView is the browser component used to replace UIWebView after iOS 8.0. Compared with UIWebView, WKWebView has higher performance, supports more HTML5 features and has more detailed control. This article briefly introduces the use of UIWebView and the synchronous interaction between JS and native APP. WKWebView 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24" /><meta name="keywords" content="ios, Wkwebview, JS Bridge call back" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/ios-wkwebview/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="iOS WKWebView detailed explanation and JS Bridge synchronization call problem" />
<meta property="og:description" content="WKWebView is the browser component used to replace UIWebView after iOS 8.0. Compared with UIWebView, WKWebView has higher performance, supports more HTML5 features and has more detailed control. This article briefly introduces the use of UIWebView and the synchronous interaction between JS and native APP. WKWebView 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/ios-wkwebview/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-19T12:42:32+08:00" />
<meta property="article:modified_time" content="2022-02-19T12:42:32+08:00" />

<meta itemprop="name" content="iOS WKWebView detailed explanation and JS Bridge synchronization call problem">
<meta itemprop="description" content="WKWebView is the browser component used to replace UIWebView after iOS 8.0. Compared with UIWebView, WKWebView has higher performance, supports more HTML5 features and has more detailed control. This article briefly introduces the use of UIWebView and the synchronous interaction between JS and native APP. WKWebView 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24"><meta itemprop="datePublished" content="2022-02-19T12:42:32+08:00" />
<meta itemprop="dateModified" content="2022-02-19T12:42:32+08:00" />
<meta itemprop="wordCount" content="1932">
<meta itemprop="keywords" content="ios," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS WKWebView detailed explanation and JS Bridge synchronization call problem"/>
<meta name="twitter:description" content="WKWebView is the browser component used to replace UIWebView after iOS 8.0. Compared with UIWebView, WKWebView has higher performance, supports more HTML5 features and has more detailed control. This article briefly introduces the use of UIWebView and the synchronous interaction between JS and native APP. WKWebView 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">iOS WKWebView detailed explanation and JS Bridge synchronization call problem</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-19 12:42:32 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1932 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#wkwebview">WKWebView</a>
          <ul>
            <li><a href="#wkbackforwardlist">WKBackForwardList</a></li>
            <li><a href="#wknavigation">WKNavigation</a></li>
            <li><a href="#wknavigationdelegate">WKNavigationDelegate</a></li>
            <li><a href="#wknavigationaction">WKNavigationAction</a></li>
            <li><a href="#wkframeinfo">WKFrameInfo</a></li>
            <li><a href="#wkwebviewconfiguration">WKWebViewConfiguration</a></li>
            <li><a href="#wkprocesspool">WKProcessPool</a></li>
            <li><a href="#wkusercontentcontroller">WKUserContentController</a></li>
            <li><a href="#wkpreferences">WKPreferences</a></li>
            <li><a href="#wkuidelegate">WKUIDelegate</a></li>
            <li><a href="#wkscriptmessagehandler-and-wkscriptmessagehandlerwithreply">WKScriptMessageHandler and WKScriptMessageHandlerWithReply</a></li>
            <li><a href="#wkcontentworld">WKContentWorld</a></li>
          </ul>
        </li>
        <li><a href="#basic-use-of-wkwebview">Basic use of WKWebView</a>
          <ul>
            <li><a href="#native-app-and-js-interaction">native APP and JS interaction</a></li>
            <li><a href="#wkwebview-and-js-interaction-synchronization-problem">WKWebView and JS interaction synchronization problem</a></li>
            <li><a href="#wkwebview-addscriptmessagehandler-circular-reference">WKWebView addScriptMessageHandler circular reference</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>WKWebView is the browser component used to replace UIWebView after iOS 8.0. Compared with UIWebView, WKWebView has higher performance, supports more HTML5 features and has more detailed control. This article briefly introduces the use of UIWebView and the synchronous interaction between JS and native APP.</p>
<h2 id="wkwebview">WKWebView</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">@interface WKWebView : UIView

//重要属性
@property (nonatomic, readonly, copy) WKWebViewConfiguration *configuration;
@property (nullable, nonatomic, weak) id &lt;WKNavigationDelegate&gt; navigationDelegate;
@property (nullable, nonatomic, weak) id &lt;WKUIDelegate&gt; UIDelegate;
@property (nonatomic, readonly, strong) WKBackForwardList *backForwardList;

@property (nonatomic, readonly, nullable) SecTrustRef serverTrust;

@property (nullable, nonatomic, copy) NSString *customUserAgent;
@property (nonatomic) BOOL allowsLinkPreview;
@property (nonatomic, readonly, strong) UIScrollView *scrollView;
...

//加载方法
- (nullable WKNavigation *)loadRequest:(NSURLRequest *)request;
- (nullable WKNavigation *)loadFileURL:(NSURL *)URL allowingReadAccessToURL:(NSURL *)readAccessURL;
...

- (nullable WKNavigation *)goBack;
- (nullable WKNavigation *)goForward;

- (nullable WKNavigation *)reload;
- (nullable WKNavigation *)reloadFromOrigin;

//类方法
+ (BOOL)handlesURLScheme:(NSString *)urlScheme;

//与JS交互接口
- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;
//下面两个是iOS 14新引入API
- (void)evaluateJavaScript:(NSString *)javaScriptString inFrame:(nullable WKFrameInfo *)frame inContentWorld:(WKContentWorld *)contentWorld completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;
- (void)callAsyncJavaScript:(NSString *)functionBody arguments:(nullable NSDictionary&lt;NSString *, id&gt; *)arguments inFrame:(nullable WKFrameInfo *)frame inContentWorld:(WKContentWorld *)contentWorld completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler;

@end
</code></pre></td></tr></table>
</div>
</div><h3 id="wkbackforwardlist">WKBackForwardList</h3>
<p>History of visited web pages.</p>
<h3 id="wknavigation">WKNavigation</h3>
<p>WKNavigation object can be used to understand the loading progress of a web page. A WKNavigation object will be returned when the page is loaded by methods such as loadRequest, goBack, etc. The following methods of WKNavigationDelegate proxy can be used to know the loading status of the page.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">//开始加载
- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(WKNavigation *)navigation;
//加载完成
- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation;
//加载失败
- (void)webView:(WKWebView *)webView didFailProvisionalNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)error
- (void)webView:(WKWebView *)webView didFailNavigation:(null_unspecified WKNavigation *)navigation withError:(NSError *)error;
</code></pre></td></tr></table>
</div>
</div><h3 id="wknavigationdelegate">WKNavigationDelegate</h3>
<p>WKNavigationDelegate has some important interfaces in addition to the above methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">//在尝试加载内容之前调用，确定是否加载请求
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler;

//在请求响应后调用，决定是否加载内容，在这里可以针对特定HTTP状态码的处理
- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler {

    if ([navigationResponse.response isKindOfClass:[NSHTTPURLResponse class]]) {
        NSHTTPURLResponse *response = (NSHTTPURLResponse *)navigationResponse.response;
        if (response.statusCode != 200) {
           //非200状态码不加载
            decisionHandler(WKNavigationResponsePolicyCancel);
            return;
        }
    }
    decisionHandler(WKNavigationResponsePolicyAllow);
}

//参考：Authentication Challenge的内容:/blog/blog/137-ssl-pinning.html
- (void)webView:(WKWebView *)webView didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential * _Nullable credential))completionHandler;
</code></pre></td></tr></table>
</div>
</div><h3 id="wknavigationaction">WKNavigationAction</h3>
<p>Contains web navigation information, according to which the corresponding action screen needs to be displayed.</p>
<h3 id="wkframeinfo">WKFrameInfo</h3>
<p>Object that identifies information about the current page content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">@interface WKFrameInfo : NSObject &lt;NSCopying&gt;

/*! @abstract A Boolean value indicating whether the frame is the main frame
 or a subframe.
 */
@property (nonatomic, readonly, getter=isMainFrame) BOOL mainFrame;

/*! @abstract The frame&#39;s current request.
 */
@property (nonatomic, readonly, copy) NSURLRequest *request;

/*! @abstract The frame&#39;s current security origin.
 */
@property (nonatomic, readonly) WKSecurityOrigin *securityOrigin API_AVAILABLE(macos(10.11), ios(9.0));

/*! @abstract The web view of the webpage that contains this frame.
 */
@property (nonatomic, readonly, weak) WKWebView *webView API_AVAILABLE(macos(10.13), ios(11.0));

@end
</code></pre></td></tr></table>
</div>
</div><h3 id="wkwebviewconfiguration">WKWebViewConfiguration</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">@interface WKWebViewConfiguration : NSObject &lt;NSSecureCoding, NSCopying&gt;

@property (nonatomic, strong) WKProcessPool *processPool;

/*! @abstract The preference settings to be used by the web view.
*/
@property (nonatomic, strong) WKPreferences *preferences;

/*! @abstract The user content controller to associate with the web view.
*/
@property (nonatomic, strong) WKUserContentController *userContentController;

/*! @abstract The website data store to be used by the web view.
 */
@property (nonatomic, strong) WKWebsiteDataStore *websiteDataStore API_AVAILABLE(macos(10.11), ios(9.0));

/*! @abstract The name of the application as used in the user agent string.
*/
@property (nullable, nonatomic, copy) NSString *applicationNameForUserAgent API_AVAILABLE(macos(10.11), ios(9.0));
...

@end
</code></pre></td></tr></table>
</div>
</div><p>WKWebViewConfiguration indicates the configuration information for initializing WKWebVie.</p>
<h3 id="wkprocesspool">WKProcessPool</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">@interface WKProcessPool : NSObject &lt;NSSecureCoding&gt;
@end
</code></pre></td></tr></table>
</div>
</div><p>WKProcessPool represents a separate process used to manage web content, and for security and stability reasons, WKWebView allocates a separate process for each WKWebView instance (instead of using the APP process space directly). WKWebViews with the same WKProcessPool object share the same process space. This is also a big difference between WKWebView and UIWebView.</p>
<p>As you can see the WKProcessPool class does not leak any interface, which means we can only create and read the object and determine if it is in the same process by the object address.</p>
<h3 id="wkusercontentcontroller">WKUserContentController</h3>
<p>WKUserScript represents a JavaScript script that needs to be injected into the web page.</p>
<h3 id="wkpreferences">WKPreferences</h3>
<p>Preference settings.</p>
<h3 id="wkuidelegate">WKUIDelegate</h3>
<p>Handles the agent that interacts with the user. There are three methods that need to be highlighted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler;
- (void)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(BOOL result))completionHandler;
- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * _Nullable result))completionHandler;
</code></pre></td></tr></table>
</div>
</div><p>The above three methods will be called when the web page executes the alert, confirm, and prompt methods of JavaScript, respectively.</p>
<h3 id="wkscriptmessagehandler-and-wkscriptmessagehandlerwithreply">WKScriptMessageHandler and WKScriptMessageHandlerWithReply</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">@protocol WKScriptMessageHandler &lt;NSObject&gt;
@required
- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message;
@end

//iOS 14
@protocol WKScriptMessageHandlerWithReply &lt;NSObject&gt;
- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message replyHandler:(void (^)(id _Nullable reply, NSString *_Nullable errorMessage))replyHandler;
@end
</code></pre></td></tr></table>
</div>
</div><p>WKScriptMessageHandler and WKScriptMessageHandlerWithReply are proxy protocols exposed by WKUserContentController and contain a must-implement method for responding to messages sent by the web&rsquo;s JavaScript code.</p>
<p>WKScriptMessageHandler and WKScriptMessageHandlerWithReply are proxy protocols exposed by WKUserContentController and contain a must-implement method for responding to messages sent by the web&rsquo;s JavaScript code.</p>
<h3 id="wkcontentworld">WKContentWorld</h3>
<p>WKContentWorld is a new addition to <a href="https://easeapi.com/blog/blog/130-ios14.html">iOS 14</a> and can be interpreted as a different namespace with a different runtime environment. Obviously, logically, there is a possibility of name conflict between native APP JS environment and web JS runtime environment. WKContentWorld has two class attributes defaultClientWorld , pageWorld , which represent the JS runtime space of native APP and web container respectively. Developers can also create a separate JS runtime environment by using: <code>+ (WKContentWorld *)worldWithName:(NSString *)name</code> factory method.</p>
<h2 id="basic-use-of-wkwebview">Basic use of WKWebView</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">WKUserContentController *userContentController = [[WKUserContentController alloc] init];
//注册处理器的名称
[userContentController addScriptMessageHandler:self name:@&#34;easeapiHandler&#34;];

WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];
configuration.userContentController = userContentController;

self.webView = [[WKWebView alloc] initWithFrame:self.view.bounds configuration:configuration];
self.webView.UIDelegate = self;
[self.view addSubview:self.webView];

NSURLRequest *request = [[NSURLRequest alloc] initWithURL:[NSURL URLWithString:@&#34;https://easeapi.com/blog&#34;]];
[self.webView loadRequest:request];
</code></pre></td></tr></table>
</div>
</div><h3 id="native-app-and-js-interaction">native APP and JS interaction</h3>
<h4 id="js-passing-data-to-native-app">JS passing data to native APP</h4>
<p>After registering the unique name through addScriptMessageHandler, data can be sent in the js code by</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">//js侧发送消息
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;success&#34;</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>      
<span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">easeapiHandler</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>

<span class="c1">//native APP接收消息
</span><span class="c1"></span><span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">userContentController</span><span class="o">:</span><span class="p">(</span><span class="nx">WKUserContentController</span> <span class="o">*</span><span class="p">)</span><span class="nx">userContentController</span> <span class="nx">didReceiveScriptMessage</span><span class="o">:</span><span class="p">(</span><span class="nx">WKScriptMessage</span> <span class="o">*</span><span class="p">)</span><span class="nx">message</span><span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nx">message</span><span class="p">.</span><span class="nx">name</span> <span class="nx">isEqualToString</span><span class="o">:</span><span class="err">@</span><span class="s2">&#34;easeapiHandler&#34;</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">NSDictionary</span> <span class="o">*</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="native-app-executes-js-code">native APP executes js code</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">//在js侧定义方法
</span><span class="c1"></span><span class="nx">jsFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
 <span class="k">return</span> <span class="s2">&#34;ok&#34;</span>
<span class="p">};</span>

<span class="c1">//native APP执行js方法并获得返回结果
</span><span class="c1"></span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">webView</span> <span class="nx">evaluateJavaScript</span><span class="o">:</span><span class="err">@</span><span class="s2">&#34;jsFunc(&#39;hello world!&#39;)&#34;</span> <span class="nx">completionHandler</span><span class="o">:^</span><span class="p">(</span><span class="nx">id</span> <span class="nx">_Nullable</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">NSError</span> <span class="o">*</span> <span class="nx">_Nullable</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s2">&#34;result = %@&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">}];</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="wkwebview-and-js-interaction-synchronization-problem">WKWebView and JS interaction synchronization problem</h3>
<p>As you can see, the interaction using window.webkit.messageHandlers.[name].postMessage sometimes doesn&rsquo;t work well, and it doesn&rsquo;t work well when you need to synchronize the JS side to get the data from the native APP before you can continue executing the JS code. Because postMessag has no callback interface, it cannot bring back the execution result of native APP. Unlike this, the evaluateJavaScript interface of native APP executing js code has a completionHandler callback to get the execution result of js on the native APP side.</p>
<p>Then the question arises: when executing postMessage on JS side, what if we get the execution result of native APP?</p>
<p>I remember this problem did not exist in UIWebView era, but it is a problem to be considered in WKWebView. At present, I have not found an elegant solution for this problem, so I have two options for reference.</p>
<h4 id="option-1-with-the-help-of-runjavascripttextinputpanelwithprompt-method">Option 1: With the help of runJavaScriptTextInputPanelWithPrompt method</h4>
<p>The above mentioned runJavaScriptTextInputPanelWithPrompt method when introducing WKUIDelegate, this method is meant to give native APP a time to realize prompt pop-up window by itself when executing prompt method, notice that this method has a completionHandler, that is, native APP will return data to JS side after processing.</p>
<p>The js prompt() method is used to display a dialog box for the user to make input. The definition is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">prompt</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">defaultText</span><span class="p">)</span>
<span class="c1">//text：标题文案
</span><span class="c1">//defaultText：输入框默认文案
</span><span class="c1">//返回用户输入的文案
</span></code></pre></td></tr></table>
</div>
</div><p>When the prompt method is executed in the WKWebView environment, it calls.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">webView</span><span class="o">:</span><span class="p">(</span><span class="nx">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="nx">webView</span> <span class="nx">runJavaScriptTextInputPanelWithPrompt</span><span class="o">:</span><span class="p">(</span><span class="nx">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nx">prompt</span> <span class="nx">defaultText</span><span class="o">:</span><span class="p">(</span><span class="nx">nullable</span> <span class="nx">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nx">defaultText</span> <span class="nx">initiatedByFrame</span><span class="o">:</span><span class="p">(</span><span class="nx">WKFrameInfo</span> <span class="o">*</span><span class="p">)</span><span class="nx">frame</span> <span class="nx">completionHandler</span><span class="o">:</span><span class="p">(</span><span class="k">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="nx">NSString</span> <span class="o">*</span> <span class="nx">_Nullable</span> <span class="nx">result</span><span class="p">))</span><span class="nx">completionHandler</span> <span class="p">{</span>
 <span class="c1">//针对特定prompt单独处理
</span><span class="c1"></span> <span class="k">if</span> <span class="p">([</span><span class="nx">prompt</span> <span class="nx">isEqualToString</span><span class="o">:</span><span class="err">@</span><span class="s2">&#34;cmd&#34;</span><span class="p">])</span> <span class="p">{</span>
  <span class="c1">//将处理结果返回给JS。
</span><span class="c1"></span>  <span class="nx">completionHandler</span><span class="p">(</span><span class="s2">&#34;result&#34;</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since the input and return are strings, it can be extended by JSON wrapping so that the response from the native APP can be synchronized by calling a specific name prompt in the js layer.</p>
<h4 id="option-2-use-the-new-api-added-by-ios-14">Option 2: Use the new API added by iOS 14</h4>
<p>Probably Apple also found this problem, so in iOS 14, there are many new optimized APIs for WKWebView, including the optimization for addScriptMessageHandler. A new didReceiveScriptMessage API with replyHandler has been added.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">webView</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">userContentController</span> <span class="nx">addScriptMessageHandlerWithReply</span><span class="o">:</span><span class="nx">self</span> <span class="nx">contentWorld</span><span class="o">:</span><span class="nx">WKContentWorld</span><span class="p">.</span><span class="nx">pageWorld</span> <span class="nx">name</span><span class="o">:</span><span class="err">@</span><span class="s2">&#34;easeapiHandler&#34;</span><span class="p">];</span>

<span class="c1">//WKScriptMessageHandlerWithReply
</span><span class="c1"></span><span class="o">-</span> <span class="p">(</span><span class="k">void</span><span class="p">)</span><span class="nx">userContentController</span><span class="o">:</span><span class="p">(</span><span class="nx">WKUserContentController</span> <span class="o">*</span><span class="p">)</span><span class="nx">userContentController</span> <span class="nx">didReceiveScriptMessage</span><span class="o">:</span><span class="p">(</span><span class="nx">WKScriptMessage</span> <span class="o">*</span><span class="p">)</span><span class="nx">message</span> <span class="nx">replyHandler</span><span class="o">:</span><span class="p">(</span><span class="k">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="nx">id</span> <span class="nx">_Nullable</span> <span class="nx">reply</span><span class="p">,</span> <span class="nx">NSString</span> <span class="o">*</span><span class="nx">_Nullable</span> <span class="nx">errorMessage</span><span class="p">))</span><span class="nx">replyHandler</span> <span class="p">{</span>
    <span class="nx">replyHandler</span><span class="p">(</span><span class="err">@</span><span class="s2">&#34;success&#34;</span><span class="p">,</span> <span class="nx">nil</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Use the promise asynchronous callback on the JS side to get the result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">authSuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&#34;result&#34;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>      
  <span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkit</span><span class="p">.</span><span class="nx">messageHandlers</span><span class="p">.</span><span class="nx">easeapiHandler</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
  <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
   <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">prompt</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
   <span class="p">},</span>
   <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
         <span class="p">}</span>
  <span class="p">)</span>
 <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="wkwebview-addscriptmessagehandler-circular-reference">WKWebView addScriptMessageHandler circular reference</h3>
<p>addScriptMessageHandler/addScriptMessageHandlerWithReply will strongly hold the object, you need to removeScriptMessageHandlerForName operation at the right time, otherwise it will cause circular reference.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ios/">ios</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/nextjs-server-client-build/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to package NextJs separately by server-side or browser-side type</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/go-jsonrpc2.0/">
            <span class="next-text nav-default">Implementation of jsonrpc2.0 in Go</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
