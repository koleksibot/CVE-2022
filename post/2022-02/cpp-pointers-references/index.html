<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The underlying implementation of pointers and references in C&#43;&#43; - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="References are an important feature introduced in C&#43;&#43; as opposed to C. They make the syntax much more concise in many places, but how are they actually implemented underneath? In Wikipedia, pointers are described as follows. In computer science, a pointer is a programming language object that stores the memory address of another value located in computer memory. A pointer references a location in memory, and obtaining the value stored" /><meta name="keywords" content="c&#43;&#43;, Pointers References" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/cpp-pointers-references/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="The underlying implementation of pointers and references in C&#43;&#43;" />
<meta property="og:description" content="References are an important feature introduced in C&#43;&#43; as opposed to C. They make the syntax much more concise in many places, but how are they actually implemented underneath? In Wikipedia, pointers are described as follows. In computer science, a pointer is a programming language object that stores the memory address of another value located in computer memory. A pointer references a location in memory, and obtaining the value stored" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/cpp-pointers-references/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-09T13:09:45+08:00" />
<meta property="article:modified_time" content="2022-02-09T13:09:45+08:00" />

<meta itemprop="name" content="The underlying implementation of pointers and references in C&#43;&#43;">
<meta itemprop="description" content="References are an important feature introduced in C&#43;&#43; as opposed to C. They make the syntax much more concise in many places, but how are they actually implemented underneath? In Wikipedia, pointers are described as follows. In computer science, a pointer is a programming language object that stores the memory address of another value located in computer memory. A pointer references a location in memory, and obtaining the value stored"><meta itemprop="datePublished" content="2022-02-09T13:09:45+08:00" />
<meta itemprop="dateModified" content="2022-02-09T13:09:45+08:00" />
<meta itemprop="wordCount" content="2111">
<meta itemprop="keywords" content="c&#43;&#43;," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The underlying implementation of pointers and references in C&#43;&#43;"/>
<meta name="twitter:description" content="References are an important feature introduced in C&#43;&#43; as opposed to C. They make the syntax much more concise in many places, but how are they actually implemented underneath? In Wikipedia, pointers are described as follows. In computer science, a pointer is a programming language object that stores the memory address of another value located in computer memory. A pointer references a location in memory, and obtaining the value stored"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The underlying implementation of pointers and references in C&#43;&#43;</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-09 13:09:45 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2111 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#further-experiments">Further experiments</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>References are an important feature introduced in C++ as opposed to C. They make the syntax much more concise in many places, but how are they actually implemented underneath?</p>
<p>In Wikipedia, pointers are described as follows.</p>
<blockquote>
<p>In computer science, a pointer is a programming language object that stores the memory address of another value located in computer memory. A pointer references a location in memory, and obtaining the value stored at that location is known as dereferencing the pointer.</p>
</blockquote>
<p>As you can see from the definition, a pointer is essentially a variable in which the address of another variable is stored. A pointer in C is very flexible in that it can point to any address, whether it exists or not, or whether it stores data of the type represented by the pointer.</p>
<p>It is not hard to imagine that a pointer is also a variable in memory when it is implemented, and it holds the addresses of other variables.</p>
<p>In Wikipedia, references are described as follows.</p>
<blockquote>
<p>In computer science, a reference is a value that enables a program to indirectly access a particular datum, such as a variable&rsquo;s value or a record, in the computer&rsquo;s memory or in some other storage device. The reference is said to refer to the datum, and accessing the datum is called dereferencing the reference.</p>
<p>In the C++ programming language, a reference is a simple reference datatype that is less powerful but safer than the pointer type inherited from C. The name C++ reference may cause confusion, as in computer science a reference is a general concept datatype, with pointers and C++ references being specific reference datatype implementations. The definition of a reference in C++ is such that it does not need to exist. It can be implemented as a new name for an existing object (similar to rename keyword in Ada).</p>
</blockquote>
<p>As you can see from the above definition, in C++, a reference can be narrowly thought of as an alias for a variable, which does not exist in itself.</p>
<p>Based on the above statement, I then thought for a while that a reference is just some black magic of the C++ compiler at compile time, which links two resolved symbols into one at runtime, thus completing the reference, and after compilation, the reference is a variable (a value in a register or on the stack) with the propriety.</p>
<p>However, the facts smacked me in the face.</p>
<p>Let&rsquo;s check it by the following procedure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
    <span class="kt">int</span> <span class="o">&amp;</span><span class="n">ra</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
    <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">pa</span><span class="p">);</span>
    <span class="o">++</span><span class="n">ra</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The program declares a variable a, then declares a pointer pa to the address of a and a life reference ra to a. Finally, it performs a self-addition operation on a using the pointer and the address, respectively.</p>
<p>Next, compile the above C++ program into assembly using <code>gcc -S test.cpp -o test.s -O0</code> to see exactly how all these operations are implemented. (MacOS environment, LLVM 10.0.1)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">	.section	__TEXT,__text,regular,pure_instructions
	.build_version macos, 10, 14	sdk_version 10, 14
	.globl	_main                   ## -- Begin function main
	.p2align	4, 0x90
_main:                                  ## @main
	.cfi_startproc
## %bb.0:
	; 保护现场
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	; 保存栈指针
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
	; 设置返回值为0
	xorl	%eax, %eax
	; int a = 0
	movl	$0, -4(%rbp)
	; t0 = &amp;a
	leaq	-4(%rbp), %rcx
	; int *pa = t0
	movq	%rcx, -16(%rbp)
	; int &amp;ra = t0
	movq	%rcx, -24(%rbp)
	; t0 = pa
	movq	-16(%rbp), %rcx
	; t1 = *t0 = *pa
	movl	(%rcx), %edx
	; ++t1
	addl	$1, %edx
	; *t0 = *pa = t1
	movl	%edx, (%rcx)
	; t0 = &amp;ra = &amp;a
	movq	-24(%rbp), %rcx
	; t1 = *t0 = *(&amp;ra) = ra = a
	movl	(%rcx), %edx
	; ++t1
	addl	$1, %edx
	; *t0 = *(&amp;ra) = ra = a = t1
	movl	%edx, (%rcx)
	; 恢复现场
	popq	%rbp
	; 返回
	retq
	.cfi_endproc
                                        ## -- End function

.subsections_via_symbols

</code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ve commented out the key code in the assembly, and you can see that the variable a, the pointer pa, and the reference ra are all located on the stack, with indexes at - 4, -16, and -24. Note that the reference does not directly reuse the <code>-4(%rbp)</code> address of the variable a, but rather, like a pointer, uses a new address and writes the address of a calculated by leaq is written into it.</p>
<p>When self-adding is done, the pointer and reference are used in exactly the same way, except that the address used to copy the contents of the pointer into the register at the beginning is different.</p>
<p>I was very surprised by this result, <em>the compiler actually translated the developer&rsquo;s operation on references into an operation on pointers</em>.</p>
<p>In the end, it turns out that modern compilers are still very smart, and if you turn up the optimization level, you will find that it directly simplifies all the intermediate computations and returns them directly, because the result of the computation does not have any output, it is not necessary. If the above code is transferred from the main function to another function, the compiler at this point does its best to optimize and return the result directly (<code>movl $2, %eax</code>), although it cannot give up calculating the values in it.</p>
<h2 id="further-experiments">Further experiments</h2>
<p>After the article was posted, some people questioned that it might be a specific operation of the gcc compiler on MacOS and not universal, so I repeated the above experiment on Linux and Windows.</p>
<p>The assembly code obtained after compiling with the same instructions in a Linux environment (distribution Ubuntu 18.04, gcc version 7.5.0) is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++">	<span class="p">.</span><span class="n">file</span>	<span class="s">&#34;test_ref.cpp&#34;</span>
	<span class="p">.</span><span class="n">text</span>
	<span class="p">.</span><span class="n">globl</span>	<span class="n">main</span>
	<span class="p">.</span><span class="n">type</span>	<span class="n">main</span><span class="p">,</span> <span class="err">@</span><span class="n">function</span>
<span class="nl">main</span><span class="p">:</span>
<span class="p">.</span><span class="nl">LFB0</span><span class="p">:</span>
	<span class="p">.</span><span class="n">cfi_startproc</span>
	<span class="p">;</span> <span class="err">保护现场</span>
	<span class="n">pushq</span>	<span class="o">%</span><span class="n">rbp</span>
	<span class="p">.</span><span class="n">cfi_def_cfa_offset</span> <span class="mi">16</span>
	<span class="p">.</span><span class="n">cfi_offset</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
	<span class="p">;</span> <span class="err">保存栈指针</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
	<span class="p">.</span><span class="n">cfi_def_cfa_register</span> <span class="mi">6</span>
	<span class="n">subq</span>	<span class="err">$</span><span class="mi">32</span><span class="p">,</span> <span class="o">%</span><span class="n">rsp</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="nl">fs</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
	<span class="p">;</span> <span class="err">设置返回值为</span><span class="mi">0</span>
	<span class="n">xorl</span>	<span class="o">%</span><span class="n">eax</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
	<span class="p">;</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">movl</span>	<span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">28</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span>
	<span class="n">leaq</span>	<span class="o">-</span><span class="mi">28</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">t0</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span>
	<span class="n">leaq</span>	<span class="o">-</span><span class="mi">28</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">ra</span> <span class="o">=</span> <span class="n">t0</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">pa</span>
	<span class="n">movq</span>	<span class="o">-</span><span class="mi">24</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="n">t1</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">=</span> <span class="o">*</span><span class="n">pa</span>
	<span class="n">movl</span>	<span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span> <span class="o">%</span><span class="n">eax</span>
	<span class="p">;</span> <span class="n">t2</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="n">leal</span>	<span class="mi">1</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span> <span class="o">%</span><span class="n">edx</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">pa</span>
	<span class="n">movq</span>	<span class="o">-</span><span class="mi">24</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="o">*</span><span class="n">t0</span> <span class="o">=</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="n">movl</span>	<span class="o">%</span><span class="n">edx</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">ra</span>
	<span class="n">movq</span>	<span class="o">-</span><span class="mi">16</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="n">t1</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">=</span> <span class="o">*</span><span class="n">pa</span>
	<span class="n">movl</span>	<span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span> <span class="o">%</span><span class="n">eax</span>
	<span class="p">;</span> <span class="n">t2</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="n">leal</span>	<span class="mi">1</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span> <span class="o">%</span><span class="n">edx</span>
	<span class="p">;</span> <span class="n">t0</span> <span class="o">=</span> <span class="n">ra</span>
	<span class="n">movq</span>	<span class="o">-</span><span class="mi">16</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
	<span class="p">;</span> <span class="o">*</span><span class="n">t0</span> <span class="o">=</span> <span class="o">*</span><span class="n">ra</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">=</span> <span class="o">*</span><span class="n">t0</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="n">movl</span>	<span class="o">%</span><span class="n">edx</span><span class="p">,</span> <span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span>
	<span class="p">;</span> <span class="err">返回值设置为</span><span class="mi">0</span>
	<span class="n">movl</span>	<span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
	<span class="n">movq</span>	<span class="o">-</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">rcx</span>
	<span class="n">xorq</span>	<span class="o">%</span><span class="nl">fs</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="o">%</span><span class="n">rcx</span>
	<span class="n">je</span>	<span class="p">.</span><span class="n">L3</span>
	<span class="n">call</span>	<span class="n">__stack_chk_fail</span><span class="err">@</span><span class="n">PLT</span>
<span class="p">.</span><span class="nl">L3</span><span class="p">:</span>
	<span class="n">leave</span>
	<span class="p">.</span><span class="n">cfi_def_cfa</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
	<span class="n">ret</span>
	<span class="p">.</span><span class="n">cfi_endproc</span>
<span class="p">.</span><span class="nl">LFE0</span><span class="p">:</span>
	<span class="p">.</span><span class="n">size</span>	<span class="n">main</span><span class="p">,</span> <span class="p">.</span><span class="o">-</span><span class="n">main</span>
	<span class="p">.</span><span class="n">ident</span>	<span class="s">&#34;GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0&#34;</span>
	<span class="p">.</span><span class="n">section</span>	<span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">GNU</span><span class="o">-</span><span class="n">stack</span><span class="p">,</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span>

</code></pre></td></tr></table>
</div>
</div><p>You can see that the compilation results are basically the same as for gcc in MacOS.</p>
<p>In a Windows environment (Windows 10, vs2019, cl version 19.23.28106.4), you can use the command <code>cl /Od /FA . \test_ref.cpp</code> to compile the source code, you can get the assembly code as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="p">;</span> <span class="n">Listing</span> <span class="n">generated</span> <span class="n">by</span> <span class="nf">Microsoft</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Optimizing</span> <span class="n">Compiler</span> <span class="n">Version</span> <span class="mf">19.23.28106.4</span> 

	<span class="n">TITLE</span>	<span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">jason</span><span class="err">\</span><span class="n">test</span><span class="err">\</span><span class="n">test_ref</span><span class="p">.</span><span class="n">cpp</span>
	<span class="mf">.686</span><span class="n">P</span>
	<span class="p">.</span><span class="n">XMM</span>
	<span class="n">include</span> <span class="n">listing</span><span class="p">.</span><span class="n">inc</span>
	<span class="p">.</span><span class="n">model</span>	<span class="n">flat</span>

<span class="n">INCLUDELIB</span> <span class="n">LIBCMT</span>
<span class="n">INCLUDELIB</span> <span class="n">OLDNAMES</span>

<span class="n">PUBLIC</span>	<span class="n">_main</span>
<span class="p">;</span> <span class="n">Function</span> <span class="n">compile</span> <span class="nl">flags</span><span class="p">:</span> <span class="o">/</span><span class="n">Odtp</span>
<span class="n">_TEXT</span>	<span class="n">SEGMENT</span>
<span class="n">_ra</span><span class="err">$</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span>						<span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">_pa</span><span class="err">$</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span>						<span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">_a</span><span class="err">$</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>						<span class="p">;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">_main</span>	<span class="n">PROC</span>
<span class="p">;</span> <span class="n">File</span> <span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">jason</span><span class="err">\</span><span class="n">test</span><span class="err">\</span><span class="n">test_ref</span><span class="p">.</span><span class="n">cpp</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">2</span>
	<span class="n">push</span>	<span class="n">ebp</span>
	<span class="n">mov</span>	<span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
	<span class="n">sub</span>	<span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>					<span class="p">;</span> <span class="mo">0000000</span><span class="n">cH</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">3</span>
	<span class="n">mov</span>	<span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_a</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">],</span> <span class="mi">0</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">4</span>
	<span class="n">lea</span>	<span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_a</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_pa</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">],</span> <span class="n">eax</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">5</span>
	<span class="n">lea</span>	<span class="n">ecx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_a</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_ra</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">],</span> <span class="n">ecx</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">6</span>
	<span class="n">mov</span>	<span class="n">edx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_pa</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">edx</span><span class="p">]</span>
	<span class="n">add</span>	<span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
	<span class="n">mov</span>	<span class="n">ecx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_pa</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ecx</span><span class="p">],</span> <span class="n">eax</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">7</span>
	<span class="n">mov</span>	<span class="n">edx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_ra</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">edx</span><span class="p">]</span>
	<span class="n">add</span>	<span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
	<span class="n">mov</span>	<span class="n">ecx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">_ra</span><span class="err">$</span><span class="p">[</span><span class="n">ebp</span><span class="p">]</span>
	<span class="n">mov</span>	<span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">ecx</span><span class="p">],</span> <span class="n">eax</span>
<span class="p">;</span> <span class="n">Line</span> <span class="mi">8</span>
	<span class="n">xor</span>	<span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
	<span class="n">mov</span>	<span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span>
	<span class="n">pop</span>	<span class="n">ebp</span>
	<span class="n">ret</span>	<span class="mi">0</span>
<span class="n">_main</span>	<span class="n">ENDP</span>
<span class="n">_TEXT</span>	<span class="n">ENDS</span>
<span class="n">END</span>

</code></pre></td></tr></table>
</div>
</div><p>The cl compiler has a slightly different format for assembly code than gcc, but the meaning is similar, and the meaning of the assembly code can be determined relatively easily from the lines of code indicated above. As you can see, it also uses the same method as the first two.</p>
<p>To take it a step further, here is a comment from user &ldquo;XZiar&rdquo; on Zhihu, whose comment gives more insight into the mechanism.</p>
<blockquote>
<p>It doesn&rsquo;t really mean &ldquo;interpreting references as pointers&rdquo;, does it?</p>
<p>At the machine code level, there are no pointers either, only addresses (pointers actually also imply type information). The concept of variables also does not exist, there is only &ldquo;unformatted data&rdquo; that is just manipulated by instructions with formatting.</p>
<p>So you see that references and pointers have the same effect because at the machine code level, there is no extra information to indicate the difference between them.</p>
<p>And at the language level, references can indeed be understood as const pointers</p>
</blockquote>
<p>In addition, she provides a more in-depth explanation of why references copy addresses in assembly code.</p>
<blockquote>
<p>It is also normal for references to be copied over, and it is true that the compiler cannot fully analyze the exact point of the reference at compile time. Consider the following code.</p>
<p>int a=0,b=1; int&amp; c = flag ? a : b;</p>
<p>References are only not reset because they are const, but what they point to can be determined at runtime.</p>
</blockquote>
<p>At this point, the exploration of the underlying implementation of pointers and references is basically over. As you can see, without compiler optimizations enabled, mainstream compilers choose to interpret references in C++ as &ldquo;const pointers&rdquo;.</p>
<p>But what happens when compiler optimizations are enabled? In MacOS, after changing the return value in the source code to a (to prevent the compiler from optimizing and thinking there is no output and doing nothing), and adjusting the compiler optimization options to O1 and O2, the results are the same, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">	<span class="p">.</span><span class="n">section</span>	<span class="n">__TEXT</span><span class="p">,</span><span class="n">__text</span><span class="p">,</span><span class="n">regular</span><span class="p">,</span><span class="n">pure_instructions</span>
	<span class="p">.</span><span class="n">build_version</span> <span class="n">macos</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span>	<span class="n">sdk_version</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span>
	<span class="p">.</span><span class="n">globl</span>	<span class="n">_main</span>                   <span class="err">##</span> <span class="o">--</span> <span class="n">Begin</span> <span class="n">function</span> <span class="n">main</span>
	<span class="p">.</span><span class="n">p2align</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x90</span>
<span class="nl">_main</span><span class="p">:</span>                                  <span class="err">##</span> <span class="err">@</span><span class="n">main</span>
	<span class="p">.</span><span class="n">cfi_startproc</span>
<span class="cp">## %bb.0:
</span><span class="cp"></span>	<span class="n">pushq</span>	<span class="o">%</span><span class="n">rbp</span>
	<span class="p">.</span><span class="n">cfi_def_cfa_offset</span> <span class="mi">16</span>
	<span class="p">.</span><span class="n">cfi_offset</span> <span class="o">%</span><span class="n">rbp</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
	<span class="n">movq</span>	<span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
	<span class="p">.</span><span class="n">cfi_def_cfa_register</span> <span class="o">%</span><span class="n">rbp</span>
	<span class="n">movl</span>	<span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="o">%</span><span class="n">eax</span>
	<span class="n">popq</span>	<span class="o">%</span><span class="n">rbp</span>
	<span class="n">retq</span>
	<span class="p">.</span><span class="n">cfi_endproc</span>
                                        <span class="cp">## -- End function
</span><span class="cp"></span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that the assembly version of the code omits all code related to pointers, references and memory operations, and directly sets the return value to 2.</p>
<p>From here it can be seen that the compiler&rsquo;s role is to translate the code written in the language into reasonable assembly code, as long as the assembly code can be executed as the source code really intended. Since machine code can express a limited number of concepts (basically, operations on registers and memory), while high-level languages can express a wide variety of concepts, the compiler needs to map (or see as a translation) various complex concepts in high-level languages into simple concepts in machine code. In the translation of C++ pointers and references, the mainstream C++ compilers have chosen to map them to addresses in machine code, discarding the type information therein.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/communicate-with-cpp-code-in-node/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Communicating with C&#43;&#43; code in NodeJS</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/vue3-responsive/">
            <span class="next-text nav-default">Vue3 - Responsive Principle Explained</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
