<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>In-depth understanding of the Gradle Tooling API - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. Introduction A build system is an automated tool for generating target products from source code, including libraries, executables, generated scripts, etc. Build systems generally provide platform-related executables that can be triggered externally by executing commands, such as GUN Make, Ant, CMake, Gradle, etc. Gradle is a flexible and powerful open source Gradle is a flexible and powerful open source build system that provides cross-platform executables for external execution of Gradle builds via commands in a command line window, such as ." /><meta name="keywords" content="gradle, Tooling, Api" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/gradle-tooling-api/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="In-depth understanding of the Gradle Tooling API" />
<meta property="og:description" content="1. Introduction A build system is an automated tool for generating target products from source code, including libraries, executables, generated scripts, etc. Build systems generally provide platform-related executables that can be triggered externally by executing commands, such as GUN Make, Ant, CMake, Gradle, etc. Gradle is a flexible and powerful open source Gradle is a flexible and powerful open source build system that provides cross-platform executables for external execution of Gradle builds via commands in a command line window, such as ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/gradle-tooling-api/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-22T09:13:11+08:00" />
<meta property="article:modified_time" content="2022-02-22T09:13:11+08:00" />

<meta itemprop="name" content="In-depth understanding of the Gradle Tooling API">
<meta itemprop="description" content="1. Introduction A build system is an automated tool for generating target products from source code, including libraries, executables, generated scripts, etc. Build systems generally provide platform-related executables that can be triggered externally by executing commands, such as GUN Make, Ant, CMake, Gradle, etc. Gradle is a flexible and powerful open source Gradle is a flexible and powerful open source build system that provides cross-platform executables for external execution of Gradle builds via commands in a command line window, such as ."><meta itemprop="datePublished" content="2022-02-22T09:13:11+08:00" />
<meta itemprop="dateModified" content="2022-02-22T09:13:11+08:00" />
<meta itemprop="wordCount" content="2219">
<meta itemprop="keywords" content="gradle," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In-depth understanding of the Gradle Tooling API"/>
<meta name="twitter:description" content="1. Introduction A build system is an automated tool for generating target products from source code, including libraries, executables, generated scripts, etc. Build systems generally provide platform-related executables that can be triggered externally by executing commands, such as GUN Make, Ant, CMake, Gradle, etc. Gradle is a flexible and powerful open source Gradle is a flexible and powerful open source build system that provides cross-platform executables for external execution of Gradle builds via commands in a command line window, such as ."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">In-depth understanding of the Gradle Tooling API</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-22 09:13:11 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2219 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction">1. Introduction</a></li>
        <li><a href="#2-interface-functions-and-call-examples">2. Interface functions and call examples</a>
          <ul>
            <li><a href="#21-interface-functions">2.1 Interface Functions</a></li>
            <li><a href="#22-call-example">2.2 Call example</a></li>
          </ul>
        </li>
        <li><a href="#3-principle-analysis">3. Principle analysis</a>
          <ul>
            <li><a href="#31-how-to-communicate-with-gradle-build-process">3.1 How to communicate with Gradle build process?</a></li>
            <li><a href="#32-how-to-achieve-forward-and-backward-compatibility">3.2 How to achieve forward and backward compatibility?</a></li>
          </ul>
        </li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-introduction">1. Introduction</h2>
<p><strong>A build system is an automated tool for generating target products</strong> from source code, including libraries, executables, generated scripts, etc. Build systems generally provide platform-related executables that can be triggered externally by executing commands, such as GUN Make, Ant, CMake, Gradle, etc. Gradle is a flexible and powerful open source Gradle is a flexible and powerful open source build system that provides cross-platform executables for external execution of Gradle builds via commands in a command line window, such as <code>. /gradlew assemble</code> command triggers a Gradle build task.</p>
<p>Modern mature IDEs integrate the required build systems, combine multiple command-line tools, encapsulate them into a set of automated build tools, and provide build view tools to improve developer productivity. In IntelliJ IDEA, it is possible to trigger the execution of Gradle tasks through the Gradle view tool, but it is not achieved by encapsulating command line tools, but by integrating the programming <strong>SDK - Gradle Tooling API</strong> specifically provided by Gradle, through which Gradle build capabilities can be embedded into the IDE or other tooling software.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/bde6eaa6d01c4682bbe236d5ae72e625.png" alt="Gradle Tooling API"></p>
<p>Why does Gradle provide a Tooling API specifically for external integration calls, rather than just an executable-based command approach like other build systems? <strong>The Tooling API is a major extension to Gradle</strong> that provides more controlled and deeper build control than the command approach, allowing IDEs and other tools to be more easily and tightly integrated with Gradle&rsquo;s capabilities. The Tooling API interface can return build results directly, eliminating the need to manually parse the log output of command-line programs as in the command method, and can run version-independently, meaning that <strong>the same version of the Tooling API can handle builds from different Gradle versions</strong>, while being both forward and backward compatible.</p>
<h2 id="2-interface-functions-and-call-examples">2. Interface functions and call examples</h2>
<h3 id="21-interface-functions">2.1 Interface Functions</h3>
<p>The Tooling API provides functions for executing and monitoring builds, querying build information, etc.</p>
<ul>
<li>Querying build information, including project structure, project dependencies, external dependencies, and project tasks.</li>
<li>Executing build tasks and listening to the progress information of the build.</li>
<li>Cancelling the executing build task.</li>
<li>Automatically download the Gradle version that matches the project.</li>
</ul>
<p>The key APIs are as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/a898c5c7728348e283b2d97cc8add034.png" alt="Gradle Tooling API"></p>
<h3 id="22-call-example">2.2 Call example</h3>
<h4 id="query-project-structure-and-tasks">Query project structure and tasks</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">(</span><span class="n">ProjectConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">GradleConnector</span><span class="o">.</span><span class="na">newConnector</span><span class="o">()</span>
         <span class="o">.</span><span class="na">forProjectDirectory</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;someFolder&#34;</span><span class="o">))</span>
         <span class="o">.</span><span class="na">connect</span><span class="o">())</span> <span class="o">{</span>
   <span class="n">GradleProject</span> <span class="n">rootProject</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getModel</span><span class="o">(</span><span class="n">GradleProject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GradleProject</span><span class="o">&gt;</span> <span class="n">subProject</span> <span class="o">=</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">getChildren</span><span class="o">();</span>
   <span class="n">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GradleTask</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">getTasks</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As introduced in the API above, we first create a connection <code>ProjectConnection</code> to a participating build project via the Tooling API entry class <code>GradleConnector</code>, and then get the structure information model <code>GradleProject</code> of this project via <code>getModel(Class&lt;T&gt; modelType)</code>, which contains information about the project structure, project tasks, etc. that we want to query.</p>
<h4 id="execute-the-build-task">Execute the build task</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">String</span><span class="o">[]</span> <span class="n">gradleTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">&#34;clean&#34;</span><span class="o">,</span> <span class="s">&#34;app:assembleDebug&#34;</span><span class="o">};</span>
<span class="k">try</span> <span class="o">(</span><span class="n">ProjectConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">GradleConnector</span><span class="o">.</span><span class="na">newConnector</span><span class="o">()</span>
         <span class="o">.</span><span class="na">forProjectDirectory</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;someFolder&#34;</span><span class="o">))</span>
         <span class="o">.</span><span class="na">connect</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">BuildLauncher</span> <span class="n">build</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">newBuild</span><span class="o">();</span>
    <span class="n">build</span><span class="o">.</span><span class="na">forTasks</span><span class="o">(</span><span class="n">gradleTasks</span><span class="o">)</span>
         <span class="o">.</span><span class="na">addProgressListener</span><span class="o">(</span><span class="n">progressListener</span><span class="o">)</span>
         <span class="o">.</span><span class="na">setColorOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
         <span class="o">.</span><span class="na">setJvmArguments</span><span class="o">(</span><span class="n">jvmArguments</span><span class="o">);</span>
    <span class="n">build</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This example creates a <code>BuildLauncher</code> for executing build tasks via the <code>newBuild()</code> method of <code>ProjectConnection</code>, then configures the Gradle tasks to be executed via <code>forTasks(String... tasks)</code> to configure the Gradle tasks to be executed and configure the execution progress listener, etc., and finally trigger the execution of the tasks via <code>run()</code>.</p>
<h2 id="3-principle-analysis">3. Principle analysis</h2>
<h3 id="31-how-to-communicate-with-gradle-build-process">3.1 How to communicate with Gradle build process?</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/2e7a66bef329469fb886570ecbbd9bdc.png" alt="Gradle build process"></p>
<p>The Gradle Tooling API does not have the real Gradle build capability, but provides an entry point to call the native Gradle program to facilitate the communication with Gradle in coded form. After calling the Gradle build capability through the API in our own tooling program, we still need to communicate with the real Gradle builder across processes. Whether it is an IDE or tooling application that interacts with Gradle through the Gradle Tooling API, or a command-line window application that interacts with Gradle in the form of a command, the client application that invokes the Gradle build across the process is a <strong>Gradle client</strong>, and the Gradle build that actually performs the task is the <strong>Gradle client</strong>. program is the <strong>Gradle build process</strong> .</p>
<p>The <strong>Gradle daemon process</strong> is a long-standing Gradle build process that improves build speed by circumventing the build Gradle JVM environment and memory cache, and is always enabled for Gradle clients that integrate the Gradle Tooling API. In other words, a tooling application that has integrated the Gradle Tooling API will always communicate with the daemon process across processes to invoke Gradle build capabilities. If a Gradle client wants to connect to a dynamically created daemon process, it needs to register the daemon process and open it to queries through a service registration and service discovery mechanism, which is provided by <strong>DaemonRegistry</strong>.</p>
<h4 id="client---gradle-client">Client - Gradle Client</h4>
<p>The following is an analysis of the cross-process communication mechanism of the Gradle Tooling API from the source code perspective, taking the project structure information as the starting point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">try</span> <span class="o">(</span><span class="n">ProjectConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">GradleConnector</span><span class="o">.</span><span class="na">newConnector</span><span class="o">()</span>
         <span class="o">.</span><span class="na">forProjectDirectory</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;someFolder&#34;</span><span class="o">))</span>
         <span class="o">.</span><span class="na">connect</span><span class="o">())</span> <span class="o">{</span>
   <span class="n">GradleProject</span> <span class="n">rootProject</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getModel</span><span class="o">(</span><span class="n">GradleProject</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>From the code, although <code>ProjectConnection</code> looks like it creates a link to the daemon process, it doesn&rsquo;t. Instead, the link to the daemon process is actually created in the <code>getModel(Class&lt;T&gt; modelType)</code> method, which, internally, is called from the This method is called from the Tooling API side to the Gradle source code, and finally looks for an available daemon process in <code>DefaultDaemonConnector.java</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">DaemonClientConnection</span> <span class="nf">connect</span><span class="o">(</span><span class="n">ExplainingSpec</span><span class="o">&lt;</span><span class="n">DaemonContext</span><span class="o">&gt;</span> <span class="n">constraint</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">DaemonInfo</span><span class="o">&gt;,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">DaemonInfo</span><span class="o">&gt;&gt;</span> <span class="n">idleBusy</span> <span class="o">=</span> <span class="n">partitionByState</span><span class="o">(</span><span class="n">daemonRegistry</span><span class="o">.</span><span class="na">getAll</span><span class="o">(),</span> <span class="n">Idle</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">DaemonInfo</span><span class="o">&gt;</span> <span class="n">idleDaemons</span> <span class="o">=</span> <span class="n">idleBusy</span><span class="o">.</span><span class="na">getLeft</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">DaemonInfo</span><span class="o">&gt;</span> <span class="n">busyDaemons</span> <span class="o">=</span> <span class="n">idleBusy</span><span class="o">.</span><span class="na">getRight</span><span class="o">();</span>
    <span class="c1">// Check to see if there are any compatible idle daemons
</span><span class="c1"></span>    <span class="n">DaemonClientConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectToIdleDaemon</span><span class="o">(</span><span class="n">idleDaemons</span><span class="o">,</span> <span class="n">constraint</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Check to see if there are any compatible canceled daemons and wait to see if one becomes idle
</span><span class="c1"></span>    <span class="n">connection</span> <span class="o">=</span> <span class="n">connectToCanceledDaemon</span><span class="o">(</span><span class="n">busyDaemons</span><span class="o">,</span> <span class="n">constraint</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// No compatible daemons available - start a new daemon
</span><span class="c1"></span>    <span class="n">handleStopEvents</span><span class="o">(</span><span class="n">idleDaemons</span><span class="o">,</span> <span class="n">busyDaemons</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">startDaemon</span><span class="o">(</span><span class="n">constraint</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using the above daemon process lookup logic and related code, it can be concluded that.</p>
<ol>
<li>the daemon process includes six states <strong>Idle, Busy, Canceled, StopRequested, Stopped, Broken</strong>.</li>
<li>when executing Gradle builds in daemon process mode, it will try to find the daemon process with <strong>Idle, Canceled</strong> status and compatible environment in turn, if not found, it will create a new daemon process compatible with Gradle client environment.</li>
<li>all Daemon processes are recorded in the <code>DaemonRegistry.java</code> registry for the Gradle client to obtain.</li>
<li>the environment compatibility determination of the Daemon process includes Gradle version, file encoding, JVM heap size and other attributes.</li>
<li>after getting a compatible daemon process, it will link to the port the daemon process is listening on via socket, and then communicate with the daemon process via socket.</li>
</ol>
<h4 id="server-side---daemon-process">server side - Daemon process</h4>
<p>When a Gradle client calls the Gradle build capability, it triggers the creation of a daemon process. The process entry function is in <code>GradleDaemon.java</code>, then it goes to <code>DaemonMain.java</code> to initialize the process, and finally in <code> TcpIncomingConnector.java</code> to open the Socket Server and bind to listen on a specified port.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">ConnectionAcceptor</span> <span class="nf">accept</span><span class="o">(</span><span class="n">Action</span><span class="o">&lt;</span><span class="n">ConnectCompletion</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowRemote</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocketChannel</span> <span class="n">serverSocket</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">localPort</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">serverSocket</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="n">serverSocket</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">addressFactory</span><span class="o">.</span><span class="na">getLocalBindingAddress</span><span class="o">(),</span> <span class="n">0</span><span class="o">));</span>
        <span class="n">localPort</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">getLocalPort</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">UncheckedException</span><span class="o">.</span><span class="na">throwAsUncheckedException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The daemon process is then logged into the registry in <code>DaemonRegistryUpdater.java</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">(</span><span class="n">Address</span> <span class="n">connectorAddress</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;{}{}&#34;</span><span class="o">,</span> <span class="n">DaemonMessages</span><span class="o">.</span><span class="na">ADVERTISING_DAEMON</span><span class="o">,</span> <span class="n">connectorAddress</span><span class="o">);</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Advertised daemon context: {}&#34;</span><span class="o">,</span> <span class="n">daemonContext</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">connectorAddress</span> <span class="o">=</span> <span class="n">connectorAddress</span><span class="o">;</span>
    <span class="n">daemonRegistry</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="k">new</span> <span class="n">DaemonInfo</span><span class="o">(</span><span class="n">connectorAddress</span><span class="o">,</span> <span class="n">daemonContext</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">Busy</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this way, Gradle client can get the compatible daemon process and its port in the registry, so as to establish a connection with the daemon process for communication, as shown in the figure below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/018d0da424b645f98e7c18d0b13e0b05.png" alt="sobyte"></p>
<p>To summarize the process of establishing connection between Tooling API and Gradle Daemon process:</p>
<ol>
<li>the Tooling API itself is not too much code, the call to get the project information interface is wrapped by <code>ModelProducer</code> abstraction, then it enters the Gradle source code, but still belongs to the Gradle client process.</li>
<li>in <code>DefaultDaemonConnector</code> it will try to get an available and compatible daemon process from <code>DaemonRegistry</code>, if not, it will create a new daemon process.</li>
<li>the Daemon process will listen to the fixed port through socket binding after it starts, and then record the listening port and other information about itself into <code>DaemonRegistry</code> for Gradle client to query, get and establish connection.</li>
</ol>
<h3 id="32-how-to-achieve-forward-and-backward-compatibility">3.2 How to achieve forward and backward compatibility?</h3>
<p>Tooling API supports Gradle 2.6 and higher, i.e. one version of Tooling API is forward and backward compatible with other versions of Gradle, and supports calling old or new versions of Gradle for Gradle building, but the interface functions included in Tooling API are not applicable to all Gradle versions; Gradle How is the compatibility between Gradle and Tooling API versions achieved?</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/bdec8fcb474a447cac6e362f21cf4b34.png" alt="sobyte"></p>
<p>Think about a question: If we have two pieces of software: <strong>Main Software A</strong> and <strong>Tooling Software B</strong> dedicated to calling A, how can we achieve maximum and elegant version compatibility between A and B? Here is a deeper analysis of the Tooling API and Gradle source code to see what technical solutions Gradle has adopted in terms of version compatibility that are worthy of attention.</p>
<h4 id="gradle-version-adaptation">Gradle Version Adaptation</h4>
<p>In the Gradle Tooling API source code repository, there is a flowchart that describes the chain of calls to get project information.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/22/7ca6aa24dc6d4554bb13b5e79e7f88b5.png" alt="Gradle Tooling API"></p>
<p>We will focus only on the <code>DefaultConnection</code> in the diagram - the key class for calls from the Tooling API to the Gradle launcher module.</p>
<blockquote>
<p>DefaultConnection has entry points to accept calls from different ToolingAPI versions</p>
</blockquote>
<p>The Tooling API side eventually loads <code>DefaultConnection</code> in <code>DefaultToolingImplementationLoader.java</code> via a custom <code>URLClassLoader</code>, and the custom <code>URLClassLoader</code> class load path specifies the corresponding The custom <code>URLClassLoader</code> class load path specifies the jar package under the lib of the corresponding Gradle version, so that it can load different Gradle versions of <code>DefaultConnection</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">ClassLoader</span> <span class="nf">createImplementationClassLoader</span><span class="o">(</span><span class="n">Distribution</span> <span class="n">distribution</span><span class="o">,</span> <span class="n">ProgressLoggerFactory</span> <span class="n">progressLoggerFactory</span><span class="o">,</span> <span class="n">InternalBuildProgressListener</span> <span class="n">progressListener</span><span class="o">,</span> <span class="n">ConnectionParameters</span> <span class="n">connectionParameters</span><span class="o">,</span> <span class="n">BuildCancellationToken</span> <span class="n">cancellationToken</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ClassPath</span> <span class="n">implementationClasspath</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="na">getToolingImplementationClasspath</span><span class="o">(</span><span class="n">progressLoggerFactory</span><span class="o">,</span> <span class="n">progressListener</span><span class="o">,</span> <span class="n">connectionParameters</span><span class="o">,</span> <span class="n">cancellationToken</span><span class="o">);</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Using tooling provider classpath: {}&#34;</span><span class="o">,</span> <span class="n">implementationClasspath</span><span class="o">);</span>
    <span class="n">FilteringClassLoader</span><span class="o">.</span><span class="na">Spec</span> <span class="n">filterSpec</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilteringClassLoader</span><span class="o">.</span><span class="na">Spec</span><span class="o">();</span>
    <span class="n">filterSpec</span><span class="o">.</span><span class="na">allowPackage</span><span class="o">(</span><span class="s">&#34;org.gradle.tooling.internal.protocol&#34;</span><span class="o">);</span>
    <span class="n">filterSpec</span><span class="o">.</span><span class="na">allowClass</span><span class="o">(</span><span class="n">JavaVersion</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">FilteringClassLoader</span> <span class="n">filteringClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FilteringClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">filterSpec</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">VisitableURLClassLoader</span><span class="o">(</span><span class="s">&#34;tooling-implementation-loader&#34;</span><span class="o">,</span> <span class="n">filteringClassLoader</span><span class="o">,</span> <span class="n">implementationClasspath</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It should be noted that although <code>DefaultConnection</code> is already a Gradle-side source, it is still part of the Gradle client-side process, i.e. a tooling program such as an IDE.</p>
<h4 id="model-class-adaptation">Model Class Adaptation</h4>
<p>The <code>getModel(Class&lt;T&gt; modelType)</code> method can get the project structure information model <code>GradleProject</code> from the Gradle daemon process, while different Gradle versions may have different <code>GradleProject</code> definitions, how can multiple versions of the information model structure be compatible in the same version of the Tooling API?</p>
<p>Before requesting the information model, Tooling API will determine in <code>VersionDetails.java</code> whether the model is supported by the Gradle version, and if so, it will send a request to the daemon process. daemon process will return the information model of the corresponding version, and then send a request to Tooling API&rsquo;s <code>ProtocolToModel</code>. API&rsquo;s <code>ProtocolToModelAdapter.java</code> will encapsulate a layer of dynamic proxy and finally return it as a <code>Proxy</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">createView</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">targetType</span><span class="o">,</span> <span class="n">Object</span> <span class="n">sourceObject</span><span class="o">,</span> <span class="n">ViewDecoration</span> <span class="n">decoration</span><span class="o">,</span> <span class="n">ViewGraphDetails</span> <span class="n">graphDetails</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="c1">// Create a proxy
</span><span class="c1"></span>    <span class="n">InvocationHandlerImpl</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandlerImpl</span><span class="o">(</span><span class="n">targetType</span><span class="o">,</span> <span class="n">sourceObject</span><span class="o">,</span> <span class="n">decorationsForThisType</span><span class="o">,</span> <span class="n">graphDetails</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">viewType</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">viewType</span><span class="o">},</span> <span class="n">handler</span><span class="o">);</span>
    <span class="n">handler</span><span class="o">.</span><span class="na">attachProxy</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">viewType</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The final Tooling API returns a <code>GradleProject</code> that is simply a dynamic proxy interface, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GradleProject</span> <span class="kd">extends</span> <span class="n">HierarchicalElement</span><span class="o">,</span> <span class="n">BuildableElement</span><span class="o">,</span> <span class="n">ProjectModel</span> <span class="o">{</span>
    <span class="o">......</span>
    <span class="n">File</span> <span class="nf">getBuildDirectory</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">UnsupportedMethodException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, even for the supported information models, some of the contents may not be supported due to Gradle version mismatch, and the call will throw <code>UnsupportedMethodException</code> exception.</p>
<p>However, this approach also brings a disadvantage, because the Tooling API side can only get the model information interface, not the real model entity class, then the subsequent serialization or delivery of the whole model information class, you need to do another layer of conversion, to construct a real entity class containing the content, Android sdktools library for the <code>AndroidProject</code> model, the real content of the entity class <code>IdeAndroidProjectImpl</code> constructed.</p>
<h2 id="4-summary">4. Summary</h2>
<p>This article firstly introduces <strong>Gradle Tooling API</strong> from the combination of modern IDE and build system, and introduces its special significance to Gradle build system, then introduces its main functions through the specific API and call examples of Tooling API, and finally analyzes <strong>cross-process communication</strong> and <strong>version compatibility principle</strong>, which are two very important mechanisms in Tooling API, in conjunction with source code.</p>
<p>Through the analysis of Gradle Tooling API, we can have a deep understanding of the overall architecture of Tooling API, so that we can better develop Gradle-capable tooling software based on it, and we can also learn some methodologies in similar <strong>technical architecture scenarios</strong>: when you need to communicate with services dynamically created at program runtime, you can generally introduce As a tool program for external access, when similar programs only provide the command line approach, we should dare to break the rules and provide a new approach, so that we can empower other software to a greater extent and achieve a win-win situation for both sides.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/gradle/">gradle</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/c-va-list-pitfall/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A va_list error case</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/linux-does-a-better-job-of-patching-vulnerabilities/">
            <span class="next-text nav-default">Google Research: Linux does a better job than Apple, Google and Microsoft at patching vulnerabilities</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
