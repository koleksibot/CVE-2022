<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to use higher-order function programming to improve the simplicity of your code - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Functions are first-class citizens of Go language. This article adopts a high-order function approach to abstract the query conditions for querying DB using gorm, abstracting various complex combinations of queries for multiple tables into a unified method and a configuration class, improving the simplicity and elegance of the code, and at the same time can improve the efficiency of developers. Background There is a DB table, and the business needs" /><meta name="keywords" content="golang, Higher Order Function" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/go-higher-order-function/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to use higher-order function programming to improve the simplicity of your code" />
<meta property="og:description" content="Functions are first-class citizens of Go language. This article adopts a high-order function approach to abstract the query conditions for querying DB using gorm, abstracting various complex combinations of queries for multiple tables into a unified method and a configuration class, improving the simplicity and elegance of the code, and at the same time can improve the efficiency of developers. Background There is a DB table, and the business needs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/go-higher-order-function/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-16T15:12:45+08:00" />
<meta property="article:modified_time" content="2022-02-16T15:12:45+08:00" />

<meta itemprop="name" content="How to use higher-order function programming to improve the simplicity of your code">
<meta itemprop="description" content="Functions are first-class citizens of Go language. This article adopts a high-order function approach to abstract the query conditions for querying DB using gorm, abstracting various complex combinations of queries for multiple tables into a unified method and a configuration class, improving the simplicity and elegance of the code, and at the same time can improve the efficiency of developers. Background There is a DB table, and the business needs"><meta itemprop="datePublished" content="2022-02-16T15:12:45+08:00" />
<meta itemprop="dateModified" content="2022-02-16T15:12:45+08:00" />
<meta itemprop="wordCount" content="2951">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use higher-order function programming to improve the simplicity of your code"/>
<meta name="twitter:description" content="Functions are first-class citizens of Go language. This article adopts a high-order function approach to abstract the query conditions for querying DB using gorm, abstracting various complex combinations of queries for multiple tables into a unified method and a configuration class, improving the simplicity and elegance of the code, and at the same time can improve the efficiency of developers. Background There is a DB table, and the business needs"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to use higher-order function programming to improve the simplicity of your code</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-16 15:12:45 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2951 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#solution">Solution</a>
          <ul>
            <li><a href="#beginner">Beginner</a></li>
            <li><a href="#advanced">Advanced</a></li>
            <li><a href="#the-ultimate">The ultimate</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Functions are first-class citizens of Go language. This article adopts a <strong>high-order function</strong> approach to abstract the query conditions for querying DB using gorm, abstracting various complex combinations of queries for multiple tables into a unified method and a configuration class, improving the simplicity and elegance of the code, and at the same time can improve the efficiency of developers.</p>
<h2 id="background">Background</h2>
<p>There is a DB table, and the business needs to do filtering queries by different fields in this table, which is a very common requirement, and I believe this requirement is inseparable for everyone who does business development. For example, we have a table that stores user information, and the simplified table structure is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">user_info</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;自增主键&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;用户id&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">user_name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;用户姓名&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="k">role</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;角色&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">status</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;状态&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="w"> </span><span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;用户信息表&#39;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This table has several key fields, user_id, user_name, role, status. if we want to do filtering by user_id, then we are generally in the dao layer to write a method like this (<strong>for the sake of concise model code, all sample code here omitted the error handling part</strong>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetUserInfoByUid</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">userID</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">db</span> <span class="o">:=</span> <span class="nf">GetDB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
   <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">{}.</span><span class="nf">TableName</span><span class="p">())</span>
   <span class="kd">var</span> <span class="nx">infos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span>
   <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_id = ?&#34;</span><span class="p">,</span> <span class="nx">userID</span><span class="p">)</span>
   <span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">infos</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">infos</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If the business needs to query by user_name, then we need to write a similar method to query by user_name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">func</span> <span class="nf">GetUserInfoByName</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">)</span> <span class="o">([]*</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">db</span> <span class="o">:=</span> <span class="n">GetDB</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
   <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Table</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span><span class="o">{}.</span><span class="na">TableName</span><span class="o">())</span>
   <span class="n">var</span> <span class="n">infos</span> <span class="o">[]*</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span>
   <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Where</span><span class="o">(</span><span class="s">&#34;user_name = ?&#34;</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span>
   <span class="n">db</span><span class="o">.</span><span class="na">Find</span><span class="o">(&amp;</span><span class="n">infos</span><span class="o">)</span>
   <span class="k">return</span> <span class="n">infos</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the code of the two methods <strong>are extremely similar</strong>, and if we need to query by role or status, then we have to come up with several more methods, resulting in a lot of similar methods. Of course, it is easy to think that we can solve this problem by using one method with a few more inputs, so we merged the above two methods <strong>into</strong> the following method, which can support <strong>filtering queries by multiple fields</strong> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">func</span> <span class="nf">GetUserInfo</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">userID</span> <span class="n">int64</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">,</span> <span class="n">role</span> <span class="kt">int</span><span class="o">,</span> <span class="n">status</span> <span class="kt">int</span><span class="o">)</span> <span class="o">([]*</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">db</span> <span class="o">:=</span> <span class="n">GetDB</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
   <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Table</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span><span class="o">{}.</span><span class="na">TableName</span><span class="o">())</span>
   <span class="n">var</span> <span class="n">infos</span> <span class="o">[]*</span><span class="n">resource</span><span class="o">.</span><span class="na">UserInfo</span>
   <span class="k">if</span> <span class="n">userID</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">{</span>
      <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Where</span><span class="o">(</span><span class="s">&#34;user_id = ?&#34;</span><span class="o">,</span> <span class="n">userID</span><span class="o">)</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">{</span>
      <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Where</span><span class="o">(</span><span class="s">&#34;user_name = ?&#34;</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="n">role</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">{</span>
      <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Where</span><span class="o">(</span><span class="s">&#34;role = ?&#34;</span><span class="o">,</span> <span class="n">role</span><span class="o">)</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">{</span>
      <span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">Where</span><span class="o">(</span><span class="s">&#34;status = ?&#34;</span><span class="o">,</span> <span class="n">status</span><span class="o">)</span>
   <span class="o">}</span>
   <span class="n">db</span><span class="o">.</span><span class="na">Find</span><span class="o">(&amp;</span><span class="n">infos</span><span class="o">)</span>
   <span class="k">return</span> <span class="n">infos</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Accordingly, the code that calls this method needs to be changed as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">//只根据UserID查询
infos := GetUserInfo(ctx, userID, &#34;&#34;, 0, 0)
//只根据UserName查询
infos := GetUserInfo(ctx, 0, name, 0, 0)
//只根据Role查询
infos := GetUserInfo(ctx, 0, &#34;&#34;, role, 0)
//只根据Status查询
infos := GetUserInfo(ctx, 0, &#34;&#34;, 0, status)
</code></pre></td></tr></table>
</div>
</div><p>This kind of code can be very difficult for both those who write it and those who read it. We&rsquo;ve only listed four parameters here, so imagine what this code would look like if there were a dozen to 20 fields in the table that needed to be filtered. <strong>First, the GetUserInfo method itself has a lot of parameters</strong> and is full of ! = 0 and ! = &quot;&quot; judgments, and it is important to note that 0 must not be a valid value for the field, otherwise ! = 0 would be a problem. <strong>Secondly, as the caller</strong>, it is clear that only based on a field filter query, but had to fill a 0 or &quot;&quot; for other parameters to occupy, and the caller should be particularly careful, because if you are not careful, you may fill the role to the status position, because they are the same type, the compiler will not check for any errors, it is easy to make business bugs.</p>
<h2 id="solution">Solution</h2>
<p>If there are segments to solve this kind of problem, then the above writeup can only be considered bronze, next we look at silver, gold and king.</p>
<h3 id="beginner">Beginner</h3>
<p>A more common solution to this problem is to <strong>create a new structure</strong>, put the various query fields in this structure, and then pass this structure as an input to the query method in the dao layer. And where the dao method is called, the structure containing the different fields is constructed according to the respective needs. In this example, we can build a UserInfo structure as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">UserInfo</span> <span class="kd">struct</span> <span class="p">{</span>
   <span class="nx">UserID</span> <span class="kt">int64</span>
   <span class="nx">Name</span> <span class="kt">string</span>
   <span class="nx">Role</span> <span class="kt">int32</span>
   <span class="nx">Status</span> <span class="kt">int32</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Passing UserInfo as an input to the GetUserInfo method makes the GetUserInfo method look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">info</span> <span class="o">*</span><span class="nx">UserInfo</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">db</span> <span class="o">:=</span> <span class="nf">GetDB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
   <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">{}.</span><span class="nf">TableName</span><span class="p">())</span>
   <span class="kd">var</span> <span class="nx">infos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span>
   <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">UserID</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_id = ?&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Name</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
      <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_name = ?&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Role</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;role = ?&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Role</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Status</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;status = ?&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">infos</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">infos</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Accordingly, the code that calls this method needs to be changed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//只根据userD查询
</span><span class="c1"></span><span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">UserInfo</span><span class="p">{</span>
   <span class="nx">UserID</span><span class="p">:</span> <span class="nx">userID</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">infos</span> <span class="o">:=</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span>
<span class="c1">//只根据name查询
</span><span class="c1"></span><span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">UserInfo</span><span class="p">{</span>
   <span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">infos</span> <span class="o">:=</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>This code is actually much better than the initial approach, at least the dao layer method <strong>has been changed from many inputs to one</strong> and the caller&rsquo;s code can <strong>build parameters</strong> according to their needs without the need for many null placeholders. But the problem is also obvious: there are still a lot of null judgments, and a <strong>redundant structure</strong> is introduced. It would be a shame if we ended there.</p>
<p>In addition, if we extend the business scenario, we use not equal-value queries, but <strong>multiple-value queries or interval queries</strong>, such as the query status in (a, b), then how to extend the above code? Is it necessary to introduce a method, the method is tedious aside, what is the name of the method will let us tangle for a long time; perhaps we can try to expand each parameter from a single value into an array, and then assign the value of the place from = to in () way, all the parameters of the query use in obviously not so friendly to performance.</p>
<h3 id="advanced">Advanced</h3>
<p>Next we look at the golden solution. In the above method, we introduced a redundant structure and couldn&rsquo;t avoid doing a lot of null assignment in the dao layer methods. So can we not introduce the redundant structure UserInfo and avoid these ugly null assignments as well? The answer is yes, <strong>functional programming</strong> can solve this problem very well, first we need to define a function type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Define Option to be a function whose input type is *gorm.DB and whose return value is null.</p>
<p>Then define a function for each field in the DB table that needs to be filtered for a query, and assign a value to that field, like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">UserID</span><span class="p">(</span><span class="nx">userID</span> <span class="kt">int64</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;`user_id` = ?&#34;</span><span class="p">,</span> <span class="nx">userID</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">UserName</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;`user_name` = ?&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">Role</span><span class="p">(</span><span class="nx">role</span> <span class="kt">int32</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;`role` = ?&#34;</span><span class="p">,</span> <span class="nx">role</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">Status</span><span class="p">(</span><span class="nx">status</span> <span class="kt">int32</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;`status` = ?&#34;</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above set of code, the input is a filter value of a field that returns an Option function, and the function&rsquo;s function is to assign the input to the current [db *gorm.DB] object. This is what we mentioned at the beginning of the article <strong>higher-order functions</strong>, not unlike our ordinary functions, which return a simple type of value or a wrapped type of structure, this higher-order function returns a function with a certain function. Here more than one sentence, although the go language well supported functional programming, but due to its <strong>currently lack of support for generic</strong> , resulting in the use of higher-order function programming does not bring more convenience to developers, so in the usual business code to write higher-order functions or slightly rare. And developers familiar with JAVA know that JAVA Map, Reduce, Filter and other higher-order functions are very comfortable to use.</p>
<p>Well, with this set of functions, let&rsquo;s look at the dao layer of the query method how to write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="nx">option</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">))</span> <span class="p">([]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">db</span> <span class="o">:=</span> <span class="nf">GetDB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
   <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">{}.</span><span class="nf">TableName</span><span class="p">())</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">option</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
      <span class="nf">option</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">infos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span>
   <span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">infos</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">infos</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>By comparing the method with the one at the beginning, you can see that the method&rsquo;s input <strong>has been changed from a number of different types of parameters to a set of functions of the same type</strong>, so when dealing with these parameters, there is no need to judge the null one by one, but directly use a for loop to get it done, which is much more concise than before.</p>
<p>So how to write the code to call the method, here it is given directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//只使用userID查询
</span><span class="c1"></span><span class="nx">infos</span> <span class="o">:=</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nf">UserID</span><span class="p">(</span><span class="nx">userID</span><span class="p">))</span>
<span class="c1">//只使用userName查询
</span><span class="c1"></span><span class="nx">infos</span> <span class="o">:=</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nf">UserName</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
<span class="c1">//使用role和status同时查询
</span><span class="c1"></span><span class="nx">infos</span> <span class="o">:=</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nf">Role</span><span class="p">(</span><span class="nx">role</span><span class="p">),</span> <span class="nf">Status</span><span class="p">(</span><span class="nx">status</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>Whether we use any single parameter or a combination of multiple parameters to query, we can write it as we like, without paying attention to the order of the parameters, which is concise and clear, and the readability is also very good.</p>
<p>Consider the <strong>extension scenario</strong> mentioned above. If we need a multi-value query, such as querying multiple status, then we just need to add a small function to Option.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">StatusIn</span><span class="p">(</span><span class="nx">status</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;`status` in ?&#34;</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The same is true for other fields or equivalent queries, and the simplicity of the code speaks for itself.</p>
<h3 id="the-ultimate">The ultimate</h3>
<p>If you can optimize to the above advanced stage, it&rsquo;s already very clean, and it&rsquo;s perfectly fine if you stop there. But if you want to go further and pursue the ultimate, then please read on!</p>
<p>In the above method, we have already solved the problem of cumbersome code for a table with multiple field combinations through higher-order functions, but for different table queries, we still have to write a query method for each table, so <strong>is there room for further optimization</strong>? We find that this set of higher-order functions defined in Option has nothing to do with a table at all, but simply assigns values to gorm.DB. So if we have multiple tables, each with common fields like user_id, is_deleted, create_time, and update_time, then we don&rsquo;t need to define them all over again, <strong>just one in Option</strong>, and we can reuse them for each table query. Thinking further, we find that Option maintains some silly code that we don&rsquo;t need to write manually each time, <strong>we can use script generation</strong> to scan through the DB tables and generate an Equal method, In method, Greater method, Less method for each non-repeating field, which can solve all the tables to do equal-value queries, multi-value queries, interval queries by different fields This can solve the problem of equal-value queries, multi-value queries, and interval queries in all tables by different fields.</p>
<p>After solving the problem of Option, for each table of various combinations of queries, you only need to write a very simple Get method, for the convenience of seeing, we post here again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetUserInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="nx">option</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">))</span> <span class="p">([]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">db</span> <span class="o">:=</span> <span class="nf">GetDB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
   <span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">{}.</span><span class="nf">TableName</span><span class="p">())</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">option</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
      <span class="nf">option</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="kd">var</span> <span class="nx">infos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span>
   <span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">infos</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">infos</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above query method is written for the user_info table, if there are other tables, we need to write a Get method similar to this one for each table. If we take a closer look at the Get method for each table, we will see that there are two differences between these methods.</p>
<ul>
<li>The return value type is different.</li>
<li>TableName is not the same.</li>
</ul>
<p>If we can solve these two problems, then we can <strong>solve all table queries</strong> using one method. First of all, for the first point of inconsistent return values, we can refer to json.unmarshal and pass in the return type as a parameter, because the pointer type is passed in, so we don&rsquo;t need to give the return value again; and for the problem of inconsistent tableName, we can actually add an Option method in the same way as above for different parameters to to solve the problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TableName</span><span class="p">(</span><span class="nx">tableName</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">db</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="nx">tableName</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After this transformation, our dao-level query method looks like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetRecord</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="nx">option</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">))</span> <span class="p">{</span>
   <span class="nx">db</span> <span class="o">:=</span> <span class="nf">GetDB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">option</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
      <span class="nf">option</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span>
   <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that we have changed the method name from GetUserInfo to <strong>GetRecord</strong> because this method supports queries not only for the user_info table, but for all tables in a library. This means that instead of having one class for each table and many query methods under each class, we now have <strong>One method for all queries for all tables</strong>.</p>
<p>Then let&rsquo;s see how the code to call this method is written.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//根据userID和userName查询
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">infos</span> <span class="p">[]</span><span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span>
<span class="nf">GetRecord</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">infos</span><span class="p">,</span> <span class="nf">TableName</span><span class="p">(</span><span class="nx">resource</span><span class="p">.</span><span class="nx">UserInfo</span><span class="p">{}.</span><span class="nf">TableName</span><span class="p">()),</span> <span class="nf">UserID</span><span class="p">(</span><span class="nx">userID</span><span class="p">),</span> <span class="nf">UserName</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>The example of querying the user_info table is still given here, specifying the tableName and return type in the call.</p>
<p>After this transformation, we end up with a simple method [<strong>GetRecord</strong>] + <strong>an auto-generatable configuration class</strong> [<strong>Option</strong>] for multiple combinations of queries for all tables in a library. The simplicity and elegance of the code has been improved a bit more. The downside is that the query method is called with two extra parameters, one for the return value variable and one for the tableName, which is a bit less aesthetically pleasing.</p>
<h2 id="summary">Summary</h2>
<p>The abstraction of the grom query conditions here greatly simplifies the writing of the DB combination query and improves the simplicity of the code. For other update, insert, delete operations, you can also borrow this idea to do a certain degree of simplification, because of space relations we do not repeat here.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/java-callable/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">In-depth analysis of the Callable interface</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/windows10-wsl/">
            <span class="next-text nav-default">Windows 10 WSL2 Experience</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
