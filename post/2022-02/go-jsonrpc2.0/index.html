<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Implementation of jsonrpc2.0 in Go - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="request Request can represent a request or notification from jsorpc2.0. 1 2 3 4 5 6 7 8 type Request struct { Method string `json:&amp;#34;method&amp;#34;` Params *json.RawMessage `json:&amp;#34;params,omitempty&amp;#34;` ID ID `json:&amp;#34;id&amp;#34;` Notif bool `json:&amp;#34;-&amp;#34;` Meta *json.RawMessage `json:&amp;#34;meta,omitempty&amp;#34;` } The Meta field is not specified in the jsonrpc spec, but is an aid to tracking context. The Notif field indicates whether it is a notification or not. The Params/Meta fields are" /><meta name="keywords" content="golang, Jsonrpc2" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/go-jsonrpc2.0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Implementation of jsonrpc2.0 in Go" />
<meta property="og:description" content="request Request can represent a request or notification from jsorpc2.0. 1 2 3 4 5 6 7 8 type Request struct { Method string `json:&#34;method&#34;` Params *json.RawMessage `json:&#34;params,omitempty&#34;` ID ID `json:&#34;id&#34;` Notif bool `json:&#34;-&#34;` Meta *json.RawMessage `json:&#34;meta,omitempty&#34;` } The Meta field is not specified in the jsonrpc spec, but is an aid to tracking context. The Notif field indicates whether it is a notification or not. The Params/Meta fields are" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/go-jsonrpc2.0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-19T12:22:00+08:00" />
<meta property="article:modified_time" content="2022-02-19T12:22:00+08:00" />

<meta itemprop="name" content="Implementation of jsonrpc2.0 in Go">
<meta itemprop="description" content="request Request can represent a request or notification from jsorpc2.0. 1 2 3 4 5 6 7 8 type Request struct { Method string `json:&#34;method&#34;` Params *json.RawMessage `json:&#34;params,omitempty&#34;` ID ID `json:&#34;id&#34;` Notif bool `json:&#34;-&#34;` Meta *json.RawMessage `json:&#34;meta,omitempty&#34;` } The Meta field is not specified in the jsonrpc spec, but is an aid to tracking context. The Notif field indicates whether it is a notification or not. The Params/Meta fields are"><meta itemprop="datePublished" content="2022-02-19T12:22:00+08:00" />
<meta itemprop="dateModified" content="2022-02-19T12:22:00+08:00" />
<meta itemprop="wordCount" content="4466">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementation of jsonrpc2.0 in Go"/>
<meta name="twitter:description" content="request Request can represent a request or notification from jsorpc2.0. 1 2 3 4 5 6 7 8 type Request struct { Method string `json:&#34;method&#34;` Params *json.RawMessage `json:&#34;params,omitempty&#34;` ID ID `json:&#34;id&#34;` Notif bool `json:&#34;-&#34;` Meta *json.RawMessage `json:&#34;meta,omitempty&#34;` } The Meta field is not specified in the jsonrpc spec, but is an aid to tracking context. The Notif field indicates whether it is a notification or not. The Params/Meta fields are"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Implementation of jsonrpc2.0 in Go</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-19 12:22:00 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4466 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#request">request</a></li>
        <li><a href="#response">Response</a></li>
        <li><a href="#conn">Conn</a>
          <ul>
            <li><a href="#objectstream">ObjectStream</a></li>
            <li><a href="#handler">Handler</a></li>
            <li><a href="#call">call</a></li>
            <li><a href="#logger">Logger</a></li>
            <li><a href="#conn-analysis">Conn analysis</a></li>
            <li><a href="#anymessage">anyMessage</a></li>
            <li><a href="#conns-read-concatenation">Conn&rsquo;s read concatenation</a></li>
            <li><a href="#conns-implementation-of-the-jsonrpc2-interface">Conn&rsquo;s implementation of the JSONRPC2 interface</a></li>
          </ul>
        </li>
        <li><a href="#reanalysis">Reanalysis</a></li>
        <li><a href="#the-last-piece">The last piece</a></li>
        <li><a href="#use-in-ion-sfu">Use in ion-sfu</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="request">request</h2>
<p>Request can represent a request or notification from jsorpc2.0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Method</span> <span class="kt">string</span>           <span class="s">`json:&#34;method&#34;`</span>
  <span class="nx">Params</span> <span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;params,omitempty&#34;`</span>
  <span class="nx">ID</span>     <span class="nx">ID</span>               <span class="s">`json:&#34;id&#34;`</span>
  <span class="nx">Notif</span>  <span class="kt">bool</span>             <span class="s">`json:&#34;-&#34;`</span>

  <span class="nx">Meta</span> <span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;meta,omitempty&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Meta field is not specified in the jsonrpc spec, but is an aid to tracking context. The Notif field indicates whether it is a notification or not. The Params/Meta fields are all json serialized strings.</p>
<p>This Request has several methods:</p>
<ul>
<li>MarshalJSON serialized to json string</li>
<li>UnmarshalJSON deserializes the json string into a Request object.</li>
<li>SetParams/SetMeta to set the Params/Meta fields respectively.</li>
</ul>
<p>The ID is also specified in the spec, and can be a string/value/null. The current implementation of this package does not support IDs that are</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ID</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Num</span> <span class="kt">uint64</span>
  <span class="nx">Str</span> <span class="kt">string</span>

  <span class="nx">IsString</span> <span class="kt">bool</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>In most cases, there is always a non-zero value for Num and Str, and when both are zero, IsString is used to distinguish which field is used as the id:</p>
<ul>
<li>String supports printing</li>
<li>MarshalJSON serialization</li>
<li>UnmarshalJSON deserialization</li>
</ul>
<h2 id="response">Response</h2>
<p>Response is a response only and does not contain a notification.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Response</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ID</span>     <span class="nx">ID</span>               <span class="s">`json:&#34;id&#34;`</span>
  <span class="nx">Result</span> <span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;result,omitempty&#34;`</span>
  <span class="nx">Error</span>  <span class="o">*</span><span class="nx">Error</span>           <span class="s">`json:&#34;error,omitempty&#34;`</span>

  <span class="nx">Meta</span> <span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;meta,omitempty&#34;`</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Result and Error are only one kind of return. In case of an error, there is a special kind of error that is simply ignored for simplicity: the request ID error.</p>
<p>Response also contains several methods:</p>
<ul>
<li>MarshalJSON serialized to a json string</li>
<li>UnmarshalJSON deserialize to Response object</li>
<li>SetResult SetResult field</li>
</ul>
<p>As you can see from the source code here, Request and Response use two different ways of writing when serializing and deserializing, which is a strange trick the author is showing.</p>
<p>Response.Error in the spec is clearly defined:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Error</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Code</span>    <span class="kt">int64</span>            <span class="s">`json:&#34;code&#34;`</span>
  <span class="nx">Message</span> <span class="kt">string</span>           <span class="s">`json:&#34;message&#34;`</span>
  <span class="nx">Data</span>    <span class="o">*</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;data&#34;`</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Method of Error:</p>
<ul>
<li>SetError sets the Data in Error</li>
<li>Error implements the error interface.</li>
</ul>
<p>The following are the errors specified in the spec</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">const (
  CodeParseError     = -32700
  CodeInvalidRequest = -32600
  CodeMethodNotFound = -32601
  CodeInvalidParams  = -32602
  CodeInternalError  = -32603
)

</code></pre></td></tr></table>
</div>
</div><h2 id="conn">Conn</h2>
<p>Conn is the connection between client and server of json-rpc, client and server are symmetric, so both client and server will use Conn object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Conn</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">stream</span> <span class="nx">ObjectStream</span>

  <span class="nx">h</span> <span class="nx">Handler</span>

  <span class="nx">mu</span>       <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
  <span class="nx">shutdown</span> <span class="kt">bool</span>
  <span class="nx">closing</span>  <span class="kt">bool</span>
  <span class="nx">seq</span>      <span class="kt">uint64</span>
  <span class="nx">pending</span>  <span class="kd">map</span><span class="p">[</span><span class="nx">ID</span><span class="p">]</span><span class="o">*</span><span class="nx">call</span>

  <span class="nx">sending</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

  <span class="nx">disconnect</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>

  <span class="nx">logger</span> <span class="nx">Logger</span>

  <span class="nx">onRecv</span> <span class="p">[]</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="o">*</span><span class="nx">Response</span><span class="p">)</span>
  <span class="nx">onSend</span> <span class="p">[]</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="o">*</span><span class="nx">Response</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Conn involves a lot of other objects, let&rsquo;s analyze them one by one, and finally look at the functions Conn provides.</p>
<h3 id="objectstream">ObjectStream</h3>
<p>ObjectStreram, a bidirectional stream of jsonrpc2.9 objects, through which jsonrpc2.0 objects can be written to the stream, and objects can be retrieved from the stream.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ObjectStream</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">WriteObject</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
  <span class="nf">ReadObject</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>

  <span class="nx">io</span><span class="p">.</span><span class="nx">Closer</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Looking at the implementation types through GoImplements, we see that bufferedObjectStream and one of the sub-package types are also implemented. Let&rsquo;s look at bufferedObjectStream first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">bufferedObjectStream</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">conn</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Closer</span> <span class="c1">// all writes should go through w, all reads through r
</span><span class="c1"></span>  <span class="nx">w</span>    <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Writer</span>
  <span class="nx">r</span>    <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span>

  <span class="nx">codec</span> <span class="nx">ObjectCodec</span>

  <span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>ReadWriteCloser to send and receive objects (jsonrpc2.0 objects). Before analyzing the bufferedObjectStream, let&rsquo;s take a look at the ObjectCodec:</p>
<p>ObjectCodec specifies how to encode and decode jsonrpc2.0 objects in the stream.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ObjectCodec</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">WriteObject</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
  <span class="nf">ReadObject</span><span class="p">(</span><span class="nx">stream</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>There are two types that implement ObjectCodec, indicating the existence of two types of encoding: VarintObjectCodec and VSCodeObjectCodec.</p>
<p>VarintObjectCodec is called header variable length, the header is the length, first look at the write object:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">type</span> <span class="nx">VarintObjectCodec</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="kd">func</span> <span class="p">(</span><span class="nx">VarintObjectCodec</span><span class="p">)</span> <span class="nf">WriteObject</span><span class="p">(</span>
      <span class="nx">stream</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">buf</span> <span class="p">[</span><span class="nx">binary</span><span class="p">.</span><span class="nx">MaxVarintLen64</span><span class="p">]</span><span class="kt">byte</span>
      <span class="nx">b</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nf">PutUvarint</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:],</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)))</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">b</span><span class="p">]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>MaxVarintLen64 is 10, which means the maximum number of bits of int64 is 10. binary. So the flow of VarintObjectCodec.WriteObject is as follows:</p>
<ul>
<li>Serialize the data to json</li>
<li>Write the binary encoded length to stream</li>
<li>Write the json serialized data to stream</li>
</ul>
<p>Because the length of json serialization is variable, this encoding method is also called variable length encoding.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">VarintObjectCodec</span><span class="p">)</span> <span class="nf">ReadObject</span><span class="p">(</span>
  <span class="nx">stream</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nf">ReadUvarint</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nf">LimitReader</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">b</span><span class="p">))).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>First read a binary encoded uint64 length from the stream, and then read a fixed length data from the stream, this data is the json serialized data, deserialization can be.</p>
<p>The remaining encoding format is VSCodeObjectCodec, which contains the length and type in the header, which is an encoding format defined by Microsoft in lsp.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">VSCodeObjectCodec</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">VSCodeObjectCodec</span><span class="p">)</span> <span class="nf">WriteObject</span><span class="p">(</span>
  <span class="nx">stream</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span>
      <span class="nx">stream</span><span class="p">,</span> <span class="s">&#34;Content-Length: %d\r\n\r\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>As you can see, the Content-Type is fixed (json serialized data), so in the implementation, only the length is specified, the length and content before a blank line, and the newline is &lsquo;\r\n&rsquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">func</span> <span class="p">(</span><span class="nx">VSCodeObjectCodec</span><span class="p">)</span> <span class="nf">ReadObject</span><span class="p">(</span>
      <span class="nx">stream</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">contentLength</span> <span class="kt">uint64</span>
      <span class="k">for</span> <span class="p">{</span>
        <span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">ReadByte</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">b</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">`jsonrpc2: line endings must be \r\n`</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">line</span> <span class="o">==</span> <span class="s">&#34;\r&#34;</span> <span class="p">{</span>
          <span class="k">break</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;Content-Length: &#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;Content-Length: &#34;</span><span class="p">)</span>
          <span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
          <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
          <span class="nx">contentLength</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseUint</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">contentLength</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;jsonrpc2: no Content-Length header found&#34;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nf">LimitReader</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">contentLength</span><span class="p">))).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>ReadString(), read directly to the specified character, with the specified character. HasPrefix(), determine if the prefix of a string is xxx. strings. TrimSpace(), remove the first and last spaces.</p>
<p>Use a for loop, very cleverly the two &lsquo;\r\n&rsquo; are handled, for loop exit, just the length of the content is also calculated. Finally, call the json library to do the deserialization.</p>
<p>Here after the two json encoding methods, let&rsquo;s come back to bufferedObjectStream.</p>
<p>First look at the bufferedObjectStream implementation of ObjectStream:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">bufferedObjectStream</span><span class="p">)</span> <span class="nf">WriteObject</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">WriteObject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">w</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
<span class="p">}</span>
<span class="c1">// 最后还是通过具体的编码方式对象去实现写对象
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">bufferedObjectStream</span><span class="p">)</span> <span class="nf">ReadObject</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">codec</span><span class="p">.</span><span class="nf">ReadObject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">bufferedObjectStream</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>More specific analysis: bufferedObjectStream is not exported, through the constructor NewBufferedStream to construct.
Furthermore, reading and writing objects to the stream is done through specific encoding objects,
Therefore, bufferedObjectStream actually provides a representation of the stream, which is specified by NewBufferedStream.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewBufferedStream</span><span class="p">(</span>
  <span class="nx">conn</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriteCloser</span><span class="p">,</span> <span class="nx">codec</span> <span class="nx">ObjectCodec</span><span class="p">)</span> <span class="nx">ObjectStream</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">bufferedObjectStream</span><span class="p">{</span>
    <span class="nx">conn</span><span class="p">:</span>  <span class="nx">conn</span><span class="p">,</span>
    <span class="nx">w</span><span class="p">:</span>     <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span>
    <span class="nx">r</span><span class="p">:</span>     <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">conn</span><span class="p">),</span>
    <span class="nx">codec</span><span class="p">:</span> <span class="nx">codec</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>ReadWriteCloser. From this constructor, we can see that the stream object for reading and writing is io.</p>
<p>At this point, we are done analyzing ObjectStream-related stuff (except for the sub-packages). Let&rsquo;s go back to the Conn object.</p>
<h3 id="handler">Handler</h3>
<p>The second field in the Conn structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">Handle</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Handler is an interface for handling jsonrpc requests and notifications,
Handle() is handled one request at a time, if there is no requirement for the order, you can use the asynchronous version of AsyncHandler.
We first look at the synchronous version of HandlerWithErrorConfigurer, and then look at the asynchronous version of AsyncHandler.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">HandlerWithErrorConfigurer</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">handleFunc</span> <span class="kd">func</span><span class="p">(</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
  <span class="nx">suppressErrClosed</span> <span class="kt">bool</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>This structure is relatively simple and contains a function and a flag. The constructor is HandlerWithError:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">HandlerWithError</span><span class="p">(</span><span class="nx">handleFunc</span>
  <span class="kd">func</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="p">))</span> <span class="o">*</span><span class="nx">HandlerWithErrorConfigurer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">HandlerWithErrorConfigurer</span><span class="p">{</span><span class="nx">handleFunc</span><span class="p">:</span> <span class="nx">handleFunc</span><span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The implementation of the Handler is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">HandlerWithErrorConfigurer</span><span class="p">)</span> <span class="nf">Handle</span><span class="p">(</span>
      <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">conn</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">handleFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Notif</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">conn</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;jsonrpc2 handler: notification %q handling error: %v\n&#34;</span><span class="p">,</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span>
      <span class="p">}</span>

      <span class="nx">resp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ID</span><span class="p">}</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">Error</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
          <span class="nx">resp</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">e</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resp</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Error</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">Notif</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">SendResponse</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">ErrClosed</span> <span class="o">||</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nx">suppressErrClosed</span> <span class="p">{</span>
            <span class="nx">conn</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;jsonrpc2 handler: sending response %s: %v\n&#34;</span><span class="p">,</span>
              <span class="nx">resp</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The processing flow is as follows:</p>
<ul>
<li>The handler is specified at the time of construction, and the handler is called at this time.
<ul>
<li>If Request is a notification, if there is an error, it will be recorded; if not, it will be finished.</li>
</ul>
</li>
<li>If Request is a request, then the processing function returns the result
<ul>
<li>Construct a Response</li>
<li>SendResponse to send a response</li>
</ul>
</li>
</ul>
<p>The HandlerWithErrorConfigurer also supports ignoring connection closure errors. Next look at the asynchronous Handler:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">AsyncHandler</span><span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">)</span> <span class="nx">Handler</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">asyncHandler</span><span class="p">{</span><span class="nx">h</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">asyncHandler</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Handler</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">asyncHandler</span><span class="p">)</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">conn</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">go</span> <span class="nx">h</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Asynchronous is relatively simple, directly embedded in a Handler interface object, using go to do asynchronous processing. Note that the constructor AsyncHandler is exposed, the implementation object asyncHandler structure is not exposed. Because the asyncHandler has a Hanlder embedded in it, the HanlderWithErrorConfigurer will eventually be used.</p>
<h3 id="call">call</h3>
<p>call represents the entire life cycle of a jsonrpc call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">call</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">request</span>  <span class="o">*</span><span class="nx">Request</span>
  <span class="nx">response</span> <span class="o">*</span><span class="nx">Response</span>
  <span class="nx">seq</span>      <span class="kt">uint64</span> <span class="c1">// the seq of the request
</span><span class="c1"></span>  <span class="nx">done</span>     <span class="kd">chan</span> <span class="kt">error</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p><code>map[ID]call</code> is used to log all calls.</p>
<h3 id="logger">Logger</h3>
<p>Logging, the standard library log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Logger</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">Printf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="conn-analysis">Conn analysis</h3>
<p>Ensure that Conn implements the JSONRPC2 interface</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">_</span> <span class="nx">JSONRPC2</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">Conn</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">NewConn</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">stream</span> <span class="nx">ObjectStream</span><span class="p">,</span>
  <span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">ConnOpt</span><span class="p">)</span> <span class="o">*</span><span class="nx">Conn</span> <span class="p">{</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Conn</span><span class="p">{</span>
    <span class="nx">stream</span><span class="p">:</span>     <span class="nx">stream</span><span class="p">,</span>
    <span class="nx">h</span><span class="p">:</span>          <span class="nx">h</span><span class="p">,</span>
    <span class="nx">pending</span><span class="p">:</span>    <span class="kd">map</span><span class="p">[</span><span class="nx">ID</span><span class="p">]</span><span class="o">*</span><span class="nx">call</span><span class="p">{},</span>
    <span class="nx">disconnect</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">logger</span><span class="p">:</span>     <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">LstdFlags</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">opt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="nf">opt</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">readMessages</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The whole construction is quite interesting, ObjectStream and Handler are both interfaces that need to be constructed before they can be passed in. The logs are finally thrown into os.Stderr. The construction also does two things:</p>
<ul>
<li>Iterate over the opt, and process the constructed Conn.</li>
<li>Open the read (concurrently)</li>
</ul>
<p>ConnOpt provides custom handling of Conn. readMessages() is the read concurrent, before we dive in, let&rsquo;s analyze the anyMessage type:</p>
<h3 id="anymessage">anyMessage</h3>
<p>anyMessage represents a Request or a Response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">anyMessage</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">request</span>  <span class="o">*</span><span class="nx">Request</span>
  <span class="nx">response</span> <span class="o">*</span><span class="nx">Response</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">anyMessage</span><span class="p">)</span> <span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{}</span>
  <span class="k">switch</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
    <span class="nx">v</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span>
  <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
    <span class="nx">v</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">v</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
    <span class="s">&#34;jsonrpc2: message must have exactly \
</span><span class="s">    one of the request or response fields set&#34;</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>json serialization is the call to serialize Request or Response.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">anyMessage</span><span class="p">)</span> <span class="nf">UnmarshalJSON</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="kd">type</span> <span class="nx">msg</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">ID</span>     <span class="kd">interface</span><span class="p">{}</span>              <span class="s">`json:&#34;id&#34;`</span>
        <span class="nx">Method</span> <span class="o">*</span><span class="kt">string</span>                  <span class="s">`json:&#34;method&#34;`</span>
        <span class="nx">Result</span> <span class="nx">anyValueWithExplicitNull</span> <span class="s">`json:&#34;result&#34;`</span>
        <span class="nx">Error</span>  <span class="kd">interface</span><span class="p">{}</span>              <span class="s">`json:&#34;error&#34;`</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">isRequest</span><span class="p">,</span> <span class="nx">isResponse</span> <span class="kt">bool</span>
      <span class="nx">checkType</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">msg</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">mIsRequest</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="kc">nil</span>
        <span class="nx">mIsResponse</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Result</span><span class="p">.</span><span class="nx">null</span> <span class="o">||</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Result</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nx">mIsRequest</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">mIsResponse</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">mIsRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">mIsResponse</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
            <span class="s">&#34;jsonrpc2: unable to determine message type (request or response)&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mIsRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">isResponse</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">mIsResponse</span> <span class="o">&amp;&amp;</span> <span class="nx">isRequest</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
            <span class="s">&#34;jsonrpc2: batch message type mismatch (must be all requests or all responses)&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">isRequest</span> <span class="p">=</span> <span class="nx">mIsRequest</span>
        <span class="nx">isResponse</span> <span class="p">=</span> <span class="nx">mIsResponse</span>
        <span class="k">return</span> <span class="kc">nil</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="nx">isArray</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">;</span> <span class="nx">isArray</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">msgs</span> <span class="p">[]</span><span class="nx">msg</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">msgs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;jsonrpc2: invalid empty batch&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">msgs</span> <span class="p">{</span>
          <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkType</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">msg</span><span class="p">{</span>
            <span class="nx">ID</span><span class="p">:</span>     <span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ID</span><span class="p">,</span>
            <span class="nx">Method</span><span class="p">:</span> <span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Method</span><span class="p">,</span>
            <span class="nx">Result</span><span class="p">:</span> <span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Result</span><span class="p">,</span>
            <span class="nx">Error</span><span class="p">:</span>  <span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Error</span><span class="p">,</span>
          <span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">m</span> <span class="nx">msg</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkType</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{}</span>
      <span class="k">switch</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">isRequest</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">isResponse</span><span class="p">:</span>
        <span class="nx">v</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">request</span>
      <span class="k">case</span> <span class="p">!</span><span class="nx">isRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">isResponse</span><span class="p">:</span>
        <span class="nx">v</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">response</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">isRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">isResponse</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Error</span> <span class="o">==</span> <span class="kc">nil</span>
          <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Result</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Result</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">jsonNull</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>This piece of code can be divided into three pieces:</p>
<ul>
<li>Define a detection function, this function can detect after deserialization, is Request or Response</li>
<li>json deserialization, and then use the detection function to determine, support Request array or Response array</li>
<li>json deserialization to the specified object</li>
</ul>
<h3 id="conns-read-concatenation">Conn&rsquo;s read concatenation</h3>
<p>Read concurrently is started at the time of Conn construction</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 这个读协程分了两大步:
</span><span class="c1">// 循环读；退出循环之后的资源释放
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">readMessages</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="k">for</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>

    <span class="c1">// 从stream中读数据
</span><span class="c1"></span>    <span class="c1">// 当读失败时,退出for循环,这也是唯一退出循环的方式
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">m</span> <span class="nx">anyMessage</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nf">ReadObject</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">{</span>

    <span class="c1">// 如果是Request,先调用onRecv做前处理,在调用Handler来处理请求
</span><span class="c1"></span>    <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">onRecv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">onRecv</span> <span class="p">{</span>
        <span class="nf">onRecv</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">h</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span>

    <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
      <span class="nx">resp</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span>
      <span class="k">if</span> <span class="nx">resp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">id</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">ID</span>

        <span class="c1">// 如果是Response,先从待处理列表pending中删除
</span><span class="c1"></span>        <span class="c1">// 因为收到了响应,意味着一次请求已经闭环
</span><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
        <span class="nx">call</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
        <span class="nb">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">pending</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">call</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">call</span><span class="p">.</span><span class="nx">response</span> <span class="p">=</span> <span class="nx">resp</span>
        <span class="p">}</span>

        <span class="c1">// 对Response的一些后处理
</span><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">onRecv</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span>
          <span class="k">if</span> <span class="nx">call</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="p">=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">request</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">onRecv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">onRecv</span> <span class="p">{</span>
            <span class="nf">onRecv</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// 最后的错误处理分3类
</span><span class="c1"></span>        <span class="c1">// 错误处理之后都会将此次请求-响应的生命周期标记为完结
</span><span class="c1"></span>        <span class="k">switch</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">call</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
          <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
            <span class="s">&#34;jsonrpc2: ignoring response #%s with no corresponding request\n&#34;</span><span class="p">,</span>
            <span class="nx">id</span><span class="p">)</span>

        <span class="k">case</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
          <span class="nx">call</span><span class="p">.</span><span class="nx">done</span> <span class="o">&lt;-</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Error</span>
          <span class="nb">close</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>

        <span class="k">default</span><span class="p">:</span>
          <span class="nx">call</span><span class="p">.</span><span class="nx">done</span> <span class="o">&lt;-</span> <span class="kc">nil</span>
          <span class="nb">close</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// stream读失败后,退出循环,释放资源
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">sending</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">closing</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closing</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">closing</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrClosed</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">call</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pending</span> <span class="p">{</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">done</span> <span class="o">&lt;-</span> <span class="nx">err</span>
    <span class="nb">close</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">sending</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">closing</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;jsonrpc2: protocol error: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="conns-implementation-of-the-jsonrpc2-interface">Conn&rsquo;s implementation of the JSONRPC2 interface</h3>
<p>JSONRPC2 interface, Call method is a standard request, Notify is a notification request, Close is to close the relevant connection.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">JSONRPC2</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span>
    <span class="nx">result</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opt</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span>
  <span class="nf">Notify</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span>
    <span class="nx">params</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opt</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span>
  <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Implementation of Call:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span>
  <span class="nx">result</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

  <span class="c1">//  封装一个请求
</span><span class="c1"></span>  <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Method</span><span class="p">:</span> <span class="nx">method</span><span class="p">}</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">SetParams</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="c1">// 对请求的前处理
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">opt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 发送请求
</span><span class="c1"></span>  <span class="nx">call</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anyMessage</span><span class="p">{</span><span class="nx">request</span><span class="p">:</span> <span class="nx">req</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="c1">// 等待返回
</span><span class="c1"></span>  <span class="k">select</span> <span class="p">{</span>

  <span class="c1">// 成功返回(从stream上读取到响应)
</span><span class="c1"></span>  <span class="k">case</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">call</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrClosed</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">result</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">call</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Result</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Result</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">jsonNull</span>
      <span class="p">}</span>

      <span class="c1">// 最后将响应中的result返回
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="o">*</span><span class="nx">call</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>

  <span class="c1">// 超时或被取消
</span><span class="c1"></span>  <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
    <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The implementation of Notify is a little different from the standard request in that there is no response to the Notify request, and it returns when it is sent:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Notify</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
  <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Method</span><span class="p">:</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">Notif</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">SetParams</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">opt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anyMessage</span><span class="p">{</span><span class="nx">request</span><span class="p">:</span> <span class="nx">req</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Notify is similar to Call in implementation, except that it does not have to wait for a response. In addition, the Notify request does not have an id, so the Call preprocessing must add an ID to the Request.</p>
<p>The implementation of Close:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closing</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">ErrClosed</span>
  <span class="p">}</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">closing</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Here are the other methods of Conn:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// send, 请求和响应都是通过此函数去发送的
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">send</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">m</span> <span class="o">*</span><span class="nx">anyMessage</span><span class="p">,</span>
  <span class="nx">wait</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">call</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">sending</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sending</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

  <span class="kd">var</span> <span class="nx">id</span> <span class="nx">ID</span>

  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closing</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrClosed</span>
  <span class="p">}</span>

  <span class="c1">// 如果是标准请求,需要维护一个pending列表
</span><span class="c1"></span>  <span class="c1">// 里面每一个元素,表示一次请求的完整生命周期
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">wait</span> <span class="p">{</span>
    <span class="nx">cc</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">call</span><span class="p">{</span><span class="nx">request</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">seq</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">seq</span><span class="p">,</span> <span class="nx">done</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">IsString</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">Num</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">Num</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">seq</span>
    <span class="p">}</span>
    <span class="nx">id</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">ID</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">pending</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">cc</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">seq</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

  <span class="c1">// 发送之前的统一前处理
</span><span class="c1"></span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">onSend</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="p">(</span>
      <span class="nx">req</span>  <span class="o">*</span><span class="nx">Request</span>
      <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
    <span class="p">)</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
      <span class="nx">req</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">request</span>
    <span class="k">case</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
      <span class="nx">resp</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">response</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">onSend</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">onSend</span> <span class="p">{</span>
      <span class="nf">onSend</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 一旦出错,不用等待,直接从pending列表中删除
</span><span class="c1"></span>  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">cc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
        <span class="nb">delete</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">pending</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}()</span>

  <span class="c1">// 调用ObjectStream将jsonrpc对象写入到流中
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nf">WriteObject</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Conn.Reply returns a response (success); Conn.ReplyWithError returns a failed response The response will have an id corresponding to the id of the request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Reply</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="nx">ID</span><span class="p">,</span> <span class="nx">result</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">resp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="nx">id</span><span class="p">}</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anyMessage</span><span class="p">{</span><span class="nx">response</span><span class="p">:</span> <span class="nx">resp</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">ReplyWithError</span><span class="p">(</span>
  <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="nx">ID</span><span class="p">,</span> <span class="nx">respErr</span> <span class="o">*</span><span class="nx">Error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anyMessage</span><span class="p">{</span>
      <span class="nx">response</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">Error</span><span class="p">:</span> <span class="nx">respErr</span><span class="p">}},</span> <span class="kc">false</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">SendResponse</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">anyMessage</span><span class="p">{</span><span class="nx">response</span><span class="p">:</span> <span class="nx">resp</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>At the end there is also a way to get the &ldquo;disconnected channel&rdquo;:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">DisconnectNotify</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">disconnect</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="reanalysis">Reanalysis</h2>
<p>By now the source code of jsonrpc2 package has been finished, but it is all silos, no overall understanding. Please jump to <a href="#%E6%9C%80%E5%90%8E%E4%B8%80%E7%89%87">subpackage websocket</a></p>
<p>So far, the following extensions are provided:</p>
<ul>
<li>OnSend/OnRecv, the pre-processing for receiving and sending</li>
<li>Handler, how to deal with the request, this piece of business logic</li>
<li>ObjectStream, this through the sub-package, to determine the use of websocket</li>
</ul>
<p>When we analyzed this, we realized that a lot of the structure is for testing purposes, but in fact the whole jsonrpc2 provides a relatively simple functionality. This package, except for the testing part, is very simple.</p>
<h2 id="the-last-piece">The last piece</h2>
<p>bufferedObjectStream provides an implementation of ObjectStream, but based on bufio, the subpackage sourcegraph/jsonrpc2/websocket is the websocket-based jsonrpc2 stream.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ObjectStream</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">conn</span> <span class="o">*</span><span class="nx">ws</span><span class="p">.</span><span class="nx">Conn</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewObjectStream</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ws</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="nx">ObjectStream</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">ObjectStream</span><span class="p">{</span><span class="nx">conn</span><span class="p">:</span> <span class="nx">conn</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">ObjectStream</span><span class="p">)</span> <span class="nf">WriteObject</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">WriteJSON</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">ObjectStream</span><span class="p">)</span> <span class="nf">ReadObject</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">ReadJSON</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">ws</span><span class="p">.</span><span class="nx">CloseError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Code</span> <span class="o">==</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">CloseAbnormalClosure</span> <span class="o">&amp;&amp;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">Text</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">ObjectStream</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The ws here refers to gorilla/websocket.</p>
<p>With this subpackage, all sending and receiving is websocket based.</p>
<h2 id="use-in-ion-sfu">Use in ion-sfu</h2>
<p>Only the Conn object is used, and the disconnected channel is listened to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">jc</span> <span class="o">:=</span> <span class="nx">jsonrpc2</span><span class="p">.</span><span class="nf">NewConn</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="nx">websocketjsonrpc2</span><span class="p">.</span><span class="nf">NewObjectStream</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">p</span><span class="p">)</span>
<span class="o">&lt;-</span><span class="nx">jc</span><span class="p">.</span><span class="nf">DisconnectNotify</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>So sourcegraph/jsonrpc2 has a lot of extensions, but the ion project only uses ObjectStream and Handler, and ObjectStream is extended to websocket with a sub-package, and Handler is not clear:</p>
<p>The third parameter in jsonrpc2.NewConn is the Handler, we first analyze when it will be called, and finally analyze what is inside the Handler.</p>
<p>The above analysis of Conn, said: in the construction of Conn, will create a read concurrent, in this read concurrent, there is a for loop has been reading from the stream (read from the websocket), which read the Request, will call Handler to handle:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">c.h.Handle(ctx, c, m.request)
</code></pre></td></tr></table>
</div>
</div><p>At this point, only then will the Handle() of the Handler interface be called. Handler call time is found, to see the specific processing logic:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">s</span> <span class="o">:=</span> <span class="nx">sfu</span><span class="p">.</span><span class="nf">NewSFU</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
<span class="nx">p</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewJSONSignal</span><span class="p">(</span><span class="nx">sfu</span><span class="p">.</span><span class="nf">NewPeer</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/ios-wkwebview/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">iOS WKWebView detailed explanation and JS Bridge synchronization call problem</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/async-in-map/">
            <span class="next-text nav-default">Using async functions in Map traversal</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
