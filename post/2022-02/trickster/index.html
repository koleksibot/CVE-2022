<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Trickster Usage - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Introduction Trickster is comcast&amp;rsquo;s open source HTTP reverse proxy cache that speeds up TSDB (time series databases, such as Prometheus) queries. Purpose Use Trickster to proxy Prometheus in a k8s cluster to verify that Trickster can speed up Grafana queries. Note: Prometheus and Grafana are already deployed in the cluster Installation According to the official documentation, Trickster provides the following installation methods. Docker k8s Helm Source code installation For this" /><meta name="keywords" content="trickster" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/trickster/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Trickster Usage" />
<meta property="og:description" content="Introduction Trickster is comcast&rsquo;s open source HTTP reverse proxy cache that speeds up TSDB (time series databases, such as Prometheus) queries. Purpose Use Trickster to proxy Prometheus in a k8s cluster to verify that Trickster can speed up Grafana queries. Note: Prometheus and Grafana are already deployed in the cluster Installation According to the official documentation, Trickster provides the following installation methods. Docker k8s Helm Source code installation For this" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/trickster/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-23T10:20:08+08:00" />
<meta property="article:modified_time" content="2022-02-23T10:20:08+08:00" />

<meta itemprop="name" content="Trickster Usage">
<meta itemprop="description" content="Introduction Trickster is comcast&rsquo;s open source HTTP reverse proxy cache that speeds up TSDB (time series databases, such as Prometheus) queries. Purpose Use Trickster to proxy Prometheus in a k8s cluster to verify that Trickster can speed up Grafana queries. Note: Prometheus and Grafana are already deployed in the cluster Installation According to the official documentation, Trickster provides the following installation methods. Docker k8s Helm Source code installation For this"><meta itemprop="datePublished" content="2022-02-23T10:20:08+08:00" />
<meta itemprop="dateModified" content="2022-02-23T10:20:08+08:00" />
<meta itemprop="wordCount" content="714">
<meta itemprop="keywords" content="trickster," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Trickster Usage"/>
<meta name="twitter:description" content="Introduction Trickster is comcast&rsquo;s open source HTTP reverse proxy cache that speeds up TSDB (time series databases, such as Prometheus) queries. Purpose Use Trickster to proxy Prometheus in a k8s cluster to verify that Trickster can speed up Grafana queries. Note: Prometheus and Grafana are already deployed in the cluster Installation According to the official documentation, Trickster provides the following installation methods. Docker k8s Helm Source code installation For this"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Trickster Usage</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-23 10:20:08 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 714 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#purpose">Purpose</a></li>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#install-via-helm">Install via Helm</a></li>
          </ul>
        </li>
        <li><a href="#verification">Verification</a>
          <ul>
            <li><a href="#experiment-1">Experiment 1</a></li>
            <li><a href="#experiment-2">Experiment 2</a></li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#principle">Principle</a></li>
        <li><a href="#caution">Caution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/23/1fb86b1b134a4d4d954d80e3104f78cd.png" alt="Trickster"></p>
<h2 id="introduction">Introduction</h2>
<p><a href="https://github.com/trickstercache/trickster">Trickster</a> is comcast&rsquo;s open source HTTP reverse proxy cache that speeds up TSDB (time series databases, such as Prometheus) queries.</p>
<h2 id="purpose">Purpose</h2>
<p>Use Trickster to proxy Prometheus in a k8s cluster to verify that Trickster can speed up Grafana queries.</p>
<blockquote>
<p>Note: Prometheus and Grafana are already deployed in the cluster</p>
</blockquote>
<h2 id="installation">Installation</h2>
<p>According to the <a href="https://github.com/trickstercache/trickster#installing">official documentation</a>, Trickster provides the following installation methods.</p>
<ul>
<li>Docker</li>
<li>k8s</li>
<li>Helm</li>
<li>Source code installation</li>
</ul>
<p>For this installation via Helm, see <a href="https://helm.tricksterproxy.io/">here</a> for the installation steps.</p>
<h3 id="install-via-helm">Install via Helm</h3>
<p>Add the Trickster Helm repo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">helm repo add tricksterproxy https://helm.tricksterproxy.io
</code></pre></td></tr></table>
</div>
</div><p>To see if it was added successfully.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># helm search repo tricksterproxy</span>
NAME                    	CHART VERSION	APP VERSION	DESCRIPTION
tricksterproxy/trickster	1.5.4        	1.1        	Trickster is an HTTP Reverse Proxy Cache and ti...
</code></pre></td></tr></table>
</div>
</div><p>Here, you need to look at the configuration information of Trickster, namely <a href="https://github.com/trickstercache/helm-charts/blob/main/charts/trickster/values.yaml">values.yaml</a></p>
<p>In order to get Trickster up and running, the following configuration items need to be noted in this configuration file values.yaml.</p>
<p><strong>origins</strong></p>
<p>In the originURL, fill in the existing Prometheus address, i.e. Trickster will proxy this address and cache the query data</p>
<p><strong>caches</strong></p>
<p>Trickster supports a variety of cache types, such as: memory, bbolt, badger, filesystem and redis, which uses memory cache is the default way, based on <a href="https://pkg.go.dev/sync#Map">sync.Map</a>, here we will directly use the default It is recommended to use filesystem and redis for production environment.</p>
<p><strong>replicaCount</strong></p>
<p>The number of pods, the default is 1, here is also the direct use of the default value</p>
<p><strong>service</strong></p>
<p>That is, the way k8s services are exposed, here using the lb way to expose services, you need to configure the annotations inside: <strong>service</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">service.beta.kubernetes.io/alibaba-cloud-loadbalancer-force-override-listeners: <span class="s2">&#34;true&#34;</span>
service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id: 这里填写 lb 实例 id
service.beta.kubernetes.io/alicloud-loadbalancer-protocol-port: http:80
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: AliCloud k8s cluster is used</p>
</blockquote>
<p>and change the type inside the service to: LoadBalancer.</p>
<p><strong>ingress</strong></p>
<p>If the above service exposure method is not LoadBalancer, and you want to expose the service through ingress, you can modify the ingress configuration item</p>
<p><strong>resources</strong></p>
<p>The limits and requests configuration for resources, filled in here, is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">4Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Installation by command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">helm upgrade -i trickster tricksterproxy/trickster -f values.yaml --namespace monitoring --debug
</code></pre></td></tr></table>
</div>
</div><p>Install trickster using a custom values.yaml, installed under the monitoring namespace, with the installation process in debug mode, which outputs a detailed installation process.</p>
<p>To check if the installation was successful, you can directly visit the <code>http://lb-IP:8480/trickster/ping</code> address and perform a health check.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">curl http://lb-IP:8480/trickster/ping
pong
</code></pre></td></tr></table>
</div>
</div><p>In addition, you can directly visit: <code>http://lb-IP:8480/metrics</code> to view Trickster&rsquo;s metrics data</p>
<blockquote>
<p>Note: Here the service is exposed via lb, lb-IP is the IP address of lb, 8480 is the default proxy port of Trickster</p>
</blockquote>
<h2 id="verification">Verification</h2>
<p>Now let&rsquo;s see if the same queries in Grafana are sped up after using Trickster, and by how much.</p>
<p>First, add a new data source to the existing Grafana with the Trickster reverse proxy URL: <code>http://lb-IP:8480</code></p>
<p>Find a more time-consuming query panel, do two experiments, each experiment has two groups, the data source are the native Prometheus and Trickster to Prometheus made a proxy, each group experiments refresh panel 15 times, through Grafana&rsquo;s Query Inspector to see each refresh query time, the results are as follows.</p>
<h3 id="experiment-1">Experiment 1</h3>
<p>Check the data of this panel for the past 1 hour, refresh time is 10s, result.</p>
<p>Native Prometheus query time total: 42s, average query time: 2.8s
Trickster query time total: 13.899s, the average query time: 0.9266s</p>
<h3 id="experiment-2">Experiment 2</h3>
<p>View the data of this panel for the past 3 hours, refresh time is 10s, the result.</p>
<p>Native Prometheus query time total: 108s, average query time: 7.2s
Trickster query time total: 22.579s, the average query time: 1.505s</p>
<h2 id="conclusion">Conclusion</h2>
<p>Preliminary verification that Trickster can speed up the queries of temporal databases such as Prometheus.</p>
<h2 id="principle">Principle</h2>
<p>So why does Trickster speed up Prometheus queries?</p>
<p>Because every time a dashboard is loaded or reloaded, most dashboards request the entire time range of data from the time series database, while Trickster&rsquo;s Delta Proxy checks the time range of the client query to determine which data points have been cached and requests only the data points that are really needed on Prometheus, an incremental query that will significantly speed up the chart load time.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/23/3ae80e178be446e687568d76a1ac5d82.png" alt="sobyte"></p>
<h2 id="caution">Caution</h2>
<ul>
<li>The above procedure is only for testing the use of Trickster, for reference</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/trickster/">trickster</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/elon-musk-is-a-fan-of-rust/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Musk: I&#39;m a Rust fan, but would choose C for performance</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/checksum-mismatch-error/">
            <span class="next-text nav-default">Go Modules - checksum mismatch error resolution</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
