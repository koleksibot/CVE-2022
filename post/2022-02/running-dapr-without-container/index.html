<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Running dapr in a non-container (cluster) environment - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="dapr, which I have been following for some time, has been officially released in v1.0 (in fact, v1.0.1 was updated when this article was published), which means that dapr has entered a stable state to some extent and can be tried in practice. As a project I&amp;rsquo;ve been following, I tried it out in the first place and tried to introduce it into a real project, and this article is" /><meta name="keywords" content="dapr" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/running-dapr-without-container/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Running dapr in a non-container (cluster) environment" />
<meta property="og:description" content="dapr, which I have been following for some time, has been officially released in v1.0 (in fact, v1.0.1 was updated when this article was published), which means that dapr has entered a stable state to some extent and can be tried in practice. As a project I&rsquo;ve been following, I tried it out in the first place and tried to introduce it into a real project, and this article is" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/running-dapr-without-container/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-07T12:50:25+08:00" />
<meta property="article:modified_time" content="2022-02-07T12:50:25+08:00" />

<meta itemprop="name" content="Running dapr in a non-container (cluster) environment">
<meta itemprop="description" content="dapr, which I have been following for some time, has been officially released in v1.0 (in fact, v1.0.1 was updated when this article was published), which means that dapr has entered a stable state to some extent and can be tried in practice. As a project I&rsquo;ve been following, I tried it out in the first place and tried to introduce it into a real project, and this article is"><meta itemprop="datePublished" content="2022-02-07T12:50:25+08:00" />
<meta itemprop="dateModified" content="2022-02-07T12:50:25+08:00" />
<meta itemprop="wordCount" content="1416">
<meta itemprop="keywords" content="dapr," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Running dapr in a non-container (cluster) environment"/>
<meta name="twitter:description" content="dapr, which I have been following for some time, has been officially released in v1.0 (in fact, v1.0.1 was updated when this article was published), which means that dapr has entered a stable state to some extent and can be tried in practice. As a project I&rsquo;ve been following, I tried it out in the first place and tried to introduce it into a real project, and this article is"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Running dapr in a non-container (cluster) environment</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-07 12:50:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1416 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-dapr">What is dapr?</a></li>
        <li><a href="#local-installation">Local installation</a></li>
        <li><a href="#adding-redis-as-a-component">Adding Redis as a component</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/07/1062c86926e44bd3b7e05ae7fb447df2.png" alt="sobyte"></p>
<p><code>dapr</code>, which I have been following for some time, has been officially released in v1.0 (in fact, v1.0.1 was updated when this article was published), which means that <code>dapr</code> has entered a stable state to some extent and can be tried in practice. As a project I&rsquo;ve been following, I tried it out in the first place and tried to introduce it into a real project, and this article is some preliminary testing for that.</p>
<h2 id="what-is-dapr">What is dapr?</h2>
<p><code>dapr</code> was first open sourced by Microsoft, a portable, event-driven program runtime that makes it easy for any developer to build resilient, stateless/stateful applications running in the cloud and on the edge, with the flexibility to support multiple development languages. In other words, in my opinion, <code>dapr</code> can be seen and handled as a <code>serverless</code> landing solution for programs that are only concerned with the provided store and message queue interfaces and don&rsquo;t need to care about more than the architectural level.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/07/82852abfbfe74aaa85751896fa41166c.png" alt="sobyte"></p>
<p>However, in the official example tutorial, the environment used is a container environment to deploy and manage dapr. In fact, <code>dapr</code> can be configured to run in self-hosted mode on the local machine, except in a container environment or container cluster environment.</p>
<h2 id="local-installation">Local installation</h2>
<p>The <code>dapr</code> installation can be done with the official <code>dapr-cli</code>, which can be quickly installed with the one-click install command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash</span>
Your system is linux_amd64

Dapr CLI is detected:
main: line 86: <span class="m">43656</span> Segmentation fault      <span class="nv">$DAPR_CLI_FILE</span> --version
Reinstalling Dapr CLI - /usr/local/bin/dapr...

Getting the latest Dapr CLI...
Installing v1.0.0 Dapr CLI...
Downloading https://github.com/dapr/cli/releases/download/v1.0.0/dapr_linux_amd64.tar.gz ...
dapr installed into /usr/local/bin successfully.
CLI version: 1.0.0
Runtime version: n/a

To get started with Dapr, please visit https://docs.dapr.io/getting-started/
</code></pre></td></tr></table>
</div>
</div><p>You can confirm that the <code>dapr-cli</code> program was installed successfully by entering the <code>dapr</code> command.</p>
<p>Next, use dapr-cli to install all runtime and other applications.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># dapr init --slim</span>
⌛  Making the jump to hyperspace...
↘  Downloading binaries and setting up components...
Dapr runtime installed to /root/.dapr/bin, you may run the following to add it to your path <span class="k">if</span> you want to run daprd directly:
    <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/root/.dapr/bin
✅  Downloaded binaries and completed components <span class="nb">set</span> up.
ℹ️  daprd binary has been installed to /root/.dapr/bin.
ℹ️  placement binary has been installed to /root/.dapr/bin.
✅  Success! Dapr is up and running. To get started, go here: https://aka.ms/dapr-getting-started

<span class="c1"># dapr --version</span>
CLI version: 1.0.0
Runtime version: 1.0.1
</code></pre></td></tr></table>
</div>
</div><p>In the official documentation, if you choose to initialize with the <code>init</code> command, <code>dapr-cli</code> will automatically try to use the container environment to manage related programs, and will only choose to run locally if you add the <code>-slim</code> argument. See the <code>dapr help init</code> help for more information on usage. By default, program-related content is installed in the <code>$HOME/.dapr</code> directory, here I used the <code>root</code> user for simplicity, so the program command directory is <code>/root/.dapr/bin</code>, and the following commands are installed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ls ~/.dapr/bin</span>
daprd  dashboard  placement  web
</code></pre></td></tr></table>
</div>
</div><p>From the file name you can see that <code>daprd</code> is the deamon process, <code>dashboard</code> is the management panel, and <code>placement</code> is the tool used to manage the <code>actor</code> distribution scheme and key range. The official documentation mentions that <code>Reids</code> will be used as the default storage and pub/sub components after installation, but my actual installation is actually not there, I don&rsquo;t know if the documentation is a bit out of date. If you start the program and try to save the data in the store according to the official documentation example, you will get an error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// 第一个session中执行：
<span class="c1"># dapr run --app-id myapp --dapr-http-port 3500</span>

// 第二个session中执行：
<span class="c1"># curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;[{ &#34;key&#34;: &#34;name&#34;, &#34;value&#34;: &#34;Bruce Wayne&#34;}]&#39; http://localhost:3500/v1.0/state/statestore</span>

<span class="o">{</span><span class="s2">&#34;errorCode&#34;</span>:<span class="s2">&#34;ERR_STATE_STORES_NOT_CONFIGURED&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;state store is not configured&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>But actually adding components is relatively easy in <code>dapr</code>, by adding the corresponding <code>yaml</code> file under <code>$HOME/.dapr/components</code>.</p>
<h2 id="adding-redis-as-a-component">Adding Redis as a component</h2>
<p>We can find a <code>Redis</code> component configuration template in the <a href="https://docs.dapr.io/operations/components/setup-state-store/supported-state-stores/setup-redis/"><code>official documentation</code></a> that It can be quickly used to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># redis-store.yml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">dapr.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Component</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-store</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">state.redis</span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redisHost</span><span class="w">
</span><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">6379</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redisPassword</span><span class="w">
</span><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Of course, we can also use the <code>Redis Stream</code> function to do pub/sub functions, although this function has been GA, but because of the characteristics of <code>Redis Stream</code>, you need to be careful with this function, here just because it is a demonstration so it does not matter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># redis-pubsub.yml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">dapr.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Component</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-pubsub</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pubsub.redis</span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redisHost</span><span class="w">
</span><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">6379</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redisPassword</span><span class="w">
</span><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">consumerID</span><span class="w">
</span><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;myGroup&#34;</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Here we have defined a <code>store</code> called <code>redis-store</code>, so we need to modify the above command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># curl -X POST -H &#34;Content-Type: application/json&#34; -d &#39;[{ &#34;key&#34;: &#34;name&#34;, &#34;value&#34;: &#34;Bruce Wayne&#34;}]&#39; http://localhost:3500/v1.0/state/redis-store</span>

// 获取存储内容
<span class="c1"># curl http://localhost:3500/v1.0/state/redis-store/name</span>
<span class="s2">&#34;Bruce Wayne&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>You can also get the content stored in <code>Redis</code> through <code>redis-cli</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># redis-cli</span>
127.0.0.1:6379&gt; keys *
1<span class="o">)</span> <span class="s2">&#34;myapp||name&#34;</span>
127.0.0.1:6379&gt; hgetall <span class="s2">&#34;myapp||name&#34;</span>
1<span class="o">)</span> <span class="s2">&#34;data&#34;</span>
2<span class="o">)</span> <span class="s2">&#34;\&#34;Bruce Wayne\&#34;&#34;</span>
3<span class="o">)</span> <span class="s2">&#34;version&#34;</span>
4<span class="o">)</span> <span class="s2">&#34;1&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>When we added <code>Redis</code> as storage, we also added <code>Redis</code> to support publish/subscribe functionality. Here you may need to write additional programs to implement it. Let&rsquo;s use the official example here. There are two types of subscriptions in <code>dapr</code>, one is in the form of a <code>yaml</code> declaration component, and the other can be implemented by writing code. Of course, the first and second approaches have advantages and disadvantages, the former being more suitable for seamless integration and the latter for development control. Here, for the sake of intuitiveness, we directly use the code-writing approach.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/dapr/subscribe&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="p">[]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
			<span class="p">{</span>
				<span class="s">&#34;pubsubname&#34;</span><span class="p">:</span> <span class="s">&#34;redis-pubsub&#34;</span><span class="p">,</span>
				<span class="s">&#34;topic&#34;</span><span class="p">:</span>      <span class="s">&#34;deathStarStatus&#34;</span><span class="p">,</span>
				<span class="s">&#34;route&#34;</span><span class="p">:</span>      <span class="s">&#34;dsstatus&#34;</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">})</span>
	<span class="p">})</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/dsstatus&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&#34;success&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
	<span class="p">})</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;127.0.0.1:5000&#34;</span><span class="p">)</span>
<span class="p">}</span>


</code></pre></td></tr></table>
</div>
</div><p>Start the compiled <code>daprdemo</code> with the following command, note that you need to fill in the path when specifying the file name or in <code>$PATH</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># dapr --app-id subapp --app-port 5000 run ~/daprdemo</span>
</code></pre></td></tr></table>
</div>
</div><p>In the program startup log we can see that <code>dapr</code> tries to access some default <code>endpoint</code> to read possible configurations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">INFO<span class="o">[</span>0000<span class="o">]</span> application discovered on port <span class="m">5000</span>           <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.runtime <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
<span class="o">==</span> <span class="nv">APP</span> <span class="o">==</span> <span class="o">[</span>GIN<span class="o">]</span> 2021/03/11 - 10:45:02 <span class="p">|</span> <span class="m">404</span> <span class="p">|</span>         949ns <span class="p">|</span>       127.0.0.1 <span class="p">|</span> GET      <span class="s2">&#34;/dapr/config&#34;</span>

INFO<span class="o">[</span>0000<span class="o">]</span> application configuration loaded              <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.runtime <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
INFO<span class="o">[</span>0000<span class="o">]</span> actor runtime started. actor idle timeout: 1h0m0s. actor scan interval: 30s  <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.runtime.actor <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
<span class="o">==</span> <span class="nv">APP</span> <span class="o">==</span> <span class="o">[</span>GIN<span class="o">]</span> 2021/03/11 - 10:45:02 <span class="p">|</span> <span class="m">200</span> <span class="p">|</span>     540.891µs <span class="p">|</span>       127.0.0.1 <span class="p">|</span> GET      <span class="s2">&#34;/dapr/subscribe&#34;</span>

INFO<span class="o">[</span>0000<span class="o">]</span> app is subscribed to the following topics: <span class="o">[</span>deathStarStatus<span class="o">]</span> through <span class="nv">pubsub</span><span class="o">=</span>redis-pubsub  <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.runtime <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
WARN<span class="o">[</span>0000<span class="o">]</span> redis streams: BUSYGROUP Consumer Group name already exists  <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.contrib <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
INFO<span class="o">[</span>0000<span class="o">]</span> dapr initialized. Status: Running. Init Elapsed 49.674504ms  <span class="nv">app_id</span><span class="o">=</span>subapp <span class="nv">instance</span><span class="o">=</span>127.0.0.1 <span class="nv">scope</span><span class="o">=</span>dapr.runtime <span class="nv">type</span><span class="o">=</span>log <span class="nv">ver</span><span class="o">=</span>1.0.1
</code></pre></td></tr></table>
</div>
</div><p>Next we try to use <code>dapr-cli</code> to send a message to the <code>myapp</code> we started earlier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">dapr publish --publish-app-id myapp --pubsub redis-pubsub --topic deathStarStatus --data <span class="s1">&#39;{&#34;status&#34;: &#34;completed&#34;}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>The output obtained in the program log is .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">== APP == [GIN] 2021/03/11 - 10:45:05 | 200 |      122.15µs |       127.0.0.1 | POST     &#34;/dsstatus&#34;

== APP == 2021/03/11 10:45:05 {&#34;id&#34;:&#34;9c237504-7cab-4a13-8582-92d9130fd016&#34;,&#34;source&#34;:&#34;myapp&#34;,&#34;pubsubname&#34;:&#34;redis-pubsub&#34;,&#34;traceid&#34;:&#34;00-fba669a086f84650e882e3cadc55082c-ea466c080e359e68-00&#34;,&#34;data&#34;:{&#34;status&#34;:&#34;completed&#34;},&#34;specversion&#34;:&#34;1.0&#34;,&#34;datacontenttype&#34;:&#34;application/json&#34;,&#34;type&#34;:&#34;com.dapr.event.sent&#34;,&#34;topic&#34;:&#34;deathStarStatus&#34;}
</code></pre></td></tr></table>
</div>
</div><p>Of course, in addition to the pub/sub approach, we can also use the routing capabilities provided by <code>dapr</code> to make service calls directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># curl http://127.0.0.1:3500/v1.0/invoke/subapp/method/dsstatus -X POST</span>
<span class="o">{</span><span class="s2">&#34;success&#34;</span>:true<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Other component functions can be configured by referring to the description in the official documentation.</p>
<h2 id="summary">Summary</h2>
<p><code>dapr</code> is a powerful <code>serverless</code> runtime that, in addition to the above-mentioned message- and request-store-oriented features, can also control <code>HTTP</code> requests and <code>gRPC</code> requests of an application, etc. In addition to these features, service management is included, as well as observability support, making it a very promising runtime choice.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/dapr/">dapr</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/nats-server-usage/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Comparison of NATS-Server (JetStream) and NATS Streaming Server</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/clash-tproxy/">
            <span class="next-text nav-default">Raspberry Pi Clash Transparent Proxy (TProxy) </span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
