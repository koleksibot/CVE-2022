<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Windows 10 WSL2 Experience - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. Introduction to WSL Wikipedia. Windows Subsystem for Linux (English: Windows Subsystem for Linux, WSL for short) is a compatibility layer for being able to run Linux binary executables (ELF format) natively on Windows 10 and Windows Server 2019. This means that you can execute Linux programs on Windows with the help of WSL. For developers, this makes a lot of sense. High-level language development generally relies on a graphical" /><meta name="keywords" content="windows10, wsl" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/windows10-wsl/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Windows 10 WSL2 Experience" />
<meta property="og:description" content="1. Introduction to WSL Wikipedia. Windows Subsystem for Linux (English: Windows Subsystem for Linux, WSL for short) is a compatibility layer for being able to run Linux binary executables (ELF format) natively on Windows 10 and Windows Server 2019. This means that you can execute Linux programs on Windows with the help of WSL. For developers, this makes a lot of sense. High-level language development generally relies on a graphical" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/windows10-wsl/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-16T09:51:58+08:00" />
<meta property="article:modified_time" content="2022-02-16T09:51:58+08:00" />

<meta itemprop="name" content="Windows 10 WSL2 Experience">
<meta itemprop="description" content="1. Introduction to WSL Wikipedia. Windows Subsystem for Linux (English: Windows Subsystem for Linux, WSL for short) is a compatibility layer for being able to run Linux binary executables (ELF format) natively on Windows 10 and Windows Server 2019. This means that you can execute Linux programs on Windows with the help of WSL. For developers, this makes a lot of sense. High-level language development generally relies on a graphical"><meta itemprop="datePublished" content="2022-02-16T09:51:58+08:00" />
<meta itemprop="dateModified" content="2022-02-16T09:51:58+08:00" />
<meta itemprop="wordCount" content="2278">
<meta itemprop="keywords" content="windows,wsl," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Windows 10 WSL2 Experience"/>
<meta name="twitter:description" content="1. Introduction to WSL Wikipedia. Windows Subsystem for Linux (English: Windows Subsystem for Linux, WSL for short) is a compatibility layer for being able to run Linux binary executables (ELF format) natively on Windows 10 and Windows Server 2019. This means that you can execute Linux programs on Windows with the help of WSL. For developers, this makes a lot of sense. High-level language development generally relies on a graphical"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Windows 10 WSL2 Experience</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-16 09:51:58 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2278 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction-to-wsl">1. Introduction to WSL</a>
          <ul>
            <li><a href="#11-wsl-vs-virtual-machine">1.1 WSL vs Virtual Machine</a></li>
          </ul>
        </li>
        <li><a href="#2-wsl2-try">2. WSL2 try</a>
          <ul>
            <li><a href="#21-wsl-dynamic-ip-how-to-access-from-outside">2.1 WSL dynamic IP, how to access from outside?</a></li>
            <li><a href="#22-how-do-i-install-docker-without-installing-docker-desktop">2.2 How do I install Docker without installing Docker Desktop?</a></li>
            <li><a href="#23-how-do-win-and-wsl-systems-interoperate">2.3 How do Win and WSL systems interoperate?</a></li>
          </ul>
        </li>
        <li><a href="#3-problems-with-wsl2">3. Problems with WSL2</a>
          <ul>
            <li><a href="#31-wsl-and-virtualbox-for-hyper-v-conflict">3.1 WSL and VirtualBox for Hyper-v conflict</a></li>
            <li><a href="#32-centos6-has-problems-running-on-wsl2-docker">3.2 Centos6 has problems running on wsl2 docker</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-introduction-to-wsl">1. Introduction to WSL</h2>
<p>Wikipedia.</p>
<blockquote>
<p>Windows Subsystem for Linux (English: Windows Subsystem for Linux, WSL for short) is a compatibility layer for being able to run Linux binary executables (ELF format) natively on Windows 10 and Windows Server 2019.</p>
</blockquote>
<p>This means that you can execute Linux programs on Windows with the help of <code>WSL</code>. For developers, this makes a lot of sense.</p>
<p>High-level language development generally relies on a graphical <code>Integrated Development Environment (IDE)</code>, so the development environment systems are usually <code>Windows</code> or <code>OSX</code>. <code>OSX</code> was developed from the <code>Unix</code> system, so it comes with a command line terminal, which is developer friendly; while <code>Windows</code> naturally supports graphical operations, and although there are <code>cmd</code> and <code>PowerShell</code> terminals that support simple command lines, they are ultimately limited in functionality and cannot replace <code>Linux</code> functionality.</p>
<p>For example, if you are developing on Windows and need to replace <code>172.16.12.13</code> with <code>141.151.1.111</code> for all configuration files in a directory and its subdirectories, you don&rsquo;t know which configuration file contains the string to be replaced and there are many such files scattered around. It would be a lot of work to find it manually on <code>Windows</code> or to write a <code>bat</code> script, whereas on <code>Linux</code> it only takes one command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#该命令递归寻找当前目录及子目录后缀是txt的文件并执行替换字符串</span>
find . -type f -name <span class="s1">&#39;*.txt&#39;</span> -exec sed -i <span class="s1">&#39;s/172.16.12.13/141.151.1.111/g&#39;</span> <span class="o">{}</span> <span class="se">\;</span> 
</code></pre></td></tr></table>
</div>
</div><p>As you can see, development efficiency would be greatly enhanced if <code>Windows</code> could use <code>Linux</code> system programs.</p>
<p>Microsoft made an attempt to be compatible with <code>Unix like</code> on <code>Windows</code> systems, and first introduced <code>WSL1</code>, which had a big problem with file system performance. Then came <code>WSL2</code>, where the underlying implementation was different from <code>WSL1</code> and the file system performance was greatly improved. The difference between <code>WSL1</code> and <code>WSL2</code> can be found at <a href="https://docs.microsoft.com/en-us/windows/wsl/compare-versions">https://docs.microsoft.com/en-us/windows/wsl/compare-versions</a>.</p>
<p>There are a lot of complaints about <code>WSL</code> on the Internet, which is difficult to use. I personally practice, using <code>WSL2</code> can have a good development experience, but there are some headaches, here to record some solutions.</p>
<h3 id="11-wsl-vs-virtual-machine">1.1 WSL vs Virtual Machine</h3>
<p>If you want to run a <code>Linux</code> distribution on a <code>Windows</code> system, you can install a virtual machine before you have a <code>WSL</code>.</p>
<p>Compare a virtual machine with <code>WSL2</code>, where the file system is completely isolated from the host; the latter is interconnected.</p>
<p><code>WSL2</code> implements the <code>Linux</code> kernel based on <code>Hyper-v</code>, so <code>WSL</code> is also a complete Linux system. Compared to virtual machines, <code>WSL2</code> is a bit lighter. But the supported distributions are also limited.</p>
<p>Recommendation: If you have no contact with <code>Linux</code> and want to learn <code>Linux</code>, it is better to install a <code>Linux</code> virtual machine by yourself; and if you are very familiar with <code>Linux</code>, you can try to install <code>WSL2</code>, which will bring better development experience for developers.</p>
<h2 id="2-wsl2-try">2. WSL2 try</h2>
<p>For WSL2 installation, please refer to the article: <a href="https://dowww.spencerwoo.com/">https://dowww.spencerwoo.com/</a></p>
<p>WSL2 migration reference answer: <a href="https://stackoverflow.com/questions/63252225/is-this-the-correct-way-to-import-a-wsl-export-overwriting-default-installati">https://stackoverflow.com/questions/63252225/is-this-the-correct-way-to-import-a-wsl-export-overwriting-default-installati</a></p>
<p>WSL2 is installed on Windows <code>C</code> drive by default, as the capacity of WSL2 usage becomes larger, it may cause a warning of space on <code>C</code> drive. You can migrate <code>WSL2</code> to another logical volume using the above method. In fact, WSL, like a virtual machine, is stored in HOST as an image file, and the <code>WSL2-Ubuntu 20</code> installed on my Win10 already uses <code>40G</code> of storage, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/05df5ec25d4c43eba3103d11384affd4.png" alt="sobyte"></p>
<blockquote>
<p>If you want to migrate WSL2 from your development environment computer to your home computer, it is also easy to copy the image file away and import it directly to the target machine.</p>
</blockquote>
<p>I chose to install <code>WSL2</code> with <code>Ubuntu 20.04 LTS</code> from the Microsoft Store, and the next steps are based on that Ubuntu distribution.</p>
<p>The <code>WSL</code> boot is to open the corresponding <code>Ubuntu</code> or other distribution installed from the Microsoft Store (as shown below), and the <code>WSL</code> shutdown can be used in <code>PowerShell</code>: <code>wsl --shutdow</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/77a8a5a4b16a40bdb2cf3aa7fa2d5e5b.png" alt="sobyte"></p>
<h3 id="21-wsl-dynamic-ip-how-to-access-from-outside">2.1 WSL dynamic IP, how to access from outside?</h3>
<p>The network of <code>WSL2</code> is similar to the <code>NAT</code> network mode set in the virtual machine, in this mode the <code>WSL2</code> instance accesses the external network with the help of the host&rsquo;s NIC, the host can also access the <code>WSL2</code> instance, but other hosts in the host&rsquo;s LAN cannot access the <code>WSL2</code> instance. As shown in the figure.</p>
<blockquote>
<p>The so-called <code>WSL2</code> instance refers to a certain <code>WSL2</code> supported distribution installed, I am using <code>Ubuntu 20.04 LTS</code>.</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/bd2df584d7f746eebbb6cee96e072864.png" alt="sobyte"></p>
<p>The network address of <code>WSL2</code> changes dynamically (like docker container, the IP address changes on reboot), and no other host on the LAN can access it, which is too inconvenient.</p>
<blockquote>
<p>Why is it inconvenient? If you start a service on <code>WSL2</code> and your colleague can&rsquo;t access it, it&rsquo;s very troublesome.</p>
</blockquote>
<p>How to solve it? You can map the port of <code>WSL2</code> to the host win by using <code>Windows</code> port mapping.</p>
<p>The script is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#清除网络映射</span>
netsh interface portproxy reset
<span class="c1">#获取WSL2实例动态IP</span>
<span class="nv">$wsl_ip</span> <span class="o">=</span> <span class="o">(</span>wsl hostname -I<span class="o">)</span>.trim<span class="o">()</span>.split<span class="o">()[</span>0<span class="o">]</span>
<span class="c1">#日志信息</span>
Write-Host <span class="s2">&#34;WSL Machine IP: &#34;&#34;</span><span class="nv">$wsl_ip</span><span class="s2">&#34;&#34;&#34;</span>
<span class="c1">#网络映射win:8080 --&gt; wsl2:8080</span>
netsh interface portproxy add v4tov4 <span class="nv">listenport</span><span class="o">=</span><span class="m">8080</span> <span class="nv">connectport</span><span class="o">=</span><span class="m">8080</span> <span class="nv">connectaddress</span><span class="o">=</span><span class="nv">$wsl_ip</span>
</code></pre></td></tr></table>
</div>
</div><p>It can be executed directly in the <code>PowerShell</code> terminal, or it can be saved as a <code>.ps1</code> script and the script executed in the <code>PowerShell</code> terminal, as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/38ed3556f0a64ab492db68d64976560b.png" alt="sobyte"></p>
<h3 id="22-how-do-i-install-docker-without-installing-docker-desktop">2.2 How do I install Docker without installing Docker Desktop?</h3>
<p>If you have a virtual machine installed locally, installing docker is easy. However, installing it on a <code>WSL2</code> instance will take some effort.</p>
<p>The official solution is to install <code>Docker Desktop for Windows</code> on <code>WSL2</code>, you can refer to <a href="https://docs.microsoft.com/zh-cn/windows/wsl/tutorials/wsl-containers">https://docs.microsoft.com/zh-cn/windows/wsl/tutorials/wsl-containers</a>.</p>
<p>If you don&rsquo;t want to install <code>Docker Desktop</code> but want to use <code>docker</code> on <code>WSL2</code>, refer to <a href="https://dev.to/bowmanjd/install-docker-on-windows-wsl-without-docker-desktop-34m9">https://dev.to/bowmanjd/install-docker-on-windows-wsl-without-docker-desktop-34m9</a> for the The solution will be explained in detail next.</p>
<blockquote>
<p>Only <code>docker</code> is installed here for <code>WSL2</code> version, <code>docker</code> is not supported for <code>WSL1</code> version.</p>
</blockquote>
<blockquote>
<p>The following configuration is for <code>WSL2 Ubuntu 20.04 LTS</code> for docker configuration, other <code>WSL2</code> supported distributions have differences in user and permission configuration, please refer to the original article.</p>
</blockquote>
<h4 id="221-deleting-an-existing-docker">2.2.1 Deleting an existing docker</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo apt remove docker-engine docker docker.io docker-ce docker-ce-cli
</code></pre></td></tr></table>
</div>
</div><h4 id="222-installing-dependencies">2.2.2 Installing dependencies</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo apt install --no-install-recommends apt-transport-https ca-certificates curl gnupg2
</code></pre></td></tr></table>
</div>
</div><h4 id="223-ubuntu-package-repository-configuration">2.2.3 Ubuntu package repository configuration</h4>
<p>Set the os-release related environment variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#执行完成后，可以在shel中执行$ID验证是否存在该变量</span>
<span class="nb">source</span> /etc/os-release
</code></pre></td></tr></table>
</div>
</div><p>Let <code>apt</code> Trusted Warehouse.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#这里的${ID}是上面source命令执行后的环境变量ID，本示例是：ubuntu</span>
curl -fsSL https://download.docker.com/linux/<span class="si">${</span><span class="nv">ID</span><span class="si">}</span>/gpg <span class="p">|</span> sudo apt-key add -
</code></pre></td></tr></table>
</div>
</div><p>Add repository addresses and update the repository list so that <code>apt</code> can use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#本示例变量替换后的结果为：deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable</span>
<span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64] https://download.docker.com/linux/</span><span class="si">${</span><span class="nv">ID</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">VERSION_CODENAME</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/docker.list
sudo apt update
</code></pre></td></tr></table>
</div>
</div><h4 id="224-installing-docker">2.2.4 Installing Docker</h4>
<p>Execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo apt install docker-ce docker-ce-cli containerd.io
</code></pre></td></tr></table>
</div>
</div><h4 id="225-setting-docker-command-permissions">2.2.5 Setting docker command permissions</h4>
<ol>
<li>You can execute with the root user. This is not the norm, for fear of <code>rm -rf /</code> mishaps.</li>
<li>Each time you use <code>sudo docker ...</code>, a normal user using sudo will be operating as the <code>root</code> user. The sudo function is configured in <code>/etc/sudoers</code> for normal users. The <code>WSL2 Ubuntu</code> instance is created with the normal user added to <code>sudoers</code> by default.</li>
</ol>
<p>In addition to that, you can also add users to a group and give the group the ability to execute a process without secrecy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#这里的$USER会解析为当前用户</span>
sudo usermod -aG docker <span class="nv">$USER</span>
</code></pre></td></tr></table>
</div>
</div><p>The docker process has the following password-free configuration in <code>sudoers</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># sudo visudo, 添加下面</span>
%docker <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span>  NOPASSWD: /usr/bin/dockerd
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>The <code>docker</code> group may have been created by the command that installed <code>docker</code>, so if you go to <code>/etc/group</code> and there is no <code>docker</code> group, you can use the command <code>sudo groupadd -g 999 docker</code>.</p>
</blockquote>
<blockquote>
<p>In fact, there is a confusion here, because on Ubuntu systems a normal user is given the ability to join a group, and the group can be set up to operate a command as root with no security. If the command involves writing data, you may get a <code>Permission denied</code> error. For example, for <code>git</code>, you need to set <code>sudo chown -R $USER:$USER $GIT_REPO</code> to use it without problems. After checking, the reason may be that the above setting does execute the command as <code>root</code> user, but the result of the command will trigger a new process that is executed as a normal user, so you need to have permissions on the directory.</p>
</blockquote>
<h4 id="226-configuring-dockerd">2.2.6 Configuring dockerd</h4>
<p>Set up a directory for the docker socket to use, and set permissions so that the group to which <code>docker</code> belongs has permission to write to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">DOCKER_DIR</span><span class="o">=</span>/mnt/wsl/shared-docker
mkdir -pm <span class="nv">o</span><span class="o">=</span>,ug<span class="o">=</span>rwx <span class="s2">&#34;</span><span class="nv">$DOCKER_DIR</span><span class="s2">&#34;</span>
chgrp docker <span class="s2">&#34;</span><span class="nv">$DOCKER_DIR</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>To set the <code>dockerd</code> startup parameters, edit <code>/etc/docker/daemon.json</code> and configure it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;hosts&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;unix:///mnt/wsl/shared-docker/docker.sock&#34;</span><span class="p">],</span>
  <span class="nt">&#34;insecure-registries&#34;</span><span class="p">:[</span><span class="s2">&#34;a.b.com:5000&#34;</span><span class="p">,</span> <span class="s2">&#34;m.n.com:9500&#34;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>If there is no corresponding <code>/etc/docker/daemon.json</code> file, you can create it manually. The <code>insecure-registries</code> setting in the parameters means that the insecure <code>http</code> image registry is allowed, and can be configured again if needed.</p>
</blockquote>
<h4 id="227-starting-dockerd">2.2.7 Starting dockerd</h4>
<p>Use the command <code>sudo dockerd</code> to start it. However, to start <code>dockerd</code> in this way, we need to start a container like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker -H unix:///mnt/wsl/shared-docker/docker.sock run --rm hello-world
</code></pre></td></tr></table>
</div>
</div><p>We can start <code>dockerd</code> with a script, which will be easier to use.</p>
<h4 id="228-dockerd-script-launch">2.2.8 dockerd script launch</h4>
<p>Start script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">DOCKER_DISTRO</span><span class="o">=</span><span class="s2">&#34;Ubuntu-20.04&#34;</span>
<span class="nv">DOCKER_DIR</span><span class="o">=</span>/mnt/wsl/shared-docker
<span class="nv">DOCKER_SOCK</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$DOCKER_DIR</span><span class="s2">/docker.sock&#34;</span>
<span class="nb">export</span> <span class="nv">DOCKER_HOST</span><span class="o">=</span><span class="s2">&#34;unix://</span><span class="nv">$DOCKER_SOCK</span><span class="s2">&#34;</span>
<span class="k">if</span> <span class="o">[</span> ! -S <span class="s2">&#34;</span><span class="nv">$DOCKER_SOCK</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    mkdir -pm <span class="nv">o</span><span class="o">=</span>,ug<span class="o">=</span>rwx <span class="s2">&#34;</span><span class="nv">$DOCKER_DIR</span><span class="s2">&#34;</span>
    chgrp docker <span class="s2">&#34;</span><span class="nv">$DOCKER_DIR</span><span class="s2">&#34;</span>
    /mnt/c/Windows/System32/wsl.exe -d <span class="nv">$DOCKER_DISTRO</span> sh -c <span class="s2">&#34;nohup sudo -b dockerd &lt; /dev/null &gt; </span><span class="nv">$DOCKER_DIR</span><span class="s2">/dockerd.log 2
</span></code></pre></td></tr></table>
</div>
</div><p>Save the script in <code>docker-service</code> under <code>path</code>, in this case in <code>/usr/bin</code>. Execute <code>docker-service</code> to start <code>dockerd</code>.</p>
<h4 id="229-zsh-setup-to-enable-self-starting-dockerd">2.2.9 zsh setup to enable self-starting dockerd</h4>
<p>The default <code>sh</code> used by this <code>WSL2 Ubuntu</code> is <code>zsh</code>, so you can set <code>WSL2</code> to boot <code>dockerd</code> by adding the <code>source /usr/bin/docker-service</code> startup script to <code>/etc/zsh/zprofile</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/445abf618ded4e729b4ae4fefa489748.png" alt="sobyte"></p>
<h3 id="23-how-do-win-and-wsl-systems-interoperate">2.3 How do Win and WSL systems interoperate?</h3>
<h4 id="231-file-system-interoperability">2.3.1 File system interoperability</h4>
<p><strong>Accessing WSL file system on win</strong></p>
<p>Execute <code>explorer.exe on the wsl instance .</code> , or directly open Windows Explorer and type: <code>\\wsl$\Ubuntu-20.04\opt</code> . As follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/47d2893a32ba48a8a52996934fbd77a6.png" alt="sobyte"></p>
<p>This way to open the wsl file system directory, Windows users have read and write access to the <code>WSL</code> normal user data, for the root user is read-only access. And use this way to open the file modification and save is very laggy, performance problems. Therefore, <strong>it is not recommended to modify the contents of wsl instance file system on Windows system</strong> .</p>
<p><strong>Accessing the win file system on WSL</strong></p>
<p><code>WSL2</code> maps a Windows disk logical volume to a mount file. <code>/mnt/c</code> is the Windows C disk mount path; <code>/mnt/d</code> is the Windows D file mount path and so on and so forth. If you want to open <code>D:\out.txt</code> on a Win system with <code>vim</code> on <code>WSL</code>, you can just use: <code>vim /mnt/d/out.txt</code>.</p>
<p>Operating the <code>Windows</code> file system on <code>WSL</code> will also have some performance issues, but not as severe as the performance delays of <code>Windows</code> operating the <code>WSL</code> file system. If it&rsquo;s something like a larger git repository, it&rsquo;s best to clone to the <code>WSL</code> local filesystem operation.</p>
<h4 id="232-program-call-interoperability">2.3.2 Program call interoperability</h4>
<p><code>WSL</code> is able to read <code>Windows</code> system <code>PAHT</code> variables directly and open them directly on wsl, e.g. <code>ping.exe</code> on <code>WSL</code>: <code>WSL</code> is able to read <code>Windows</code> system <code>PAHT</code> variables directly and open them directly on wsl.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/e69f74aefc534562a4cfa48818d636a0.png" alt="sobyte"></p>
<blockquote>
<p>There are times when this feature is useful, especially when you open graphical applications. For example, opening a text file in the <code>WSL</code> system with <code>notepad++</code>, etc. <strong>Remember that exe programs in the Win system PATH variable are only found in the WSL</strong> .</p>
</blockquote>
<p>Of course, you can also execute <code>WSL</code> commands on a <code>Windows</code> system, such as <code>wsl ping</code> in <code>PowerShell</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/16/79aa57e86aa94f3e936a515e3f3a7441.png" alt="sobyte"></p>
<p>The two commands can also be used in combination, for example, in <code>PowerShell</code>: <code>wsl ls -la | findstr &quot;git&quot;</code>. For more information, please refer to: <a href="https://docs.microsoft.com/en-us/windows/wsl/filesystems">https://docs.microsoft.com/en-us/windows/wsl/filesystems</a></p>
<h2 id="3-problems-with-wsl2">3. Problems with WSL2</h2>
<h3 id="31-wsl-and-virtualbox-for-hyper-v-conflict">3.1 WSL and VirtualBox for Hyper-v conflict</h3>
<p>Error: Please enable the Virtual Machine Platform Windows feature and make sure virtualization is enabled in the BIOS.</p>
<p>This is because the <code>Hyper-v</code> service was previously turned off when using VirtualBox. Set Hyper-v mode to be enabled automatically: <code>bcdedit /set hypervisorlaunchtype auto</code>.</p>
<p>After Hyper-v service is started, you need to restart the computer for WSL to start normally.</p>
<p>After restarting the v2ray program, I found that I could not bind to <code>10809</code>, but I did not find the port occupied by <code>netstat -ano|findstr 10809</code>. I found that the port reserved by the Hyper-v program was probably occupied. The solution is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">netsh int ip show dynamicport tcp <span class="c1">#查看端口范围</span>
netsh int ip <span class="nb">set</span> dynamicport tcp <span class="nv">start</span><span class="o">=</span><span class="m">49152</span> <span class="nv">num</span><span class="o">=</span><span class="m">16384</span> <span class="c1">#设置新的端口范围，重启计算机</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-centos6-has-problems-running-on-wsl2-docker">3.2 Centos6 has problems running on wsl2 docker</h3>
<p>There is a problem running containers based on <code>centos6</code> images on <code>WSL2</code> docker, solution: add the following configuration to <code>%userprofile%\.wslconfig</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[wsl2]
kernelCommandLine = vsyscall=emulate
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/windows/">windows</a>
          <a href="/tags/wsl/">wsl</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/go-higher-order-function/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to use higher-order function programming to improve the simplicity of your code</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/go-deprecate-strings-title/">
            <span class="next-text nav-default">Go1.18 new feature: deprecate strings.Title method</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
