<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Case sharing of JMH and Arthas positioning issues - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I would like to summarize what I&amp;rsquo;ve been using in my recent work, the testing tool JMH and the Java runtime monitoring tool Arthas, which have helped me in my actual work. So here&amp;rsquo;s how to use these tools. I also want to deepen my familiarity with these tools. For these two tools, I will first briefly introduce the general usage scenarios of these tools, and then I will use" /><meta name="keywords" content="arthas, jmh" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-02/jmh-and-arthas/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Case sharing of JMH and Arthas positioning issues" />
<meta property="og:description" content="I would like to summarize what I&rsquo;ve been using in my recent work, the testing tool JMH and the Java runtime monitoring tool Arthas, which have helped me in my actual work. So here&rsquo;s how to use these tools. I also want to deepen my familiarity with these tools. For these two tools, I will first briefly introduce the general usage scenarios of these tools, and then I will use" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-02/jmh-and-arthas/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-10T09:21:25+08:00" />
<meta property="article:modified_time" content="2022-02-10T09:21:25+08:00" />

<meta itemprop="name" content="Case sharing of JMH and Arthas positioning issues">
<meta itemprop="description" content="I would like to summarize what I&rsquo;ve been using in my recent work, the testing tool JMH and the Java runtime monitoring tool Arthas, which have helped me in my actual work. So here&rsquo;s how to use these tools. I also want to deepen my familiarity with these tools. For these two tools, I will first briefly introduce the general usage scenarios of these tools, and then I will use"><meta itemprop="datePublished" content="2022-02-10T09:21:25+08:00" />
<meta itemprop="dateModified" content="2022-02-10T09:21:25+08:00" />
<meta itemprop="wordCount" content="3705">
<meta itemprop="keywords" content="jmh,arthas," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Case sharing of JMH and Arthas positioning issues"/>
<meta name="twitter:description" content="I would like to summarize what I&rsquo;ve been using in my recent work, the testing tool JMH and the Java runtime monitoring tool Arthas, which have helped me in my actual work. So here&rsquo;s how to use these tools. I also want to deepen my familiarity with these tools. For these two tools, I will first briefly introduce the general usage scenarios of these tools, and then I will use"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Case sharing of JMH and Arthas positioning issues</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-10 09:21:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3705 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#problem-description">Problem Description</a></li>
        <li><a href="#introduction-to-jmh">Introduction to JMH</a></li>
        <li><a href="#arthas-what-exactly-does-my-code-do-at-runtime">Arthas What exactly does my code do at runtime</a>
          <ul>
            <li><a href="#hands-on">Hands-on</a></li>
            <li><a href="#monitor-method-calls">Monitor method calls</a></li>
            <li><a href="#trace-command--jad-command">trace command &amp; jad command</a></li>
            <li><a href="#watch-command">watch command</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I would like to summarize what I&rsquo;ve been using in my recent work, the testing tool JMH and the Java runtime monitoring tool Arthas, which have helped me in my actual work. So here&rsquo;s how to use these tools. I also want to deepen my familiarity with these tools. For these two tools, I will first briefly introduce the general usage scenarios of these tools, and then I will use an example of a real performance problem I encountered in my work to explain the actual usage of these two tools in detail. Without further ado, let&rsquo;s get right to the point.</p>
<h2 id="problem-description">Problem Description</h2>
<p>In order to be able to run through the use of these two tools in my later examples, I will first briefly describe the actual performance problems we encountered in our development. Then I&rsquo;ll draw out the actual use of the two performance tools and see how we used them to successfully locate a performance bottleneck.</p>
<p>The problem is as follows: In order to be able to support the loss rate, we modified the original log4j2 Async+Custom Appender approach and put the asynchronous logic into our own revamped Appender. However, we found that the performance of the modified logging was much lower than the previous Async+Custom Appender approach. Here I didn&rsquo;t use an example from the actual company for privacy reasons, here I used an alternative way that also reflects the problem. Let&rsquo;s skip the specific configuration file for now and give the performance test code and results</p>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.bryantchang.appendertest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppenderTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGGER_NAME_DEFAULT</span> <span class="o">=</span> <span class="s">&#34;defaultLogger&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGGER_NAME_INCLUDE</span> <span class="o">=</span> <span class="s">&#34;includeLocationLogger&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LOGGER_NAME_INCLUDE</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">BATCH</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">;</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BATCH</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;msg is {}&#34;</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;duration of &#34;</span> <span class="o">+</span> <span class="n">LOGGER_NAME_INCLUDE</span> <span class="o">+</span>  <span class="s">&#34; is &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The code logic is simple, it calls logger.info to print 10,000 logs at a time and then records the elapsed time. The comparison between the two is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/e5739ac4ec14464ebdc13506927c6116.png" alt="sobyte"></p>
<p>Comparison of results.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/d8719ccac0f84d16b574b3fff6dfe42a.png" alt="sobyte"></p>
<p>From these two pictures we are able to see the same logic, the difference in time consumption between the two programs is tens of times, but looking at the pictures, it seems to be just the name of the logger is different. Analyzing the results of the above experiment, we may have two questions</p>
<ul>
<li>whether the above code test is standard and regulated</li>
<li>If it is really a performance problem, then the two codes have such a big difference in which method leads to the final performance difference</li>
</ul>
<p>The following two tools will be used to answer these two questions respectively</p>
<h2 id="introduction-to-jmh">Introduction to JMH</h2>
<p>The first question is whether the test method is standard. We write our code in a dead loop + back and forth &ldquo;stopwatch&rdquo; style. If we were to add a multi-threaded test, we would need a thread pool, and we would have to care about the logic of the test in addition to the logic of the code itself. JMH is one such testing framework for Java. Here is the official definition of JMH.</p>
<blockquote>
<p>JMH is a performance benchmarking framework for the Java language or other Java virtual machine languages.</p>
</blockquote>
<p>The most suitable scenario is to test the performance of two collections of put and get, such as ArrayList vs. LinkedList, etc. Here we need to test the time required to play a batch of logs, which is also basically in line with the test scenario using JMH. Here is the test code, the bench framework code and the main function.</p>
<p>Methods to be tested</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogBenchMarkWorker</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nf">LogBenchMarkWorker</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LogBenchMarkWorkerInstance</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">LogBenchMarkWorker</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogBenchMarkWorker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">LogBenchMarkWorker</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">LogBenchMarkWorkerInstance</span><span class="o">.</span><span class="na">instance</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGGER_DEFAULT_NAME</span> <span class="o">=</span> <span class="s">&#34;defaultLogger&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOGGER_INCLUDE_LOCATION</span> <span class="o">=</span> <span class="s">&#34;includeLocationLogger&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LOGGER_DEFAULT_NAME</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">logBatch</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BATCH_SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;msg is {}&#34;</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see the method to be tested is very simple, it is the operation of printing 10,000 logs at once in a single batch, so there is no need to explain any additional parts. Let&rsquo;s look at the benchmark section again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogBenchMarkMain</span> <span class="o">{</span>

    <span class="nd">@Benchmark</span>
    <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">AverageTime</span><span class="o">)</span>
    <span class="nd">@Fork</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>
    <span class="nd">@Threads</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLog1</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">LogBenchMarkWorker</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">logBatch</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">AverageTime</span><span class="o">)</span>
    <span class="nd">@Fork</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>
    <span class="nd">@Threads</span><span class="o">(</span><span class="n">4</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLog4</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">LogBenchMarkWorker</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">logBatch</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">AverageTime</span><span class="o">)</span>
    <span class="nd">@Fork</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>
    <span class="nd">@Threads</span><span class="o">(</span><span class="n">8</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLog8</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">LogBenchMarkWorker</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">logBatch</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="n">Mode</span><span class="o">.</span><span class="na">AverageTime</span><span class="o">)</span>
    <span class="nd">@Fork</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>
    <span class="nd">@Threads</span><span class="o">(</span><span class="n">16</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLog16</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">LogBenchMarkWorker</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">logBatch</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this code, we then find something unique to JMH, which I briefly describe below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Benchmark注解：标识在某个具体方法上，表示这个方法将是一个被测试的最小方法，在JMH中成为一个OPS
BenmarkMode:测试类型，JMH提供了几种不同的Mode
    Throughput:整体吞吐量
    AverageTime:调用的平均时间，每次OPS执行的时间
    SampleTime:取样，给出不同比例的ops时间，例如99%的ops时间，99.99%的ops时间
fork：fork的次数，如果设置为2，JMH会fork出两个进程来测试
Threads：很容易理解，这个参数表示这个方法同时被多少个线程执行
</code></pre></td></tr></table>
</div>
</div><p>In the above code, I have defined 4 methods to be tested, the method Fork, BenchmarkMode are the average time to test a single OPS, but the number of threads for the 4 methods are different.
In addition to these parameters, there are a few more parameters that I will talk about in the main function, and the main code is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RunnerException</span> <span class="o">{</span>
        <span class="n">Options</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OptionsBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">LogBenchMarkMain</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">())</span>
                <span class="o">.</span><span class="na">warmupIterations</span><span class="o">(</span><span class="n">5</span><span class="o">)</span>
                <span class="o">.</span><span class="na">measurementIterations</span><span class="o">(</span><span class="n">5</span><span class="o">)</span>
                <span class="o">.</span><span class="na">output</span><span class="o">(</span><span class="s">&#34;logs/BenchmarkCommon.log&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">Runner</span><span class="o">(</span><span class="n">options</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can see that in the main function, we are to set the basic configuration of JMH, which has several configuration parameters meaning as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">include:benchmark所在类的名字，可以使用正则表达
warmupIteration:预热的迭代次数，这里为什么要预热的原因是由于JIT的存在，随着代码的运行，会动态对代码的运行进行优化。因此在测试过程中需要先预热几轮，让代码运行稳定后再实际进行测试
measurementIterations:实际测试轮次
output:测试报告输出位置
</code></pre></td></tr></table>
</div>
</div><p>I ran the tests with both loggers separately to see the performance test report comparison</p>
<p>Using the normal logger</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">LogBenchMarkMain.testLog1   avgt    5  0.006 ± 0.001   s/op
LogBenchMarkMain.testLog16  avgt    5  0.062 ± 0.026   s/op
LogBenchMarkMain.testLog4   avgt    5  0.006 ± 0.002   s/op
LogBenchMarkMain.testLog8   avgt    5  0.040 ± 0.004   s/op
</code></pre></td></tr></table>
</div>
</div><p>Loggers that use INCLUDE_LOCATION</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">LogBenchMarkMain.testLog1   avgt    5  0.379 ± 0.007   s/op
LogBenchMarkMain.testLog16  avgt    5  1.784 ± 0.670   s/op
LogBenchMarkMain.testLog4   avgt    5  0.378 ± 0.003   s/op
LogBenchMarkMain.testLog8   avgt    5  0.776 ± 0.070   s/op
</code></pre></td></tr></table>
</div>
</div><p>Here we see that the performance gap is immediately apparent. The performance of using INCLUDE_LOCATION is significantly lower than the performance of using normal logger. This is where we must wonder and ask &ldquo;what is the slowdown&rdquo;!</p>
<h2 id="arthas-what-exactly-does-my-code-do-at-runtime">Arthas What exactly does my code do at runtime</h2>
<p>Arthas is a java debugging tool open-sourced by Ali, similar to greys, but with more powerful features than greys, for example, you can directly draw the flame graph of java method calls, etc. The principle of both tools is the use of Java&rsquo;s powerful bytecode technology. After all, I am not a JVM expert, so I can not expand on the details of the implementation. All we have to do is stand on the shoulders of giants, accept and use these good performance monitoring tools with skill.</p>
<h3 id="hands-on">Hands-on</h3>
<p>Talk is cheap, show me your code, since it&rsquo;s a tool, let&rsquo;s go straight to the real thing. Let&rsquo;s run the program we started with locally and then explain how to use arthas.</p>
<p>We first find the process number of the program via jps, then we directly enhance the bytecode of our running program via as.sh given by arthas, and then start arthas with the following command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">./as.sh pid
</code></pre></td></tr></table>
</div>
</div><p>This is the startup screen of arthas, and we use the help command to see the features supported by the tool.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/a81319ec51c14d4588f5ba416adcf3e3.png" alt="sobyte"></p>
<p>As you can see, arthas supports viewing the current state of jvm, viewing the current thread state, monitoring the call time of certain methods, trace, profile generation flame chart, etc., with a full range of functions.
We will also only a few more commonly used commands here, other commands if you are interested in see the official website arthas website for details. This article mainly introduces the following functions.</p>
<ul>
<li>Decompile code</li>
<li>Monitor the invocation of a method</li>
<li>View the call and return value of a method</li>
<li>Trace a method</li>
</ul>
<h3 id="monitor-method-calls">Monitor method calls</h3>
<p>The main command for this is monitor, and according to the official website, the common usage is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">monitor -c duration className methodName
</code></pre></td></tr></table>
</div>
</div><p>where duration represents every few seconds to show the statistical results, that is, a single statistical cycle, className is the fully qualified name of the class, methodname is the name of the method, which we view the method is the Logger class info method, we use two different logger&rsquo;s info method, respectively. The class here is org.slf4j.Logger, the method when info, our monitoring statement is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">monitor -c <span class="m">5</span> org.slf4j.Logger info
</code></pre></td></tr></table>
</div>
</div><p>The monitoring results are as follows</p>
<ul>
<li>
<p>Using the normal appender</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/4c23429b2eff425e83ce4a6255d09c8c.png" alt="sobyte"></p>
</li>
<li>
<p>Use include appender</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/e11682811ba0434297d767a0b13f4ddc.png" alt="sobyte"></p>
</li>
</ul>
<p>We can see that the print log method using include appeder is 3 times higher than the normal appender, which makes us wonder how time consuming the various steps of these two methods are. Here we will introduce the second command, trace method.</p>
<h3 id="trace-command--jad-command">trace command &amp; jad command</h3>
<p>The log4j2 configuration files for these two programs are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="c">&lt;!--status：日志等级   monitorInterval：更新配置文件的时间间隔，单位秒--&gt;</span>
<span class="nt">&lt;configuration</span> <span class="na">status=</span><span class="s">&#34;warn&#34;</span> <span class="na">monitorInterval=</span><span class="s">&#34;30&#34;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--定义所有的appender --&gt;</span>
    <span class="nt">&lt;appenders&gt;</span>
        <span class="c">&lt;!--这个输出控制台的配置 --&gt;</span>
        <span class="nt">&lt;Console</span> <span class="na">name=</span><span class="s">&#34;console&#34;</span> <span class="na">target=</span><span class="s">&#34;SYSTEM_OUT&#34;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch） --&gt;</span>
            <span class="nt">&lt;ThresholdFilter</span> <span class="na">level=</span><span class="s">&#34;warn&#34;</span> <span class="na">onMatch=</span><span class="s">&#34;ACCEPT&#34;</span> <span class="na">onMismatch=</span><span class="s">&#34;DENY&#34;</span><span class="nt">/&gt;</span>
            <span class="c">&lt;!--日志打印格式 --&gt;</span>
            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;[%d{HH:mm:ss.SSS}] [%-5p] %l - %m%n&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Console&gt;</span>


        <span class="nt">&lt;Async</span> <span class="na">name=</span><span class="s">&#34;AsyncDefault&#34;</span> <span class="na">blocking=</span><span class="s">&#34;false&#34;</span> <span class="na">includeLocation=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&#34;fileAppender&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Async&gt;</span>

        <span class="nt">&lt;Async</span> <span class="na">name=</span><span class="s">&#34;AsyncIncludeLocation&#34;</span> <span class="na">blocking=</span><span class="s">&#34;false&#34;</span> <span class="na">includeLocation=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;AppenderRef</span> <span class="na">ref=</span><span class="s">&#34;fileAppender&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Async&gt;</span>

        <span class="c">&lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用 --&gt;</span>
        <span class="c">&lt;!--append为TRUE表示消息增加到指定文件中，false表示消息覆盖指定的文件内容，默认值是true --&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">&#34;fileAppender&#34;</span> <span class="na">fileName=</span><span class="s">&#34;log/test.log&#34;</span> <span class="na">append=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;[%d{HH:mm:ss.SSS}] [%-5p] %l - %m%n&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/File&gt;</span>

        <span class="c">&lt;!--添加过滤器ThresholdFilter,可以有选择的输出某个级别以上的类别  onMatch=&#34;ACCEPT&#34; onMismatch=&#34;DENY&#34;意思是匹配就接受,否则直接拒绝  --&gt;</span>
        <span class="nt">&lt;File</span> <span class="na">name=</span><span class="s">&#34;ERROR&#34;</span> <span class="na">fileName=</span><span class="s">&#34;logs/error.log&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ThresholdFilter</span> <span class="na">level=</span><span class="s">&#34;error&#34;</span> <span class="na">onMatch=</span><span class="s">&#34;ACCEPT&#34;</span> <span class="na">onMismatch=</span><span class="s">&#34;DENY&#34;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;[%d{yyyy.MM.dd &#39;at&#39; HH:mm:ss z}] [%-5p] %l - %m%n&#34;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/File&gt;</span>

        <span class="c">&lt;!--这个会打印出所有的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档 --&gt;</span>
        <span class="nt">&lt;RollingFile</span> <span class="na">name=</span><span class="s">&#34;rollingFile&#34;</span> <span class="na">fileName=</span><span class="s">&#34;logs/app.log&#34;</span>
                     <span class="na">filePattern=</span><span class="s">&#34;logs/$${date:yyyy-MM}/web-%d{yyyy-MM-dd}.log.gz&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;PatternLayout</span> <span class="na">pattern=</span><span class="s">&#34;[%d{yyyy-MM-dd HH:mm:ss}] [%-5p] %l - %m%n&#34;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;Policies&gt;</span>
                <span class="nt">&lt;TimeBasedTriggeringPolicy</span> <span class="na">modulate=</span><span class="s">&#34;true&#34;</span> <span class="na">interval=</span><span class="s">&#34;1&#34;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/Policies&gt;</span>
            <span class="nt">&lt;DefaultRolloverStrategy&gt;</span>
                <span class="nt">&lt;Delete</span> <span class="na">basePath=</span><span class="s">&#34;logs&#34;</span> <span class="na">maxDepth=</span><span class="s">&#34;2&#34;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;IfFileName</span> <span class="na">glob=</span><span class="s">&#34;*/*.log.gz&#34;</span> <span class="nt">/&gt;</span>
                    <span class="nt">&lt;IfLastModified</span> <span class="na">age=</span><span class="s">&#34;7d&#34;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/Delete&gt;</span>
            <span class="nt">&lt;/DefaultRolloverStrategy&gt;</span>
        <span class="nt">&lt;/RollingFile&gt;</span>
    <span class="nt">&lt;/appenders&gt;</span>

    <span class="c">&lt;!--然后定义logger，只有定义了logger并引入的appender，appender才会生效 --&gt;</span>
    <span class="nt">&lt;loggers&gt;</span>
        <span class="c">&lt;!--过滤掉spring和mybatis的一些无用的DEBUG信息--&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&#34;defaultLogger&#34;</span> <span class="na">additivity=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;AsyncDefault&#34;</span><span class="nt">&gt;&lt;/appender-ref&gt;</span>
        <span class="nt">&lt;/logger&gt;</span>

        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&#34;includeLocationLogger&#34;</span> <span class="na">additivity=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">&#34;AsyncIncludeLocation&#34;</span><span class="nt">&gt;&lt;/appender-ref&gt;</span>
        <span class="nt">&lt;/logger&gt;</span>

        <span class="c">&lt;!--建立一个默认的root的logger --&gt;</span>
        <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">&#34;INFO&#34;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;/root&gt;</span>
    <span class="nt">&lt;/loggers&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>We both used an AsyncAppender to apply a FileAppender. looking at the fileAppender, we found that there is no difference between the two, except for one option in the asyncAppender, which is includeLocation, one is false and the other is true. As for the meaning of this parameter, we won&rsquo;t discuss it for now, we now know that the problem may be in AsyncAppender, but how do we verify it. trace command is useful.</p>
<p>The basic usage of the trace command is similar to monitor, where the main argument is -n, which means how many times to trace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">trace -n trace_times className methodName.
</code></pre></td></tr></table>
</div>
</div><p>As I mentioned in my previous blog about Log4j2, the core method of any appender is its append method. So let&rsquo;s trace the append method of each of the two programs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">trace -n <span class="m">5</span> org.apache.logging.log4j.core.appender.AsyncAppender append.
</code></pre></td></tr></table>
</div>
</div><p>The trace results are as follows.</p>
<ul>
<li>
<p>Using the normal appender.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/2a2dbbfb1ca044968a9b22e80aa75da0.png" alt="sobyte"></p>
</li>
<li>
<p>Use include appender</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/c5f72c59ffd24ec191027191c2403ae8.png" alt="sobyte"></p>
</li>
</ul>
<p>We can immediately find that the hot methods of the two traces are not the same. In the appender that uses include, the method that takes the longest time is the createMemento method in the org.apache.logging.log4j.core.impl.Log4jLogEvent class, so how can we know This method in the end what to do it, then out of our next common command jad, this command can decompile the code of the corresponding method. Here we jad the above-mentioned createMemento method, the command is very simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">jad org.apache.logging.log4j.core.impl.Log4jLogEvent createMemento
</code></pre></td></tr></table>
</div>
</div><p>The results are as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/bc39d4e24069467e88cb3ea263d9ee45.png" alt="sobyte"></p>
<p>We find that there is an includeLocation parameter in this method, which coincides with the only different configuration we see for the two appenders, so we should have a guess at this point. To verify this guess, let&rsquo;s introduce the next command, watch.</p>
<h3 id="watch-command">watch command</h3>
<p>watch command can observe the entry, return value and other information of a particular method, we use this command to check the entry of the createMemento method, if the two programs have different entries, then we can basically conclude that this is the cause of the command as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">watch org.apache.logging.log4j.core.impl.Log4jLogEvent createMemento <span class="s2">&#34;params&#34;</span> -x <span class="m">2</span> -n <span class="m">5</span> -b -f
</code></pre></td></tr></table>
</div>
</div><p>The meaning of the parameters here is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">-x 参数展开层次
-n 执行次数
-b 查看方法调用前状态
-f 方法调用后
</code></pre></td></tr></table>
</div>
</div><p>The param represents the list of parameters of the method call, and there are other monitoring items as detailed in the official website.</p>
<p>The final watch result is as follows.</p>
<ul>
<li>
<p>Using normal logger</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/c75c095ae84442e0a6f3ad49305222e8.png" alt="sobyte"></p>
</li>
<li>
<p>Use include</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/67056abed41c4a90a37de2ddf98768a4.png" alt="sobyte"></p>
</li>
</ul>
<p>As expected, the two parameters are really a true and a false, we simply look at how this parameter is passed in, we jad the append method of AsyncAppender.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/c8993718fe0240a7b233847e5a51f42f.png" alt="sobyte"></p>
<p>We found that this includeLocation is a property of appender, which is the one configured in our xml. Checking the analysis on the official website, we see that this parameter can reduce the performance of logging by 5-10 times.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/8898cc48c6dc4e32b9d70a287321868d.png" alt="sobyte"></p>
<p>However, to find out, I followed the code statically</p>
<p>This includeLocation will be used in the event&rsquo;s createMemento to create a LogEventProxy when serializing the generated object, the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">LogEventProxy</span><span class="o">(</span><span class="kd">final</span> <span class="n">LogEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">includeLocation</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loggerFQCN</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getLoggerFqcn</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">marker</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getMarker</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">level</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getLevel</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loggerName</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getLoggerName</span><span class="o">();</span>

    <span class="kd">final</span> <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ReusableMessage</span>
            <span class="o">?</span> <span class="n">memento</span><span class="o">((</span><span class="n">ReusableMessage</span><span class="o">)</span> <span class="n">msg</span><span class="o">)</span>
            <span class="o">:</span> <span class="n">msg</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">timeMillis</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getTimeMillis</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">thrown</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getThrown</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">thrownProxy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getThrownProxy</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">contextData</span> <span class="o">=</span> <span class="n">memento</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getContextData</span><span class="o">());</span>
    <span class="k">this</span><span class="o">.</span><span class="na">contextStack</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getContextStack</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">includeLocation</span> <span class="o">?</span> <span class="n">event</span><span class="o">.</span><span class="na">getSource</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threadId</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threadName</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getThreadName</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threadPriority</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getThreadPriority</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">isLocationRequired</span> <span class="o">=</span> <span class="n">includeLocation</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">isEndOfBatch</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">isEndOfBatch</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">nanoTime</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getNanoTime</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If includeLocation is true, then the getSource function will be called, follow it in to see, the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">StackTraceElement</span> <span class="nf">getSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">source</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">source</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loggerFqcn</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">includeLocation</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Log4jLogEvent</span><span class="o">.</span><span class="na">calcLocation</span><span class="o">(</span><span class="n">loggerFqcn</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">source</span><span class="o">;</span>
    <span class="o">}</span>
     <span class="kd">public</span> <span class="kd">static</span> <span class="n">StackTraceElement</span> <span class="nf">calcLocation</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">fqcnOfLogger</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fqcnOfLogger</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// LOG4J2-1029 new Throwable().getStackTrace is faster than Thread.currentThread().getStackTrace().
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">StackTraceElement</span><span class="o">[]</span> <span class="n">stackTrace</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Throwable</span><span class="o">().</span><span class="na">getStackTrace</span><span class="o">();</span>
        <span class="n">StackTraceElement</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">stackTrace</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">stackTrace</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getClassName</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fqcnOfLogger</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">last</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">stackTrace</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that he will look at the entire call stack to find the line of code that calls this method, and the performance can be imagined. Let&rsquo;s monitor it with arthas and verify it.</p>
<p>First we trace the crateMemento method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">trace -n <span class="m">5</span> org.apache.logging.log4j.core.impl.Log4jLogEvent createMemento.
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/458448bfd1c14a9bb6bbd14e29d46724.png" alt="sobyte"></p>
<p>Log4jLogEvent&rsquo;s serialize() found in the hot method org.apache.logging.log4j.core.impl.Log4jLogEvent, keep tracing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">trace -n 5 org.apache.logging.log4j.core.impl.Log4jLogEvent serialize.
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/305fd324a85c4292a841429f2cadf293.png" alt="sobyte"></p>
<p>See the hotspot is the constructor of org.apache.logging.log4j.core.impl.Log4jLogEvent:LogEventProxy, continue trace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">trace -n 5 org.apache.logging.log4j.core.impl.Log4jLogEvent$LogEventProxy &lt;init&gt;
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/14b8bed692674534a16d14ce2397bcdf.png" alt="sobyte"></p>
<p>Found the getSource method, continue.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">trace -n <span class="m">5</span> trace -n <span class="m">5</span> org.apache.logging.log4j.core.LogEvent getSource
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/02/10/3ae6ec8b55d14a98b7e7a6e57c4f28a0.png" alt="sobyte"></p>
<p>The hotspot was finally located, and it was the calcLocation function of org.apache.logging.log4j.core.impl.Log4jLogEvent, the same code as our static trace.</p>
<p>So far we have located an online performance problem by combining JMH and arthas together. However, I introduced only the tip of the iceberg, more common commands hope that you understand and practice through the official website, after a few hands-on practice, the tool will be familiar with.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/jmh/">jmh</a>
          <a href="/tags/arthas/">arthas</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02/debug-linux-kernel-with-qemu-and-gdb/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Debugging Linux kernels with Qemu and GDB</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-02/raspberrypi-32bit-64bit/">
            <span class="next-text nav-default">Up to 1400% Performance Improvement, Raspberry Pi 32-bit/64-bit System Comparison Test</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
