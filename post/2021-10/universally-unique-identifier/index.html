<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Universally Unique Identifier - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In complex distributed systems, it is often necessary to uniquely identify a large number of data and messages. A unique ID is needed to identify a piece of data or a message after the data is divided into libraries and tables, and the self-incrementing ID of the database obviously does not meet the demand at this time a system that can generate a globally unique ID is very necessary. To" /><meta name="keywords" content="Identifier, Unique, Universally" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/universally-unique-identifier/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Universally Unique Identifier" />
<meta property="og:description" content="In complex distributed systems, it is often necessary to uniquely identify a large number of data and messages. A unique ID is needed to identify a piece of data or a message after the data is divided into libraries and tables, and the self-incrementing ID of the database obviously does not meet the demand at this time a system that can generate a globally unique ID is very necessary. To" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/universally-unique-identifier/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-28T20:04:51+08:00" />
<meta property="article:modified_time" content="2021-10-28T20:04:51+08:00" />

<meta itemprop="name" content="Universally Unique Identifier">
<meta itemprop="description" content="In complex distributed systems, it is often necessary to uniquely identify a large number of data and messages. A unique ID is needed to identify a piece of data or a message after the data is divided into libraries and tables, and the self-incrementing ID of the database obviously does not meet the demand at this time a system that can generate a globally unique ID is very necessary. To"><meta itemprop="datePublished" content="2021-10-28T20:04:51+08:00" />
<meta itemprop="dateModified" content="2021-10-28T20:04:51+08:00" />
<meta itemprop="wordCount" content="4329">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Universally Unique Identifier"/>
<meta name="twitter:description" content="In complex distributed systems, it is often necessary to uniquely identify a large number of data and messages. A unique ID is needed to identify a piece of data or a message after the data is divided into libraries and tables, and the self-incrementing ID of the database obviously does not meet the demand at this time a system that can generate a globally unique ID is very necessary. To"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Universally Unique Identifier</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-28 20:04:51 </span>
        <div class="post-category">
            <a href="/categories/solution/"> solution </a>
            </div>
          <span class="more-meta"> 4329 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#database-self-growing-id">Database self-growing ID</a></li>
        <li><a href="#redis-self-growing-ids">Redis Self-Growing IDs</a></li>
        <li><a href="#timestamp--random-number">Timestamp + Random Number</a></li>
        <li><a href="#timestamp--member-id">Timestamp + Member ID</a></li>
        <li><a href="#uuidguid">UUID/GUID</a></li>
        <li><a href="#uuid-variants">UUID variants</a></li>
        <li><a href="#snowflake">Snowflake</a></li>
        <li><a href="#snowflake-variants">Snowflake variants</a>
          <ul>
            <li><a href="#solving-time-synchronization-problems">Solving time synchronization problems</a></li>
            <li><a href="#solving-distributed-deployments">Solving distributed deployments</a></li>
          </ul>
        </li>
        <li><a href="#flickrs-database-is-self-increasing">Flickr&rsquo;s database is self-increasing</a></li>
        <li><a href="#instagram-stored-procedures">Instagram Stored Procedures</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In complex distributed systems, it is often necessary to uniquely identify a large number of data and messages. A unique ID is needed to identify a piece of data or a message after the data is divided into libraries and tables, and the self-incrementing ID of the database obviously does not meet the demand at this time a system that can generate a globally unique ID is very necessary. To summarize, what are the requirements of the business system for ID number?</p>
<ul>
<li>Global uniqueness: No duplicate ID numbers can appear.</li>
<li>Incremental trend: In MySQL InnoDB engine uses aggregated indexes, as most RDBMS use B-tree data structure to store indexed data, we should try to use ordered primary keys to ensure the write performance on top of the primary key selection.</li>
<li>Monotonic incremental: ensure that the next ID must be greater than the previous ID, such as transaction version number, IM incremental messages, sorting and other special needs.</li>
<li>Information security: If the IDs are consecutive, it is very easy to do the crawling work of malicious users, just download the specified URLs directly in order; if the order number is more dangerous, competitors can directly know the single volume of a day. So in some application scenarios, there will be a need for ID irregularity and irregularity.</li>
</ul>
<p>Take the business-side requirements for order numbers as an example.</p>
<ul>
<li>Order number cannot be duplicated</li>
<li>Order number has no rules, i.e., the coding rules cannot include any data related to the company&rsquo;s operation, and external personnel cannot guess the order quantity by the order ID. It cannot be traversed.</li>
<li>Order number length is fixed and not too long</li>
<li>Easy to read, easy to communicate, no messy number-letter exchange</li>
<li>Can be generated quickly</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/28/ef986cd189364573ab9376e4517e6354.png" alt=""></p>
<p>Common global unique ID schemes.</p>
<h2 id="database-self-growing-id">Database self-growing ID</h2>
<p>Advantages.</p>
<ul>
<li>No coding required</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Large tables cannot be divided horizontally, otherwise problems will occur when inserting and deleting</li>
<li>Need to add transaction mechanism for inserting data under high concurrency</li>
<li>When inserting parent and child tables (related tables) in business operations, the parent table must be inserted first, and then the child table</li>
</ul>
<h2 id="redis-self-growing-ids">Redis Self-Growing IDs</h2>
<p>Redis to generate distributed IDs is actually similar to using Mysql to self-increment IDs, which can be done atomically by using the incr command in Redis to self-increment and return, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; <span class="nb">set</span> seq_id <span class="m">1</span>     // 初始化自增ID为1
OK
127.0.0.1:6379&gt; incr seq_id      // 增加1，并返回
<span class="o">(</span>integer<span class="o">)</span> <span class="m">2</span>
127.0.0.1:6379&gt; incr seq_id      // 增加1，并返回
<span class="o">(</span>integer<span class="o">)</span> <span class="m">3</span>
</code></pre></td></tr></table>
</div>
</div><p>Redis supports both RDB and AOF persistence.</p>
<ul>
<li>RDB persistence is equivalent to taking a snapshot for persistence at regular intervals. If after taking a snapshot, it self-increments several times in a row before it has time to do the next snapshot persistence, Redis hangs at this time and the ID will be duplicated after restarting Redis.</li>
<li>AOF persistence is equivalent to persisting every write command. If Redis hangs, there will be no ID duplication, but it will take too long to restart and recover the data due to the incr command passing.</li>
</ul>
<p>Advantages.</p>
<ul>
<li>Ordered incremental, readable.</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Bandwidth hungry, each time a request is made to Redis.</li>
</ul>
<h2 id="timestamp--random-number">Timestamp + Random Number</h2>
<p>Advantages.</p>
<ul>
<li>Simple coding</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>There is a duplication problem with random numbers, even with the same timestamp. Need to check if the same value already exists before each insert into the database.</li>
</ul>
<h2 id="timestamp--member-id">Timestamp + Member ID</h2>
<p>Advantages.</p>
<ul>
<li>No two orders exist for one user at the same time</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Member ID will also reveal operational data, the chicken lays the egg and the egg lays the chicken</li>
</ul>
<h2 id="uuidguid">UUID/GUID</h2>
<p>The standard type of UUID (Universally Unique Identifier) contains 32 hexadecimal digits, divided into five segments by hyphen, in the form of 36 characters of 8-4-4-4-12, example: 550e8400-e29b-41d4-a716-446655440000, so far the industry has a total of 5 There are five ways to generate UUIDs so far, see the IETF UUID specification <a href="http://www.ietf.org/rfc/rfc4122.txt">A Universally Unique IDentifier (UUID) URN Namespace</a> for details.</p>
<p>Advantages.</p>
<ul>
<li>Simplicity</li>
<li>Very high performance: locally generated, no network consumption.</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Not user friendly</li>
<li>Not easy to store: The UUID is too long, 16 bytes and 128 bits, usually represented as a 36-length string, which is not applicable in many scenarios.</li>
<li>Insecure information: The algorithm of generating UUID based on MAC address may cause MAC address leakage, a vulnerability that was used to find the location of the creator of Melissa virus.</li>
<li>There are some problems in specific environments when ID is used as primary key, for example, the scenario of being DB primary key, UUID is very inapplicable:.
<ul>
<li>MySQL has a clear official recommendation <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-index-types.html">to keep the primary key as short as possible</a>, and a UUID of 36 characters in length does not meet the requirement.</li>
<li>Not good for MySQL index: If used as database primary key, the unordered nature of UUID may cause frequent data location changes under InnoDB engine, which seriously affects performance.</li>
</ul>
</li>
</ul>
<h2 id="uuid-variants">UUID variants</h2>
<p>The more popular UUID variant is based on the MySQL UUID variant: timestamp + machine number + random, as described in [GUID/UUID Performance Breakthrough](<a href="http://mysql.rjweb.org/doc.php/">http://mysql.rjweb.org/doc.php/</a> uuid)</p>
<p>Advantages.</p>
<ul>
<li>Lower development cost</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Poor performance based on MySQL stored procedures</li>
</ul>
<p>Also, with the advent of the <a href="https://dev.mysql.com/doc/refman/8.0/en/miscellaneous-functions.html#function_uuid-to-bin">UUID_TO_BIN(str, swap_flag)</a> method, the the above implementations are not so applicable anymore.</p>
<h2 id="snowflake">Snowflake</h2>
<p><a href="https://github.com/twitter/snowflake">Snowflake</a> is a global unique id generation scheme open sourced by Twitter. The background of the Twitter-Snowflake algorithm is quite simple, in order to meet the tens of thousands of messages per second requested by Twitter, each message must be The core of the Snowflake algorithm combines a timestamp, a working machine id, and a sequence number (41 bits of millisecond time + 10 bits of machine ID + 12 bits of sequence in milliseconds).</p>
<p>In the above string, the first bit is unused (and can actually be used as a sign bit for long), the next 41 bits are the millisecond time, then 5 bits datacenter identification bits, 5 bits machine ID (not really an identifier, but actually for the thread identification), and then 12 bits the current count in milliseconds within that millisecond, adding up to exactly 64 bits for a Long type.</p>
<p>Except for the highest bit which is marked as unavailable, the remaining three bit occupancy groups can be floated, depending on the specific business requirements. By default, the 41-bit timestamp can support the algorithm until 2082, the 10-bit work machine id can support 1023 machines, and the sequence number can support 4095 self-incrementing sequence ids generated in 1 millisecond.</p>
<p>Strictly speaking the use of the bit segment of the working machine id can be process level, at the machine level you can use MAC address to uniquely mark the working machine, and at the working process level you can use IP+Path to distinguish the working process. If there are fewer working machines, it is a good choice to use a configuration file to set this id, if there are too many machines the maintenance of the configuration file is a disaster.</p>
<p>The solution here is to need a process for job id assignment, which can use a simple process written by yourself to record the assignment id.</p>
<p>The work process interacts with the work id allocator just once when the work process is started, and then the work process can drop the allocated id data to a file by itself and read the id in the file directly for use in the next start. The bit segment of this work machine id can also be further split, such as using the first 5 bits to mark the process id and the last 5 bits to mark the thread id or something like that.</p>
<p>The sequence number is a series of self-incrementing ids (atomic is recommended for multi-threads), in order to handle the need to assign ids to multiple messages in the same millisecond, and if the sequence number is used up in the same millisecond, then &ldquo;wait until the next millisecond&rdquo;.</p>
<p>Snowflake is an algorithm that generates IDs by dividing namespaces (UUIDs are also counted, and are analyzed separately because they are more common), and this scheme divides the 64-bit into multiple segments: timestamp + work number + seq number, separately to indicate the machine, time, etc.</p>
<p>Advantages.</p>
<ul>
<li>The milliseconds are at the high level, the self-incrementing sequence is at the low level, and the entire ID is trending incrementally.</li>
<li>It does not depend on third-party systems such as databases, and is deployed as a service, which is more stable and generates IDs with very high performance.</li>
<li>It is very flexible as you can assign bit bits according to your business characteristics.</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Strong dependence on machine clock, if the clock on the machine dials back, it will lead to duplicate issuing numbers or the service will be in unavailable state.</li>
<li>Need to introduce zookeeper and independent snowflake dedicated server</li>
</ul>
<p>The specific implementation has the following options in addition to the official Scala version.</p>
<ul>
<li>Java version: <a href="https://github.com/sumory/uc/blob/master/src/com/sumory/uc/id/IdWorker.java">https://github.com/sumory/uc/blob/master/src/com/sumory/uc/id/IdWorker.java</a></li>
<li>Go language version: <a href="https://github.com/sumory/idgen">https://github.com/sumory/idgen</a></li>
<li>Python version: <a href="https://github.com/erans/pysnowflake">https://github.com/erans/pysnowflake</a></li>
</ul>
<h2 id="snowflake-variants">Snowflake variants</h2>
<p>snowflake&rsquo;s algorithm is still good, in fact, itself is not complicated, the complexity is how your client uses. The problems encountered are as follows.</p>
<ul>
<li>The code is deployed on different servers, how to set the machine ID in the middle, is there a more convenient way to get the machine ID?</li>
<li>The whole algorithm relies on time continuity, but the display environment is that the online servers are all enabled with ntp, and the ntp case will have the problem of time regression.</li>
</ul>
<p>Snowflake generated unique ID process.</p>
<ul>
<li>10 bits of machine number, obtained from a Zookeeper cluster when the ID-assigning worker starts (to ensure that all workers do not have duplicate machine numbers)</li>
<li>41 bits of Timestamp: Each time a new ID is generated, the current Timestamp is fetched, and the sequence number is generated in two cases:</li>
<li>If the current Timestamp is the same as the Timestamp of the previous generated ID (in the same millisecond), the sequence number of the previous ID + 1 is used as the new sequence number (12 bits); if all the IDs in this millisecond are used up, wait until the next millisecond to continue (during this waiting process, no new IDs can be (during this wait, no new IDs can be assigned)</li>
<li>If the current Timestamp is larger than the previous ID&rsquo;s Timestamp, a random initial sequence number (12 bits) is generated as the first sequence number in this millisecond</li>
</ul>
<p>The whole process is decentralized, except for the external dependency when the worker is started (it needs to get the worker number from Zookeeper), and then it can work independently.</p>
<p>Exceptions discussion:</p>
<ul>
<li>When fetching the current timestamp, what if the timestamp fetched is smaller than the timestamp of the previous generated ID? Snowflake&rsquo;s approach is to continue fetching the current machine&rsquo;s time until a larger Timestamp is fetched (while waiting, no new IDs can be assigned).</li>
</ul>
<p>As you can see from this exception, if there is a large deviation in the clocks of the machines Snowflake is running on, the whole Snowflake system will not work properly (the more deviations, the longer the wait time to assign a new ID). As you can see from Snowflake&rsquo;s official documentation (<a href="https://github.com/twitter/snowflake/#system-clock-dependency">https://github.com/twitter/snowflake/#system-clock-dependency</a>) it explicitly requires that &ldquo;You should use NTP to keep your system clock accurate&rdquo;. And it is better to configure NTP in a mode that does not adjust backwards. In other words, when NTP corrects the time, it will not dial back the machine clock.</p>
<h3 id="solving-time-synchronization-problems">Solving time synchronization problems</h3>
<p>Options that can be taken to solve the above mentioned timing problems.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>
 
<span class="cm">/**
</span><span class="cm"> * 自定义 ID 生成器
</span><span class="cm"> * ID 生成规则: ID长达 64 bits
</span><span class="cm"> * 
</span><span class="cm"> * | 41 bits: Timestamp (毫秒) | 3 bits: 区域（机房） | 10 bits: 机器编号 | 10 bits: 序列号 |
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomUUID</span> <span class="o">{</span>
    <span class="c1">// 基准时间
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="n">twepoch</span> <span class="o">=</span> <span class="n">1288834974657L</span><span class="o">;</span> <span class="c1">//Thu, 04 Nov 2010 01:42:54 GMT
</span><span class="c1"></span>    <span class="c1">// 区域标志位数
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">regionIdBits</span> <span class="o">=</span> <span class="n">3L</span><span class="o">;</span>
    <span class="c1">// 机器标识位数
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">workerIdBits</span> <span class="o">=</span> <span class="n">10L</span><span class="o">;</span>
    <span class="c1">// 序列号识位数
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">sequenceBits</span> <span class="o">=</span> <span class="n">10L</span><span class="o">;</span>
 
    <span class="c1">// 区域标志ID最大值
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">maxRegionId</span> <span class="o">=</span> <span class="o">-</span><span class="n">1L</span> <span class="o">^</span> <span class="o">(-</span><span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">regionIdBits</span><span class="o">);</span>
    <span class="c1">// 机器ID最大值
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">maxWorkerId</span> <span class="o">=</span> <span class="o">-</span><span class="n">1L</span> <span class="o">^</span> <span class="o">(-</span><span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">workerIdBits</span><span class="o">);</span>
    <span class="c1">// 序列号ID最大值
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">sequenceMask</span> <span class="o">=</span> <span class="o">-</span><span class="n">1L</span> <span class="o">^</span> <span class="o">(-</span><span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">sequenceBits</span><span class="o">);</span>
 
    <span class="c1">// 机器ID偏左移10位
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">workerIdShift</span> <span class="o">=</span> <span class="n">sequenceBits</span><span class="o">;</span>
    <span class="c1">// 业务ID偏左移20位
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">regionIdShift</span> <span class="o">=</span> <span class="n">sequenceBits</span> <span class="o">+</span> <span class="n">workerIdBits</span><span class="o">;</span>
    <span class="c1">// 时间毫秒左移23位
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">timestampLeftShift</span> <span class="o">=</span> <span class="n">sequenceBits</span> <span class="o">+</span> <span class="n">workerIdBits</span> <span class="o">+</span> <span class="n">regionIdBits</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="o">-</span><span class="n">1L</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">workerId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">regionId</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">CustomUUID</span><span class="o">(</span><span class="kt">long</span> <span class="n">workerId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">regionId</span><span class="o">)</span> <span class="o">{</span>
 
        <span class="c1">// 如果超出范围就抛出异常
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">workerId</span> <span class="o">&gt;</span> <span class="n">maxWorkerId</span> <span class="o">||</span> <span class="n">workerId</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;worker Id can&#39;t be greater than %d or less than 0&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">regionId</span> <span class="o">&gt;</span> <span class="n">maxRegionId</span> <span class="o">||</span> <span class="n">regionId</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;datacenter Id can&#39;t be greater than %d or less than 0&#34;</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="k">this</span><span class="o">.</span><span class="na">workerId</span> <span class="o">=</span> <span class="n">workerId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">regionId</span> <span class="o">=</span> <span class="n">regionId</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nf">CustomUUID</span><span class="o">(</span><span class="kt">long</span> <span class="n">workerId</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果超出范围就抛出异常
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">workerId</span> <span class="o">&gt;</span> <span class="n">maxWorkerId</span> <span class="o">||</span> <span class="n">workerId</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;worker Id can&#39;t be greater than %d or less than 0&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workerId</span> <span class="o">=</span> <span class="n">workerId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">regionId</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">nextId</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="cm">/**
</span><span class="cm">     * 实际产生代码的
</span><span class="cm">     *
</span><span class="cm">     * @param isPadding
</span><span class="cm">     * @param busId
</span><span class="cm">     * @return
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">long</span> <span class="nf">nextId</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isPadding</span><span class="o">,</span> <span class="kt">long</span> <span class="n">busId</span><span class="o">)</span> <span class="o">{</span>
 
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timeGen</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">paddingnum</span> <span class="o">=</span> <span class="n">regionId</span><span class="o">;</span>
 
        <span class="k">if</span> <span class="o">(</span><span class="n">isPadding</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">paddingnum</span> <span class="o">=</span> <span class="n">busId</span><span class="o">;</span>
        <span class="o">}</span>
 
        <span class="k">if</span> <span class="o">(</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">lastTimestamp</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="s">&#34;Clock moved backwards.  Refusing to generate id for &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastTimestamp</span> <span class="o">-</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; milliseconds&#34;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
 
        <span class="c1">//如果上次生成时间和当前时间相同,在同一毫秒内
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">lastTimestamp</span> <span class="o">==</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//sequence自增，因为sequence只有10bit，所以和sequenceMask相与一下，去掉高位
</span><span class="c1"></span>            <span class="n">sequence</span> <span class="o">=</span> <span class="o">(</span><span class="n">sequence</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">sequenceMask</span><span class="o">;</span>
            <span class="c1">//判断是否溢出,也就是每毫秒内超过1024，当为1024时，与sequenceMask相与，sequence就等于0
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">sequence</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//自旋等待到下一毫秒
</span><span class="c1"></span>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">tailNextMillis</span><span class="o">(</span><span class="n">lastTimestamp</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 如果和上次生成时间不同,重置sequence，就是下一毫秒开始，sequence计数重新从0开始累加,
</span><span class="c1"></span>            <span class="c1">// 为了保证尾数随机性更大一些,最后一位设置一个随机数
</span><span class="c1"></span>            <span class="n">sequence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SecureRandom</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">;</span>
 
        <span class="k">return</span> <span class="o">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">twepoch</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="n">timestampLeftShift</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">paddingnum</span> <span class="o">&lt;&lt;</span> <span class="n">regionIdShift</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">workerId</span> <span class="o">&lt;&lt;</span> <span class="n">workerIdShift</span><span class="o">)</span> <span class="o">|</span> <span class="n">sequence</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="c1">// 防止产生的时间比之前的时间还要小（由于NTP回拨等问题）,保持增量的趋势.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kt">long</span> <span class="nf">tailNextMillis</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">lastTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">timeGen</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">lastTimestamp</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">timeGen</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="c1">// 获取当前的时间戳
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">long</span> <span class="nf">timeGen</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using this method requires attention to.</p>
<ul>
<li>In order to keep the growing trend, avoid the time of some servers early and some servers late, you need to control the time of all servers, and avoid the NTP time server to call back the time of the server.</li>
<li>The sequence number is always returned to 0 when spanning milliseconds, which will make more IDs with sequence number 0, resulting in uneven generated IDs after modulo, so the sequence number is not returned to 0 every time, but to a random number from 0 to 9.</li>
<li>It is better to use this CustomUUID class in a system that can keep the single instance mode running.</li>
</ul>
<h3 id="solving-distributed-deployments">Solving distributed deployments</h3>
<p>There are some variants of Snowflake, and individual applications have made some changes to Snowflake to suit their actual scenarios.</p>
<p><strong><a href="https://github.com/boundary/flake">Boundary flake</a></strong></p>
<p>Changes:</p>
<ul>
<li>ID length extended to 128 bits</li>
<li>Up to 64 bits timestamp</li>
<li>Then a 48 bits Worker number (as long as the Mac address)</li>
<li>Finally, a 16 bits Seq Number</li>
<li>Since it uses 48 bits as the Worker ID, the same length as the Mac address, there is no need to communicate with Zookeeper to get the Worker ID at startup.</li>
<li>It is based on Erlang.</li>
</ul>
<p>The purpose of this is to achieve a smaller conflict probability with more bits, so that more workers can work at the same time. It can also allocate more IDs per millisecond.</p>
<p><strong><a href="https://github.com/SawdustSoftware/simpleflake">Simpleflake</a></strong></p>
<p>The idea of Simpleflake is to eliminate the worker number, keep the 41 bits timestamp, and extend the sequence number to 22 bits.</p>
<p>Features of Simpleflake.</p>
<ul>
<li>sequence number is generated completely at random (this also leads to duplicate IDs)</li>
<li>There is no worker number, so there is no need to communicate with Zookeeper, which makes it completely decentralized.</li>
<li>Timestamp remains the same as Snowflake, so you can seamlessly upgrade to Snowflake in the future</li>
</ul>
<p>The problem with Simpleflake is that the sequence number is generated completely randomly, leading to the possibility of duplicate generated IDs. The probability of duplicate generated IDs grows with the number of IDs generated per second.</p>
<p>So the limitation of Simpleflake is that it cannot generate too many IDs per second (preferably less than 100 times/sec, if the scenario is greater than 100 times/sec, Simpleflake is not applicable and it is recommended to switch back to Snowflake).</p>
<p><strong><a href="https://docs.mongodb.com/manual/reference/method/ObjectId/#description">MongoDB ObjectID</a></strong></p>
<p>MongoDB official documentation ObjectID can be regarded as similar to snowflake method, through &ldquo;time + machine code + pid + inc&rdquo; a total of 12 bytes, through the way 4 + 3 + 2 + 3 finally identified into a 24-length hexadecimal characters. Compared to snowflake length and readability is less.</p>
<p><strong><a href="https://github.com/baidu/uid-generator">Baidu uid-generator</a></strong></p>
<p>uid-generator uses snowflake, but differs in the production of the machine id, also called workId. uid-generator&rsquo;s workId is automatically generated by uid-generator and takes into account that the application is deployed on docker, in uid-generator generator, the default policy is: the workId is assigned by the database when the application is started. To put it simply, the application will insert a piece of data into the database table (uid-generator needs to add a new WORKER_NODE table) at startup, and the unique id corresponding to the data returned after successful insertion is the workId of the machine, and the data consists of host and port. For the workId in the uid-generator, it occupies 22 bits, the time occupies 28 bits, and the serialization occupies 13 bits. It should be noted that, unlike the original snowflake, the unit of time is seconds, not milliseconds, and the workId is different, as the same application consumes one workId per restart. workId every time the same application restarts.</p>
<p><strong><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Meituan Leaf</a></strong></p>
<p>Leaf by Meituan is also a distributed ID generation framework. It is very comprehensive, i.e., it supports number segment mode as well as snowflake mode.</p>
<p>Number mode can be understood as a bulk acquisition, such as the DistributIdService from the database to get IDs, if you can get multiple IDs in bulk and cached locally, then it will greatly provide the efficiency of the business application to get IDs. For example, each time the DistributionIdService obtains IDs from the database, it obtains a number range, such as (1,1000], which represents 1000 IDs, and when the business application requests the DistributionIdService to provide IDs, the DistributionIdService only needs to increment itself locally from 1 and return Instead of requesting the database every time, the business application will only need to go to the database to get the next ID when the local self-increment reaches 1000, i.e., when the current ID has been used up.</p>
<p>The difference between Leaf&rsquo;s snowflake pattern and the original snowflake algorithm is mainly in the generation of workId, which is based on ZooKeeper&rsquo;s sequential Id.</p>
<h2 id="flickrs-database-is-self-increasing">Flickr&rsquo;s database is self-increasing</h2>
<p>Flickr is using something called <a href="https://code.flickr.net/2010/02/08/ticket-servers-distributed-unique-primary-keys-on-the-cheap/">Ticket Servers</a>. It is implemented using pure MySQL.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">Tickets64</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">auto_increment</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">stub</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w">  </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">stub</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">stub</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Insert a record first, then use replace to get the id</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">REPLACE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Tickets64</span><span class="w"> </span><span class="p">(</span><span class="n">stub</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">LAST_INSERT_ID</span><span class="p">();</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Advantages.</p>
<ul>
<li>Very simple, using the existing database system functions to achieve, small cost, with DBA professional maintenance.</li>
<li>ID number is monotonically self-increasing, which can realize some business with special requirements for ID.</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>Strong dependency on DB, when DB is abnormal the whole system is unavailable, which is a fatal problem. Configuring master-slave replication can increase the availability as much as possible, but data consistency is difficult to guarantee in special cases. Inconsistency in master-slave switchover may lead to duplicate issuance.</li>
<li>The ID issuance performance bottleneck is limited to the read and write performance of a single MySQL.</li>
</ul>
<p>For MySQL performance problem, the following solution can be used: In a distributed system we can deploy several machines, and each machine sets different initial values with equal step size and number of machines. For example, there are two machines. The initial value of TicketServer1 is 1 (1, 3, 5, 7, 9, 11&hellip;) and the initial value of TicketServer2 is 2 (2, 4, 6, 8, 10&hellip;).</p>
<h2 id="instagram-stored-procedures">Instagram Stored Procedures</h2>
<p>The Instagram ID generation is simply described as 41b ts + 13b shard id + 10b increment seq.</p>
<ul>
<li>41 bits: Timestamp (milliseconds)</li>
<li>13 bits: code number of each logic shard (maximum 8 * 1024 logic shards supported)</li>
<li>10 bits: sequence number, each Shard can generate up to 1024 IDs per millisecond</li>
</ul>
<p>The implementation is as follows.</p>
<ul>
<li>first divide each Table into logical shards, the number of logical shards can be very large, for example, 2000 logical shards</li>
<li>Then make a rule that specifies which database instance each logical shard is stored in; there need not be many database instances, for example, for a system with 2 PostgreSQL instances (instagram using PostgreSQL) you can use the rule that the odd number of logical shards are stored in the first database instance and the even number of logical shards are stored in the second database instance</li>
<li>Specify one field per Table as the slice field (e.g. for user tables you can specify uid as the slice field)</li>
<li>When inserting a new data, first decide which logical shard the data is assigned to based on the value of the shard field.</li>
<li>Then, based on the correspondence between the logic shard and the PostgreSQL instance, determine which PostgreSQL instance the data should be stored on</li>
</ul>
<p>The 41 bits Timestamp is similar to Snowflake when generating unique IDs, and this cry mainly describes how to generate the 13 bits logic Shard code and the 10 bits sequence number.</p>
<p>logic Shard code.</p>
<ul>
<li>Suppose a new user record is inserted, and when inserting, the uid is used to determine which logic shard the record should be inserted into.</li>
<li>Assume that the current record to be inserted will be inserted into logic shard number 1341 (assuming that there are 2000 logic shards in this Table)</li>
<li>The 13 bits of the newly generated ID will be filled with the number 1341</li>
</ul>
<p>The sequence number is generated using the auto-increment sequence on each PostgreSQL Table.</p>
<ul>
<li>If there are already 5000 rows on the current table, then the next auto-increment sequence for this table is 5001 (you can get it directly by calling the method provided by PL/PGSQL)</li>
<li>Then this 5001 is modulo 1024 to get a sequence number of 10 bits</li>
</ul>
<p>The advantage of the Instagram solution is that</p>
<ul>
<li>Using the logic Shard number to replace the Worker number used by Snowflake, there is no need to go to the central node to get the Worker number, so it is completely decentralized.</li>
<li>You can directly know which logic shard the record is stored on by its ID</li>
<li>When you do data migration in the future, you can also do data migration by logic shard, which will not affect the future data migration.</li>
</ul>
<p>For more details, see: <a href="https://instagram-engineering.com/sharding-ids-at-instagram-1cf5a71e5a5c">Sharding &amp; IDs at Instagram</a></p>
<p>Advantages.</p>
<ul>
<li>Low development costs</li>
</ul>
<p>Disadvantages.</p>
<ul>
<li>PostgreSQL-based stored procedures, poor generality</li>
</ul>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/finding-user-sessions-with-sql/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Finding User Sessions With Sql</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/readability/">
            <span class="next-text nav-default">Readability, a web body extraction tool</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
