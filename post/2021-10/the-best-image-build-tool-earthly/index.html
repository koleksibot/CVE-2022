<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Earthly A more powerful image builder  - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Introduction to Earthly Earthly is a more advanced Docker image builder, Earthly replaces the traditional Dockerfile with its own Earthfile; Earthfile is as Earthly officially describes: Makefile &#43; Dockerfile = Earthfile Earthly supports some Dockerfile extension syntax through buildkit, and integrates Dockerfile with Makefile, making it easier to build and code Dockerfile for multiple platforms; Earthly makes it easier to reuse Dockerfile code and more CI-friendly automatic integration. Quick Start" /><meta name="keywords" content="earthly, docker" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/the-best-image-build-tool-earthly/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Earthly A more powerful image builder " />
<meta property="og:description" content="Introduction to Earthly Earthly is a more advanced Docker image builder, Earthly replaces the traditional Dockerfile with its own Earthfile; Earthfile is as Earthly officially describes: Makefile &#43; Dockerfile = Earthfile Earthly supports some Dockerfile extension syntax through buildkit, and integrates Dockerfile with Makefile, making it easier to build and code Dockerfile for multiple platforms; Earthly makes it easier to reuse Dockerfile code and more CI-friendly automatic integration. Quick Start" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/the-best-image-build-tool-earthly/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-31T17:21:15+08:00" />
<meta property="article:modified_time" content="2021-10-31T17:21:15+08:00" />

<meta itemprop="name" content="Earthly A more powerful image builder ">
<meta itemprop="description" content="Introduction to Earthly Earthly is a more advanced Docker image builder, Earthly replaces the traditional Dockerfile with its own Earthfile; Earthfile is as Earthly officially describes: Makefile &#43; Dockerfile = Earthfile Earthly supports some Dockerfile extension syntax through buildkit, and integrates Dockerfile with Makefile, making it easier to build and code Dockerfile for multiple platforms; Earthly makes it easier to reuse Dockerfile code and more CI-friendly automatic integration. Quick Start"><meta itemprop="datePublished" content="2021-10-31T17:21:15+08:00" />
<meta itemprop="dateModified" content="2021-10-31T17:21:15+08:00" />
<meta itemprop="wordCount" content="1521">
<meta itemprop="keywords" content="earthly,docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Earthly A more powerful image builder "/>
<meta name="twitter:description" content="Introduction to Earthly Earthly is a more advanced Docker image builder, Earthly replaces the traditional Dockerfile with its own Earthfile; Earthfile is as Earthly officially describes: Makefile &#43; Dockerfile = Earthfile Earthly supports some Dockerfile extension syntax through buildkit, and integrates Dockerfile with Makefile, making it easier to build and code Dockerfile for multiple platforms; Earthly makes it easier to reuse Dockerfile code and more CI-friendly automatic integration. Quick Start"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Earthly A more powerful image builder </h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-31 17:21:15 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1521 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction-to-earthly">Introduction to Earthly</a></li>
        <li><a href="#quick-start">Quick Start</a>
          <ul>
            <li><a href="#21-installing-dependencies">2.1. Installing Dependencies</a></li>
            <li><a href="#22-installing-earthly">2.2, Installing Earthly</a></li>
            <li><a href="#23-syntax-highlighting">2.3. Syntax highlighting</a></li>
            <li><a href="#24-basic-use">2.4, basic use</a></li>
          </ul>
        </li>
        <li><a href="#advanced-use">Advanced Use</a>
          <ul>
            <li><a href="#31-multi-stage-construction">3.1. Multi-stage construction</a></li>
            <li><a href="#32-extended-command">3.2, Extended command</a></li>
            <li><a href="#33udcs">3.3、UDCS</a></li>
            <li><a href="#34-multi-platform-build">3.4, multi-platform build</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="introduction-to-earthly">Introduction to Earthly</h2>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/43c6556cc8ea469194656a387c82f838.png" alt=""></p>
<p>Earthly is a more advanced Docker image builder, Earthly replaces the traditional Dockerfile with its own Earthfile; Earthfile is as Earthly officially describes:</p>
<p><strong>Makefile + Dockerfile = Earthfile</strong></p>
<p>Earthly supports some Dockerfile extension syntax through buildkit, and integrates Dockerfile with Makefile, making it easier to build and code Dockerfile for multiple platforms; Earthly makes it easier to reuse Dockerfile code and more CI-friendly automatic integration.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="21-installing-dependencies">2.1. Installing Dependencies</h3>
<p>Earthly currently relies on Docker and Git, so make sure you have Docker and Git installed on your machine before installing Earthly.</p>
<h3 id="22-installing-earthly">2.2, Installing Earthly</h3>
<p>Earthly is written in Go, so it is mainly a binary file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo /bin/sh -c <span class="s1">&#39;wget https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 -O /usr/local/bin/earthly &amp;&amp; chmod +x /usr/local/bin/earthly &amp;&amp; /usr/local/bin/earthly bootstrap --with-autocomplete&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>After installation Earthly will start a buildkitd container: <code>earthly-buildkitd</code>.</p>
<h3 id="23-syntax-highlighting">2.3. Syntax highlighting</h3>
<p>Earthly officially supports syntax highlighting for VS Code, VIM and Sublime Text, please refer to the <a href="https://earthly.dev/get-earthly">official documentation</a> for details.</p>
<h3 id="24-basic-use">2.4, basic use</h3>
<p>This example is derived from the official Basic tutorial, the following example to compile a Go project as a sample:</p>
<p>first create a directory of any name in which the project source code files and an <code>Earthfile</code> file.</p>
<p><strong>main.go</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Earthfile</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> golang:1.17-alpine</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go-example</span><span class="err">
</span><span class="err">
</span><span class="err"></span>build:<span class="err">
</span><span class="err"></span>    COPY main.go .<span class="err">
</span><span class="err"></span>    RUN go build -o build/go-example main.go<span class="err">
</span><span class="err"></span>    SAVE ARTIFACT build/go-example /go-example AS LOCAL build/go-example<span class="err">
</span><span class="err">
</span><span class="err"></span>docker:<span class="err">
</span><span class="err"></span>    COPY +build/go-example .<span class="err">
</span><span class="err"></span>    ENTRYPOINT <span class="o">[</span><span class="s2">&#34;/go-example/go-example&#34;</span><span class="o">]</span><span class="err">
</span><span class="err"></span>    SAVE IMAGE go-example:latest<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Once we have <code>Earthfile</code> we can use <code>Earthly</code> to package it as a mirror.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># 目录结构
~/t/earthlytest ❯❯❯ tree
.
├── Earthfile
└── main.go

0 directories, 2 files

# 通过 earthly 进行构建
~/t/earthlytest ❯❯❯ earthly +docker
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/d519e16838c64248b9a7fb6a47281c23.png" alt=""></p>
<p>Once the build is complete, we can view the image we just built directly from docker&rsquo;s images list and run:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/b39906292aa0413abdb8ac1232f7aea6.png" alt=""></p>
<h2 id="advanced-use">Advanced Use</h2>
<h3 id="31-multi-stage-construction">3.1. Multi-stage construction</h3>
<p>Earthfile contains Makefile-like <code>targets</code>, and the different <code>targets</code> can be referenced by a specific syntax, each <code>target</code> can be executed separately, and earthly will automatically resolve these dependencies during execution.</p>
<p>This multi-stage build time syntax is flexible enough that we can run separate commands at each stage and use different base images; as you can see from the quick start, we always use a base image ( <code>golang:1.17-alpine</code>), and for applications like Go that compile with their own runtime and do not rely on their language SDK, we can in fact put the &ldquo;distributions&rdquo; inside a simple runtime image, thus reducing the size of the final image:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/bc5353c1fd984aa7af55689964ab9c2b.png" alt=""></p>
<p>Since we use multiple targets, we can run the <code>build</code> target separately to verify our compilation process. <strong>This multi-target design allows us to build our application with a finer separation of compilation and packaging steps, and also allows us to verify them separately.</strong> For example, we can run the <code>build</code> target separately to verify that our compilation process is correct:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/cdb94baa09844f1686fcd6fc804b5c7e.png" alt=""></p>
<p>After the other phases are verified, we can run the final target directly, and earthly will automatically recognize the dependency and run its dependent target automatically:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/e0f71122fadd488996efb5770975f5c8.png" alt=""></p>
<h3 id="32-extended-command">3.2, Extended command</h3>
<h4 id="321-save">3.2.1, SAVE</h4>
<p>The SAVE instruction is one of Earthly&rsquo;s own extension instructions, actually divided into <code>SAVE ARTIFACT</code> and <code>SAVE IMAGE</code>; where the <code>SAVE ARTIFACT</code> instruction format is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">SAVE ARTIFACT <span class="o">[</span>--keep-ts<span class="o">]</span> <span class="o">[</span>--keep-own<span class="o">]</span> <span class="o">[</span>--if-exists<span class="o">]</span> <span class="o">[</span>--force<span class="o">]</span> &lt;src&gt; <span class="o">[</span>&lt;artifact-dest-path&gt;<span class="o">]</span> <span class="o">[</span>AS LOCAL &lt;local-path&gt;<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>SAVE ARTIFACT</code> command is used to save a file or directory from the build runtime environment to the target&rsquo;s artifact environment; once saved to the artifact environment, it can be referenced in other locations with commands such as <code>COPY</code>, similar to Dockerfile&rsquo;s <code>COPY --from...</code> syntax; the difference is that <code>SAVE ARTIFACT</code> supports the <code>AS LOCAL &lt;local-path&gt;</code> additional parameter. syntax; the difference is that <code>SAVE ARTIFACT</code> supports the <code>AS LOCAL &lt;local-path&gt;</code> additional parameter, which when specified will make a copy of the file or directory on the host at the same time, generally for debugging purposes. The <code>SAVE ARTIFACT</code> command is shown in the example above, and after running the <code>earthly +build</code> command you will actually see the SAVed ARTIFACT locally:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/f212d6b1bbd34ff7bbd8dacc9ef2879a.png" alt=""></p>
<p>The other <code>SAVE IMAGE</code> command is used to SAVE the current build environment into an IMAGE, <strong>if the <code>-push</code> option is specified and the <code>-push</code> option is added when executing the <code>earthly +target</code> command, the image will be pushed to the target Registry automatically.</strong> The <code>-SAVE IMAGE</code> command has the following format:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">SAVE IMAGE <span class="o">[</span>--cache-from<span class="o">=</span>&lt;cache-image&gt;<span class="o">]</span> <span class="o">[</span>--push<span class="o">]</span> &lt;image-name&gt;...
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/6c1af26ee56e41a9a2bd4b8ebc852dc9.png" alt=""></p>
<h4 id="322-git-clone">3.2.2, GIT CLONE</h4>
<p>The <code>GIT CLONE</code> command is used to clone a given git repository into the build environment; unlike the <code>RUN git clone...</code> command, <strong><code>GIT CLONE</code> runs through the host git command, it does not depend on the git command inside the container, and you can also configure git authentication directly for earthly to avoid leaking this security information into the build environment;</strong> please refer to the <a href="https://docs.earthly.dev/docs/guides/auth">official documentation</a> for more information on how to configure git authentication for earthly.  here is a sample of the <code>GIT CLONE</code> command:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/566a125170ed4ff49dff277cab462229.png" alt=""></p>
<h4 id="323-_copy">3.2.3, _COPY</h4>
<p>The <code>COPY</code> directive is similar to the standard Dockerfile COPY directive, in addition to supporting the standard Dockerfile COPY function, the <code>COPY</code> directive in **earthly can reference artifacts generated by other target loops, and will automatically declare dependencies when referencing them; that is, when a similar directive exists in the <code>B</code> target If you simply execute <code>earthly +B</code>, then earthly will determine from the dependency analysis that target A needs to be executed before COPY:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># 与 Dockerfile 相同的使用方式，从上下文复制
COPY [options...] &lt;src&gt;... &lt;dest&gt;

# 扩展支持的从 target 复制方式
COPY [options...] &lt;src-artifact&gt;... &lt;dest&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="324-run">3.2.4, RUN</h4>
<p>The <code>RUN</code> command is consistent with the standard use of Dockerfile, but with more extended options, the command format is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># shell 方式运行(/bin/sh -c)
RUN [--push] [--entrypoint] [--privileged] [--secret &lt;env-var&gt;=&lt;secret-ref&gt;] [--ssh] [--mount &lt;mount-spec&gt;] [--] &lt;command&gt;

# exec 方式运行
RUN [[&lt;flags&gt;...], &#34;&lt;executable&gt;&#34;, &#34;&lt;arg1&gt;&#34;, &#34;&lt;arg2&gt;&#34;, ...]
</code></pre></td></tr></table>
</div>
</div><p>The <code>--privileged</code> option allows running commands to use <code>privileged capabilities</code>, but requires earthly to add the <code>--allow-privileged</code> option when running the target; the <code>--interactive / --interactive- keep</code> option is used to interactively execute some commands, and build continues after the interaction is complete, <strong>operations performed during the interaction are persisted to the image:</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/e44d8fcb73af4b8f9c0aa3150af84015.png" alt=""></p>
<p>For reasons of space, please refer to the official documentation <a href="https://docs.earthly.dev/docs/earthfile">Earthfile reference</a> for other specific commands.</p>
<h3 id="33udcs">3.3、UDCS</h3>
<p>UDCs are called &ldquo;User-defined commands&rdquo;, i.e. user-defined commands; through UDCs we can strip out specific commands from Earthfile, thus achieving more general and uniform code reuse; here is a sample of defining UDCs commands:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># 定义一个 Command</span><span class="err">
</span><span class="err"></span><span class="c"># ⚠️ 注意: 语法必须满足以下规则</span><span class="err">
</span><span class="err"></span><span class="c"># 1、名称全大写</span><span class="err">
</span><span class="err"></span><span class="c"># 2、名称下划线分割</span><span class="err">
</span><span class="err"></span><span class="c"># 3、首个命令必须为 COMMAND(后面没有冒号)</span><span class="err">
</span><span class="err"></span>MY_COPY:<span class="err">
</span><span class="err"></span>    COMMAND<span class="err">
</span><span class="err"></span>    ARG src<span class="err">
</span><span class="err"></span>    ARG <span class="nv">dest</span><span class="o">=</span>./<span class="err">
</span><span class="err"></span>    ARG <span class="nv">recursive</span><span class="o">=</span>false<span class="err">
</span><span class="err"></span>    RUN cp <span class="k">$(if</span> <span class="nv">$recursive</span> <span class="o">=</span>  <span class="s2">&#34;true&#34;</span><span class="p">;</span> <span class="k">then</span> <span class="nb">printf</span> -- -r<span class="p">;</span> <span class="k">fi)</span> <span class="s2">&#34;</span><span class="nv">$src</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$dest</span><span class="s2">&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># target 中引用</span><span class="err">
</span><span class="err"></span>build:<span class="err">
</span><span class="err"></span>    FROM alpine:3.13<span class="err">
</span><span class="err"></span>    WORKDIR /udc-example<span class="err">
</span><span class="err"></span>    RUN <span class="nb">echo</span> <span class="s2">&#34;hello&#34;</span> &gt;./foo<span class="err">
</span><span class="err"></span>    <span class="c1"># 通过 DO 关键字引用 UDCs</span><span class="err">
</span><span class="err"></span>    DO +MY_COPY --src<span class="o">=</span>./foo --dest<span class="o">=</span>./bar<span class="err">
</span><span class="err"></span>    RUN cat ./bar <span class="c1"># prints &#34;hello&#34;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Not only can UDCs be defined in an Earthfile, UDCs can be referenced across files and directories:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/abdccfd5a2d8416f8ab80418d29bd3de.png" alt=""></p>
<p>With UDCs, we can abstract all the operations such as version control of the base image and general handling of special images in this way, and then each Earthfile can refer to them as needed.</p>
<h3 id="34-multi-platform-build">3.4, multi-platform build</h3>
<p>In the past, when using Dockerfile, we needed to configure and enable buildkit to achieve multi-platform builds; the configuration process may be tedious, but now earthly can help us achieve multi-platform cross-compilation by default, all we need to do is to declare which platforms we need to support in Earthfile:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/022ec0b68fe04ecdb48eb09b9122ed13.png" alt=""></p>
<p>The above Earthfile will automatically build all four platform images and keep a single tag when running the <code>earthly --push +all</code> build, and will also automatically push to Docker Hub thanks to the <code>-push</code> option:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/31/74ba1136a65744e8aa1b9f42a9dfa211.png" alt=""></p>
<h2 id="summary">Summary</h2>
<p>Earthly makes up for many of the shortcomings of Dockerfile and solves many of the pain points; however, it may also require some learning costs, but if you are already familiar with Dockerfile, the learning costs are actually not high; so it is still recommended to switch from Dockerfile to Earthfile for unified and versioned management. This article is limited by space (lazy) many places did not speak, such as the shared cache, so more detailed use of Earthly is best to read carefully <a href="https://docs.earthly.dev/docs/guides">official documentation</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/earthly/">earthly</a>
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/is-ddd-garbage-or-silver-bullet/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">DDD in the end is garbage or silver bullets</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/go-timeout/">
            <span class="next-text nav-default">Timeout control in Go</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
