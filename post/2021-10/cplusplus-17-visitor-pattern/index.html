<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Cplusplus 17 Visitor Pattern - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Visitor Pattern The accessor pattern is a behavioral pattern that allows arbitrary detached visitors to be able to access managed elements under the control of the manager. The visitor cannot change the definition of the object (but this is not mandatory, you can agree to allow changes). For the manager, it does not care how many visitors there actually are, it only cares about a defined order of access to the elements (for example, for a binary tree, you can provide multiple access orders such as mid-order, pre-order, etc." /><meta name="keywords" content="c&#43;&#43;, Visitor Pattern" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/cplusplus-17-visitor-pattern/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Cplusplus 17 Visitor Pattern" />
<meta property="og:description" content="Visitor Pattern The accessor pattern is a behavioral pattern that allows arbitrary detached visitors to be able to access managed elements under the control of the manager. The visitor cannot change the definition of the object (but this is not mandatory, you can agree to allow changes). For the manager, it does not care how many visitors there actually are, it only cares about a defined order of access to the elements (for example, for a binary tree, you can provide multiple access orders such as mid-order, pre-order, etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/cplusplus-17-visitor-pattern/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-05T16:38:23+08:00" />
<meta property="article:modified_time" content="2021-10-05T16:38:23+08:00" />

<meta itemprop="name" content="Cplusplus 17 Visitor Pattern">
<meta itemprop="description" content="Visitor Pattern The accessor pattern is a behavioral pattern that allows arbitrary detached visitors to be able to access managed elements under the control of the manager. The visitor cannot change the definition of the object (but this is not mandatory, you can agree to allow changes). For the manager, it does not care how many visitors there actually are, it only cares about a defined order of access to the elements (for example, for a binary tree, you can provide multiple access orders such as mid-order, pre-order, etc."><meta itemprop="datePublished" content="2021-10-05T16:38:23+08:00" />
<meta itemprop="dateModified" content="2021-10-05T16:38:23+08:00" />
<meta itemprop="wordCount" content="1871">
<meta itemprop="keywords" content="c&#43;&#43;," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cplusplus 17 Visitor Pattern"/>
<meta name="twitter:description" content="Visitor Pattern The accessor pattern is a behavioral pattern that allows arbitrary detached visitors to be able to access managed elements under the control of the manager. The visitor cannot change the definition of the object (but this is not mandatory, you can agree to allow changes). For the manager, it does not care how many visitors there actually are, it only cares about a defined order of access to the elements (for example, for a binary tree, you can provide multiple access orders such as mid-order, pre-order, etc."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Cplusplus 17 Visitor Pattern</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-05 16:38:23 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1871 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#visitor-pattern">Visitor Pattern</a>
          <ul>
            <li><a href="#composition">Composition</a></li>
            <li><a href="#interface">Interface</a></li>
            <li><a href="#scenes">Scenes</a></li>
            <li><a href="#features">Features</a></li>
            <li><a href="#realization">Realization</a></li>
          </ul>
        </li>
        <li><a href="#epilogue">Epilogue</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="visitor-pattern">Visitor Pattern</h2>
<p>The accessor pattern is a behavioral pattern that allows arbitrary detached visitors to be able to access managed elements under the control of the manager. The visitor cannot change the definition of the object (but this is not mandatory, you can agree to allow changes). For the manager, it does not care how many visitors there actually are, it only cares about a defined order of access to the elements (for example, for a binary tree, you can provide multiple access orders such as mid-order, pre-order, etc.).</p>
<h3 id="composition">Composition</h3>
<p>The Visitor schema contains two main objects: the Visitable object and the Vistor object. In addition, Visited objects are included in the Visitor schema as objects that will be manipulated.</p>
<p>A Visitable object, i.e., a manager, may contain a series of elements (Visited) of various shapes and sizes that may have complex structural relationships within the Visitable (but can also be some kind of simple containment relationship, such as a simple vector.) The Visitable will generally be a complex container that is responsible for interpreting these relationships and traversing them with A standard logic is used to traverse these elements. When Visitable traverses these elements, it provides each element to the Visitor so that it can access the Visited element.</p>
<p>Such a programming pattern is the Visitor Pattern.</p>
<h3 id="interface">Interface</h3>
<p>In order to be able to observe each element, there is therefore a practical necessity to have a constraint: all observable elements have a common base class Visited.</p>
<p>All Visitors must be derived from Visitor in order to be available to the Visitable.accept(visitor&amp;) interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span> <span class="p">{</span>

    <span class="k">struct</span> <span class="nc">base_visitor</span> <span class="p">{</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">base_visitor</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">};</span>
    <span class="k">struct</span> <span class="nc">base_visitable</span> <span class="p">{</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">base_visitable</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">};</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Visited</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ReturnType</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
    <span class="k">class</span> <span class="nc">visitor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">base_visitor</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="k">using</span> <span class="n">return_t</span> <span class="o">=</span> <span class="n">ReturnType</span><span class="p">;</span>
        <span class="k">using</span> <span class="n">visited_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Visited</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="n">return_t</span> <span class="nf">visit</span><span class="p">(</span><span class="n">visited_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">visited</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Visited</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ReturnType</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
    <span class="k">class</span> <span class="nc">visitable</span> <span class="o">:</span> <span class="k">public</span> <span class="n">base_visitable</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">visitable</span><span class="p">()</span> <span class="p">{}</span>
        <span class="k">using</span> <span class="n">return_t</span> <span class="o">=</span> <span class="n">ReturnType</span><span class="p">;</span>
        <span class="k">using</span> <span class="n">visitor_t</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">&lt;</span><span class="n">Visited</span><span class="p">,</span> <span class="n">return_t</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="n">return_t</span> <span class="nf">accept</span><span class="p">(</span><span class="n">visitor_t</span> <span class="o">&amp;</span><span class="n">guest</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace hicc::util
</span></code></pre></td></tr></table>
</div>
</div><h3 id="scenes">Scenes</h3>
<p>For example, suppose we are designing a set of vector editors. In the Canvas, there can be many Layers, each containing certain properties (e.g. fill color, transparency), and there can be multiple Elements. Elements can be Point, Line, Rect, Arc, etc.</p>
<p>To be able to draw the canvas on the screen, we can have a Screen device object that implements the Visitor interface, so the canvas can accept access to the Screen and thus draw the elements of the canvas to the screen.</p>
<p>If we provide Printer as an observer, then the canvas will be able to print out the image elements.</p>
<p>If we provide Document as an observer, then the canvas will be able to serialize the graphical properties to a disk file.</p>
<p>If we need additional behavior in the future, we can go ahead and add new observers and then do something similar with the canvas and the tuples it holds.</p>
<h3 id="features">Features</h3>
<ul>
<li>If you need to perform certain operations on all elements in a complex object structure (such as an object tree), you can use the visitor pattern.</li>
<li>The visitor pattern takes the non-primary functionality away from the object manager, so it is also a means of decoupling.</li>
<li>If you are making a class library for an object library, then providing an access interface to the outside will facilitate the user to develop his own visitor to access your class library without intrusion - he doesn&rsquo;t have to give you issue/pull request for his own little thing.</li>
<li>For complex structural hierarchies, make good use of object nesting and recursion capabilities to avoid writing similar logic over and over again.</li>
</ul>
<blockquote>
<p>Check out the reference implementations of canva, layer, and group, which accomplish nesting self-management capabilities by implementing <code>drawable</code> and <code>vistiable&lt;drawable&gt;</code>, and enabling <code>accept()</code> to go recursively into each container.</p>
</blockquote>
<h3 id="realization">Realization</h3>
<p>We implemented a part of the vector image editor as an example, using the base class template given earlier.</p>
<h4 id="drawable-and-base-elements">drawable and base elements</h4>
<p>First do the basic declaration of drawable/shape and the base tuples.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">visitor</span><span class="o">::</span><span class="n">basic</span> <span class="p">{</span>

  <span class="k">using</span> <span class="n">draw_id</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">;</span>

  <span class="cm">/** @brief a shape such as a dot, a line, a rectangle, and so on. */</span>
  <span class="k">struct</span> <span class="nc">drawable</span> <span class="p">{</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">drawable</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="n">drawable</span> <span class="k">const</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;&lt;&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">type_name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;#&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">draw_id</span> <span class="nf">id</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_id</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">void</span> <span class="nf">id</span><span class="p">(</span><span class="n">draw_id</span> <span class="n">id_</span><span class="p">)</span> <span class="p">{</span> <span class="n">_id</span> <span class="o">=</span> <span class="n">id_</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">private</span><span class="o">:</span>
    <span class="n">draw_id</span> <span class="n">_id</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cp">#define MAKE_DRAWABLE(T)                                            \
</span><span class="cp">    T(draw_id id_) { id(id_); }                                     \
</span><span class="cp">    T() {}                                                          \
</span><span class="cp">    virtual ~T() {}                                                 \
</span><span class="cp">    std::string type_name() const override {                        \
</span><span class="cp">        return std::string{hicc::debug::type_name&lt;T&gt;()};            \
</span><span class="cp">    }                                                               \
</span><span class="cp">    friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;os, T const &amp;o) { \
</span><span class="cp">        return os &lt;&lt; &#39;&lt;&#39; &lt;&lt; o.type_name() &lt;&lt; &#39;#&#39; &lt;&lt; o.id() &lt;&lt; &#39;&gt;&#39;;  \
</span><span class="cp">    }
</span><span class="cp"></span>
  <span class="c1">//@formatter:off
</span><span class="c1"></span>  <span class="k">struct</span> <span class="nc">point</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">point</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">line</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">line</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">rect</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">rect</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">ellipse</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">arc</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">arc</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">triangle</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">triangle</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">star</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">star</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">polygon</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">polygon</span><span class="p">)};</span>
  <span class="k">struct</span> <span class="nc">text</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span> <span class="p">{</span><span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">text</span><span class="p">)};</span>
  <span class="c1">//@formatter:on
</span><span class="c1"></span>  <span class="c1">// note: dot, rect (line, rect, ellipse, arc, text), poly (triangle, star, polygon)
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For debugging purposes, we overload the &lsquo;&quot;&rsquo; stream output operator and use the macro MAKE_DRAWABLE to cut down on repetitive code keystrokes. In the MAKE_DRAWABLE macro, we get the class name via <code>hicc::debug::type_name&lt;T&gt;()</code> and return this as a string from <code>drawable::type_name()</code>.</p>
<p>For simplicity reasons the base tuples are not hierarchical, but are derived in parallel from drawable.</p>
<h4 id="composite-elements-and-layers">Composite elements and layers</h4>
<p>The following declares a group object, which contains a set of tuples. Since we want to have as much recursive structure as possible, layers are also considered to be a combination of a group of tuples</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">visitor</span><span class="o">::</span><span class="n">basic</span> <span class="p">{</span>

  <span class="k">struct</span> <span class="nc">group</span> <span class="o">:</span> <span class="k">public</span> <span class="n">drawable</span>
    <span class="p">,</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">visitable</span><span class="o">&lt;</span><span class="n">drawable</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
      <span class="k">using</span> <span class="n">drawable_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">drawable</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">drawables_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">draw_id</span><span class="p">,</span> <span class="n">drawable_t</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">drawables_t</span> <span class="n">drawables</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="n">drawable_t</span> <span class="o">&amp;&amp;</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="n">drawables</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">t</span><span class="p">));</span> <span class="p">}</span>
    <span class="n">return_t</span> <span class="nf">accept</span><span class="p">(</span><span class="n">visitor_t</span> <span class="o">&amp;</span><span class="n">guest</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">did</span><span class="p">,</span> <span class="n">dr</span><span class="p">]</span> <span class="o">:</span> <span class="n">drawables</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">guest</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
        <span class="n">UNUSED</span><span class="p">(</span><span class="n">did</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">struct</span> <span class="nc">layer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">group</span> <span class="p">{</span>
    <span class="n">MAKE_DRAWABLE</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="c1">// more: attrs, ...
</span><span class="c1"></span>  <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The group class already implements the visitable interface, and its accept can accept visitors, at which point the tuples group iterates through all of its tuples and makes them available to visitors.</p>
<blockquote>
<p>You can also create compound tuples based on the group class, which allows several tuples to be combined into a new tuples component, the difference being that groups are generally temporary objects for UI operations, while compound tuples can be selected and used by the user as part of a component library.</p>
</blockquote>
<p>By default, guest accesses elements of the form <code>visited const &amp;</code>, which is read-only.</p>
<p>The layer has at least all the capabilities of a group, so it does the same thing for visitors. The properties part of the layer (mask, overlay, etc.) is omitted.</p>
<h4 id="canvas">Canvas</h4>
<p>The canvas contains several layers, so it should also implement the visitable interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">visitor</span><span class="o">::</span><span class="n">basic</span> <span class="p">{</span>

  <span class="k">struct</span> <span class="nc">canvas</span> <span class="o">:</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">visitable</span><span class="o">&lt;</span><span class="n">drawable</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">layer_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">layer</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">layers_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">draw_id</span><span class="p">,</span> <span class="n">layer_t</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">layers_t</span> <span class="n">layers</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="n">draw_id</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">layers</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">layer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">));</span> <span class="p">}</span>
    <span class="n">layer_t</span> <span class="o">&amp;</span><span class="n">get</span><span class="p">(</span><span class="n">draw_id</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">layers</span><span class="p">[</span><span class="n">id</span><span class="p">];</span> <span class="p">}</span>
    <span class="n">layer_t</span> <span class="o">&amp;</span><span class="k">operator</span><span class="p">[](</span><span class="n">draw_id</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">layers</span><span class="p">[</span><span class="n">id</span><span class="p">];</span> <span class="p">}</span>

    <span class="k">virtual</span> <span class="n">return_t</span> <span class="nf">accept</span><span class="p">(</span><span class="n">visitor_t</span> <span class="o">&amp;</span><span class="n">guest</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
      <span class="c1">// hicc_debug(&#34;[canva] visiting for: %s&#34;, to_string(guest).c_str());
</span><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">lid</span><span class="p">,</span> <span class="n">ly</span><span class="p">]</span> <span class="o">:</span> <span class="n">layers</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ly</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">guest</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Where add will create a new layer with default arguments and the layer order follows an upward stacking pattern. get and the <code>[]</code> operator can access a layer with a positive integer subscript. However, the code does not contain a layer order management function. If you wish, you can add a <code>std::vector&lt;draw_id&gt;</code> helper structure to help manage the layer order.</p>
<p>Now let&rsquo;s review the canvas-layer-tuple system. The accept interface successfully runs through the entire system.</p>
<p>It&rsquo;s time to create the visitors</p>
<h4 id="screen-or-printer">screen or printer</h4>
<p>Both implement simple visitor interfaces.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">visitor</span><span class="o">::</span><span class="n">basic</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">screen</span> <span class="o">:</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">visitor</span><span class="o">&lt;</span><span class="n">drawable</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">return_t</span> <span class="nf">visit</span><span class="p">(</span><span class="n">visited_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">visited</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
      <span class="n">hicc_debug</span><span class="p">(</span><span class="s">&#34;[screen][draw] for: %s&#34;</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">visited</span><span class="p">.</span><span class="n">get</span><span class="p">()).</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="n">screen</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[screen] &#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">struct</span> <span class="nc">printer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">visitor</span><span class="o">&lt;</span><span class="n">drawable</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">return_t</span> <span class="nf">visit</span><span class="p">(</span><span class="n">visited_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">visited</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
      <span class="n">hicc_debug</span><span class="p">(</span><span class="s">&#34;[printer][draw] for: %s&#34;</span><span class="p">,</span> <span class="n">to_string</span><span class="p">(</span><span class="n">visited</span><span class="p">.</span><span class="n">get</span><span class="p">()).</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="n">printer</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[printer] &#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>hicc::to_string</code> is a simple stream wrapper that does the following core logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_string</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
  <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="test-case">test case</h4>
<p>The test program constructs a miniature canvas and several graph elements and then accesses them schematically.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="nf">test_visitor_basic</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">visitor</span><span class="o">::</span><span class="n">basic</span><span class="p">;</span>

    <span class="n">canvas</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">draw_id</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">did</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">c</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="o">++</span><span class="n">id</span><span class="p">);</span> <span class="c1">// added one graph-layer
</span><span class="c1"></span>    <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">line</span><span class="o">&gt;</span><span class="p">(</span><span class="o">++</span><span class="n">did</span><span class="p">));</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">line</span><span class="o">&gt;</span><span class="p">(</span><span class="o">++</span><span class="n">did</span><span class="p">));</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">rect</span><span class="o">&gt;</span><span class="p">(</span><span class="o">++</span><span class="n">did</span><span class="p">));</span>

    <span class="n">screen</span> <span class="n">scr</span><span class="p">;</span>
    <span class="n">c</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">scr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The output should look something like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">--- BEGIN OF test_visitor_basic                       ----------------------
09/14/21 00:33:31 [debug]: [screen][draw] for: &lt;hicc::dp::visitor::basic::rect#3&gt;
09/14/21 00:33:31 [debug]: [screen][draw] for: &lt;hicc::dp::visitor::basic::line#2&gt;
09/14/21 00:33:31 [debug]: [screen][draw] for: &lt;hicc::dp::visitor::basic::line#1
--- END OF test_visitor_basic                         ----------------------

It took 2.813.753ms
</code></pre></td></tr></table>
</div>
</div><h2 id="epilogue">Epilogue</h2>
<p>The Visitor pattern can sometimes be replaced by the Iterator pattern. But iterators often have a fatal flaw that affects their usefulness: iterators themselves can be rigid, costly, and inefficient - unless you make the most appropriate design choices and implement the most elaborate iterator. They both allow the user to access the contents of a known complex container without intrusion.</p>
<p>BTW, some people say that it is because languages like Java do not support double assignment that the visitor pattern was born. This is pure fucking bullshit: Java was officially released in 1995, when it was a fairly rudimentary prototype and there were no patterns to speak of, and it wasn&rsquo;t until 1998, when JDK 1.2 came out, that EJB, J2EE, etc., and then its design patterns took off in a big way. It is not too much to say that Java is riding on the east wind of GoF summary, without the milestone experience summary of GoF in 1994, there would not be Design Patterns terminology in the following decades until today, so too many kids are ignorant and fearless to open their mouths.</p>
<p>For C++, the definition of double-distribution or whatever is completely meaningless. I&rsquo;m so sick of Java.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/cplusplus-pipeable/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Pipeable Programming in C&#43;&#43;</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/cplusplus-17-observer-pattern/">
            <span class="next-text nav-default">Observer mode in C&#43;&#43;17</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
