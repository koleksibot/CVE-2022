<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Observer mode in C&#43;&#43;17 - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Observer Pattern The Observer pattern is a behavioral pattern that is a subscription-publishing mechanism. Objects are able to make announcements, and anyone who has registered observer status with the object will be able to receive notifications when such announcement events occur. Registering an identity means subscribing, and the event occurs means publishing. There can be many observers doing subscriptions, at which point an observer chain is held in the observed" /><meta name="keywords" content="c&#43;&#43;, Observer Pattern" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/cplusplus-17-observer-pattern/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Observer mode in C&#43;&#43;17" />
<meta property="og:description" content="Observer Pattern The Observer pattern is a behavioral pattern that is a subscription-publishing mechanism. Objects are able to make announcements, and anyone who has registered observer status with the object will be able to receive notifications when such announcement events occur. Registering an identity means subscribing, and the event occurs means publishing. There can be many observers doing subscriptions, at which point an observer chain is held in the observed" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/cplusplus-17-observer-pattern/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-05T16:25:37+08:00" />
<meta property="article:modified_time" content="2021-10-05T16:25:37+08:00" />

<meta itemprop="name" content="Observer mode in C&#43;&#43;17">
<meta itemprop="description" content="Observer Pattern The Observer pattern is a behavioral pattern that is a subscription-publishing mechanism. Objects are able to make announcements, and anyone who has registered observer status with the object will be able to receive notifications when such announcement events occur. Registering an identity means subscribing, and the event occurs means publishing. There can be many observers doing subscriptions, at which point an observer chain is held in the observed"><meta itemprop="datePublished" content="2021-10-05T16:25:37+08:00" />
<meta itemprop="dateModified" content="2021-10-05T16:25:37+08:00" />
<meta itemprop="wordCount" content="1923">
<meta itemprop="keywords" content="c&#43;&#43;," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Observer mode in C&#43;&#43;17"/>
<meta name="twitter:description" content="Observer Pattern The Observer pattern is a behavioral pattern that is a subscription-publishing mechanism. Objects are able to make announcements, and anyone who has registered observer status with the object will be able to receive notifications when such announcement events occur. Registering an identity means subscribing, and the event occurs means publishing. There can be many observers doing subscriptions, at which point an observer chain is held in the observed"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Observer mode in C&#43;&#43;17</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-05 16:25:37 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1923 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#observer-pattern">Observer Pattern</a>
          <ul>
            <li><a href="#engineering-difficulties">Engineering Difficulties</a></li>
            <li><a href="#is-it-a-misunderstanding">Is it a misunderstanding?</a></li>
            <li><a href="#scenes">Scenes</a></li>
            <li><a href="#composition">Composition</a></li>
            <li><a href="#realization">Realization</a></li>
          </ul>
        </li>
        <li><a href="#epilogue">Epilogue</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="observer-pattern">Observer Pattern</h2>
<p>The Observer pattern is a behavioral pattern that is a subscription-publishing mechanism. Objects are able to make announcements, and anyone who has registered observer status with the object will be able to receive notifications when such announcement events occur. Registering an identity means subscribing, and the event occurs means publishing.</p>
<p>There can be many observers doing subscriptions, at which point an observer chain is held in the observed object.</p>
<h3 id="engineering-difficulties">Engineering Difficulties</h3>
<p>The usual C++ implementations focus on modeling the implementation of the pattern and not on practical qualities. So most of the implementations of the observer pattern you can see are case-based and do not support cross-threading, asynchronous, or non-blocking.</p>
<p>Due to the blocking one-way traversal nature of the observer chain, an unruly observer may hang up the notification chain of events that occur and furthermore hang up the whole thread.</p>
<p>However, solving this problem is not easy - for the most part we rely on the convention that observers must do their job in a disciplined manner and must finish their observations quickly. If you want to solve this problem completely, you will need a timeout interrupt mechanism, but this tends to make the entire code implementation of the observer pattern vague and complex, and in fact makes the technique infeasible.</p>
<p>This can be useful if you make your observer pattern implementations support asynchronous methods, but the problem with this is that the response latency of events is unpredictable (and left to the CPU thread scheduling feature). There are two ways to trigger non-blocking: either start a thread when the event occurs in order to traverse the observer chain and call back in turn, or facilitate the observer chain and call back in a new thread. Both approaches have their own characteristics, which you can evaluate in practice. In addition, using the standard library of concurrent threads provided by C++20 can help improve response latency.</p>
<h3 id="is-it-a-misunderstanding">Is it a misunderstanding?</h3>
<p>I haven&rsquo;t drawn a UML diagram for many years. In fact, I think this diagram is not very useful, it is not as straightforward intuition as reading the code directly, look at the diagram still have to translate it in the brain, look at the code, it seems that the brain when the CPU is very skilled ah, directly there.</p>
<p>Am I missing something, or, misunderstanding something.</p>
<h3 id="scenes">Scenes</h3>
<p>The Observer pattern is so easy to understand that there is no need to design a proper scenario to explain it.</p>
<p>A customer looks to see if a product has arrived in the store. I&rsquo;m going to order a copy of the South China Morning Post. I order fresh milk from the dairy every morning. And so on.</p>
<h3 id="composition">Composition</h3>
<p>Having said that (boring on uml), to quote a graph.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/05/6587d2e322064d29b35af4284a35de57.png" alt=""></p>
<ol>
<li><strong>发布者</strong> （Publisher） 会向其他对象发送值得关注的事件。 事件会在发布者自身状态改变或执行特定行为后发生。 发布者中包含一个允许新订阅者加入和当前订阅者离开列表的订阅构架。</li>
<li>当新事件发生时， 发送者会遍历订阅列表并调用每个订阅者对象的通知方法。 该方法是在订阅者接口中声明的。</li>
<li><strong>订阅者</strong> （Subscriber） 接口声明了通知接口。 在绝大多数情况下， 该接口仅包含一个 <code>update</code> 更新方法。 该方法可以拥有多个参数， 使发布者能在更新时传递事件的详细信息。</li>
<li><strong>具体订阅者</strong> （Concrete Subscribers） 可以执行一些操作来回应发布者的通知。 所有具体订阅者类都实现了同样的接口， 因此发布者不需要与具体类相耦合。</li>
<li>订阅者通常需要一些上下文信息来正确地处理更新。 因此， 发布者通常会将一些上下文数据作为通知方法的参数进行传递。 发布者也可将自身作为参数进行传递， 使订阅者直接获取所需的数据。</li>
<li><strong>客户端</strong> （Client） 会分别创建发布者和订阅者对象， 然后为订阅者注册发布者更新。</li>
</ol>
<h3 id="realization">Realization</h3>
<p>The new C++17 implementation of the observer pattern focuses on these aspects.</p>
<ul>
<li>using smart pointers instead of the previous bare pointers, as well as fine-grained explicit management rights</li>
<li>Allowing different means of adding observers</li>
<li>Allowing custom Observer types</li>
<li>Preference for empty structs as event signals</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/05/253e1dcea35a4e37ae3a2a7fc75d5d75.png" alt=""></p>
<h4 id="core-templates-observable-and-observer">Core templates observable and observer</h4>
<p>A default recommended observer base class template provides you with the base constructor prototype. Your observer class should derive from this template. Unless you intend to define your own interface (though, to a large extent, the need to do so is infinitely close to zero, since the observable template requires an Observer to have an interface like <code>observe(subject const&amp;)</code>).</p>
<p>As for the observable template itself, it contains &lsquo;+=&rsquo; and &lsquo;-=&rsquo; operator overloads, so you can use a more semantic coding approach.</p>
<p>The code is as follows (referenced in hz-common.hh).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span> <span class="p">{</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
  <span class="k">class</span> <span class="nc">observer</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">observer</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">using</span> <span class="n">subject_t</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">observe</span><span class="p">(</span><span class="n">subject_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Observer</span> <span class="o">=</span> <span class="n">observer</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">Managed</span> <span class="o">=</span> <span class="nb">false</span><span class="o">&gt;</span>
  <span class="k">class</span> <span class="nc">observable</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">observable</span><span class="p">()</span> <span class="p">{</span> <span class="n">clear</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">using</span> <span class="n">subject_t</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">observer_t_nacked</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">observer_t</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">observer_t_nacked</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">observer_t_shared</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">observer_t_nacked</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="n">add_observer</span><span class="p">(</span><span class="n">observer_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_observers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="n">add_observer</span><span class="p">(</span><span class="n">observer_t_shared</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">observer_t</span> <span class="n">wp</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>
      <span class="n">_observers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">wp</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="n">remove_observer</span><span class="p">(</span><span class="n">observer_t_shared</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">remove_observer</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">get</span><span class="p">());</span> <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="n">remove_observer</span><span class="p">(</span><span class="n">observer_t_nacked</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_observers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">remove_if</span><span class="p">(</span><span class="n">_observers</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">_observers</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[</span><span class="n">o</span><span class="p">](</span><span class="n">observer_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">spt</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span>
          <span class="k">return</span> <span class="n">spt</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">o</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}),</span> <span class="n">_observers</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
      <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="n">observer_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">add_observer</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="n">observer_t_shared</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">add_observer</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">-=</span><span class="p">(</span><span class="n">observer_t_nacked</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">remove_observer</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="p">}</span>
    <span class="n">observable</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">-=</span><span class="p">(</span><span class="n">observer_t_shared</span> <span class="o">&amp;</span><span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">remove_observer</span><span class="p">(</span><span class="n">o</span><span class="p">);</span> <span class="p">}</span>

    <span class="k">public</span><span class="o">:</span>
    <span class="cm">/**
</span><span class="cm">      * @brief fire an event along the observers chain.
</span><span class="cm">      * @param event_or_subject 
</span><span class="cm">      */</span>
    <span class="kt">void</span> <span class="n">emit</span><span class="p">(</span><span class="n">subject_t</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">event_or_subject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="nl">wp</span> <span class="p">:</span> <span class="n">_observers</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">spt</span> <span class="o">=</span> <span class="n">wp</span><span class="p">.</span><span class="n">lock</span><span class="p">())</span>
          <span class="n">spt</span><span class="o">-&gt;</span><span class="n">observe</span><span class="p">(</span><span class="n">event_or_subject</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">clear</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">Managed</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">observer_t</span><span class="o">&gt;</span> <span class="n">_observers</span><span class="p">;</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace hicc::util
</span></code></pre></td></tr></table>
</div>
</div><p>In the current implementation, the Managed template parameter of observable is useless, and the managed observer feature is not yet implemented, so you always have to manage each observer instance yourself. The observable only contains the weak_ptr of the observer, which sets the stage for adding asynchronous capabilities in the future, but for now its usefulness seems small.</p>
<p>There&rsquo;s a lot of talk in the previous section, but that&rsquo;s all the code in the core class template when it comes to concrete implementation, which isn&rsquo;t too much.</p>
<h4 id="test-case">test case</h4>
<p>The method used is.</p>
<ul>
<li>declaring event signals as structs, and you can include the necessary load in the structs, thus using a single struct to carry different event signals</li>
<li>but observable does not support you to provide multiple event signals of structure type</li>
<li>observable objects need to be derived from observable</li>
<li>The observable is created and registered to the observable using <code>make_shareable</code></li>
</ul>
<p>The sample code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">observer</span><span class="o">::</span><span class="n">basic</span> <span class="p">{</span>

  <span class="k">struct</span> <span class="nc">event</span> <span class="p">{};</span>

  <span class="k">class</span> <span class="nc">Store</span> <span class="o">:</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">observable</span><span class="o">&lt;</span><span class="n">event</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">class</span> <span class="nc">Customer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">hicc</span><span class="o">::</span><span class="n">util</span><span class="o">::</span><span class="n">observer</span><span class="o">&lt;</span><span class="n">event</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Customer</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">Customer</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">void</span> <span class="nf">observe</span><span class="p">(</span><span class="k">const</span> <span class="n">subject_t</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
      <span class="n">hicc_debug</span><span class="p">(</span><span class="s">&#34;event raised: %s&#34;</span><span class="p">,</span> <span class="n">debug</span><span class="o">::</span><span class="n">type_name</span><span class="o">&lt;</span><span class="n">subject_t</span><span class="o">&gt;</span><span class="p">().</span><span class="n">data</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace hicc::dp::observer::basic
</span><span class="c1"></span>
<span class="kt">void</span> <span class="nf">test_observer_basic</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">hicc</span><span class="o">::</span><span class="n">dp</span><span class="o">::</span><span class="n">observer</span><span class="o">::</span><span class="n">basic</span><span class="p">;</span>

  <span class="n">Store</span> <span class="n">store</span><span class="p">;</span>
  <span class="n">Store</span><span class="o">::</span><span class="n">observer_t_shared</span> <span class="n">c</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span><span class="p">();</span> <span class="c1">// uses Store::observer_t_shared rather than &#39;auto&#39;
</span><span class="c1"></span>  <span class="n">store</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">store</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">event</span><span class="p">{});</span>
  <span class="n">store</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Store is an observable object.</p>
<p>The Customer acts as an observer, registering with <code>store += c</code> and deregistering with <code>store -= c</code>.</p>
<p>Where appropriate, store.exit() fires an event signal out, which will then be received by all observers and interpreted however they see fit.</p>
<p>Note that smart pointer degradation.</p>
<ul>
<li>must use <code>Store::observer_t_shared c = std::make_shared&lt;Customer&gt;();</code> because the &lsquo;+=&rsquo; and &lsquo;-=&rsquo; operators recognize the <code>hicc::util::observable&lt;event&gt;::observer_t_shared</code> type</li>
<li>If you use <code>auto c = std::make_shared&lt;Customer&gt;()</code>, they cannot be derived by &lsquo;+=&rsquo; or &lsquo;-=&rsquo; and the compilation will not complete</li>
<li>could consider solving this problem with CRTP techniques, but the need is not really great - you can complain about it and I might get motivated</li>
</ul>
<p>Remaining issues.</p>
<ul>
<li>There is no mechanism to prevent duplicate observer registration. It&rsquo;s not difficult to add it, but we don&rsquo;t think you should write code for duplicate registration, so we don&rsquo;t care if it&rsquo;s duplicate or not, you do it ~</li>
</ul>
<h2 id="epilogue">Epilogue</h2>
<p>We have not been able to solve the hard problem. The quandary raised above can only be solved by a realistic and enhanced version of the Observer pattern, Rx/ReactiveX. ReactiveX, however, is not a pure subscription pattern at all, and the threshold is too high.</p>
<p>So, or, maybe, next time consider a simpler Rx, you know ReactiveX already has RxCpp, but we might get a simple version of Rx, with the main purpose of adding asynchronous capabilities to the observer pattern, and just drop the operators.</p>
<p>There is another famous implementation of the subscriber, or observer, pattern: Qt&rsquo;s Signal-Slot mechanism. This relies on Qt&rsquo;s QObject to provide a mechanism by which a connect can be triggered by a signal. It is almost equivalent to the observer pattern, but emphasizes the notion of sender and receiver, which may not be necessary for most implementations of the observer pattern. But the signal slot mechanism provides developers before C++11 with the ability to call back a slot function with parameters without association, which no one could do at the beginning, even after C++11, due to the template change in the perfect forwarding sometimes syntax is not perfect, but also until after C++14/17 to have a comprehensive beyond. So now it is, slot this mechanism has lost its allure, just in the stubborn, and the actual application, unless you are using qt, most or just do an observable is also very light and easy.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/cplusplus-17-visitor-pattern/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Cplusplus 17 Visitor Pattern</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/go-http-server-shudown-done-right/">
            <span class="next-text nav-default">Golang http.Server graceful exit: the easily misused Shutdown() method</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
