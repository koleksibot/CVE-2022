<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Renew a Kubernetes certificate with a 10-year expiration date - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="It is very convenient to use kubeadm to install kubernetes cluster, but there is also a more annoying problem is that the default certificate is only valid for one year, so you need to consider the issue of certificate upgrade, the demo cluster version of this article is v1.16.2 version, there is no guarantee that the following operation is also applicable to other versions, before the operation must first backup" /><meta name="keywords" content="kubernetes, certs" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/update-k8s-10y-expire-certs/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Renew a Kubernetes certificate with a 10-year expiration date" />
<meta property="og:description" content="It is very convenient to use kubeadm to install kubernetes cluster, but there is also a more annoying problem is that the default certificate is only valid for one year, so you need to consider the issue of certificate upgrade, the demo cluster version of this article is v1.16.2 version, there is no guarantee that the following operation is also applicable to other versions, before the operation must first backup" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/update-k8s-10y-expire-certs/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-24T12:36:53+08:00" />
<meta property="article:modified_time" content="2021-10-24T12:36:53+08:00" />

<meta itemprop="name" content="Renew a Kubernetes certificate with a 10-year expiration date">
<meta itemprop="description" content="It is very convenient to use kubeadm to install kubernetes cluster, but there is also a more annoying problem is that the default certificate is only valid for one year, so you need to consider the issue of certificate upgrade, the demo cluster version of this article is v1.16.2 version, there is no guarantee that the following operation is also applicable to other versions, before the operation must first backup"><meta itemprop="datePublished" content="2021-10-24T12:36:53+08:00" />
<meta itemprop="dateModified" content="2021-10-24T12:36:53+08:00" />
<meta itemprop="wordCount" content="1801">
<meta itemprop="keywords" content="kubernetes,certs," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Renew a Kubernetes certificate with a 10-year expiration date"/>
<meta name="twitter:description" content="It is very convenient to use kubeadm to install kubernetes cluster, but there is also a more annoying problem is that the default certificate is only valid for one year, so you need to consider the issue of certificate upgrade, the demo cluster version of this article is v1.16.2 version, there is no guarantee that the following operation is also applicable to other versions, before the operation must first backup"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Renew a Kubernetes certificate with a 10-year expiration date</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-24 12:36:53 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1801 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#manual-certificate-renewal">Manual certificate renewal</a></li>
        <li><a href="#renewing-certificates-with-the-kubernetes-certificate-api">Renewing Certificates with the Kubernetes Certificate API</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>It is very convenient to use kubeadm to install kubernetes cluster, but there is also a more annoying problem is that the default certificate is only valid for one year, so you need to consider the issue of certificate upgrade, the demo cluster version of this article is v1.16.2 version, there is no guarantee that the following operation is also applicable to other versions, <strong>before the operation must first backup the certificate directory, to prevent the operation error rollback</strong> . <strong>Make sure to backup the certificate directory before operation to prevent rollback of operation errors</strong> . This article introduces two ways to update the cluster certificate.</p>
<h2 id="manual-certificate-renewal">Manual certificate renewal</h2>
<p>The client certificate generated by kubeadm is only valid for one year by default, and we can check if the certificate is expired by using the <code>check-expiration</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm alpha certs check-expiration
CERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
admin.conf                 Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
apiserver                  Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
apiserver-etcd-client      Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
apiserver-kubelet-client   Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
controller-manager.conf    Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
etcd-healthcheck-client    Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
etcd-peer                  Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
etcd-server                Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
front-proxy-client         Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
scheduler.conf             Nov 07, <span class="m">2020</span> 11:59 UTC   73d             no
</code></pre></td></tr></table>
</div>
</div><p>This command displays the expiration/remaining time of client certificates in the <code>/etc/kubernetes/pki</code> folder and the client certificates embedded in the <code>KUBECONFIG</code> file used by kubeadm.</p>
<blockquote>
<p><code>kubeadm</code> cannot manage certificates signed by external CAs, so if you have an external certificate, you need to manage the certificate renewal manually.</p>
</blockquote>
<p>Also note that <code>kubelet.conf</code> is not included in the above list, because kubeadm configures kubelet to automatically renew certificates.</p>
<p>In addition, kubeadm automatically updates all certificates when the control panel is upgraded, so it is best practice to upgrade your cluster frequently with kubeadm to ensure that your cluster stays up to date and reasonably secure. However, for real production environments we may not upgrade the cluster as often as we would like, so we need to update the certificates manually.</p>
<p>To renew certificates manually is also very easy, we just need to renew your certificates with the <code>kubeadm alpha certs renew</code> command, which performs the renewal with the CA (or front-proxy-CA) certificate and the key stored in <code>/etc/kubernetes/pki</code>.</p>
<blockquote>
<p>If you are running a highly available cluster, this command needs to be executed on all control panel nodes.</p>
</blockquote>
<p>Next, let&rsquo;s update our cluster certificates. The following actions are performed on the master node, starting with a backup of the original certificates.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ mkdir /etc/kubernetes.bak
$ cp -r /etc/kubernetes/pki/ /etc/kubernetes.bak
$ cp /etc/kubernetes/*.conf /etc/kubernetes.bak
</code></pre></td></tr></table>
</div>
</div><p>Then back up the etcd data directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cp -r /var/lib/etcd /var/lib/etcd.bak
</code></pre></td></tr></table>
</div>
</div><p>Next, execute the command to renew the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm alpha certs renew all --config<span class="o">=</span>kubeadm.yaml
kubeadm alpha certs renew all --config<span class="o">=</span>kubeadm.yaml
certificate embedded in the kubeconfig file <span class="k">for</span> the admin to use and <span class="k">for</span> kubeadm itself renewed
certificate <span class="k">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="k">for</span> the API server to connect to kubelet renewed
certificate embedded in the kubeconfig file <span class="k">for</span> the controller manager to use renewed
certificate <span class="k">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="k">for</span> etcd nodes to communicate with each other renewed
certificate <span class="k">for</span> serving etcd renewed
certificate <span class="k">for</span> the front proxy client renewed
certificate embedded in the kubeconfig file <span class="k">for</span> the scheduler manager to use renewed
</code></pre></td></tr></table>
</div>
</div><p>Through the above command certificate on a key to update completed, this time to view the above certificate can see the expiration time is already a year after the time of.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm alpha certs check-expiration
CERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
admin.conf                 Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
apiserver                  Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
apiserver-etcd-client      Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
apiserver-kubelet-client   Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
controller-manager.conf    Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
etcd-healthcheck-client    Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
etcd-peer                  Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
etcd-server                Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
front-proxy-client         Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
scheduler.conf             Aug 26, <span class="m">2021</span> 03:47 UTC   364d            no
</code></pre></td></tr></table>
</div>
</div><p>Then remember to update the kubeconfig file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm init phase kubeconfig all --config kubeadm.yaml
<span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&#34;/etc/kubernetes&#34;</span>
<span class="o">[</span>kubeconfig<span class="o">]</span> Using existing kubeconfig file: <span class="s2">&#34;/etc/kubernetes/admin.conf&#34;</span>
<span class="o">[</span>kubeconfig<span class="o">]</span> Using existing kubeconfig file: <span class="s2">&#34;/etc/kubernetes/kubelet.conf&#34;</span>
<span class="o">[</span>kubeconfig<span class="o">]</span> Using existing kubeconfig file: <span class="s2">&#34;/etc/kubernetes/controller-manager.conf&#34;</span>
<span class="o">[</span>kubeconfig<span class="o">]</span> Using existing kubeconfig file: <span class="s2">&#34;/etc/kubernetes/scheduler.conf&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Overwrite the original admin file with the newly generated admin configuration file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ mv <span class="nv">$HOME</span>/.kube/config <span class="nv">$HOME</span>/.kube/config.old
$ cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
$ chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></td></tr></table>
</div>
</div><p>After restarting kube-apiserver, kube-controller, kube-scheduler, and etcd, we can check the validity of the apiserver certificate to verify that the update was successful.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">echo</span> <span class="p">|</span> openssl s_client -showcerts -connect 127.0.0.1:6443 -servername api 2&gt;/dev/null <span class="p">|</span> openssl x509 -noout -enddate
<span class="nv">notAfter</span><span class="o">=</span>Aug <span class="m">26</span> 03:47:23 <span class="m">2021</span> GMT
</code></pre></td></tr></table>
</div>
</div><p>You can see that the expiration date is now one year past, proving that the update has been successful.</p>
<h2 id="renewing-certificates-with-the-kubernetes-certificate-api">Renewing Certificates with the Kubernetes Certificate API</h2>
<p>In addition to the above one-click manual certificate update, you can also use the Kubernetes Certificate API to perform manual certificate updates. For online environments we may not take the risk of updating the cluster or renewing the certificate often, which is risky after all, so we want to generate a certificate with a long enough validity. There are many administrators who manually change the kubeadm source code to 10 years and then recompile it to create a cluster. This approach is not recommended, although it can serve the purpose, especially if you want to update the cluster with a new version. In fact, Kubernetes provides an API to help us generate a long enough certificate to be valid.</p>
<p>To sign using the built-in API method, first we need to configure the <code>--experimental-cluster-signing-duration</code> parameter of the kube-controller-manager component, adjusting it to 10 years:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ vi /etc/kubernetes/manifests/kube-controller-manager.yaml
......
spec:
  containers:
  - command:
    - kube-controller-manager
    <span class="c1"># 设置证书有效期为 10 年</span>
    - --experimental-cluster-signing-duration<span class="o">=</span>87600h 
    - --client-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt
......
</code></pre></td></tr></table>
</div>
</div><p>After the changes are made kube-controller-manager will automatically restart to take effect. Then we need to create a certificate signing request for the Kubernetes certificate API using the following command. If you set up an external signer such as <code>cert-manager</code>, certificate signing requests (CSRs) will be automatically approved. Otherwise, you must manually approve the certificate using the <code>kubectl certificate</code> command. The following kubeadm command outputs the name of the certificate to be approved and then waits for the approval to occur.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm alpha certs renew all --use-api --config kubeadm.yaml <span class="p">&amp;</span>
</code></pre></td></tr></table>
</div>
</div><p>The output is similar to the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>1<span class="o">]</span> <span class="m">2890</span>
<span class="o">[</span>certs<span class="o">]</span> Certificate request <span class="s2">&#34;kubeadm-cert-kubernetes-admin-pn99f&#34;</span> created
</code></pre></td></tr></table>
</div>
</div><p>Then next we need to go to manually approve the certificate:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get csr
NAME                                  AGE   REQUESTOR          CONDITION
kubeadm-cert-kubernetes-admin-pn99f   64s   kubernetes-admin   Pending
<span class="c1"># 手动批准证书</span>
$ kubectl certificate approve kubeadm-cert-kubernetes-admin-pn99f
certificatesigningrequest.certificates.k8s.io/kubeadm-cert-kubernetes-admin-pn99f approved
</code></pre></td></tr></table>
</div>
</div><p>Approve the csr in the Pending state in the same way until all csr&rsquo;s are approved. The final status of the list of all csr&rsquo;s is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get csr
NAME                                                AGE     REQUESTOR          CONDITION
kubeadm-cert-front-proxy-client-llhrj               30s     kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-2s6kf                   2m43s   kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-etcd-client-t9pkx       2m7s    kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-kubelet-client-pjbjm    108s    kubernetes-admin   Approved,Issued
kubeadm-cert-kube-etcd-healthcheck-client-8dcn8     64s     kubernetes-admin   Approved,Issued
kubeadm-cert-kubernetes-admin-pn99f                 4m29s   kubernetes-admin   Approved,Issued
kubeadm-cert-system:kube-controller-manager-mr86h   79s     kubernetes-admin   Approved,Issued
kubeadm-cert-system:kube-scheduler-t8lnw            17s     kubernetes-admin   Approved,Issued
kubeadm-cert-ydzs-master-cqh4s                      52s     kubernetes-admin   Approved,Issued
kubeadm-cert-ydzs-master-lvbr5                      41s     kubernetes-admin   Approved,Issued
</code></pre></td></tr></table>
</div>
</div><p>The validity of the inspection certificate after the completion of the approval.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubeadm alpha certs check-expiration
CERTIFICATE                EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
admin.conf                 Nov 05, <span class="m">2029</span> 11:53 UTC   9y              no
apiserver                  Nov 05, <span class="m">2029</span> 11:54 UTC   9y              no
apiserver-etcd-client      Nov 05, <span class="m">2029</span> 11:53 UTC   9y              no
apiserver-kubelet-client   Nov 05, <span class="m">2029</span> 11:54 UTC   9y              no
controller-manager.conf    Nov 05, <span class="m">2029</span> 11:54 UTC   9y              no
etcd-healthcheck-client    Nov 05, <span class="m">2029</span> 11:53 UTC   9y              no
etcd-peer                  Nov 05, <span class="m">2029</span> 11:53 UTC   9y              no
etcd-server                Nov 05, <span class="m">2029</span> 11:54 UTC   9y              no
front-proxy-client         Nov 05, <span class="m">2029</span> 11:54 UTC   9y              no
scheduler.conf             Nov 05, <span class="m">2029</span> 11:53 UTC   9y              no
</code></pre></td></tr></table>
</div>
</div><p>We can see that it has been extended by 10 years, because the ca certificate is only valid for 10 years.</p>
<p>However, we can&rsquo;t restart several components of the control panel directly yet, because the etcd corresponding to the cluster installed with kubeadm uses the <code>/etc/kubernetes/pki/etcd/ca.crt</code> certificate by default, and the certificate approved with the command <code>kubectl certificate approve</code> is issued with the default <code>/etc/kubernetes/pki/ca.crt</code> certificate, so we need to replace the ca authority certificate in etcd:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 先拷贝静态 Pod 资源清单</span>
$ cp -r /etc/kubernetes/manifests/ /etc/kubernetes/manifests.bak
$ vi /etc/kubernetes/manifests/etcd.yaml
......
spec:
  containers:
  - command:
    - etcd
    <span class="c1"># 修改为 CA 文件</span>
    - --peer-trusted-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt
    - --trusted-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt
......
    volumeMounts:
    - mountPath: /var/lib/etcd
      name: etcd-data
    - mountPath: /etc/kubernetes/pki  <span class="c1"># 更改证书目录</span>
      name: etcd-certs
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki  <span class="c1"># 将 pki 目录挂载到 etcd 中去</span>
      type: DirectoryOrCreate
    name: etcd-certs
  - hostPath:
      path: /var/lib/etcd 
      type: DirectoryOrCreate
    name: etcd-data
......
</code></pre></td></tr></table>
</div>
</div><p>Since kube-apiserver has to connect to the etcd cluster, the corresponding etcd ca file also needs to be reworked:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ vi /etc/kubernetes/manifests/kube-apiserver.yaml
......
spec:
  containers:
  - command:
    - kube-apiserver
    <span class="c1"># 将etcd ca文件修改为默认的ca.crt文件</span>
    - --etcd-cafile<span class="o">=</span>/etc/kubernetes/pki/ca.crt
......
</code></pre></td></tr></table>
</div>
</div><p>In addition, you need to replace the <code>requestheader-client-ca-file</code> file, which by default is the <code>/etc/kubernetes/pki/front-proxy-ca.crt</code> file, with the default CA file as well, otherwise using the aggregation API, for example, after installing the metrics- server and then execute the <code>kubectl top</code> command, it will report the following error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cp /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/front-proxy-ca.crt
$ cp /etc/kubernetes/pki/ca.key /etc/kubernetes/pki/front-proxy-ca.key
</code></pre></td></tr></table>
</div>
</div><p>Since it is a static Pod, the above components will be restarted automatically after the changes are made. Since our current version of kubelet has certificate auto-rotation enabled by default, I don&rsquo;t need to manage the kubelet certificate anymore, so I update the certificate to 10 validity. <strong>Make sure to backup the certificate directory before operation to prevent rollback of operation errors</strong> .</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/certs/">certs</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/grafana-loki-usage/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Grafana Loki Concise Tutorial</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/use-kustomize-custom-helm-charts/">
            <span class="next-text nav-default">Customize Helm Charts with Kustomize</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
