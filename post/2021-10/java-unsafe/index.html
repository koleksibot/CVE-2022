<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Talk about some tips for using Unsafe - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I remember when I first learned Java, just after learning the syntax basics, I came across reflection, a feature provided by Java, although it seems to be a very basic knowledge point now, but at that time, I was undoubtedly excited, and I instantly felt that I was out of the &amp;ldquo;Java beginner&amp;rdquo; team. As I gained experience, I gradually learned a lot of similar points that I was excited about, and the Unsafe technique was definitely one of them." /><meta name="keywords" content="Java, Unsafe" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/java-unsafe/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Talk about some tips for using Unsafe" />
<meta property="og:description" content="I remember when I first learned Java, just after learning the syntax basics, I came across reflection, a feature provided by Java, although it seems to be a very basic knowledge point now, but at that time, I was undoubtedly excited, and I instantly felt that I was out of the &ldquo;Java beginner&rdquo; team. As I gained experience, I gradually learned a lot of similar points that I was excited about, and the Unsafe technique was definitely one of them." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/java-unsafe/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-15T20:55:19+08:00" />
<meta property="article:modified_time" content="2021-10-15T20:55:19+08:00" />

<meta itemprop="name" content="Talk about some tips for using Unsafe">
<meta itemprop="description" content="I remember when I first learned Java, just after learning the syntax basics, I came across reflection, a feature provided by Java, although it seems to be a very basic knowledge point now, but at that time, I was undoubtedly excited, and I instantly felt that I was out of the &ldquo;Java beginner&rdquo; team. As I gained experience, I gradually learned a lot of similar points that I was excited about, and the Unsafe technique was definitely one of them."><meta itemprop="datePublished" content="2021-10-15T20:55:19+08:00" />
<meta itemprop="dateModified" content="2021-10-15T20:55:19+08:00" />
<meta itemprop="wordCount" content="1825">
<meta itemprop="keywords" content="java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Talk about some tips for using Unsafe"/>
<meta name="twitter:description" content="I remember when I first learned Java, just after learning the syntax basics, I came across reflection, a feature provided by Java, although it seems to be a very basic knowledge point now, but at that time, I was undoubtedly excited, and I instantly felt that I was out of the &ldquo;Java beginner&rdquo; team. As I gained experience, I gradually learned a lot of similar points that I was excited about, and the Unsafe technique was definitely one of them."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Talk about some tips for using Unsafe</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-15 20:55:19 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/implementation-details/"> implementation-details </a>
            </div>
          <span class="more-meta"> 1825 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#using-unsafe">Using Unsafe</a></li>
        <li><a href="#memory-allocation--access">Memory allocation &amp; access</a></li>
        <li><a href="#memory-copy">Memory Copy</a></li>
        <li><a href="#unconventional-instantiated-objects">Unconventional instantiated objects</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I remember when I first learned Java, just after learning the syntax basics, I came across <code>reflection</code>, a feature provided by Java, although it seems to be a very basic knowledge point now, but at that time, I was undoubtedly excited, and I instantly felt that I was out of the &ldquo;Java beginner&rdquo; team. As I gained experience, I gradually learned a lot of similar points that I was excited about, and the Unsafe technique was definitely one of them.</p>
<p>Unsafe` is a tool class provided natively by the JDK that contains many operations that seem cool in Java, such as memory allocation and reclamation, CAS operations, class instantiation, memory barriers, and so on. As its name suggests, the operations it provides are also more dangerous due to its ability to manipulate memory directly and perform underlying system calls. unsafe has been instrumental in extending the expressiveness of the Java language and facilitating the implementation of core library functionality in higher-level (Java layer) code that would otherwise be implemented at a lower level (C layer).</p>
<p>Starting with JDK9, the limitations of Java&rsquo;s modular design prevented any of the non-standard library modules from accessing <code>sun.misc.Unsafe</code>. However, in JDK8, we can still operate Unsafe directly, and if we don&rsquo;t learn it, we may not have the chance later.</p>
<h2 id="using-unsafe">Using Unsafe</h2>
<p>Unsafe was not designed to be invoked by the average developer, so we cannot instantiate Unsafe objects via the new or factory methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">getUnsafe</span><span class="o">();</span>

<span class="kd">static</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span> <span class="nf">getUnsafe</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span>  <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once you get it, you can use the global singleton object to do whatever you want.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/15/6021a32b17b14a739a7b12db4e13d77c.png" alt=""></p>
<p>I borrowed the image directly from the web. The above picture contains many features of Unsafe, which is quite comprehensive. If I introduce all of them, the article will be too long, and the format will inevitably be a running account, so I am going to combine some of my project experience and some competition experience, and talk about some tips of Unsafe from a practical point of view.</p>
<h2 id="memory-allocation--access">Memory allocation &amp; access</h2>
<p>Java can actually manipulate memory directly like C++, with Unsafe. Let&rsquo;s start with a ByteBuffer example where we will open up a 16-byte memory space and write and read 4 int types of data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testByteBuffer</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ByteBuffer</span> <span class="n">directBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">16</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Students who are familiar with nio operations should not be familiar with the above example, which is a very basic and standard way of using memory. How can Unsafe achieve the same effect?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testUnsafe0</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">address</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">allocateMemory</span><span class="o">(</span><span class="n">16</span><span class="o">);</span>
    <span class="n">unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
    <span class="n">unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">4</span><span class="o">,</span> <span class="n">2</span><span class="o">);</span>
    <span class="n">unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">8</span><span class="o">,</span> <span class="n">3</span><span class="o">);</span>
    <span class="n">unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">12</span><span class="o">,</span> <span class="n">4</span><span class="o">);</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">address</span><span class="o">));</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">4</span><span class="o">));</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">8</span><span class="o">));</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">12</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The output of both codes is the same.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">1
2
3
4
</code></pre></td></tr></table>
</div>
</div><p>The following is a description of the Unsafe APIs used, one by one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">native</span> <span class="kt">long</span> <span class="nf">allocateMemory</span><span class="o">(</span><span class="kt">long</span> <span class="n">var1</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>The native method allocates memory off the heap and returns a long type value, which is the first address of the memory and can be used as a reference to other Unsafe APIs. If you have seen the source code of DirectByteBuffer, you will see that it is actually wrapped in Unsafe internally. Speaking of DirectByteBuffer, here&rsquo;s an extra note: <code>ByteBuffer.allocateDirect</code> allocates out-of-heap memory subject to <code>-XX:MaxDirectMemorySize</code>, while Unsafe allocates out-of-heap memory without the limit, and of course, without the <code>-Xmx</code> limit. . If you are participating in a contest and are inspired by something, you can type &ldquo;I got it&rdquo; on the public screen.</p>
<p>Seeing the other two APIs <code>putInt</code> and <code>getInt</code>, you should realize that there must be other byte manipulation APIs such as <code>putByte</code> / <code>putShort</code> / <code>putLong</code>, and of course put and get come in pairs. There are also points to note in this series of APIs, and it is recommended to use them in pairs, otherwise the parsing may fail due to byte order. You can see the following example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testUnsafe1</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">ByteBuffer</span> <span class="n">directBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">directBufferAddress</span> <span class="o">=</span> <span class="o">((</span><span class="n">DirectBuffer</span><span class="o">)</span><span class="n">directBuffer</span><span class="o">).</span><span class="na">address</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Unsafe.putInt(1)&#34;</span><span class="o">);</span>
    <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">directBufferAddress</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Unsafe.getInt() == &#34;</span> <span class="o">+</span> <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">directBufferAddress</span><span class="o">));</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;ByteBuffer.getInt() == &#34;</span> <span class="o">+</span> <span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;ByteBuffer.getInt() reverseBytes == &#34;</span> <span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">reverseBytes</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Unsafe</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
<span class="n">Unsafe</span><span class="o">.</span><span class="na">getInt</span><span class="o">()</span> <span class="o">==</span> <span class="n">1</span>
<span class="n">ByteBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">()</span> <span class="o">==</span> <span class="n">16777216</span>
<span class="n">ByteBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">()</span> <span class="n">reverseBytes</span> <span class="o">==</span> <span class="n">1</span>
</code></pre></td></tr></table>
</div>
</div><p>We can find that when we use Unsafe to putInt and then use ByteBuffer to getInt, the result is not as expected and we need to change the byte order of the result to restore the correct one. This is actually because ByteBuffer internally determines the byte order of the current operating system, and for multi-byte data types like int, my test machine uses large end order storage, while Unsafe stores them in small short order by default. If you are not sure, it is recommended to use the write and read APIs together to avoid byte order problems.</p>
<h2 id="memory-copy">Memory Copy</h2>
<p>Memory copy is still a very common requirement in real-world applications. For example, as I introduced in the previous article, when writing to disk, in-heap memory needs to be copied to off-heap memory first, and when we do memory aggregation, for example, we need to buffer some data, which also involves memory copy. Unsafe provides native methods for memory copying, which can be done from heap to heap, from heap to heap, from heap to heap, and from heap to heap, in short, from anywhere to anywhere.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">copyMemory</span><span class="o">(</span><span class="n">Object</span> <span class="n">src</span><span class="o">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">,</span> <span class="n">Object</span> <span class="n">dst</span> <span class="o">,</span><span class="kt">long</span> <span class="n">dstOffset</span><span class="o">,</span> <span class="kt">long</span> <span class="n">size</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>For in-heap memory, we can directly pass src the first address of the array of objects and specify offset as the offset of the corresponding array type, and we can get the offset of the objects stored in in-heap memory by using the arrayBaseOffset method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">arrayBaseOffset</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">var1</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>For example, to get a fixed offset of byte[] you can do this: <code>unsafe.arrayBaseOffset(byte[].class)</code></p>
<p>For off-heap memory, it is a bit more intuitive, with dst set to null and dstOffset set to the memory address obtained by Unsafe.</p>
<p>Example code for copying in-heap memory to out-of-heap memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">unsafeCopyMemory</span><span class="o">()</span>  <span class="o">{</span>
    <span class="n">ByteBuffer</span> <span class="n">heapBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="n">ByteBuffer</span> <span class="n">directBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
    <span class="n">heapBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">1234</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">address</span> <span class="o">=</span> <span class="o">((</span><span class="n">DirectBuffer</span><span class="o">)</span><span class="n">directBuffer</span><span class="o">).</span><span class="na">address</span><span class="o">();</span>

    <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">copyMemory</span><span class="o">(</span><span class="n">heapBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="n">16</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">address</span><span class="o">,</span> <span class="n">4</span><span class="o">);</span>

    <span class="n">directBuffer</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">directBuffer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">directBuffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In practice, most ByteBuffer-related source code uses the copyMemory method when it comes to memory copying.</p>
<h2 id="unconventional-instantiated-objects">Unconventional instantiated objects</h2>
<p>Before JDK9 modularity, there were usually two common practices if you didn&rsquo;t want to open some classes to other users or avoid being instantiated randomly (singleton pattern)</p>
<p>Case 1: Privatizing constructors</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrivateConstructorFoo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nf">PrivateConstructorFoo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;constructor method is invoked&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hello world&#34;</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If you wish to instantiate the object, the first thing that comes to mind is probably reflection to create</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reflectConstruction</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">PrivateConstructorFoo</span> <span class="n">privateConstructorFoo</span> <span class="o">=</span> <span class="n">PrivateConstructorFoo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
  <span class="n">privateConstructorFoo</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Unsurprisingly, we obtained an exception</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalAccessException</span><span class="o">:</span> <span class="n">Class</span> <span class="n">io</span><span class="o">.</span><span class="na">openmessaging</span><span class="o">.</span><span class="na">Main</span> <span class="n">can</span> <span class="n">not</span> <span class="n">access</span> <span class="n">a</span> <span class="n">member</span> <span class="n">of</span> <span class="kd">class</span> <span class="nc">moe</span><span class="o">.</span><span class="na">cnkirito</span><span class="o">.</span><span class="na">PrivateConstructorFoo</span> <span class="n">with</span> <span class="n">modifiers</span> <span class="s">&#34;private&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>With a slight adjustment, the constructor is called to create the instance</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reflectConstruction2</span><span class="o">()</span> <span class="o">{</span>
   <span class="n">Constructor</span><span class="o">&lt;</span><span class="n">PrivateConstructorFoo</span><span class="o">&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">PrivateConstructorFoo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">();</span>
   <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
   <span class="n">PrivateConstructorFoo</span> <span class="n">privateConstructorFoo</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
   <span class="n">privateConstructorFoo</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It works! The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">constructor method is invoked
hello world
</code></pre></td></tr></table>
</div>
</div><p>Of course, Unsafe also provides the allocateInstance method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">native</span> <span class="n">Object</span> <span class="nf">allocateInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InstantiationException</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Instantiation is also possible and more intuitive</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">allocateInstance</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InstantiationException</span> <span class="o">{</span>
    <span class="n">PrivateConstructorFoo</span> <span class="n">privateConstructorFoo</span> <span class="o">=</span> <span class="o">(</span><span class="n">PrivateConstructorFoo</span><span class="o">)</span> <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">allocateInstance</span><span class="o">(</span><span class="n">PrivateConstructorFoo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">privateConstructorFoo</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Again works! The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">hello world
</code></pre></td></tr></table>
</div>
</div><p>Note one detail here, <code>allocateInstance</code> does not trigger the constructor method.</p>
<p>Case 2: package level instances</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">moe.cnkirito</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">PackageFoo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hello world&#34;</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that here I have defined a package level accessible object <code>PackageFoo</code> that is only accessible to classes under the <code>moe.cnkirito</code> package.</p>
<p>Let&rsquo;s also try to use reflection first</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.bellamm</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reflectConstruction</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;moe.cnkirito.PackageFoo&#34;</span><span class="o">);</span>
  <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Got the expected error reported.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalAccessException</span><span class="o">:</span> <span class="n">Class</span> <span class="n">io</span><span class="o">.</span><span class="na">openmessaging</span><span class="o">.</span><span class="na">Main</span> <span class="n">can</span> <span class="n">not</span> <span class="n">access</span> <span class="n">a</span> <span class="n">member</span> <span class="n">of</span> <span class="kd">class</span> <span class="nc">moe</span><span class="o">.</span><span class="na">cnkirito</span><span class="o">.</span><span class="na">PackageFoo</span> <span class="n">with</span> <span class="n">modifiers</span> <span class="s">&#34;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>What about trying Unsafe again?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.bellamm</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">allocateInstance</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">fooClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;moe.cnkirito.PackageFoo&#34;</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">allocateInstance</span><span class="o">(</span><span class="n">fooClass</span><span class="o">);</span>
    <span class="n">Method</span> <span class="n">helloMethod</span> <span class="o">=</span> <span class="n">fooClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
    <span class="n">helloMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">helloMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">foo</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since we cannot even define the PackageFoo class at compile time under the <code>com.bellamm</code> package, we have to use the reflection mechanism to get the methods of <code>moe.cnkirito.PackageFoo</code> at runtime, with Unsafe instantiation, and finally call it to successfully output <code>hello world</code>.</p>
<p>After spending so much time experimenting with the two limiting cases and the Unsafe solution, we need to have real-world scenarios to support the value of Unsafe#allocateInstance. I will briefly list two scenarios.</p>
<ol>
<li>when a serialization framework is unable to create an object using reflection, you can try to create it using Unsafe as the underwriting logic.</li>
<li>Get the package level protected class, and then with the help of reflection mechanism, you can magic some source code implementation or call some native methods, this method is used with caution, not recommended for production use.</li>
</ol>
<p>Sample code: dynamically modify the out-of-heap memory limit to override the JVM startup parameter: <code>-XX:MaxDirectMemorySize</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">hackMaxDirectMemorySize</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">directMemoryField</span> <span class="o">=</span> <span class="n">VM</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;directMemory&#34;</span><span class="o">);</span>
        <span class="n">directMemoryField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">directMemoryField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">VM</span><span class="o">(),</span> <span class="n">8L</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">);</span>

        <span class="n">Object</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="na">unsafe</span><span class="o">.</span><span class="na">allocateInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.nio.Bits&#34;</span><span class="o">));</span>
        <span class="n">Field</span> <span class="n">maxMemory</span> <span class="o">=</span> <span class="n">bits</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;maxMemory&#34;</span><span class="o">);</span>
        <span class="n">maxMemory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">maxMemory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">bits</span><span class="o">,</span> <span class="n">8L</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">VM</span><span class="o">.</span><span class="na">maxDirectMemory</span><span class="o">());</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>First of all, I would like to introduce these three Unsafe usage, which I personally think are some of the more commonly used Unsafe cases.</p>
<p>Unsafe is something that people who know how to use it basically know that you can&rsquo;t use it blindly; if you don&rsquo;t use it, it&rsquo;s better to know that Java has this mechanism than not to know it, right? Of course, this article also introduces some practical scenarios that may have to use Unsafe, but more still appear in the underlying source code.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">java</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/css-content-url/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">CSS content&#39;s new replacement element specification behavior explained</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/visually-explained-k8s-ingress/">
            <span class="next-text nav-default">Illustrating Kubernetes Ingress</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
