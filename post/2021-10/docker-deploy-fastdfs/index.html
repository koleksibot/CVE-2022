<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Docker Deployment FastDFS - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="If your FastDFS file system needs high availability and needs to be deployed on multiple machines, and you only run FastDFS on these servers, then FastDFS may not be suitable for deployment with Docker, it can be deployed directly on the machines according to the official documentation, there is no need to use containers to deploy. In fact, FastDFS is not suitable for containerized deployment, because the tracker server reports" /><meta name="keywords" content="Docker, Fastdfs" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/docker-deploy-fastdfs/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Docker Deployment FastDFS" />
<meta property="og:description" content="If your FastDFS file system needs high availability and needs to be deployed on multiple machines, and you only run FastDFS on these servers, then FastDFS may not be suitable for deployment with Docker, it can be deployed directly on the machines according to the official documentation, there is no need to use containers to deploy. In fact, FastDFS is not suitable for containerized deployment, because the tracker server reports" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/docker-deploy-fastdfs/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-04T09:49:30+08:00" />
<meta property="article:modified_time" content="2021-10-04T09:49:30+08:00" />

<meta itemprop="name" content="Docker Deployment FastDFS">
<meta itemprop="description" content="If your FastDFS file system needs high availability and needs to be deployed on multiple machines, and you only run FastDFS on these servers, then FastDFS may not be suitable for deployment with Docker, it can be deployed directly on the machines according to the official documentation, there is no need to use containers to deploy. In fact, FastDFS is not suitable for containerized deployment, because the tracker server reports"><meta itemprop="datePublished" content="2021-10-04T09:49:30+08:00" />
<meta itemprop="dateModified" content="2021-10-04T09:49:30+08:00" />
<meta itemprop="wordCount" content="2890">
<meta itemprop="keywords" content="docker,fastdfs," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker Deployment FastDFS"/>
<meta name="twitter:description" content="If your FastDFS file system needs high availability and needs to be deployed on multiple machines, and you only run FastDFS on these servers, then FastDFS may not be suitable for deployment with Docker, it can be deployed directly on the machines according to the official documentation, there is no need to use containers to deploy. In fact, FastDFS is not suitable for containerized deployment, because the tracker server reports"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Docker Deployment FastDFS</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-04 09:49:30 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2890 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#building-a-docker-image">Building a docker image</a>
          <ul>
            <li><a href="#preparing-the-configuration-file">Preparing the configuration file</a></li>
            <li><a href="#modify-the-configuration-file">Modify the configuration file</a></li>
            <li><a href="#dockerfile">Dockerfile</a></li>
            <li><a href="#comparison-of-the-size-built-out-of-different-base-images">Comparison of the size built out of different base images</a></li>
            <li><a href="#problems-caused-by-musl-libc">Problems caused by musl libc</a></li>
            <li><a href="#container-startup-method">Container startup method</a></li>
          </ul>
        </li>
        <li><a href="#testing">Testing</a>
          <ul>
            <li><a href="#testing-tools">Testing Tools</a></li>
            <li><a href="#file-upload-test">File upload test</a></li>
            <li><a href="#file-download-test">File Download Test</a></li>
            <li><a href="#analysis-of-test-results">Analysis of test results</a></li>
          </ul>
        </li>
        <li><a href="#optimization-parameters">Optimization parameters</a></li>
        <li><a href="#faq">FAQ</a>
          <ul>
            <li><a href="#unable-to-connect-to-tracker-server">Unable to connect to tracker server</a></li>
            <li><a href="#server-disk-exhaustion">Server disk exhaustion</a></li>
            <li><a href="#failed-when-restarting-service">Failed when restarting service</a></li>
            <li><a href="#security-related">Security Related</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>If your FastDFS file system needs high availability and needs to be deployed on multiple machines, and you only run FastDFS on these servers, then FastDFS may not be suitable for deployment with Docker, it can be deployed directly on the machines according to the official documentation, there is no need to use containers to deploy. In fact, FastDFS is not suitable for containerized deployment, because the tracker server reports its IP to the storage server, and this IP is the IP inside the container. This is a private IP segment of Docker, which will prevent clients from accessing the storage server. Of course, if you use a host network or a network solution that connects clients to storage, such as flannel, calico, etc., this is possible, and in Kubernetes based on service discovery, clients can also access the storage server.</p>
<p>So what scenario is FastDFS deployment using Docker suitable for? In fact, it is suitable for small and medium-sized projects that do not require high availability and high performance. Or all FastDFS services can be wrapped in a container and started with other services using docker-compose, which is perfect. My project is this scenario, because of limited server resources, it is impossible to deploy a separate FastDFS server cluster, blah blah blah the whole high availability. All project components are deployed on one machine using Docker, and nginx in FastDFS is also not deployed separately, and tracker, storage server together in a container. There is no way to save resources ğŸ˜‚</p>
<h2 id="building-a-docker-image">Building a docker image</h2>
<p>Officially, there are two ways to build docker images, but I feel that they are not good, one is to use the centos base image build, the size of the build out is nearly, there is no need to distinguish between local build or network build. The whole process of building you need to connect to the extranet to download the build package and so on, and what network build and local build to distinguish? So here we just need to prepare the configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"> â•­â”€root@docker-230 ~/root/container/fastdfs/fastdfs/docker/dockerfile_network â€¹masterâ€º
â•°â”€# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
fastdfs             centos              c1488537c23c        <span class="m">8</span> seconds ago       483MB
</code></pre></td></tr></table>
</div>
</div><h3 id="preparing-the-configuration-file">Preparing the configuration file</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># å°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶ä¸€å¹¶æ”¾åˆ° conf ç›®å½•ä¸‹</span>
<span class="nb">cd</span> ~
mkdir  -p fastdfs/conf
git clone https://github.com/happyfish100/fastdfs.git --depth <span class="m">1</span>
cp -rf fastdfs/docker/dockerfile_local/conf/* conf
cp fastdfs/docker/dockerfile_local/fastdfs.sh conf
touch Dockerfile.debian
touch Dockerfile.alpine
<span class="c1"># å¤åˆ¶å‡ºæ¥é…ç½®æ–‡ä»¶ï¼ŒæŠŠæºç ç§»é™¤æ‰å°±å¯ä»¥</span>
rm -rf fastdfs
</code></pre></td></tr></table>
</div>
</div><h3 id="modify-the-configuration-file">Modify the configuration file</h3>
<p>All the configuration files are in conf, so we can modify each one according to our needs.</p>
<p>I modified the default configuration, the data storage directory modified to <code>/var/fdfs</code>, in writing <code>Dockerfile</code> when you need to create this directory, if your directory is not modified, the Dockerfile there after the path to create the folder modified to the default can be.</p>
<p><code>tracker_server</code> modified to <code>tracker_server=tracker_ip:22122</code>, when the container starts using the environment variable injected <code>FASTDFS_IPADDR</code> to replace it can.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">â•­â”€root@debian-deploy-132 ~/fastdfs/conf
â•°â”€# tree
.
â”œâ”€â”€ client.conf             <span class="c1"># C è¯­è¨€ç‰ˆæœ¬å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¿½ç•¥</span>
â”œâ”€â”€ fastdfs.sh              <span class="c1"># docker å®¹å™¨å¯åŠ¨ fastdfs æœåŠ¡çš„è„šæœ¬</span>
â”œâ”€â”€ http.conf               <span class="c1"># http é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£</span>
â”œâ”€â”€ mime.types              <span class="c1">#</span>
â”œâ”€â”€ mod_fastdfs.conf        <span class="c1"># fastdfs nginx æ¨¡å—é…ç½®æ–‡ä»¶</span>
â”œâ”€â”€ nginx.conf              <span class="c1"># nginx é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è‡ªèº«é¡¹ç›®ä¿®æ”¹</span>
â”œâ”€â”€ storage.conf            <span class="c1"># storage æœåŠ¡é…ç½®æ–‡ä»¶</span>
â””â”€â”€ tracker.conf            <span class="c1"># tracker æœåŠ¡é…ç½®æ–‡ä»¶</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="tracker-service-configuration-file-trackerconf">tracker service configuration file tracker.conf</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">disabled</span><span class="o">=</span><span class="nb">false</span>                <span class="c1">#å¯ç”¨é…ç½®æ–‡ä»¶</span>
<span class="nv">port</span><span class="o">=</span><span class="m">22122</span>                    <span class="c1">#è®¾ç½®trackerçš„ç«¯å£å·</span>
<span class="nv">base_path</span><span class="o">=</span>/var/dfs           <span class="c1">#è®¾ç½®trackerçš„æ•°æ®æ–‡ä»¶å’Œæ—¥å¿—ç›®å½•ï¼ˆéœ€é¢„å…ˆåˆ›å»ºï¼‰</span>
http.server_port<span class="o">=</span><span class="m">28080</span>         <span class="c1">#è®¾ç½®httpç«¯å£å·</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="storage-service-configuration-file-storage_idsconf">storage service configuration file storage_ids.conf</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># storageæœåŠ¡ç«¯å£</span>
<span class="nv">port</span><span class="o">=</span><span class="m">23000</span>                         <span class="c1"># ç›‘å¬ç«¯å£å·</span>
<span class="nv">base_path</span><span class="o">=</span>/var/dfs                <span class="c1"># æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•</span>
<span class="nv">store_path0</span><span class="o">=</span>/var/dfs              <span class="c1"># ç¬¬ä¸€ä¸ªå­˜å‚¨ç›®å½•</span>
<span class="nv">tracker_server</span><span class="o">=</span>tracker_ip:22122    <span class="c1"># trackeræœåŠ¡å™¨IPå’Œç«¯å£</span>
http.server_port<span class="o">=</span><span class="m">28888</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="nginx-configuration-file-nginxconf">nginx configuration file nginx.conf</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># åœ¨ nginx é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¿®æ”¹ä¸‹é¢è¿™æ®µ</span>
server <span class="o">{</span>
    listen       28888<span class="p">;</span>    <span class="c1">## è¯¥ç«¯å£ä¸ºstorage.confä¸­çš„http.server_portç›¸åŒ</span>
    server_name  localhost<span class="p">;</span>
    location ~/group<span class="o">[</span>0-9<span class="o">]</span>/ <span class="o">{</span>
        ngx_fastdfs_module<span class="p">;</span>
    <span class="o">}</span>
    error_page   <span class="m">500</span> <span class="m">502</span> <span class="m">503</span> <span class="m">504</span>  /50x.html<span class="p">;</span>
    <span class="nv">location</span> <span class="o">=</span> /50x.html <span class="o">{</span>
    root   html<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="nginx-module-configuration-file-mod_fastdfsconf">nginx module configuration file mod_fastdfs.conf</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">tracker_server</span><span class="o">=</span>tracker_ip:22122   <span class="c1"># trackeræœåŠ¡å™¨IPå’Œç«¯å£</span>
<span class="nv">url_have_group_name</span><span class="o">=</span><span class="nb">true</span>             <span class="c1"># url ä¸­åŒ…å« group çš„åç§°</span>
<span class="nv">store_path0</span><span class="o">=</span>/var/dfs                <span class="c1"># æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="script-for-the-fastdfs-service-fastdfssh">Script for the fastdfs service fastdfs.sh</h4>
<p>The official script is written very arbitrarily, I will modify a ha, do not modify according to the official to also ok</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nv">new_val</span><span class="o">=</span><span class="nv">$FASTDFS_IPADDR</span>
<span class="nv">old</span><span class="o">=</span><span class="s2">&#34;tracker_ip&#34;</span>

sed -i <span class="s2">&#34;s/</span><span class="nv">$old</span><span class="s2">/</span><span class="nv">$new_val</span><span class="s2">/g&#34;</span> /etc/fdfs/storage.conf
sed -i <span class="s2">&#34;s/</span><span class="nv">$old</span><span class="s2">/</span><span class="nv">$new_val</span><span class="s2">/g&#34;</span> /etc/fdfs/mod_fastdfs.conf

<span class="nb">echo</span> <span class="s2">&#34;start trackerd&#34;</span>
/etc/init.d/fdfs_trackerd start

<span class="nb">echo</span> <span class="s2">&#34;start storage&#34;</span>
/etc/init.d/fdfs_storaged start

<span class="nb">echo</span> <span class="s2">&#34;start nginx&#34;</span>
/usr/local/nginx/sbin/nginx

tail -f  /dev/null
</code></pre></td></tr></table>
</div>
</div><h4 id="replace-bash-with-sh">Replace bash with sh</h4>
<p>In fact, this step can not be done, if you use bash boot, you need to install bash in alpine, will increase the size of the image of about 6MB, it does not feel necessary to do so ğŸ˜‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sed -i <span class="s1">&#39;s/bash/sh/g&#39;</span> <span class="sb">`</span>grep -nr bash <span class="p">|</span> awk -F <span class="s1">&#39;:&#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>

<span class="c1"># æ›¿æ¢å</span>
grep -nr <span class="se">\#\!\/</span>bin<span class="se">\/</span>sh
stop.sh:1:#!/bin/sh
init.d/fdfs_storaged:1:#!/bin/sh
init.d/fdfs_trackerd:1:#!/bin/sh
conf/fastdfs.sh:1:#!/bin/sh
restart.sh:1:#!/bin/sh
docker/dockerfile_local/fastdfs.sh:1:#!/bin/sh
docker/dockerfile_network/fastdfs.sh:1:#!/bin/sh
</code></pre></td></tr></table>
</div>
</div><h3 id="dockerfile">Dockerfile</h3>
<h4 id="alpine310">alpine:3.10</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> alpine:3.10</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> conf/ /home<span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">set</span> -xe <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;http://mirrors.aliyun.com/alpine/latest-stable/main/&#34;</span> &gt; /etc/apk/repositories <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;http://mirrors.aliyun.com/alpine/latest-stable/community/&#34;</span> &gt;&gt; /etc/apk/repositories <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apk update <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apk add --no-cache --virtual .build-deps alpine-sdk gcc libc-dev make perl-dev openssl-dev pcre-dev zlib-dev tzdata <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;Asia/Shanghai&#34;</span> &gt; /etc/timezone <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /usr/local/src <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/libfastcommon.git --depth <span class="m">1</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/fastdfs.git --depth <span class="m">1</span>    <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/fastdfs-nginx-module.git --depth <span class="m">1</span>  <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> wget http://nginx.org/download/nginx-1.15.4.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> tar -xf nginx-1.15.4.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/libfastcommon <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/sys\/poll\.h/poll\.h/g&#39;</span> src/sockopt.c <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/nginx-1.15.4/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./configure --add-module<span class="o">=</span>/usr/local/src/fastdfs-nginx-module/src/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apk del .build-deps tzdata <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apk add --no-cache pcre-dev bash <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /var/fdfs /home/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/fastdfs.sh /home/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/*.conf /home/mime.types /etc/fdfs <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/nginx.conf /usr/local/nginx/conf/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod +x /home/fastdfs/fastdfs.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/bash/sh/g&#39;</span> /etc/init.d/fdfs_storaged <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/bash/sh/g&#39;</span> /etc/init.d/fdfs_trackerd <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/bash/sh/g&#39;</span> /home/fastdfs/fastdfs.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rm -rf /usr/local/src/* /var/cache/apk/* /tmp/* /var/tmp/* <span class="nv">$HOME</span>/.cache<span class="err">
</span><span class="err"></span><span class="k">VOLUME</span><span class="s"> /var/fdfs</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 22122 23000 28888 28080</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/home/fastdfs/fastdfs.sh&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="debianstretch-slim">debian:stretch-slim</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> debian:stretch-slim</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> conf/ /home/<span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">set</span> -x <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;Asia/shanghai&#34;</span> &gt; /etc/timezone <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/deb.debian.org/mirrors.aliyun.com/g&#39;</span> /etc/apt/sources.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s|security.debian.org/debian-security|mirrors.aliyun.com/debian-security|g&#39;</span> /etc/apt/sources.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install  --no-install-recommends --no-install-suggests -y build-essential libpcre3 libpcre3-dev zlib1g <span class="se">\
</span><span class="se"></span>                   git wget ca-certificates  zlib1g-dev libtool libssl-dev <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /usr/local/src <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/libfastcommon.git --depth <span class="m">1</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/fastdfs.git --depth <span class="m">1</span>    <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> git clone https://github.com/happyfish100/fastdfs-nginx-module.git --depth <span class="m">1</span>  <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> wget http://nginx.org/download/nginx-1.15.4.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> tar -xf nginx-1.15.4.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/libfastcommon <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./make.sh install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/local/src/nginx-1.15.4/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ./configure --add-module<span class="o">=</span>/usr/local/src/fastdfs-nginx-module/src/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt purge -y build-essential libtool git wget ca-certificates <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt autoremove -y <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /var/dfs /home/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/fastdfs.sh /home/fastdfs/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/*.conf /home/mime.types /etc/fdfs <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv /home/nginx.conf /usr/local/nginx/conf/ <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod +x /home/fastdfs/fastdfs.sh <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/list  /usr/local/src/*<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">VOLUME</span><span class="s"> /var/fdfs</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s">  22122 23000 28888 28080</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="comparison-of-the-size-built-out-of-different-base-images">Comparison of the size built out of different base images</h3>
<p>The official build out image is nearly 500MB</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">fastdfs             alpine              e855bd197dbe        10 seconds ago      29.3MB
fastdfs             debian              e05ca1616604        20 minutes ago      103MB
fastdfs             centos              c1488537c23c        30 minutes ago      483MB
</code></pre></td></tr></table>
</div>
</div><h4 id="analyze-individual-images-using-dive">Analyze individual images using dive</h4>
<p>Official</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/e7b10f77ac924725b289456c3f452534.png" alt=""></p>
<h4 id="alpine">alpine</h4>
<p>After the alpine-based base image is built, there are only three layers of images ğŸ˜‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/f277d9fe916f44589cb9bca01c0d3a85.png" alt=""></p>
<h4 id="debian">debian</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/cac6d141bbc74d94a8170ca7bc08ef7b.png" alt=""></p>
<h3 id="problems-caused-by-musl-libc">Problems caused by musl libc</h3>
<p>However, it should be noted that there is a big difference between the dynamic link libraries of CentOS and Alpine base images, when you use ldd to check the compiled fastdfs of both, Alpine lacks many dynamic link libraries because the c library of alpine is <code>musl libc</code>, not the orthodox <code>glibc </code>, and for some large projects that rely on <code>glibc</code>, like openjdk, tomcat, rabbitmq, etc., it is not recommended to use alpine base images, because <code>musl libc</code> can cause some strange problems with jvm. This is why tomcat does not officially give the base image as a Dockerfile of alpine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">centos# find /usr/bin/ -name <span class="s2">&#34;fdfs*&#34;</span> <span class="p">|</span> xargs ldd
        linux-vdso.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0x00007fffe1d30000<span class="o">)</span>
        libpthread.so.0 <span class="o">=</span>&gt; /lib64/libpthread.so.0 <span class="o">(</span>0x00007f86036e6000<span class="o">)</span>
        libfastcommon.so <span class="o">=</span>&gt; /lib/libfastcommon.so <span class="o">(</span>0x00007f86034a5000<span class="o">)</span>
        libc.so.6 <span class="o">=</span>&gt; /lib64/libc.so.6 <span class="o">(</span>0x00007f86030d8000<span class="o">)</span>
        /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007f8603902000<span class="o">)</span>
        libm.so.6 <span class="o">=</span>&gt; /lib64/libm.so.6 <span class="o">(</span>0x00007f8602dd6000<span class="o">)</span>
        libdl.so.2 <span class="o">=</span>&gt; /lib64/libdl.so.2 <span class="o">(</span>0x00007f8602bd2000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">alpine <span class="c1"># find /usr/bin/ -name &#34;fdfs*&#34; | xargs ldd</span>
        /lib/ld-musl-x86_64.so.1 <span class="o">(</span>0x7f4f91585000<span class="o">)</span>
        libfastcommon.so <span class="o">=</span>&gt; /usr/lib/libfastcommon.so <span class="o">(</span>0x7f4f91528000<span class="o">)</span>
        libc.musl-x86_64.so.1 <span class="o">=</span>&gt; /lib/ld-musl-x86_64.so.1 <span class="o">(</span>0x7f4f91585000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">debian <span class="c1"># find /usr/bin/ -name &#34;fdfs*&#34; | xargs ldd</span>
        linux-vdso.so.1 <span class="o">(</span>0x00007ffd17e50000<span class="o">)</span>
        libpthread.so.0 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libpthread.so.0 <span class="o">(</span>0x00007feadf317000<span class="o">)</span>
        libfastcommon.so <span class="o">=</span>&gt; /usr/lib/libfastcommon.so <span class="o">(</span>0x00007feadf0d6000<span class="o">)</span>
        libc.so.6 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span class="o">(</span>0x00007feaded37000<span class="o">)</span>
        /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007feadf74a000<span class="o">)</span>
        libm.so.6 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libm.so.6 <span class="o">(</span>0x00007feadea33000<span class="o">)</span>
        libdl.so.2 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libdl.so.2 <span class="o">(</span>0x00007feade82f000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="container-startup-method">Container startup method</h3>
<p>Note that FastDFS containers need to use the host network, because the fastdfs storage server needs to report its IP to the tracker server, and this IP needs to be injected into the relevant configuration file by means of environment variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker run -d -e <span class="nv">FASTDFS_IPADDR</span><span class="o">=</span>10.10.107.230 <span class="se">\
</span><span class="se"></span>           -p 28888:28888 -p 22122:22122 -p 23000:23000 -p 28088:28080 <span class="se">\
</span><span class="se"></span>           -v <span class="nv">$PWD</span>/data:/var/fdfs --net<span class="o">=</span>host --name fastdfs fastdfs:alpine
</code></pre></td></tr></table>
</div>
</div><h2 id="testing">Testing</h2>
<h3 id="testing-tools">Testing Tools</h3>
<ol>
<li>upload client: <code>fdfs_upload_file</code></li>
<li>concurrent execution tool: <code>xargs</code> 3.</li>
<li>test sample: 10W emoji images, size between <strong>8KB-128KB</strong> 4.</li>
<li>upload test command: `time ls | xargs -n 1 -I {} -P 256 sh -c &ldquo;/usr/bin/fdfs_upload_file /etc/fdfs/client.conf {}&quot;`` -p parameter specifies the number of concurrently executed tasks</li>
<li>download the test tool: <code>wget</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">ä¸‹è½½æµ‹è¯•å‘½ä»¤ï¼š<span class="sb">`</span><span class="nb">time</span> cat url.log  <span class="p">|</span> xargs -n <span class="m">1</span> -I <span class="o">{}</span> -P <span class="m">256</span> sh -c <span class="s2">&#34;wget  {}&#34;</span><span class="sb">`</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="file-upload-test">File upload test</h3>
<p>The test sample is 10W images ranging in size from 8KB-100 KB</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/6d2ae2ed305440f4b6f23f1e4d539d16.png" alt=""></p>
<p>Number and size of test files</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/47391b1260e04f91a117fd0977e4de5d.png" alt=""></p>
<p>The time taken to execute 256 processes and upload 10w photos concurrently using xargs is about 2 minutes (intranet)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/3dc07a74eab941d6a07e7245350749f1.png" alt=""></p>
<p>Time: 2 minutes 11 seconds</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/0a2745e4d7f344c48d7f20b08a809e74.png" alt=""></p>
<p>Client load profile</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/7a03dca2a5e941b58abd31fe05d086c3.png" alt=""></p>
<p>Server-side bandwidth traffic</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/a50f75886c2943218e9665a159f4491c.png" alt=""></p>
<p>Server-side bandwidth traffic</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/62faeb7a43b94a3d9f85e4f4e9c483b6.png" alt=""></p>
<p>Server-side upload results</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/abae4e1105824706b6ce30f427e65cd8.png" alt=""></p>
<p>Server-side upload logs, all without error output</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/89364f7f57584b15805be0321be26d91.png" alt=""></p>
<h3 id="file-download-test">File Download Test</h3>
<p>Extracting file paths from logs</p>
<p>Extract the path to the file from the server-side <code>storage_access.log</code> log, add the <code>nginx</code> access port address using <code>sed</code> to get 10W records <code>http</code> access <code>url</code> address of the uploaded file</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/3f33b5b7e75f423dbd9d8a930d89e76b.png" alt=""></p>
<p>wget download</p>
<p>Use the <code>wget -i</code> parameter to specify <code>url.log</code> as the standard output to test downloading the 10W images just uploaded in 3 minutes and 23 seconds</p>
<h3 id="analysis-of-test-results">Analysis of test results</h3>
<p>Using FastDFS&rsquo;s own upload test tool and the xargs concurrent execution tool, the number of concurrent requests specified by the xargs -P parameter was measured to reach 5000 concurrent upload requests for a stable network environment. 10W images were uploaded in about 2 minutes and 11 seconds. The total test uploads of 100W images were tested continuously using a timing script. Analyzing the logs of tracker server and storage server, no error or abnormality is found in either upload or download, and the performance and stability are good.</p>
<h2 id="optimization-parameters">Optimization parameters</h2>
<p>Adjust the parameters according to business requirements and online environment to fully utilize the performance of FastDFS file system</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹æ•°æ•°é‡
accept_threads=1

# work thread count, should &lt;= max_connections
# default value is 4
# since V2.00
# å·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œåº”å½“å°äºç­‰äºæœ€å¤§è¿æ¥æ•°
work_threads=4

# min buff size
# default value 8KB
# æœ€å°ç¼“å†²å¤§å°ï¼Œé»˜è®¤å€¼ä¸º 8KB
min_buff_size = 8KB

# max buff size
# default value 128KB
# æœ€å¤§ç¼“å†²å¤§å°ï¼Œé»˜è®¤å€¼ä¸º 128KB
max_buff_size = 128KB

# thread stack size, should &gt;= 64KB
# default value is 256KB
# çº¿ç¨‹æ ˆçš„å¤§å°ï¼Œåº”å½“å¤§äº 64KBï¼Œé»˜è®¤ä¸º 256KB
thread_stack_size = 256KB

# if use connection pool
# default value is false
# since V4.05
# æ˜¯å¦ä½¿ç”¨è¿æ¥æ± 
use_connection_pool = false

# connections whose the idle time exceeds this time will be closed
# unit: second
# default value is 3600
# since V4.05
# è¿æ¥æ± çš„æœ€å¤§ç©ºé—²æ—¶é—´
connection_pool_max_idle_time = 3600
</code></pre></td></tr></table>
</div>
</div><h2 id="faq">FAQ</h2>
<h3 id="unable-to-connect-to-tracker-server">Unable to connect to tracker server</h3>
<p>You need to add the allowed IPs in the tracker.conf configuration file, and add firewall rules</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>2019-07-25 10:40:54<span class="o">]</span> ERROR - file: ../client/storage_client.c, line: 996, fdfs_recv_response fail, result: <span class="m">107</span>
upload file fail, error no: 107, error info: Transport endpoint is not connected
<span class="o">[</span>2019-07-25 10:40:54<span class="o">]</span> ERROR - file: tracker_proto.c, line: 37, server: 10.20.172.192:23000, recv data fail, errno: 107, error info: Transport endpoint is not connected
</code></pre></td></tr></table>
</div>
</div><h3 id="server-disk-exhaustion">Server disk exhaustion</h3>
<p>When the storage server runs out of disk in the partition where the upload storage directory is set, an error log will appear with no space left.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>2019-07-26 16:16:45<span class="o">]</span> ERROR - file: tracker_proto.c, line: 48, server: 10.10.107.232:22122, response status <span class="m">28</span> !<span class="o">=</span> <span class="m">0</span>
<span class="o">[</span>2019-07-26 16:16:45<span class="o">]</span> ERROR - file: ../client/tracker_client.c, line: 907, fdfs_recv_response fail, result: <span class="m">28</span>
tracker_query_storage fail, error no: 28, error info: No space left on device
</code></pre></td></tr></table>
</div>
</div><h3 id="failed-when-restarting-service">Failed when restarting service</h3>
<p>use service fdfs_trackerd restart restart tracker or storage service will report an error, will indicate that the port has been occupied. The solution is to use the kill -9 command to kill the tracker service or storage service, and then restart the corresponding service can</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>2019-07-25 10:36:55<span class="o">]</span> INFO - FastDFS v5.12, <span class="nv">base_path</span><span class="o">=</span>/home/dfs, <span class="nv">run_by_group</span><span class="o">=</span>, <span class="nv">run_by_user</span><span class="o">=</span>, <span class="nv">connect_timeout</span><span class="o">=</span>10s, <span class="nv">network_timeout</span><span class="o">=</span>60s, <span class="nv">port</span><span class="o">=</span>22122, <span class="nv">bind_addr</span><span class="o">=</span>, <span class="nv">max_connections</span><span class="o">=</span>1024, <span class="nv">accept_threads</span><span class="o">=</span>1, <span class="nv">work_threads</span><span class="o">=</span>4, <span class="nv">min_buff_size</span><span class="o">=</span>8,192, <span class="nv">max_buff_size</span><span class="o">=</span>131,072, <span class="nv">store_lookup</span><span class="o">=</span>2, <span class="nv">store_group</span><span class="o">=</span>, <span class="nv">store_server</span><span class="o">=</span>0, <span class="nv">store_path</span><span class="o">=</span>0, <span class="nv">reserved_storage_space</span><span class="o">=</span>10.00%, <span class="nv">download_server</span><span class="o">=</span>0, <span class="nv">allow_ip_count</span><span class="o">=</span>-1, <span class="nv">sync_log_buff_interval</span><span class="o">=</span>10s, <span class="nv">check_active_interval</span><span class="o">=</span>120s, <span class="nv">thread_stack_size</span><span class="o">=</span><span class="m">256</span> KB, <span class="nv">storage_ip_changed_auto_adjust</span><span class="o">=</span>1, <span class="nv">storage_sync_file_max_delay</span><span class="o">=</span>86400s, <span class="nv">storage_sync_file_max_time</span><span class="o">=</span>300s, <span class="nv">use_trunk_file</span><span class="o">=</span>0, <span class="nv">slot_min_size</span><span class="o">=</span>256, <span class="nv">slot_max_size</span><span class="o">=</span><span class="m">16</span> MB, <span class="nv">trunk_file_size</span><span class="o">=</span><span class="m">64</span> MB, <span class="nv">trunk_create_file_advance</span><span class="o">=</span>0, <span class="nv">trunk_create_file_time_base</span><span class="o">=</span>02:00, <span class="nv">trunk_create_file_interval</span><span class="o">=</span>86400, <span class="nv">trunk_create_file_space_threshold</span><span class="o">=</span><span class="m">20</span> GB, <span class="nv">trunk_init_check_occupying</span><span class="o">=</span>0, <span class="nv">trunk_init_reload_from_binlog</span><span class="o">=</span>0, <span class="nv">trunk_compress_binlog_min_interval</span><span class="o">=</span>0, <span class="nv">use_storage_id</span><span class="o">=</span>0, <span class="nv">id_type_in_filename</span><span class="o">=</span>ip, <span class="nv">storage_id_count</span><span class="o">=</span>0, <span class="nv">rotate_error_log</span><span class="o">=</span>0, <span class="nv">error_log_rotate_time</span><span class="o">=</span>00:00, <span class="nv">rotate_error_log_size</span><span class="o">=</span>0, <span class="nv">log_file_keep_days</span><span class="o">=</span>0, <span class="nv">store_slave_file_use_link</span><span class="o">=</span>0, <span class="nv">use_connection_pool</span><span class="o">=</span>0, <span class="nv">g_connection_pool_max_idle_time</span><span class="o">=</span>3600s
<span class="o">[</span>2019-07-25 10:36:55<span class="o">]</span> ERROR - file: sockopt.c, line: 868, <span class="nb">bind</span> port <span class="m">22122</span> failed, errno: 98, error info: Address already in use.
<span class="o">[</span>2019-07-25 10:36:55<span class="o">]</span> CRIT - <span class="nb">exit</span> abnormally!
</code></pre></td></tr></table>
</div>
</div><h3 id="security-related">Security Related</h3>
<ul>
<li>The tracker.conf and storage.conf configuration files allow access to all IP addresses by default, it is recommended to remove allow_hosts=* and change it to the IP address of the internal network where the FastDFS client is located.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/73cd56ed3c544e7eb2e1ba78dfb11c2d.png" alt=""></p>
<ul>
<li>The default configuration file of tracker.conf and storage.conf listens to 0.0.0.0, which is the IP address of all local machines, and it is recommended to change it to the IP address of the internal network where the FastDFS server is located.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/bcec5fe328e045888938727eee3a3ab0.png" alt=""></p>
<ul>
<li>The default running user is the current user and the user group is the current user. It is recommended to specify the least privileged user to run this process.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/01d31ffcf22241e98b81a75f567e3e89.png" alt=""></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          <a href="/tags/fastdfs/">fastdfs</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/fastdfs-lua-redis/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Lua &#43; Redis does dynamic routing to nginx</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/kubernetes-service-apis-intro/">
            <span class="next-text nav-default">Introduction to Kubernetes Service APIs</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
