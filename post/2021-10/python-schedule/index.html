<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Python Automation - Timed Tasks - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In our daily work, we often use tasks that need to be executed periodically, one way is to use Linux crond in combination with command line implementation. Another way is to use Python directly, and the following is a list of common ways to implement Python timed tasks. Use while True: &#43; sleep() to implement a timed task The sleep(secs) function in the time module allows you to pause the" /><meta name="keywords" content="python, schedule" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/python-schedule/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Python Automation - Timed Tasks" />
<meta property="og:description" content="In our daily work, we often use tasks that need to be executed periodically, one way is to use Linux crond in combination with command line implementation. Another way is to use Python directly, and the following is a list of common ways to implement Python timed tasks. Use while True: &#43; sleep() to implement a timed task The sleep(secs) function in the time module allows you to pause the" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/python-schedule/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-23T15:19:39+08:00" />
<meta property="article:modified_time" content="2021-10-23T15:19:39+08:00" />

<meta itemprop="name" content="Python Automation - Timed Tasks">
<meta itemprop="description" content="In our daily work, we often use tasks that need to be executed periodically, one way is to use Linux crond in combination with command line implementation. Another way is to use Python directly, and the following is a list of common ways to implement Python timed tasks. Use while True: &#43; sleep() to implement a timed task The sleep(secs) function in the time module allows you to pause the"><meta itemprop="datePublished" content="2021-10-23T15:19:39+08:00" />
<meta itemprop="dateModified" content="2021-10-23T15:19:39+08:00" />
<meta itemprop="wordCount" content="4577">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python Automation - Timed Tasks"/>
<meta name="twitter:description" content="In our daily work, we often use tasks that need to be executed periodically, one way is to use Linux crond in combination with command line implementation. Another way is to use Python directly, and the following is a list of common ways to implement Python timed tasks. Use while True: &#43; sleep() to implement a timed task The sleep(secs) function in the time module allows you to pause the"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Python Automation - Timed Tasks</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-23 15:19:39 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 4577 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#use-while-true--sleep-to-implement-a-timed-task">Use while True: + sleep() to implement a timed task</a></li>
        <li><a href="#running-timed-tasks-with-the-timeloop-library">Running timed tasks with the Timeloop library</a></li>
        <li><a href="#timer-implementation-using-threading">Timer implementation using threading.</a></li>
        <li><a href="#implementing-timed-tasks-with-the-built-in-module-sched">Implementing timed tasks with the built-in module sched</a></li>
        <li><a href="#implementing-timed-tasks-with-the-scheduling-module-schedule">Implementing timed tasks with the scheduling module schedule</a></li>
        <li><a href="#implementing-timed-tasks-using-the-task-framework-apscheduler">Implementing timed tasks using the task framework APScheduler</a>
          <ul>
            <li><a href="#important-concepts-in-apscheduler">Important concepts in APScheduler</a></li>
            <li><a href="#workflow-of-scheduler">Workflow of Scheduler</a></li>
          </ul>
        </li>
        <li><a href="#implementing-timed-tasks-with-celery-a-distributed-messaging-system">Implementing Timed Tasks with Celery, a Distributed Messaging System</a></li>
        <li><a href="#implementing-timed-tasks-with-the-data-flow-tool-apache-airflow">Implementing Timed Tasks with the Data Flow Tool Apache Airflow</a>
          <ul>
            <li><a href="#background-of-the-creation-of-airflow">Background of the creation of Airflow</a></li>
            <li><a href="#airflow-core-concepts">Airflow Core Concepts</a></li>
            <li><a href="#airflows-architecture">Airflow&rsquo;s architecture</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In our daily work, we often use tasks that need to be executed periodically, one way is to use Linux crond in combination with command line implementation. Another way is to use Python directly, and the following is a list of common ways to implement Python timed tasks.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/9d380161280c4301b0299bb992b5c2bc.png" alt=""></p>
<h2 id="use-while-true--sleep-to-implement-a-timed-task">Use while True: + sleep() to implement a timed task</h2>
<p>The sleep(secs) function in the time module allows you to pause the current thread for secs before resuming execution. By suspend, we mean that the current thread enters a blocking state, and when the time specified by the sleep() function is reached, it changes from blocking to ready state and waits for CPU scheduling.</p>
<p>Based on this feature, we can implement a simple timed task by means of while dead loop + sleep().</p>
<p>Code example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">time_printer</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;do func time :&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">loop_monitor</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time_printer</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 暂停5秒</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">loop_monitor</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Main disadvantages.</p>
<ul>
<li>can only set the interval, can not specify a specific time, such as 8:00 am every day</li>
<li>sleep is a blocking function, which means that the program can&rsquo;t do anything during the sleep period.</li>
</ul>
<h2 id="running-timed-tasks-with-the-timeloop-library">Running timed tasks with the Timeloop library</h2>
<p><a href="https://github.com/sankalpjonn/timeloop">Timeloop</a> is a library that can be used to run multi-cycle tasks. It is a simple library that uses the decorator pattern to run tagged functions in threads.</p>
<p>Sample code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">timeloop</span> <span class="kn">import</span> <span class="n">Timeloop</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">tl</span> <span class="o">=</span> <span class="n">Timeloop</span><span class="p">()</span>

<span class="nd">@tl</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">sample_job_every_2s</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&#34;2s job current time : </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>

<span class="nd">@tl</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">sample_job_every_5s</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&#34;5s job current time : </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>


<span class="nd">@tl</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">sample_job_every_10s</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&#34;10s job current time : </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="timer-implementation-using-threading">Timer implementation using threading.</h2>
<p>Timer in threading module is a non-blocking function, a little better than sleep, timer is the most basic understanding of the timer, we can start multiple timer tasks, these timer tasks are asynchronous execution, so there is no waiting order execution problem.</p>
<p>Timer(interval, function, args=[ ], kwargs={ })</p>
<ul>
<li>interval: the specified time</li>
<li>function: the method to be executed</li>
<li>args/kwargs: parameters of the method</li>
</ul>
<p>Code example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Timer</span>


<span class="k">def</span> <span class="nf">time_printer</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;do func time :&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
    <span class="n">loop_monitor</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">loop_monitor</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">time_printer</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">loop_monitor</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Note: Timer can only be executed once, here it needs to be called in a loop, otherwise it can only be executed once</p>
<h2 id="implementing-timed-tasks-with-the-built-in-module-sched">Implementing timed tasks with the built-in module sched</h2>
<p>The sched module implements a generic event scheduler that uses a delay function in the scheduler class to wait for a specific amount of time to execute a task. It also supports multi-threaded applications, where the delay function is called immediately after each task is executed to ensure that other threads can also execute.</p>
<p>class sched.scheduler(timefunc, delayfunc) This class defines a generic interface for scheduling events, it takes two external arguments, timefunc is a function that returns a number of time type without arguments (commonly used as time in the time module), delayfunc should be a function that takes one argument to call, is compatible with the output of timefunc, and serves to delay multiple time units (commonly used as sleep in the time module).</p>
<p>Code example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sched</span>


<span class="k">def</span> <span class="nf">time_printer</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;do func time :&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
    <span class="n">loop_monitor</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">loop_monitor</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sched</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">)</span>  <span class="c1"># 生成调度器</span>
    <span class="n">s</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time_printer</span><span class="p">,</span> <span class="p">())</span>
    <span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">loop_monitor</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Main methods of scheduler object:</p>
<ul>
<li>enter(delay, priority, action, argument), schedule an event to delay the delay by one time unit.</li>
<li>cancel(event): removes an event from the queue. This method will run a ValueError if the event is not the one currently in the queue.</li>
<li>run(): Runs all scheduled events. This function will wait (using the delayfunc() function passed to the constructor) and then execute the events until there are no more scheduled events.</li>
</ul>
<p>Personal comment: better than threading.Timer, no need to call it in a loop.</p>
<h2 id="implementing-timed-tasks-with-the-scheduling-module-schedule">Implementing timed tasks with the scheduling module schedule</h2>
<p><a href="https://github.com/dbader/schedule">schedule</a> is a third-party lightweight task scheduling module that can execute times by seconds, minutes, hours, dates, or custom events. <a href="https://schedule.readthedocs.io/en/stable/">schedule</a> allows users to run Python functions (or other callable functions) at regular intervals using a simple, user-friendly syntax.</p>
<p>Let&rsquo;s look at the code first. Is it possible to understand what it means without reading the documentation?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">schedule</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m working...&#34;</span><span class="p">)</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;10:30&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">minutes</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">monday</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">wednesday</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;13:15&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s2">&#34;:17&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Decorators: decorate static methods with @repeat()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">schedule</span> <span class="kn">import</span> <span class="n">every</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">run_pending</span>


<span class="nd">@repeat</span><span class="p">(</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working...&#39;</span><span class="p">)</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">run_pending</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Transfer parameters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">schedule</span>


<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alice&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Decorators can also pass parameters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">schedule</span> <span class="kn">import</span> <span class="n">every</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">run_pending</span>


<span class="nd">@repeat</span><span class="p">(</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="s1">&#39;World&#39;</span><span class="p">)</span>
<span class="nd">@repeat</span><span class="p">(</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="s1">&#39;Mars&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">planet</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">run_pending</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Cancellation of tasks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">schedule</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">some_task</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">i</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">schedule</span><span class="o">.</span><span class="n">cancel_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cancel job&#39;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="n">job</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">some_task</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Run a task.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">schedule</span>


<span class="k">def</span> <span class="nf">job_that_executes_once</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">schedule</span><span class="o">.</span><span class="n">CancelJob</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">minute</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;:34&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job_that_executes_once</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Retrieve tasks based on tags.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># 检索所有任务：schedule.get_jobs()</span>
<span class="kn">import</span> <span class="nn">schedule</span>


<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Andrea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;hourly-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Monica&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;hourly-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Derek&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">)</span>

<span class="n">friends</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="s1">&#39;friend&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">friends</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Cancellation of tasks according to the label.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># 取消所有任务：schedule.clear()</span>
<span class="kn">import</span> <span class="nn">schedule</span>


<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Cancel&#39;</span><span class="p">:</span>
        <span class="n">schedule</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="s1">&#39;second-tasks&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cancel second-tasks&#39;</span><span class="p">)</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Andrea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;second-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;second-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Monica&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;hourly-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="s1">&#39;Cancel&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s1">&#39;daily-tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Run the task to a certain time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">schedule</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">time</span>


<span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working...&#39;</span><span class="p">)</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="s1">&#39;23:59&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># 今天23:59停止</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="s1">&#39;2030-01-01 18:30&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># 2030-01-01 18:30停止</span>

<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># 8小时后停止</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">))</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># 今天23:59:59停止</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">second</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2030</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>  <span class="c1"># 2030-01-01 18:30停止</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Run all tasks immediately (mainly for testing).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">schedule</span>


<span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working...&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">job1</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello...&#39;</span><span class="p">)</span>


<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">monday</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;12:40&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">()</span><span class="o">.</span><span class="n">tuesday</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;16:40&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">job1</span><span class="p">)</span>

<span class="n">schedule</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">run_all</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 任务间延迟3秒</span>
</code></pre></td></tr></table>
</div>
</div><p>Running in parallel: Using Python&rsquo;s built-in queue implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">schedule</span>

<span class="k">def</span> <span class="nf">job1</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m running on thread </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">job2</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m running on thread </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">job3</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I&#39;m running on thread </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">run_threaded</span><span class="p">(</span><span class="n">job_func</span><span class="p">):</span>
    <span class="n">job_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">job_func</span><span class="p">)</span>
    <span class="n">job_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job1</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job2</span><span class="p">)</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">run_threaded</span><span class="p">,</span> <span class="n">job3</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">schedule</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="implementing-timed-tasks-using-the-task-framework-apscheduler">Implementing timed tasks using the task framework APScheduler</h2>
<p><a href="https://github.com/agronholm/apscheduler">APScheduler</a>(advanced python scheduler) based on Quartz a Python timed task framework that implements all the features of Quartz , very easy to use . Provides date-based, fixed interval and crontab type tasks, and can persist tasks. Based on these features , we can easily implement a Python timed task system .</p>
<p>It has the following three features.</p>
<ul>
<li>Liunx Cron-like scheduler (optional start/end time)</li>
<li>Interval-based execution scheduling (periodic scheduling with optional start/end times)</li>
<li>One-time execution of tasks (run a task once at a set date/time)</li>
</ul>
<p>APScheduler has four components.</p>
<ul>
<li><strong>trigger</strong> contains the scheduling logic, and each job has its own trigger for deciding which job will run next. Triggers are completely stateless, except for their own initial configuration.</li>
<li><strong>Job store</strong> stores the scheduled jobs. The default job store simply stores the jobs in memory, while other job stores store the jobs in the database. A job&rsquo;s data speaks are serialized when saved in the persistent job store and deserialized when loaded. Schedulers cannot share the same job store.</li>
<li><strong>Executors</strong> handle the running of jobs, and they usually do so by submitting the formulated callable object in the job to a thread or incoming pool. When the job completes, the executor will notify the scheduler.
The * <strong>scheduler</strong> is the other component. You usually have only one scheduler in the application. Application developers usually do not deal with job stores, schedulers, and triggers directly; instead, the scheduler provides the appropriate interface to handle these. Configuring job stores and executors can be done in the scheduler, such as adding, modifying and removing jobs.　By configuring executor, jobstore, trigger, using a thread pool (ThreadPoolExecutor default 20) or process pool (ProcessPoolExecutor default 5) and running up to 3 (max_instances) task instances simultaneously by default, you can add, delete Change check and other scheduling control</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/a7ee83d2e3ff47558f62d0884ee54d42.png" alt=""></p>
<p>Example code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">apscheduler.schedulers.blocking</span> <span class="kn">import</span> <span class="n">BlockingScheduler</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="c1"># 输出时间</span>
<span class="k">def</span> <span class="nf">job</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&#34;</span><span class="p">))</span>


<span class="c1"># BlockingScheduler</span>
<span class="n">sched</span> <span class="o">=</span> <span class="n">BlockingScheduler</span><span class="p">()</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">my_job</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;my_job_id&#39;</span><span class="p">)</span>
<span class="n">sched</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="important-concepts-in-apscheduler">Important concepts in APScheduler</h3>
<h4 id="job">Job</h4>
<p>Job is the smallest execution unit of APScheduler. When creating a Job, specify the function to be executed, the parameters required in the function, and some information about the settings when the Job is executed.</p>
<p>Build description.</p>
<ul>
<li>id: Specify the unique ID of the job</li>
<li>name: Specify the name of the job.</li>
<li>trigger: trigger defined by apscheduler, used to determine the execution time of the Job, according to the set trigger rules, calculate the next execution time of this job, will be executed when satisfied</li>
<li>executor: executor defined by apscheduler, the name of the executor is set when the job is created, according to the string your name to the scheduler to get the executor to execute this job, and execute the function specified by the job</li>
<li>max_instances: the maximum number of instances to execute this job, when executor executes a job, it calculates the number of executions based on the id of the job, and determines whether it is executable based on the maximum number of instances set</li>
<li>next_run_time: the next execution time of the Job, you can specify a time [datetime] when creating the Job, if not, the default is to get the trigger time according to the trigger</li>
<li>misfire_grace_time: the delayed execution time of Job, for example, the scheduled execution time of Job is 21:00:00, but it is executed at 21:00:31 due to service restart or other reasons, if this key is set to 40, then the Job will continue to execute, otherwise the Job will be discarded</li>
<li>coalesce: whether the Job is merged or not, is a bool value. For example, the scheduler stops 20s after restarting, and the trigger of the job is set to 5s to execute once, so this job misses 4 execution times, if set to yes, it will be merged to one execution, otherwise it will be executed one by one</li>
<li>func: the function executed by Job</li>
<li>args: the position argument needed by the Job execution function</li>
<li>kwargs: keyword arguments needed by the Job execution function</li>
</ul>
<h4 id="trigger">Trigger</h4>
<p>Trigger bound to Job, in the scheduler scheduling filter Job, according to the rules of the trigger to calculate the trigger time of the Job, and then compared with the current time to determine whether this Job will be executed, in short, is based on the rules of the trigger to calculate the next execution time.</p>
<p>Currently, APScheduler supports the following triggers.</p>
<ul>
<li>DateTrigger with specified time</li>
<li>IntervalTrigger with specified interval time</li>
<li>CronTrigger like the Linux crontab.</li>
</ul>
<h5 id="trigger-parameters-date">Trigger parameters: date</h5>
<p>date timing, the job is executed only once.</p>
<ul>
<li>run_date (datetime|str) – the date/time to run the job at</li>
<li>timezone (datetime.tzinfo|str) – time zone for run_date if it doesn’t have one already</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">my_job</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">run_date</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">my_job</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">run_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="trigger-parameters-interval">Trigger parameters: interval</h5>
<p>interval interval scheduling</p>
<ul>
<li>weeks (int) - intervals of weeks</li>
<li>days (int) - intervals of several days</li>
<li>hours (int) - intervals of hours</li>
<li>minutes (int) - intervals of several minutes</li>
<li>seconds (int) - how many seconds between</li>
<li>start_date (datetime|str) - the start date</li>
<li>end_date (datetime|str) - the end date</li>
<li>timezone (datetime.tzinfo|str) - time zone</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job_function</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="trigger-parameters-cron">Trigger parameters: cron</h5>
<p>cron dispatch</p>
<ul>
<li>(int|str) means the parameter can be either int or str</li>
<li>(datetime | str) means that the argument can be either of type datetime or str</li>
<li>year (int|str) - 4-digit year - (indicates a four-digit year, such as 2008)</li>
<li>month (int|str) - month (1-12) - (indicates that the range of values is 1-12 months)</li>
<li>day (int|str) - day of the (1-31) - (indicates that the range of values is 1-31 days)</li>
<li>week (int|str) - ISO week (1-53) - (December 31, 2006 on the Gregorian calendar can be written as 2006-W52-7 (extended form) or 2006W527 (compact form))</li>
<li>day_of_week (int|str) - number or name of weekday (0-6 or mon,tue,wed,thu,fri,sat,sun) - (indicates the first day of the week, either in 0-6 or in its English abbreviations)</li>
<li>hour (int|str) - hour (0-23) - (indicates a range of values from 0-23 hours)</li>
<li>minute (int|str) - minute (0-59) - (indicates a range of 0-59 minutes)</li>
<li>second (int|str) - second (0-59) - (means the range is 0-59 seconds)</li>
<li>start_date (datetime|str) - earliest possible date/time to trigger on (inclusive) - (indicates start time)</li>
<li>end_date (datetime|str) - latest possible date/time to trigger on (inclusive) - (indicates the end time)</li>
<li>timezone (datetime.tzinfo|str) - time zone to use for the date/time calculations (defaults to scheduler timezone) - (indicates time zone fetch)</li>
</ul>
<p>Expressions available for CronTrigger.</p>
<table>
<thead>
<tr>
<th>Expressions</th>
<th>Parameter Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>All</td>
<td>Wildcard. Example: minutes=* i.e. trigger per minute</td>
</tr>
<tr>
<td>* / a</td>
<td>All</td>
<td>Execute every time a. Example: minutes=&quot;* / 3″ i.e. executed every 3 minutes</td>
</tr>
<tr>
<td>a – b</td>
<td>All</td>
<td>Triggered in the range of a - b. Example: minutes=&ldquo;2-5&rdquo;. i.e. executed once per minute from 2 to 5 minutes</td>
</tr>
<tr>
<td>a – b / c</td>
<td>All</td>
<td>a - b range, executed at intervals of time c.。</td>
</tr>
<tr>
<td>xth y</td>
<td>Day</td>
<td>The first few days of the week trigger. x is the first few, y is the day of the week</td>
</tr>
<tr>
<td>last x</td>
<td>Day</td>
<td>The day of the week of the last week in a month triggers</td>
</tr>
<tr>
<td>last</td>
<td>Day</td>
<td>Triggered on the last day of the month</td>
</tr>
<tr>
<td>x, y, z</td>
<td>All</td>
<td>Combined expressions, which can be combined to determine the value or the above expressions</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># 6-8,11-12月第三个周五 00:00, 01:00, 02:00, 03:00运行</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job_function</span><span class="p">,</span> <span class="s1">&#39;cron&#39;</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="s1">&#39;6-8,11-12&#39;</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="s1">&#39;3rd fri&#39;</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="s1">&#39;0-3&#39;</span><span class="p">)</span>
<span class="c1"># 每周一到周五运行 直到2024-05-30 00:00:00</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job_function</span><span class="p">,</span> <span class="s1">&#39;cron&#39;</span><span class="p">,</span> <span class="n">day_of_week</span><span class="o">=</span><span class="s1">&#39;mon-fri&#39;</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="s1">&#39;2024-05-30&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="executor">Executor</h4>
<p>The Executor is initialized in the scheduler, and the Executor can be added dynamically via the scheduler&rsquo;s add_executor. each executor is bound to an alias, which is used as a unique identifier to bind to the Job, and the actual execution will be based on the executor bound to the Job to find the actual The type of executor will be chosen according to the different scheduling, if you choose AsyncIO as the scheduling library, then choose AsyncIOExecutor, if you choose tornado as the scheduling library, choose TornadoExecutor, if you choose start process as the scheduling, choose ThreadPoolExecutor. The choice of Executor needs to be based on the actual scheduler to choose a different executor. The executors currently supported by APScheduler are</p>
<ul>
<li>executors.asyncio: synchronous io, blocking</li>
<li>executors.gevent: io multiplexing, non-blocking</li>
<li>executors.pool: threadPoolExecutor and processProcessPoolExecutor</li>
<li>executors.twisted: event-driven based</li>
</ul>
<h4 id="jobstore">Jobstore</h4>
<p>The Jobstore is initialized in the scheduler, and the Jobstore can also be added dynamically via the scheduler&rsquo;s add_jobstore. each jobstore is bound to an alias, and the scheduler finds the corresponding jobstore in the scheduler according to the specified jobstore when adding the Job. When adding a job, the scheduler finds the corresponding jobstore in the scheduler according to the specified jobstore, and adds the job to the jobstore. The jobstore determines how the job is stored, it is stored in memory by default (MemoryJobStore) and is not available after restart.</p>
<ul>
<li>jobstores.memory: memory</li>
<li>jobstores.mongodb: stored in mongodb</li>
<li>jobstores.redis: stored in redis</li>
<li>jobstores.rethinkdb: stored in rethinkdb</li>
<li>jobstores.sqlalchemy: support sqlalchemy databases such as mysql, sqlite, etc.</li>
<li>jobstores.zookeeper: zookeeper</li>
</ul>
<p>The different jobstores can be configured in the scheduler configuration (see Scheduler)</p>
<h4 id="event">Event</h4>
<p>Event is an event triggered by the APScheduler when certain operations are performed. Users can customize some functions to listen to these events and do some specific operations when certain Events are triggered. Common ones are: EVENT_JOB_ERROR, EVENT_JOB_MISSED, EVENT_JOB_MISSED.</p>
<p>Current EVENT defined by APScheduler.</p>
<ul>
<li>EVENT_SCHEDULER_STARTED</li>
<li>EVENT_SCHEDULER_START</li>
<li>EVENT_SCHEDULER_SHUTDOWN</li>
<li>EVENT_SCHEDULER_PAUSED</li>
<li>EVENT_SCHEDULER_RESUMED</li>
<li>EVENT_EXECUTOR_ADDED</li>
<li>EVENT_EXECUTOR_REMOVED</li>
<li>EVENT_JOBSTORE_ADDED</li>
<li>EVENT_JOBSTORE_REMOVED</li>
<li>EVENT_ALL_JOBS_REMOVED</li>
<li>EVENT_JOB_ADDED</li>
<li>EVENT_JOB_REMOVED</li>
<li>EVENT_JOB_MODIFIED</li>
<li>EVENT_JOB_EXECUTED</li>
<li>EVENT_JOB_ERROR</li>
<li>EVENT_JOB_MISSED</li>
<li>EVENT_JOB_SUBMITTED</li>
<li>EVENT_JOB_MAX_INSTANCES</li>
</ul>
<p>Listener represents the user-defined listening to some Event, for example, when the Job triggered the EVENT_JOB_MISSED event can do some other processing according to the needs.</p>
<h4 id="scheduler">Scheduler</h4>
<p>The Scheduler is the core of the APScheduler, through which all relevant components are defined. scheduler, once started, will start scheduling according to the configured tasks. In addition to waking up the scheduler based on the upcoming scheduling time generated by all the trigers that define the Job. Scheduling is also triggered when a change in Job information occurs.</p>
<p>APScheduler supports the following scheduler methods, the more common ones are BlockingScheduler and BackgroundScheduler</p>
<ul>
<li>BlockingScheduler: Applicable to the scheduler which is the only running process in the process, calling the start function will block the current thread and cannot return immediately.</li>
<li>BackgroundScheduler: Applicable to scheduler running in the background of the application, the main thread will not block after calling start.</li>
<li>AsyncIOScheduler: For applications that use the asyncio module.</li>
<li>GeventScheduler: For applications that use the gevent module.</li>
<li>TwistedScheduler: for applications that build Twisted.</li>
<li>QtScheduler: for building Qt applications.</li>
</ul>
<h3 id="workflow-of-scheduler">Workflow of Scheduler</h3>
<p>Scheduler add job process.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/b23eea03d6a342ad87a5e92534f91983.png" alt=""></p>
<p>Scheduler scheduling process.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/c5a5b80807be4d8a8344237782f53b12.png" alt=""></p>
<h2 id="implementing-timed-tasks-with-celery-a-distributed-messaging-system">Implementing Timed Tasks with Celery, a Distributed Messaging System</h2>
<p><a href="https://github.com/celery/celery">Celery</a> is a simple, flexible, and reliable distributed system for handling large numbers of messages while providing operations with the tools needed to maintain such a system, and also for task scheduling. Celery would not be a good choice if you just need a lightweight scheduling tool.</p>
<p>Celery is a powerful distributed task queue that allows tasks to be executed completely off the main application and even be assigned to run on other hosts. We usually use it to implement asynchronous tasks (async task) and timed tasks (crontab). Asynchronous tasks are time-consuming operations such as sending emails, or uploading files, image processing, etc. Timed tasks are tasks that need to be executed at a specific time.</p>
<p>It should be noted that celery itself does not have task storage capabilities, and tasks must be stored when scheduling them, so you need to use celery with some tools that have storage and access capabilities, such as message queues, Redis cache, database, etc. The official recommendation is the message queue RabbitMQ, and sometimes Redis is also a good choice.</p>
<p>Its architecture consists of the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/0ccaa3b4b0b6458fa1bbe491842c8ca6.png" alt=""></p>
<p>The Celery architecture, which uses a typical producer-consumer model, consists of the following main components.</p>
<ul>
<li>Celery Beat, the task scheduler. The Beat process reads the contents of the configuration file and periodically sends the tasks due for execution in the configuration to the task queue.</li>
<li>Producer: Tasks that need to be performed in the queue, usually queued by users, triggers or other operations, and then handed over to workers for processing. Those who call the API, function or decorator provided by Celery to generate tasks and give them to the task queue are task producers.</li>
<li>Broker, the message middleware, in this case refers to the task queue itself, Celery plays the role of producer and consumer, brokers are the place where producers and consumers store/get products (queue).</li>
<li>Celery Worker, the consumer that executes the task, takes the task from the queue and executes it. Usually, multiple consumers are run on multiple servers to improve execution efficiency.</li>
<li>Celery supports Redis, RabbitMQ, MongoDB, Django ORM, SQLAlchemy, etc. by default.</li>
</ul>
<p>In practice, when a user initiates a request from the web front-end, we only need to drop the task to be processed into the task queue broker, and the idle worker will process the task, and the result will be temporarily stored in the background database backend. We can start multiple worker processes on one machine or multiple machines at the same time to achieve distributed parallel processing of tasks.</p>
<h2 id="implementing-timed-tasks-with-the-data-flow-tool-apache-airflow">Implementing Timed Tasks with the Data Flow Tool Apache Airflow</h2>
<p><a href="https://airflow.apache.org/">Apache Airflow</a> is an Airbnb open source data flow tool , is currently an Apache incubation project . In a very flexible way to support the ETL process of data , but also supports a very large number of plug-ins to complete functions such as HDFS monitoring , email notifications , etc. Airflow supports both stand-alone and distributed mode , support Master-Slave mode , support Mesos and other resource scheduling , have very good scalability . It is adopted by a large number of companies.</p>
<p>Airflow is developed in Python, and it uses DAGs (Directed Acyclic Graph) to express the tasks to be executed in a workflow, and the relationships and dependencies between tasks. For example, in the following workflow, the execution of task T1 is completed before T2 and T3 can start executing, and T4 can start executing after both T2 and T3 are executed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/bc2411fe718448c88cd085c07da9bda9.png" alt=""></p>
<p>Airflow provides various Operator implementations that can perform various tasks implementing.</p>
<ul>
<li>BashOperator - Executes bash commands or scripts.</li>
<li>SSHOperator - Executes remote bash commands or scripts (same principle as paramiko module).</li>
<li>PythonOperator - Executes Python functions.</li>
<li>EmailOperator - Sends an email.</li>
<li>HTTPOperator - Sends an HTTP request.</li>
<li>MySqlOperator, SqliteOperator, PostgresOperator, MsSqlOperator, OracleOperator, JdbcOperator, etc., to perform SQL tasks.</li>
<li>DockerOperator, HiveOperator, S3FileTransferOperator, PrestoToMysqlOperator, SlackOperator&hellip;</li>
</ul>
<p>In addition to the above Operators it is also easy to customize Operators to meet individual task requirements.</p>
<p>In some cases, we need to execute different tasks depending on the result of the execution, so that the workflow will branch. For example:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/c052a708e4524e7bbc2f8d3319d75621.png" alt=""></p>
<p>This requirement can be implemented using BranchPythonOperator.</p>
<h3 id="background-of-the-creation-of-airflow">Background of the creation of Airflow</h3>
<p>Often, in a large system such as an operations and maintenance system, a data analysis system, or a testing system, we have a variety of dependency requirements. These include, but are not limited to.</p>
<ul>
<li>Time dependency: The task needs to wait for a certain point in time to trigger.</li>
<li>External System Dependencies: Tasks depend on external systems that require an interface call to access them.</li>
<li>Inter-task dependencies: Task A needs to be started after Task B is completed, and the two tasks will affect each other.</li>
<li>Resource Environment Dependency: The task consumes a lot of resources or can only be executed on a specific machine.</li>
</ul>
<p>Airflow&rsquo;s core concept of DAG (Directed Acyclic Graph) - to represent workflows.</p>
<ul>
<li>Airflow is a WMS, i.e., it treats tasks and their dependencies as code, regulates task execution according to those plans, and distributes the tasks to be executed among the actual work processes.</li>
<li>Airflow provides an excellent UI for displaying the status of currently active tasks and past tasks, and allows users to manually manage the execution and status of tasks.</li>
<li>Workflows in Airflow are collections of tasks with directional dependencies.</li>
<li>Each node in the DAG is a task, and the edges in the DAG represent dependencies between tasks (forced to be directed and acyclic, so there are no circular dependencies, leading to infinite execution loops).</li>
</ul>
<h3 id="airflow-core-concepts">Airflow Core Concepts</h3>
<ul>
<li>DAGs: Directed Acyclic Graph, which organizes all tasks that need to be run according to their dependencies, and describes the order of execution of all tasks.</li>
<li>Operators: can be simply understood as a class, describing what a task in the DAG is supposed to do. Among them, airflow has many built-in operators, such as BashOperator to execute a bash command, PythonOperator to call arbitrary Python functions, EmailOperator to send emails, HTTPOperator to send HTTP requests, and SqlOperator to execute SQL requests. SqlOperator is used to execute SQL commands, etc. Also, the user can customize the Operator, which provides great convenience to the user.</li>
<li>Tasks: A Task is an instance of an Operator, which is a node in DAGs.</li>
<li>Task Instance: The task instance has its own status in the web interface, including &ldquo;running&rdquo;, &ldquo;success&rdquo;, You can see the status of the task instance in the web interface, including &ldquo;running&rdquo;, &ldquo;success&rdquo;, &ldquo;failed&rdquo;, &ldquo;skipped&rdquo;, &ldquo;up for retry&rdquo;, etc.</li>
<li>Task Relationships: There can be dependencies between different Tasks in DAGs, such as Task1 &raquo; Task2, indicating that Task2 is dependent on Task2.
By combining DAGs and Operators, users can create various complex workflows.</li>
</ul>
<h3 id="airflows-architecture">Airflow&rsquo;s architecture</h3>
<p>In a scalable production environment, Airflow contains the following components.</p>
<ul>
<li><strong>Metadatabase</strong> : This database stores information about the status of tasks.</li>
<li><strong>Scheduler</strong> : The Scheduler is a process that uses DAG definitions combined with the status of tasks in the metadata to determine which tasks need to be executed and the priority of task execution. Schedulers are typically run as services.</li>
<li><strong>Executor</strong> : An Executor is a message queue process that is bound to the scheduler and is used to determine the work process that actually executes each task schedule. There are different types of executors, each of which uses a class that specifies the work process to execute the task. For example, LocalExecutor uses a parallel process running on the same machine as the scheduler process to execute the task. Other executors like CeleryExecutor use work processes that exist in a separate cluster of work machines to execute tasks.</li>
<li><strong>Workers</strong> : These are the processes that actually perform the task logic, as determined by the executor being used.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/a08023d2c4244aeab569ff273a7f032f.png" alt=""></p>
<p>The specific implementation of the worker is specified by the executor in the configuration file. airflow supports multiple executors:</p>
<ul>
<li>SequentialExecutor: Single-process sequential execution, usually only used for testing</li>
<li>LocalExecutor: local multi-process execution</li>
<li>CeleryExecutor: Distributed task scheduling using Celery</li>
<li>DaskExecutor: Distributed task scheduling using <a href="https://distributed.dask.org/en/latest/">Dask</a></li>
<li>KubernetesExecutor: new in 1.10.0, creates temporary POD to execute each task</li>
</ul>
<p>Production environments generally use CeleryExecutor and KubernetesExecutor.</p>
<p>The architecture of using CeleryExecutor is shown in the figure:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/f19fdccbc2df4570b2a46f854d2673eb.png" alt=""></p>
<p>The architecture using KubernetesExecutor is shown in Figure:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/23/6b50b64e787d4d1398e55aae37a07d01.png" alt=""></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/pandas-sqlalchemy/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Pandas&#43;SQLAlchemy interaction with database</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/rate-limit/">
            <span class="next-text nav-default">Service High Availability Flow Limiting</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
