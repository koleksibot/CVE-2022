<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Grafana Loki Concise Tutorial - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Loki, the latest open source project from the Grafana Labs team, is a horizontally scalable, high-availability, multi-tenant log aggregation system. It is designed to be very cost effective and easy to use because it does not index log content, but rather configures a set of tags for each log stream. Project inspired by Prometheus , the official description is: Like Prometheus, but for logs , similar to the Prometheus logging" /><meta name="keywords" content="kubernetes, grafana, loki" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/grafana-loki-usage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Grafana Loki Concise Tutorial" />
<meta property="og:description" content="Loki, the latest open source project from the Grafana Labs team, is a horizontally scalable, high-availability, multi-tenant log aggregation system. It is designed to be very cost effective and easy to use because it does not index log content, but rather configures a set of tags for each log stream. Project inspired by Prometheus , the official description is: Like Prometheus, but for logs , similar to the Prometheus logging" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/grafana-loki-usage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-24T12:43:58+08:00" />
<meta property="article:modified_time" content="2021-10-24T12:43:58+08:00" />

<meta itemprop="name" content="Grafana Loki Concise Tutorial">
<meta itemprop="description" content="Loki, the latest open source project from the Grafana Labs team, is a horizontally scalable, high-availability, multi-tenant log aggregation system. It is designed to be very cost effective and easy to use because it does not index log content, but rather configures a set of tags for each log stream. Project inspired by Prometheus , the official description is: Like Prometheus, but for logs , similar to the Prometheus logging"><meta itemprop="datePublished" content="2021-10-24T12:43:58+08:00" />
<meta itemprop="dateModified" content="2021-10-24T12:43:58+08:00" />
<meta itemprop="wordCount" content="6248">
<meta itemprop="keywords" content="kubernetes,grafana,loki," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Grafana Loki Concise Tutorial"/>
<meta name="twitter:description" content="Loki, the latest open source project from the Grafana Labs team, is a horizontally scalable, high-availability, multi-tenant log aggregation system. It is designed to be very cost effective and easy to use because it does not index log content, but rather configures a set of tags for each log stream. Project inspired by Prometheus , the official description is: Like Prometheus, but for logs , similar to the Prometheus logging"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Grafana Loki Concise Tutorial</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-24 12:43:58 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 6248 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#overview">Overview</a>
          <ul>
            <li><a href="#multi-tenant">Multi-tenant</a></li>
            <li><a href="#operation-mode">Operation Mode</a></li>
            <li><a href="#components">Components</a></li>
            <li><a href="#compare-to-other-logging-systems">Compare to other logging systems</a></li>
          </ul>
        </li>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#installing-loki-with-helm">Installing Loki with Helm</a></li>
            <li><a href="#installing-loki-with-docker">Installing Loki with Docker</a></li>
            <li><a href="#local-installation-of-loki">Local installation of Loki</a></li>
          </ul>
        </li>
        <li><a href="#getting-started-with-loki">Getting Started with Loki</a>
          <ul>
            <li><a href="#loki-configuration-in-grafana">Loki configuration in Grafana</a></li>
            <li><a href="#querying-loki-with-logcli">Querying Loki with LogCLI</a></li>
            <li><a href="#label">Label</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Loki, the latest open source project from the Grafana Labs team, is a horizontally scalable, high-availability, multi-tenant log aggregation system. It is designed to be very cost effective and easy to use because it does not index log content, but rather configures a set of tags for each log stream. Project inspired by Prometheus , the official description is: <code>Like Prometheus, but for logs</code> , similar to the Prometheus logging system.</p>
<h2 id="overview">Overview</h2>
<p>Unlike other logging systems, Loki only indexes your log metadata tags (like Prometheus' tags), and does not index the raw log data in full text. The log data itself is then compressed and stored as chunks (blocks) on an object store (like S3 or GCS) or even a local filesystem. A small index and highly compressed chunks can greatly simplify operations and reduce the cost of using Loki.</p>
<p>A more detailed version of this document can be found in the chapter introduction of <a href="https://github.com/grafana/loki/blob/master/docs/architecture.md">Loki Architecture</a>.</p>
<h3 id="multi-tenant">Multi-tenant</h3>
<p>Loki supports a multi-tenant model where the data is completely separated between tenants. Multi-tenancy is implemented with a tenant ID (a string generated with numeric letters). When multi-tenancy mode is disabled, a <strong><code>false</code></strong> tenant ID is generated internally for all requests.</p>
<h3 id="operation-mode">Operation Mode</h3>
<p>Loki can be run locally on a small scale or horizontally, and Loki comes with a single process mode that allows you to run all the microservices you need in a single process. Single process mode is ideal for testing Loki or for small runs. For horizontal scaling, Loki&rsquo;s microservices can be broken into separate processes, allowing them to scale independently.</p>
<h3 id="components">Components</h3>
<h4 id="distributor">Distributor</h4>
<p>The dispatcher service is responsible for processing logs written by <a href="https://github.com/grafana/loki/blob/master/docs/clients/README.md">client</a>. Essentially it is the <code>first stop</code> in the log data writing path. Once the distributor receives the log data, it splits them into batches and sends them to multiple collectors in parallel.</p>
<p>The distributor communicates through <a href="https://grpc.io/">gPRC</a> and <a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#ingester">collector</a>. They are stateless, so we can scale them up and down according to the actual needs.</p>
<p><strong>Hashing</strong></p>
<p>The allocator uses a combination of a consistent hash and a configurable replication factor to determine which collector services should receive log data.</p>
<p>The hash is generated based on log tags and tenant IDs.</p>
<p>A hash ring stored in <a href="https://www.consul.io/">Consul</a> is used to implement the consistency hash; all collectors register their own set of Token into the hash ring. The allocator then finds the Token that best matches the hash value of the log and sends the data to the holder of that Token.</p>
<p><strong>Consistency</strong></p>
<p>Since all allocators share the same hash ring, a write request can be sent to any allocator.</p>
<p>To ensure consistency in query results, Loki uses <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo way</a> quorum consistency on reads and writes. This means that the allocator will wait for at least half of the collectors to respond before sending samples to the user and then responding to the user.</p>
<h4 id="ingester">Ingester</h4>
<p>The collector service is responsible for writing log data to the backend of the long-term storage (DynamoDB, S3, Cassandra, etc.).</p>
<p>The collector verifies that the collected logs are not out of order. When the collector receives a log line that is not in the expected order, the log line is rejected and an error is returned to the user. For more information about this, see the <a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#timestamp-ordering">Timestamp Ordering</a> section.</p>
<p>The collector verifies that the received log lines are received in increasing order of timestamp (i.e., each log has a later timestamp than the previous log). When the collector receives logs not in this order, the log lines are rejected and an error is returned.</p>
<p>Each unique tag set of data is constructed into <code>chunks</code> in memory, and then they are stored in the back-end storage.</p>
<p>If a chunks process crashes or suddenly hangs, all data that has not been flushed to storage will be lost. loki is typically configured with multiple copies (typically 3) to reduce this risk.</p>
<p><strong>Timestamp sorting</strong></p>
<p>Generally all log rows pushed to Loki must have a newer timestamp than the previously received row. However there may be cases where multiple log lines have the same nanosecond-level timestamp, which can be handled as follows.</p>
<ul>
<li>If the incoming line exactly matches the previously received line (both timestamp and log text match), the incoming line is considered an exact duplicate and will be ignored.</li>
<li>If the timestamp of the incoming line is the same as the timestamp of the previous line, but the log text is not the same, then the line log will be received. This means that it is possible to have two different log lines for the same timestamp.</li>
</ul>
<p><strong>Handoff (handoff)</strong></p>
<p>By default, when a collector shuts down and a view leaves the hash ring, it will wait to see if a new collector view comes in before it flushes and tries to initiate a handoff. The handoff will transfer all Tokens and in-memory chunks owned by the leaving collector to the new collector.</p>
<p>This process is done to avoid flushing all chunks at shutdown, which is a slower and more time-consuming process.</p>
<p><strong>File system support</strong></p>
<p>The collector supports writing to the file system via BoltDB, but this only works in single process mode, because <a href="https://github.com/grafana/loki/blob/master/docs/overview/README.md#querier">the querier</a> needs access to the same backend storage. Also BoltDB only allows one process to lock the DB for a given amount of time.</p>
<h4 id="querier">Querier</h4>
<p>The Queryer service is responsible for processing the <a href="https://github.com/grafana/loki/blob/master/docs/logql.md">LogQL</a> query statement to evaluate the log data stored in the long-term storage.</p>
<p>It first tries to query all collectors for in-memory data before returning to the back-end storage to load the data.</p>
<h4 id="front-end-queries">Front-end queries</h4>
<p>This service is an optional component that comes in front of a set of queriers to take care of scheduling requests fairly among them, parallelizing them as much as possible and caching the requests.</p>
<h4 id="chunk">Chunk</h4>
<p>The block store is Loki&rsquo;s long-term data store designed to support interactive queries and continuous writes without background maintenance tasks. It consists of the following components.</p>
<ul>
<li><strong>Block Index</strong> which can be supported by DynamoDB, Bigtable or Cassandra.</li>
<li><strong>KV storage</strong> for the block data itself, which can be DynamoDB, Bigtable, Cassandra, or on top of that, an object store such as S3.</li>
</ul>
<blockquote>
<p>Unlike the other core components of Loki, block storage is not a separate service, task, or process, but a library embedded in the collectors and queriers that need access to Loki data.</p>
</blockquote>
<p>The block store relies on a unified &ldquo;NoSQL&rdquo; storage (DynamoDB, Bigtable, and Cassandra) interface that can be used to support block store indexes. The interface assumes that an index is a collection of the following keys.</p>
<ul>
<li><strong>Hash KEY</strong> - This is required for all reads and writes.</li>
<li><strong>RANGE KEY</strong> - This is required for writes and can be omitted for reads, and can be queried by prefix or range.</li>
</ul>
<p>The interfaces in these databases supported above work a little differently.</p>
<ul>
<li>DynamoDB supports range and hash KEYs. so index entries are modeled directly as DynamoDB data, hash KEYs are distributed KEYs, and ranges are range KEYs.</li>
<li>For Bigtable and Cassandra, index entries are modeled as individual column values. A hash KEY becomes a row KEY and a range KEY becomes a column KEY.</li>
</ul>
<p>Some patterns are used to map the set of matchers and tags used for reads and writes to block storage to the appropriate operations for indexes. New patterns will be added as Loki evolves, mainly to better balance and improve query performance.</p>
<h3 id="compare-to-other-logging-systems">Compare to other logging systems</h3>
<p>EFK (Elasticsearch, Fluentd, Kibana) is used to fetch, visualize and query logs from various sources.</p>
<p>The data in Elasticsearch is stored on disk as unstructured JSON objects. The keys of each object and the contents of each key are indexed. The JSON objects can then be used to define queries (called Query DSL) or to query data through the Lucene query language.</p>
<p>In contrast, Loki in single binary mode can store data on disk, but in horizontally scalable mode, data storage needs to be in a cloud storage system such as S3, GCS, or Cassandra. logs are stored as plain text and tagged with a set of tagged names and values, where only the tags are indexed. This tradeoff makes it cheaper to operate than full indexing. logs in Loki are queried using LogQL. Due to this design trade-off, LogQL queries that filter based on content (i.e., text within log lines) require loading all blocks within the search window that match the tags defined in the query.</p>
<p>Fluentd is typically used to collect logs and forward them to Elasticsearch. fluentd is known as a data collector, which can collect logs from many sources, process them, and then forward them to one or more targets.</p>
<p>Promtail, by contrast, is tailored for Loki. Its primary mode of operation is to discover log files stored on disk and forward them to Loki associated with a set of tags. Promtail can do service discovery for Kubernetes Pods running on the same node, act as a Docker log driver, read logs from a specified folder, and fetch systemd logs continuously.</p>
<p>Loki represents logs by a set of tags in a similar way to how Prometheus represents metrics. When deployed in an environment with Prometheus, the logs from Protail typically have the same tags as your application metrics because the same service discovery mechanism is used. Having the same level of logs and metrics allows users to seamlessly switch between metrics and logs to help with root cause analysis.</p>
<p>Kibana is used to visualize and search Elasticsearch data and is very powerful when doing analysis on this data. kibana provides many visualization tools to do data analysis, such as maps, machine learning for anomaly detection, and relationship graphs. Alerts can also be configured to notify users when something unexpected happens.</p>
<p>In contrast, Grafana is specifically tailored to time series data from data sources such as Prometheus and Loki. Dashboards can be set up to visualize metrics (with logging support coming soon), and data can also be queried on an ad hoc basis using exploration views. Like Kibana, Grafana also supports alerts based on your metrics.</p>
<h2 id="installation">Installation</h2>
<p>The official recommendation is to use Tanka for installation, which is a re-implemented version of Ksonnect for production deployments within Grafana, but Tanka is currently not used much and few people are familiar with it, so we won&rsquo;t introduce this way here. The following 3 methods are mainly introduced.</p>
<h3 id="installing-loki-with-helm">Installing Loki with Helm</h3>
<h4 id="prerequisites">Prerequisites</h4>
<p>First you need to make sure that you have deployed a Kubernetes cluster and installed and configured the Helm client, then add <a href="https://github.com/grafana/loki/tree/master/production/helm/loki">Loki&rsquo;s chart repository</a>:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm repo add loki <span class="o">[</span>https://grafana.github.io/loki/charts<span class="o">](</span>https://grafana.github.io/loki/charts<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The chart repository can be updated using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm repo update
</code></pre></td></tr></table>
</div>
</div><h4 id="deploy-loki">Deploy Loki</h4>
<p>Deploy with default configuration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm upgrade --install loki loki/loki-stack
</code></pre></td></tr></table>
</div>
</div><p>Specify namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm upgrade --install loki --namespace<span class="o">=</span>loki loki/loki
</code></pre></td></tr></table>
</div>
</div><p>Specify configuration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm upgrade --install loki loki/loki --set <span class="s2">&#34;key1=val1,key2=val2,...&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Deploy Loki tool stack (Loki, Promtail, Grafana, Prometheus)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm upgrade --install loki loki/loki-stack --set grafana.enabled<span class="o">=</span>true,prometheus.enabled<span class="o">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span class="o">=</span>false,prometheus.server.persistentVolume.enabled<span class="o">=</span><span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><p>Deploy Loki tool stack (Loki, Promtail, Grafana, Prometheus)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm upgrade --install loki loki/loki-stack <span class="se">\
</span><span class="se"></span>    --set fluent-bit.enabled<span class="o">=</span>true,promtail.enabled<span class="o">=</span>false,grafana.enabled<span class="o">=</span>true,prometheus.enabled<span class="o">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span class="o">=</span>false,prometheus.server.persistentVolume.enabled<span class="o">=</span><span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><p>Deploying Grafana</p>
<p>To install Grafana to a Kubernetes cluster using Helm, you can use the command shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm install stable/grafana -n loki-grafana
</code></pre></td></tr></table>
</div>
</div><p>To obtain the Grafana administrator password, you can use the command shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get secret --namespace &lt;YOUR-NAMESPACE&gt; loki-grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</code></pre></td></tr></table>
</div>
</div><p>To access the Grafana UI page, you can use the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl port-forward --namespace &lt;YOUR-NAMESPACE&gt; service/loki-grafana 3000:80
</code></pre></td></tr></table>
</div>
</div><p>Then open <code>http://localhost:3000</code> in your browser and log in with admin and the password output above. Then <a href="https://github.com/grafana/loki/blob/master/docs/getting-started/grafana.md">follow the prompts to add the Loki data source</a> with the Loki address <code>http://loki:3100</code>.</p>
<p><strong>Accessing Loki using HTTPS Ingress</strong></p>
<p>If Loki and Promtail are deployed on different clusters, you can add an Ingress object in front of Loki, which can be accessed via HTTPS by adding a certificate and enabling Basic Auth authentication on the Ingress for security purposes.</p>
<p>In Promtail, set the following values to use HTTPS and Basic Auth authentication for communication.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">loki</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceScheme</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">user</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">pass</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>An example of Ingress' Helm template is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.ingress.class }}</span><span class="w">
</span><span class="w">    </span><span class="nt">ingress.kubernetes.io/auth-type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;basic&#34;</span><span class="nt">ingress.kubernetes.io/auth-secret</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.ingress.basic.secret }}</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">loki</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.ingress.host }}</span><span class="w">
</span><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">loki</span><span class="w">
</span><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">3100</span><span class="w">
</span><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">secretName</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.ingress.cert }}</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Values.ingress.host }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="installing-loki-with-docker">Installing Loki with Docker</h3>
<p>We can use Docker or Docker Compose to install Loki for evaluation, testing or development of Lok, but for production environments we recommend using Tanka or Helm method.</p>
<h4 id="prerequisites-1">Prerequisites</h4>
<ul>
<li><a href="https://docs.docker.com/install">Docker</a></li>
<li><a href="https://docs.docker.com/compose/install">Docker Compose</a> (optional, installation is only required if you use the Docker Compose method)</li>
</ul>
<h4 id="installing-with-docker">Installing with Docker</h4>
<p>Installation with Docker</p>
<p><strong>Linux</strong></p>
<p>After execution, the loki-config.yaml and promtail-config.yaml configuration files will be downloaded to the directory we are using, and the Docker container will use these configuration files to run Loki and Promtail.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/cmd/loki/loki-local-config.yaml -O loki-config.yaml
$ docker run -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/mnt/config -p 3100:3100 grafana/loki:1.5.0 -config.file<span class="o">=</span>/mnt/config/loki-config.yaml
$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/cmd/promtail/promtail-docker-config.yaml -O promtail-config.yaml
$ docker run -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/mnt/config -v /var/log:/var/log grafana/promtail:1.5.0 -config.file<span class="o">=</span>/mnt/config/promtail-config.yaml
</code></pre></td></tr></table>
</div>
</div><h4 id="installing-with-docker-compose">Installing with Docker Compose</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ wget https://raw.githubusercontent.com/grafana/loki/v1.5.0/production/docker-compose.yaml -O docker-compose.yaml
$ docker-compose -f docker-compose.yaml up
</code></pre></td></tr></table>
</div>
</div><h3 id="local-installation-of-loki">Local installation of Loki</h3>
<h4 id="binary-files">Binary files</h4>
<p>Each release includes binaries for Loki, which can be found on GitHub&rsquo;s <a href="https://github.com/grafana/loki/releases">Release page</a>.</p>
<h4 id="opensuse-linux-installer">openSUSE Linux Installer</h4>
<p>The community provides Loki packages for openSUSE Linux, which can be installed using the following.</p>
<ul>
<li>Add the repository <a href="https://download.opensuse.org/repositories/security:/logging/"><code>https://download.opensuse.org/repositories/security:/logging/</code></a> to the system. For example, if you are using Leap 15.1, execute the command <code>sudo zypper ar</code> <a href="https://download.opensuse.org/repositories/security:/logging/openSUSE_Leap_15.1/security:logging.repo">https://download.opensuse.org/repositories/security:/logging/openSUSE_Leap_15.1/security:logging.repo</a> ; <code>sudo zypper ref</code></li>
<li>Use the command <code>zypper in loki</code> to install the Loki package</li>
<li>Start the Loki and Promtail services.
<ul>
<li><code>systemd start promtail &amp;&amp; systemd enable promtail</code></li>
<li><code>systemd start loki &amp;&amp; systemd enable loki</code></li>
</ul>
</li>
<li>Modify the configuration files as required: <code>/etc/loki/promtail.yaml</code> and <code>/etc/loki/loki.yaml</code>.</li>
</ul>
<h4 id="manual-build">Manual build</h4>
<p><strong>Prerequisite</strong></p>
<ul>
<li>Go version 1.13+</li>
<li>Make</li>
<li>Docker (for updating protobuf files and yacc files)</li>
</ul>
<p>** Build**</p>
<p>Clone Loki code to <code>$GOPATH/src/github.com/grafana/loki</code> path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git clone <span class="o">[</span>https://github.com/grafana/loki<span class="o">](</span>https://github.com/grafana/loki<span class="o">)</span> <span class="nv">$GOPATH</span>/src/github.com/grafana/loki
</code></pre></td></tr></table>
</div>
</div><p>Then switch to the code directory and execute the <code>make loki</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/grafana/loki
$ make loki

<span class="c1"># ./cmd/loki/loki 目录下面将会生成最终的二进制文件。</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="getting-started-with-loki">Getting Started with Loki</h2>
<h3 id="loki-configuration-in-grafana">Loki configuration in Grafana</h3>
<p>Grafana has built-in support for Loki in versions 6.0 and above. It is recommended that you use 6.3 or later to have access to the new LogQL features.</p>
<ul>
<li>Log in to your Grafana instance. If this is the first time you are running Grafana, the username and password default to <code>admin</code>.</li>
<li>In Grafana, go to <code>Configuration &gt; Data Sources</code> using the icon on the left sidebar.</li>
<li>Click the <code>+ Add data source</code> button.</li>
<li>Select Loki from the list.</li>
<li>The Http URL field is the address of your Loki server, for example, it might be <a href="http://localhost:3100/">http://localhost:3100</a> when running locally or when running Docker with port mapping. When running with docker-compose or Kubernetes, the address is likely to be <a href="https://loki:3100/">https://loki:3100</a>.</li>
<li>To view the logs, click ``Explore`'' on the sidebar, select Loki Data Source in the top left drop-down menu, and then use the Logs tab button to filter the log stream.</li>
</ul>
<h3 id="querying-loki-with-logcli">Querying Loki with LogCLI</h3>
<p>If you prefer a command line interface, <code>LogCLI</code> allows users to use LogQL queries against the Loki server.</p>
<h4 id="installation-1">Installation</h4>
<p><strong>Binary (recommended)</strong></p>
<p>The release package downloaded from the <a href="https://github.com/grafana/loki/releases">Release page</a> contains the logcli binaries.</p>
<p><strong>Source code installation</strong></p>
<p>You can also use golang to compile the source code directly, using the <code>go get</code> command as shown below to get <code>logcli</code> and the binaries will appear in the <code>$GOPATH/bin</code> directory under.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ go get github.com/grafana/loki/cmd/logcli
</code></pre></td></tr></table>
</div>
</div><h4 id="usage-examples">Usage examples</h4>
<p>Assuming you are currently using Grafana Cloud, you need to set the following environment variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">export</span> <span class="nv">LOKI_ADDR</span><span class="o">=</span>https://logs-us-west1.grafana.net
$ <span class="nb">export</span> <span class="nv">LOKI_USERNAME</span><span class="o">=</span>&lt;username&gt;
$ <span class="nb">export</span> <span class="nv">LOKI_PASSWORD</span><span class="o">=</span>&lt;password&gt;
</code></pre></td></tr></table>
</div>
</div><p>If you are using Grafana locally, you can point the LogCLI directly to a local instance without a username and password at</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">export</span> <span class="nv">LOKI_ADDR</span><span class="o">=</span>http://localhost:3100
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: If you add a proxy server in front of Loki and configure authentication, you still need to configure the corresponding <code>LOKI_USERNAME</code> and <code>LOKI_PASSWORD</code> data.</p>
</blockquote>
<p>Once configured, you can use some of the <code>logcli</code> commands as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ logcli labels job
https://logs-dev-ops-tools1.grafana.net/api/prom/label/job/values
cortex-ops/consul
cortex-ops/cortex-gw
...

$ logcli query <span class="s1">&#39;{job=&#34;cortex-ops/consul&#34;}&#39;</span>
https://logs-dev-ops-tools1.grafana.net/api/prom/query?query<span class="o">=</span>%7Bjob%3D%22cortex-ops%2Fconsul%22%7D<span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span>30<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1529928228<span class="p">&amp;</span><span class="nv">end</span><span class="o">=</span>1529931828<span class="p">&amp;</span><span class="nv">direction</span><span class="o">=</span>backward<span class="p">&amp;</span><span class="nv">regexp</span><span class="o">=</span>
Common labels: <span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;cortex-ops/consul&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;cortex-ops&#34;</span><span class="o">}</span>
2018-06-25T12:52:09Z <span class="o">{</span><span class="nv">instance</span><span class="o">=</span><span class="s2">&#34;consul-8576459955-pl75w&#34;</span><span class="o">}</span> 2018/06/25 12:52:09 <span class="o">[</span>INFO<span class="o">]</span> raft: Snapshot to <span class="m">475409</span> <span class="nb">complete</span>
2018-06-25T12:52:09Z <span class="o">{</span><span class="nv">instance</span><span class="o">=</span><span class="s2">&#34;consul-8576459955-pl75w&#34;</span><span class="o">}</span> 2018/06/25 12:52:09 <span class="o">[</span>INFO<span class="o">]</span> raft: Compacting logs from <span class="m">456973</span> to <span class="m">465169</span>
...

$ logcli series -q --match<span class="o">=</span><span class="s1">&#39;{namespace=&#34;loki&#34;,container_name=&#34;loki&#34;}&#39;</span>
<span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&#34;loki&#34;</span>, <span class="nv">container_name</span><span class="o">=</span><span class="s2">&#34;loki&#34;</span>, <span class="nv">controller_revision_hash</span><span class="o">=</span><span class="s2">&#34;loki-57c9df47f4&#34;</span>, <span class="nv">filename</span><span class="o">=</span><span class="s2">&#34;/var/log/pods/loki_loki-0_8ed03ded-bacb-4b13-a6fe-53a445a15887/loki/0.log&#34;</span>, <span class="nv">instance</span><span class="o">=</span><span class="s2">&#34;loki-0&#34;</span>, <span class="nv">job</span><span class="o">=</span><span class="s2">&#34;loki/loki&#34;</span>, <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;loki&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;loki&#34;</span>, <span class="nv">release</span><span class="o">=</span><span class="s2">&#34;loki&#34;</span>, <span class="nv">statefulset_kubernetes_io_pod_name</span><span class="o">=</span><span class="s2">&#34;loki-0&#34;</span>, <span class="nv">stream</span><span class="o">=</span><span class="s2">&#34;stderr&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Batch Search</strong></p>
<p>Starting with Loki 1.6.0, logcli sends log queries to Loki in batches.</p>
<p>If you set the query&rsquo;s <code>-limit</code> parameter (default is 30) to a larger number, say 10000, then logcli will automatically send this request to Loki in batches, with the default batch size being 1000.</p>
<p>Loki has a server-side limit on the maximum number of rows returned in a query (default is 5000). Batch sending allows you to issue requests larger than the server-side limit, as long as the <code>-batch</code> size is smaller than the server limit.</p>
<p>Note that query metadata is printed on stderr for each batch, and this can be stopped by setting the <code>--quiet</code> parameter.</p>
<blockquote>
<p>For the configured values will take effect from low to high based on environment variables and command line flags.</p>
</blockquote>
<h4 id="command-details">Command Details</h4>
<p>Detailed information on the use of the <code>logcli</code> command line tool is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ logcli <span class="nb">help</span>
usage: logcli <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> &lt;command&gt; <span class="o">[</span>&lt;args&gt; ...<span class="o">]</span>

A command-line <span class="k">for</span> loki.

Flags:
      --help             Show context-sensitive <span class="nb">help</span> <span class="o">(</span>also try --help-long and --help-man<span class="o">)</span>.
      --version          Show application version.
  -q, --quiet            Suppress query metadata.
      --stats            Show query statistics.
  -o, --output<span class="o">=</span>default   Specify output mode <span class="o">[</span>default, raw, jsonl<span class="o">]</span>. raw suppresses log labels and timestamp.
  -z, --timezone<span class="o">=</span>Local   Specify the timezone to use when formatting output timestamps <span class="o">[</span>Local, UTC<span class="o">]</span>.
      --cpuprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a CPU profile.
      --memprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a memory profile.
      --addr<span class="o">=</span><span class="s2">&#34;http://localhost:3100&#34;</span>
                         Server address. Can also be <span class="nb">set</span> using LOKI_ADDR env var.
      --username<span class="o">=</span><span class="s2">&#34;&#34;</span>      Username <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_USERNAME env var.
      --password<span class="o">=</span><span class="s2">&#34;&#34;</span>      Password <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_PASSWORD env var.
      --ca-cert<span class="o">=</span><span class="s2">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span class="nb">set</span> using LOKI_CA_CERT_PATH env var.
      --tls-skip-verify  Server certificate TLS skip verify.
      --cert<span class="o">=</span><span class="s2">&#34;&#34;</span>          Path to the client certificate. Can also be <span class="nb">set</span> using LOKI_CLIENT_CERT_PATH env var.
      --key<span class="o">=</span><span class="s2">&#34;&#34;</span>           Path to the client certificate key. Can also be <span class="nb">set</span> using LOKI_CLIENT_KEY_PATH env var.
      --org-id<span class="o">=</span><span class="s2">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span class="k">for</span> representing tenant ID. Useful <span class="k">for</span> requesting tenant data when
                         bypassing an auth gateway.

Commands:
  <span class="nb">help</span> <span class="o">[</span>&lt;command&gt;...<span class="o">]</span>
    Show help.

  query <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> &lt;query&gt;
    Run a LogQL query.

    The <span class="s2">&#34;query&#34;</span> <span class="nb">command</span> is useful <span class="k">for</span> querying <span class="k">for</span> logs. Logs can be returned in a few output modes:

      raw: log line
      default: log timestamp + log labels + log line
      jsonl: JSON response from Loki API of log line

    The output of the log can be specified with the <span class="s2">&#34;-o&#34;</span> flag, <span class="k">for</span> example, <span class="s2">&#34;-o raw&#34;</span> <span class="k">for</span> the raw output format.

    The <span class="s2">&#34;query&#34;</span> <span class="nb">command</span> will output extra information about the query and its results, such as the API URL, <span class="nb">set</span> of common labels,
    and <span class="nb">set</span> of excluded labels. This extra information can be suppressed with the --quiet flag.

    While <span class="s2">&#34;query&#34;</span> does support metrics queries, its output contains multiple data points between the start and end query time.
    This output is used to build graphs, like what is seen in the Grafana Explore graph view. If you are querying metrics and just
    want the most recent data point <span class="o">(</span>like what is seen in the Grafana Explore table view<span class="o">)</span>, <span class="k">then</span> you should use the <span class="s2">&#34;instant-query&#34;</span>
    <span class="nb">command</span> instead.

  instant-query <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> &lt;query&gt;
    Run an instant LogQL query.

    The <span class="s2">&#34;instant-query&#34;</span> <span class="nb">command</span> is useful <span class="k">for</span> evaluating a metric query <span class="k">for</span> a single point in time. This is equivalent to the
    Grafana Explore table view<span class="p">;</span> <span class="k">if</span> you want a metrics query that is used to build a Grafana graph, you should use the <span class="s2">&#34;query&#34;</span>
    <span class="nb">command</span> instead.

    This <span class="nb">command</span> does not produce useful output when querying <span class="k">for</span> log lines<span class="p">;</span> you should always use the <span class="s2">&#34;query&#34;</span> <span class="nb">command</span> when you
    are running log queries.

    For more information about log queries and metric queries, refer to the LogQL documentation:

    https://grafana.com/docs/loki/latest/logql/

  labels <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> <span class="o">[</span>&lt;label&gt;<span class="o">]</span>
    Find values <span class="k">for</span> a given label.

  series <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> &lt;matcher&gt;
    Run series query.

$ logcli <span class="nb">help</span> query
usage: logcli query <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> &lt;query&gt;

Run a LogQL query.

The <span class="s2">&#34;query&#34;</span> <span class="nb">command</span> is useful <span class="k">for</span> querying <span class="k">for</span> logs. Logs can be returned in a few output modes:

  raw: log line
  default: log timestamp + log labels + log line
  jsonl: JSON response from Loki API of log line

The output of the log can be specified with the <span class="s2">&#34;-o&#34;</span> flag, <span class="k">for</span> example, <span class="s2">&#34;-o raw&#34;</span> <span class="k">for</span> the raw output format.

The <span class="s2">&#34;query&#34;</span> <span class="nb">command</span> will output extra information about the query and its results, such as the API URL, <span class="nb">set</span> of common labels, and
<span class="nb">set</span> of excluded labels. This extra information can be suppressed with the --quiet flag.

While <span class="s2">&#34;query&#34;</span> does support metrics queries, its output contains multiple data points between the start and end query time. This
output is used to build graphs, like what is seen in the Grafana Explore graph view. If you are querying metrics and just want the
most recent data point <span class="o">(</span>like what is seen in the Grafana Explore table view<span class="o">)</span>, <span class="k">then</span> you should use the <span class="s2">&#34;instant-query&#34;</span> <span class="nb">command</span>
instead.

Flags:
      --help               Show context-sensitive <span class="nb">help</span> <span class="o">(</span>also try --help-long and --help-man<span class="o">)</span>.
      --version            Show application version.
  -q, --quiet              Suppress query metadata.
      --stats              Show query statistics.
  -o, --output<span class="o">=</span>default     Specify output mode <span class="o">[</span>default, raw, jsonl<span class="o">]</span>. raw suppresses log labels and timestamp.
  -z, --timezone<span class="o">=</span>Local     Specify the timezone to use when formatting output timestamps <span class="o">[</span>Local, UTC<span class="o">]</span>.
      --cpuprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>      Specify the location <span class="k">for</span> writing a CPU profile.
      --memprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>      Specify the location <span class="k">for</span> writing a memory profile.
      --addr<span class="o">=</span><span class="s2">&#34;http://localhost:3100&#34;</span>
                           Server address. Can also be <span class="nb">set</span> using LOKI_ADDR env var.
      --username<span class="o">=</span><span class="s2">&#34;&#34;</span>        Username <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_USERNAME env var.
      --password<span class="o">=</span><span class="s2">&#34;&#34;</span>        Password <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_PASSWORD env var.
      --ca-cert<span class="o">=</span><span class="s2">&#34;&#34;</span>         Path to the server Certificate Authority. Can also be <span class="nb">set</span> using LOKI_CA_CERT_PATH env var.
      --tls-skip-verify    Server certificate TLS skip verify.
      --cert<span class="o">=</span><span class="s2">&#34;&#34;</span>            Path to the client certificate. Can also be <span class="nb">set</span> using LOKI_CLIENT_CERT_PATH env var.
      --key<span class="o">=</span><span class="s2">&#34;&#34;</span>             Path to the client certificate key. Can also be <span class="nb">set</span> using LOKI_CLIENT_KEY_PATH env var.
      --org-id<span class="o">=</span><span class="s2">&#34;&#34;</span>          adds X-Scope-OrgID to API requests <span class="k">for</span> representing tenant ID. Useful <span class="k">for</span> requesting tenant data when
                           bypassing an auth gateway.
      --limit<span class="o">=</span><span class="m">30</span>           Limit on number of entries to print.
      --since<span class="o">=</span>1h           Lookback window.
      --from<span class="o">=</span>FROM          Start looking <span class="k">for</span> logs at this absolute <span class="nb">time</span> <span class="o">(</span>inclusive<span class="o">)</span>.
      --to<span class="o">=</span>TO              Stop looking <span class="k">for</span> logs at this absolute <span class="nb">time</span> <span class="o">(</span>exclusive<span class="o">)</span>.
      --step<span class="o">=</span>STEP          Query resolution step width, <span class="k">for</span> metric queries. Evaluate the query at the specified step over the <span class="nb">time</span>
                           range.
      --interval<span class="o">=</span>INTERVAL  Query interval, <span class="k">for</span> log queries. Return entries at the specified interval, ignoring those between.
                           **This parameter is experimental, please see Issue 1779**.
      --batch<span class="o">=</span><span class="m">1000</span>         Query batch size to use <span class="k">until</span> <span class="s1">&#39;limit&#39;</span> is reached.
      --forward            Scan forwards through logs.
      --no-labels          Do not print any labels.
      --exclude-label<span class="o">=</span>EXCLUDE-LABEL ...
                           Exclude labels given the provided key during output.
      --include-label<span class="o">=</span>INCLUDE-LABEL ...
                           Include labels given the provided key during output.
      --labels-length<span class="o">=</span><span class="m">0</span>    Set a fixed padding to labels.
      --store-config<span class="o">=</span><span class="s2">&#34;&#34;</span>    Execute the current query using a configured storage from a given Loki configuration file.
  -t, --tail               Tail the logs.
      --delay-for<span class="o">=</span><span class="m">0</span>        Delay in tailing by number of seconds to accumulate logs <span class="k">for</span> re-ordering.
      --colored-output     Show ouput with colored labels.

Args:
  &lt;query&gt;  eg <span class="s1">&#39;{foo=&#34;bar&#34;,baz=~&#34;.*blip&#34;} |~ &#34;.*error.*&#34;&#39;</span>

$ logcli <span class="nb">help</span> labels
usage: logcli labels <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> <span class="o">[</span>&lt;label&gt;<span class="o">]</span>

Find values <span class="k">for</span> a given label.

Flags:
      --help             Show context-sensitive <span class="nb">help</span> <span class="o">(</span>also try --help-long and --help-man<span class="o">)</span>.
      --version          Show application version.
  -q, --quiet            Suppress query metadata.
      --stats            Show query statistics.
  -o, --output<span class="o">=</span>default   Specify output mode <span class="o">[</span>default, raw, jsonl<span class="o">]</span>. raw suppresses log labels and timestamp.
  -z, --timezone<span class="o">=</span>Local   Specify the timezone to use when formatting output timestamps <span class="o">[</span>Local, UTC<span class="o">]</span>.
      --cpuprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a CPU profile.
      --memprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a memory profile.
      --addr<span class="o">=</span><span class="s2">&#34;http://localhost:3100&#34;</span>
                         Server address. Can also be <span class="nb">set</span> using LOKI_ADDR env var.
      --username<span class="o">=</span><span class="s2">&#34;&#34;</span>      Username <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_USERNAME env var.
      --password<span class="o">=</span><span class="s2">&#34;&#34;</span>      Password <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_PASSWORD env var.
      --ca-cert<span class="o">=</span><span class="s2">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span class="nb">set</span> using LOKI_CA_CERT_PATH env var.
      --tls-skip-verify  Server certificate TLS skip verify.
      --cert<span class="o">=</span><span class="s2">&#34;&#34;</span>          Path to the client certificate. Can also be <span class="nb">set</span> using LOKI_CLIENT_CERT_PATH env var.
      --key<span class="o">=</span><span class="s2">&#34;&#34;</span>           Path to the client certificate key. Can also be <span class="nb">set</span> using LOKI_CLIENT_KEY_PATH env var.
      --org-id<span class="o">=</span><span class="s2">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span class="k">for</span> representing tenant ID. Useful <span class="k">for</span> requesting tenant data when
                         bypassing an auth gateway.
      --since<span class="o">=</span>1h         Lookback window.
      --from<span class="o">=</span>FROM        Start looking <span class="k">for</span> labels at this absolute <span class="nb">time</span> <span class="o">(</span>inclusive<span class="o">)</span>.
      --to<span class="o">=</span>TO            Stop looking <span class="k">for</span> labels at this absolute <span class="nb">time</span> <span class="o">(</span>exclusive<span class="o">)</span>.

Args:
  <span class="o">[</span>&lt;label&gt;<span class="o">]</span>  The name of the label.

$ logcli <span class="nb">help</span> series
usage: logcli series --match<span class="o">=</span>MATCH <span class="o">[</span>&lt;flags&gt;<span class="o">]</span>

Run series query.

Flags:
      --help             Show context-sensitive <span class="nb">help</span> <span class="o">(</span>also try --help-long and --help-man<span class="o">)</span>.
      --version          Show application version.
  -q, --quiet            Suppress query metadata.
      --stats            Show query statistics.
  -o, --output<span class="o">=</span>default   Specify output mode <span class="o">[</span>default, raw, jsonl<span class="o">]</span>. raw suppresses log labels and timestamp.
  -z, --timezone<span class="o">=</span>Local   Specify the timezone to use when formatting output timestamps <span class="o">[</span>Local, UTC<span class="o">]</span>.
      --cpuprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a CPU profile.
      --memprofile<span class="o">=</span><span class="s2">&#34;&#34;</span>    Specify the location <span class="k">for</span> writing a memory profile.
      --addr<span class="o">=</span><span class="s2">&#34;http://localhost:3100&#34;</span>
                         Server address. Can also be <span class="nb">set</span> using LOKI_ADDR env var.
      --username<span class="o">=</span><span class="s2">&#34;&#34;</span>      Username <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_USERNAME env var.
      --password<span class="o">=</span><span class="s2">&#34;&#34;</span>      Password <span class="k">for</span> HTTP basic auth. Can also be <span class="nb">set</span> using LOKI_PASSWORD env var.
      --ca-cert<span class="o">=</span><span class="s2">&#34;&#34;</span>       Path to the server Certificate Authority. Can also be <span class="nb">set</span> using LOKI_CA_CERT_PATH env var.
      --tls-skip-verify  Server certificate TLS skip verify.
      --cert<span class="o">=</span><span class="s2">&#34;&#34;</span>          Path to the client certificate. Can also be <span class="nb">set</span> using LOKI_CLIENT_CERT_PATH env var.
      --key<span class="o">=</span><span class="s2">&#34;&#34;</span>           Path to the client certificate key. Can also be <span class="nb">set</span> using LOKI_CLIENT_KEY_PATH env var.
      --org-id<span class="o">=</span><span class="s2">&#34;&#34;</span>        adds X-Scope-OrgID to API requests <span class="k">for</span> representing tenant ID. Useful <span class="k">for</span> requesting tenant data when
                         bypassing an auth gateway.
      --since<span class="o">=</span>1h         Lookback window.
      --from<span class="o">=</span>FROM        Start looking <span class="k">for</span> logs at this absolute <span class="nb">time</span> <span class="o">(</span>inclusive<span class="o">)</span>.
      --to<span class="o">=</span>TO            Stop looking <span class="k">for</span> logs at this absolute <span class="nb">time</span> <span class="o">(</span>exclusive<span class="o">)</span>.
      --match<span class="o">=</span>MATCH ...  eg <span class="s1">&#39;{foo=&#34;bar&#34;,baz=~&#34;.*blip&#34;}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="label">Label</h3>
<p>Label tags are key-value pairs that can define anything, and we like to call them metadata that describe the log stream. If you are familiar with Prometheus, then you must have some knowledge of Label tags, which are also defined in Loki&rsquo;s scrape configuration and have the same functionality as Prometheus, these tags are very easy to associate application metrics with log data.</p>
<p>The tags in Loki perform a very important task: they define a stream. More specifically, the combination of each tag key and value defines the stream. If just one tag value changes, this will create a new stream.</p>
<p>If you are familiar with Prometheus, the terminology there is called sequences, and there is an additional dimension in Prometheus: indicator names. this is simplified in Loki, since there are no indicator names, only labels, so it was finally decided to use streams instead of sequences.</p>
<h4 id="label-example">Label example</h4>
<p>The following example will illustrate the basic use and concepts of Label tags in Loki.</p>
<p>First, take a look at the following example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w"> </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span><span class="w">   </span><span class="nt">pipeline_stages</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">localhost</span><span class="w">
</span><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">syslog</span><span class="w">
</span><span class="w">      </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/syslog</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This configuration will fetch the log file data and add a <code>job=syslog</code> tag, which we can query like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="l">job=&#34;syslog&#34;}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This will create a stream in Loki. Now let&rsquo;s add some more task configurations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w"> </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span><span class="w">   </span><span class="nt">pipeline_stages</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">localhost</span><span class="w">
</span><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">syslog</span><span class="w">
</span><span class="w">      </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/syslog</span><span class="w">
</span><span class="w"> </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span><span class="w">   </span><span class="nt">pipeline_stages</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">localhost</span><span class="w">
</span><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">      </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/apache.log</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This will create a stream in Loki. We can query these streams in several ways.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="l">job=&#34;apache&#34;} &lt;- 显示 job 标签为 apache 的日志</span><span class="w">
</span><span class="w"></span>{<span class="l">job=&#34;syslog&#34;} &lt;- 显示 job 标签为 syslog 的日志</span><span class="w">
</span><span class="w"></span>{<span class="l">job=~&#34;apache|syslog&#34;} &lt;- 显示 job 标签为 apache 或者 syslog 的日志</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The last way we use is a <code>regex</code> tag matcher to get logs with job tag values of apache or syslog. Next we see how to use the additional tags.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w"> </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span><span class="w">   </span><span class="nt">pipeline_stages</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">localhost</span><span class="w">
</span><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">syslog</span><span class="w">
</span><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span><span class="w">      </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/syslog</span><span class="w">
</span><span class="w"> </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">system</span><span class="w">
</span><span class="w">   </span><span class="nt">pipeline_stages</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">localhost</span><span class="w">
</span><span class="w">     </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span><span class="w">      </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/apache.log</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>To get the logs of these two tasks you can use the following instead of the regex approach.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="l">env=&#34;dev&#34;} &lt;- 将返回所有带有 env=dev 标签的日志</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>By using one tag it is possible to query many log streams, and by combining several different tags it is possible to create very flexible log queries.</p>
<p>Label tags are indices of Loki log data, and they are used to find the compressed log content, which is stored separately as blocks. Each unique combination of labels and values defines a stream , a stream of logs that are batched, compressed, and stored as blocks.</p>
<h4 id="cardinality">Cardinality</h4>
<p>The previous example uses a statically defined Label tag with a single value; however, there are ways to define the label dynamically. For example, we have log data like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">11.11.11.11 - frank <span class="o">[</span>25/Jan/2000:14:00:01 -0500<span class="o">]</span> <span class="s2">&#34;GET /1986.js HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>We can use the following to parse this log data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">- job_name: system
   pipeline_stages:
      - regex:
        expression: <span class="s2">&#34;^(?P&lt;ip&gt;\\S+) (?P&lt;identd&gt;\\S+) (?P&lt;user&gt;\\S+) \\[(?P&lt;timestamp&gt;[\\w:/]+\\s[+\\-]\\d{4})\\] \&#34;(?P&lt;action&gt;\\S+)\\s?(?P&lt;path&gt;\\S+)?\\s?(?P&lt;protocol&gt;\\S+)?\&#34; (?P&lt;status_code&gt;\\d{3}|-) (?P&lt;size&gt;\\d+|-)\\s?\&#34;?(?P&lt;referer&gt;[^\&#34;]*)\&#34;?\\s?\&#34;?(?P&lt;useragent&gt;[^\&#34;]*)?\&#34;?</span>$<span class="s2">&#34;</span>
    - labels:
        action:
        status_code:
   static_configs:
   - targets:
      - localhost
     labels:
      job: apache
      env: dev
      __path__: /var/log/apache.log
</code></pre></td></tr></table>
</div>
</div><p>This regex matches each component of the log line and extracts the value of each component into a capture group. Inside the pipeline code, this data is placed into a temporary data structure that allows it to be used for other processing while the log line is being processed (at which point the temporary data is discarded).</p>
<p>From this regex, we then use two of these capture groups to dynamically set two tags based on the content of the log line itself.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">action <span class="o">(</span>例如 <span class="nv">action</span><span class="o">=</span><span class="s2">&#34;GET&#34;</span>, <span class="nv">action</span><span class="o">=</span><span class="s2">&#34;POST&#34;</span><span class="o">)</span> status_code <span class="o">(</span>例如 <span class="nv">status_code</span><span class="o">=</span><span class="s2">&#34;200&#34;</span>, <span class="nv">status_code</span><span class="o">=</span><span class="s2">&#34;400&#34;</span><span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Suppose we have the following lines of log data:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">11.11.11.11 - frank <span class="o">[</span>25/Jan/2000:14:00:01 -0500<span class="o">]</span> <span class="s2">&#34;GET /1986.js HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
11.11.11.12 - frank <span class="o">[</span>25/Jan/2000:14:00:02 -0500<span class="o">]</span> <span class="s2">&#34;POST /1986.js HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
11.11.11.13 - frank <span class="o">[</span>25/Jan/2000:14:00:03 -0500<span class="o">]</span> <span class="s2">&#34;GET /1986.js HTTP/1.1&#34;</span> <span class="m">400</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
11.11.11.14 - frank <span class="o">[</span>25/Jan/2000:14:00:04 -0500<span class="o">]</span> <span class="s2">&#34;POST /1986.js HTTP/1.1&#34;</span> <span class="m">400</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, after the logs are collected in Loki, they are created as a stream as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;apache&#34;</span>,env<span class="o">=</span><span class="s2">&#34;dev&#34;</span>,action<span class="o">=</span><span class="s2">&#34;GET&#34;</span>,status_code<span class="o">=</span><span class="s2">&#34;200&#34;</span><span class="o">}</span> 11.11.11.11 - frank <span class="o">[</span>25/Jan/2000:14:00:01 -0500<span class="o">]</span> <span class="s2">&#34;GET /1986.js HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;apache&#34;</span>,env<span class="o">=</span><span class="s2">&#34;dev&#34;</span>,action<span class="o">=</span><span class="s2">&#34;POST&#34;</span>,status_code<span class="o">=</span><span class="s2">&#34;200&#34;</span><span class="o">}</span> 11.11.11.12 - frank <span class="o">[</span>25/Jan/2000:14:00:02 -0500<span class="o">]</span> <span class="s2">&#34;POST /1986.js HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;apache&#34;</span>,env<span class="o">=</span><span class="s2">&#34;dev&#34;</span>,action<span class="o">=</span><span class="s2">&#34;GET&#34;</span>,status_code<span class="o">=</span><span class="s2">&#34;400&#34;</span><span class="o">}</span> 11.11.11.13 - frank <span class="o">[</span>25/Jan/2000:14:00:03 -0500<span class="o">]</span> <span class="s2">&#34;GET /1986.js HTTP/1.1&#34;</span> <span class="m">400</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;apache&#34;</span>,env<span class="o">=</span><span class="s2">&#34;dev&#34;</span>,action<span class="o">=</span><span class="s2">&#34;POST&#34;</span>,status_code<span class="o">=</span><span class="s2">&#34;400&#34;</span><span class="o">}</span> 11.11.11.14 - frank <span class="o">[</span>25/Jan/2000:14:00:04 -0500<span class="o">]</span> <span class="s2">&#34;POST /1986.js HTTP/1.1&#34;</span> <span class="m">400</span> <span class="m">932</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; de; rv:1.9.1.7) Gecko/20091221 Firefox/3.5.7 GTB6&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>These 4 log lines will become 4 separate streams and start populating 4 separate blocks. Any additional log lines that match these <code>tag/value</code> combinations will be added to the existing streams. If another unique label combination comes in (e.g. status_code=&ldquo;500&rdquo;) another new stream will be created.</p>
<p>For example, if we set a Label tag for the IP, not only will each request from the user become a unique stream, but each request with a different action or status_code from the same user will get its own stream.</p>
<p>If there are 4 common actions (GET, PUT, POST, DELETE) and 4 common status codes (probably more than 4!) ), this would be 16 streams and 16 separate blocks. Then now multiply that by each user, and if we use IP&rsquo;s tags, you&rsquo;ll soon have thousands or tens of thousands of streams.</p>
<p>This Cardinality is so high, it&rsquo;s enough to hang Loki.</p>
<p>When we talk about Cardinality, we mean the combination of tags and values and the number of streams they create. High Cardinality means using tags with a large range of possible values, such as IP, or a combination that requires other tags, even if they have a small and limited set, such as status_code and action.</p>
<p>High Cardinality causes Loki to build a huge index (💰💰💰💰) and store thousands of tiny blocks into object storage (slow), Loki currently performs very poorly in this configuration and is very uneconomical to run and use.</p>
<h4 id="loki-performance-optimization">Loki Performance Optimization</h4>
<p>Now that we know that it&rsquo;s bad to use a lot of tags or tags with a lot of values, how should I query my logs? If none of the data is indexed, won&rsquo;t the query be really slow?</p>
<p>We see that people using Loki are used to other index-heavy solutions and they just feel that they need to define a lot of tags to be able to query the logs efficiently, after all, many other logging solutions are for indexing, which is the usual way of thinking before.</p>
<p>When using Loki, you may need to forget what you know and see how you can solve this problem with parallelization. the superpower of Loki is to break queries into small chunks and schedule them in parallel, so you can query large amounts of log data in a small amount of time.</p>
<p>Large indexes are very complex and expensive, and typically, the full-text index of your log data is equal to or larger than the size of the log data itself. To query your log data, this index needs to be loaded, probably in memory for performance, which makes it very difficult to scale, and when you collect a large number of logs, your index becomes very large.</p>
<p>Now let&rsquo;s talk about Loki, indexes are usually an order of magnitude smaller than the amount of logs you&rsquo;re collecting. So if you do a good job of keeping your streams to a minimum, then the index grows very slowly compared to the logs collected.</p>
<p>Loki will effectively keep your static costs as low as possible (index size and memory requirements and static log storage) and allow query performance to be controlled by horizontal scaling at runtime.</p>
<p>To see how it works, let&rsquo;s go back to the example above where we query for a specific IP address to access log data. Instead of using a label to store the IP, we instead use a filter expression to query it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="l">job=&#34;apache&#34;} |= &#34;11.11.11.11&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Behind the scenes Loki breaks that query into smaller shards (shards) and opens each chunk (chunk) for the stream whose label matches and starts looking up that IP address.</p>
<p>The size of these shards and the amount of parallelization is configurable and based on the resources you provide. If you want, you can configure shard spacing to 5m, deploy 20 lookups, and process gigabytes of logs in a few seconds. Or you can go even crazier and configure 200 queriers and process terabytes of logs!</p>
<p>This tradeoff between smaller indexes and parallel queries and larger/faster full-text indexes is what makes Loki so cost effective relative to other systems. The cost and complexity of operating a large index is high and usually fixed, whether you are querying it or not, and you are paying for it 24 hours a day.</p>
<p>The advantage of this design is that you can decide how much querying power you want to have, and you can change it on demand. Query performance becomes a function of how much you want to spend. At the same time the data is heavily compressed and stored in low cost object stores like S3 and GCS. this minimizes fixed operational costs while still providing incredibly fast querying capabilities.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/grafana/">grafana</a>
          <a href="/tags/loki/">loki</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/decision-tree-visualizations/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Decision tree visualization methods and techniques</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/update-k8s-10y-expire-certs/">
            <span class="next-text nav-default">Renew a Kubernetes certificate with a 10-year expiration date</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
