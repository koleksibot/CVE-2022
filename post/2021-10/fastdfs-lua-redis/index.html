<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Lua &#43; Redis does dynamic routing to nginx - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Since FastDFS distributed file storage does not retain the original file name when uploading files, when the file is uploaded it returns a file ID in the following format, which contains the group the file is in, the secondary directory, and a base64-encoded file name generated from the client&amp;rsquo;s IP, timestamp, and file size. The file ID is stored in the client database and can only be accessed by the" /><meta name="keywords" content="lua, fastdfs, redis, nginx, routing" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-10/fastdfs-lua-redis/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Lua &#43; Redis does dynamic routing to nginx" />
<meta property="og:description" content="Since FastDFS distributed file storage does not retain the original file name when uploading files, when the file is uploaded it returns a file ID in the following format, which contains the group the file is in, the secondary directory, and a base64-encoded file name generated from the client&rsquo;s IP, timestamp, and file size. The file ID is stored in the client database and can only be accessed by the" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-10/fastdfs-lua-redis/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-04T10:13:49+08:00" />
<meta property="article:modified_time" content="2021-10-04T10:13:49+08:00" />

<meta itemprop="name" content="Lua &#43; Redis does dynamic routing to nginx">
<meta itemprop="description" content="Since FastDFS distributed file storage does not retain the original file name when uploading files, when the file is uploaded it returns a file ID in the following format, which contains the group the file is in, the secondary directory, and a base64-encoded file name generated from the client&rsquo;s IP, timestamp, and file size. The file ID is stored in the client database and can only be accessed by the"><meta itemprop="datePublished" content="2021-10-04T10:13:49+08:00" />
<meta itemprop="dateModified" content="2021-10-04T10:13:49+08:00" />
<meta itemprop="wordCount" content="1711">
<meta itemprop="keywords" content="lua,fastdfs,redis,nginx," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Lua &#43; Redis does dynamic routing to nginx"/>
<meta name="twitter:description" content="Since FastDFS distributed file storage does not retain the original file name when uploading files, when the file is uploaded it returns a file ID in the following format, which contains the group the file is in, the secondary directory, and a base64-encoded file name generated from the client&rsquo;s IP, timestamp, and file size. The file ID is stored in the client database and can only be accessed by the"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Lua &#43; Redis does dynamic routing to nginx</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-04 10:13:49 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1711 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#implementation-process">Implementation process</a>
          <ul>
            <li><a href="#get-the-original-file-name-and-the-newly-generated-file-id">Get the original file name and the newly generated file ID</a></li>
            <li><a href="#importing-data-into-redis">Importing Data into Redis</a></li>
            <li><a href="#compiling-nginx-to-include-lua-and-lua-redis-modules">Compiling nginx to include lua and lua-Redis modules</a></li>
            <li><a href="#configuring-nginx">Configuring nginx</a></li>
            <li><a href="#test-access">Test Access</a></li>
            <li><a href="#shortcomings-and-improvement-options">Shortcomings and improvement options</a></li>
            <li><a href="#disadvantages">Disadvantages</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Since FastDFS distributed file storage does not retain the original file name when uploading files, when the file is uploaded it returns a file ID in the following format, which contains the group the file is in, the secondary directory, and a base64-encoded file name generated from the client&rsquo;s IP, timestamp, and file size. The file ID is stored in the client database and can only be accessed by the file ID. If other systems want to access the FastDFS file store, they have to get the file ID of the file from the database where the upload client is stored. This increases the coupling of the system and is not conducive to subsequent file storage migration and maintenance. Since FastDFS stores files directly on local disks and does not chunk or merge files, we can let nginx request files on local disks directly, without querying the client database for file IDs, and without going through FastDFS.</p>
<p>Composition of the file ID</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/66204c39e124472ba0b6bc891390b77d.png" alt=""></p>
<p><code>group1</code> is the name of the group where the file is located</p>
<p><code>M00</code> is the partition on the storage server where the file is located</p>
<p><code>00/05</code> is the first level subdirectory/second level subdirectory where the file is located, which is the real path where the file is located</p>
<p><code>Cgpr6F1A7O6ASWv9AAA-az6haWc850.jpg</code> is the name of the newly generated file</p>
<p><strong>The root directory for file storage, set by the <code>base_path=</code> configuration parameter, the data directory is the file storage directory, and the logs directory stores logs</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/ff30b58935b44e1e8821d5491513c975.png" alt=""></p>
<p>First-level subdirectories for file storage</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/39859684385a4c5e818a55a687ff977a.png" alt=""></p>
<p>Secondary subdirectories for file storage</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/a9c86d8eb4784fe3afc4764f5cc9c8d2.png" alt=""></p>
<p>FastDFS stores real files, no chunking or merging of files</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/fbb0c0cdad244ca9878fc35071b51fb2.png" alt=""></p>
<p>For testing purposes, the <code>nginx</code> list directory option is turned on here</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/00d6f6e3f13f44c49ec5732872f3f533.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/8675ef956e514cfab510a33be8537ccb.png" alt=""></p>
<h2 id="implementation-process">Implementation process</h2>
<h3 id="get-the-original-file-name-and-the-newly-generated-file-id">Get the original file name and the newly generated file ID</h3>
<p>The log in the following format is extracted from the client (C version) log, available in the database for other versions, which records the original file name and the file ID generated by the FastDFS storage service after the upload.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/69fe2cdd9fd447c18b199bd0f94e94d6.png" alt=""></p>
<p>You need to add a <code>/</code> to the original file name as the requested <code>uri</code> header, and the converted format will be as follows</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/c1b3ad8f49a143f29f21121ef805df57.png" alt=""></p>
<h3 id="importing-data-into-redis">Importing Data into Redis</h3>
<p>Use a shell script to import the original file name (which can also be customized) into the Redis database as KEY and the file ID as VALUE</p>
<p><code>awk 'BEGIN{ FS=&quot; &quot;}{arr[$NF]=$1}END{for( k in arr){ cmd=d=&quot;redis-cli set &quot;k&quot; &quot;arr[k];system(cmd)}}' url.log</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 通过脚本导入</span>
<span class="c1">#!/bin/bash</span>
<span class="c1"># import data</span>
cat <span class="nv">$1</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> line
<span class="k">do</span>
    <span class="nv">key</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f2<span class="k">)</span>
    <span class="nv">value</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f1<span class="k">)</span>
    redis-cli <span class="nb">set</span> <span class="nv">$key</span> <span class="nv">$value</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 10W 条 K/V 键值对占用不到15MB 内存</span>
╭─root@ubuntu-238 /tmp
╰─# redis-cli
127.0.0.1:6379&gt; info
<span class="c1"># Memory</span>
used_memory:14690296
used_memory_human:14.01M
used_memory_rss:18280448
used_memory_rss_human:17.43M
used_memory_peak:18094392
used_memory_peak_human:17.26M
used_memory_peak_perc:81.19%
used_memory_overhead:5881110
used_memory_startup:782504
used_memory_dataset:8809186
used_memory_dataset_perc:63.34%
total_system_memory:4136931328
total_system_memory_human:3.85G
used_memory_lua:37888
used_memory_lua_human:37.00K
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
mem_fragmentation_ratio:1.24
mem_allocator:jemalloc-3.6.0
active_defrag_running:0
lazyfree_pending_objects:0

127.0.0.1:6379&gt; get /000001.jpg
<span class="s2">&#34;group1/M00/00/05/Cgpr6F1A6oOARgfgAAAdDglAWL4368.jpg&#34;</span>
127.0.0.1:6379&gt;
</code></pre></td></tr></table>
</div>
</div><h3 id="compiling-nginx-to-include-lua-and-lua-redis-modules">Compiling nginx to include lua and lua-Redis modules</h3>
<h4 id="compiler-environment">Compiler Environment</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">yum install -y gcc g++ gcc-c++  zlib zlib-devel openssl openssl--devel pcre pcre-devel
</code></pre></td></tr></table>
</div>
</div><h4 id="compile-luajit">Compile luajit</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 编译安装 luajit</span>
wget http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz
tar zxf LuaJIT-2.1.0-beta2.tar.gz
<span class="nb">cd</span> LuaJIT-2.1.0-beta2
make <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/luajit
make install <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/luajit
</code></pre></td></tr></table>
</div>
</div><h4 id="download-the-ngx_devel_kit-ndk-module">Download the ngx_devel_kit (NDK) module</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">wget https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz
tar -xzvf v0.2.19.tar.gz
</code></pre></td></tr></table>
</div>
</div><h4 id="download-the-lua-nginx-module-module">Download the lua-nginx-module module</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.2.tar.gz
tar -xzvf v0.10.2.tar.gz
</code></pre></td></tr></table>
</div>
</div><h4 id="compiling-nginx">Compiling nginx</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">tar zxvf nginx-1.15.1.tar.gz
<span class="nb">cd</span> nginx-1.15.1/

<span class="c1"># tell nginx&#39;s build system where to find LuaJIT 2.1:</span>
<span class="nb">export</span> <span class="nv">LUAJIT_LIB</span><span class="o">=</span>/usr/local/luajit/lib
<span class="nb">export</span> <span class="nv">LUAJIT_INC</span><span class="o">=</span>/usr/local/luajit/include/luajit-2.1

./configure --prefix<span class="o">=</span>/usr/local/nginx --with-ld-opt<span class="o">=</span><span class="s2">&#34;-Wl,-rpath,/usr/local/luajit/lib&#34;</span> --with-http_stub_status_module --with-http_ssl_module --with-http_realip_module --with-http_gzip_static_module --with-debug <span class="se">\
</span><span class="se"></span>--add-module<span class="o">=</span>/usr/local/src/nginx_lua_tools/ngx_devel_kit-0.2.19

<span class="c1"># 重新编译</span>
./configure <span class="o">(</span>之前安装的参数<span class="o">)</span> --with-ld-opt<span class="o">=</span><span class="s2">&#34;-Wl,-rpath,/usr/local/luajit/lib&#34;</span> --add-module<span class="o">=</span>/path/to/ngx_devel_kit --add-module<span class="o">=</span>/path/to/lua-nginx-module
--add-module后参数路径根据解压路径为准
make -j4 <span class="p">&amp;</span> make install
<span class="c1"># --with-debug &#34;调试日志&#34;默认是禁用的，因为它会引入比较大的运行时开销，让 Nginx 服务器显著变慢。</span>
<span class="c1"># 启用 --with-debug 选项重新构建好调试版的 Nginx 之后，还需要同时在配置文件中通过标准的 error_log 配置指令为错误日志使用 debug 日志级别（这同时也是最低的日志级别）</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="configuring-nginx">Configuring nginx</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>

    <span class="kn">location</span> <span class="p">~</span><span class="sr">/group[0-9]/</span> <span class="p">{</span>
    <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/home/dfs/data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="p">=</span> <span class="s">/Redis</span> <span class="p">{</span>
        <span class="kn">internal</span><span class="p">;</span>
        <span class="kn">set_unescape_uri</span> <span class="nv">$key</span> <span class="nv">$arg_key</span><span class="p">;</span>
        <span class="kn">Redis2_query</span> <span class="s">get</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="kn">Redis2_pass</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">;</span>
    <span class="p">}</span>
<span class="c1"># 此处根据业务的需求来写正则表达式，一定要个 redis 里的 KEY  对应上
</span><span class="c1"></span>    <span class="kn">location</span>  <span class="p">~</span><span class="sr">/[0-9].*\.(gif|jpg|jpeg|png)$</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$target</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
        <span class="kn">access_by_lua</span> <span class="s">&#39;</span>
<span class="c1"># 使用 nginx 的内部参数 ngx.var.uri 来获取请求的 uri 地址，如 /000001.jpg
</span><span class="c1"></span>            <span class="s">local</span> <span class="s">key</span> <span class="p">=</span> <span class="s">ngx.var.uri</span>
<span class="c1"># 根据正则匹配到 KEY ，从 redis 数据库里获取文件 ID (路径和文件名)
</span><span class="c1"></span>            <span class="s">local</span> <span class="s">res</span> <span class="p">=</span> <span class="s">ngx.location.capture(</span>
                <span class="s">&#34;/Redis&#34;,</span> <span class="p">{</span> <span class="kn">args</span> <span class="p">=</span> <span class="p">{</span> <span class="kn">key</span> <span class="p">=</span> <span class="s">key</span> <span class="err">}</span> <span class="err">}</span>
            <span class="s">)</span>
            <span class="s">if</span> <span class="s">res.status</span> <span class="p">~</span><span class="sr">=</span> <span class="mi">200</span> <span class="s">then</span>
                <span class="s">ngx.log(ngx.ERR,</span> <span class="s">&#34;Redis</span> <span class="s">server</span> <span class="s">returned</span> <span class="s">bad</span> <span class="s">status:</span> <span class="s">&#34;,</span>
                    <span class="s">res.status)</span>
                <span class="s">ngx.exit(res.status)</span>
            <span class="s">end</span>
            <span class="s">if</span> <span class="s">not</span> <span class="s">res.body</span> <span class="s">then</span>
                <span class="s">ngx.log(ngx.ERR,</span> <span class="s">&#34;Redis</span> <span class="s">returned</span> <span class="s">empty</span> <span class="s">body&#34;)</span>
                <span class="s">ngx.exit(500)</span>
            <span class="s">end</span>
            <span class="s">local</span> <span class="s">parser</span> <span class="p">=</span> <span class="s">require</span> <span class="s">&#34;Redis.parser&#34;</span>
            <span class="s">local</span> <span class="s">filename,</span> <span class="s">typ</span> <span class="p">=</span> <span class="s">parser.parse_reply(res.body)</span>
            <span class="s">if</span> <span class="s">typ</span> <span class="p">~</span><span class="sr">=</span> <span class="s">parser.BULK_REPLY</span> <span class="s">or</span> <span class="s">not</span> <span class="s">server</span> <span class="s">then</span>
                <span class="s">ngx.log(ngx.ERR,</span> <span class="s">&#34;bad</span> <span class="s">Redis</span> <span class="s">response:</span> <span class="s">&#34;,</span> <span class="s">res.body)</span>
                <span class="s">ngx.exit(500)</span>
            <span class="s">end</span>

            <span class="s">ngx.var.target</span> <span class="p">=</span> <span class="s">filename</span>
        <span class="s">&#39;</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://10.20.172.196/</span><span class="nv">$target</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="test-access">Test Access</h3>
<h4 id="the-url-address-of-the-stitched-image-file">The url address of the stitched image file</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/46aa1d8de96b414590d51ba7e152973e.png" alt=""></p>
<h4 id="access-via-browser">Access via browser</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/5688720f5f344c2db8c4391716660b5d.png" alt=""></p>
<h4 id="parallel-download-using-wget-and-xargs">Parallel download using wget and xargs</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/59c0ceca5cf3495f99a613346a727750.png" alt=""></p>
<h3 id="shortcomings-and-improvement-options">Shortcomings and improvement options</h3>
<h4 id="advantages">Advantages</h4>
<p>The advantage of this solution is that the uploaded files can be retrieved from the file name that is accessed by a custom file name, which is set according to the needs of the business. The corresponding regular expressions are written in the nginx location module. This decouples FastDFS from the upload client, making it possible to access files without relying on FastDFS storage, reducing O&amp;M costs. At the same time, since the Redis database and internal forwarding are used, the performance loss is almost negligible as it is transparent to the accessing client.</p>
<h3 id="disadvantages">Disadvantages</h3>
<ol>
<li>Since the data in the Redis database needs to be imported from the client logs or database, the Redis database cannot be updated in real time, and if the uploaded file is modified or deleted, it cannot be updated to the Redis database.</li>
<li>You need to recompile and install nginx, add the lua-nginx module, and install the Redis database.</li>
</ol>
<h4 id="improvements">Improvements</h4>
<ul>
<li>Modify the content of FastDFS log output, add metafile name field, and add, delete, and check Redis based on the log operation records</li>
</ul>
<p>As you can see from the source code, FastDFS records the operation types of files in the logs, and you can add, delete, and check the Redis database based on these types, so you can monitor the output of the logs to add, delete, and check the Redis database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">//storage access log actions
<span class="c1">#define ACCESS_LOG_ACTION_UPLOAD_FILE    &#34;upload&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_DOWNLOAD_FILE  &#34;download&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_DELETE_FILE    &#34;delete&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_GET_METADATA   &#34;get_metadata&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_SET_METADATA   &#34;set_metadata&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_MODIFY_FILE    &#34;modify&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_APPEND_FILE    &#34;append&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_TRUNCATE_FILE  &#34;truncate&#34;</span>
<span class="c1">#define ACCESS_LOG_ACTION_QUERY_FILE     &#34;status&#34;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>After reading the source code of the FastDFS storage module, I found that the FastDFS server does not store the original file name, and the original file name is not included in the corresponding file attribute structure. The source code needs to be modified to output the original file name to the log, which is difficult.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">typedef struct
<span class="o">{</span>
	bool if_gen_filename<span class="p">;</span>	  //if upload generate filename
	char file_type<span class="p">;</span>           //regular or link file
	bool if_sub_path_alloced<span class="p">;</span> //if sub path alloced since V3.0
	char master_filename<span class="o">[</span>128<span class="o">]</span><span class="p">;</span>
	char file_ext_name<span class="o">[</span>FDFS_FILE_EXT_NAME_MAX_LEN + 1<span class="o">]</span><span class="p">;</span>
	char formatted_ext_name<span class="o">[</span>FDFS_FILE_EXT_NAME_MAX_LEN + 2<span class="o">]</span><span class="p">;</span>
	char prefix_name<span class="o">[</span>FDFS_FILE_PREFIX_MAX_LEN + 1<span class="o">]</span><span class="p">;</span>
	char group_name<span class="o">[</span>FDFS_GROUP_NAME_MAX_LEN + 1<span class="o">]</span><span class="p">;</span>  	//the upload group name
	int start_time<span class="p">;</span>		//upload start timestamp
	FDFSTrunkFullInfo trunk_info<span class="p">;</span>
	FileBeforeOpenCallback before_open_callback<span class="p">;</span>
	FileBeforeCloseCallback before_close_callback<span class="p">;</span>
<span class="o">}</span> StorageUploadInfo<span class="p">;</span>

typedef struct
<span class="o">{</span>
	char op_flag<span class="p">;</span>
	char *meta_buff<span class="p">;</span>
	int meta_bytes<span class="p">;</span>
<span class="o">}</span> StorageSetMetaInfo<span class="p">;</span>

typedef struct
<span class="o">{</span>
	char filename<span class="o">[</span>MAX_PATH_SIZE + 128<span class="o">]</span><span class="p">;</span>  	//full filename
	/* FDFS logic filename to log not including group name */
	char fname2log<span class="o">[</span>128+sizeof<span class="o">(</span>FDFS_STORAGE_META_FILE_EXT<span class="o">)]</span><span class="p">;</span>
	char op<span class="p">;</span>            //w <span class="k">for</span> writing, r <span class="k">for</span> reading, d <span class="k">for</span> deleting etc.
	char sync_flag<span class="p">;</span>     //sync flag log to binlog
	bool calc_crc32<span class="p">;</span>    //if calculate file content <span class="nb">hash</span> code
	bool calc_file_hash<span class="p">;</span>      //if calculate file content <span class="nb">hash</span> code
	int open_flags<span class="p">;</span>           //open file flags
	int file_hash_codes<span class="o">[</span>4<span class="o">]</span><span class="p">;</span>   //file <span class="nb">hash</span> code
	int64_t crc32<span class="p">;</span>            //file content crc32 signature
	MD5_CTX md5_context<span class="p">;</span>
	union
	<span class="o">{</span>
		StorageUploadInfo upload<span class="p">;</span>
		StorageSetMetaInfo setmeta<span class="p">;</span>
	<span class="o">}</span> extra_info<span class="p">;</span>
	int dio_thread_index<span class="p">;</span>		//dio thread index
	int timestamp2log<span class="p">;</span>		//timestamp to log
	int delete_flag<span class="p">;</span>     //delete file flag
	int create_flag<span class="p">;</span>    //create file flag
	int buff_offset<span class="p">;</span>    //buffer offset after recv to write to file
	int fd<span class="p">;</span>         //file description no
	int64_t start<span class="p">;</span>  //the start offset of file
	int64_t end<span class="p">;</span>    //the end offset of file
	int64_t offset<span class="p">;</span> //the current offset of file
	FileDealDoneCallback done_callback<span class="p">;</span>
	DeleteFileLogCallback log_callback<span class="p">;</span>

	struct timeval tv_deal_start<span class="p">;</span> //task deal start tv <span class="k">for</span> access log
<span class="o">}</span> StorageFileContext<span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Real-time updates to the Redis database by the type of file operations recorded in FastDFS logs</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/10/04/4412f6ad68634ff38214ba61307565d5.png" alt=""></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/lua/">lua</a>
          <a href="/tags/fastdfs/">fastdfs</a>
          <a href="/tags/redis/">redis</a>
          <a href="/tags/nginx/">nginx</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-10/the-strategy-pattern-in-cplusplus17/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The Strategy pattern in C&#43;&#43;17</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/docker-deploy-fastdfs/">
            <span class="next-text nav-default">Docker Deployment FastDFS</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
