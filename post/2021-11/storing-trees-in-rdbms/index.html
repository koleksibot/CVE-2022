<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Tree structured data database storage solution - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In the program development, we often encounter a tree structure to represent the relationship between certain data, such as the organizational structure of the enterprise, the classification of goods, operation columns, etc., the current relational database is to store data in the form of two-dimensional table records, and the tree structure of the data must be stored in the two-dimensional table Schema design. Recently, we have been interested in this" /><meta name="keywords" content="Tree, database, storage" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-11/storing-trees-in-rdbms/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Tree structured data database storage solution" />
<meta property="og:description" content="In the program development, we often encounter a tree structure to represent the relationship between certain data, such as the organizational structure of the enterprise, the classification of goods, operation columns, etc., the current relational database is to store data in the form of two-dimensional table records, and the tree structure of the data must be stored in the two-dimensional table Schema design. Recently, we have been interested in this" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-11/storing-trees-in-rdbms/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-20T15:15:55+08:00" />
<meta property="article:modified_time" content="2021-11-20T15:15:55+08:00" />

<meta itemprop="name" content="Tree structured data database storage solution">
<meta itemprop="description" content="In the program development, we often encounter a tree structure to represent the relationship between certain data, such as the organizational structure of the enterprise, the classification of goods, operation columns, etc., the current relational database is to store data in the form of two-dimensional table records, and the tree structure of the data must be stored in the two-dimensional table Schema design. Recently, we have been interested in this"><meta itemprop="datePublished" content="2021-11-20T15:15:55+08:00" />
<meta itemprop="dateModified" content="2021-11-20T15:15:55+08:00" />
<meta itemprop="wordCount" content="3260">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tree structured data database storage solution"/>
<meta name="twitter:description" content="In the program development, we often encounter a tree structure to represent the relationship between certain data, such as the organizational structure of the enterprise, the classification of goods, operation columns, etc., the current relational database is to store data in the form of two-dimensional table records, and the tree structure of the data must be stored in the two-dimensional table Schema design. Recently, we have been interested in this"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Tree structured data database storage solution</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-11-20 15:15:55 </span>
        <div class="post-category">
            <a href="/categories/database/"> database </a>
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 3260 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#adjacency-list-pattern-adjacency-list">Adjacency List Pattern Adjacency List</a></li>
        <li><a href="#path-enumeration">Path Enumeration</a></li>
        <li><a href="#closure-table">Closure Table</a></li>
        <li><a href="#left-and-right-value-coding-nested-set">Left and Right Value Coding Nested Set</a></li>
        <li><a href="#interval-nested-nested-intervals">interval nested Nested Intervals</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the program development, we often encounter a tree structure to represent the relationship between certain data, such as the organizational structure of the enterprise, the classification of goods, operation columns, etc., the current relational database is to store data in the form of two-dimensional table records, and the tree structure of the data must be stored in the two-dimensional table Schema design. Recently, we have been interested in this area, and we are dedicated to sorting out the following common tree structure data.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/c134414bc85d47d0951b242ca58a67a3.png" alt=""></p>
<h2 id="adjacency-list-pattern-adjacency-list">Adjacency List Pattern Adjacency List</h2>
<p>The simplest method is: Adjacency List (Adjacency List pattern). It simply describes the parent node of a node based on the inheritance relationship between nodes, thus creating a two-bit relationship table. The table structure is usually designed as {Node_id,Parent_id}, as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/23c6e5b0091647539d4b9a6a33f4b3cd.png" alt=""></p>
<p>Approximate code for using the join table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// $parent is the parent of the children we want to see
</span><span class="c1">// $level is increased when we go deeper into the tree,
</span><span class="c1">//        used to display a nice indented tree
</span><span class="c1"></span>
<span class="k">function</span> <span class="nf">display_children</span><span class="p">(</span><span class="nv">$parent</span><span class="p">,</span> <span class="nv">$level</span><span class="p">)</span> 
<span class="p">{</span>
   <span class="c1">// 获得一个 父节点 $parent 的所有子节点
</span><span class="c1"></span>   <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysql_query</span><span class="p">(</span><span class="s1">&#39;SELECT name FROM tree WHERE parent=&#34;&#39;</span><span class="o">.</span><span class="nv">$parent</span><span class="o">.</span><span class="s1">&#39;&#34;;&#39;</span><span class="p">);</span>

   <span class="c1">// 显示每个子节点
</span><span class="c1"></span>   <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> 
   <span class="p">{</span>
       <span class="c1">// 缩进显示节点名称
</span><span class="c1"></span>       <span class="k">echo</span> <span class="nx">str_repeat</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="nv">$level</span><span class="p">)</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>

       <span class="c1">//再次调用这个函数显示子节点的子节点
</span><span class="c1"></span>      
       <span class="nx">display_children</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nv">$level</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Using this function for the root node of the entire structure (Food) will print out the entire multilevel tree structure. Since Food is the root node its parent is empty, so call it like this: display_children(&quot;,0). will display the entire tree. If you want to display only a part of the whole structure, say the fruit part, call it like this: display_children(&lsquo;Fruit&rsquo;,0);</p>
<p>Using almost the same method we can know the path from the root node to any node. For example, Cherry&rsquo;s path is &ldquo;Food &gt;; Fruit &gt;; Red&rdquo;. To get such a path we need to start from the deepest level &ldquo;Cherry&rdquo;, query its parent node &ldquo;Red&rdquo; and add it to the path, then we query Red&rsquo;s parent node and add it to the path as well. And so on up to the highest level &ldquo;Food&rdquo;</p>
<p>Here is the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// $node 是那个最深的节点
</span><span class="c1"></span><span class="k">function</span> <span class="nf">get_path</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span> 
<span class="p">{</span>
   <span class="c1">// 查询这个节点的父节点
</span><span class="c1"></span>   <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysql_query</span><span class="p">(</span><span class="s1">&#39;SELECT parent FROM tree &#39;</span><span class="o">.</span>
                          <span class="s1">&#39;WHERE name=&#34;&#39;</span><span class="o">.</span><span class="nv">$node</span><span class="o">.</span><span class="s1">&#39;&#34;;&#39;</span><span class="p">);</span>
   <span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

   <span class="c1">// 用一个数组保存路径
</span><span class="c1"></span>   <span class="nv">$path</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

   <span class="c1">// 如果不是根节点则继续向上查询
</span><span class="c1"></span>   <span class="c1">// (根节点没有父节点)
</span><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
   <span class="p">{</span>
       <span class="c1">// the last part of the path to $node, is the name
</span><span class="c1"></span>       <span class="c1">// of the parent of $node
</span><span class="c1"></span>       <span class="nv">$path</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">];</span>

       <span class="c1">// we should add the path to the parent of this node
</span><span class="c1"></span>       <span class="c1">// to the path
</span><span class="c1"></span>       <span class="nv">$path</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nx">get_path</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]),</span> <span class="nv">$path</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// return the path
</span><span class="c1"></span>   <span class="k">return</span> <span class="nv">$path</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>If you use this function for &ldquo;Cherry&rdquo;: print_r(get_path(&lsquo;Cherry&rsquo;)), you will get an array like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="k">Array</span>  
<span class="p">(</span>  
  <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span><span class="p">;</span> <span class="nx">Food</span>  
  <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span><span class="p">;</span> <span class="nx">Fruit</span>  
  <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span><span class="p">;</span> <span class="nx">Red</span>  
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The advantages of this scheme are obvious: the structure is simple and easy to understand, and since the relationship between them is maintained by a single parent_id, it is very easy to add, delete, and change only the records directly related to it. The disadvantage of course is also very prominent: since the inheritance relationship between nodes is directly recorded, any CRUD operation on the Tree will be inefficient, mainly due to the frequent &ldquo;recursive&rdquo; operations, where the recursive process constantly accesses the database and each database IO has a time overhead. For example, if you want to return all the fruits, that is, all the children nodes of the fruits, a seemingly simple operation, you need to use a bunch of recursion. Of course, this scheme is not useless, when the tree level is relatively small is very practical, based on the neighbor list pattern can also be expanded is a flat table, the difference is the level of the node and the order of the current node is also put into the table, more suitable for similar comments and other scenarios, the specific table structure similar to this, here will not elaborate in depth.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/10bc0de50d7f4365a90e180be69a00c3.png" alt=""></p>
<h2 id="path-enumeration">Path Enumeration</h2>
<p>The materialized path is actually easier to understand, it is actually the full path of the node that is recorded when the node is created. The following figure is an example.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/6b4a78fbd4b84786b48ffa11db48ae27.png" alt=""></p>
<p>The result of storing according to Path Enumeration is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/006e364b99054f818b33bb1787a4a468.png" alt=""></p>
<p>This solution is based on the idea of unix file directories, and mainly trades space for time.</p>
<p>Query all the children nodes under a certain node: (Take Fruit as an example)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;/%&#39;</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>How to query direct child nodes? MySQL regular expression query is needed for.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">REGEXP</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;[0-9]$&#39;</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Query all superiors of any node: (take Yellow as an example).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Yellow&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="n">path</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">path</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Insert additional data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">parent_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pathTree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">pathtree</span><span class="w"> </span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">node_name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">parent_path</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">LAST_INSERT_ID</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;White&#39;</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The disadvantage of this scheme is that the depth of the tree may exceed the length of the PATH field, so the maximum depth it can support is not infinite.</p>
<p>If the number of hierarchies is determined, all columns can be expanded again, as shown below, which is more tried for content with determined hierarchies like administrative divisions, biological taxonomy (boundary, phylum, order, family, genus, species).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/73c2222605b94acd9773fbf79e971c75.png" alt=""></p>
<h2 id="closure-table">Closure Table</h2>
<p>Closure Table is a more thorough full path structure that records the full expansion form of related nodes on the path respectively. It can clarify the relationship between any two nodes without redundant queries, and cascade deletion and node movement are also very convenient. But its storage overhead will be larger, in addition to the Meta information of the nodes, but also need a special relationship table.</p>
<p>The following diagram gives an example of data example.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/c4caac050f124207ad8ad2ceeac1120d.png" alt=""></p>
<p>Create master table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">nodeInfo</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">    </span><span class="n">node_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">node_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">
</span><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Create relationship tables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">nodeRelationship</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">    </span><span class="n">ancestor</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">descendant</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">distance</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span><span class="w"> </span><span class="n">descendant</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>where</p>
<ul>
<li>Ancestor represents an ancestor node</li>
<li>Descendant represents the descendant node</li>
<li>Distance Ancestor is the distance from Descendant</li>
</ul>
<p>Adding data (creating a stored procedure)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="o">`</span><span class="n">AddNode</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">_parent_name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="o">`</span><span class="n">_node_name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_ancestor</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_descendant</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="k">From</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node_name</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="n">_node_name</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">_descendant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node_name</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span><span class="n">descendant</span><span class="p">,</span><span class="n">distance</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="n">_descendant</span><span class="p">,</span><span class="n">_descendant</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parent_name</span><span class="p">)</span><span class="w">
</span><span class="w">        </span><span class="k">THEN</span><span class="w">
</span><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parent_name</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span><span class="n">descendant</span><span class="p">,</span><span class="n">distance</span><span class="p">)</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">ancestor</span><span class="p">,</span><span class="n">_descendant</span><span class="p">,</span><span class="n">distance</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">descendant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parent</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The data in the 2 tables after completion looks roughly like this: (Note: each node has a record to itself.)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/938b3b925ac047b480740946d7fbf629.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/fab1068ab26c45a881a6e5c59ff07f6e.png" alt=""></p>
<p>Query all child nodes under Fruit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w">
</span><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">node_name</span><span class="w">
</span><span class="w"></span><span class="k">FROM</span><span class="w">
</span><span class="w">    </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n1</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">ancestor</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n3</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">descendant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">node_id</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w">
</span><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="w">
</span><span class="w"></span><span class="k">AND</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Query the direct child nodes under Fruit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w">
</span><span class="w">    </span><span class="n">n3</span><span class="p">.</span><span class="n">node_name</span><span class="w">
</span><span class="w"></span><span class="k">FROM</span><span class="w">
</span><span class="w">    </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n1</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">ancestor</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n3</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">descendant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">node_id</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w">
</span><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="w">
</span><span class="w"></span><span class="k">AND</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Query the tier that Fruit is in.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w">
</span><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">node_name</span><span class="w">
</span><span class="w"></span><span class="k">FROM</span><span class="w">
</span><span class="w">    </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n1</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">noderelationship</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n1</span><span class="p">.</span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">descendant</span><span class="w">
</span><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">nodeinfo</span><span class="w"> </span><span class="n">n3</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">n2</span><span class="p">.</span><span class="n">ancestor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n3</span><span class="p">.</span><span class="n">node_id</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w">
</span><span class="w">    </span><span class="n">n1</span><span class="p">.</span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="w">
</span><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span><span class="w">    </span><span class="n">n2</span><span class="p">.</span><span class="n">distance</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>It is also very simple to delete nodes, so I will not elaborate much here.</p>
<h2 id="left-and-right-value-coding-nested-set">Left and Right Value Coding Nested Set</h2>
<p>In general database based applications, the need for queries is always greater than that for deletions and modifications. In order to avoid the &ldquo;recursive&rdquo; process of querying a tree structure, we design a new non-recursive querying, infinitely grouped left and right value encoding scheme based on Tree&rsquo;s preorder traversal to save the data of the tree.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/db17e00de83a457bb57ca1d6d5264ddb.png" alt=""></p>
<p>The first time you see this table structure, I believe most people are not sure how the left value (Lft) and right value (Rgt) are calculated, and this table design does not seem to preserve the inheritance relationship between parent and child nodes. But when you point your finger at the numbers in the table and count from 1 to 18, you should find something, right? Yes, the order in which you move your finger is the order in which the tree is traversed in preorder, as shown in the figure below. When we start from the left side of the root node Food, marked as 1, and along the direction of the traversal of the previous order, in order to mark the numbers on the traversal path, we finally came back to the root node Food, and wrote 18 on the right side.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/e8f26abb511c4a6681cc5abcdb1e0afd.png" alt=""></p>
<p>Based on this design, we can infer that all nodes with left values greater than 2 and right values less than 11 are the successor nodes of Fruit, and the structure of the whole tree is stored by the left and right values. However, this is not enough, our aim is to be able to perform CRUD operations on the tree, i.e., we need to construct the relevant algorithm to go with it. The tree is traversed in depth-first, left-to-right order, and each node is labeled with a left value and a right value starting from 1, and these two values are stored in the corresponding name.</p>
<p><strong>How to query?</strong></p>
<ol>
<li>Get all the children nodes under a node, take Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Get the total number of descendant nodes</li>
</ol>
<p>Total number of children = (right value - left value - 1)/2, take Fruit as an example, its total number of children is: (11-2-1)/2 = 4</p>
<ol start="3">
<li>Get the number of levels the node is at in the tree, taking Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">11</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>Get the path where the current node is located, taking Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">11</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In our daily processing we often also encounter the need to obtain the immediate superior, sibling, or immediate subordinate of a node. To better describe the hierarchical relationship, we can create a view for Tree, adding a hierarchical column whose value can be calculated by writing a custom function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">CountLayer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">_node_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_result</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_lft</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">_rgt</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">Node_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node_id</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">Lft</span><span class="p">,</span><span class="n">Rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node_id</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">_lft</span><span class="p">,</span><span class="n">_rgt</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">_lft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">_rgt</span><span class="p">);</span><span class="w">    
</span><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="n">_result</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">ELSE</span><span class="w">
</span><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>After adding the function, we create an a-view and add the new hierarchical column.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="o">`</span><span class="n">NewView</span><span class="o">`</span><span class="k">AS</span><span class="w"> 
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">Node_id</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Lft</span><span class="p">,</span><span class="w"> </span><span class="n">Rgt</span><span class="p">,</span><span class="w"> </span><span class="n">CountLayer</span><span class="p">(</span><span class="n">Node_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>Get the parent node of the current node, using Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">treeview</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">11</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Layer</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>Get all direct child nodes, taking Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">treeview</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Layer</span><span class="o">=</span><span class="mi">3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>Get all sibling nodes, using Fruit as an example.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">treeview</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">treeview</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">11</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">Layer</span><span class="o">=</span><span class="mi">2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>Return all leaf nodes</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>How to create a tree? How to add data?</strong></p>
<p>The above has described how to retrieve the results, so how can we add new nodes?</p>
<p>The most important thing about Nested set is that there must be a root node as the starting point of all nodes, and usually this node is not used. In order to control the query level, it is recommended to add the parent_id when building the table together with the linked list method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">Tree</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">node_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">parent_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">UNSIGNED</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">lft</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">rgt</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">idx_left_right</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">lft</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">rgt</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">Tree</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">lft</span><span class="p">,</span><span class="n">rgt</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Food&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Add a child node (at the start of the child node). Take the example of adding a child node Fruit under Food.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Food&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">lft</span><span class="p">,</span><span class="w"> </span><span class="n">rgt</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="o">@</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Fruit&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>If you need to append at the end, you need to do the following (for example, add Apple under Red).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Red&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">lft</span><span class="p">,</span><span class="w"> </span><span class="n">rgt</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="o">@</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Add a sibling node after node A (for example, add Green after Yellow)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Yellow&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Tree</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">lft</span><span class="p">,</span><span class="w"> </span><span class="n">rgt</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="o">@</span><span class="n">parent_id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Green&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The above discussion of adding nodes refers to adding end nodes, i.e., the node inserted is not the parent node of the currently existing node. What should we do if we need to insert a non-end node?</p>
<p>The process can be divided into 2 steps: first add a new node, and then move the required node to the lower level of the new node. Node movement method (for example, moving Apple to Yellow).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">nodeId</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">Left</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">Right</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Yellow&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">Left</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">Left</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">parent_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">nodeId</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="k">Left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="k">Left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>delete nodes (including child nodes)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Apple&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">DELETE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>What if I need to delete only that node and the child nodes are automatically moved up one level?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">LOCK</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WRITE</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">node_id</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="n">node_id</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Red&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">parent_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">parent_id</span><span class="w"> </span><span class="k">WHERE</span><span class="w">  </span><span class="n">parent_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">node_id</span><span class="w">
</span><span class="w"></span><span class="k">DELETE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">Where</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myLeft</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">rgt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w">
</span><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Tree</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="n">rgt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgt</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="k">Where</span><span class="w"> </span><span class="n">lft</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">rgt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">myRight</span><span class="w">
</span><span class="w"></span><span class="n">UNLOCK</span><span class="w"> </span><span class="n">TABLES</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The above is the CURD operation of Nested Set, specifically in the use of the recommended combination of transactions and stored procedures together. The advantage of this solution is that it is very convenient to query, but the disadvantage is that each insertion and deletion of data involves too many updates, and if the tree is very large, it may take a long time to insert a piece of data.</p>
<h2 id="interval-nested-nested-intervals">interval nested Nested Intervals</h2>
<p>The previous introduced the left and right value encoding, I wonder if you have noticed that if the data is huge, each update needs to update almost the entire table, less efficient no better way? Today we will study the interval nesting method.</p>
<p><strong>interval nesting method principle</strong></p>
<p>If the node interval [clft, crgt] and [plft, prgt] have the following relationship: plft &lt;= clft and crgt &gt;= prgt, then the points in the interval [clft, crgt] are the children of [plft, prgt]. Based on this assumption, we can obtain new intervals by continuously scribing down the interval. For example, if there is a blank interval [lft1, rgt1] in the interval [plft, prgt], to add an interval of the same level as [plft,lft1], [rgt1,prgt], just insert the nodes: [(2<em>lft1+rgt1)/3, (rgt1+2</em>lft)/3]. After adding the nodes we are left with [lft1,(2<em>lft1+rgt1)/3] and [(rgt1+2</em>lft)/3,rgt1] two free spaces to add more child nodes.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/c77e939337864eccbb8ec25a033317b4.png" alt=""></p>
<p>If we put the intervals in the two-bit plane and treat rgt as the x-axis and lft as the y-axis, then the number of nested intervals is almost like this</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/41c29e46183f417d8215b64f30fdc97e.png" alt=""></p>
<p>Each node [lft, rgt] has children that are contained in y &gt;= lft &amp; x &lt;= rgt. Also the space where y &gt;= clft &amp; x &lt;= crgt is located is a subset of y &gt;= plft &amp; x &lt;= prgt. In addition, since the new right intervals are smaller than the existing left intervals, the new nodes are below the line y = x.</p>
<p><strong>Interval nesting method implementation</strong></p>
<p>After understanding the principle of the interval nesting method, we will consider how to implement it, in principle, the initial interval can use any interval, here we use [0,1] as the root interval.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/36c0d1f00aa44b2082bbba326d14e8da.png" alt=""></p>
<p>First, we define 2 points in the XY plane. Depth-first set point and breadth-finite set point for the point <code>&lt;x=1,y=1/2&gt;</code> with depth-first set point <code>&lt;x=1,y=1&gt;</code> and breadth-first set point <code>&lt;x=1/2,y=1/2&gt;</code>. Next, we define the position of the first child node as the midpoint between the parent node and the depth-first set point. The sibling node is the midpoint from the previous child node to the breadth-first set point, as shown in the figure above, where node 1.2 is at <code>&lt;x=3/4, y=5/8&gt;</code>.</p>
<p>Also looking closely we can see the relationship between the points. Also if we know the sum of x and y, we can invert the value of x,y (what is the exact logic, I haven&rsquo;t figured it out yet either, any of you who know can help explain).</p>
<p>Let&rsquo;s take the node <code>&lt;x=3/4, y=5/8&gt;</code> as an example, we can get his sum to 11/8.</p>
<p>We define 11 as the numerator (numerator) and 8 as the denominator (denominator), then the numerator of point x is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">x_numer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">numer</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">denom</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">(</span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">ret_num</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The denominator of point x is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">x_</span><span class="w"> </span><span class="n">denom</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">numer</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">denom</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">(</span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_num</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">ret_den</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Molecules at point Y.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">y_numer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">x_numer</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">x_denom</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">denom</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">den</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">(</span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Denominator of Y.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">y_denom</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">x_numer</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">x_denom</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">denom</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">den</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">(</span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">num</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">den</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Next, let&rsquo;s test whether X and Y can be decoded.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w">
</span><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">x_numer</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">x_denom</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">y_numer</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">y_denom</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Y</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/20/2917c3a5afdc48429f76f6355bf0637c.png" alt=""></p>
<p>The result is identical to the position of node 1.2 as <code>&lt;x=3/4, y=5/8&gt;</code>. Now we know that only one fraction is needed to represent a point on the plane.</p>
<p>If there is already a fraction 11/8 how do we get the parent of that node? (If the numerator is 3, it means it is the root node)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">parent_numer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">numer</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="n">denom</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">denom</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">((</span><span class="n">ret_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ret_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ret_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">ret_num</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">parent_numer</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">parent_denom</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">parent</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Calculate the position of the current node at the sibling level.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">parent_denom</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">numer</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">numer</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">denom</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">floor</span><span class="p">((</span><span class="n">ret_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ret_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ret_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_den</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">ret_den</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>With the method of querying the parent node and the position of the current node in the same level, the path of the node can be calculated by the combination of these two methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">path</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">numer</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">path</span><span class="p">(</span><span class="n">parent_numer</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">),</span><span class="n">parent_denom</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">))</span><span class="o">||</span><span class="w"> </span><span class="err">‘</span><span class="p">.</span><span class="err">’</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sibling_number</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>After adding the above method and testing, it returns [Err] 1424 - Recursive stored functions and triggers are not allowed. That is, MySQL&rsquo;s custom functions do not support recursive queries.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">path</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">numer_temp</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">denom_temp</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">path_result</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">path_temp</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">sn</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">path_temp</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">numer</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="n">path_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span><span class="w">        </span><span class="k">THEN</span><span class="w">
</span><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="n">path_result</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">sibling_number</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">ELSE</span><span class="w">
</span><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="n">path_result</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">sibling_number</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">),</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">path_temp</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">path_temp</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">path_result</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">numer_temp</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_numer</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">denom_temp</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_denom</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">numer</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">numer_temp</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">denom</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">denom_temp</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">path_result</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The result of SELECT path (11, 8) is 1.2</p>
<p>Calculate the node hierarchy by</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">node_level</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">numer</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">denom</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">numer</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="n">numer</span><span class="o">!=</span><span class="mi">3</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_numer</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret_den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">parent_denom</span><span class="p">(</span><span class="n">numer</span><span class="p">,</span><span class="w"> </span><span class="n">denom</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">numer</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_num</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">denom</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret_den</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We know how to convert the encoded nodes into directory form, how to reverse it? The following is the method.</p>
<p>First add 2 helper functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">child_numer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">num</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">den</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">child</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">child_denom</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">num</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">den</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="o">`</span><span class="n">child</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">den</span><span class="o">*</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>To write the reversal function again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">path_numer</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">path</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">sibling</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">postfix</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">sibling</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">SUBSTR</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">SUBSTR</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">child_numer</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">den</span><span class="p">,</span><span class="n">sibling</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">child_denom</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">den</span><span class="p">,</span><span class="n">sibling</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DEFINER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">root</span><span class="o">`@`</span><span class="n">localhost</span><span class="o">`</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="o">`</span><span class="n">path_denom</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">path</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span><span class="w">
</span><span class="w"> </span><span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="nb">INT</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">sibling</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="k">length</span><span class="p">(</span><span class="k">postfix</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">DO</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">sibling</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">SUBSTR</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="k">postfix</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">SUBSTR</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="k">postfix</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">child_numer</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">den</span><span class="p">,</span><span class="n">sibling</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">den</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">child_denom</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">den</span><span class="p">,</span><span class="n">sibling</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="n">den</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>select CONCAT(path_numer(&lsquo;2.1.3′),'/',path_denom(&lsquo;2.1.3&rsquo;)) The result is 51/64</p>
<p>Reference link.</p>
<ul>
<li><a href="http://salman-w.blogspot.com/2012/08/php-adjacency-list-hierarchy-tree-traversal.html">http://salman-w.blogspot.com/2012/08/php-adjacency-list-hierarchy-tree-traversal.html</a></li>
<li><a href="https://packagist.org/search/?tags=adjacency%20list">https://packagist.org/search/?tags=adjacency%20list</a></li>
<li><a href="https://communities.bmc.com/docs/DOC-9902">https://communities.bmc.com/docs/DOC-9902</a></li>
<li><a href="https://coderwall.com/p/lixing/closure-tables-for-browsing-trees-in-sql">https://coderwall.com/p/lixing/closure-tables-for-browsing-trees-in-sql</a></li>
<li><a href="https://www.sitepoint.com/hierarchical-data-database/">https://www.sitepoint.com/hierarchical-data-database/</a></li>
<li><a href="https://packagist.org/search/?q=Nested+Set">https://packagist.org/search/?q=Nested+Set</a></li>
<li><a href="http://www.rampant-books.com/art_vadim_nested_sets_sql_trees.htm">http://www.rampant-books.com/art_vadim_nested_sets_sql_trees.htm</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2021-11/database-schema/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to understand Schema schema of database</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-11/tokudb/">
            <span class="next-text nav-default">MySQL High Performance Storage Engine TokuDB</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
