<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Building images without Dockerfile: BuildPack vs Dockerfile - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In the past, we have built technology platforms using microservices, containerization, and service orchestration. To improve the efficiency of our development teams, we also provide the CICD platform for rapid deployment of code to Openshift (an enterprise-class Kubernetes) clusters. The first step of deployment is to containerize the application, and the continuous integration deliverables have changed from jar packages, webpack, etc. to container images. Containerization packages the software code and" /><meta name="keywords" content="docker" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-11/buildpack-vs-dockerfile/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Building images without Dockerfile: BuildPack vs Dockerfile" />
<meta property="og:description" content="In the past, we have built technology platforms using microservices, containerization, and service orchestration. To improve the efficiency of our development teams, we also provide the CICD platform for rapid deployment of code to Openshift (an enterprise-class Kubernetes) clusters. The first step of deployment is to containerize the application, and the continuous integration deliverables have changed from jar packages, webpack, etc. to container images. Containerization packages the software code and" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-11/buildpack-vs-dockerfile/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-01T13:27:34+08:00" />
<meta property="article:modified_time" content="2021-11-01T13:27:34+08:00" />

<meta itemprop="name" content="Building images without Dockerfile: BuildPack vs Dockerfile">
<meta itemprop="description" content="In the past, we have built technology platforms using microservices, containerization, and service orchestration. To improve the efficiency of our development teams, we also provide the CICD platform for rapid deployment of code to Openshift (an enterprise-class Kubernetes) clusters. The first step of deployment is to containerize the application, and the continuous integration deliverables have changed from jar packages, webpack, etc. to container images. Containerization packages the software code and"><meta itemprop="datePublished" content="2021-11-01T13:27:34+08:00" />
<meta itemprop="dateModified" content="2021-11-01T13:27:34+08:00" />
<meta itemprop="wordCount" content="1791">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building images without Dockerfile: BuildPack vs Dockerfile"/>
<meta name="twitter:description" content="In the past, we have built technology platforms using microservices, containerization, and service orchestration. To improve the efficiency of our development teams, we also provide the CICD platform for rapid deployment of code to Openshift (an enterprise-class Kubernetes) clusters. The first step of deployment is to containerize the application, and the continuous integration deliverables have changed from jar packages, webpack, etc. to container images. Containerization packages the software code and"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Building images without Dockerfile: BuildPack vs Dockerfile</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-11-01 13:27:34 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1791 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-dockerfile">What is Dockerfile</a>
          <ul>
            <li><a href="#mirror-layering">Mirror layering</a></li>
          </ul>
        </li>
        <li><a href="#what-is-buildpack">What is Buildpack</a>
          <ul>
            <li><a href="#what-is-builder">What is Builder?</a></li>
            <li><a href="#how-buildpack-works">How Buildpack works</a></li>
          </ul>
        </li>
        <li><a href="#buildpack-hands-on">BuildPack Hands-On</a>
          <ul>
            <li><a href="#create-buildpack">Create buildpack</a></li>
            <li><a href="#create-stack">Create stack</a></li>
            <li><a href="#create-builder">Create Builder</a></li>
            <li><a href="#testing">Testing</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the past, we have built technology platforms using microservices, containerization, and service orchestration. To improve the efficiency of our development teams, we also provide the CICD platform for rapid deployment of code to Openshift (an enterprise-class Kubernetes) clusters.</p>
<p>The first step of deployment is to containerize the application, and the continuous integration deliverables have changed from jar packages, webpack, etc. to container images. Containerization packages the software code and all the required components (libraries, frameworks, runtime environments) together so that it can run consistently on any infrastructure in any environment and be &ldquo;isolated&rdquo; from other applications.</p>
<p>Our code needs to go from source to compile to final runnable image and even deployment, all in the CICD pipeline. Initially, we added three files to each code repository, which we also injected into new projects via a project builder (similar to Spring Initializer).</p>
<ul>
<li>Jenkinsfile.groovy: used to define the Jenkins pipeline, and there will be multiple versions for different languages</li>
<li>Manifest YAML: used to define Kubernetes resources, i.e. descriptions of workloads and their operation</li>
<li>Dockerfile: used to build objects</li>
</ul>
<p>These three files also need to evolve as we work. Initially, when there were fewer projects (a dozen or so), our basic team could go to various code repositories to maintain and upgrade them. As projects grew exponentially, the cost of maintenance became higher and higher. We iterated on the CICD platform, moving &ldquo;Jenkinsfile.groovy&rdquo; and &ldquo;manifest YAML&rdquo; out of the project and keeping the less-changed Dockerfile.</p>
<p>As the platform evolves, we need to consider decoupling the only &ldquo;nail households&rdquo;, Dockerfile, from the code, and upgrading it if necessary. So we researched buildpacks and came up with this article today.</p>
<h2 id="what-is-dockerfile">What is Dockerfile</h2>
<p>Docker automatically builds images by reading the instructions in a Dockerfile, which is a text file containing instructions that can be executed by Docker to build images. Let&rsquo;s take the Dockerfile used to test Tekton&rsquo;s Java project as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> openjdk:8-jdk-alpine</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> mkdir /app<span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> target/*.jar /app/app.jar<span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span> <span class="s2">&#34;-c&#34;</span><span class="p">,</span> <span class="s2">&#34;java -Xmx128m -Xms64m -jar app.jar&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="mirror-layering">Mirror layering</h3>
<p>You may have heard that Docker images contain multiple layers. Each layer corresponds to each command in the Dockerfile, such as <code>RUN</code>, <code>COPY</code>, and <code>ADD</code>. Some specific commands will create a new layer, and if some layers do not change during the image build, they will be fetched from the cache.</p>
<p>In the Buildpack below, the image is also layered and cached to speed up the image build.</p>
<h2 id="what-is-buildpack">What is Buildpack</h2>
<p><a href="https://buildpacks.io/">BuildPack</a> is a program that converts source code into a container image that can be run in any cloud environment. Typically buildpack encapsulates an ecological toolchain for a single language. Works with Java, Ruby, Go, NodeJs, Python, etc.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/01/19f3e550bc964741bca190fcf6dcb05b.png" alt=""></p>
<h3 id="what-is-builder">What is Builder?</h3>
<p>A number of buildpacks are combined in order to form <strong>builder</strong>, and in addition to buildpacks, the builder also adds <a href="https://buildpacks.io/docs/concepts/components/lifecycle/">lifecycle</a> and stack container image.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/01/ac0378a458b94452b41c2e88f72cb832.png" alt=""></p>
<p>The stack container image consists of two images: the build image, which is used to run the buildpack, and the run image, which is the base image for building the application image.</p>
<h3 id="how-buildpack-works">How Buildpack works</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/01/52aae245d9d1457d9eb1a9a3c694a1cd.png" alt=""></p>
<p>Each buildpack runtime consists of two phases.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/01/57113fa256df4d9bb81bb43323105f18.png" alt=""></p>
<h4 id="1-detection-phase">1. Detection phase</h4>
<p>Determines if the current buildpack is applicable by checking some specific files/data in the source code. If applicable, it will enter the build phase; otherwise, it will exit. For example.</p>
<ul>
<li>Java maven&rsquo;s buildpack checks if <code>pom.xml</code> is present in the source code</li>
<li>Python&rsquo;s buildpack checks for <code>requirements.txt</code> or <code>setup.py</code> files in the source code.</li>
<li>Node buildpack looks for the <code>package-lock.json</code> file.</li>
</ul>
<h4 id="2-build-phase">2. Build phase</h4>
<p>The following operations are performed during the build phase.</p>
<ol>
<li>set up the build and runtime environments</li>
<li>download the dependencies and compile the source code (if required)</li>
<li>set up the correct entrypoint and startup scripts.</li>
</ol>
<p>For example.</p>
<ul>
<li>Java maven buildpack checks for a <code>pom.xml</code> file and then executes <code>mvn clean install -DskipTests</code>.</li>
<li>Python buildpack checks for <code>requrements.txt</code> and then executes <code>pip install -r requrements.txt</code>.</li>
<li>Node build pack checks for <code>package-lock.json</code> and then executes <code>npm install</code></li>
</ul>
<h2 id="buildpack-hands-on">BuildPack Hands-On</h2>
<p>How do you build an image with builderpack without a Dockerfile? After reading the above, you can basically understand that the core of this is in the writing and use of buildpack.</p>
<p>In fact, there are many open source buildpacks that you can use now, so you don&rsquo;t have to write them manually without a specific customization. For example, here are a few buildpacks that are open source and maintained by major manufacturers.</p>
<ul>
<li><a href="https://github.com/heroku/">Heroku Buildpacks</a></li>
<li><a href="https://github.com/GoogleCloudPlatform/buildpacks">Google Buildpacks</a></li>
<li><a href="https://github.com/paketo-buildpacks">Paketo</a></li>
</ul>
<p>But before we go into detail about open source buildpacks, let&rsquo;s take a deeper look into how Buildpacks work by creating our own buildpack. For testing the project, we&rsquo;ll use <a href="https://github.com/addozhang/tekton-test">Testing Tekton&rsquo;s Java Project</a>.</p>
<p>Everything below is committed to <a href="https://github.com/addozhang/buildpacks-sample">Github</a> and can be accessed at: <a href="https://github.com/addozhang/buildpacks-sample"> https://github.com/addozhang/buildpacks-sample</a> for the code.</p>
<p>The final directory <code>buildpacks-sample </code> is structured as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">├── builders
│   └── builder.toml
├── buildpacks
│   └── buildpack-maven
│       ├── bin
│       │   ├── build
│       │   └── detect
│       └── buildpack.toml
└── stacks
    ├── build
    │   └── Dockerfile
    ├── build.sh
    └── run
        └── Dockerfile
</code></pre></td></tr></table>
</div>
</div><h3 id="create-buildpack">Create buildpack</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">pack buildpack new examples/maven <span class="se">\
</span><span class="se"></span>                         --api 0.5 <span class="se">\
</span><span class="se"></span>                         --path buildpack-maven <span class="se">\
</span><span class="se"></span>                         --version 0.0.1 <span class="se">\
</span><span class="se"></span>                         --stacks io.buildpacks.samples.stacks.bionic
</code></pre></td></tr></table>
</div>
</div><p>Look at the resulting <code>buildpack-maven</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">buildpack-maven
├── bin
│   ├── build
│   └── detect
└── buildpack.toml
</code></pre></td></tr></table>
</div>
</div><p>The default preliminary test data in each file is not very useful. Something needs to be added.</p>
<p><strong><code>bin/detect</code> :</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/usr/bin/env bash
</span><span class="cp"></span>
<span class="k">if</span> <span class="o">[[</span> ! -f pom.xml <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">exit</span> <span class="m">100</span>
<span class="k">fi</span>

<span class="nv">plan_path</span><span class="o">=</span><span class="nv">$2</span>

cat &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">plan_path</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s">[[provides]]
</span><span class="s">name = &#34;jdk&#34;
</span><span class="s">[[requires]]
</span><span class="s">name = &#34;jdk&#34;
</span><span class="s">EOL</span>
</code></pre></td></tr></table>
</div>
</div><p><strong><code>bin/build</code>:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/usr/bin/env bash
</span><span class="cp"></span>
<span class="nb">set</span> -euo pipefail

<span class="nv">layers_dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
<span class="nv">env_dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">/env&#34;</span>
<span class="nv">plan_path</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>

<span class="nv">m2_layer_dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">layers_dir</span><span class="si">}</span><span class="s2">/maven_m2&#34;</span>
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="si">${</span><span class="nv">m2_layer_dir</span><span class="si">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  mkdir -p <span class="si">${</span><span class="nv">m2_layer_dir</span><span class="si">}</span>
  <span class="nb">echo</span> <span class="s2">&#34;cache = true&#34;</span> &gt; <span class="si">${</span><span class="nv">m2_layer_dir</span><span class="si">}</span>.toml
<span class="k">fi</span>
ln -s <span class="si">${</span><span class="nv">m2_layer_dir</span><span class="si">}</span> <span class="nv">$HOME</span>/.m2

<span class="nb">echo</span> <span class="s2">&#34;---&gt; Running Maven&#34;</span>
mvn clean install -B -DskipTests

<span class="nv">target_dir</span><span class="o">=</span><span class="s2">&#34;target&#34;</span>
<span class="k">for</span> jar_file in <span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$target_dir</span><span class="s2">&#34;</span> -maxdepth <span class="m">1</span> -name <span class="s2">&#34;*.jar&#34;</span> -type f<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
  cat &gt;&gt; <span class="s2">&#34;</span><span class="si">${</span><span class="nv">layers_dir</span><span class="si">}</span><span class="s2">/launch.toml&#34;</span> <span class="s">&lt;&lt;EOL
</span><span class="s">[[processes]]
</span><span class="s">type = &#34;web&#34;
</span><span class="s">command = &#34;java -jar ${jar_file}&#34;
</span><span class="s">EOL</span>
  break<span class="p">;</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p><strong><code>buildpack.toml</code> ：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="nx">api</span> <span class="p">=</span> <span class="s2">&#34;0.5&#34;</span>

<span class="p">[</span><span class="nx">buildpack</span><span class="p">]</span>
  <span class="nx">id</span> <span class="p">=</span> <span class="s2">&#34;examples/maven&#34;</span>
  <span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.0.1&#34;</span>

<span class="p">[[</span><span class="nx">stacks</span><span class="p">]]</span>
  <span class="nx">id</span> <span class="p">=</span> <span class="s2">&#34;com.atbug.buildpacks.example.stacks.maven&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="create-stack">Create stack</h3>
<p>To build a Maven project, the preferred environment is Java and Maven, so we use <code>maven:3.5.4-jdk-8-slim</code> as the base image for the build image. The runtime of the application requires a Java environment, so we use <code>openjdk:8-jdk-slim</code> as the base image for the run image.</p>
<p>Create <code>build</code> and <code>run</code> directories in the <code>stacks</code> directory, respectively.</p>
<p><strong><code>build/Dockerfile</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> maven:3.5.4-jdk-8-slim</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">cnb_uid</span><span class="o">=</span><span class="m">1000</span>
<span class="k">ARG</span> <span class="nv">cnb_gid</span><span class="o">=</span><span class="m">1000</span>
<span class="k">ARG</span> stack_id<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">CNB_STACK_ID</span><span class="o">=</span><span class="si">${</span><span class="nv">stack_id</span><span class="si">}</span><span class="err">
</span><span class="err"></span><span class="k">LABEL</span> io.buildpacks.stack.id<span class="o">=</span><span class="si">${</span><span class="nv">stack_id</span><span class="si">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">CNB_USER_ID</span><span class="o">=</span><span class="si">${</span><span class="nv">cnb_uid</span><span class="si">}</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">CNB_GROUP_ID</span><span class="o">=</span><span class="si">${</span><span class="nv">cnb_gid</span><span class="si">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Install packages that we want to make available at both build and run time</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>  apt-get install -y xz-utils ca-certificates <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>  rm -rf /var/lib/apt/lists/*<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Create user and group</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> groupadd cnb --gid <span class="si">${</span><span class="nv">cnb_gid</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>  useradd --uid <span class="si">${</span><span class="nv">cnb_uid</span><span class="si">}</span> --gid <span class="si">${</span><span class="nv">cnb_gid</span><span class="si">}</span> -m -s /bin/bash cnb<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">USER</span><span class="s"> ${CNB_USER_ID}:${CNB_GROUP_ID}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><strong><code>run/Dockerfile</code></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> openjdk:8-jdk-slim</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> stack_id<span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">cnb_uid</span><span class="o">=</span><span class="m">1000</span>
<span class="k">ARG</span> <span class="nv">cnb_gid</span><span class="o">=</span><span class="m">1000</span>
<span class="k">LABEL</span> io.buildpacks.stack.id<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">stack_id</span><span class="si">}</span><span class="s2">&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">USER</span><span class="s"> ${cnb_uid}:${cnb_gid}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Then build out two images using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">STACK_ID</span><span class="o">=</span>com.atbug.buildpacks.example.stacks.maven

docker build --build-arg <span class="nv">stack_id</span><span class="o">=</span><span class="si">${</span><span class="nv">STACK_ID</span><span class="si">}</span> -t addozhang/samples-buildpacks-stack-build:latest ./build
docker build --build-arg <span class="nv">stack_id</span><span class="o">=</span><span class="si">${</span><span class="nv">STACK_ID</span><span class="si">}</span> -t addozhang/samples-buildpacks-stack-run:latest ./run
</code></pre></td></tr></table>
</div>
</div><h3 id="create-builder">Create Builder</h3>
<p>After you have the buildpack and stack, you create the Builder. First, create the <code>builder.toml</code> file and add the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[[</span><span class="nx">buildpacks</span><span class="p">]]</span>
<span class="nx">id</span> <span class="p">=</span> <span class="s2">&#34;examples/maven&#34;</span>
<span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.0.1&#34;</span>
<span class="nx">uri</span> <span class="p">=</span> <span class="s2">&#34;../buildpacks/buildpack-maven&#34;</span>

<span class="p">[[</span><span class="nx">order</span><span class="p">]]</span>
<span class="p">[[</span><span class="nx">order</span><span class="p">.</span><span class="nx">group</span><span class="p">]]</span>
<span class="nx">id</span> <span class="p">=</span> <span class="s2">&#34;examples/maven&#34;</span>
<span class="nx">version</span> <span class="p">=</span> <span class="s2">&#34;0.0.1&#34;</span>

<span class="p">[</span><span class="nx">stack</span><span class="p">]</span>
<span class="nx">id</span> <span class="p">=</span> <span class="s2">&#34;com.atbug.buildpacks.example.stacks.maven&#34;</span>
<span class="nx">run-image</span> <span class="p">=</span> <span class="s2">&#34;addozhang/samples-buildpacks-stack-run:latest&#34;</span>
<span class="nx">build-image</span> <span class="p">=</span> <span class="s2">&#34;addozhang/samples-buildpacks-stack-build:latest&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Then execute the command, <strong>Note that we use the <code>-pull-policy if-not-present</code> parameter here, so we don&rsquo;t need to push the two images of the stack to the mirror repository</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">pack builder create example-builder:latest --config ./builder.toml --pull-policy <span class="k">if</span>-not-present
</code></pre></td></tr></table>
</div>
</div><h3 id="testing">Testing</h3>
<p>Once we have the builder, we can use the created builder to build the image.</p>
<p>The same <code>-pull-policy if-not-present </code> parameter is added here to use the local builder image: <code>-pull-policy if-not-present </code> parameter is added here to use the local builder image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 目录 buildpacks-sample  与 tekton-test 同级，并在 buildpacks-sample  中执行如下命令</span>
pack build addozhang/tekton-test --builder example-builder:latest --pull-policy <span class="k">if</span>-not-present --path ../tekton-test
</code></pre></td></tr></table>
</div>
</div><p>If you see something like the following, it means that the image was built successfully (the first time to build the image due to the need to download maven dependencies may take longer, the subsequent will be faster, you can perform twice to verify the next).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">...
===&gt; EXPORTING
[exporter] Adding 1/1 app layer(s)
[exporter] Reusing layer &#39;launcher&#39;
[exporter] Reusing layer &#39;config&#39;
[exporter] Reusing layer &#39;process-types&#39;
[exporter] Adding label &#39;io.buildpacks.lifecycle.metadata&#39;
[exporter] Adding label &#39;io.buildpacks.build.metadata&#39;
[exporter] Adding label &#39;io.buildpacks.project.metadata&#39;
[exporter] Setting default process type &#39;web&#39;
[exporter] Saving addozhang/tekton-test...
[exporter] *** Images (0d5ac1158bc0):
[exporter]       addozhang/tekton-test
[exporter] Adding cache layer &#39;examples/maven:maven_m2&#39;
Successfully built image addozhang/tekton-test
</code></pre></td></tr></table>
</div>
</div><p>Start the container and you will see that the spring boot application starts normally:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">docker run --rm addozhang/tekton-test:latest
  .   ____          _            __ _ _
 /\\ / ___&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | &#39;_ | &#39;_| | &#39;_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  &#39;  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.2.3.RELEASE)

 ...
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>In fact, there are many open source buildpacks available that you can use without having to write them manually for specific customizations. For example, the following buildpacks are open-sourced and maintained by major manufacturers.</p>
<ul>
<li><a href="https://github.com/heroku/">Heroku Buildpacks</a></li>
<li><a href="https://github.com/GoogleCloudPlatform/buildpacks">Google Buildpacks</a></li>
<li><a href="https://github.com/paketo-buildpacks">Paketo</a></li>
</ul>
<p>The buildpacks libraries above are more comprehensive and may differ slightly in their implementation. For example, Heroku uses shell scripts for its execution phase, while Paketo uses Golang, which is more scalable, supported by the Cloud Foundry Foundation, and has a full-time core development team sponsored by VMware. These small, modular buildpacks can be extended to use different scenarios by combining them.</p>
<p>Of course, it&rsquo;s easier to understand how a buildpack works by writing one yourself.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-11/camerax-extensions-api/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Apply effects to photos using the CameraX Extensions API</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-10/is-ddd-garbage-or-silver-bullet/">
            <span class="next-text nav-default">DDD in the end is garbage or silver bullets</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
