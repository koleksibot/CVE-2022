<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Tips for using the Python network request library Requests - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The Requests library is used to make standard HTTP requests in Python. It abstracts the complexity behind the request into a nice, simple API so you can focus on interacting with the service and using the data in your application. Requests POST/GET parameters Commonly used parameters are listed in the following table. Requests Return object Response common methods Common properties and methods of Response class. 1 2 3 4 5" /><meta name="keywords" content="Python, Requests" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-11/requests-best-practice/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Tips for using the Python network request library Requests" />
<meta property="og:description" content="The Requests library is used to make standard HTTP requests in Python. It abstracts the complexity behind the request into a nice, simple API so you can focus on interacting with the service and using the data in your application. Requests POST/GET parameters Commonly used parameters are listed in the following table. Requests Return object Response common methods Common properties and methods of Response class. 1 2 3 4 5" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-11/requests-best-practice/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-16T22:35:26+08:00" />
<meta property="article:modified_time" content="2021-11-16T22:35:26+08:00" />

<meta itemprop="name" content="Tips for using the Python network request library Requests">
<meta itemprop="description" content="The Requests library is used to make standard HTTP requests in Python. It abstracts the complexity behind the request into a nice, simple API so you can focus on interacting with the service and using the data in your application. Requests POST/GET parameters Commonly used parameters are listed in the following table. Requests Return object Response common methods Common properties and methods of Response class. 1 2 3 4 5"><meta itemprop="datePublished" content="2021-11-16T22:35:26+08:00" />
<meta itemprop="dateModified" content="2021-11-16T22:35:26+08:00" />
<meta itemprop="wordCount" content="2530">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tips for using the Python network request library Requests"/>
<meta name="twitter:description" content="The Requests library is used to make standard HTTP requests in Python. It abstracts the complexity behind the request into a nice, simple API so you can focus on interacting with the service and using the data in your application. Requests POST/GET parameters Commonly used parameters are listed in the following table. Requests Return object Response common methods Common properties and methods of Response class. 1 2 3 4 5"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Tips for using the Python network request library Requests</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-11-16 22:35:26 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2530 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#requests-postget-parameters">Requests POST/GET parameters</a></li>
        <li><a href="#requests-return-object-response-common-methods">Requests Return object Response common methods</a></li>
        <li><a href="#requests-request-failure-retry-settings">Requests Request Failure Retry Settings</a></li>
        <li><a href="#requests-chinese-encoding-garbled-problem">Requests Chinese encoding garbled problem</a></li>
        <li><a href="#downloading-images-or-files-using-requests">Downloading images or files using Requests</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The Requests library is used to make standard HTTP requests in Python. It abstracts the complexity behind the request into a nice, simple API so you can focus on interacting with the service and using the data in your application.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/16/bb9db0ade84c440ab9eda21cfd5eb290.png" alt=""></p>
<h2 id="requests-postget-parameters">Requests POST/GET parameters</h2>
<p>Commonly used parameters are listed in the following table.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/16/f68892995fe14af6b280b1392f2ba22f.png" alt=""></p>
<h2 id="requests-return-object-response-common-methods">Requests Return object Response common methods</h2>
<p>Common properties and methods of Response class.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">Response</span><span class="o">.</span><span class="n">url</span>           <span class="n">请求url</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">status_code</span>   <span class="n">响应状态码</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">text</span>          <span class="n">获取响应内容</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>           <span class="n">活动响应的JSON内容</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">ok</span>            <span class="n">请求是否成功</span><span class="err">，</span><span class="n">status_code</span><span class="o">&lt;</span><span class="mi">400</span> <span class="n">返回True</span>
<span class="n">Response</span><span class="o">.</span><span class="n">headers</span>       <span class="n">响应header信息</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">cookies</span>       <span class="n">响应的cookie</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.1</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">elapsed</span>       <span class="n">请求响应的时间</span><span class="err">。</span>
<span class="n">Response</span><span class="o">.</span><span class="n">links</span>         <span class="n">返回响应头部的links连接</span><span class="err">，</span><span class="n">相当于Response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
<span class="n">Response</span><span class="o">.</span><span class="n">raw</span>           <span class="n">获取原始套接字响应</span><span class="err">，</span><span class="n">需要将初始请求参数stream</span><span class="o">=</span><span class="kc">True</span>
<span class="n">Response</span><span class="o">.</span><span class="n">content</span>        <span class="n">以字节形式获取响应提</span><span class="err">，</span><span class="n">多用于非文本请求</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.2</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">()</span> <span class="n">迭代获取响应数据</span><span class="err">，</span><span class="p">[</span><span class="n">见示例2</span><span class="mf">.2</span><span class="p">]</span>
<span class="n">Response</span><span class="o">.</span><span class="n">history</span>    <span class="n">重定向请求历史记录</span>
<span class="n">Response</span><span class="o">.</span><span class="n">reason</span>        <span class="n">响应状态的文本原因</span><span class="err">，</span><span class="n">如</span><span class="err">：</span><span class="s2">&#34;Not Found&#34;</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span>
<span class="n">Response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    <span class="n">关闭并释放链接</span><span class="err">，</span><span class="n">释放后不能再次访问</span><span class="err">’</span><span class="n">raw</span><span class="err">’</span><span class="n">对象</span><span class="err">。</span><span class="n">一般不会调用</span><span class="err">。</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="requests-request-failure-retry-settings">Requests Request Failure Retry Settings</h2>
<p>When using requests to capture data, we often encounter connection timeout problems, so in order to make the program more robust, we need to implement a failure retry logic for requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">s</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">,</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

<span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://example.com&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>A reading of the source code provides an overview of the implementation mechanism.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">HTTPAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;The built-in HTTP Adapter for urllib3.
</span><span class="s2">    :param max_retries: The maximum number of retries each connection
</span><span class="s2">        should attempt. Note, this applies only to failed DNS lookups, socket
</span><span class="s2">        connections and connection timeouts, never to requests where data has
</span><span class="s2">        made it to the server. By default, Requests does not retry failed
</span><span class="s2">        connections. If you need granular control over the conditions under
</span><span class="s2">        which we retry a request, import urllib3&#39;s ``Retry`` class and pass
</span><span class="s2">        that instead.
</span><span class="s2">    Usage::
</span><span class="s2">      &gt;&gt;&gt; import requests
</span><span class="s2">      &gt;&gt;&gt; s = requests.Session()
</span><span class="s2">      &gt;&gt;&gt; a = requests.adapters.HTTPAdapter(max_retries=3)
</span><span class="s2">      &gt;&gt;&gt; s.mount(&#39;http://&#39;, a)
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">__attrs__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;max_retries&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;_pool_connections&#39;</span><span class="p">,</span> <span class="s1">&#39;_pool_maxsize&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;_pool_block&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_connections</span><span class="o">=</span><span class="n">DEFAULT_POOLSIZE</span><span class="p">,</span>
                 <span class="n">pool_maxsize</span><span class="o">=</span><span class="n">DEFAULT_POOLSIZE</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="n">DEFAULT_RETRIES</span><span class="p">,</span>
                 <span class="n">pool_block</span><span class="o">=</span><span class="n">DEFAULT_POOLBLOCK</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_retries</span> <span class="o">==</span> <span class="n">DEFAULT_RETRIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">Retry</span><span class="o">.</span><span class="n">from_int</span><span class="p">(</span><span class="n">max_retries</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">Retry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Retry configuration.
</span><span class="s2">    Each retry attempt will create a new Retry object with updated values, so
</span><span class="s2">    they can be safely reused.
</span><span class="s2">    Retries can be defined as a default for a pool::
</span><span class="s2">        retries = Retry(connect=5, read=2, redirect=5)
</span><span class="s2">        http = PoolManager(retries=retries)
</span><span class="s2">        response = http.request(&#39;GET&#39;, &#39;http://example.com/&#39;)
</span><span class="s2">    Or per-request (which overrides the default for the pool)::
</span><span class="s2">        response = http.request(&#39;GET&#39;, &#39;http://example.com/&#39;, retries=Retry(10))
</span><span class="s2">    Retries can be disabled by passing ``False``::
</span><span class="s2">        response = http.request(&#39;GET&#39;, &#39;http://example.com/&#39;, retries=False)
</span><span class="s2">    Errors will be wrapped in :class:`~urllib3.exceptions.MaxRetryError` unless
</span><span class="s2">    retries are disabled, in which case the causing exception will be raised.
</span><span class="s2">    :param int total:
</span><span class="s2">        Total number of retries to allow. Takes precedence over other counts.
</span><span class="s2">        Set to ``None`` to remove this constraint and fall back on other
</span><span class="s2">        counts. It&#39;s a good idea to set this to some sensibly-high value to
</span><span class="s2">        account for unexpected edge cases and avoid infinite retry loops.
</span><span class="s2">        Set to ``0`` to fail on the first retry.
</span><span class="s2">        Set to ``False`` to disable and imply ``raise_on_redirect=False``.
</span><span class="s2">    ....
</span><span class="s2">    
</span><span class="s2">    :param iterable method_whitelist:
</span><span class="s2">        Set of uppercased HTTP method verbs that we should retry on.
</span><span class="s2">        By default, we only retry on methods which are considered to be
</span><span class="s2">        indempotent (multiple requests with the same parameters end with the
</span><span class="s2">        same state). See :attr:`Retry.DEFAULT_METHOD_WHITELIST`.
</span><span class="s2">    :param iterable status_forcelist:
</span><span class="s2">        A set of HTTP status codes that we should force a retry on.
</span><span class="s2">        By default, this is disabled with ``None``.
</span><span class="s2">    :param float backoff_factor:
</span><span class="s2">        A backoff factor to apply between attempts. urllib3 will sleep for::
</span><span class="s2">            {backoff factor} * (2 ^ ({number of total retries} - 1))
</span><span class="s2">        seconds. If the backoff_factor is 0.1, then :func:`.sleep` will sleep
</span><span class="s2">        for [0.1s, 0.2s, 0.4s, ...] between retries. It will never be longer
</span><span class="s2">        than :attr:`Retry.BACKOFF_MAX`.
</span><span class="s2">        By default, backoff is disabled (set to 0).
</span><span class="s2">        
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">DEFAULT_METHOD_WHITELIST</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;TRACE&#39;</span><span class="p">])</span>
    <span class="c1">#: Maximum backoff time.</span>
    <span class="n">BACKOFF_MAX</span> <span class="o">=</span> <span class="mi">120</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redirect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">method_whitelist</span><span class="o">=</span><span class="n">DEFAULT_METHOD_WHITELIST</span><span class="p">,</span> <span class="n">status_forcelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">raise_on_redirect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raise_on_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">_observed_errors</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">connect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read</span>
        <span class="k">if</span> <span class="n">redirect</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">redirect</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">raise_on_redirect</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span> <span class="o">=</span> <span class="n">redirect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_forcelist</span> <span class="o">=</span> <span class="n">status_forcelist</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_whitelist</span> <span class="o">=</span> <span class="n">method_whitelist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">=</span> <span class="n">backoff_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_redirect</span> <span class="o">=</span> <span class="n">raise_on_redirect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_status</span> <span class="o">=</span> <span class="n">raise_on_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observed_errors</span> <span class="o">=</span> <span class="n">_observed_errors</span>  <span class="c1"># TODO: use .history instead?</span>
    <span class="k">def</span> <span class="nf">get_backoff_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34; Formula for computing the current backoff
</span><span class="s2">        :rtype: float
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observed_errors</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># 重试算法， _observed_erros就是第几次重试，每次失败这个值就+1.</span>
        <span class="c1"># backoff_factor = 0.1, 重试的间隔为[0.1, 0.2, 0.4, 0.8, ..., BACKOFF_MAX(120)]</span>
        <span class="n">backoff_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observed_errors</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BACKOFF_MAX</span><span class="p">,</span> <span class="n">backoff_value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34; Sleep between retry attempts using an exponential backoff.
</span><span class="s2">        By default, the backoff factor is 0 and this method will return
</span><span class="s2">        immediately.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="n">backoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_backoff_time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">backoff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">backoff</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_forced_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34; Is this method/status code retryable? (Based on method/codes whitelists)
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_whitelist</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_whitelist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_forcelist</span> <span class="ow">and</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_forcelist</span>
<span class="c1"># For backwards compatibility (equivalent to pre-v1.9):</span>
<span class="n">Retry</span><span class="o">.</span><span class="n">DEFAULT</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Retry design is relatively simple, in the HTTPConnectionPool according to the returned exceptions and access methods, distinguish which link failure (connect? read?), and then reduce the corresponding value can be. Then determine whether all the operation retries are zeroed out, and report MaxRetries exception if zeroed out. However, a simple backoff algorithm is used for the interval between each retry.</p>
<p>There are a few points to note when using retry:</p>
<ul>
<li>If you use a simple form such as get, it will retry 3 times by default.</li>
<li>Retries are only retried if there are DNS resolution errors, link errors, link timeouts, and other exceptions. It will not retry if there is a read timeout, write timeout, HTTP protocol error, etc.</li>
<li>Using Retries will cause the error returned to be MaxRetriesError instead of the exact exception.</li>
</ul>
<p>Reference link.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/15431044/can-i-set-max-retries-for-requests-request">Can I set max_retries for requests.request?</a></li>
</ul>
<h2 id="requests-chinese-encoding-garbled-problem">Requests Chinese encoding garbled problem</h2>
<p>When using requests, there are sometimes problems with encoding errors, which are mainly caused by errors in encoding recognition. The most common error that occurs when the content is garbled is the recognition of the encoding as ISO-8859-1.</p>
<p><strong>What is ISO-8859-1?</strong></p>
<p>ISO 8859-1, officially ISO/IEC 8859-1:1998, also known as Latin-1 or &ldquo;Western European Language&rdquo;, is the first 8-bit character set of ISO/IEC 8859 within the International Organization for Standardization. It is based on ASCII, with 96 letters and symbols in the vacant 0xA0-0xFF range for use in Latin alphabetic languages with additional symbols.</p>
<p><strong>Why is recognized as ISO-8859-1?</strong></p>
<p>With the error page, we found that even though the specific encoding of the page was specified in the HTML as follows, the error still occurred.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&#34;Content-Type&#34;</span> <span class="na">content=</span><span class="s">&#34;text/html; charset=utf-8&#34;</span> <span class="nt">/&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>By looking at the source code, we can find that the default encoding recognition logic of Requests is very simple: as long as the server response header can not get the encoding information that the default use of ISO-8859-1, the specific logic can be obtained from the Lib\site-packages\requests\utils.py. file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">get_encoding_from_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Returns encodings from given HTTP Header Dict.
</span><span class="s2">
</span><span class="s2">    :param headers: dictionary to extract encoding from.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">content_type</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;charset&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;charset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&#34;&#39;</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ISO-8859-1&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>From the code can be seen: requires will first look for the HTTP header &ldquo;Content-Type&rdquo; field, if not, the default encoding format is exactly &ldquo;ISO-8859-1&rdquo;. The code does not get the encoding format specified in the HTML page, about such processing, many people also submitted in the official issues <a href="https://github.com/requests/requests/issues/1774">spit</a>, but the author replied is strictly http protocol standard to write this library. HTTP protocol RFC 2616 mentioned, if the HTTP response in the Content-Type field does not specify the charset, the default page is &lsquo;ISO-8859-1&rsquo; encoding.</p>
<blockquote>
<p>When you receive a response, Requests makes a guess at the encoding to use for decoding the response when you call the Response.text method. Requests will first check for an encoding in the HTTP header, and if none is present, will use charade to attempt to guess the encoding.</p>
<p>The only time Requests will not do this is if no explicit charset is present in the HTTP headers and the Content-Type header contains text. In this situation, RFC 2616 specifies that the default charset must be ISO-8859-1. Requests follows the specification in this case. If you require a different encoding, you can manually set the Response.encoding property, or use the raw Response.content.</p>
</blockquote>
<p><strong>How to solve the problem after finding the cause of the messy code?</strong></p>
<p>If you know the explicit encoding, the solution is very simple, just specify the specific encoding.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">resp</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Or to recode the data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>How to get the exact page encoding when the exact encoding is not known?</p>
<p>Actually Requests provides to get the encoding from the HTML content, it is just not used by default, see Lib\site-packages\requests\utils.py:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">get_encodings_from_content</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Returns encodings from given content string.
</span><span class="s2">
</span><span class="s2">    :param content: bytestring to extract encodings from.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span>
        <span class="s1">&#39;In requests 3.0, get_encodings_from_content will be removed. For &#39;</span>
        <span class="s1">&#39;more information, please see the discussion on issue #2266. (This&#39;</span>
        <span class="s1">&#39; warning should only appear once.)&#39;</span><span class="p">),</span>
        <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="n">charset_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;meta.*?charset=[&#34;</span><span class="se">\&#39;</span><span class="s1">]*(.+?)[&#34;</span><span class="se">\&#39;</span><span class="s1">&gt;]&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">pragma_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;meta.*?content=[&#34;</span><span class="se">\&#39;</span><span class="s1">]*;?charset=(.+?)[&#34;</span><span class="se">\&#39;</span><span class="s1">&gt;]&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">xml_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&lt;\?xml.*?encoding=[&#34;</span><span class="se">\&#39;</span><span class="s1">]*(.+?)[&#34;</span><span class="se">\&#39;</span><span class="s1">&gt;]&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">charset_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">pragma_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">xml_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition Requests provides encoding detection using chardet, see models.py:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">apparent_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;The apparent encoding, provided by the chardet library.&#34;&#34;&#34;</span>
    <span class="k">return</span> <span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>For these three approaches, the rate of identification coding and the resources required differ.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">cProfile</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;https://www.biaodianfu.com&#34;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">charset_type</span><span class="p">():</span>
    <span class="n">char_type</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_encoding_from_headers</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">char_type</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">charset_content</span><span class="p">():</span>
    <span class="n">charset_content</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_encodings_from_content</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">charset_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">charset_det</span><span class="p">():</span>
    <span class="n">charset_det</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apparent_encoding</span>
    <span class="k">return</span> <span class="n">charset_det</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cProfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;charset_type()&#34;</span><span class="p">)</span>
    <span class="n">cProfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;charset_content()&#34;</span><span class="p">)</span>
<span class="n">cProfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;charset_det()&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Implementation results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">charset_type</span><span class="p">()</span>                                   <span class="mi">25</span> <span class="n">function</span> <span class="n">calls</span> <span class="ow">in</span> <span class="mf">0.000</span> <span class="n">seconds</span>
<span class="n">charset_content</span><span class="p">()</span>       <span class="mi">2137</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">2095</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">0.007</span> <span class="n">seconds</span>
<span class="n">charset_det</span><span class="p">()</span>       <span class="mi">292729</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">292710</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">0.551</span> <span class="n">seconds</span>
</code></pre></td></tr></table>
</div>
</div><p>The final solution, creating a requests_patch.py file and importing it before the code is used, solves the problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># 以下hack只适合Python2</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="k">def</span> <span class="nf">monkey_patch</span><span class="p">():</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">content</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_content</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">:</span>
            <span class="n">encodings</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_encodings_from_content</span><span class="p">(</span><span class="n">_content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encodings</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encodings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apparent_encoding</span>
            <span class="n">_content</span> <span class="o">=</span> <span class="n">_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">_content</span>
        <span class="k">return</span> <span class="n">_content</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="n">monkey_patch</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>The above code will report TypeError: cannot use a string pattern on a bytes-like object when executed under Python3, mainly because of the non-string data returned by .content in python3. To get the correct encoding under Python, the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># 此hack针对是是Python3</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">charsets</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="n">_charset</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_encoding_from_headers</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_charset</span> <span class="o">==</span> <span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">:</span>
        <span class="n">__charset</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_encodings_from_content</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__charset</span><span class="p">:</span>
            <span class="n">_charset</span> <span class="o">=</span> <span class="n">__charset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_charset</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">apparent_encoding</span>

    <span class="k">return</span> <span class="n">_charset</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="downloading-images-or-files-using-requests">Downloading images or files using Requests</h2>
<p>When using Python for data scraping, sometimes you need to keep files or images, etc. There are various ways to achieve this in Python.</p>
<p>Downloading images or files using <strong>requests</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./image/logo.png&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># Retrieve HTTP meta-data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># 请求获取图片并保存</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="c1"># i.show()  # 查看图片</span>
<span class="c1"># 将图片保存</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;img.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
   <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">():</span>
       <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Use the <strong>urlretrieve</strong> method to download an image or file</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1">#已被淘汰，不建议使用</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.baidu.com/img/superlogo_c4d7df0a003d3db9b65e9ef0fe6da1ec.png&#39;</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;./image/logo.png&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Download images or files using the <strong>wget</strong> method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="c1"># wget是Linux下的一个命令行下载工具，在Python中可通过安装对应包后使用。</span>
<span class="kn">import</span> <span class="nn">wget</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.baidu.com/img/superlogo_c4d7df0a003d3db9b65e9ef0fe6da1ec.png&#39;</span>
<span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;./image/logo.png&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-11/python-error-retry/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python exception retry solution</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-11/python-beautiful-soup/">
            <span class="next-text nav-default">HTML parsing and extraction tool Beautiful Soup</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
