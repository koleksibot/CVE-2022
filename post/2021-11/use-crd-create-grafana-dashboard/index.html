<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Creating a Grafana Dashboard with Kubernetes Resource Objects - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="When we use Grafana Dashboard to display our monitoring charts, we often go to someone else&amp;rsquo;s Dashboard and change it, but this also causes many people using Grafana to have no idea how to customize a Dashboard, although it is not very difficult. Here we introduce a relatively new tool: DARK, full name Dashboards As Resources in Kubernetes., which means that through the Kubernetes resource object to define Grafana Dashboard," /><meta name="keywords" content="Grafana, Kubernetes" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-11/use-crd-create-grafana-dashboard/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Creating a Grafana Dashboard with Kubernetes Resource Objects" />
<meta property="og:description" content="When we use Grafana Dashboard to display our monitoring charts, we often go to someone else&rsquo;s Dashboard and change it, but this also causes many people using Grafana to have no idea how to customize a Dashboard, although it is not very difficult. Here we introduce a relatively new tool: DARK, full name Dashboards As Resources in Kubernetes., which means that through the Kubernetes resource object to define Grafana Dashboard," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-11/use-crd-create-grafana-dashboard/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-22T19:33:50+08:00" />
<meta property="article:modified_time" content="2021-11-22T19:33:50+08:00" />

<meta itemprop="name" content="Creating a Grafana Dashboard with Kubernetes Resource Objects">
<meta itemprop="description" content="When we use Grafana Dashboard to display our monitoring charts, we often go to someone else&rsquo;s Dashboard and change it, but this also causes many people using Grafana to have no idea how to customize a Dashboard, although it is not very difficult. Here we introduce a relatively new tool: DARK, full name Dashboards As Resources in Kubernetes., which means that through the Kubernetes resource object to define Grafana Dashboard,"><meta itemprop="datePublished" content="2021-11-22T19:33:50+08:00" />
<meta itemprop="dateModified" content="2021-11-22T19:33:50+08:00" />
<meta itemprop="wordCount" content="817">
<meta itemprop="keywords" content="grafana,kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creating a Grafana Dashboard with Kubernetes Resource Objects"/>
<meta name="twitter:description" content="When we use Grafana Dashboard to display our monitoring charts, we often go to someone else&rsquo;s Dashboard and change it, but this also causes many people using Grafana to have no idea how to customize a Dashboard, although it is not very difficult. Here we introduce a relatively new tool: DARK, full name Dashboards As Resources in Kubernetes., which means that through the Kubernetes resource object to define Grafana Dashboard,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Creating a Grafana Dashboard with Kubernetes Resource Objects</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-11-22 19:33:50 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 817 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>When we use Grafana Dashboard to display our monitoring charts, we often go to someone else&rsquo;s Dashboard and change it, but this also causes many people using Grafana to have no idea how to customize a Dashboard, although it is not very difficult. Here we introduce a relatively new tool: <a href="https://github.com/K-Phoen/dark">DARK</a>, full name <code>Dashboards As Resources in Kubernetes.</code>, which means that through the Kubernetes resource object to define Grafana Dashboard, the implementation principle is also very simple, that is, the CRD to define the Dashboard, and then through the interaction with Grafana&rsquo;s API Token to achieve the CRUD of the Dashboard.</p>
<p>Let&rsquo;s look at how to use <code>DARK</code> to define a Grafana Dashboard.</p>
<p>First Clone the project code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git clone https://github.com/K-Phoen/dark.git
</code></pre></td></tr></table>
</div>
</div><p>Then install the CRD resources</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f k8s/crd.yaml
</code></pre></td></tr></table>
</div>
</div><p>Then create Grafana&rsquo;s API KEYS from the Secret object. In the Grafana main interface, select the Configuration menu on the left -&gt; <code>API Keys</code> to create API Keys, and select the <code>Editor</code> role to.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/22/9505a9d15af24199960f6398ad76bdb6.png" alt=""></p>
<p>Once created, a dialog box will pop up with the corresponding <code>API Keys</code>, use this KEY to create a corresponding Secret object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl create secret generic dark-tokens --from-literal<span class="o">=</span><span class="nv">grafana</span><span class="o">=</span>&lt;替换成APIKEY&gt;
</code></pre></td></tr></table>
</div>
</div><p>Then modify the <code>k8s/cluster-role.yaml</code> file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboards-viewer</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;k8s.kevingomez.fr&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;grafanadashboards&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;events&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;patch&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboards-viewer-cluster</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboards-viewer</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Then create the resource object above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f k8s/cluster-role.yaml
</code></pre></td></tr></table>
</div>
</div><p>Modify the <code>k8s/deployment.yaml</code> file, change the <code>GRAFANA_HOST</code> environment variable to your own Grafana address, and since I have Grafana installed in the Kubernetes cluster here, I directly configure it with DNS, and then add the <code>dark</code> created above ServiceAccount.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark-tokens</span><span class="w">
</span><span class="w">        </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">dark-tokens</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kphoen/dark:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GRAFANA_HOST</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">http://grafana.kube-mon:3000</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GRAFANA_TOKEN</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dark-tokens</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Create the above Controller directly after the modification is completed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f k8s/deployment.yaml
$ kubectl get pods -l <span class="nv">app</span><span class="o">=</span>dark
NAME                    READY   STATUS    RESTARTS   AGE
dark-6bd956b8d6-755p2   1/1     Running   <span class="m">0</span>          36m
</code></pre></td></tr></table>
</div>
</div><p>Now that the Controller is defined, we can actually go through the CRD object to define the Grafana Dashboard, as shown below to define a <code>GrafanaDashboard</code> object, in which we can define the content according to our needs, such as defining <code>annotations</code>, <code> variables</code>, <code>graph</code>, <code>table</code> can be defined, but of course the most important thing is to have the correct data source and query statement: (example-dashboards.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">k8s.kevingomez.fr/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">GrafanaDashboard</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-dashboard</span><span class="w">
</span><span class="w"></span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Test folder&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Awesome dashboard</span><span class="w">
</span><span class="w">  </span><span class="nt">editable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">shared_crosshair</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">generated, yaml]</span><span class="w">
</span><span class="w">  </span><span class="nt">auto_refresh</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span><span class="w">  </span><span class="nt">tags_annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Deployments</span><span class="w">
</span><span class="w">      </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Prometheus&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;#5794F2&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;deploy&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;production&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">interval</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">interval</span><span class="w">
</span><span class="w">        </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">Interval</span><span class="w">
</span><span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;30s&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1m&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;5m&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;10m&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;30m&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;1h&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;6h&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;12h&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span>- <span class="nt">query</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">status</span><span class="w">
</span><span class="w">        </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP status</span><span class="w">
</span><span class="w">        </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">        </span><span class="nt">request</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;label_values(prometheus_http_requests_total, code)&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">const</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">percentile</span><span class="w">
</span><span class="w">        </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">Percentile</span><span class="w">
</span><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">values_map</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">50th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">75th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;75&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">80th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;80&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">85th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;85&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">90th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;90&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">95th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;95&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">99th</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;99&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">custom</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vX</span><span class="w">
</span><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">        </span><span class="nt">values_map</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">v1</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">          </span><span class="nt">v2</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">  </span><span class="nt">rows</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">      </span><span class="nt">panels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">graph</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP Rate</span><span class="w">
</span><span class="w">            </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l">400px</span><span class="w">
</span><span class="w">            </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">            </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rate(promhttp_metric_handler_requests_total[$interval])&#34;</span><span class="w">
</span><span class="w">                  </span><span class="nt">legend</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{handler}} - {{ code }}&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">graph</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Heap allocations</span><span class="w">
</span><span class="w">            </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l">400px</span><span class="w">
</span><span class="w">            </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">            </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;go_memstats_heap_alloc_bytes&#34;</span><span class="w">
</span><span class="w">                  </span><span class="nt">legend</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{job}}&#34;</span><span class="w">
</span><span class="w">                  </span><span class="nt">ref</span><span class="p">:</span><span class="w"> </span><span class="l">A</span><span class="w">
</span><span class="w">        </span>- <span class="nt">table</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Threads</span><span class="w">
</span><span class="w">            </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">            </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;go_threads&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">hidden_columns</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;Time&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">            </span><span class="nt">time_series_aggregations</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">AVG</span><span class="w">
</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">avg</span><span class="w">
</span><span class="w">              </span>- <span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">Current</span><span class="w">
</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">current</span><span class="w">
</span><span class="w">        </span>- <span class="nt">single_stat</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Heap Allocations</span><span class="w">
</span><span class="w">            </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="l">Prometheus</span><span class="w">
</span><span class="w">            </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;go_memstats_heap_alloc_bytes{job=&#34;prometheus&#34;}&#39;</span><span class="w">
</span><span class="w">            </span><span class="nt">unit</span><span class="p">:</span><span class="w"> </span><span class="l">bytes</span><span class="w">
</span><span class="w">            </span><span class="nt">thresholds</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;26000000&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;28000000&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">            </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;value&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Some text, because it might be useful&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">panels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">text</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Some awesome text?</span><span class="w">
</span><span class="w">            </span><span class="nt">markdown</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Markdown syntax help: [commonmark.org/help](https://commonmark.org/help/)\n${percentile}&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">text</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l">Some awesome html?</span><span class="w">
</span><span class="w">            </span><span class="nt">html</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Some &lt;b&gt;awesome&lt;/b&gt; html?&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Again, create the above example file directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f example-dashboards.yaml
$ kubectl get dashboards
NAME                AGE
example-dashboard   35m
$ kubectl logs -f dark-6bd956b8d6-755p2
W0327 11:10:24.356194       <span class="m">1</span> client_config.go:543<span class="o">]</span> Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
I0327 11:10:24.360886       <span class="m">1</span> controller.go:87<span class="o">]</span> Setting up event handlers
I0327 11:10:24.362305       <span class="m">1</span> controller.go:118<span class="o">]</span> Starting dark-controller
I0327 11:10:24.362341       <span class="m">1</span> controller.go:121<span class="o">]</span> Waiting <span class="k">for</span> informer caches to sync
I0327 11:10:24.462733       <span class="m">1</span> controller.go:126<span class="o">]</span> Starting workers
I0327 11:10:24.462820       <span class="m">1</span> controller.go:132<span class="o">]</span> Started workers
I0327 11:13:22.641706       <span class="m">1</span> controller.go:197<span class="o">]</span> Successfully synced <span class="s1">&#39;default/example-dashboard&#39;</span>
I0327 11:13:22.643061       <span class="m">1</span> event.go:278<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="s2">&#34;GrafanaDashboard&#34;</span>, Namespace:<span class="s2">&#34;default&#34;</span>, Name:<span class="s2">&#34;example-dashboard&#34;</span>, UID:<span class="s2">&#34;efc6f96f-c7fc-40b5-8b8f-831a95b0a042&#34;</span>, APIVersion:<span class="s2">&#34;k8s.kevingomez.fr/v1&#34;</span>, ResourceVersion:<span class="s2">&#34;48490732&#34;</span>, FieldPath:<span class="s2">&#34;&#34;</span><span class="o">})</span>: type: <span class="s1">&#39;Normal&#39;</span> reason: <span class="s1">&#39;Synced&#39;</span> GrafanaDashboard synced successfully
</code></pre></td></tr></table>
</div>
</div><p>You can also see the corresponding logging information in the Controller. After the resource object is created successfully, you can now check the Grafana page to see that a new <code>Test folder</code> folder and <code>Awesome dashboard</code> have been added.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/22/63405cebd6fb4233ac565d611f798c04.png" alt=""></p>
<p>Looking at the Dashboard, you can see the same information as the various charts defined in the CRD above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/11/22/e25604eaf05647f0bb35f028098d2858.png" alt=""></p>
<p>This way we define the Grafana Dashboard using Kubernetes resource objects, which is obviously more elegant than going directly to the page and configuring it manually, and is in line with the <code>everything as code</code> idea 🤯.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/grafana/">grafana</a>
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-11/alertmanager-when-alert/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">AlertManager When to Alert</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-11/envoy-usage-demo/">
            <span class="next-text nav-default">Envoy simple example</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
