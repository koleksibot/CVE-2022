<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Metaclass in Python 3 - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In the Python programming language, most classes are used to generate objects: when you call these classes, they return an Instance of the class to the caller. For example, if you call a Student class that defines the various actions required of a student, we get a new instance of Student, which seems very natural. One of the core ideas of the OOP language is inheritance, i.e. if I had" /><meta name="keywords" content="python, Metaclass" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/python-metaclass/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Metaclass in Python 3" />
<meta property="og:description" content="In the Python programming language, most classes are used to generate objects: when you call these classes, they return an Instance of the class to the caller. For example, if you call a Student class that defines the various actions required of a student, we get a new instance of Student, which seems very natural. One of the core ideas of the OOP language is inheritance, i.e. if I had" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/python-metaclass/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-03T09:44:47+08:00" />
<meta property="article:modified_time" content="2022-03-03T09:44:47+08:00" />

<meta itemprop="name" content="Metaclass in Python 3">
<meta itemprop="description" content="In the Python programming language, most classes are used to generate objects: when you call these classes, they return an Instance of the class to the caller. For example, if you call a Student class that defines the various actions required of a student, we get a new instance of Student, which seems very natural. One of the core ideas of the OOP language is inheritance, i.e. if I had"><meta itemprop="datePublished" content="2022-03-03T09:44:47+08:00" />
<meta itemprop="dateModified" content="2022-03-03T09:44:47+08:00" />
<meta itemprop="wordCount" content="1607">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Metaclass in Python 3"/>
<meta name="twitter:description" content="In the Python programming language, most classes are used to generate objects: when you call these classes, they return an Instance of the class to the caller. For example, if you call a Student class that defines the various actions required of a student, we get a new instance of Student, which seems very natural. One of the core ideas of the OOP language is inheritance, i.e. if I had"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Metaclass in Python 3</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-03 09:44:47 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1607 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#start-with-inheritance">Start with inheritance</a></li>
        <li><a href="#class-creation">Class creation</a></li>
        <li><a href="#using-metaclasses">Using metaclasses</a>
          <ul>
            <li><a href="#one-small-thing">One small thing</a></li>
            <li><a href="#factory-metaclasses">Factory metaclasses</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the Python programming language, most classes are used to generate <em>objects</em>: when you call these classes, they return an <strong>Instance</strong> of the class to the caller. For example, if you call a Student class that defines the various actions required of a student, we get a new instance of Student, which seems very natural.</p>
<p>One of the core ideas of the <strong>OOP</strong> language is <em>inheritance</em>, i.e. if I had several classes like Student and wanted to add some common functionality to them at the same time, we would choose to create base classes and then modify the definitions of those classes to make them subclasses of that base class. And <strong>Metaclass</strong>, as the name implies, means &ldquo;class that creates classes&rdquo; - we use it when we want to have more control over the <em>creation process</em> of a series of classes.</p>
<p>This article is another blog post in the Chinese Internet world that explains metaclasses in Python. If this is the first article you&rsquo;ve seen on the subject, or if you&rsquo;re jumping from another article, I hope this article opens up a whole new perspective on metaclasses for you.</p>
<blockquote>
<p>Base classes define the generic functionality of a set of classes, while metaclasses control the creation of a set of classes.</p>
<p>The difference between Metaclass and Baseclass</p>
</blockquote>
<h2 id="start-with-inheritance">Start with inheritance</h2>
<p>To understand the meaning of Metaclass, let&rsquo;s start with <strong>Inheritance</strong>. As a fundamental concept provided by almost every object-oriented programming language, the inheritance operation means that one object (subclass) acquires a set of characteristics from another object (base class).</p>
<p>For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">People</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">People</span><span class="p">):</span>
    <span class="n">grade</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above example, all People objects have the age property. The subclass Student, in addition to the age property, also has the grade property. This is inheritance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">Student</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">Student</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">grade</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://www.python.org/download/releases/2.3/mro/">Starting with Python 2.3</a>, the Python programming language uses a method known as the &ldquo;C3 algorithm&rdquo; to determine a class&rsquo;s <strong>MRO</strong> (Method Resolution Order). The MRO of a class determines the inheritance order of the class and the order in which we should look up the base class when we call a method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">Student</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">__main__</span><span class="o">.</span><span class="n">Student</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">People</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="nb">object</span><span class="s1">&#39;&gt;)</span>
</code></pre></td></tr></table>
</div>
</div><p>The MRO of a class is a property of the class <em>itself</em>, not a property of an <em>instance</em> of the class.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">Student</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&#34;&lt;stdin&gt;&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s1">&#39;Student&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;__mro__&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="class-creation">Class creation</h2>
<p>Sometimes we want to control the <em>creation</em> process of a class. The simplest example is that we want a call to the Student class&rsquo;s factory, StudentFactory, to return a Student object instead of a StudentFactory object, as we define it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">StudentFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above example, we override the <code>__new__</code> method of the StudentFactory class so that whenever we pass a student&rsquo;s properties into the StudentFactory class, the class returns a newly created instance of Student.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">StudentFactory</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">Student</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">grade</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Similarly, for the People method we can construct a similar factory class to enable fast construction of People-type objects. Let&rsquo;s put the two Factory classes together.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">PeopleFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">People</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

<span class="k">class</span> <span class="nc">StudentFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
</code></pre></td></tr></table>
</div>
</div><p>The part with differences is already reflected in bold font. In fact, we can see that the difference between the two classes is really small. If there are not one or two but ten or twenty similar factory classes, we have to write a lot of repetitive code. Is there any way to generate similar factory classes in bulk? The answer is to use <strong>metaclasses</strong> .</p>
<h2 id="using-metaclasses">Using metaclasses</h2>
<p>The basic idea of using metaclasses is to first find the <em>pattern</em> of the class that needs to be built. As in the above example, the factory class for each dataclass differs only in the type variable in the <code>__new__</code> function, but all the rest is the same. Thus, the task we need to accomplish with the constructed metaclass MetaFactory is clear.</p>
<ul>
<li>
<p>For each concrete factory class that specifies a metaclass as MetaFactory, you need to define a variable of your own, let&rsquo;s call it <code>_instance</code>. This variable should be the object that this specific factory class uses to produce. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">StudentFactory</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaFactory</span><span class="p">):</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="n">Student</span> <span class="c1"># StudentFactory 用来生产 Student</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>We want to get the object (Student) of the corresponding instance type when we call a concrete factory class (like StudentFactory). As we learned above, this is done by overriding the <code>__new__</code> function of the StudentFactory class.</p>
</li>
<li>
<p>MetaFactory needs to overload its own <code>__new__</code> function for each factory class.</p>
</li>
</ul>
<p>At this point, the role of the metaclass MetaFactory is clear: it is responsible for generating concrete factory classes based on requirements. The &ldquo;requirements&rdquo; are the <code>_instance</code> objects that we define in each concrete factory class. A metaclass is a class that has the ability to generate a <em>concrete class</em>.</p>
<h3 id="one-small-thing">One small thing</h3>
<p>Wait! We still have one little problem left to solve: above, we used the <code>object.__new__(Student)</code> method to create a Student <strong>object</strong> . For the metaclass, it needs to create <strong>classes</strong> instead of class objects. How should this be done?</p>
<p>We already know that there is a simple way to create classes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">This_Is_A_Class</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s2">&#34;xxx&#34;</span>
    <span class="k">def</span> <span class="nf">who_am_i</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&#34;I am a class&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above class definition, which we are already very familiar with, it is actually composed of three parts marked with underscores.</p>
<ul>
<li>The name of the class: <code>This_Is_A_Class</code>, a string</li>
<li>the list of base classes of the class: in this case the class <code>object</code>, which may be omitted depending on the actual situation, or there may be multiple classes (i.e. multiple inheritance), so the list should be an ordered unmodifiable sequence (tuple)</li>
<li>Class properties: Whether the class defines variable properties (here <code>a=&quot;xxx&quot;</code>) or class methods (<code>who_am_i</code>), these elements are part of the class properties. Because we can access these elements directly through the <code>class_name. property name</code> method to access these members. The list of properties is a key-value pair, represented using Python&rsquo;s dictionary type</li>
</ul>
<p>In fact, Python provides us with another way to create classes. The above method is equivalent to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">This_Is_A_Class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
    <span class="s2">&#34;This_Is_A_Class&#34;</span><span class="p">,</span>
    <span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">{</span>
        <span class="s2">&#34;a&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span><span class="p">,</span>
        <span class="s2">&#34;who_am_i&#34;</span><span class="p">:</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;I am a class&#34;</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The built-in function <code>type(name, bases, namespaces)</code> takes three arguments: <code>name</code> is a string representing the name of the class to be defined; <code>bases</code> is a tuple representing a list of base classes; <code>namespaces</code> is an attribute (namespace) of the class; this function returns the instance of the class itself and assigns it to <code>This_Is_A_Class</code>.</p>
<p>Regardless of which of the above methods is used to define the class, the following code is executed with the same effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">This_Is_A_Class</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">__main__</span><span class="o">.</span><span class="n">This_Is_A_Class</span><span class="s1">&#39;&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>All can return the class itself (and not an instance of the class).</p>
<h3 id="factory-metaclasses">Factory metaclasses</h3>
<p>Let&rsquo;s return to the MetaFactory class discussion from earlier. metaclass must have the ability to return a concrete class, which is achieved through inert evaluation with the <code>__new__</code> method of the metaclass: when a concrete class with a specified metaclass is to be used, the following parameters are passed to the <code>__new__</code> method of the metaclass, if the concrete class itself has not already been computed method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="fm">__new__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>These are the parameters needed to call the <code>type()</code> function to create a new class. But the factory class must change <code>namespaces</code> before creating the new class: it needs to override the corresponding <code>__new__</code> method for the concrete class. The full MetaFactory definition looks like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">MetaFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">factory_new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">namespaces</span><span class="p">[</span><span class="s2">&#34;_instance&#34;</span><span class="p">]</span>
        <span class="n">namespaces</span><span class="p">[</span><span class="s2">&#34;__new__&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">factory_new</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>where <code>__new__</code> is the constructor of the metafactory class itself, and <code>factory_new</code> is the <code>__new__</code> function provided by the metafactory class for the concrete factory class, just like the <code>__new__</code> function in StudentFactory that we implemented in the first half of the article, but with the type part replaced with <code>cls._ instance</code> to accommodate the different concrete types.</p>
<p>Note in particular that if the metaclass inherits from the <code>type</code> class, the last line in the <code>__new__</code> method needs to be written as <code>return type.__new__(cls, name, bases, namespaces)</code>, otherwise there will be some strange problems, don&rsquo;t ask me how I know this.</p>
<p>The complete program code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">MetaFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">factory_new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">namespaces</span><span class="p">[</span><span class="s2">&#34;_instance&#34;</span><span class="p">]</span>
        <span class="n">namespaces</span><span class="p">[</span><span class="s2">&#34;__new__&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">factory_new</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">People</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">People</span><span class="p">):</span>
    <span class="n">grade</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">PeopleFactory</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaFactory</span><span class="p">):</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="n">People</span>

<span class="k">class</span> <span class="nc">StudentFactory</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaFactory</span><span class="p">):</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="n">Student</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s call StudentFactory and verify that.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="o">&gt;&gt;&gt;</span> <span class="n">StudentFactory</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">Student</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">grade</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s so cool!</p>
<h2 id="summary">Summary</h2>
<p>Metaclasses are classes that are used to generate concrete classes. In contrast to <em>inheritance</em>, which adds base functionality to a class, <em>metaclasses</em> control the class creation process. According to the Python documentation, some possible use cases for metaclasses include: enumeration types, logging classes, type checkers, automatic delegation, proxy patterns, framework building, and automatic resource locking/synchronization logic.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/git-merge-intro/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A deeper understanding of git merge operations</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/http-host-header-attack/">
            <span class="next-text nav-default">HTTP Host Header Attack - Study Notes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
