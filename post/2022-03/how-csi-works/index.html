<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A Brief Analysis of How CSI Works - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Recently, I have been doing CSI-related work, and as I have been developing it, I have come to believe that the details of CSI are quite tedious. By organizing the CSI workflow, I can deepen my understanding of CSI and share my knowledge of CSI with you.
I will introduce CSI through two articles, the first of which will focus on the basic components and workings of CSI, based on Kubernetes as the COs (Container Orchestration Systems) for CSI." /><meta name="keywords" content="CSI" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/how-csi-works/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="A Brief Analysis of How CSI Works" />
<meta property="og:description" content="Recently, I have been doing CSI-related work, and as I have been developing it, I have come to believe that the details of CSI are quite tedious. By organizing the CSI workflow, I can deepen my understanding of CSI and share my knowledge of CSI with you.
I will introduce CSI through two articles, the first of which will focus on the basic components and workings of CSI, based on Kubernetes as the COs (Container Orchestration Systems) for CSI." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/how-csi-works/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-10T08:49:09+08:00" />
<meta property="article:modified_time" content="2022-03-10T08:49:09+08:00" />

<meta itemprop="name" content="A Brief Analysis of How CSI Works">
<meta itemprop="description" content="Recently, I have been doing CSI-related work, and as I have been developing it, I have come to believe that the details of CSI are quite tedious. By organizing the CSI workflow, I can deepen my understanding of CSI and share my knowledge of CSI with you.
I will introduce CSI through two articles, the first of which will focus on the basic components and workings of CSI, based on Kubernetes as the COs (Container Orchestration Systems) for CSI."><meta itemprop="datePublished" content="2022-03-10T08:49:09+08:00" />
<meta itemprop="dateModified" content="2022-03-10T08:49:09+08:00" />
<meta itemprop="wordCount" content="2729">
<meta itemprop="keywords" content="csi," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Brief Analysis of How CSI Works"/>
<meta name="twitter:description" content="Recently, I have been doing CSI-related work, and as I have been developing it, I have come to believe that the details of CSI are quite tedious. By organizing the CSI workflow, I can deepen my understanding of CSI and share my knowledge of CSI with you.
I will introduce CSI through two articles, the first of which will focus on the basic components and workings of CSI, based on Kubernetes as the COs (Container Orchestration Systems) for CSI."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A Brief Analysis of How CSI Works</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-10 08:49:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2729 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-components-of-csi">Basic components of CSI</a>
          <ul>
            <li><a href="#sidecar-components">SideCar components</a></li>
            <li><a href="#third-party-plugins">Third-party plugins</a></li>
          </ul>
        </li>
        <li><a href="#workflow">Workflow</a>
          <ul>
            <li><a href="#provision">Provision</a></li>
            <li><a href="#attach">Attach</a></li>
            <li><a href="#mount">Mount</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, I have been doing CSI-related work, and as I have been developing it, I have come to believe that the details of CSI are quite tedious. By organizing the CSI workflow, I can deepen my understanding of CSI and share my knowledge of CSI with you.</p>
<p>I will introduce CSI through two articles, the first of which will focus on the basic components and workings of CSI, based on Kubernetes as the COs (Container Orchestration Systems) for CSI. The second article will take a few typical CSI projects and analyze the specific implementation.</p>
<h2 id="basic-components-of-csi">Basic components of CSI</h2>
<p>There are two types of CSI cloud providers, one of in-tree type and one of out-of-tree type. The former is a storage plugin that runs inside the k8s core component; the latter is a storage plugin that runs independently of the k8s component. This article focuses on the out-of-tree type of plugins.</p>
<p>The out-of-tree type of plug-in interacts with k8s components through the gRPC interface, and k8s provides a number of SideCar components to work with CSI plug-ins to achieve rich functionality. For out-of-tree plugins, the components used are divided into SideCar components and plugins that need to be implemented by third parties.</p>
<h3 id="sidecar-components">SideCar components</h3>
<h4 id="external-attacher">external-attacher</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/e9676d27f0764063b3c810d704c751d2.png" alt="external-attacher"></p>
<p>Listens to the VolumeAttachment object and calls the <code>ControllerPublishVolume</code> and <code>ControllerUnpublishVolume</code> interfaces of the CSI driver Controller service to attach and remove volumes to and from the node.</p>
<p>This component is needed if the storage system requires the attach/detach step, as the K8s internal Attach/Detach Controller does not call the CSI driver interface directly.</p>
<h4 id="external-provisioner">external-provisioner</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/ae1792673715435c9faf501692a3e681.png" alt="external-provisioner"></p>
<p>Provided that the provisioner field of the StorageClass specified in the PVC is the same as the return value of the <code>CreateVolume</code> and <code>DeleteVolume</code> interfaces of the CSI driver Controller service. The <code>GetPluginInfo</code> interface of the Identity service returns the same value. Once the new volume is provisioned, K8s will create the corresponding PV.</p>
<p>If the recycling policy of the PV bound to the PVC is delete, then the external-provisioner component listens for the deletion of the PVC and calls the <code>DeleteVolume</code> interface of the CSI driver Controller service. Once the volume is deleted successfully, the component will also delete the corresponding PV.</p>
<p>The component also supports the creation of data sources from snapshots. If the Snapshot CRD data source is specified in the PVC, the component will get information about the snapshot through the <code>SnapshotContent</code> object and pass this content to the CSI driver when calling the <code>CreateVolume</code> interface, and the CSI driver will need to create the volume based on the data source snapshot.</p>
<h4 id="external-resizer">external-resizer</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/bf5ca1d3c92947f09a4a192acc8f9ee9.png" alt="external-resizer"></p>
<p>Listens to the PVC object and if the user requests more storage on the PVC object, the component calls the <code>NodeExpandVolume</code> interface of the CSI driver Controller service, which is used to expand the volume.</p>
<h4 id="external-snapshotter">external-snapshotter</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/7a001f4ea8c14c36ab8eb28efb1ac42b.png" alt="external-snapshotter"></p>
<p>This component is used in conjunction with the Snapshot Controller, which creates the corresponding VolumeSnapshotContent based on the Snapshot objects created in the cluster, and the external-snapshotter, which listens to the VolumeSnapshotContent object. When the VolumeSnapshotContent is listened to, the corresponding parameter is passed to the CSI driver Controller service via <code>CreateSnapshotRequest</code> to invoke its <code>CreateSnapshot</code> interface. This component is also responsible for calling the <code>DeleteSnapshot</code> and <code>ListSnapshots</code> interfaces.</p>
<h4 id="livenessprobe">livenessprobe</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/818fc7068a934474878834d8616c8109.png" alt="livenessprobe"></p>
<p>Responsible for monitoring the health of the CSI driver and reporting to k8s through the Liveness Probe mechanism, and restarting the pod when an abnormality is detected in the CSI driver.</p>
<h4 id="node-driver-registrar">node-driver-registrar</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/ec7c58f3ae9b4d6f8dfe9a3f75ed9cbc.png" alt="node-driver-registrar"></p>
<p>By directly calling the <code>NodeGetInfo</code> interface of the CSI driver Node service, the CSI driver information is registered on the corresponding node&rsquo;s kubelet through the kubelet&rsquo;s plugin registration mechanism.</p>
<h4 id="external-health-monitor-controller">external-health-monitor-controller</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/99aac614ad19493aa53ac10fc9ec4a92.png" alt="external-health-monitor-controller"></p>
<p>The health of the CSI volume is checked and reported in the event of the PVC by calling the <code>ListVolumes</code> or <code>ControllerGetVolume</code> interface of the CSI driver Controller service.</p>
<h4 id="external-health-monitor-agent">external-health-monitor-agent</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/8725da17249c49ff989636f138825ab9.png" alt="external-health-monitor-agent"></p>
<p>Check the health of the CSI volume by calling the <code>NodeGetVolumeStats</code> interface of the CSI driver Node service and report it in the pod&rsquo;s event.</p>
<h3 id="third-party-plugins">Third-party plugins</h3>
<p>The third-party storage provider (i.e., SP, Storage Provider) needs to implement two plugins, Controller, which is responsible for volume management and is deployed as a StatefulSet, and Node, which is responsible for mounting the volume into the pod and is deployed as a DaemonSet in each node.</p>
<p>The CSI plug-in interacts with kubelet and k8s external components through the Unix Domani Socket gRPC, which defines three sets of RPC interfaces that SPs need to implement in order to communicate with k8s external components. The three sets of interfaces are CSI Identity, CSI Controller, and CSI Node, which are defined in detail below.</p>
<h4 id="csi-identity">CSI Identity</h4>
<p>The CSI Identity is used to provide the identity information of the CSI driver and needs to be implemented by both the Controller and the Node. The interfaces are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="kd">service</span> <span class="n">Identity</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">GetPluginInfo</span><span class="p">(</span><span class="n">GetPluginInfoRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">GetPluginInfoResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">GetPluginCapabilities</span><span class="p">(</span><span class="n">GetPluginCapabilitiesRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">GetPluginCapabilitiesResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">Probe</span> <span class="p">(</span><span class="n">ProbeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ProbeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><code>GetPluginInfo</code> is mandatory, the node-driver-registrar component will call this interface to register the CSI driver to the kubelet; <code>GetPluginCapabilities</code> is used to indicate what features the CSI driver mainly provides.</p>
<h4 id="csi-controller">CSI Controller</h4>
<p>is used to create/delete volumes, attach/detach volumes, volume snapshots, volume expansion/contraction, etc. The Controller plugin needs to implement this set of interfaces. The interfaces are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="kd">service</span> <span class="n">Controller</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">CreateVolume</span> <span class="p">(</span><span class="n">CreateVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">CreateVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">DeleteVolume</span> <span class="p">(</span><span class="n">DeleteVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">DeleteVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ControllerPublishVolume</span> <span class="p">(</span><span class="n">ControllerPublishVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ControllerPublishVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ControllerUnpublishVolume</span> <span class="p">(</span><span class="n">ControllerUnpublishVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ControllerUnpublishVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ValidateVolumeCapabilities</span> <span class="p">(</span><span class="n">ValidateVolumeCapabilitiesRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ValidateVolumeCapabilitiesResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ListVolumes</span> <span class="p">(</span><span class="n">ListVolumesRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ListVolumesResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">GetCapacity</span> <span class="p">(</span><span class="n">GetCapacityRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">GetCapacityResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ControllerGetCapabilities</span> <span class="p">(</span><span class="n">ControllerGetCapabilitiesRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ControllerGetCapabilitiesResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">CreateSnapshot</span> <span class="p">(</span><span class="n">CreateSnapshotRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">CreateSnapshotResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">DeleteSnapshot</span> <span class="p">(</span><span class="n">DeleteSnapshotRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">DeleteSnapshotResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ListSnapshots</span> <span class="p">(</span><span class="n">ListSnapshotsRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ListSnapshotsResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ControllerExpandVolume</span> <span class="p">(</span><span class="n">ControllerExpandVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ControllerExpandVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ControllerGetVolume</span> <span class="p">(</span><span class="n">ControllerGetVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">ControllerGetVolumeResponse</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>        <span class="k">option</span> <span class="p">(</span><span class="n">alpha_method</span><span class="p">)</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>As mentioned above in the introduction of k8s external components, different interfaces are provided to different components for different functions. For example, <code>CreateVolume</code> / <code>DeleteVolume</code> can be used with external-provisioner to create/delete volume, <code>ControllerPublishVolume</code> / <code>ControllerUnpublishVolume</code> can be used with external-attacher for attaching/detaching volumes, etc.</p>
<h4 id="csi-node">CSI Node</h4>
<p>The Node plug-in needs to implement this set of interfaces for mount/umount volume, check volume status, etc. The interfaces are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="kd">service</span> <span class="n">Node</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeStageVolume</span> <span class="p">(</span><span class="n">NodeStageVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeStageVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeUnstageVolume</span> <span class="p">(</span><span class="n">NodeUnstageVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeUnstageVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodePublishVolume</span> <span class="p">(</span><span class="n">NodePublishVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodePublishVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeUnpublishVolume</span> <span class="p">(</span><span class="n">NodeUnpublishVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeUnpublishVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeGetVolumeStats</span> <span class="p">(</span><span class="n">NodeGetVolumeStatsRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeGetVolumeStatsResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeExpandVolume</span><span class="p">(</span><span class="n">NodeExpandVolumeRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeExpandVolumeResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeGetCapabilities</span> <span class="p">(</span><span class="n">NodeGetCapabilitiesRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeGetCapabilitiesResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">NodeGetInfo</span> <span class="p">(</span><span class="n">NodeGetInfoRequest</span><span class="p">)</span><span class="err">
</span><span class="err"></span>    <span class="k">returns</span> <span class="p">(</span><span class="n">NodeGetInfoResponse</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p><code>NodeStageVolume</code> is used to implement the function of multiple pods sharing a single volume, supporting first mounting the volume to a temporary directory and then mounting it to the pod via <code>NodePublishVolume</code>; <code>NodeUnstageVolume</code> does the opposite.</p>
<h2 id="workflow">Workflow</h2>
<p>Here&rsquo;s a look at the entire workflow of pod mounting volume. There are three phases in the process: Provision/Delete, Attach/Detach, and Mount/Unmount, but not every storage solution goes through these three phases, for example, NFS does not have an Attach/Detach phase.</p>
<p>The entire process involves not only the work of the components described above, but also the AttachDetachController and PVController components of the ControllerManager and the kubelet, and the following is a detailed analysis of the Provision, Attach, and Mount phases respectively.</p>
<h3 id="provision">Provision</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/08e22773cdd4420ab3ea8126ef6aec56.png" alt="csi Provision"></p>
<p>Let&rsquo;s look at the Provision phase first, the whole process is shown in the figure above. Both extenal-provisioner and PVController watch PVC resources.</p>
<ol>
<li>When PVController watches that a PVC is created in the cluster, it determines whether there is an in-tree plugin that matches it, and if not, it determines that its storage type is out-of-tree, so it annotates the PVC with <code>volume.beta.kubernetes.io/storage- provisioner={csi driver name}</code>.</li>
<li>call the CSI Controller&rsquo;s <code>CreateVolume</code> interface when the extenal-provisioner watches that the PVC&rsquo;s annotated csi driver is consistent with its own csi driver.</li>
<li>when the <code>CreateVolume</code> interface of the CSI Controller returns success, the extenal-provisioner creates the corresponding PV in the cluster.</li>
<li>when the PVController watches that a PV is created in the cluster, it binds the PV to the PVC.</li>
</ol>
<h3 id="attach">Attach</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/13613223a13d4eee9b29a894cbd5f361.png" alt="csi Attach"></p>
<p>The Attach phase refers to attaching a volume to a node, and the whole process is shown in the figure above.</p>
<ol>
<li>the ADController listens when a pod is dispatched to a node and is using a PV of type CSI, and calls the internal in-tree CSI plug-in interface, which creates a VolumeAttachment resource in the cluster.</li>
<li>the external-attacher component watches for a VolumeAttachment resource to be created and calls the CSI Controller&rsquo;s <code>ControllerPublishVolume</code> interface.</li>
<li>when the CSI Controller&rsquo;s <code>ControllerPublishVolume</code> interface is called successfully, the external-attacher sets the Attached state of the corresponding VolumeAttachment object to true.</li>
<li>When the ADController watches that the Attached state of the VolumeAttachment object is true, it updates the internal state of the ADController ActualStateOfWorld.</li>
</ol>
<h3 id="mount">Mount</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/ed9a8c2b129c4df88edd1ac9399895c9.png" alt="CSI Mount"></p>
<p>The last step of mounting the volume to the pod involves the kubelet, and the whole process is simply described as a kubelet on the corresponding node calling the CSI Node plug-in to perform the mount operation during the pod creation process. The following is a breakdown of the kubelet&rsquo;s internal components.</p>
<p>First, in the main function <code>syncPod</code> where the kubelet creates the pod, the kubelet calls the <code>WaitForAttachAndMount</code> method of its subcomponent volumeManager and waits for the volume mount to complete.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncPod</span><span class="p">(</span><span class="nx">o</span> <span class="nx">syncPodOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
<span class="o">...</span>
	<span class="c1">// Volume manager will not mount volumes for terminated pods
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">kl</span><span class="p">.</span><span class="nf">podIsTerminated</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Wait for volumes to attach/mount
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">volumeManager</span><span class="p">.</span><span class="nf">WaitForAttachAndMount</span><span class="p">(</span><span class="nx">pod</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">kl</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">FailedMountVolume</span><span class="p">,</span> <span class="s">&#34;Unable to attach or mount volumes: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unable to attach or mount volumes for pod %q: %v; skipping pod&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pod</span><span class="p">(</span><span class="nx">pod</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The volumeManager contains two components: the desiredStateOfWorldPopulator and the reconciler, which work together to complete the mount and umount process of the volume in the pod. The whole process is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/3d269115debd4ba6913db395645faa1d.png" alt="csi"></p>
<p>The desiredStateOfWorldPopulator and reconciler have a producer-consumer model. two queues are maintained in the volumeManager (technically an interface, but acting as a queue here), namely DesiredStateOfWorld and The former maintains the desired state of the volume in the current node; the latter maintains the actual state of the volume in the current node.</p>
<p>The desiredStateOfWorldPopulator only does two things in its own loop, one is to get the newly created Pod from the podManager of the kubelet and record the information of the volume it needs to mount into DesiredStateOfWorld; the other thing is to get the information of the volume being mounted from the podManager of the current node into DesiredStateOfWorld. The other thing is to get the deleted pods from the podManager of the current node and check if their volumes are in the ActualStateOfWorld record, and if not, remove them from DesiredStateOfWorld as well, thus ensuring that DesiredStateOfWorld records the desired state of all the volumes in the node. This ensures that DesiredStateOfWorld records the desired state of all volumes in the node. The relevant code is as follows (some code has been removed to streamline the logic).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Iterate through all pods and add to desired state of world if they don&#39;t
</span><span class="c1">// exist but should
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">dswp</span> <span class="o">*</span><span class="nx">desiredStateOfWorldPopulator</span><span class="p">)</span> <span class="nf">findAndAddNewPods</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Map unique pod name to outer volume name to MountedVolume.
</span><span class="c1"></span>	<span class="nx">mountedVolumesForPod</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">volumetypes</span><span class="p">.</span><span class="nx">UniquePodName</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">MountedVolume</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="nx">processedVolumesForFSResize</span> <span class="o">:=</span> <span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dswp</span><span class="p">.</span><span class="nx">podManager</span><span class="p">.</span><span class="nf">GetPods</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">dswp</span><span class="p">.</span><span class="nf">processPodVolumes</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">mountedVolumesForPod</span><span class="p">,</span> <span class="nx">processedVolumesForFSResize</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// processPodVolumes processes the volumes in the given pod and adds them to the
</span><span class="c1">// desired state of the world.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">dswp</span> <span class="o">*</span><span class="nx">desiredStateOfWorldPopulator</span><span class="p">)</span> <span class="nf">processPodVolumes</span><span class="p">(</span>
	<span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span>
	<span class="nx">mountedVolumesForPod</span> <span class="kd">map</span><span class="p">[</span><span class="nx">volumetypes</span><span class="p">.</span><span class="nx">UniquePodName</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">MountedVolume</span><span class="p">,</span>
	<span class="nx">processedVolumesForFSResize</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">uniquePodName</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GetUniquePodName</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
    <span class="o">...</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">podVolume</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Volumes</span> <span class="p">{</span>   
		<span class="nx">pvc</span><span class="p">,</span> <span class="nx">volumeSpec</span><span class="p">,</span> <span class="nx">volumeGidValue</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span>
			<span class="nx">dswp</span><span class="p">.</span><span class="nf">createVolumeSpec</span><span class="p">(</span><span class="nx">podVolume</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">mounts</span><span class="p">,</span> <span class="nx">devices</span><span class="p">)</span>

		<span class="c1">// Add volume to desired state of world
</span><span class="c1"></span>		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">dswp</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">AddPodToVolume</span><span class="p">(</span>
			<span class="nx">uniquePodName</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">volumeSpec</span><span class="p">,</span> <span class="nx">podVolume</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">volumeGidValue</span><span class="p">)</span>
		<span class="nx">dswp</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">MarkRemountRequired</span><span class="p">(</span><span class="nx">uniquePodName</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The reconciler is the consumer, and it does three main things.</p>
<ol>
<li><code>unmountVolumes()</code> : iterates through the volume in ActualStateOfWorld, determines if it is in DesiredStateOfWorld, and if not, calls the CSI Node&rsquo;s interface to perform an unmount and records it in ActualStateOfWorld.</li>
<li><code>mountAttachVolumes()</code>: Get the volume from DesiredStateOfWorld that needs to be mounted, call the CSI Node&rsquo;s interface to perform mount or expand, and record it in ActualStateOfWorld.</li>
<li><code>unmountDetachDevices()</code> : iterate through the volume in ActualStateOfWorld, and if it has been attached, but there is no pod in use and not recorded in DesiredStateOfWorld, then unmount/detach it.</li>
</ol>
<p>Let&rsquo;s take <code>mountAttachVolumes()</code> as an example and see how it calls the CSI Node interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">)</span> <span class="nf">mountAttachVolumes</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Ensure volumes that should be attached/mounted are attached/mounted.
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">volumeToMount</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">desiredStateOfWorld</span><span class="p">.</span><span class="nf">GetVolumesToMount</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">volMounted</span><span class="p">,</span> <span class="nx">devicePath</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">PodExistsInVolume</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">PodName</span><span class="p">,</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">)</span>
		<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">DevicePath</span> <span class="p">=</span> <span class="nx">devicePath</span>
		<span class="k">if</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsVolumeNotAttachedError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">...</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">volMounted</span> <span class="o">||</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsRemountRequiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// Volume is not mounted, or is already mounted, but requires remounting
</span><span class="c1"></span>			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">MountVolume</span><span class="p">(</span>
				<span class="nx">rc</span><span class="p">.</span><span class="nx">waitForAttachTimeout</span><span class="p">,</span>
				<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeToMount</span><span class="p">,</span>
				<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">,</span>
				<span class="nx">isRemount</span><span class="p">)</span>
			<span class="o">...</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">IsFSResizeRequiredError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">operationExecutor</span><span class="p">.</span><span class="nf">ExpandInUseVolume</span><span class="p">(</span>
				<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeToMount</span><span class="p">,</span>
				<span class="nx">rc</span><span class="p">.</span><span class="nx">actualStateOfWorld</span><span class="p">)</span>
			<span class="o">...</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The execution of the mount is done in <code>rc.operationExecutor</code>, look at the operationExecutor code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">oe</span> <span class="o">*</span><span class="nx">operationExecutor</span><span class="p">)</span> <span class="nf">MountVolume</span><span class="p">(</span>
	<span class="nx">waitForAttachTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
	<span class="nx">volumeToMount</span> <span class="nx">VolumeToMount</span><span class="p">,</span>
	<span class="nx">actualStateOfWorld</span> <span class="nx">ActualStateOfWorldMounterUpdater</span><span class="p">,</span>
	<span class="nx">isRemount</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="kd">var</span> <span class="nx">generatedOperations</span> <span class="nx">volumetypes</span><span class="p">.</span><span class="nx">GeneratedOperations</span>
		<span class="nx">generatedOperations</span> <span class="p">=</span> <span class="nx">oe</span><span class="p">.</span><span class="nx">operationGenerator</span><span class="p">.</span><span class="nf">GenerateMountVolumeFunc</span><span class="p">(</span>
			<span class="nx">waitForAttachTimeout</span><span class="p">,</span> <span class="nx">volumeToMount</span><span class="p">,</span> <span class="nx">actualStateOfWorld</span><span class="p">,</span> <span class="nx">isRemount</span><span class="p">)</span>

	<span class="c1">// Avoid executing mount/map from multiple pods referencing the
</span><span class="c1"></span>	<span class="c1">// same volume in parallel
</span><span class="c1"></span>	<span class="nx">podName</span> <span class="o">:=</span> <span class="nx">nestedpendingoperations</span><span class="p">.</span><span class="nx">EmptyUniquePodName</span>

	<span class="k">return</span> <span class="nx">oe</span><span class="p">.</span><span class="nx">pendingOperations</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span>
		<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span> <span class="nx">podName</span><span class="p">,</span> <span class="s">&#34;&#34;</span> <span class="cm">/* nodeName */</span><span class="p">,</span> <span class="nx">generatedOperations</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This function constructs the executor function first and then executes it, then look at the constructor again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">og</span> <span class="o">*</span><span class="nx">operationGenerator</span><span class="p">)</span> <span class="nf">GenerateMountVolumeFunc</span><span class="p">(</span>
	<span class="nx">waitForAttachTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
	<span class="nx">volumeToMount</span> <span class="nx">VolumeToMount</span><span class="p">,</span>
	<span class="nx">actualStateOfWorld</span> <span class="nx">ActualStateOfWorldMounterUpdater</span><span class="p">,</span>
	<span class="nx">isRemount</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">volumetypes</span><span class="p">.</span><span class="nx">GeneratedOperations</span> <span class="p">{</span>

	<span class="nx">volumePlugin</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span>
		<span class="nx">og</span><span class="p">.</span><span class="nx">volumePluginMgr</span><span class="p">.</span><span class="nf">FindPluginBySpec</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">)</span>

	<span class="nx">mountVolumeFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">volumetypes</span><span class="p">.</span><span class="nx">OperationContext</span> <span class="p">{</span>
		<span class="c1">// Get mounter plugin
</span><span class="c1"></span>		<span class="nx">volumePlugin</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">og</span><span class="p">.</span><span class="nx">volumePluginMgr</span><span class="p">.</span><span class="nf">FindPluginBySpec</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">)</span>
		<span class="nx">volumeMounter</span><span class="p">,</span> <span class="nx">newMounterErr</span> <span class="o">:=</span> <span class="nx">volumePlugin</span><span class="p">.</span><span class="nf">NewMounter</span><span class="p">(</span>
			<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">,</span>
			<span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span>
			<span class="nx">volume</span><span class="p">.</span><span class="nx">VolumeOptions</span><span class="p">{})</span>
		<span class="o">...</span>
		<span class="c1">// Execute mount
</span><span class="c1"></span>		<span class="nx">mountErr</span> <span class="o">:=</span> <span class="nx">volumeMounter</span><span class="p">.</span><span class="nf">SetUp</span><span class="p">(</span><span class="nx">volume</span><span class="p">.</span><span class="nx">MounterArgs</span><span class="p">{</span>
			<span class="nx">FsUser</span><span class="p">:</span>              <span class="nx">util</span><span class="p">.</span><span class="nf">FsUserFrom</span><span class="p">(</span><span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">Pod</span><span class="p">),</span>
			<span class="nx">FsGroup</span><span class="p">:</span>             <span class="nx">fsGroup</span><span class="p">,</span>
			<span class="nx">DesiredSize</span><span class="p">:</span>         <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">DesiredSizeLimit</span><span class="p">,</span>
			<span class="nx">FSGroupChangePolicy</span><span class="p">:</span> <span class="nx">fsGroupChangePolicy</span><span class="p">,</span>
		<span class="p">})</span>
		<span class="c1">// Update actual state of world
</span><span class="c1"></span>		<span class="nx">markOpts</span> <span class="o">:=</span> <span class="nx">MarkVolumeOpts</span><span class="p">{</span>
			<span class="nx">PodName</span><span class="p">:</span>             <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">PodName</span><span class="p">,</span>
			<span class="nx">PodUID</span><span class="p">:</span>              <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">Pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span>
			<span class="nx">VolumeName</span><span class="p">:</span>          <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeName</span><span class="p">,</span>
			<span class="nx">Mounter</span><span class="p">:</span>             <span class="nx">volumeMounter</span><span class="p">,</span>
			<span class="nx">OuterVolumeSpecName</span><span class="p">:</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">OuterVolumeSpecName</span><span class="p">,</span>
			<span class="nx">VolumeGidVolume</span><span class="p">:</span>     <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeGidValue</span><span class="p">,</span>
			<span class="nx">VolumeSpec</span><span class="p">:</span>          <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">,</span>
			<span class="nx">VolumeMountState</span><span class="p">:</span>    <span class="nx">VolumeMounted</span><span class="p">,</span>
		<span class="p">}</span>

		<span class="nx">markVolMountedErr</span> <span class="o">:=</span> <span class="nx">actualStateOfWorld</span><span class="p">.</span><span class="nf">MarkVolumeAsMounted</span><span class="p">(</span><span class="nx">markOpts</span><span class="p">)</span>
		<span class="o">...</span>
		<span class="k">return</span> <span class="nx">volumetypes</span><span class="p">.</span><span class="nf">NewOperationContext</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">migrated</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">volumetypes</span><span class="p">.</span><span class="nx">GeneratedOperations</span><span class="p">{</span>
		<span class="nx">OperationName</span><span class="p">:</span>     <span class="s">&#34;volume_mount&#34;</span><span class="p">,</span>
		<span class="nx">OperationFunc</span><span class="p">:</span>     <span class="nx">mountVolumeFunc</span><span class="p">,</span>
		<span class="nx">EventRecorderFunc</span><span class="p">:</span> <span class="nx">eventRecorderFunc</span><span class="p">,</span>
		<span class="nx">CompleteFunc</span><span class="p">:</span>      <span class="nx">util</span><span class="p">.</span><span class="nf">OperationCompleteHook</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nf">GetFullQualifiedPluginNameForVolume</span><span class="p">(</span><span class="nx">volumePluginName</span><span class="p">,</span> <span class="nx">volumeToMount</span><span class="p">.</span><span class="nx">VolumeSpec</span><span class="p">),</span> <span class="s">&#34;volume_mount&#34;</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we first go to the plugin list of the CSI registered to the kubelet and find the corresponding plugin, then execute <code>volumeMounter.SetUp</code> and finally update the ActualStateOfWorld record. Here, the external CSI plugin is csiMountMgr, and the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">csiMountMgr</span><span class="p">)</span> <span class="nf">SetUp</span><span class="p">(</span><span class="nx">mounterArgs</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SetUpAt</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">GetPath</span><span class="p">(),</span> <span class="nx">mounterArgs</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">csiMountMgr</span><span class="p">)</span> <span class="nf">SetUpAt</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mounterArgs</span> <span class="nx">volume</span><span class="p">.</span><span class="nx">MounterArgs</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">csi</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">csiClientGetter</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
	<span class="o">...</span>

	<span class="nx">err</span> <span class="p">=</span> <span class="nx">csi</span><span class="p">.</span><span class="nf">NodePublishVolume</span><span class="p">(</span>
		<span class="nx">ctx</span><span class="p">,</span>
		<span class="nx">volumeHandle</span><span class="p">,</span>
		<span class="nx">readOnly</span><span class="p">,</span>
		<span class="nx">deviceMountPath</span><span class="p">,</span>
		<span class="nx">dir</span><span class="p">,</span>
		<span class="nx">accessMode</span><span class="p">,</span>
		<span class="nx">publishContext</span><span class="p">,</span>
		<span class="nx">volAttribs</span><span class="p">,</span>
		<span class="nx">nodePublishSecrets</span><span class="p">,</span>
		<span class="nx">fsType</span><span class="p">,</span>
		<span class="nx">mountOptions</span><span class="p">,</span>
	<span class="p">)</span>
    <span class="o">...</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the CSI Node <code>NodePublishVolume</code> / <code>NodeUnPublishVolume</code> interface is called by the volumeManager&rsquo;s csiMountMgr in the kubelet.</p>
<h2 id="summary">Summary</h2>
<p>This article analyzes the entire CSI system from three aspects: the CSI components, the CSI interface, and the process of how volume is mounted on a pod.</p>
<p>CSI is the standard storage interface for the entire container ecosystem, and the CO communicates with the CSI plug-in via gRPC. In order to achieve universality, k8s has designed many external components to work with the CSI plug-in to achieve different functions, thus ensuring the purity of k8s internal logic and the simplicity of the CSI plug-in.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/csi/">csi</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/implement-a-kubernetes-network-plugin/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to Implement a Kubernetes Network Plugin</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubelet-eviction-mechanism/">
            <span class="next-text nav-default">An analysis of the Kubelet eviction mechanism</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
