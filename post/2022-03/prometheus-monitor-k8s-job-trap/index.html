<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Prometheus Monitoring Kubernetes Job Resource False Alarm Issue - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Someone mentioned a problem before, it is about Prometheus monitoring Job task false alarm problem, the general meaning of the CronJob control Job, the front of the execution failed, monitoring will trigger the alarm, after the solution to generate a new Job can be executed normally, but will still receive the alarm in front.
This is because we generally keep some history when executing Job tasks to facilitate troubleshooting, so if there is a failed Job before, even if it will become successful later, the previous Job will continue to exist, and the default alarm rule used by most direct kube-prometheus installation and deployment is kube_job_ status_failed &amp;gt; 0, which is obviously inaccurate." /><meta name="keywords" content="prometheus, k8s" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/prometheus-monitor-k8s-job-trap/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Prometheus Monitoring Kubernetes Job Resource False Alarm Issue" />
<meta property="og:description" content="Someone mentioned a problem before, it is about Prometheus monitoring Job task false alarm problem, the general meaning of the CronJob control Job, the front of the execution failed, monitoring will trigger the alarm, after the solution to generate a new Job can be executed normally, but will still receive the alarm in front.
This is because we generally keep some history when executing Job tasks to facilitate troubleshooting, so if there is a failed Job before, even if it will become successful later, the previous Job will continue to exist, and the default alarm rule used by most direct kube-prometheus installation and deployment is kube_job_ status_failed &gt; 0, which is obviously inaccurate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/prometheus-monitor-k8s-job-trap/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-06T17:12:01+08:00" />
<meta property="article:modified_time" content="2022-03-06T17:12:01+08:00" />

<meta itemprop="name" content="Prometheus Monitoring Kubernetes Job Resource False Alarm Issue">
<meta itemprop="description" content="Someone mentioned a problem before, it is about Prometheus monitoring Job task false alarm problem, the general meaning of the CronJob control Job, the front of the execution failed, monitoring will trigger the alarm, after the solution to generate a new Job can be executed normally, but will still receive the alarm in front.
This is because we generally keep some history when executing Job tasks to facilitate troubleshooting, so if there is a failed Job before, even if it will become successful later, the previous Job will continue to exist, and the default alarm rule used by most direct kube-prometheus installation and deployment is kube_job_ status_failed &gt; 0, which is obviously inaccurate."><meta itemprop="datePublished" content="2022-03-06T17:12:01+08:00" />
<meta itemprop="dateModified" content="2022-03-06T17:12:01+08:00" />
<meta itemprop="wordCount" content="974">
<meta itemprop="keywords" content="prometheus,k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Prometheus Monitoring Kubernetes Job Resource False Alarm Issue"/>
<meta name="twitter:description" content="Someone mentioned a problem before, it is about Prometheus monitoring Job task false alarm problem, the general meaning of the CronJob control Job, the front of the execution failed, monitoring will trigger the alarm, after the solution to generate a new Job can be executed normally, but will still receive the alarm in front.
This is because we generally keep some history when executing Job tasks to facilitate troubleshooting, so if there is a failed Job before, even if it will become successful later, the previous Job will continue to exist, and the default alarm rule used by most direct kube-prometheus installation and deployment is kube_job_ status_failed &gt; 0, which is obviously inaccurate."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Prometheus Monitoring Kubernetes Job Resource False Alarm Issue</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-06 17:12:01 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 974 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>Someone mentioned a problem before, it is about Prometheus monitoring Job task false alarm problem, the general meaning of the CronJob control Job, the front of the execution failed, monitoring will trigger the alarm, after the solution to generate a new Job can be executed normally, but will still receive the alarm in front.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/06/848dd570240641b98c47da8fed4b927d.png" alt="monitoring will trigger the alarm"></p>
<p>This is because we generally keep some history when executing Job tasks to facilitate troubleshooting, so if there is a failed Job before, even if it will become successful later, the previous Job will continue to exist, and the default alarm rule used by most direct kube-prometheus installation and deployment is <code>kube_job_ status_failed &gt; 0</code>, which is obviously inaccurate. status_failed &gt; 0`, which is obviously inaccurate, only we can manually delete the failed Job task to eliminate false positives. troubleshooting problems. Let&rsquo;s reorganize our thinking to solve this problem.</p>
<p><code>CronJob</code> will create a Job object at each execution time of the schedule, and you can use the <code>.spec.successfulJobsHistoryLimit</code> and <code>.spec.failedJobsHistoryLimit</code> properties to keep how many completed and failed Jobs, the default is 3 and 1 respectively, such as the following Declare a resource object for <code>CronJob</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*/1 * * * *&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">successfulJobsHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">failedJobsHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hello</span><span class="w">
</span><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span><span class="w">            </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span><span class="w">            </span>- <span class="l">date;</span><span class="w">
</span><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>According to the resource object specification above, Kubernetes will keep only one failed Job and one successful Job.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">NAME               COMPLETIONS   DURATION   AGE
hello-4111706356   0/1           2m         10d
hello-4111706356   1/1           5s         5s
</code></pre></td></tr></table>
</div>
</div><p>To solve the above false positives, you also need to use the <code>kube-state-metrics</code> service, which listens to the Kubernetes APIServer and generates metrics about the state of objects. Deployment, Node, Job, Pod, and other resource objects. Here we will use the following metrics.</p>
<ul>
<li><code>kube_job_owner</code>: to find the relationship between a Job and the CronJob that triggered it</li>
<li><code>kube_job_status_start_time</code>: to get the time when the Job was triggered</li>
<li><code>kube_job_status_failed</code> : Get the job that failed to execute</li>
<li><code>kube_cronjob_spec_suspend</code> : filter out pending jobs</li>
</ul>
<p>Here is an example metric with tags generated by the <code>hello</code> task triggered by the CronJob run.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kube_job_owner<span class="o">{</span><span class="nv">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1604875860&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span>, <span class="nv">owner_is_controller</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>, <span class="nv">owner_kind</span><span class="o">=</span><span class="s2">&#34;CronJob&#34;</span>, <span class="nv">owner_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="o">}</span> <span class="m">1</span>
kube_job_status_start_time<span class="o">{</span><span class="nv">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1604875860&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="o">}</span> <span class="m">1604875874</span>
kube_job_status_failed<span class="o">{</span><span class="nv">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1604875860&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span>, <span class="nv">reason</span><span class="o">=</span><span class="s2">&#34;BackoffLimitExceeded&#34;</span><span class="o">}</span> <span class="m">1</span>
kube_cronjob_spec_suspend<span class="o">{</span><span class="nv">cronjob</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span>,job<span class="o">=</span><span class="s2">&#34;kube-state-metrics&#34;</span>, <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="o">}</span> <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p>To make monitoring alarms accurate, we really just need to go <strong>get the last job of a group of Jobs triggered by the same CronJob, and only trigger an alarm when the Job fails in execution</strong>.</p>
<p>Since the <code>kube_job_status_failed</code> and <code>kube_job_status_start_time</code> metrics do not contain the tag of the CronJob to which they belong, the first step is to add this tag, and the <code>owner_name</code> in the <code>kube_job_owner</code> metric is all we need to merge it with the following promql statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w">  </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w">  </span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Here we use the <code>max</code> function because we may run multiple kube-state-metrics for HA, so it is sufficient to use the max function to return one result for each Job task. Assuming our Job history contains 2 tasks (one failed and the other successful), the results will look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="err">{</span><span class="n">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1623578940&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="err">}</span><span class="w"> </span><span class="mi">1623578959</span><span class="w">
</span><span class="w"></span><span class="err">{</span><span class="n">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1617667200&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="err">}</span><span class="w"> </span><span class="mi">1617667204</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Now that we know the owner of each Job, we need to find out the last task executed, which we can do by aggregating the results by the <code>owner_name</code> tag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w">  </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> 
</span><span class="w"></span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The above statement will find the latest job start time of each owner (that is, CronJob), and then merge it with the above statement, keeping the record with the same start time as the latest executed Job task.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w"> </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w"> </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="o">==</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">owner_name</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_LEFT</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w"> </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w"> </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The results will show the last job executed for each CronJob and only the last one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="err">{</span><span class="n">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1623578940&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="err">}</span><span class="w"> </span><span class="mi">1623578959</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>To increase readability we can also replace the job_name, owner_name tags with job and cronjob to make it easier to read.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">label_replace</span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="n">label_replace</span><span class="p">(</span><span class="w">
</span><span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w">      </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w">      </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w">    </span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="o">==</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">owner_name</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_LEFT</span><span class="p">()</span><span class="w">
</span><span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="w">
</span><span class="w">      </span><span class="n">kube_job_status_start_time</span><span class="w">
</span><span class="w">      </span><span class="o">*</span><span class="w"> </span><span class="k">ON</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span><span class="w"> </span><span class="n">GROUP_RIGHT</span><span class="p">()</span><span class="w">
</span><span class="w">      </span><span class="n">kube_job_owner</span><span class="err">{</span><span class="n">owner_name</span><span class="o">!=</span><span class="s2">&#34;&#34;</span><span class="err">}</span><span class="w">
</span><span class="w">    </span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="k">BY</span><span class="w"> </span><span class="p">(</span><span class="n">owner_name</span><span class="p">),</span><span class="w">
</span><span class="w">  </span><span class="s2">&#34;job&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;$1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;job_name&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;(.+)&#34;</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;cronjob&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;$1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;owner_name&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;(.+)&#34;</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You will now see a result similar to the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="err">{</span><span class="n">job</span><span class="o">=</span><span class="s2">&#34;hello-1623578940&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cronjob</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">job_name</span><span class="o">=</span><span class="s2">&#34;hello-1623578940&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">namespace</span><span class="o">=</span><span class="s2">&#34;myNamespace&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">owner_name</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="err">}</span><span class="w"> </span><span class="mi">1623578959</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Since the above query statement is complex, it would be very stressful for Prometheus to perform a real-time computation for each alarm evaluation, so we can use record rules to implement an offline computation-like approach to greatly improve efficiency. Create a record rule as shown below to represent the last executed job record of each CronJob.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">job:kube_job_status_start_time:max</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    label_replace(
</span><span class="sd">      label_replace(
</span><span class="sd">        max(
</span><span class="sd">          kube_job_status_start_time
</span><span class="sd">          * ON(job_name,namespace) GROUP_RIGHT()
</span><span class="sd">          kube_job_owner{owner_name!=&#34;&#34;}
</span><span class="sd">        )
</span><span class="sd">        BY (job_name, owner_name, namespace)
</span><span class="sd">        == ON(owner_name) GROUP_LEFT()
</span><span class="sd">        max(
</span><span class="sd">          kube_job_status_start_time
</span><span class="sd">          * ON(job_name,namespace) GROUP_RIGHT()
</span><span class="sd">          kube_job_owner{owner_name!=&#34;&#34;}
</span><span class="sd">        )
</span><span class="sd">        BY (owner_name),
</span><span class="sd">      &#34;job&#34;, &#34;$1&#34;, &#34;job_name&#34;, &#34;(.+)&#34;),
</span><span class="sd">    &#34;cronjob&#34;, &#34;$1&#34;, &#34;owner_name&#34;, &#34;(.+)&#34;)</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>Now that we know the most recent job that CronJob started executing, we can use the <code>kube_job_status_failed</code> metric to filter out the failed ones.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">job:kube_job_status_failed:sum</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    clamp_max(job:kube_job_status_start_time:max, 1)
</span><span class="sd">      * ON(job) GROUP_LEFT()
</span><span class="sd">      label_replace(
</span><span class="sd">        (kube_job_status_failed &gt; 0),
</span><span class="sd">        &#34;job&#34;, &#34;$1&#34;, &#34;job_name&#34;, &#34;(.+)&#34;
</span><span class="sd">      )</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>clamp_max</code> function is used here to convert the result of <code>job:kube_job_status_start_time:max</code> to a set of time series with an upper bound of 1. It is used to filter the failed jobs by multiplication to get a set of Job tasks containing the most recent failures, which we also add here to the record rule named <code>kube_job_ status_failed:sum</code> to the record rule.</p>
<p>The final step is to add alarm rules directly to the failed Job tasks, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">- alert: CronJobStatusFailed
  expr: |
    job:kube_job_status_failed:sum
    * ON(cronjob, namespace) GROUP_LEFT()
    (kube_cronjob_spec_suspend == 0)
</code></pre></td></tr></table>
</div>
</div><p>To avoid false alarms, we have excluded pending tasks. Here we have solved the problem of false alarms for Prometheus monitoring CronJob tasks. Although kube-prometheus has a lot of built-in monitoring and alerting rules for us, we can&rsquo;t be completely superstitious and sometimes they don&rsquo;t always fit the actual needs.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/prometheus/">prometheus</a>
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/qdir-stdfilesystem/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A simple comparison of QDir and std::filesystem</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/edns-client-subnet/">
            <span class="next-text nav-default">Introduction to EDNS Client Subnet Protocol</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
