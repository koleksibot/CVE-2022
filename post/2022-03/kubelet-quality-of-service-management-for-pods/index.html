<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Quality of Service Management for Pods by Kubelet - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The previous article, Kubelet Pod Creation Workflow, explained how kubelet creates pods and how the components collaborate with each other. Based on the previous article, this article will explain how kubelet performs quality of service management for pods.
Pod QoS Kubernetes has a QoS type for each Pod, which is used to manage the quality of service for the Pod. There are three types, in decreasing order of priority.
 Guaranteed: Each container in a Pod must have a request and a limit, and the values must be the same." /><meta name="keywords" content="kubelet, Quality, Service Management, Pods" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/kubelet-quality-of-service-management-for-pods/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Quality of Service Management for Pods by Kubelet" />
<meta property="og:description" content="The previous article, Kubelet Pod Creation Workflow, explained how kubelet creates pods and how the components collaborate with each other. Based on the previous article, this article will explain how kubelet performs quality of service management for pods.
Pod QoS Kubernetes has a QoS type for each Pod, which is used to manage the quality of service for the Pod. There are three types, in decreasing order of priority.
 Guaranteed: Each container in a Pod must have a request and a limit, and the values must be the same." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/kubelet-quality-of-service-management-for-pods/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-10T09:58:42+08:00" />
<meta property="article:modified_time" content="2022-03-10T09:58:42+08:00" />

<meta itemprop="name" content="Quality of Service Management for Pods by Kubelet">
<meta itemprop="description" content="The previous article, Kubelet Pod Creation Workflow, explained how kubelet creates pods and how the components collaborate with each other. Based on the previous article, this article will explain how kubelet performs quality of service management for pods.
Pod QoS Kubernetes has a QoS type for each Pod, which is used to manage the quality of service for the Pod. There are three types, in decreasing order of priority.
 Guaranteed: Each container in a Pod must have a request and a limit, and the values must be the same."><meta itemprop="datePublished" content="2022-03-10T09:58:42+08:00" />
<meta itemprop="dateModified" content="2022-03-10T09:58:42+08:00" />
<meta itemprop="wordCount" content="4326">
<meta itemprop="keywords" content="kubelet," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Quality of Service Management for Pods by Kubelet"/>
<meta name="twitter:description" content="The previous article, Kubelet Pod Creation Workflow, explained how kubelet creates pods and how the components collaborate with each other. Based on the previous article, this article will explain how kubelet performs quality of service management for pods.
Pod QoS Kubernetes has a QoS type for each Pod, which is used to manage the quality of service for the Pod. There are three types, in decreasing order of priority.
 Guaranteed: Each container in a Pod must have a request and a limit, and the values must be the same."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Quality of Service Management for Pods by Kubelet</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-10 09:58:42 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4326 words </span>
          <span class="more-meta"> 21 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pod-qos">Pod QoS</a></li>
        <li><a href="#cgroups">Cgroups</a></li>
        <li><a href="#cgroups-in-k8s">Cgroups in K8s</a>
          <ul>
            <li><a href="#resolving-root-cgroups">Resolving Root Cgroups</a></li>
            <li><a href="#qos-level-cgroups">Qos-level cgroups</a></li>
            <li><a href="#pod-level-cgroups">pod-level cgroups</a></li>
            <li><a href="#container-level-cgroups">container-level cgroups</a></li>
            <li><a href="#oom-scoring">OOM scoring</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The previous article, Kubelet Pod Creation Workflow, explained how kubelet creates pods and how the components collaborate with each other. Based on the previous article, this article will explain how kubelet performs quality of service management for pods.</p>
<h2 id="pod-qos">Pod QoS</h2>
<p>Kubernetes has a QoS type for each Pod, which is used to manage the quality of service for the Pod. There are three types, in decreasing order of priority.</p>
<ul>
<li>Guaranteed: Each container in a Pod must have a request and a limit, and the values must be the same.</li>
<li>Burstable: At least one container in the Pod has a request value set for cpu or memory; * BestEffort: The Pod has a request value set for cpu or memory.</li>
<li>BestEffort: all containers in the Pod do not specify cpu and memory requests and limits.</li>
</ul>
<p>When machine resources are insufficient, kubelet will treat the Pod unfairly based on its QoS level. For seizable resources, such as CPU, when resources are tight, time slices are allocated in proportion to requests, and CPUs are slowed down if they reach the CPU resource limit limit of a Pod; while for non-seizable resources, such as memory and disk, when resources are tight, pods are evicted or OOMKill according to QoS levels.</p>
<h2 id="cgroups">Cgroups</h2>
<p>Cgroups stands for Control Groups, a mechanism provided by the Linux kernel to limit, record, and isolate the physical resources (such as cpu, memory, i/o, etc.) used by process groups.</p>
<p>The cgroups structure is used to represent the resource limits of a control group to one or more cgroups subsystems. Each cgroups structure is called a cgroups hierarchy. cgroups hierarchies can attach one or more cgroups subsystems, and the current hierarchy can restrict resources to the cgroups subsystems it attaches to; each cgroups subsystem can only be attached to one cpu hierarchy. can only be attached to one cpu hierarchy.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/529d060ea2b74d2babf497994feb356d.png" alt="Cgroups"></p>
<p>Where the cpu subsystem restricts process access to the CPU, each parameter exists independently in a pseudo-file in the cgroups virtual file system, and the parameters are explained as follows.</p>
<table>
<thead>
<tr>
<th>key</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu.shares</td>
<td>cgroup&rsquo;s allocation of time. For example, if cgroup A is set to 100 and cgroup B is set to 200, then the tasks in B will take twice as long to get cpu as the tasks in A.</td>
</tr>
<tr>
<td>cpu.cfs_period_us</td>
<td>The period of the fully fair scheduler&rsquo;s adjusted time quota.</td>
</tr>
<tr>
<td>cpu.cfs_quota_us</td>
<td>The amount of time the full fair scheduler can occupy in its cycle.</td>
</tr>
<tr>
<td>cpu.stat</td>
<td>cpu running statistics</td>
</tr>
</tbody>
</table>
<h2 id="cgroups-in-k8s">Cgroups in K8s</h2>
<p>In kubernetes, in order to limit the use of container resources and prevent containers from competing for resources or affecting their hosts, the kubelet component needs to limit the use of container resources using cgroups. cgroups currently support limiting multiple resources for a process, while kubelet only supports limiting cpu, memory, pids, and hugetlb resources.</p>
<p>When kubelet starts, it resolves the root cgroups on the node and creates a sub-cgroups called kubepods under it. three levels of cgroups file tree are created under kubepods.</p>
<ul>
<li>QoS level: Two QoS level cgroups, named Burstable and BestEffort, exist as the parent cgroups of all pods at their respective QoS levels</li>
<li>pod level: When creating a pod, you need to create pod level cgroups under the QoS cgroups corresponding to the pod. for Guaranteed Qos corresponding pods, the pod cgroups are created directly in the kubepods cgroups of the same level.</li>
<li>container level: when creating a specific container within a pod, pod level cgroups continue to create the corresponding container level cgroups.</li>
</ul>
<h3 id="resolving-root-cgroups">Resolving Root Cgroups</h3>
<p>Let&rsquo;s start by looking at how kubelet resolves root group cgroups.</p>
<p>The kubelet manages pod QoS levels through the component qosContainerManager, which is a member of the component containerManager, and constructs the qosContainerManager when constructing the containerManager, look at the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewContainerManager</span><span class="p">(</span><span class="nx">mountUtil</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">cadvisorInterface</span> <span class="nx">cadvisor</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">nodeConfig</span> <span class="nx">NodeConfig</span><span class="p">,</span> <span class="nx">failSwapOn</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">devicePluginEnabled</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">recorder</span> <span class="nx">record</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">)</span> <span class="p">(</span><span class="nx">ContainerManager</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
   <span class="o">...</span>
  
	<span class="nx">cgroupRoot</span> <span class="o">:=</span> <span class="nf">ParseCgroupfsToCgroupName</span><span class="p">(</span><span class="nx">nodeConfig</span><span class="p">.</span><span class="nx">CgroupRoot</span><span class="p">)</span>
	<span class="nx">cgroupManager</span> <span class="o">:=</span> <span class="nf">NewCgroupManager</span><span class="p">(</span><span class="nx">subsystems</span><span class="p">,</span> <span class="nx">nodeConfig</span><span class="p">.</span><span class="nx">CgroupDriver</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">nodeConfig</span><span class="p">.</span><span class="nx">CgroupsPerQOS</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">nodeConfig</span><span class="p">.</span><span class="nx">CgroupRoot</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid configuration: cgroups-per-qos was specified and cgroup-root was not specified. To enable the QoS cgroup hierarchy you need to specify a valid cgroup-root&#34;</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">!</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nx">cgroupRoot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid configuration: cgroup-root %q doesn&#39;t exist&#34;</span><span class="p">,</span> <span class="nx">cgroupRoot</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;container manager verified user specified cgroup-root exists: %v&#34;</span><span class="p">,</span> <span class="nx">cgroupRoot</span><span class="p">)</span>
		
		<span class="nx">cgroupRoot</span> <span class="p">=</span> <span class="nf">NewCgroupName</span><span class="p">(</span><span class="nx">cgroupRoot</span><span class="p">,</span> <span class="nx">defaultNodeAllocatableCgroupName</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Creating Container Manager object based on Node Config: %+v&#34;</span><span class="p">,</span> <span class="nx">nodeConfig</span><span class="p">)</span>

	<span class="nx">qosContainerManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewQOSContainerManager</span><span class="p">(</span><span class="nx">subsystems</span><span class="p">,</span> <span class="nx">cgroupRoot</span><span class="p">,</span> <span class="nx">nodeConfig</span><span class="p">,</span> <span class="nx">cgroupManager</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Before constructing the qosContainerManager, the root of the pod cgroup managed by the kubelet is assembled and passed into the constructor, <code>&lt;rootCgroup&gt;/kubepods</code>.</p>
<p>Once constructed, when the containerManager is started, it initializes and starts all the subcomponents, including the qosContainerManager, which is started by calling the setupNode function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">containerManagerImpl</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">node</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span>
	<span class="nx">activePods</span> <span class="nx">ActivePodsFunc</span><span class="p">,</span>
	<span class="nx">sourcesReady</span> <span class="nx">config</span><span class="p">.</span><span class="nx">SourcesReady</span><span class="p">,</span>
	<span class="nx">podStatusProvider</span> <span class="nx">status</span><span class="p">.</span><span class="nx">PodStatusProvider</span><span class="p">,</span>
	<span class="nx">runtimeService</span> <span class="nx">internalapi</span><span class="p">.</span><span class="nx">RuntimeService</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="c1">// cache the node Info including resource capacity and
</span><span class="c1"></span>	<span class="c1">// allocatable of the node
</span><span class="c1"></span>	<span class="nx">cm</span><span class="p">.</span><span class="nx">nodeInfo</span> <span class="p">=</span> <span class="nx">node</span>

	<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">LocalStorageCapacityIsolation</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">rootfs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">cadvisorInterface</span><span class="p">.</span><span class="nf">RootFsInfo</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get rootfs info: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="nx">rName</span><span class="p">,</span> <span class="nx">rCap</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cadvisor</span><span class="p">.</span><span class="nf">EphemeralStorageCapacityFromFsInfo</span><span class="p">(</span><span class="nx">rootfs</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">cm</span><span class="p">.</span><span class="nx">capacity</span><span class="p">[</span><span class="nx">rName</span><span class="p">]</span> <span class="p">=</span> <span class="nx">rCap</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">// Ensure that node allocatable configuration is valid.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">validateNodeAllocatable</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="c1">// Setup the node
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">setupNode</span><span class="p">(</span><span class="nx">activePods</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
    <span class="o">...</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the setupNode function, the createNodeAllocatableCgroups function is called to resolve the node&rsquo;s root cgroups and then start the qosContainerManager.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">containerManagerImpl</span><span class="p">)</span> <span class="nf">setupNode</span><span class="p">(</span><span class="nx">activePods</span> <span class="nx">ActivePodsFunc</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="o">...</span>
	<span class="c1">// Setup top level qos containers only if CgroupsPerQOS flag is specified as true
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">NodeConfig</span><span class="p">.</span><span class="nx">CgroupsPerQOS</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">createNodeAllocatableCgroups</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">err</span> <span class="p">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">qosContainerManager</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">getNodeAllocatableAbsolute</span><span class="p">,</span> <span class="nx">activePods</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to initialize top level QOS containers: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally, let&rsquo;s take a closer look at the createNodeAllocatableCgroups function and explore how kubelet resolves the root cgroups of nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">containerManagerImpl</span><span class="p">)</span> <span class="nf">createNodeAllocatableCgroups</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">nodeAllocatable</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">internalCapacity</span>
	<span class="c1">// Use Node Allocatable limits instead of capacity if the user requested enforcing node allocatable.
</span><span class="c1"></span>	<span class="nx">nc</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">NodeConfig</span><span class="p">.</span><span class="nx">NodeAllocatableConfig</span>
	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">CgroupsPerQOS</span> <span class="o">&amp;&amp;</span> <span class="nx">nc</span><span class="p">.</span><span class="nx">EnforceNodeAllocatable</span><span class="p">.</span><span class="nf">Has</span><span class="p">(</span><span class="nx">kubetypes</span><span class="p">.</span><span class="nx">NodeAllocatableEnforcementKey</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">nodeAllocatable</span> <span class="p">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">getNodeAllocatableInternalAbsolute</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="nx">cgroupConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CgroupConfig</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">cgroupRoot</span><span class="p">,</span>
		<span class="c1">// The default limits for cpu shares can be very low which can lead to CPU starvation for pods.
</span><span class="c1"></span>		<span class="nx">ResourceParameters</span><span class="p">:</span> <span class="nf">getCgroupConfig</span><span class="p">(</span><span class="nx">nodeAllocatable</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nx">cgroupConfig</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">cgroupConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to create %q cgroup&#34;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">cgroupRoot</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getCgroupConfig</span><span class="p">(</span><span class="nx">rl</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">)</span> <span class="o">*</span><span class="nx">ResourceConfig</span> <span class="p">{</span>
	<span class="c1">// TODO(vishh): Set CPU Quota if necessary.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">rl</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="kd">var</span> <span class="nx">rc</span> <span class="nx">ResourceConfig</span>
	<span class="k">if</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">rl</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="c1">// Memory is defined in bytes.
</span><span class="c1"></span>		<span class="nx">val</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Value</span><span class="p">()</span>
		<span class="nx">rc</span><span class="p">.</span><span class="nx">Memory</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">val</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">rl</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="c1">// CPU is defined in milli-cores.
</span><span class="c1"></span>		<span class="nx">val</span> <span class="o">:=</span> <span class="nf">MilliCPUToShares</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">())</span>
		<span class="nx">rc</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">val</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">q</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">rl</span><span class="p">[</span><span class="nx">pidlimit</span><span class="p">.</span><span class="nx">PIDs</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="nx">val</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Value</span><span class="p">()</span>
		<span class="nx">rc</span><span class="p">.</span><span class="nx">PidsLimit</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">val</span>
	<span class="p">}</span>
	<span class="nx">rc</span><span class="p">.</span><span class="nx">HugePageLimit</span> <span class="p">=</span> <span class="nf">HugePageLimits</span><span class="p">(</span><span class="nx">rl</span><span class="p">)</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">rc</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the createNodeAllocatableCgroups function essentially sets the root group Cgroup based on the available cpu, memory, Pid, HugePageLimits, etc. of the node obtained from cm.internalCapacity, which sets the memory limit, cpu share, Pid limit, and hugePageLimit. cpu share, Pid limit and hugePageLimit. The name of the root group cgroup is the kubepods directory passed in before building the qosContainerManager.</p>
<p>The cm.internalCapacity is obtained from the CAdvisor when the containerManager is initialized; when the user uses the Node Allocatable feature, the node&rsquo;s reserved resources are set according to the parameters filled in by the user.</p>
<h3 id="qos-level-cgroups">Qos-level cgroups</h3>
<p>After the root group cgroups are set, let&rsquo;s take a look at the qosContainerManager startup function.</p>
<p>As shown in the figure below, the root group cgroups (path /kubepods) are first fetched, which is the result of the previous parsing step.</p>
<p>Then the QoS-level cgroups are created, where the Guaranteed cgroup path is the root group, the Burstable cgroup path is /kubepods/burstable, and the BestEffort cgroup path is /kubepods/besteffort, and the cpushare of the latter two types starts at 0.</p>
<p>Finally, a concurrent program is started to execute the UpdateCgroups function at regular intervals to synchronize the corresponding cgroups according to the pods of each QoS type.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/1f3edc2b11b04f63a68c6e89f937142d.png" alt="Qos-level cgroups"></p>
<p>The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">qosContainerManagerImpl</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">getNodeAllocatable</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceList</span><span class="p">,</span> <span class="nx">activePods</span> <span class="nx">ActivePodsFunc</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">cm</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cgroupManager</span>
	<span class="nx">rootContainer</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cgroupRoot</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">cm</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nx">rootContainer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;root container %v doesn&#39;t exist&#34;</span><span class="p">,</span> <span class="nx">rootContainer</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Top level for Qos containers are created only for Burstable
</span><span class="c1"></span>	<span class="c1">// and Best Effort classes
</span><span class="c1"></span>	<span class="nx">qosClasses</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSClass</span><span class="p">]</span><span class="nx">CgroupName</span><span class="p">{</span>
		<span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span><span class="p">:</span>  <span class="nf">NewCgroupName</span><span class="p">(</span><span class="nx">rootContainer</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span><span class="p">))),</span>
		<span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span><span class="p">:</span> <span class="nf">NewCgroupName</span><span class="p">(</span><span class="nx">rootContainer</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span><span class="p">))),</span>
	<span class="p">}</span>

	<span class="c1">// Create containers for both qos classes
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">qosClass</span><span class="p">,</span> <span class="nx">containerName</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">qosClasses</span> <span class="p">{</span>
		<span class="nx">resourceParameters</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ResourceConfig</span><span class="p">{}</span>
		<span class="c1">// the BestEffort QoS class has a statically configured minShares value
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">qosClass</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span> <span class="p">{</span>
			<span class="nx">minShares</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">MinShares</span><span class="p">)</span>
			<span class="nx">resourceParameters</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">minShares</span>
		<span class="p">}</span>

		<span class="c1">// containerConfig object stores the cgroup specifications
</span><span class="c1"></span>		<span class="nx">containerConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CgroupConfig</span><span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>               <span class="nx">containerName</span><span class="p">,</span>
			<span class="nx">ResourceParameters</span><span class="p">:</span> <span class="nx">resourceParameters</span><span class="p">,</span>
		<span class="p">}</span>

		<span class="c1">// for each enumerated huge page size, the qos tiers are unbounded
</span><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nf">setHugePagesUnbounded</span><span class="p">(</span><span class="nx">containerConfig</span><span class="p">)</span>

		<span class="c1">// check if it exists
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">cm</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nx">containerName</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">containerConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create top level %v QOS cgroup : %v&#34;</span><span class="p">,</span> <span class="nx">qosClass</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// to ensure we actually have the right state, we update the config on startup
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">containerConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to update top level %v QOS cgroup : %v&#34;</span><span class="p">,</span> <span class="nx">qosClass</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">// Store the top level qos container names
</span><span class="c1"></span>	<span class="nx">m</span><span class="p">.</span><span class="nx">qosContainersInfo</span> <span class="p">=</span> <span class="nx">QOSContainersInfo</span><span class="p">{</span>
		<span class="nx">Guaranteed</span><span class="p">:</span> <span class="nx">rootContainer</span><span class="p">,</span>
		<span class="nx">Burstable</span><span class="p">:</span>  <span class="nx">qosClasses</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span><span class="p">],</span>
		<span class="nx">BestEffort</span><span class="p">:</span> <span class="nx">qosClasses</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span><span class="p">],</span>
	<span class="p">}</span>
	<span class="nx">m</span><span class="p">.</span><span class="nx">getNodeAllocatable</span> <span class="p">=</span> <span class="nx">getNodeAllocatable</span>
	<span class="nx">m</span><span class="p">.</span><span class="nx">activePods</span> <span class="p">=</span> <span class="nx">activePods</span>

	<span class="c1">// update qos cgroup tiers on startup and in periodic intervals
</span><span class="c1"></span>	<span class="c1">// to ensure desired state is in sync with actual state.
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">UpdateCgroups</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;[ContainerManager] Failed to reserve QoS requests: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="nx">periodicQOSCgroupUpdateInterval</span><span class="p">,</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Look at the UpdateCgroups again.</p>
<p>First, the cpushare value is recalculated for both BestEffort and Burstable qos. The rule is that the cpushare of the BestEffort type is set to 2; the cpushare of the Burstable type is the sum of the cpushare of all the pods under it.</p>
<p>Second, if memory huge page is enabled, set the huge page related cgroup.</p>
<p>Then, if qos reserve is enabled, the memory limit is calculated for both Burstable and BestEffort QoS types, and the rule is that the memory limit for Burstable is the total number of nodes minus the sum of the memory limits of Guaranteed pods. The memory limit of BestEffort is the memory limit of Burstable minus the sum of the memory limits of Burstable pods. The calculation formula is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">burstableLimit</span> <span class="o">:=</span> <span class="nx">allocatable</span> <span class="o">-</span> <span class="p">(</span><span class="nx">qosMemoryRequests</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSGuaranteed</span><span class="p">]</span> <span class="o">*</span> <span class="nx">percentReserve</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="nx">bestEffortLimit</span> <span class="o">:=</span> <span class="nx">burstableLimit</span> <span class="o">-</span> <span class="p">(</span><span class="nx">qosMemoryRequests</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span><span class="p">]</span> <span class="o">*</span> <span class="nx">percentReserve</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>In particular, the qos-reserved parameter is used in some scenarios where we want to ensure that the resources of a high-level pod like Guaranteed pod, especially the non-preemptible resources (such as memory), are not preempted by a low-level pod. The So Burstable&rsquo;s cgroup needs to reserve memory resources for Guaranteed pods that are higher than it, while BestEffort needs to reserve memory resources for both Burstable and Guaranteed.</p>
<p>Finally, the new data is updated to the QoS level cgroup data. The overall code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">qosContainerManagerImpl</span><span class="p">)</span> <span class="nf">UpdateCgroups</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">qosConfigs</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSClass</span><span class="p">]</span><span class="o">*</span><span class="nx">CgroupConfig</span><span class="p">{</span>
		<span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span><span class="p">:</span> <span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>               <span class="nx">m</span><span class="p">.</span><span class="nx">qosContainersInfo</span><span class="p">.</span><span class="nx">Burstable</span><span class="p">,</span>
			<span class="nx">ResourceParameters</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">ResourceConfig</span><span class="p">{},</span>
		<span class="p">},</span>
		<span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span><span class="p">:</span> <span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>               <span class="nx">m</span><span class="p">.</span><span class="nx">qosContainersInfo</span><span class="p">.</span><span class="nx">BestEffort</span><span class="p">,</span>
			<span class="nx">ResourceParameters</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">ResourceConfig</span><span class="p">{},</span>
		<span class="p">},</span>
	<span class="p">}</span>

	<span class="c1">// update the qos level cgroup settings for cpu shares
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">setCPUCgroupConfig</span><span class="p">(</span><span class="nx">qosConfigs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// update the qos level cgroup settings for huge pages (ensure they remain unbounded)
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">setHugePagesConfig</span><span class="p">(</span><span class="nx">qosConfigs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">QOSReserved</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">percentReserve</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span><span class="p">.</span><span class="nx">qosReserved</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="nx">resource</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">:</span>
				<span class="nx">m</span><span class="p">.</span><span class="nf">setMemoryReserve</span><span class="p">(</span><span class="nx">qosConfigs</span><span class="p">,</span> <span class="nx">percentReserve</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="nx">updateSuccess</span> <span class="o">:=</span> <span class="kc">true</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">config</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">qosConfigs</span> <span class="p">{</span>
			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">updateSuccess</span> <span class="p">=</span> <span class="kc">false</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="o">...</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">config</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">qosConfigs</span> <span class="p">{</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;[ContainerManager]: Failed to update QoS cgroup configuration&#34;</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
   <span class="o">...</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In cgroupManager.Update(), runc is called to write cgroups based on all the cgroups calculated above, and the supported cgroupfs include MemoryGroup, CpuGroup, PidsGroup, all in package <code>&quot;github.com/ opencontainers/runc/libcontainer/cgroups/fs&quot;</code>, and the source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">setSupportedSubsystemsV1</span><span class="p">(</span><span class="nx">cgroupConfig</span> <span class="o">*</span><span class="nx">libcontainerconfigs</span><span class="p">.</span><span class="nx">Cgroup</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">sys</span><span class="p">,</span> <span class="nx">required</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">getSupportedSubsystems</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">cgroupConfig</span><span class="p">.</span><span class="nx">Paths</span><span class="p">[</span><span class="nx">sys</span><span class="p">.</span><span class="nf">Name</span><span class="p">()];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">required</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to find subsystem mount for required subsystem: %v&#34;</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="o">...</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">cgroupConfig</span><span class="p">.</span><span class="nx">Paths</span><span class="p">[</span><span class="nx">sys</span><span class="p">.</span><span class="nf">Name</span><span class="p">()],</span> <span class="nx">cgroupConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to set config for supported subsystems : %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getSupportedSubsystems</span><span class="p">()</span> <span class="kd">map</span><span class="p">[</span><span class="nx">subsystem</span><span class="p">]</span><span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">supportedSubsystems</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">subsystem</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span>
		<span class="o">&amp;</span><span class="nx">cgroupfs</span><span class="p">.</span><span class="nx">MemoryGroup</span><span class="p">{}:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">cgroupfs</span><span class="p">.</span><span class="nx">CpuGroup</span><span class="p">{}:</span>    <span class="kc">true</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">cgroupfs</span><span class="p">.</span><span class="nx">PidsGroup</span><span class="p">{}:</span>   <span class="kc">false</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// not all hosts support hugetlb cgroup, and in the absent of hugetlb, we will fail silently by reporting no capacity.
</span><span class="c1"></span>	<span class="nx">supportedSubsystems</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">cgroupfs</span><span class="p">.</span><span class="nx">HugetlbGroup</span><span class="p">{}]</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">SupportPodPidsLimit</span><span class="p">)</span> <span class="o">||</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">SupportNodePidsLimit</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">supportedSubsystems</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">cgroupfs</span><span class="p">.</span><span class="nx">PidsGroup</span><span class="p">{}]</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">supportedSubsystems</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Take cpuGroup as an example, it is essentially writing to cpu.shares, cpu.cfs_period_us, cpu.cfs_quota_us files. The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">CpuGroup</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cgroup</span> <span class="o">*</span><span class="nx">configs</span><span class="p">.</span><span class="nx">Cgroup</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">shares</span> <span class="o">:=</span> <span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuShares</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fscommon</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#34;cpu.shares&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nx">shares</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="o">...</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuPeriod</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fscommon</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#34;cpu.cfs_period_us&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuPeriod</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuQuota</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fscommon</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#34;cpu.cfs_quota_us&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nx">cgroup</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuQuota</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nf">SetRtSched</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">cgroup</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pod-level-cgroups">pod-level cgroups</h3>
<p>Here&rsquo;s a look at the process of creating a pod-level cgroup.</p>
<p>When creating a pod, the syncPod function will call the EnsureExists method inside the podContainerManagerImpl structure, which will check whether the pod already exists, and if not, it will call the ResourceConfigForPod function to calculate the resource of the pod and then create its corresponding cgroup. The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">podContainerManagerImpl</span><span class="p">)</span> <span class="nf">EnsureExists</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">podContainerName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetPodContainerName</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
	<span class="c1">// check if container already exist
</span><span class="c1"></span>	<span class="nx">alreadyExists</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">alreadyExists</span> <span class="p">{</span>
		<span class="c1">// Create the pod container
</span><span class="c1"></span>		<span class="nx">containerConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CgroupConfig</span><span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>               <span class="nx">podContainerName</span><span class="p">,</span>
			<span class="nx">ResourceParameters</span><span class="p">:</span> <span class="nf">ResourceConfigForPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">enforceCPULimits</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cpuCFSQuotaPeriod</span><span class="p">),</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">SupportPodPidsLimit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">podPidsLimit</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">containerConfig</span><span class="p">.</span><span class="nx">ResourceParameters</span><span class="p">.</span><span class="nx">PidsLimit</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">podPidsLimit</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cgroupManager</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">containerConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create container for %v : %v&#34;</span><span class="p">,</span> <span class="nx">podContainerName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">applyLimits</span><span class="p">(</span><span class="nx">pod</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to apply resource limits on container for %v : %v&#34;</span><span class="p">,</span> <span class="nx">podContainerName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s look at how kubelet calculates the resource of a pod.</p>
<p>First, the cpu request/limits and memory limit of all containers of the pod are counted, cpu request/limits are converted into cpuShares and cpuQuota; the large page limit is calculated; then, according to the resource declaration of each container, the QoS is determined; finally, the cgroup of the pod is counted:</p>
<ol>
<li>if enforceCPULimits is not enabled, cpuQuota is -1; 2. if the pod is of Guaranteed type, cpuQuota is -1.</li>
<li>if the pod is Guaranteed, CpuShares, CpuQuota, CpuPeriod, Memory are all calculated earlier.</li>
<li>if the pod is of type Burstable, CpuQuota and CpuPeriod are configured only if cpuLimitsDeclared is on, and Memory is configured only if memoryLimitsDeclared is on.</li>
<li>If the pod is of type BestEffort, CpuShares is 2, and nothing else is set.</li>
</ol>
<p>The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ResourceConfigForPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">enforceCPULimits</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">cpuPeriod</span> <span class="kt">uint64</span><span class="p">)</span> <span class="o">*</span><span class="nx">ResourceConfig</span> <span class="p">{</span>
	<span class="c1">// sum requests and limits.
</span><span class="c1"></span>	<span class="nx">reqs</span><span class="p">,</span> <span class="nx">limits</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.</span><span class="nf">PodRequestsAndLimits</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>

	<span class="nx">cpuRequests</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="nx">cpuLimits</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="nx">memoryLimits</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">reqs</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
		<span class="nx">cpuRequests</span> <span class="p">=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">limits</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceCPU</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
		<span class="nx">cpuLimits</span> <span class="p">=</span> <span class="nx">limit</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">limit</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">limits</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">ResourceMemory</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
		<span class="nx">memoryLimits</span> <span class="p">=</span> <span class="nx">limit</span><span class="p">.</span><span class="nf">Value</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="c1">// convert to CFS values
</span><span class="c1"></span>	<span class="nx">cpuShares</span> <span class="o">:=</span> <span class="nf">MilliCPUToShares</span><span class="p">(</span><span class="nx">cpuRequests</span><span class="p">)</span>
	<span class="nx">cpuQuota</span> <span class="o">:=</span> <span class="nf">MilliCPUToQuota</span><span class="p">(</span><span class="nx">cpuLimits</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">cpuPeriod</span><span class="p">))</span>

	<span class="c1">// track if limits were applied for each resource.
</span><span class="c1"></span>	<span class="nx">memoryLimitsDeclared</span> <span class="o">:=</span> <span class="kc">true</span>
	<span class="nx">cpuLimitsDeclared</span> <span class="o">:=</span> <span class="kc">true</span>
	<span class="c1">// map hugepage pagesize (bytes) to limits (bytes)
</span><span class="c1"></span>	<span class="nx">hugePageLimits</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="kt">int64</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">container</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nf">Cpu</span><span class="p">().</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">cpuLimitsDeclared</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nf">Memory</span><span class="p">().</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">memoryLimitsDeclared</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="nx">containerHugePageLimits</span> <span class="o">:=</span> <span class="nf">HugePageLimits</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Requests</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">containerHugePageLimits</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">hugePageLimits</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
				<span class="nx">hugePageLimits</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span> <span class="o">+</span> <span class="nx">v</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">hugePageLimits</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// quota is not capped when cfs quota is disabled
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">enforceCPULimits</span> <span class="p">{</span>
		<span class="nx">cpuQuota</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// determine the qos class
</span><span class="c1"></span>	<span class="nx">qosClass</span> <span class="o">:=</span> <span class="nx">v1qos</span><span class="p">.</span><span class="nf">GetPodQOS</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>

	<span class="c1">// build the result
</span><span class="c1"></span>	<span class="nx">result</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ResourceConfig</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">qosClass</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSGuaranteed</span> <span class="p">{</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuShares</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">CpuQuota</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuQuota</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">CpuPeriod</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuPeriod</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">Memory</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">memoryLimits</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">qosClass</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBurstable</span> <span class="p">{</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuShares</span>
		<span class="k">if</span> <span class="nx">cpuLimitsDeclared</span> <span class="p">{</span>
			<span class="nx">result</span><span class="p">.</span><span class="nx">CpuQuota</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuQuota</span>
			<span class="nx">result</span><span class="p">.</span><span class="nx">CpuPeriod</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cpuPeriod</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">memoryLimitsDeclared</span> <span class="p">{</span>
			<span class="nx">result</span><span class="p">.</span><span class="nx">Memory</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">memoryLimits</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">shares</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">MinShares</span><span class="p">)</span>
		<span class="nx">result</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">shares</span>
	<span class="p">}</span>
	<span class="nx">result</span><span class="p">.</span><span class="nx">HugePageLimit</span> <span class="p">=</span> <span class="nx">hugePageLimits</span>
	<span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="container-level-cgroups">container-level cgroups</h3>
<p>Finally, let&rsquo;s take a look at the container-level cgroups.</p>
<p>When a container is created, it will first get its parent cgroup, i.e. pod-level cgroups, which will be stored in podSandboxConfig, and then generateContainerConfig will be called to generate container-level cgroup information. The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">startContainer</span><span class="p">(</span><span class="nx">podSandboxID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podSandboxConfig</span> <span class="o">*</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">PodSandboxConfig</span><span class="p">,</span> <span class="nx">spec</span> <span class="o">*</span><span class="nx">startSpec</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">podStatus</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">PodStatus</span><span class="p">,</span> <span class="nx">pullSecrets</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">podIP</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podIPs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">container</span> <span class="o">:=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">container</span>
	<span class="o">...</span>
	<span class="nx">containerConfig</span><span class="p">,</span> <span class="nx">cleanupAction</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">generateContainerConfig</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">restartCount</span><span class="p">,</span> <span class="nx">podIP</span><span class="p">,</span> <span class="nx">imageRef</span><span class="p">,</span> <span class="nx">podIPs</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cleanupAction</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">cleanupAction</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="nx">containerID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">CreateContainer</span><span class="p">(</span><span class="nx">podSandboxID</span><span class="p">,</span> <span class="nx">containerConfig</span><span class="p">,</span> <span class="nx">podSandboxConfig</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">grpcstatus</span><span class="p">.</span><span class="nf">FromError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">recordContainerEvent</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">containerID</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">FailedToCreateContainer</span><span class="p">,</span> <span class="s">&#34;Error: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Message</span><span class="p">())</span>
		<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Message</span><span class="p">(),</span> <span class="nx">ErrCreateContainer</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then look at the code to generate the containerConfig, in fact, this part is very simple, is generated from the container resources in the container of all the cgroup information, the source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">generateContainerConfig</span><span class="p">(</span><span class="nx">container</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">restartCount</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">podIP</span><span class="p">,</span> <span class="nx">imageRef</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">podIPs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">nsTarget</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">ContainerConfig</span><span class="p">,</span> <span class="kd">func</span><span class="p">(),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">opts</span><span class="p">,</span> <span class="nx">cleanupAction</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeHelper</span><span class="p">.</span><span class="nf">GenerateRunContainerOptions</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">podIP</span><span class="p">,</span> <span class="nx">podIPs</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">ContainerConfig</span><span class="p">{</span>
		<span class="nx">Metadata</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">ContainerMetadata</span><span class="p">{</span>
			<span class="nx">Name</span><span class="p">:</span>    <span class="nx">container</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
			<span class="nx">Attempt</span><span class="p">:</span> <span class="nx">restartCountUint32</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">Image</span><span class="p">:</span>       <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">ImageSpec</span><span class="p">{</span><span class="nx">Image</span><span class="p">:</span> <span class="nx">imageRef</span><span class="p">},</span>
		<span class="nx">Command</span><span class="p">:</span>     <span class="nx">command</span><span class="p">,</span>
		<span class="nx">Args</span><span class="p">:</span>        <span class="nx">args</span><span class="p">,</span>
		<span class="nx">WorkingDir</span><span class="p">:</span>  <span class="nx">container</span><span class="p">.</span><span class="nx">WorkingDir</span><span class="p">,</span>
		<span class="nx">Labels</span><span class="p">:</span>      <span class="nf">newContainerLabels</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">pod</span><span class="p">),</span>
		<span class="nx">Annotations</span><span class="p">:</span> <span class="nf">newContainerAnnotations</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">restartCount</span><span class="p">,</span> <span class="nx">opts</span><span class="p">),</span>
		<span class="nx">Devices</span><span class="p">:</span>     <span class="nf">makeDevices</span><span class="p">(</span><span class="nx">opts</span><span class="p">),</span>
		<span class="nx">Mounts</span><span class="p">:</span>      <span class="nx">m</span><span class="p">.</span><span class="nf">makeMounts</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">container</span><span class="p">),</span>
		<span class="nx">LogPath</span><span class="p">:</span>     <span class="nx">containerLogsPath</span><span class="p">,</span>
		<span class="nx">Stdin</span><span class="p">:</span>       <span class="nx">container</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
		<span class="nx">StdinOnce</span><span class="p">:</span>   <span class="nx">container</span><span class="p">.</span><span class="nx">StdinOnce</span><span class="p">,</span>
		<span class="nx">Tty</span><span class="p">:</span>         <span class="nx">container</span><span class="p">.</span><span class="nx">TTY</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// set platform specific configurations.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">applyPlatformSpecificContainerConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">nsTarget</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">cleanupAction</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="k">return</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">cleanupAction</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">applyPlatformSpecificContainerConfig</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">ContainerConfig</span><span class="p">,</span> <span class="nx">container</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">uid</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">nsTarget</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">Linux</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">generateLinuxContainerConfig</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">pod</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">nsTarget</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">generateLinuxContainerConfig</span><span class="p">(</span><span class="nx">container</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">uid</span> <span class="o">*</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">username</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">nsTarget</span> <span class="o">*</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span> <span class="o">*</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">LinuxContainerConfig</span> <span class="p">{</span>
	<span class="nx">lc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">LinuxContainerConfig</span><span class="p">{</span>
		<span class="nx">Resources</span><span class="p">:</span>       <span class="o">&amp;</span><span class="nx">runtimeapi</span><span class="p">.</span><span class="nx">LinuxContainerResources</span><span class="p">{},</span>
		<span class="nx">SecurityContext</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nf">determineEffectiveSecurityContext</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">username</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="c1">// set linux container resources
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">cpuShares</span> <span class="kt">int64</span>
	<span class="nx">cpuRequest</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Requests</span><span class="p">.</span><span class="nf">Cpu</span><span class="p">()</span>
	<span class="nx">cpuLimit</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nf">Cpu</span><span class="p">()</span>
	<span class="nx">memoryLimit</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Limits</span><span class="p">.</span><span class="nf">Memory</span><span class="p">().</span><span class="nf">Value</span><span class="p">()</span>
	<span class="nx">oomScoreAdj</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">qos</span><span class="p">.</span><span class="nf">GetContainerOOMScoreAdjust</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">machineInfo</span><span class="p">.</span><span class="nx">MemoryCapacity</span><span class="p">)))</span>

	<span class="k">if</span> <span class="nx">cpuRequest</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cpuLimit</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">cpuShares</span> <span class="p">=</span> <span class="nf">milliCPUToShares</span><span class="p">(</span><span class="nx">cpuLimit</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">())</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// if cpuRequest.Amount is nil, then milliCPUToShares will return the minimal number
</span><span class="c1"></span>		<span class="c1">// of CPU shares.
</span><span class="c1"></span>		<span class="nx">cpuShares</span> <span class="p">=</span> <span class="nf">milliCPUToShares</span><span class="p">(</span><span class="nx">cpuRequest</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuShares</span> <span class="p">=</span> <span class="nx">cpuShares</span>
	<span class="k">if</span> <span class="nx">memoryLimit</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">MemoryLimitInBytes</span> <span class="p">=</span> <span class="nx">memoryLimit</span>
	<span class="p">}</span>

	<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">OomScoreAdj</span> <span class="p">=</span> <span class="nx">oomScoreAdj</span>

	<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">cpuCFSQuota</span> <span class="p">{</span>
		<span class="nx">cpuPeriod</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">quotaPeriod</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">kubefeatures</span><span class="p">.</span><span class="nx">CPUCFSQuotaPeriod</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">cpuPeriod</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">cpuCFSQuotaPeriod</span><span class="p">.</span><span class="nx">Duration</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">cpuQuota</span> <span class="o">:=</span> <span class="nf">milliCPUToQuota</span><span class="p">(</span><span class="nx">cpuLimit</span><span class="p">.</span><span class="nf">MilliValue</span><span class="p">(),</span> <span class="nx">cpuPeriod</span><span class="p">)</span>
		<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuQuota</span> <span class="p">=</span> <span class="nx">cpuQuota</span>
		<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">CpuPeriod</span> <span class="p">=</span> <span class="nx">cpuPeriod</span>
	<span class="p">}</span>

	<span class="nx">lc</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">HugepageLimits</span> <span class="p">=</span> <span class="nf">GetHugepageLimitsFromResources</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">lc</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After the containerConfig is generated, the CRI interface is called to create the container, which includes the creation of container-level cgroups.</p>
<h3 id="oom-scoring">OOM scoring</h3>
<p>As we all know, when a node runs out of memory, it will trigger the system&rsquo;s OOM Killer, and the kubelet must ensure that pods of different QoS types are killed in a different order. Let&rsquo;s take a look at how the kubelet guarantees the order in which pods are killed.</p>
<h4 id="linux-oom">Linux OOM</h4>
<p>Linux has an OOM KILLER mechanism that enables its own algorithm to selectively kill some processes when the system runs out of memory. Some files related to system OOM are</p>
<p><code>/proc/&lt;pid&gt;/oom_score_adj</code>: When calculating the final badness score, oom_score_adj is added to the result, so that the user can use this value to protect a process from being killed or to kill a process every time, from -1000 to 1000. If the value is set to -1000, the process will never be killed, because the badness score will always return 0.</p>
<p><code>/proc/&lt;pid&gt;/oom_adj</code>: This parameter is there for compatibility with older versions of the kernel. It is set in the range -17 to 15.</p>
<p><code>/proc/&lt;pid&gt;/oom_score</code> : This value is calculated by combining the memory consumption, CPU time (utime + stime), survival time (uptime - start time) and oom_adj of the process.</p>
<p>The OOM killer mechanism decides which process to kill based on oom_score and oom_score_adj.</p>
<h4 id="kubelets-oom-scoring-system">kubelet&rsquo;s OOM scoring system</h4>
<p>With the foundation of OOM Killer in place, let&rsquo;s look at how kubelet sets up oom_score_adj for different kinds of processes. collected from the code as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">dockerOOMScoreAdj</span> <span class="o">=</span> -999
KubeletOOMScoreAdj <span class="nv">int</span> <span class="o">=</span> -999
KubeProxyOOMScoreAdj  <span class="nv">int</span> <span class="o">=</span> -999
defaultSandboxOOMAdj <span class="nv">int</span> <span class="o">=</span> -998
guaranteedOOMScoreAdj <span class="nv">int</span> <span class="o">=</span> -998
besteffortOOMScoreAdj <span class="nv">int</span> <span class="o">=</span> <span class="m">1000</span>
</code></pre></td></tr></table>
</div>
</div><p>The dockershim process (dockerOOMScoreAdj), the kubelet process (KubeletOOMScoreAdj), and the kubeproxy process (KubeProxyOOMScoreAdj) have oom_score_adj set to -999, indicating that it is very important, but not to -1000.</p>
<p>The pod pause container (defaultSandboxOOMAdj) and the Guaranteed type pod (guaranteedOOMScoreAdj) have oom_score_adj set to -998, indicating that they are also important, but can still be killed relative to the components above.</p>
<p>The BestEffort type pod (besteffortOOMScoreAdj), oom_score_adj is set to 1000, which means that the BestEffort type pod is the most likely to be killed.</p>
<p>Finally, let&rsquo;s look at the Burstable type of pod, which is calculated as.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">min</span><span class="p">{</span><span class="nx">max</span><span class="p">[</span><span class="mi">1000</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="nx">memoryRequest</span><span class="p">)</span> <span class="o">/</span> <span class="nx">memoryCapacity</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">+</span> <span class="nx">guaranteedOOMScoreAdj</span><span class="p">],</span> <span class="mi">999</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It can be seen that a pod of Burstable type must score larger than Guaranteed and smaller than BestEffort, and the larger the request value of memory, the less likely it is to be killed.</p>
<p>The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetContainerOOMScoreAdjust</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">container</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">memoryCapacity</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">types</span><span class="p">.</span><span class="nf">IsCriticalPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Critical pods should be the last to get killed.
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">guaranteedOOMScoreAdj</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="nx">v1qos</span><span class="p">.</span><span class="nf">GetPodQOS</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSGuaranteed</span><span class="p">:</span>
		<span class="c1">// Guaranteed containers should be the last to get killed.
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">guaranteedOOMScoreAdj</span>
	<span class="k">case</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">PodQOSBestEffort</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">besteffortOOMScoreAdj</span>
	<span class="p">}</span>

	<span class="nx">memoryRequest</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Resources</span><span class="p">.</span><span class="nx">Requests</span><span class="p">.</span><span class="nf">Memory</span><span class="p">().</span><span class="nf">Value</span><span class="p">()</span>
	<span class="nx">oomScoreAdjust</span> <span class="o">:=</span> <span class="mi">1000</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="nx">memoryRequest</span><span class="p">)</span><span class="o">/</span><span class="nx">memoryCapacity</span>
	<span class="c1">// A guaranteed pod using 100% of memory can have an OOM score of 10. Ensure
</span><span class="c1"></span>	<span class="c1">// that burstable pods have a higher OOM score adjustment.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oomScoreAdjust</span><span class="p">)</span> <span class="p">&lt;</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="nx">guaranteedOOMScoreAdj</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="nx">guaranteedOOMScoreAdj</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// Give burstable pods a higher chance of survival over besteffort pods.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oomScoreAdjust</span><span class="p">)</span> <span class="o">==</span> <span class="nx">besteffortOOMScoreAdj</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oomScoreAdjust</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oomScoreAdjust</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>In summary, k8s provides three types of QoS, namely Guaranteed, Burstable and BestEffort. kubelet creates different cgroups for different types of pods to ensure that different types of pods get different resources and try to ensure high priority quality of service and improve system stability.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubelet/">kubelet</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/process-scheduling-algorithm/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Operating system process scheduling algorithm</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubelet-pod-creation-workflow/">
            <span class="next-text nav-default">Kubelet pod creation workflow</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
