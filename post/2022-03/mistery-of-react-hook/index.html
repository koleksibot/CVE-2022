<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The mystery of the React hook - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="As we all know, React has two forms of components, class components and function components, and developers can use class components and function components to achieve the same purpose and build the exact same page. Since I came across React last August, I have been using function components because they are recommended by my company. I have to say that function components are much better than class components. You can" /><meta name="keywords" content="react, Hook" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/mistery-of-react-hook/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="The mystery of the React hook" />
<meta property="og:description" content="As we all know, React has two forms of components, class components and function components, and developers can use class components and function components to achieve the same purpose and build the exact same page. Since I came across React last August, I have been using function components because they are recommended by my company. I have to say that function components are much better than class components. You can" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/mistery-of-react-hook/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-05T11:53:19+08:00" />
<meta property="article:modified_time" content="2022-03-05T11:53:19+08:00" />

<meta itemprop="name" content="The mystery of the React hook">
<meta itemprop="description" content="As we all know, React has two forms of components, class components and function components, and developers can use class components and function components to achieve the same purpose and build the exact same page. Since I came across React last August, I have been using function components because they are recommended by my company. I have to say that function components are much better than class components. You can"><meta itemprop="datePublished" content="2022-03-05T11:53:19+08:00" />
<meta itemprop="dateModified" content="2022-03-05T11:53:19+08:00" />
<meta itemprop="wordCount" content="1562">
<meta itemprop="keywords" content="react," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The mystery of the React hook"/>
<meta name="twitter:description" content="As we all know, React has two forms of components, class components and function components, and developers can use class components and function components to achieve the same purpose and build the exact same page. Since I came across React last August, I have been using function components because they are recommended by my company. I have to say that function components are much better than class components. You can"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The mystery of the React hook</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-05 11:53:19 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1562 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#i-the-basics">I. The Basics</a></li>
            <li><a href="#ii-simulating-react">II. Simulating React</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/05/def39c8b701947e892581e550089f692.png" alt="react hook"></p>
<p>As we all know, React has two forms of components, class components and function components, and developers can use class components and function components to achieve the same purpose and build the exact same page. Since I came across React last August, I have been using function components because they are recommended by my company. I have to say that function components are much better than class components. You can use useEffect to implement <code>componentDidUpdate</code>, <code>componentDidMount</code> and <code>componentWillUnmount</code> of the class component. While marveling at the power of hooks, I&rsquo;ve often wondered how <strong>React actually implements the useEffect and useState hooks</strong>? Each time a function component is rendered, the component function is simply executed once, the function is not instance (no this pointer), so how is the state of the component recorded and updated? Maybe you are like me, you will guess that the state of the function component is achieved by <strong>closures</strong>, then congratulations, your guess is right, hook is the use of the idea of closure. For those who don&rsquo;t know about closures, please move to <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures">MDN</a> to learn about the concept of closures before coming here to continue reading.</p>
<p>This article is about 15 minutes long, so I&rsquo;m sure you&rsquo;ll get something out of it. The article focuses on deepening your understanding of how hooks work by manually implementing a mock React yourself. It includes the most commonly used useEffect and useState implementations. I refer to some blogs and materials, and then manually organize their own practice.</p>
<h3 id="i-the-basics">I. The Basics</h3>
<p>Before mocking the implementation of React, we must understand some concepts.</p>
<h4 id="1-jsx">1. JSX</h4>
<p>A JSX is a normal javascript object that Babel translates into a function call called React.createElement(). The following two pieces of code, for example, are equivalent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">(</span>
  <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;greeting&#34;</span><span class="p">&gt;</span>
    <span class="nx">Hello</span><span class="p">,</span> <span class="nx">world</span><span class="o">!</span>
  <span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">);</span>

<span class="c1">// 经过babel转译后
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span>
  <span class="s1">&#39;h1&#39;</span><span class="p">,</span>
  <span class="p">{</span><span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;greeting&#39;</span><span class="p">},</span>
  <span class="s1">&#39;Hello, world!&#39;</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>React.createElement returns an ordinary javascript Object.</p>
<h4 id="2-rendering-is-actually-executing-a-function">2. Rendering is actually executing a function</h4>
<p>Each time a function component re-renders, it actually executes the component&rsquo;s function once.</p>
<p>For example, the App component below is actually executing App(props) each time it re-renders.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ii-simulating-react">II. Simulating React</h3>
<h4 id="1-a-simple-react">1. A simple React</h4>
<p>First we implement the simplest React ourselves, with only the render function. render takes a Component as an argument and exampleProps represents the Props passed to the component.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">render</span>: <span class="kt">Component</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">exampleProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">unit</span><span class="o">:</span> <span class="s2">&#34;likes&#34;</span>
        <span class="p">};</span>
        <span class="kr">const</span> <span class="nx">compo</span> <span class="o">=</span> <span class="nx">Component</span><span class="p">(</span><span class="nx">exampleProps</span><span class="p">);</span>
        <span class="nx">compo</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">compo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In order to test this simple version of React, we need a component whose render function outputs some information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;render&#34;</span><span class="p">,</span> <span class="p">{</span>
                <span class="kr">type</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
                <span class="nx">inner</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">unit</span><span class="si">}</span><span class="sb">`</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then apply it in practice to see the effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;likes&#34;}
</span><span class="c1"></span><span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;likes&#34;}
</span></code></pre></td></tr></table>
</div>
</div><p>We Component rendered twice, and both renders printed log messages.</p>
<h4 id="2-usestate">2. useState</h4>
<p>Next, we extend React to implement useState. useState can return a value and a dispatcher that can update it. useState accepts an initial value parameter that sets the initial value of the state.</p>
<blockquote>
<p>Returns a stateful value, and a function to update it.</p>
</blockquote>
<p>The function component uses useState to create and update the state of the component, which is one of the most common hooks in react. Let&rsquo;s implement useState ourselves.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">index</span>: <span class="kt">0</span><span class="p">,</span>
    <span class="nx">state</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">useState</span>: <span class="kt">defaultProp</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">cachedIndex</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defaultProp</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">currentState</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">];</span>
        <span class="kr">const</span> <span class="nx">currentSetter</span> <span class="o">=</span> <span class="nx">newValue</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">[</span><span class="nx">currentState</span><span class="p">,</span> <span class="nx">currentSetter</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">render</span>: <span class="kt">Component</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">exampleProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">unit</span><span class="o">:</span> <span class="s2">&#34;likes&#34;</span>
        <span class="p">};</span>

        <span class="kr">const</span> <span class="nx">compo</span> <span class="o">=</span> <span class="nx">Component</span><span class="p">(</span><span class="nx">exampleProps</span><span class="p">);</span>
        <span class="nx">compo</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

        <span class="nx">React</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// reset index
</span><span class="c1"></span>
        <span class="k">return</span> <span class="nx">compo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The function of closures is used here. We store the state values into React.state array and then create a currentSetter which is used to update the state values. Finally index is added to store the new state value. Due to the nature of closures, when there are multiple useState values within a component function, each cachedIndex is independent, so the state corresponding to each currentSetter is also independent. Another thing to note is that <code>React.index = 0</code> must be reset in the render function, because the index must be 0 every time the component function is executed, because the hook is also executed every time.</p>
<p>Update the Component and add state to it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kr">const</span> <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="s2">&#34;Steve&#34;</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">click</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">personArrived</span>: <span class="kt">person</span> <span class="o">=&gt;</span> <span class="nx">setName</span><span class="p">(</span><span class="nx">person</span><span class="p">),</span>
        <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;render&#34;</span><span class="p">,</span> <span class="p">{</span>
                <span class="kr">type</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
                <span class="nx">inner</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">count</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">unit</span><span class="si">}</span><span class="sb"> for </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Test component rendering.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;0 likes for Steve&#34;}
</span><span class="c1"></span><span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;0 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span>  <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;1 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">personArrived</span><span class="p">(</span><span class="s2">&#34;Peter&#34;</span><span class="p">);</span>
<span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;2 likes for Peter&#34;}
</span></code></pre></td></tr></table>
</div>
</div><p>The useState we simulated functions as expected. It is quite different from the actual useState in React, but it is enough to help us understand it.</p>
<h4 id="3-useeffect">3. useEffect</h4>
<p>useEffect is executed asynchronously, after the component function is executed. Here&rsquo;s how the documentation describes useEffect, and I&rsquo;ve excerpted a few of the most important features.</p>
<ol>
<li>The function passed to <code>useEffect</code> will run after the render is committed to the screen.</li>
<li>By default, effects run after every completed render, but you can choose to fire them <a href="https://reactjs.org/docs/hooks-reference.html#conditionally-firing-an-effect">only when certain values have changed</a>.</li>
<li>the function passed to <code>useEffect</code> may return a clean-up function.</li>
</ol>
<p>The first point means that useEffect is asynchronous, the second point means that we can pass a second parameter (dependency) to useEffect to control whether the first function parameter in useEffect is executed or not, and the third point is that the function we pass can return a function as a cleanup or unsubscribe function.</p>
<p>We will follow the above three features to implement our own useEffect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">React</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">index</span>: <span class="kt">0</span><span class="p">,</span>
    <span class="nx">state</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">useState</span>: <span class="kt">defaultProp</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">cachedIndex</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defaultProp</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kr">const</span> <span class="nx">currentState</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">];</span>
        <span class="kr">const</span> <span class="nx">currentSetter</span> <span class="o">=</span> <span class="nx">newValue</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newValue</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">[</span><span class="nx">currentState</span><span class="p">,</span> <span class="nx">currentSetter</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">useEffect</span><span class="o">:</span> <span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">dependencies</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">cachedIndex</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">hasChanged</span> <span class="o">=</span> <span class="nx">dependencies</span> <span class="o">!==</span> <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">dependencies</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">hasChanged</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">();</span>
            <span class="nx">React</span><span class="p">.</span><span class="nx">state</span><span class="p">[</span><span class="nx">cachedIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dependencies</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">React</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;unsubscribed effect&#34;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span>: <span class="kt">Component</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">exampleProps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">unit</span><span class="o">:</span> <span class="s2">&#34;likes&#34;</span>
        <span class="p">};</span>

        <span class="kr">const</span> <span class="nx">compo</span> <span class="o">=</span> <span class="nx">Component</span><span class="p">(</span><span class="nx">exampleProps</span><span class="p">);</span>
        <span class="nx">compo</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

        <span class="nx">React</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// reset index
</span><span class="c1"></span>
        <span class="k">return</span> <span class="nx">compo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Store the dependencies in React.state and compare the dependencies with React.state[cachedIndex] (the previously stored dependencies) to determine if the dependency has changed. If it has changed, we execute a callback and update the dependencies stored in React.state for the next execution.</p>
<p>We also update the Component to include the useEffect hook.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">const</span> <span class="nx">Component</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kr">const</span> <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="s2">&#34;Steve&#34;</span><span class="p">);</span>

    <span class="kr">const</span> <span class="nx">exitThis</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Effect ran&#34;</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">name</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">click</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">personArrived</span>: <span class="kt">person</span> <span class="o">=&gt;</span> <span class="nx">setName</span><span class="p">(</span><span class="nx">person</span><span class="p">),</span>
        <span class="nx">unsubscribe</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">exitThis</span><span class="p">(),</span>
        <span class="nx">render</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;render&#34;</span><span class="p">,</span> <span class="p">{</span>
                <span class="kr">type</span><span class="o">:</span> <span class="s2">&#34;div&#34;</span><span class="p">,</span>
                <span class="nx">inner</span><span class="o">:</span> <span class="sb">`</span><span class="si">${</span><span class="nx">count</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">props</span><span class="p">.</span><span class="nx">unit</span><span class="si">}</span><span class="sb"> for </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The final return object contains an unsubscribe, which is used to simulate the cleanup work of useEffect.</p>
<p>Test the useEffect function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kd">let</span> <span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span>
<span class="c1">// log: Effect ran
</span><span class="c1">//      render {type: &#34;div&#34;, inner: &#34;0 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;0 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span> <span class="c1">// log: render {type: &#34;div&#34;, inner: &#34;1 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="nx">App</span><span class="p">.</span><span class="nx">personArrived</span><span class="p">(</span><span class="s2">&#34;Peter&#34;</span><span class="p">);</span>
<span class="nx">App</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">Component</span><span class="p">);</span>
<span class="c1">// log: Effect ran
</span><span class="c1">//      render {type: &#34;div&#34;, inner: &#34;2 likes for Steve&#34;}
</span><span class="c1"></span>
<span class="nx">App</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span> <span class="c1">// log: unsubscribed effect
</span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the useEffect function is executed when the component is first loaded, and also when the name is changed, and finally the unsubscribe is called to perform the cleanup.</p>
<p>This is almost the end of the content, you must have a deeper understanding of hooks. There are more similar hooks that you can try to simulate yourselves, such as useCallback.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/react/">react</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/webpack-tutorial/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Webpack Quick Start</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/typescript-builtin-generic/">
            <span class="next-text nav-default">Built-in Generics in TypeScript</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
