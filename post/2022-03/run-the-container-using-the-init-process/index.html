<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Run the Container using the init processs - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Anyone who has followed Bare Metal related projects will have seen how the boot process, how to quickly provision a physical server, etc. is implemented, usually with a LiveOS running to achieve certain actions. The Tinkerbell project uses Linuxkit as the LiveOS, and the Plunder project uses BOOTy as the LiveOS. a few days ago @thebsdbox took out a part of BOOTy and showed the main implementation as ginit, so we can better understand the details of the installation." /><meta name="keywords" content="Container, Init Process" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/run-the-container-using-the-init-process/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Run the Container using the init processs" />
<meta property="og:description" content="Anyone who has followed Bare Metal related projects will have seen how the boot process, how to quickly provision a physical server, etc. is implemented, usually with a LiveOS running to achieve certain actions. The Tinkerbell project uses Linuxkit as the LiveOS, and the Plunder project uses BOOTy as the LiveOS. a few days ago @thebsdbox took out a part of BOOTy and showed the main implementation as ginit, so we can better understand the details of the installation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/run-the-container-using-the-init-process/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-06T16:58:30+08:00" />
<meta property="article:modified_time" content="2022-03-06T16:58:30+08:00" />

<meta itemprop="name" content="Run the Container using the init processs">
<meta itemprop="description" content="Anyone who has followed Bare Metal related projects will have seen how the boot process, how to quickly provision a physical server, etc. is implemented, usually with a LiveOS running to achieve certain actions. The Tinkerbell project uses Linuxkit as the LiveOS, and the Plunder project uses BOOTy as the LiveOS. a few days ago @thebsdbox took out a part of BOOTy and showed the main implementation as ginit, so we can better understand the details of the installation."><meta itemprop="datePublished" content="2022-03-06T16:58:30+08:00" />
<meta itemprop="dateModified" content="2022-03-06T16:58:30+08:00" />
<meta itemprop="wordCount" content="2159">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Run the Container using the init processs"/>
<meta name="twitter:description" content="Anyone who has followed Bare Metal related projects will have seen how the boot process, how to quickly provision a physical server, etc. is implemented, usually with a LiveOS running to achieve certain actions. The Tinkerbell project uses Linuxkit as the LiveOS, and the Plunder project uses BOOTy as the LiveOS. a few days ago @thebsdbox took out a part of BOOTy and showed the main implementation as ginit, so we can better understand the details of the installation."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Run the Container using the init processs</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-06 16:58:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2159 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#demonstration-of-the-process">Demonstration of the process</a>
          <ul>
            <li><a href="#creating-a-raw-image-from-a-container-image">Creating a RAW image from a Container image</a></li>
            <li><a href="#use-ginit-to-make-initramfsimg">Use ginit to make initramfs.img</a></li>
            <li><a href="#running-the-entrypoint-command-in-the-container-through-qemu">Running the EntryPoint command in the Container through QEMU</a></li>
          </ul>
        </li>
        <li><a href="#ginit-implementation">ginit implementation</a>
          <ul>
            <li><a href="#create-system-device-and-mount-it">Create system device and mount it</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Anyone who has followed Bare Metal related projects will have seen how the boot process, how to quickly provision a physical server, etc. is implemented, usually with a LiveOS running to achieve certain actions.
The Tinkerbell project uses Linuxkit as the LiveOS, and the Plunder project uses BOOTy as the LiveOS. a few days ago @thebsdbox took out a part of BOOTy and showed the main implementation as ginit, so we can better understand the details of the installation. Take a look at this project today.</p>
<p>If you install a CentOS, it is usually started with kernel + initramfs.img. initramfs.img contains systemd, anaconda, dracut and some other components, and then systemd specifies the different Target affiliations/dependencies/order to complete the final Anaconda call. Anaconda calls.</p>
<p>Anaconda decides how to install itself by parsing the KickStart parameter in <code>/proc/cmdline</code>.</p>
<p>The ginit project shows the following.</p>
<ul>
<li>Making initramfs.img</li>
<li>Making a RAW image from a Container image</li>
<li>Running a virtual machine with a RAW image and the Linux Kernel via QEMU</li>
<li>ginit automatically runs the entrypoint command in Container</li>
</ul>
<h2 id="demonstration-of-the-process">Demonstration of the process</h2>
<h3 id="creating-a-raw-image-from-a-container-image">Creating a RAW image from a Container image</h3>
<p>The RAW image will not end up containing the Kernel part, so take the Nginx Container as an example. Extract the <code>Entrypoint</code> from the nginx:latest image, prepare a RAW image via <code>dd</code>, format it as ext4, mount the raw image locally as a loop device, copy the Nginx image to the mount point via <code>docker export</code>, unmount the mount point, and finally The RAW image contains all the contents of the Nginx Container. The RAW image here does not contain the kernel, so it cannot be started directly and is only used as a dependency for subsequent actions.</p>
<p>The default <code>Entrypoint</code> for the Nginx Container is <code>docker-entrypoint.sh</code>, which is a script that does some parameter checking.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nb">echo</span> <span class="s2">&#34;Lets build you a disk image!&#34;</span>
docker pull <span class="nv">$1</span>
<span class="nv">ENTRYPOINT</span><span class="o">=</span><span class="k">$(</span>docker inspect -f <span class="s1">&#39;{{.Config.Entrypoint}}&#39;</span> <span class="nv">$1</span> <span class="p">|</span> sed <span class="s1">&#39;s/[][]//g&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">&#34;Creating a 200MB Disk&#34;</span>
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>disk.img <span class="nv">bs</span><span class="o">=</span>1024k <span class="nv">count</span><span class="o">=</span><span class="m">200</span>
mkfs.ext4 -F disk.img
mkdir -p /tmp/disk
mount -t ext4 -o loop disk.img /tmp/disk/
<span class="nb">echo</span> <span class="s2">&#34;Converting </span><span class="nv">$1</span><span class="s2"> to disk image&#34;</span>
docker create --name exporter <span class="nv">$1</span> null
docker <span class="nb">export</span> exporter <span class="p">|</span> tar xv -C /tmp/disk
docker rm exporter
umount /tmp/disk
<span class="nb">echo</span> The <span class="nb">command</span> <span class="nv">$ENTRYPOINT</span> will start this container
</code></pre></td></tr></table>
</div>
</div><h3 id="use-ginit-to-make-initramfsimg">Use ginit to make initramfs.img</h3>
<p>Static compile ginit; download and compile busybox, place the ginit compilation init under the <code>/</code> path, archive busybox via cpio, and compress it using gzip. Once all the processes are complete, copy the resulting initramfs.cpio.gz to the project path. The initramfs will eventually contain busybox + ginit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># syntax=docker/dockerfile:experimental</span><span class="err">
</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Build ginit as an init</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> golang:1.17-alpine as dev</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk add --no-cache git ca-certificates gcc linux-headers musl-dev<span class="err">
</span><span class="err"></span><span class="k">COPY</span> . /go/src/github.com/thebsdbox/ginit/<span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go/src/github.com/thebsdbox/ginit</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on
<span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,sharing<span class="o">=</span>locked,id<span class="o">=</span>gomod,target<span class="o">=</span>/go/pkg/mod/cache <span class="se">\
</span><span class="se"></span>    --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,sharing<span class="o">=</span>locked,id<span class="o">=</span>goroot,target<span class="o">=</span>/root/.cache/go-build <span class="se">\
</span><span class="se"></span>    <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">1</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build -a -ldflags <span class="s2">&#34;-linkmode external -extldflags &#39;-static&#39; -s -w&#34;</span> -o init<span class="err">
</span><span class="err"></span>    <span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Build Busybox</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> gcc:10.1.0 as Busybox</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update<span class="p">;</span> apt-get install -y cpio<span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -O https://busybox.net/downloads/busybox-1.31.1.tar.bz2<span class="err">
</span><span class="err"></span><span class="k">RUN</span> tar -xf busybox*bz2<span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> busybox-1.31.1</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> make defconfig<span class="p">;</span> make <span class="nv">LDFLAGS</span><span class="o">=</span>-static <span class="nv">CONFIG_PREFIX</span><span class="o">=</span>./initramfs install<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> initramfs </span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>dev /go/src/github.com/thebsdbox/ginit/init .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Package initramfs</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> find . -print0 <span class="p">|</span> cpio --null -ov --format<span class="o">=</span>newc &gt; ../initramfs.cpio <span class="err">
</span><span class="err"></span><span class="k">RUN</span> gzip ../initramfs.cpio<span class="err">
</span><span class="err"></span><span class="k">RUN</span> mv ../initramfs.cpio.gz /<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>Busybox /initramfs.cpio.gz .<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="running-the-entrypoint-command-in-the-container-through-qemu">Running the EntryPoint command in the Container through QEMU</h3>
<p>As of now, we have initramfs.img, we have the raw image, but we are still missing the Linux Kernel. You can download the <code>boot executable bzImage</code> file directly from <a href="http://archive.ubuntu.com/ubuntu/dists/focal-updates/main/installer-amd64/current/legacy-images/netboot/ubuntu-installer/amd64/">netboot</a> provided by Ubuntu.</p>
<p>Now that all the preparations are done, we can run the virtual machine directly from QEMU, with Nginx in the RAW Image and ginit in the initramfs.</p>
<p>As mentioned earlier, the default <code>Entrypoint</code> for the Nginx Container is <code>docker-entrypoint.sh</code>, which is used to do some parameter wrapping, so here I changed the parameter to <code>/usr/sbin/nginx</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">qemu-system-x86_64 -nographic <span class="se">\
</span><span class="se"></span>  -kernel ./linux <span class="se">\
</span><span class="se"></span>  -append <span class="s2">&#34;entrypoint=/usr/sbin/nginx root=/dev/sda console=ttyS0&#34;</span> <span class="se">\
</span><span class="se"></span>  -initrd ./initramfs.cpio.gz <span class="se">\
</span><span class="se"></span>  -hda ./disk.img <span class="se">\
</span><span class="se"></span>  -m 1G
</code></pre></td></tr></table>
</div>
</div><p>The virtual machine console is <code>ttyS0</code>, which can be run through a terminal to view the boot log directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">...
[    1.469920] rtc_cmos 00:00: setting system clock to 2022-03-05T06:36:19 UTC (1646462179)
[    1.525397] ata1.00: ATA-7: QEMU HARDDISK, 2.5+, max UDMA/100
[    1.525579] ata1.00: 409600 sectors, multi 16: LBA48 
[    1.532980] ata2.00: ATAPI: QEMU DVD-ROM, 2.5+, max UDMA/100
[    1.540741] scsi 0:0:0:0: Direct-Access     ATA      QEMU HARDDISK    2.5+ PQ: 0 ANSI: 5
[    1.545673] sd 0:0:0:0: [sda] 409600 512-byte logical blocks: (210 MB/200 MiB)
[    1.547063] sd 0:0:0:0: [sda] Write Protect is off
[    1.547515] sd 0:0:0:0: Attached scsi generic sg0 type 0
[    1.548188] sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn&#39;t support DPO or FUA
[    1.550227] scsi 1:0:0:0: CD-ROM            QEMU     QEMU DVD-ROM     2.5+ PQ: 0 ANSI: 5
[    1.568178] sd 0:0:0:0: [sda] Attached SCSI disk
[    1.578345] sr 1:0:0:0: [sr0] scsi3-mmc drive: 4x/4x cd/rw xa/form2 tray
[    1.578736] cdrom: Uniform CD-ROM driver Revision: 3.20
[    1.582611] sr 1:0:0:0: Attached scsi generic sg1 type 5
[    1.595655] Freeing unused decrypted memory: 2040K
[    1.666044] Freeing unused kernel image memory: 2712K
[    1.666482] Write protecting the kernel read-only data: 22528k
[    1.669246] Freeing unused kernel image memory: 2008K
[    1.670507] Freeing unused kernel image memory: 1192K
[    1.742691] x86/mm: Checked W+X mappings: passed, no W+X pages found.
[    1.743002] Run /init as init process
INFO[0000] Folder created [dev] -&gt; [/dev]          
INFO[0000] Folder created [proc] -&gt; [/proc]        
INFO[0000] Folder created [sys] -&gt; [/sys]          
INFO[0000] Folder created [tmp] -&gt; [/tmp]          
INFO[0000] Mounted [dev] -&gt; [/dev]                 
INFO[0000] Mounted [proc] -&gt; [/proc]               
INFO[0000] Mounted [sys] -&gt; [/sys]                 
INFO[0000] Mounted [tmp] -&gt; [/tmp]                 
INFO[0000] Starting DHCP client                    
INFO[0000] Starting ginit                          
ERRO[0000] Error finding adapter [Link not found]  
[    2.209227] tsc: Refined TSC clocksource calibration: 2893.182 MHz
[    2.209573] clocksource: tsc: mask: 0xffffffffffffffff max_cycles: 0x29b41aa25d4, max_idle_ns: 440795325238 ns
[    2.209984] clocksource: Switched to clocksource tsc
INFO[0002] Beginning provisioning process          
ERRO[0002] route ip+net: no such network interface 
INFO[0002] Folder created [root] -&gt; [/mnt]         
[    3.902861] random: fast init done
[    3.912319] EXT4-fs (sda): recovery complete
[    3.913757] EXT4-fs (sda): mounted filesystem with ordered data mode. Opts: (null)
[    3.914463] ext4 filesystem being mounted at /mnt supports timestamps until 2038 (0x7fffffff)
INFO[0002] Mounted [root] -&gt; [/mnt]                
INFO[0002] Mounted [dev] -&gt; [/mnt/dev]             
INFO[0002] Mounted [proc] -&gt; [/mnt/proc]           
INFO[0002] Starting Shell                          
INFO[0002] Waiting for command to finish...        
/ #
</code></pre></td></tr></table>
</div>
</div><p>The <code>/init</code> in <code>[ 1.743002] Run /init as init process</code> is already the <code>ginit</code> we compiled above, and the log output of the <code>ginit</code> run is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">INFO[0000] Folder created [dev] -&gt; [/dev]          
INFO[0000] Folder created [proc] -&gt; [/proc]        
INFO[0000] Folder created [sys] -&gt; [/sys]          
INFO[0000] Folder created [tmp] -&gt; [/tmp]          
INFO[0000] Mounted [dev] -&gt; [/dev]                 
INFO[0000] Mounted [proc] -&gt; [/proc]               
INFO[0000] Mounted [sys] -&gt; [/sys]                 
INFO[0000] Mounted [tmp] -&gt; [/tmp]                 
INFO[0000] Starting DHCP client                    
INFO[0000] Starting ginit                          
ERRO[0000] Error finding adapter [Link not found]  
[    2.209227] tsc: Refined TSC clocksource calibration: 2893.182 MHz
[    2.209573] clocksource: tsc: mask: 0xffffffffffffffff max_cycles: 0x29b41aa25d4, max_idle_ns: 440795325238 ns
[    2.209984] clocksource: Switched to clocksource tsc
INFO[0002] Beginning provisioning process          
ERRO[0002] route ip+net: no such network interface 
INFO[0002] Folder created [root] -&gt; [/mnt]         
[    3.902861] random: fast init done
[    3.912319] EXT4-fs (sda): recovery complete
[    3.913757] EXT4-fs (sda): mounted filesystem with ordered data mode. Opts: (null)
[    3.914463] ext4 filesystem being mounted at /mnt supports timestamps until 2038 (0x7fffffff)
INFO[0002] Mounted [root] -&gt; [/mnt]                
INFO[0002] Mounted [dev] -&gt; [/mnt/dev]             
INFO[0002] Mounted [proc] -&gt; [/mnt/proc]           
INFO[0002] Starting Shell                          
INFO[0002] Waiting for command to finish.
</code></pre></td></tr></table>
</div>
</div><p>There are several things: create the necessary paths, create the corresponding devices, start a DHCP Client to get the IP address, mount the RAW image to /mnt, run the program specified in the <code>entrypoint</code> parameter via <code>chroot</code>, in this case <code>/usr/sbin/nginx</code>, and finally provide a shell environment to the user. We can see what processes are currently running with the <code>ps</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">/ # ps -ef |grep -v &#39;\[&#39;
PID   USER     TIME  COMMAND
    1 0         0:01 /init
  178 0         0:00 nginx: master process /usr/sbin/nginx
  179 0         0:00 /bin/sh
  180 101       0:00 nginx: worker process
  193 0         0:00 ps -ef
/ # df 
Filesystem           1K-blocks      Used Available Use% Mounted on
devtmpfs                497020         4    497016   0% /dev
tmpfs                   502392         0    502392   0% /tmp
/dev/sda                181984    150940     16708  90% /mnt
devtmpfs                497020         4    497016   0% /mnt/dev
/ # ls /mnt/docker-entrypoint.sh 
/mnt/docker-entrypoint.sh
/ # ls /mnt/usr/sbin/nginx
/mnt/usr/sbin/nginx
/ # ls -hl /init
-rwxr-xr-x    1 0        0           3.4M Mar  5 04:20 /init
</code></pre></td></tr></table>
</div>
</div><p>Now that we have the instructions to run in a Container Image running through the Linux kernel with initramfs, in a Bare Metal scenario, we can build Nginx into initramfs, replace Nginx with Docker or Container, and expose it. The physical server is used as the Docker Server, and the standby server is used as the Docker Client to connect to the physical server to run the specified container, and finally complete the installation of the physical server OS.</p>
<h2 id="ginit-implementation">ginit implementation</h2>
<h3 id="create-system-device-and-mount-it">Create system device and mount it</h3>
<p>The <code>DefaultMounts</code> and <code>DefaultDevices</code> define some mandatory devices such as <code>/dev/null</code> , <code>/dev/random</code> , <code>/dev/urandom</code> , and mount points such as <code>/dev</code> , <code>/proc</code> , <code>/tmp</code> , <code>/sys</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">urandom</span> <span class="o">:=</span> <span class="nx">Device</span><span class="p">{</span>
		<span class="nx">CreateDevice</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>

		<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;urandom&#34;</span><span class="p">,</span>
		<span class="nx">Path</span><span class="p">:</span>  <span class="s">&#34;/dev/urandom&#34;</span><span class="p">,</span>
		<span class="nx">Mode</span><span class="p">:</span>  <span class="nx">syscall</span><span class="p">.</span><span class="nx">S_IFCHR</span><span class="p">,</span>
		<span class="nx">Major</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="nx">Minor</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">dev</span> <span class="o">:=</span> <span class="nx">Mount</span><span class="p">{</span>
		<span class="nx">CreateMount</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">EnableMount</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">Name</span><span class="p">:</span>        <span class="s">&#34;dev&#34;</span><span class="p">,</span>
		<span class="nx">Source</span><span class="p">:</span>      <span class="s">&#34;devtmpfs&#34;</span><span class="p">,</span>
		<span class="nx">Path</span><span class="p">:</span>        <span class="s">&#34;/dev&#34;</span><span class="p">,</span>
		<span class="nx">FSType</span><span class="p">:</span>      <span class="s">&#34;devtmpfs&#34;</span><span class="p">,</span>
		<span class="nx">Flags</span><span class="p">:</span>       <span class="nx">syscall</span><span class="p">.</span><span class="nx">MS_MGC_VAL</span><span class="p">,</span>
		<span class="nx">Mode</span><span class="p">:</span>        <span class="mo">0777</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">m</span><span class="p">.</span><span class="nx">Mount</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Mount</span><span class="p">,</span> <span class="nx">dev</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//cmd.Execute()
</span><span class="c1"></span><span class="nx">m</span> <span class="o">:=</span> <span class="nx">realm</span><span class="p">.</span><span class="nf">DefaultMounts</span><span class="p">()</span>
<span class="nx">d</span> <span class="o">:=</span> <span class="nx">realm</span><span class="p">.</span><span class="nf">DefaultDevices</span><span class="p">()</span>
<span class="nx">dev</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetMount</span><span class="p">(</span><span class="s">&#34;dev&#34;</span><span class="p">)</span>
<span class="nx">dev</span><span class="p">.</span><span class="nx">CreateMount</span> <span class="p">=</span> <span class="kc">true</span>
<span class="nx">dev</span><span class="p">.</span><span class="nx">EnableMount</span> <span class="p">=</span> <span class="kc">true</span>

<span class="nx">proc</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetMount</span><span class="p">(</span><span class="s">&#34;proc&#34;</span><span class="p">)</span>
<span class="nx">proc</span><span class="p">.</span><span class="nx">CreateMount</span> <span class="p">=</span> <span class="kc">true</span>
<span class="nx">proc</span><span class="p">.</span><span class="nx">EnableMount</span> <span class="p">=</span> <span class="kc">true</span>

<span class="nx">tmp</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetMount</span><span class="p">(</span><span class="s">&#34;tmp&#34;</span><span class="p">)</span>
<span class="nx">tmp</span><span class="p">.</span><span class="nx">CreateMount</span> <span class="p">=</span> <span class="kc">true</span>
<span class="nx">tmp</span><span class="p">.</span><span class="nx">EnableMount</span> <span class="p">=</span> <span class="kc">true</span>

<span class="nx">sys</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetMount</span><span class="p">(</span><span class="s">&#34;sys&#34;</span><span class="p">)</span>
<span class="nx">sys</span><span class="p">.</span><span class="nx">CreateMount</span> <span class="p">=</span> <span class="kc">true</span>
<span class="nx">sys</span><span class="p">.</span><span class="nx">EnableMount</span> <span class="p">=</span> <span class="kc">true</span>

<span class="c1">// Create all folders
</span><span class="c1"></span><span class="nx">m</span><span class="p">.</span><span class="nf">CreateFolder</span><span class="p">()</span>
<span class="c1">// Ensure that /dev is mounted (first)
</span><span class="c1"></span><span class="nx">m</span><span class="p">.</span><span class="nf">MountNamed</span><span class="p">(</span><span class="s">&#34;dev&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

<span class="c1">// Create all devices
</span><span class="c1"></span><span class="nx">d</span><span class="p">.</span><span class="nf">CreateDevice</span><span class="p">()</span>

<span class="c1">// Mount any additional mounts
</span><span class="c1"></span><span class="nx">m</span><span class="p">.</span><span class="nf">MountAll</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>After the basic environment is prepared, start the DHCP Client and obtain an IP address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Starting DHCP client&#34;</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">realm</span><span class="p">.</span><span class="nf">DHCPClient</span><span class="p">()</span>

	<span class="c1">// HERE IS WHERE THE MAIN CODE GOES
</span><span class="c1"></span>	<span class="nx">log</span><span class="p">.</span><span class="nf">Infoln</span><span class="p">(</span><span class="s">&#34;Starting ginit&#34;</span><span class="p">)</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Infoln</span><span class="p">(</span><span class="s">&#34;Beginning provisioning process&#34;</span><span class="p">)</span>

	<span class="nx">mac</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">realm</span><span class="p">.</span><span class="nf">GetMAC</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Errorln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="c1">//realm.Shell()
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">mac</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that the system environment is ready and the network is ready, it is time to run the specific commands. The way to get the commands is by parsing <code>/proc/cmdline</code>, <code>/proc/cmdline</code> is passed through <code>--append</code> when we create the VM.</p>
<p>After parsing the <code>root</code> and <code>entrypoint</code> parameter values, <code>root</code> is mounted to the corresponding mount point via <code>Mount</code>, and <code>entrypoint</code> is run via <code>chroot</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">   <span class="nx">stuffs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ParseCmdLine</span><span class="p">(</span><span class="nx">CmdlinePath</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Errorln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">realm</span><span class="p">.</span><span class="nf">MountRootVolume</span><span class="p">(</span><span class="nx">stuffs</span><span class="p">[</span><span class="s">&#34;root&#34;</span><span class="p">])</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Disk Error: [%v]&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;/usr/sbin/chroot&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;/mnt&#34;</span><span class="p">,</span> <span class="nx">stuffs</span><span class="p">[</span><span class="s">&#34;entrypoint&#34;</span><span class="p">]}</span><span class="o">...</span><span class="p">)</span>
<span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;command error [%v]&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error [%v]&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">realm</span><span class="p">.</span><span class="nf">Shell</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>After all programs are run, a Shell environment is provided to the user.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Shell will Start a userland shell
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Shell</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Shell stuff
</span><span class="c1"></span>	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Starting Shell&#34;</span><span class="p">)</span>

	<span class="c1">// TTY hack to support ctrl+c
</span><span class="c1"></span>	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;/usr/bin/setsid&#34;</span><span class="p">,</span> <span class="s">&#34;cttyhack&#34;</span><span class="p">,</span> <span class="s">&#34;/bin/sh&#34;</span><span class="p">)</span>
	<span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Shell error [%v]&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Waiting for command to finish...&#34;</span><span class="p">)</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Shell error [%v]&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>ginit is a minimal implementation that makes it easy to quickly understand what init does, and replacing ginit with systemd does the same thing, but it&rsquo;s easy to get lost in the piles of Target dependencies. In the process of searching for information, I also saw that <a href="https://github.com/QuentinPerez/busygoxdoes">https://github.com/QuentinPerez/busygoxdoes</a> something similar, which can be used as a reference.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/edns-client-subnet/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Introduction to EDNS Client Subnet Protocol</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/solve-gin-router-path-conflict/">
            <span class="next-text nav-default">Solve Gin Router Path Conflict</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
