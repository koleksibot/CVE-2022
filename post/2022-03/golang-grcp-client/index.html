<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Implementing a simple gRPC client using Golang - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes how to implement a simple rpc client using golang. This can provide some help in understanding the operation of the gRPC protocol." /><meta name="keywords" content="golang, grcp, http2, protobuf, Unary" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/golang-grcp-client/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Implementing a simple gRPC client using Golang" />
<meta property="og:description" content="This article describes how to implement a simple rpc client using golang. This can provide some help in understanding the operation of the gRPC protocol." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/golang-grcp-client/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-23T09:14:42+08:00" />
<meta property="article:modified_time" content="2022-03-23T09:14:42+08:00" />

<meta itemprop="name" content="Implementing a simple gRPC client using Golang">
<meta itemprop="description" content="This article describes how to implement a simple rpc client using golang. This can provide some help in understanding the operation of the gRPC protocol."><meta itemprop="datePublished" content="2022-03-23T09:14:42+08:00" />
<meta itemprop="dateModified" content="2022-03-23T09:14:42+08:00" />
<meta itemprop="wordCount" content="1987">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementing a simple gRPC client using Golang"/>
<meta name="twitter:description" content="This article describes how to implement a simple rpc client using golang. This can provide some help in understanding the operation of the gRPC protocol."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Implementing a simple gRPC client using Golang</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-23 09:14:42 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1987 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>I recently mentioned the gRPC protocol in a discussion with a friend, and I&rsquo;ve written about gRPC before. People usually use the official grpc library to communicate directly. But as far as I can see, most of them are Unary requests and very few are stream calls. Unary requests of gRPC are not much different from ordinary http/2 calls, so we can write a simple gRPC client by ourselves. Today, we will share our thoughts on the go language as an example. For those of you who insist on using the official SDK, don&rsquo;t miss this article as it will also provide some help in understanding the operation of the gRPC protocol.</p>
<p>Before introducing the client, we need a server-side program that can be used for testing. This part can be implemented directly using the official SDK.</p>
<p>First, we define the proto file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">&#34;taoshu.in/foo/hello&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">hello</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// The greeter service definition.
</span><span class="c1"></span><span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="c1">// Sends a greeting
</span><span class="c1"></span>  <span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// The request message containing the user&#39;s name.
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">HelloRequest</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// The response message containing the greetings
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">HelloReply</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Since we need to import the generated grpc code in the go language, we need to set the package name of the generated code using <code>go_package</code>.</p>
<p>Then, we use protoc to generate the corresponding pb and grpc files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">protoc <span class="se">\
</span><span class="se"></span>    --go_out<span class="o">=</span>. <span class="se">\
</span><span class="se"></span>    --go_opt<span class="o">=</span><span class="nv">paths</span><span class="o">=</span>source_relative <span class="se">\
</span><span class="se"></span>    --go-grpc_out<span class="o">=</span>. <span class="se">\
</span><span class="se"></span>    --go-grpc_opt<span class="o">=</span><span class="nv">paths</span><span class="o">=</span>source_relative <span class="se">\
</span><span class="se"></span>    hello/hello.proto
</code></pre></td></tr></table>
</div>
</div><p>After successful execution, we will see the following file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">hello
├── hello.pb.go
├── hello.proto
└── hello_grpc.pb.go
</code></pre></td></tr></table>
</div>
</div><p><code>hello.pb.go</code> contains the definition of the interface input and output messages, and <code>hello_grpc.pb.go</code> defines the interface to be implemented by the server and the client, as well as the implementation code for the client. All the server side has to do is to implement the corresponding interface first. We can create a <code>hello.go</code> file with the following contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">hello</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="nx">context</span> <span class="s">&#34;context&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">HelloServer</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// gRPC 要求每个服务的实现必须嵌入对应的结构体
</span><span class="c1"></span>  <span class="c1">// 这个结构体也是自动生成的
</span><span class="c1"></span>  <span class="nx">UnimplementedGreeterServer</span>
<span class="p">}</span>

<span class="c1">// SayHello 实现 GreeterServer 中的 SayHello 方法
</span><span class="c1">// 也就是在 proto 文件中定义的方法
</span><span class="c1">// GreeterServer 接口由 protoc 自动生成
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">HelloServer</span><span class="p">)</span> <span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">out</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">HelloReply</span><span class="p">{}</span>
  <span class="nx">out</span><span class="p">.</span><span class="nx">Message</span> <span class="p">=</span> <span class="s">&#34;Hello &#34;</span> <span class="o">+</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Name</span>

  <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After implementing the interface logic, we still have to write the service startup code with the following core logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 监听端口（正式代码需要处理错误）
</span><span class="c1"></span><span class="nx">ln</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;127.0.0.1:8080&#34;</span><span class="p">)</span>
<span class="c1">// 新建服务
</span><span class="c1"></span><span class="nx">grpcServer</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
<span class="c1">// 注册接口
</span><span class="c1"></span><span class="nx">hello</span><span class="p">.</span><span class="nf">RegisterGreeterServer</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hello</span><span class="p">.</span><span class="nx">HelloServer</span><span class="p">{})</span>
<span class="c1">// 启动服务
</span><span class="c1"></span><span class="nx">grpcServer</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Well, here we have the simplest gRPC service. After running the code the service will listen on port 8080.</p>
<p>Next, we&rsquo;re going to write our own client code. But before we start, we need to briefly review the gRPC communication protocol.</p>
<p>First of all, gRPC uses the http2 protocol at the bottom. http2 uses frames to transfer data, with different frames for headers and data, so that they can be crossed over, rather than having to pass headers and then data, as in http1. The structure of a Unary request is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">HEADERS (flags = END_HEADERS)
:method = POST
:scheme = http
:path = /hello.Greeter/SayHello
:authority = 127.0.0.1:8080
content-type = application/grpc+proto
trailers = TE

DATA (flags = END_STREAM)
&lt;Length-Prefixed Message&gt;
</code></pre></td></tr></table>
</div>
</div><p>There are several points to note here.</p>
<ul>
<li><code>:path</code> holds the path to the interface, taking the value corresponding to the definition of the proto, with the structure <code>/package name. service/method name</code></li>
<li><code>content-type</code> indicates the data encoding type, pb corresponds to <code>application/grpc+proto</code>, or you can use json</li>
<li><code>trailers</code> is fixed to <code>TE</code> to indicate that the trailer headers can be handled correctly. Some gRPC libraries require this field to be passed</li>
</ul>
<p>The last thing to note is the structure of the data as a <code>Length-Prefixed</code> message. This is simply a five-byte prefix before the pb data, where the first byte indicates whether the pb data is compressed or not, and the next four bytes hold a thirty-two-bit integer in big-endian order, which is used to record the length of the pb data.</p>
<p>After the request message, let&rsquo;s look at the response message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">HEADERS (flags = END_HEADERS)
:status = 200
content-type = application/grpc+proto

DATA
&lt;Length-Prefixed Message&gt;

HEADERS (flags = END_STREAM, END_HEADERS)
grpc-status = 0 # OK
grpc-message = &#34;&#34;
</code></pre></td></tr></table>
</div>
</div><p>Note here that the server first sends a header frame with <code>:status</code> and <code>content-type</code> information, then sends a data frame, and finally sends another header frame with <code>grpc-status</code> and <code>grpc-message</code>. The header after the data is sent is called the trailer header. gRPC is designed in such a way that we will not expand on it, if you are interested, you can see the link to the article given in my header.</p>
<p>Well, everything is ready, we can design our own gRPC client.</p>
<p>From the above analysis, we can conclude that we just need to serialize the request object into a pb byte stream, then insert a five-byte prefix in front, set the length of the pb data, and finally use the http standard library to send the data to the gRPC server. After receiving the response from the gRPC server, we deserialize the body into a response object, and we are done.</p>
<p>Wait, can we use the go language http standard library? Theoretically, yes, because the http standard library already supports the http2 protocol. However, there is a catch: the http standard library requires the server to use tls encryption when making http2 requests. In order to promote the popularity of https and protect user privacy, major browsers force http2 communication to be encrypted with tls. So go&rsquo;s standard library also has this requirement. But generally speaking, intranet services run in a controlled environment, and tls configuration and certificate management are troublesome, so most intranet services do not use tls encryption (which is not true). So, we need to investigate a way to initiate http2 communication over plaintext tcp connections.</p>
<p>In fact, the method is very simple, we just need to prepare an <code>http2.Transport</code> ourselves.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">plainTextH2Transport</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">http2</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
  <span class="c1">// 允许发起 http:// 请求
</span><span class="c1"></span>  <span class="nx">AllowHTTP</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="c1">// 默认 http2 会发起 tls 连接
</span><span class="c1"></span>  <span class="c1">// 可以通过 DialTLS 拦截并改为发起普通 TCP 连接
</span><span class="c1"></span>  <span class="nx">DialTLS</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">_</span> <span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the <code>net/http</code> framework, <code>Transport</code> is responsible for handling the real network communication and maintaining the underlying TCP connection. The <code>plainTextH2Transport</code> we declare here is a global variable at the package level, which is the only way to reuse TCP connections.</p>
<p>The plaintext http2 client we described earlier can be used by simply declaring it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">c</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Transport</span><span class="p">:</span> <span class="nx">plainTextH2Transport</span><span class="p">}</span>
<span class="c1">// c 支持发起明文 http2 请求
</span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s that simple and uncomplicated! To facilitate expansion, we can design the following structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">GrpcClient</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewGrpcClient</span><span class="p">()</span> <span class="nx">GrpcClient</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">grpcClient</span><span class="p">{</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Transport</span><span class="p">:</span> <span class="nx">plainTextH2Transport</span><span class="p">}}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since we have embedded <code>http.Client</code> in <code>GrpcClient</code>, <code>GrpcClient</code> itself is also an <code>http.Client</code>. Next we need to implement the Unary request logic. The interface signature is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">GrpcClient</span><span class="p">)</span> <span class="nf">DoUnary</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">api</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">proto</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Apart from <code>ctx</code>, there are three core inputs, <code>api/in/out</code>. In fact, <code>api</code> is the full URL of the interface, in our case <code>http://127.0.0.1:8080/hello.Greeter/SayHello</code>, which corresponds to the previous proto and the address the server listens to. <code>in</code> and <code>out</code> correspond to the request and return messages of the gRPC interface. Since we want to write a generic client, we set the type to <code>proto.Message</code> uniformly. If we could generate the code automatically, we could determine each interface and the incoming and outgoing parameters from the proto file, and then generate the corresponding DoUnary methods separately. But we are designing a <strong>simple</strong> client today, and we don&rsquo;t want to use a heavyweight solution like auto-generated code. So, we have to set it to <code>proto.Message</code> type uniformly. But this design has a drawback, it requires the caller to initialize both in and out before calling. But it can&rsquo;t be helped, it&rsquo;s the only solution that doesn&rsquo;t require code generation.</p>
<p>There are two return values, the first one is the underlying http response. Through it we can read the http protocol status code and various headers (gRPC metadata). The second one returns an error. Generally, the caller only needs to check for errors and does not need to access the first return value.</p>
<p>Okay, let&rsquo;s analyze the code implementation of DoUnary. First, we need to construct the so-called Length-Prefixed message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 正式代码需要处理错误
</span><span class="c1"></span><span class="nx">pb</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span>

<span class="nx">bs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="c1">// 第一个字节默认为0，表示不压缩
</span><span class="c1">// 后四个字节以大端的形式保存 pb 消息长度
</span><span class="c1"></span><span class="nx">binary</span><span class="p">.</span><span class="nx">BigEndian</span><span class="p">.</span><span class="nf">PutUint32</span><span class="p">(</span><span class="nx">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">pb</span><span class="p">)))</span>
<span class="c1">// 使用 MultiReader 「连接」两个 []byte 避免无谓的内存拷贝
</span><span class="c1"></span><span class="nx">body</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">MultiReader</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">bs</span><span class="p">),</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">pb</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>At this point, we have the Length-Prefixed message ready, and we have wrapped it in an io. Then, we have to make the http2 request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 正式代码需要处理错误
</span><span class="c1"></span><span class="nx">req</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>

<span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="c1">// 设置必要的头信息
</span><span class="c1"></span><span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;trailers&#34;</span><span class="p">,</span> <span class="s">&#34;TE&#34;</span><span class="p">)</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;content-type&#34;</span><span class="p">,</span> <span class="s">&#34;application/grpc+proto&#34;</span><span class="p">)</span>
<span class="c1">// 正式代码需要处理错误
</span><span class="c1"></span><span class="nx">resp</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally, we read all the returned data, take it and decode it into response objects.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 正式代码需要处理错误
</span><span class="c1"></span><span class="nx">pb</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="c1">// Unary 调用出错不会返回 body
</span><span class="c1">// 此时 grpc-status 跟 http 状态码一同返回
</span><span class="c1">// 不能通过 Trailer 读取
</span><span class="c1"></span><span class="k">if</span> <span class="nx">status</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;grpc-status&#34;</span><span class="p">);</span> <span class="nx">status</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="kt">int</span>
  <span class="k">if</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">status</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="nx">err</span> <span class="p">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nf">Code</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;grpc-message&#34;</span><span class="p">))</span>
  <span class="k">return</span>
<span class="p">}</span>
<span class="c1">// 因为是 Unary，可以直接跳过前五个字节
</span><span class="c1"></span><span class="nx">err</span> <span class="p">=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">pb</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="nx">out</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The full code is available from <a href="https://gist.github.com/taoso/adb850fbcf11580bd00e3ca058361db3">here</a>. The above is a simplest gRCP client.</p>
<p>Finally, we start the server side and run the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">c</span> <span class="o">:=</span> <span class="nf">NewGrpcClient</span><span class="p">()</span>

<span class="nx">api</span> <span class="o">:=</span> <span class="s">&#34;http://127.0.0.1:8080/hello.Greeter/SayHello&#34;</span>
<span class="nx">in</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">hello</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;涛叔&#34;</span><span class="p">}</span>
<span class="nx">out</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">hello</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">{}</span>

<span class="c1">// 正式代码需要处理错误
</span><span class="c1"></span><span class="nx">resp</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">DoUnary</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Trailer</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;trace-id&#34;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>The program will output &ldquo;Hello 涛叔&rdquo;.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/understanding-the-gprc-protocol/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Understanding the gRPC Protocol</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/golang-zero-copy/">
            <span class="next-text nav-default">Zero-Copy Optimization in the Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
