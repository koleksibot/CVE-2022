<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The one thing that makes React18 better than the old React - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="React18 has entered the RC (release candidate) phase, only one step away from the official version. Today, instead of talking about new features, we&amp;rsquo;ll talk about a detail that makes v18 better than the old version: v18 may have fewer component renders. Where does the state come from? In the following components. 1 2 3 4 function App() { const [num, update] = useState(0); // ...省略" /><meta name="keywords" content="React18" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/react18-better-than-the-old-react/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="The one thing that makes React18 better than the old React" />
<meta property="og:description" content="React18 has entered the RC (release candidate) phase, only one step away from the official version. Today, instead of talking about new features, we&rsquo;ll talk about a detail that makes v18 better than the old version: v18 may have fewer component renders. Where does the state come from? In the following components. 1 2 3 4 function App() { const [num, update] = useState(0); // ...省略" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/react18-better-than-the-old-react/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-19T11:05:05+08:00" />
<meta property="article:modified_time" content="2022-03-19T11:05:05+08:00" />

<meta itemprop="name" content="The one thing that makes React18 better than the old React">
<meta itemprop="description" content="React18 has entered the RC (release candidate) phase, only one step away from the official version. Today, instead of talking about new features, we&rsquo;ll talk about a detail that makes v18 better than the old version: v18 may have fewer component renders. Where does the state come from? In the following components. 1 2 3 4 function App() { const [num, update] = useState(0); // ...省略"><meta itemprop="datePublished" content="2022-03-19T11:05:05+08:00" />
<meta itemprop="dateModified" content="2022-03-19T11:05:05+08:00" />
<meta itemprop="wordCount" content="904">
<meta itemprop="keywords" content="react," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The one thing that makes React18 better than the old React"/>
<meta name="twitter:description" content="React18 has entered the RC (release candidate) phase, only one step away from the official version. Today, instead of talking about new features, we&rsquo;ll talk about a detail that makes v18 better than the old version: v18 may have fewer component renders. Where does the state come from? In the following components. 1 2 3 4 function App() { const [num, update] = useState(0); // ...省略"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The one thing that makes React18 better than the old React</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-19 11:05:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 904 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#where-does-the-state-come-from">Where does the state come from?</a></li>
        <li><a href="#concurrent-brings-changes">Concurrent brings changes</a></li>
        <li><a href="#the-difference-between-old-and-new-concurrent">The difference between old and new Concurrent</a></li>
        <li><a href="#last">Last</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>React18 has entered the RC (release candidate) phase, only one step away from the official version.</p>
<p>Today, instead of talking about new features, we&rsquo;ll talk about a detail that makes v18 better than the old version: v18 may have fewer component renders.</p>
<h2 id="where-does-the-state-come-from">Where does the state come from?</h2>
<p>In the following components.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">num</span><span class="p">,</span> <span class="nx">update</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="c1">// ...省略
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>App component render executes useState after rendering, which returns the latest value of num.</p>
<p>That is, the component must be rendered in order to know the latest state. Why is this the case?</p>
<p>Consider the following code that triggers an update.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="p">[</span><span class="nx">num</span><span class="p">,</span> <span class="nx">update</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">onClick</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">update</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">num</span> <span class="p">=&gt;</span> <span class="nx">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">num</span> <span class="p">=&gt;</span> <span class="nx">num</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The onClick execution triggers the update, which leads to the App component render, and then the useState execution.</p>
<p>Inside useState, the following process is followed to calculate num.</p>
<ol>
<li><code>update(100)</code> changes num to 100</li>
<li><code>update(num =&gt; num + 1)</code> changes num to 100 + 1 = 101</li>
<li><code>update(num =&gt; num * 3)</code> will change num to 101 * 3 = 303</li>
</ol>
<p>That is, when the App component renders, num is 303.</p>
<p>So, the state calculation needs to collect the triggered updates first and then calculate them uniformly in useState.</p>
<p>For the above example, naming the updates as u0 to u2 respectively, the calculation formula for the state is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">baseState</span> <span class="o">-&gt;</span> <span class="nx">u0</span> <span class="o">-&gt;</span> <span class="nx">u1</span> <span class="o">-&gt;</span> <span class="nx">u2</span> <span class="o">=</span> <span class="nx">newState</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="concurrent-brings-changes">Concurrent brings changes</h2>
<p>Concurrent brings the concept of priority to React, which is reflected in the state calculation, where updates have different priorities depending on the scenario that triggered them (for example, updates triggered in onClick callbacks have higher priority than updates triggered in useEffect callbacks).</p>
<p>The difference in the computed state is that if an update has a low priority, it will be skipped.</p>
<p>Assuming the low priority of u1 in the above example, the formula for calculating the num state when the App component is rendered is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 其中u1因为优先级低，被跳过
</span><span class="c1"></span><span class="nx">baseState</span> <span class="o">-&gt;</span> <span class="nx">u0</span> <span class="o">-&gt;</span> <span class="nx">u2</span> <span class="o">=</span> <span class="nx">newState</span>
</code></pre></td></tr></table>
</div>
</div><p>That is.</p>
<ol>
<li><code>update(100)</code> changes num to 100</li>
<li><code>update(num =&gt; num * 3)</code> changes num to 100 * 3 = 300</li>
</ol>
<p>Obviously this result is not correct.</p>
<p>Therefore, the logic of React to compute state in concurrent cases will be more complex. Specifically, it may include multiple rounds of computation.</p>
<p>When computing state, if an update is skipped, the next computation will continue to compute from the skipped update backwards.</p>
<p>For example, in the above example, u1 is skipped. When u1 is skipped, num is 100, and the state 100, and all updates after u1, are saved for the next calculation.</p>
<p>In the example that is, u1 and u2 are saved.</p>
<p>The next update is as follows.</p>
<ol>
<li>initial state is 100, <code>update(num =&gt; num + 1</code>) changes num to 100 + 1 = 101</li>
<li><code>update(num =&gt; num * 3)</code> changes num to 101 * 3 = 303</li>
</ol>
<p>As you can see, the final result 303 is the same as the synchronous React, except that it needs to be rendered twice.</p>
<p><strong>Synchronous React</strong> render once, result is 303.</p>
<p><strong>Concurrent React</strong> render twice, the result is 300 (intermediate state) and 303 (final state) respectively.</p>
<h2 id="the-difference-between-old-and-new-concurrent">The difference between old and new Concurrent</h2>
<p>From the above example we see that the number of times a component renders is affected by <strong>how many updates are skipped</strong> and may actually be rendered not just twice, but multiple times.</p>
<p>In the old version of <strong>Concurrent React</strong>, what indicates <strong>priority</strong> is a timestamp called expirationTime. The algorithm for comparing whether <strong>updates should be skipped</strong> is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 更新优先级是否小于render的优先级
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="nx">updateExpirationTime</span> <span class="o">&lt;</span> <span class="nx">renderExpirationTime</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...被跳过
</span><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// ...不跳过
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this logic, as long as the priority is low, it will be skipped, meaning one more render.</p>
<p>In the <strong>new version of concurrent React</strong>, <strong>priority</strong> is stored in a <strong>31-bit binary number</strong>.</p>
<p>As an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">renderLanes</span> <span class="o">=</span> <span class="mb">0b0101</span><span class="p">;</span>
<span class="nx">u1</span><span class="p">.</span><span class="nx">lane</span> <span class="o">=</span>           <span class="mb">0b0001</span><span class="p">;</span>
<span class="nx">u2</span><span class="p">.</span><span class="nx">lane</span> <span class="o">=</span>           <span class="mb">0b0010</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>where renderLanes is the <strong>priority</strong> specified for this update.</p>
<p>The function to compare priorities is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">isSubsetOfLanes</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">subset</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">set</span> <span class="o">&amp;</span> <span class="nx">subset</span><span class="p">)</span> <span class="o">===</span> <span class="nx">subset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Among them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// true
</span><span class="c1"></span><span class="nx">isSubsetOfLanes</span><span class="p">(</span><span class="nx">renderLanes</span><span class="p">,</span> <span class="nx">u1</span><span class="p">.</span><span class="nx">lane</span><span class="p">)</span>

<span class="c1">// false
</span><span class="c1"></span><span class="nx">isSubsetOfLanes</span><span class="p">(</span><span class="nx">renderLanes</span><span class="p">,</span> <span class="nx">u2</span><span class="p">.</span><span class="nx">lane</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>u1.lane is included in renderLanes, which means this update has sufficient priority.</p>
<p>u2.lane is not contained in renderLanes, which means this update does not have enough priority and is skipped.</p>
<p>But the lane of the skipped update (u2 in the example) will be reset to 0, i.e.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">u2</span><span class="p">.</span><span class="nx">lane</span> <span class="o">=</span> <span class="mb">0b0000</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Obviously any lanes contain zeros.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// true
</span><span class="c1"></span><span class="nx">isSubsetOfLanes</span><span class="p">(</span><span class="nx">renderLanes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>So this update will definitely be processed the next time. In other words, in <strong>new versions of concurrent React</strong>, there will be at most 2 <strong>duplicate renders</strong> due to <strong>priority reasons</strong> being skipped.</p>
<h2 id="last">Last</h2>
<p>Compared with the old <strong>concurrent React</strong>, the new <strong>concurrent React</strong> will have more advantages in the number of renders.</p>
<p>Reflecting on the user&rsquo;s senses, the user will see less <strong>intermediate state</strong> that has not been fully computed.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/react/">react</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/add-ssh-key-login-os-and-troubleshooting/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Adding SSH Key Login and Troubleshooting</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/pulsar-repeat-consume/">
            <span class="next-text nav-default">Pulsar Repeat Consumption</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
