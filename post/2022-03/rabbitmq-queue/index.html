<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>RabbitMQ Consumption Model and Dead Letter Queues - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="RabbitMQ Model RabbitMQ is a producer/consumer model, where the producer produces messages to a queue and the consumer takes messages from the queue to consume, without interacting directly with each other. Let&amp;rsquo;s start by looking at the structure of the RabbitMQ model. In the diagram, we can see that the entire structure consists of a Producer, an Exchange, a Queue, and a Consumer. Among them, the Producer and the Consumer" /><meta name="keywords" content="react, Message Consumption Model, Dead Message Queues, python" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/rabbitmq-queue/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="RabbitMQ Consumption Model and Dead Letter Queues" />
<meta property="og:description" content="RabbitMQ Model RabbitMQ is a producer/consumer model, where the producer produces messages to a queue and the consumer takes messages from the queue to consume, without interacting directly with each other. Let&rsquo;s start by looking at the structure of the RabbitMQ model. In the diagram, we can see that the entire structure consists of a Producer, an Exchange, a Queue, and a Consumer. Among them, the Producer and the Consumer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/rabbitmq-queue/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-11T13:37:24+08:00" />
<meta property="article:modified_time" content="2022-03-11T13:37:24+08:00" />

<meta itemprop="name" content="RabbitMQ Consumption Model and Dead Letter Queues">
<meta itemprop="description" content="RabbitMQ Model RabbitMQ is a producer/consumer model, where the producer produces messages to a queue and the consumer takes messages from the queue to consume, without interacting directly with each other. Let&rsquo;s start by looking at the structure of the RabbitMQ model. In the diagram, we can see that the entire structure consists of a Producer, an Exchange, a Queue, and a Consumer. Among them, the Producer and the Consumer"><meta itemprop="datePublished" content="2022-03-11T13:37:24+08:00" />
<meta itemprop="dateModified" content="2022-03-11T13:37:24+08:00" />
<meta itemprop="wordCount" content="1860">
<meta itemprop="keywords" content="rabbitmq,python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RabbitMQ Consumption Model and Dead Letter Queues"/>
<meta name="twitter:description" content="RabbitMQ Model RabbitMQ is a producer/consumer model, where the producer produces messages to a queue and the consumer takes messages from the queue to consume, without interacting directly with each other. Let&rsquo;s start by looking at the structure of the RabbitMQ model. In the diagram, we can see that the entire structure consists of a Producer, an Exchange, a Queue, and a Consumer. Among them, the Producer and the Consumer"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">RabbitMQ Consumption Model and Dead Letter Queues</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-11 13:37:24 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1860 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#rabbitmq-model">RabbitMQ Model</a>
          <ul>
            <li><a href="#channel">Channel</a></li>
            <li><a href="#exchange">Exchange</a></li>
            <li><a href="#queue">Queue</a></li>
            <li><a href="#routingkey--bindingkey">RoutingKey &amp; BindingKey</a></li>
          </ul>
        </li>
        <li><a href="#publishsubscribe-mechanism">Publish/Subscribe Mechanism</a></li>
        <li><a href="#dead-messages">Dead Messages</a>
          <ul>
            <li><a href="#dead-letter-switch">Dead letter switch</a></li>
            <li><a href="#dead-letter-queue">Dead letter queue</a></li>
            <li><a href="#deferred-queue">Deferred queue</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="rabbitmq-model">RabbitMQ Model</h2>
<p>RabbitMQ is a producer/consumer model, where the producer produces messages to a queue and the consumer takes messages from the queue to consume, without interacting directly with each other.</p>
<p>Let&rsquo;s start by looking at the structure of the RabbitMQ model.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/740b96e22b424159a190998cba9d687a.png" alt="RabbitMQ Message Queue Model"></p>
<p>In the diagram, we can see that the entire structure consists of a Producer, an Exchange, a Queue, and a Consumer.</p>
<p>Among them, the Producer and the Consumer create TCP connections and channels when they connect to the MQ, and the Producer produces messages and decides which queue to send them to based on its specified RoutingKey, which is already the BindingKey of the Queue connected to the Exchange.</p>
<p>Let&rsquo;s analyze the function of each part one by one.</p>
<h3 id="channel">Channel</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/880e75ce953c449e93a8c9ef30b78e53.png" alt="rabbitmq channel"></p>
<p>Once the Connection is established, the client creates an AMQP channel, or Channel, which is a virtual connection based on the Connection, with multiple channels reusing a single TCP connection, reducing performance overhead and making it easier to manage. This not only reduces performance overhead, but also makes it easier to manage.</p>
<p>TCP connections and channel creation are implemented using Python&rsquo;s pika package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">class</span> <span class="nc">MqClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mq_host</span><span class="p">,</span> <span class="n">mq_port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">conn_params</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">mq_host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">mq_port</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">conn_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="exchange">Exchange</h3>
<p>Producers typically send messages to a switch, which in turn routes them to a queue and either returns them to the queue or discards them if they fail to route.</p>
<p>Implement the switch in Python.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">create_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_name</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span>
        <span class="n">exchange</span><span class="o">=</span><span class="n">change_name</span><span class="p">,</span>
        <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;topic&#39;</span><span class="p">,</span>
        <span class="n">passive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">durable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">auto_delete</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Switches are usually of four types.</p>
<ol>
<li>fanout: routes all messages sent to that switch to all queues bound to that switch.</li>
<li>direct: routes messages to queues where the BindingKey matches the RoutingKey exactly.</li>
<li>topic: routes messages to queues where the BindingKey matches the RoutingKey, with matching rules such as &lsquo;.&rsquo; split by &lsquo;.&rsquo; and &lsquo;*&rsquo; and &lsquo;#&rsquo; for fuzzy matching.</li>
<li>headers: the switch of this type matches the message content according to the headers attribute of the message.</li>
</ol>
<h3 id="queue">Queue</h3>
<p>A queue is an object in RabbitMQ that stores messages. Multiple consumers can subscribe to the same queue, and the messages in the queue are split evenly among the consumers, rather than each consumer receiving all the messages.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py">    <span class="k">def</span> <span class="nf">create_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="routingkey--bindingkey">RoutingKey &amp; BindingKey</h3>
<p>RoutingKey is the routing key, usually specified by the producer when sending the message, and BindingKey is the binding key, usually used to bind the switch to the queue.</p>
<p>The two are usually used in conjunction, for example, direct and topic type switches look for a match between these two keys when routing messages. In some cases, RoutingKey and BindingKey can be seen as the same thing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py">    <span class="k">def</span> <span class="nf">queue_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">exchange_name</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="publishsubscribe-mechanism">Publish/Subscribe Mechanism</h2>
<p>RabbitMQ messages are usually consumed in push mode and pull mode.</p>
<p>The push mode uses a subscription approach, using the <code>basic_consume</code> method, while the pull mode uses a queue fetching approach, using the <code>basic_get</code> method. Pull mode is usually used to get a single message, but push mode is more suitable for continuous message fetching or when high throughput is required.</p>
<p>Here is an example of push mode.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">msg_consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">,</span> <span class="n">header_frame</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[Consumer] Receive message:&#34;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;           </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_frame</span><span class="o">.</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method_frame</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[Consumer] Reject message and return it to queue!&#34;</span><span class="p">)</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">basic_nack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method_frame</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">,</span>
                           <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">msg_publisher</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">):</span>
    <span class="c1"># Send a message</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
    <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
                <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Producer] Message was published&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Producer] Message was returned&#39;</span><span class="p">)</span>
        
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">MqClient</span><span class="p">(</span>
        <span class="n">mq_host</span><span class="o">=</span><span class="s2">&#34;172.16.110.17&#34;</span><span class="p">,</span>
        <span class="n">mq_port</span><span class="o">=</span><span class="mi">5672</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s2">&#34;guest&#34;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s2">&#34;guest&#34;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_channel</span><span class="p">()</span>

    <span class="c1"># 设置生产者</span>
    <span class="n">msg_publisher</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
                  <span class="n">exchange</span><span class="o">=</span><span class="n">EXCHANGE_NAME</span><span class="p">,</span>
                  <span class="n">routing_key</span><span class="o">=</span><span class="s2">&#34;hdls.miao.message&#34;</span><span class="p">)</span>
    <span class="c1"># 设置消费者</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span>
        <span class="n">msg_consumer</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="n">QUEUE_NAME</span><span class="p">,</span>
        <span class="n">no_ack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">consumer_tag</span><span class="o">=</span><span class="s2">&#34;hdls-consumer&#34;</span>
    <span class="p">)</span>
    <span class="c1"># 开始消费</span>
    <span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">stop_consuming</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>The consumer receives the message and performs an incoming ack to get the following result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>Producer<span class="o">]</span> Message was published
<span class="o">[</span>Consumer<span class="o">]</span> Receive message:
           hdls.miao.message: b<span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>If, instead of consuming the message, the consumer rejects: <code>basic_nack</code>, and the rejection is accompanied by a parameter set to <code>requeue=True</code>, which knocks the message back to the queue, the result is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>Producer<span class="o">]</span> Message was published
<span class="o">[</span>Consumer<span class="o">]</span> Receive message:
           hdls.miao.message: b<span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
<span class="o">[</span>Consumer<span class="o">]</span> Reject message and <span class="k">return</span> it to queue!
<span class="o">[</span>Consumer<span class="o">]</span> Receive message:
           hdls.miao.message: b<span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
<span class="o">[</span>Consumer<span class="o">]</span> Reject message and <span class="k">return</span> it to queue!
<span class="o">[</span>Consumer<span class="o">]</span> Receive message:
           hdls.miao.message: b<span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
<span class="o">[</span>Consumer<span class="o">]</span> Reject message and <span class="k">return</span> it to queue!
<span class="o">[</span>Consumer<span class="o">]</span> Receive message:
           hdls.miao.message: b<span class="s2">&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;</span>
<span class="o">[</span>Consumer<span class="o">]</span> Reject message and <span class="k">return</span> it to queue!
...
</code></pre></td></tr></table>
</div>
</div><p>At this point the message will keep getting hit back into the queue and just keep blocking the queue.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/d39cb3236c08422e951c15a15678a878.png" alt="rabbitmq Publish/Subscribe Mechanism"></p>
<h2 id="dead-messages">Dead Messages</h2>
<p>When a message is rejected and knocked back to the queue, and thereafter the message is not received by a consumer and becomes a dead message, it blocks the queue, and when there are more and more dead messages in the queue, the performance of the queue will be affected. For the handling of dead messages, setting up a dead message queue is a good choice.</p>
<p>There are usually several cases of dead messages.</p>
<ol>
<li>the message is rejected (by the basic.reject method or basic.nack method) and is also knocked back to the queue.</li>
<li>the message itself has a TTL set or the queue has a TTL set and has reached its expiration time.</li>
<li>the queue has reached the maximum number of messages it can hold.</li>
</ol>
<h3 id="dead-letter-switch">Dead letter switch</h3>
<p>When a message becomes dead in a queue, it can be sent to another switch, the dead letter switch. A dead letter switch is actually a normal switch, but bound to a dead letter queue, and is declared and used in the same way as a normal switch.</p>
<h3 id="dead-letter-queue">Dead letter queue</h3>
<p>A dead letter queue is a queue used to receive dead letters, but it is essentially the same as a normal queue. Only when setting up a normal queue, you need to define which dead switch it is, and what routing_key to use to route messages to the dead queue when they become dead. This way all dead messages can be routed to the corresponding dead queue.</p>
<p>Note that the dead switch and the dead queue need to exist before declaring the dead settings for the normal queue.</p>
<p>Modify the above common queue according to the definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py">    <span class="k">def</span> <span class="nf">create_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span>
                     <span class="n">is_dead</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dead</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&#34;x-dead-letter-exchange&#34;</span><span class="p">:</span> <span class="n">DEAD_EXCHANGE_NAME</span><span class="p">,</span>
                <span class="s2">&#34;x-dead-letter-routing-key&#34;</span><span class="p">:</span> <span class="n">DEAD_ROUTING_KEY</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>When declaring a queue, it is sufficient to declare two parameters: <code>x-dead-letter-exchange</code> and <code>x-dead-letter-routing-key</code>. Also declare the dead letter queue before declaring the normal queue.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py">    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_exchange</span><span class="p">(</span><span class="n">DEAD_EXCHANGE_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_queue</span><span class="p">(</span><span class="n">DEAD_EXCHANGE_NAME</span><span class="p">,</span>
                          <span class="n">DEAD_QUEUE_NAME</span><span class="p">,</span> <span class="n">DEAD_ROUTING_KEY</span><span class="p">,</span> <span class="n">is_dead</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_exchange</span><span class="p">(</span><span class="n">EXCHANGE_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_queue</span><span class="p">(</span><span class="n">EXCHANGE_NAME</span><span class="p">,</span> <span class="n">QUEUE_NAME</span><span class="p">,</span> <span class="n">ROUTING_KEY</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>If consumers of the dead letter queue are added at the same time, dead letters can be handled uniformly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">dead_msg_consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">,</span> <span class="n">header_frame</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[DEAD CSM] Dead Message! It&#39;s time to put it to dead queue.&#34;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;           </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method_frame</span><span class="o">.</span><span class="n">routing_key</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;           ACK dead message!&#34;</span><span class="p">)</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method_frame</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">basic_nack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method_frame</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">,</span>
                           <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></td></tr></table>
</div>
</div><p>Everything is ready! But it actually reports an error after running.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">pika.exceptions.ChannelClosed: (406, &#34;PRECONDITION_FAILED - inequivalent arg &#39;x-dead-letter-exchange&#39; for queue &#39;hdls.mq.queue&#39; in vhost &#39;/&#39;: received the value &#39;dead.exchange&#39; of type &#39;longstr&#39; but current is none&#34;)
</code></pre></td></tr></table>
</div>
</div><p>This is because we have already declared the queue without the dead letter setting, and when declaring the queue, we tried to set an x-dead-letter-exchange parameter, but the current queue on the server has none of this parameter, so the server does not allow it, so it reports an error.</p>
<p>In this case, there are two solutions: one is to remove the previous queue from the server, add the dead-letter parameter, and declare the queue again; the other is to set the parameter via policy.</p>
<p>The policy can be set with <code>rabbitmqctl set_policy</code> or on the RabbitMQ front page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/a8a6760498444315b75ff615c389978a.png" alt="rabbitmq web ui"></p>
<p>Note that the parameters are <code>dead-letter-exchange</code> <code>dead-letter-routing-key</code> when set by the policy method, while the dead letter parameters in the first method need to be prefixed with <code>x-</code>.</p>
<p>After adding the dead letter setting, enable consumer again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">[Publisher] Message was published
[Consumer] Receive message:
           hdls.miao.message: b&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;
[Consumer] Reject message and return it to queue!
[DEAD CSM] Dead Message! It&#39;s time to put it to dead queue.
           dead.message: b&#34;hahahahhahahahaha! I&#39;m a bug and you can&#39;t catch me!&#34;
           ACK dead message!
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the message is routed to the dead letter queue after hitting back the queue.</p>
<h3 id="deferred-queue">Deferred queue</h3>
<p>By deferred queue, we mean that after the message is sent, it does not want to be immediately available to the consumer, and we hope that the consumer will get the message after a specified time.</p>
<p>Delayed queues can be implemented with dead letter queues. Using the TTL characteristics of the queue or message, it can be done so that the message is routed to the dead letter queue after the specified timeout, and the dead letter queue can then be used as a delayed queue to do the message processing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py">    <span class="k">def</span> <span class="nf">create_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">,</span>
                     <span class="n">is_dead</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dead</span><span class="p">:</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&#34;x-message-ttl&#34;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
                <span class="s2">&#34;x-dead-letter-exchange&#34;</span><span class="p">:</span> <span class="n">DEAD_EXCHANGE_NAME</span><span class="p">,</span>
                <span class="s2">&#34;x-dead-letter-routing-key&#34;</span><span class="p">:</span> <span class="n">DEAD_ROUTING_KEY</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Add a <code>x-message-ttl</code> to the dead message setting of the normal queue to set the TTL of the message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">[Publisher] Message was published
[Consumer] Receive message:
           hdls.miao.message: b&#34;I&#39;m not bug, but you can only receive me in 3 seconds.&#34;
[Consumer] Reject message and return it to queue!
[Consumer] Receive message:
           hdls.miao.message: b&#34;I&#39;m not bug, but you can only receive me in 3 seconds.&#34;
[Consumer] Reject message and return it to queue!
[Consumer] Receive message:
           hdls.miao.message: b&#34;I&#39;m not bug, but you can only receive me in 3 seconds.&#34;
[Consumer] Reject message and return it to queue!
[DELAY CSM] Delay queue receive the message!
            dead.message: b&#34;I&#39;m not bug, but you can only receive me in 3 seconds.&#34;
            ACK delay message!
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rabbitmq/">rabbitmq</a>
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/kubernetes-job-and-cronjob/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes Job and Cronjob</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubernetes-oidc/">
            <span class="next-text nav-default">The OIDC protocol and its use in Kubernetes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
