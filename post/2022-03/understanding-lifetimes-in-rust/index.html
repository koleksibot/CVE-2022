<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Lifetimes in Rust - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article explains lifetimes in Rust." /><meta name="keywords" content="rust, Lifetimes" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/understanding-lifetimes-in-rust/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Lifetimes in Rust" />
<meta property="og:description" content="This article explains lifetimes in Rust." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/understanding-lifetimes-in-rust/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-21T14:32:16+08:00" />
<meta property="article:modified_time" content="2022-03-21T14:32:16+08:00" />

<meta itemprop="name" content="Lifetimes in Rust">
<meta itemprop="description" content="This article explains lifetimes in Rust."><meta itemprop="datePublished" content="2022-03-21T14:32:16+08:00" />
<meta itemprop="dateModified" content="2022-03-21T14:32:16+08:00" />
<meta itemprop="wordCount" content="1542">
<meta itemprop="keywords" content="rust," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Lifetimes in Rust"/>
<meta name="twitter:description" content="This article explains lifetimes in Rust."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Lifetimes in Rust</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-21 14:32:16 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1542 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#refa-t-a">Ref&lt;&lsquo;a, T: &lsquo;a&gt;</a></li>
        <li><a href="#cowa-b-a--toowned--sized">Cow&lt;&lsquo;a, B: &lsquo;a + ToOwned + ?Sized&gt;</a></li>
        <li><a href="#box_disaplayablea-t-display--a">box_disaplayable&lt;&lsquo;a, T: Display + &lsquo;a&gt;</a></li>
        <li><a href="#fora">for&lt;&lsquo;a&gt;</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The things that make the lifetime annotation syntax awkward for me are</p>
<ol>
<li>it&rsquo;s not a real type because it can&rsquo;t be instantiated like a real type, but it can be passed into the type parameter of a generic type like a real type, and it does have covariant inversion for real subtyping</li>
<li>it can also be used as a type constraint like Trait, in addition to other lifetime annotations like <code>'a: 'b</code>, it can also be constrained with normal types like <code>T: 'a</code>.</li>
</ol>
<p>This setting is still acceptable. However, in addition, lifetime appears from time to time together with some other strange syntax, and it is still always scary at this point.</p>
<p>I want to overcome my fear of lifetime by 1. confronting it and 2. organizing and analyzing it.</p>
<p>After roughly sorting out a handful of code I don&rsquo;t understand, I found that the syntax I don&rsquo;t understand about lifetime seems to be mainly when it is put together with various generic parameters and even trait constraints.</p>
<p>Find a few examples to look at in detail.</p>
<h2 id="refa-t-a">Ref&lt;&lsquo;a, T: &lsquo;a&gt;</h2>
<p>This example is from <a href="https://carols10cents.github.io/book/ch19-02-advanced-lifetimes.html#lifetime-bounds-on-references-to-generic-types">https://carols10cents.github.io/book/ch19-02-advanced-lifetimes.html#lifetime-bounds-on-references-to-generic-types</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">struct</span> <span class="nc">Ref</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This error is said to be reported (but I didn&rsquo;t reproduce it locally, probably because the rust compiler has added a new omission rule).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">error[E0309]: the parameter type `T` may not live long enough
 --&gt; src/lib.rs:1:19
  |
1 | struct Ref&lt;&#39;a, T&gt;(&amp;&#39;a T);
  |                   ^^^^^^
  |
  = help: consider adding an explicit lifetime bound `T: &#39;a`...
note: ...so that the reference type `&amp;&#39;a T` does not outlive the data it points at
 --&gt; src/lib.rs:1:19
  |
1 | struct Ref&lt;&#39;a, T&gt;(&amp;&#39;a T);
  |   
</code></pre></td></tr></table>
</div>
</div><p>Why do we need to add lifetime constraints to the generic parameters here?</p>
<p>Because T may be a structure containing a reference, such as <code>Lexer&lt;'a&gt;</code>, which has the ownership of this Lexer but has external references inside, or it may be a reference type such as <code>&amp;PlainText</code>. In this case, <code>T:'a</code> can be used to declare that the lifetime of the type T must be within the scope of <code>'a</code>.</p>
<h2 id="cowa-b-a--toowned--sized">Cow&lt;&lsquo;a, B: &lsquo;a + ToOwned + ?Sized&gt;</h2>
<p>Look at another example of a Cow from the standard library.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Cow</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> 
</span><span class="w"></span><span class="k">where</span><span class="w">
</span><span class="w">    </span><span class="n">B</span>: <span class="o">&#39;</span><span class="na">a</span> <span class="o">+</span><span class="w"> </span><span class="nb">ToOwned</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"> 
</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">Borrowed</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">B</span><span class="p">),</span><span class="w">
</span><span class="w">    </span><span class="n">Owned</span><span class="p">(</span><span class="o">&lt;</span><span class="n">B</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">ToOwned</span><span class="o">&gt;</span>::<span class="n">Owned</span><span class="p">),</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Like the previous example, here we have <code>'a</code> specified for B in the generic parameter to constrain its lifecycle to be within <code>'a</code>.</p>
<p>The main thing in this code is the <code>?Sized</code> trait, so let&rsquo;s look it up.</p>
<p>The <code>Sized</code> trait means that the compiler knows the length of the type, and all type arguments have a default <code>Sized</code> bound. <code>?Sized</code> means that the bound is released, allowing non-fixed-length types to be accepted. The non-deterministic types are mainly from Slice and Trait Objects, such as <code>dyn MyTrait</code> and <code>[u8]</code>. Non-fixed-length types cannot be stored on the stack, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// Can&#39;t be stored on the stack directly
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">MySuperSlice</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">info</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="n">data</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>But references to non-fixed-length types are still fixed-length and can be passed on the stack, such as <code>&amp;'a B</code> , <code>&amp;dyn MyTrait</code> , <code>&amp;[u8]</code> . The reason B in <code>Cow&lt;'a, B&gt;</code> allows <code>?Sized</code> is because the contents of the Borrowed part of the enum are a reference to B. If <code>?Sized</code> had not been declared, <code>Cow&lt;&gt;</code> would not have been available for <code>[u8]</code>.</p>
<h2 id="box_disaplayablea-t-display--a">box_disaplayable&lt;&lsquo;a, T: Display + &lsquo;a&gt;</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">box_displayable</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Display</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Display</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Why does this code not compile?</p>
<p>As in the previous example, the reason is that T could be a structure containing a reference, or it could be a trait that implements a reference type such as <code>impl Display for &amp;MyType</code>. When you move, you need to make sure that it is still in lifetime range after the move.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="n">error</span><span class="p">[</span><span class="n">E0310</span><span class="p">]</span>: <span class="nc">the</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="n">T</span><span class="err">`</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">enough</span><span class="w">
</span><span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">4</span>:<span class="mi">5</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">fn</span> <span class="nf">box_displayable</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Display</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Display</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">                    </span><span class="o">--</span><span class="w"> </span><span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">adding</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">explicit</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">bound</span><span class="o">..</span><span class="p">.</span>: <span class="err">`</span><span class="n">T</span>: <span class="o">&#39;</span><span class="nb">static</span> <span class="o">+</span><span class="err">`</span><span class="w">
</span><span class="w"></span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="n">note</span>: <span class="o">..</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="n">T</span><span class="err">`</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">meet</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">bounds</span><span class="w">
</span><span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">4</span>:<span class="mi">5</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">^^^^^^^^^^^</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="fora">for&lt;&lsquo;a&gt;</h2>
<p><a href="http://zderadicka.eu/higher-rank/">http://zderadicka.eu/higher-rank/</a> This example is better, I have a <code>ChuckSum</code> trait wrapped in a <code>calc</code> method with two algorithmic implementations, Xor and Add.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">trait</span> <span class="nx">Checksum</span><span class="p">&lt;</span><span class="nx">R</span><span class="p">:</span><span class="nx">Read</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="nf">calc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">r</span><span class="p">:</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">Vec</span><span class="p">&lt;</span><span class="nx">u8</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nx">Xor</span><span class="p">;</span>

<span class="nx">impl</span> <span class="p">&lt;</span><span class="nx">R</span><span class="p">:</span><span class="nx">Read</span><span class="p">&gt;</span> <span class="nx">Checksum</span><span class="p">&lt;</span><span class="nx">R</span><span class="p">&gt;</span> <span class="k">for</span> <span class="nx">Xor</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="nf">calc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">mut</span> <span class="nx">r</span><span class="p">:</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">Vec</span><span class="p">&lt;</span><span class="nx">u8</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="nx">let</span> <span class="nx">mut</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">u8</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">let</span> <span class="nx">mut</span> <span class="nx">buf</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span><span class="nx">u8</span><span class="p">;</span><span class="mi">8</span><span class="p">];</span>
        <span class="nx">loop</span> <span class="p">{</span>
            <span class="nx">let</span> <span class="nx">read</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">buf</span><span class="p">).</span><span class="nf">unwrap</span><span class="p">();</span>
            <span class="k">if</span> <span class="nx">read</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="k">break</span> <span class="p">}</span>
            <span class="k">for</span> <span class="nx">b</span> <span class="nx">in</span> <span class="o">&amp;</span><span class="nx">buf</span><span class="p">[..</span><span class="nx">read</span><span class="p">]</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="p">^=</span> <span class="nx">b</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nx">vec</span><span class="p">![</span><span class="nx">res</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nx">Add</span><span class="p">;</span>

<span class="nx">impl</span> <span class="p">&lt;</span><span class="nx">R</span><span class="p">:</span><span class="nx">Read</span><span class="p">&gt;</span> <span class="nx">Checksum</span><span class="p">&lt;</span><span class="nx">R</span><span class="p">&gt;</span> <span class="k">for</span> <span class="nx">Add</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="nf">calc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">mut</span> <span class="nx">r</span><span class="p">:</span><span class="nx">R</span><span class="p">)</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">Vec</span><span class="p">&lt;</span><span class="nx">u8</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="c1">// skipped
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It makes sense. There are several different algorithms, all taking parameters that satisfy the <code>Read</code> trait, to calculate checksum.</p>
<p>The checksum of a file is calculated according to the algorithm specified in the parameter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">calc_file_with_checksum</span><span class="p">(</span><span class="n">_path</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">checksumer</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Checksum</span><span class="o">&lt;&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;blah blah blah&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">into_bytes</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="n">checksumer</span><span class="p">.</span><span class="n">calc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This will report an error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">╰─$ rustc hrtb.rs                                                                                                                                                                                                                                                1 ↵
error[E0106]: missing lifetime specifier
  --&gt; hrtb.rs:25:73
   |
25 | fn calc_file_with_checksum(_path: String, mut checksumer: impl Checksum&lt;&amp;[u8]&gt;) -&gt; Vec&lt;u8&gt; {
   |                                                                         ^ expected named lifetime parameter
   |
help: consider introducing a named lifetime parameter
   |
25 | fn calc_file_with_checksum&lt;&#39;a&gt;(_path: String, mut checksumer: impl Checksum&lt;&amp;&#39;a [u8]&gt;) -&gt; Vec&lt;u8&gt; {
   |                           ++++                                               ++

error: aborting due to previous error

For more information about this error, try `rustc --explain E0106`.
</code></pre></td></tr></table>
</div>
</div><p>Follow the prompts to change it again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">error[E0597]: `buf` does not live long enough
  --&gt; hrtb.rs:27:21
   |
25 | fn calc_file_with_checksum&lt;&#39;a&gt;(_path: String, mut checksumer: impl Checksum&lt;&amp;&#39;a [u8]&gt;) -&gt; Vec&lt;u8&gt; {
   |                            -- lifetime `&#39;a` defined here
26 |     let buf = &#34;blah blah blah&#34;.to_string().into_bytes();
27 |     checksumer.calc(&amp;buf)
   |     ----------------^^^^-
   |     |               |
   |     |               borrowed value does not live long enough
   |     argument requires that `buf` is borrowed for `&#39;a`
28 | }
   | - `buf` dropped here while still borrowed

error: aborting due to previous error

For more information about this error, try `rustc --explain E0597`.
</code></pre></td></tr></table>
</div>
</div><p>Why does the error borrowed value does not live long enough?</p>
<p>Because according to the lifetime constraint, the lifetime of the argument to calc needs to be larger than <code>'a</code>, but the lifetime of the variable buf is smaller than <code>'a</code>, so the error is reported.</p>
<p>A reference type can be a type parameter of Generic Trait, which is fine in itself, but a reference requires a lifetime, and the lifetime annotation that has appeared in a function in the past can only come from the declaration of the lifetime generic parameter of the function. If you use a function&rsquo;s lifetime &lsquo;a to annotate references in generic parameters, you will get the above error.</p>
<p>Using a function&rsquo;s lifetime &lsquo;a to mark references in <code>Checksum&lt;&amp;[u8]&gt;</code> is not correct from a lifecycle perspective. The lifetime of a reference in <code>Checksum&lt;&amp;[u8]&gt;</code> is only relevant to the point at which it is called, and it will be different for two different calls.</p>
<p>It is possible to do a work around by defining a separate function and ensuring that the lifetime of the reference is consistent through the lifetime tag of the function, and there is no problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">calc_checksum</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Checksum</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">calc</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>It would be ugly to wrap a separate function for each similar call point. For this reason rust introduced the HRTB (Higher Rank Trait Bound) syntax, which is this <code>for &lt;'a&gt;</code>. Change it like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">calc_file_with_checksum</span><span class="p">(</span><span class="n">_path</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">checksumer</span>: <span class="nc">impl</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Checksum</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;blah blah blah&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">into_bytes</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="n">checksumer</span><span class="p">.</span><span class="n">calc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>means that its lifetime is independent of the lifetime marking of the foo function, and is bound specifically at each specific call point, and there is no need to define a separate function just because of lifetime.</p>
<h2 id="summary">Summary</h2>
<p>The lifetime marking of structs and functions is relatively easy to understand, but the possibility of substituting reference types for parameters of generic types is one area that is easy to forget. In addition, there is no way to foresee the lifetime of generic parameters when defining a generic structure or Trait, and it is easier to encounter accidents at this time.</p>
<p><strong>Should I add lifetime constraints to generic parameters when defining a structure?</strong> The generalized parameters are easy to be mentally defined.</p>
<p>If it is related to a reference, you need to understand that even if the generic parameter is an owned type, there may still be a reference field in it, and it will be related to lifetime. lifetime of the generic parameter satisfies the lifetime constraint of the structure.</p>
<p><strong>Are there any generic parameters that might be passed in by reference in the Trait being used?</strong></p>
<p>It doesn&rsquo;t make sense to constrain such arguments by the lifetime of the function where they are called; the lifetime they need must be smaller than the function&rsquo;s lifetime &lsquo;a, and they won&rsquo;t satisfy the function&rsquo;s lifetime constraint. In this case, the Trait type itself can be constrained by <code>for&lt;'a&gt;</code>, and the function itself can be used without the lifetime argument.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rust/">rust</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/rails-on-docker/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Rails on Docker: Build a development environment with Docker Compose</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/go-s-test-questions/">
            <span class="next-text nav-default">Can you answer this Go question correctly?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
