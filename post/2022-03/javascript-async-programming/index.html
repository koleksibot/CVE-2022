<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Asynchronous Programming Methods and Practices in JavaScript - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes asynchronous programming in JavaScript." /><meta name="keywords" content="javascript, Async Programming" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/javascript-async-programming/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Asynchronous Programming Methods and Practices in JavaScript" />
<meta property="og:description" content="This article describes asynchronous programming in JavaScript." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/javascript-async-programming/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-25T09:29:18+08:00" />
<meta property="article:modified_time" content="2022-03-25T09:29:18+08:00" />

<meta itemprop="name" content="Asynchronous Programming Methods and Practices in JavaScript">
<meta itemprop="description" content="This article describes asynchronous programming in JavaScript."><meta itemprop="datePublished" content="2022-03-25T09:29:18+08:00" />
<meta itemprop="dateModified" content="2022-03-25T09:29:18+08:00" />
<meta itemprop="wordCount" content="2460">
<meta itemprop="keywords" content="javascript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Asynchronous Programming Methods and Practices in JavaScript"/>
<meta name="twitter:description" content="This article describes asynchronous programming in JavaScript."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Asynchronous Programming Methods and Practices in JavaScript</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-25 09:29:18 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2460 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-why-asynchronous-programming">1. Why Asynchronous Programming</a></li>
        <li><a href="#2-several-ways-to-implement-asynchronous-programming">2. Several ways to implement asynchronous programming</a>
          <ul>
            <li><a href="#21-callback-functions">2.1 Callback functions</a></li>
            <li><a href="#22-event-listening-and-handling">2.2 Event Listening and Handling</a></li>
            <li><a href="#23-promise">2.3 Promise</a></li>
            <li><a href="#24-async--await">2.4 <code>Async / Await</code></a></li>
          </ul>
        </li>
        <li><a href="#3-javascript-asynchronous-programming-in-practice">3. JavaScript Asynchronous Programming in Practice</a>
          <ul>
            <li><a href="#31-delay-handling">3.1 Delay handling</a></li>
            <li><a href="#32-promiseing-of-event-listeners-and-subscriptions">3.2 Promiseing of event listeners and subscriptions</a></li>
            <li><a href="#33-debounce-and-throttle-functions">3.3 Debounce and throttle functions</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-why-asynchronous-programming">1. Why Asynchronous Programming</h2>
<p>JavaScript is a single-threaded programming language that can only execute one task at a time. In order to handle different task scheduling logic, asynchronous programming is unavoidable in JavaScript development.</p>
<p>The following scenarios necessarily involve asynchronous programming methods.</p>
<ul>
<li>IO operations: external device access
<ul>
<li>File access</li>
<li>TCP / UDP network access</li>
</ul>
</li>
<li>Asynchronous APIs
<ul>
<li>setTimeout / setInterval</li>
<li>setImmediate</li>
<li>process.nextTick</li>
<li>queueMicrotask</li>
<li>Event</li>
</ul>
</li>
</ul>
<h2 id="2-several-ways-to-implement-asynchronous-programming">2. Several ways to implement asynchronous programming</h2>
<ul>
<li>Callback functions</li>
<li>Event Listening / Observer Pattern</li>
<li>Promise</li>
<li>Async / Await</li>
</ul>
<p>Functions can be passed as arguments to functions, which is the most basic form of Javascript support for asynchronous programming. Therefore, the callback function pattern is the most widespread and almost the only available means of asynchronous programming in the early days (ES5-).
With the introduction of the <code>Promise</code> concept, JavaScript&rsquo;s modern syntax (ES6+) for asynchronous programming became more and more concise and friendly.
Since ES7 introduced <code>Async / Await</code> based on <code>Promise</code> into the syntax standard, asynchronous programming can become as concise and clear as writing synchronous code.</p>
<h3 id="21-callback-functions">2.1 Callback functions</h3>
<p>The ability to pass functions as arguments to functions is the most basic form of Javascript support for asynchronous programming, and this feature makes JavaScript asynchronous programming very flexible and simple. The callback function pattern is the most widespread and almost the only option available for asynchronous programming in the early days (ES5-). However, it is most criticized for having to use a large number of asynchronous callbacks in complex business logic, resulting in a deeply nested callback hell pattern that makes the logic exceptionally complex to read and difficult to maintain.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
 
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./a.txt&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;readFile.error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./b.txt&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err1</span><span class="p">,</span> <span class="nx">data1</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;readFile.error:&#39;</span><span class="p">,</span> <span class="nx">err1</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">data</span> <span class="o">+</span> <span class="nx">data1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="22-event-listening-and-handling">2.2 Event Listening and Handling</h3>
<p>Event listening and handling is a subscriber pattern, and is essentially based on callback functions. It is very common in JavaScript-based development. The subscriber pattern makes it easy to separate less relevant logic implementations and simplify inter-module dependency calls. The event-based subscriber pattern was used extensively in the <code>jQuery</code> era.</p>
<p>However, in large projects with heavy front-end architecture, data dependencies are often extremely complex, and in complex scenarios involving multiple variable factors, the data state of the subscriber pattern is highly uncontrollable and can easily lead to confusion in the subscription dependency logic due to logical fine-tuning of different variable factors. Therefore, there are many libraries of data flow management tools for medium and large front-end projects. Data flow management is still essentially based on the implementation of callback functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{...};</span>
<span class="nx">workerChannel</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">});</span>
<span class="nx">workerChannel</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="23-promise">2.3 Promise</h3>
<p>With the introduction of the <code>Promise</code> concept, JavaScript&rsquo;s modern syntax (ES6+) for asynchronous programming has become more and more concise and friendly. <code>Promise</code> is much better than callback functions and avoids the callback hell paradigm, but its <code>then</code> callback paradigm is not concise. However, <code>Promise</code> provides the foundation for almost all asynchronous-related APIs in the subsequent ES6+ standard.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">a</span> <span class="p">=&gt;</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./b.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">b</span> <span class="p">=&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
  <span class="p">.</span><span class="k">catch</span> <span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">err</span> <span class="o">?</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">:</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
 
<span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./a.txt&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">a</span> <span class="p">=&gt;</span> <span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./b.txt&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">b</span> <span class="p">=&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="24-async--await">2.4 <code>Async / Await</code></h3>
<p>Since <code>ES7(ES2016)</code> introduced <code>Async / Await</code> based on <code>Promise</code> into the syntax standard, asynchronous programming can become as concise and clear as writing synchronous code. <code>ES13(ES2022)</code> also includes <code>Top-level Await</code> in the specification, so that <code>Await</code> can be used anywhere in the ESM module outside the confines of the <code>Async</code> function. Its main features can be summarized as follows.</p>
<ul>
<li>Syntactic sugar: based on <code>Promise</code> base support</li>
<li>Asynchronous programming as if you were writing synchronous code</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">try</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">promises</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./b.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-javascript-asynchronous-programming-in-practice">3. JavaScript Asynchronous Programming in Practice</h2>
<ul>
<li><code>Promise</code>ization</li>
<li>Using <code>Async / Await</code></li>
<li>Concurrent performance: avoiding IO blocking</li>
<li>Anti-jitter and throttling</li>
</ul>
<h3 id="31-delay-handling">3.1 Delay handling</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// delay 封装：callback 模式
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">callback</span><span class="p">(),</span> <span class="nx">timeout</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// delay 封装：Promise 模式
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeou</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(),</span> <span class="nx">timeout</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="kr">await</span> <span class="nx">delay</span><span class="p">(</span><span class="mi">3_00</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">callback</span><span class="p">());</span>
<span class="nx">callback</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// sleep 封装：TS 类型、回调值支持
</span><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="o">?:</span> <span class="nx">T</span> <span class="o">|</span> <span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">T</span> <span class="o">|</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">))</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">=&gt;</span>
    <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(),</span> <span class="nx">timeout</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="nx">value</span><span class="p">()</span> <span class="o">:</span> <span class="nx">value</span><span class="p">);</span>
 
<span class="kr">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="mi">3_000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-promiseing-of-event-listeners-and-subscriptions">3.2 Promiseing of event listeners and subscriptions</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">});</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
 
<span class="nx">request</span><span class="p">({...}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p><em><strong>Q: How to implement timeout processing?</strong></em></p>
<h4 id="321-settimeout-and-timeout-handling">3.2.1 <code>setTimeout</code> and timeout handling</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">({</span> <span class="nx">errmsg</span><span class="o">:</span> <span class="s1">&#39;timeout&#39;</span> <span class="p">}),</span> <span class="nx">timeout</span><span class="p">);</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
 
<span class="nx">request</span><span class="p">({...}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p><em><strong>Q: How to implement a generic package for timeout processing?</strong></em></p>
<h4 id="322-generic-encapsulation-of-timeout-handling-racetimeout">3.2.2 Generic encapsulation of timeout handling: <code>raceTimeout</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">raceTimeout</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">promise</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">onTimeout</span><span class="o">?:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">T</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">promiseResolve</span><span class="o">:</span> <span class="p">((</span><span class="nx">value</span><span class="o">:</span> <span class="nx">T</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">promiseResolve</span><span class="o">?</span><span class="p">.(</span><span class="nx">onTimeout</span><span class="o">?</span><span class="p">.()),</span> <span class="nx">timeout</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span><span class="nx">promise</span><span class="p">.</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">)),</span> <span class="k">new</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">promiseResolve</span> <span class="o">=</span> <span class="nx">resolve</span><span class="p">))]);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Call <code>request</code> with <code>raceTimeout</code> to handle the timeout.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">raceTimeout</span><span class="p">(</span><span class="nx">request</span><span class="p">({...}),</span> <span class="mi">3_000</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">errmsg</span><span class="o">:</span> <span class="s1">&#39;timeout&#39;</span> <span class="p">}))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p>Use <code>raceTimeout</code> to encapsulate generic timeout handling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">});</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">raceTimeout</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">errmsg</span><span class="o">:</span> <span class="s1">&#39;timeout&#39;</span> <span class="p">}));</span>
<span class="p">}</span>
 
<span class="nx">request</span><span class="p">({...}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="323-generic-wrapper-for-timeout-handling-timeoutdeferred">3.2.3 Generic wrapper for timeout handling: <code>timeoutDeferred</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">interface</span> <span class="nx">IScheduledLater</span> <span class="kr">extends</span> <span class="nx">IDisposable</span> <span class="p">{</span>
    <span class="nx">isTriggered</span><span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">timeoutDeferred</span><span class="p">(</span><span class="nx">timeout</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span><span class="o">:</span> <span class="nx">IScheduledLater</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">fn</span><span class="p">();</span>
    <span class="p">},</span> <span class="nx">timeout</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">isTriggered</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">scheduled</span><span class="p">,</span>
        <span class="nx">dispose</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">handle</span><span class="p">);</span>
            <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">},</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Example of encapsulating generic timeout handling using <code>timeoutDeferred</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">timeoutDeferred</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">({</span> <span class="nx">errmsg</span><span class="o">:</span> <span class="s1">&#39;timeout&#39;</span> <span class="p">}));</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">});</span>
    <span class="nx">workerChannel</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">uid</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
 
<span class="nx">request</span><span class="p">({...}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">body</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>A simple use, no simpler than using <code>setTimeout</code> directly</li>
<li>A more convenient use of <code>timeoutDeferred</code> is to decide how to execute <code>deferred.dispose()</code> in complex logic processes based on different variable factors</li>
</ul>
<h4 id="324-generic-wrapper-for-timeout-handling-microtaskdeferred">3.2.4 Generic wrapper for timeout handling: <code>microtaskDeferred</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">microtaskDeferred</span><span class="p">(</span><span class="nx">fn</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span><span class="o">:</span> <span class="nx">IScheduledLater</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">queueMicrotask</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scheduled</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">fn</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
 
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">isTriggered</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">scheduled</span><span class="p">,</span>
        <span class="nx">dispose</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">scheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">},</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="33-debounce-and-throttle-functions">3.3 Debounce and throttle functions</h3>
<p>Take the example of a postal worker delivering a letter.</p>
<ul>
<li>Post office receiving mail - <code>letters = []</code> ;</li>
<li>The postman delivers the letter - <code>function deliver(){}</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">letters</span> <span class="o">=</span> <span class="p">[];</span>
<span class="cm">/** 邮局接收信件 */</span>
<span class="kd">function</span> <span class="nx">onLetterReceived</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">letters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
  <span class="nx">deliver</span><span class="p">();</span> <span class="c1">// 派送策略？
</span><span class="c1"></span><span class="p">}</span>
<span class="cm">/** 邮政员派送信件 */</span>
<span class="kd">function</span> <span class="nx">deliver</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">lettersToDeliver</span> <span class="o">=</span> <span class="nx">letters</span><span class="p">;</span>
  <span class="nx">letters</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">return</span> <span class="nx">makeTheTrip</span><span class="p">(</span><span class="nx">lettersToDeliver</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Execute <code>makeTheTrip</code> as soon as the letter is received. Requirement.
<ul>
<li>Receive mail less frequently?</li>
<li>Very large number of postal workers?</li>
<li>Very fast delivery?</li>
<li>More&hellip;</li>
</ul>
</li>
</ul>
<h4 id="331-lodash--function-anti-shake-and-throttling">3.3.1 <code>lodash</code> : function anti-shake and throttling</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="p">{</span> <span class="nx">throttle</span><span class="p">,</span> <span class="nx">debounce</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;lodash&#39;</span><span class="p">;</span>
 
<span class="c1">// 节流：100ms 内最多执行一次
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">throttler</span> <span class="o">=</span> <span class="nx">throttle</span><span class="p">(</span><span class="nx">deliver</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
 
<span class="c1">// 防抖：间隔 100ms 以上才触发
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">debounced</span> <span class="o">=</span> <span class="nx">debounce</span><span class="p">(</span><span class="nx">deliver</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
 
<span class="c1">// 防抖：高频调用 - 每隔 1s 至少会触发一次
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">debounced</span> <span class="o">=</span> <span class="nx">debounce</span><span class="p">(</span><span class="nx">deliver</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="p">{</span> <span class="nx">maxWait</span><span class="o">:</span> <span class="mi">1000</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>Problems.</p>
<ul>
<li>Optimal value: How to determine <code>100ms</code> and <code>1000ms</code>?</li>
<li>Unable to maximize CPU utilization</li>
<li>Can&rsquo;t handle uncertain task calls with large time consumption better</li>
</ul>
<p><em><strong>Why?</strong></em></p>
<ul>
<li>Main reason: Can&rsquo;t tell when the message is finished</li>
<li>Solution: <code>callback</code> =&gt; use back callback hell mode?</li>
<li>Solution: try <code>Promise</code> ?</li>
</ul>
<h4 id="332-promise-style-antijitter-and-throttling">3.3.2 <code>Promise</code>-style antijitter and throttling</h4>
<ul>
<li><code>Throttler</code> : Execute <code>async</code> callback tasks in throttled fashion</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Throttler</span> <span class="p">{</span>
  <span class="cm">/** 正在执行的任务句柄 */</span>
  <span class="kr">private</span> <span class="nx">activePromise</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="cm">/** 等待执行的任务句柄 */</span>
  <span class="kr">private</span> <span class="nx">queuedPromise</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="cm">/** 等待执行的任务 */</span>
  <span class="kr">private</span> <span class="nx">queuedPromiseFactory</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">queue</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">promiseFactory</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Application examples.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">throttler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Throttler</span><span class="p">();</span>
<span class="cm">/** 邮局接收信件 */</span>
<span class="kd">function</span> <span class="nx">onLetterReceived</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">letters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
  <span class="nx">throttler</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="nx">deliver</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Delivery strategy
<ul>
<li>Incoming mail initiates delivery tasks</li>
<li>Take all emails for each delivery</li>
<li>Waiting queue always caches only the latest one - <code>queuedPromiseFactory</code></li>
</ul>
</li>
</ul>
<h4 id="333-sequencer--sequential-execution-of-async-callback-tasks">3.3.3 <code>Sequencer</code> : sequential execution of async callback tasks</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Sequencer</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">current</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="nx">queue</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">promiseTask</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
            <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">promiseTask</span><span class="p">(),</span>
            <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">promiseTask</span><span class="p">()</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Features.</p>
<ul>
<li><code>One By One</code></li>
<li>Difference with <code>Throttler</code>: no limit on waiting queues ( <code>queue</code>)</li>
<li>Simple encapsulation, easy to call</li>
</ul>
<h4 id="334-distinguishing-between-multiple-types-of-sequential-execution-of-async-tasks">3.3.4 Distinguishing between multiple types of sequential execution of async tasks</h4>
<p>Cache different types of <code>Sequencer</code> by <code>key</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">SequencerByKey</span><span class="o">&lt;</span><span class="nx">TKey</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">promiseMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nx">TKey</span><span class="p">,</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;&gt;</span><span class="p">();</span>
    <span class="nx">queue</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span> <span class="nx">TKey</span><span class="p">,</span> <span class="nx">promiseTask</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">runningPromise</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">promiseMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">??</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
        <span class="kr">const</span> <span class="nx">newPromise</span> <span class="o">=</span> <span class="nx">runningPromise</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promiseTask</span><span class="p">)</span>
            <span class="p">.</span><span class="k">finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">promiseMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">===</span> <span class="nx">newPromise</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">promiseMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">promiseMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">newPromise</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">newPromise</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="335-jitter-proof-execution-of-asynchronous-tasks">3.3.5 Jitter-proof execution of asynchronous tasks</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Delayer</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="kr">implements</span> <span class="nx">IDisposable</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">deferred</span><span class="o">:</span> <span class="nx">IScheduledLater</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">completionPromise</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">doResolve</span><span class="o">:</span> <span class="p">((</span><span class="nx">value</span><span class="o">?:</span> <span class="nx">unknown</span> <span class="o">|</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">doReject</span><span class="o">:</span> <span class="p">((</span><span class="nx">err</span><span class="o">:</span> <span class="nx">unknown</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">task</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
 
    <span class="nx">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">defaultDelay</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{}</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultDelay</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="nx">isTriggered</span><span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span>
    <span class="nx">cancel</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">delayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Delayer</span><span class="p">(</span><span class="mi">10_000</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">letters</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">function</span> <span class="nx">letterReceived</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">letters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
  <span class="nx">delayer</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">makeTheTrip</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Features.</p>
<ul>
<li>Delayed execution</li>
<li>Stateful and cancelable</li>
<li>Simple calling method, clear business logic</li>
<li>Disadvantages: high-frequency calls keep getting canceled, can&rsquo;t be called in time</li>
</ul>
<h4 id="336-throttleddelayer--anti-jitter--throttling">3.3.6 <code>ThrottledDelayer</code> : Anti-jitter + throttling</h4>
<blockquote>
<p>The postman is smart enough to wait a certain amount of time before going out to deliver the mail (it doesn&rsquo;t wait all the time).</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ThrottledDelayer</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">delayer</span><span class="o">:</span> <span class="nx">Delayer</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">throttler</span><span class="o">:</span> <span class="nx">Throttler</span><span class="p">;</span>
 
    <span class="nx">constructor</span><span class="p">(</span><span class="nx">defaultDelay</span><span class="o">:</span> <span class="nx">number</span><span class="p">);</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="nx">promiseFactory</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nx">delay</span><span class="o">?:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">delayer</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">throttler</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="nx">promiseFactory</span><span class="p">),</span> <span class="nx">delay</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">unknown</span> <span class="nx">as</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">isTriggered</span><span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">delayer</span><span class="p">.</span><span class="nx">isTriggered</span><span class="p">();</span> <span class="p">}</span>
    <span class="nx">cancel</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">delayer</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span> <span class="p">}</span>
    <span class="nx">dispose</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">delayer</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Delayed execution of high-frequency tasks: wait for a certain amount of time before sending a message</li>
<li>A new delayed task is called in a shake-proof way when the message is delivered: <code>delayer.trigger</code>, <code>delayer.completionPromise</code></li>
<li>When the delivery is complete, the next delivery journey is immediately started: <code>throttler.queuedPromise</code></li>
</ul>
<h4 id="337-barrier--call-barrier-before-initialization">3.3.7 <code>Barrier</code> : call barrier before initialization</h4>
<p>Creates a barrier with an initial state of closed and a final state of permanently open.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Barrier</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_isOpen</span><span class="o">:</span> <span class="kr">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">_promise</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="kr">private</span> <span class="nx">_completePromise</span><span class="o">!:</span> <span class="p">(</span><span class="nx">v</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">void</span><span class="p">;</span>
    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">c</span><span class="p">,</span> <span class="nx">_e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_completePromise</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">isOpen</span><span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isOpen</span> <span class="p">}</span>
    <span class="nx">open</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_isOpen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_completePromise</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">wait</span><span class="p">()</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_promise</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Q: How does a postal worker handle a triggered mail delivery task when he or she is not yet on duty?</p>
<p>Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">barrier</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Barrier</span><span class="p">();</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">letterReceived</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">letters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">barrier</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span> <span class="c1">// 等待就绪后调用
</span><span class="c1"></span>  <span class="nx">makeTheTrip</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// ...
</span><span class="c1"></span><span class="nx">barrier</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span> <span class="c1">// 邮政员上班了
</span></code></pre></td></tr></table>
</div>
</div><p>Advantages.</p>
<ul>
<li>No cumbersome way to create buffers, wait for callbacks, etc.</li>
<li>Simplified call chain and clear and concise logic</li>
</ul>
<h4 id="338-timeout-auto-open-barrier-autoopenbarrier">3.3.8 Timeout auto-open barrier: <code>AutoOpenBarrier</code></h4>
<blockquote>
<p>How to automatically enable an alternative (e.g. robotic delivery mode) when the postal worker keeps not coming to work?</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">AutoOpenBarrier</span> <span class="kr">extends</span> <span class="nx">Barrier</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">_timeout</span><span class="o">:</span> <span class="nx">NodeJS</span><span class="p">.</span><span class="nx">Timer</span><span class="p">;</span>
    <span class="nx">constructor</span><span class="p">(</span><span class="nx">autoOpenTimeMs</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">(),</span> <span class="nx">autoOpenTimeMs</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">override</span> <span class="nx">open</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">);</span>
        <span class="kr">super</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="339-retry-failure-to-retry">3.3.9 <code>retry</code> Failure to retry</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">retry</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">task</span><span class="o">:</span> <span class="nx">ITask</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nx">delay</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">retries</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">validator</span><span class="o">?:</span> <span class="p">(</span><span class="nx">r</span><span class="o">:</span> <span class="nx">T</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="kr">boolean</span><span class="p">)</span><span class="o">:</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">lastError</span><span class="o">:</span> <span class="nb">Error</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
 
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">retries</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">task</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">validator</span> <span class="o">||</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">result</span><span class="p">))</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lastError</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
            <span class="kr">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="k">throw</span> <span class="nx">lastError</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>retry</code> Application example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">doLogin</span><span class="p">()</span><span class="o">:</span> <span class="p">{</span> <span class="nx">success</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">}</span> <span class="p">{}</span>
<span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">retry</span><span class="p">(</span><span class="nx">doLogin</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">success</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/javascript/">javascript</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/golang-len/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Is the result of the len(s) expression a constant or a variable?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/linux-tc-flow-control/">
            <span class="next-text nav-default">Introduction to Linux TC Flow Control</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
