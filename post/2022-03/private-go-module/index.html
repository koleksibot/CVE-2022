<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Small company internal private Go module pulling solution - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes a private Go module pulling solution within a small company." /><meta name="keywords" content="golang, Private Module" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/private-go-module/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Small company internal private Go module pulling solution" />
<meta property="og:description" content="This article describes a private Go module pulling solution within a small company." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/private-go-module/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-26T11:36:34+08:00" />
<meta property="article:modified_time" content="2022-03-26T11:36:34+08:00" />

<meta itemprop="name" content="Small company internal private Go module pulling solution">
<meta itemprop="description" content="This article describes a private Go module pulling solution within a small company."><meta itemprop="datePublished" content="2022-03-26T11:36:34+08:00" />
<meta itemprop="dateModified" content="2022-03-26T11:36:34+08:00" />
<meta itemprop="wordCount" content="2428">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Small company internal private Go module pulling solution"/>
<meta name="twitter:description" content="This article describes a private Go module pulling solution within a small company."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Small company internal private Go module pulling solution</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-26 11:36:34 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2428 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-the-cause-of-the-problem">1. The cause of the problem</a></li>
        <li><a href="#2--a-solution-for-small-companies">2.  A solution for small companies</a>
          <ul>
            <li><a href="#0-solution-example-environment-topology">0. Solution example environment topology</a></li>
            <li><a href="#1-choosing-a-goproxy-implementation">1. Choosing a goproxy implementation</a></li>
            <li><a href="#2-customize-the-package-import-path-and-map-it-to-the-internal-vcs-repository">2. Customize the package import path and map it to the internal vcs repository</a></li>
            <li><a href="#3-development-machine-client-setup">3. Development machine (client) setup</a></li>
            <li><a href="#4-the-shortcomings-of-the-solution">4. The &ldquo;shortcomings&rdquo; of the solution</a></li>
          </ul>
        </li>
        <li><a href="#3-summary">3. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/cffc445906af471a9bd53cfda9660b6a.png" alt="go module"></p>
<h2 id="1-the-cause-of-the-problem">1. The cause of the problem</h2>
<p>With the introduction of the Go module in Go 1.11, the Go command to pull the dependent public go module is no longer a &ldquo;pain point&rdquo;. This is shown in the figure below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/8e2f4f00c2984ed9a0c924d9833a8a37.png" alt="go module"></p>
<p>We only need to configure a public GOPROXY service for the environment variable GOPROXY within our company/organization to easily pull all public go modules (public mods are open source mods).</p>
<p>However, as the number of Go users in the company increases and the number of Go projects increases, the problem of &ldquo;code duplication&rdquo; arises. It became necessary to pull public code and put it into a separate, internal private repository that could be reused. So we <strong>have</strong> the need to pull private go modules! **</p>
<p>Some companies or organizations put all their code in a public vcs hosting provider (e.g. github.com), and the private go module is placed directly in the private repository of the corresponding public vcs service. If the same is true for your company, then pulling the private go module hosted in the public vcs private repository is also easy, see the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/db3b449fd6ad427791fe4519a3c99ba5.png" alt="go module"></p>
<p>Of course, a prerequisite for this solution is that each developer needs to have access to the private go module repository on the public vcs service, and the credentials can be in any form, either basic auth user and password, or personal access token (similar to github), as long as they are provided in accordance with the public vcs authentication requirements can be provided.</p>
<p>However, if the private go module is placed on the company&rsquo;s internal vcs server, as shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/89e8b2b0e3044178946dfb9013145b3a.png" alt="private go module"></p>
<p>So how do we get Go commands to automatically pull private go modules from internal servers?</p>
<p>Some gopher will say: &quot; <strong>That&rsquo;s easy! It&rsquo;s no different than pulling a private go module hosted on a public vcs service</strong>&quot;. Most of the gophers who hold this view are from large companies. Large companies have a well-developed IT infrastructure for development, and their internal vcs servers are accessible via domain names (e.g. git.bat.com/user/repo), so employees within large companies can access private go modules on their internal vcs servers just like they can access public vcs services, as shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/8600f34069424a1a9b65797d9d181d40.png" alt="go module"></p>
<p>We see: In the above scenario, the company built an internal goproxy service (i.e. in-house goproxy in the above figure), the purpose of which is to provide a way to pull external go modules for those development machines and ci machines that do not have direct access to the external network, and secondly, because of the cache of in-house goproxy This is to provide a way to pull external go modules for development machines and ci machines that do not have direct access to the extranet. For the private go module, the development machine will configure it into the GOPRIVATE environment variable, so that the Go command will not take GOPROXY when pulling the private go module, but will use the direct access to vcs (such as git.bat.com in the above figure) to pull the private go module.</p>
<p>Of course, the big manufacturers may also use the following scheme to hand over both external go module and private go module to the internal unified Goproxy service to handle.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/f6190e75732f4a71a7c149c971e53045.png" alt="go module"></p>
<p>In this scenario, developers only need to configure GOPROXY as in-house goproxy to pull external go module and private go module uniformly, but since the go command by default will perform sum verification (to sum.golang.org) on all go modules pulled by goproxy, and our private go module has no data record in the public sum validation server, so the developer needs to fill the private go module into the GONOSUMDB environment variable, so that the go command will not perform sum checksum on it. However, there is one thing to note about this solution: the in-house goproxy needs to have access to all the repo where the private module is located, so as to ensure the success of each private go module pull!</p>
<p>Well, here&rsquo;s the problem! How to implement a private go module pulling solution for small companies that do not have a complete internal IT infrastructure and want to put the private go module on the company&rsquo;s internal vcs server?</p>
<h2 id="2--a-solution-for-small-companies">2.  A solution for small companies</h2>
<p>small companies may be small, but their goals cannot be low. Although small companies have weak or inflexible IT infrastructure, they should not put too much extra &ldquo;burden&rdquo; on developers. Therefore, comparing the above two possible solutions for large companies, we prefer the latter. This way, we can <strong>leave all the complexity to the in-house goproxy node and the developers can make it simple enough</strong>. But how do we implement this solution when small companies don&rsquo;t have DNS and can&rsquo;t use domain names&hellip;? In this section, we implement this solution.</p>
<h3 id="0-solution-example-environment-topology">0. Solution example environment topology</h3>
<p>We first prepare a sample environment for the subsequent implementation of the solution, with the following topology.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/cf7e0e4016354214b4e14af3dd9b22aa.png" alt="go module"></p>
<h3 id="1-choosing-a-goproxy-implementation">1. Choosing a goproxy implementation</h3>
<p>After the release of <a href="https://pkg.go.dev/cmd/go@master#hdr-module_proxy_protocol">Go module proxy protocol specification</a>, many mature open source implementations of Goproxy have appeared in the Go community. From the original <a href="https://tonybai.com/2018/11/26/hello-go-module-proxy/">athens</a> to two excellent open source implementations in China: <a href="https://github.com/goproxy/goproxy">goproxy.cn</a> and <a href="https://github.com/goproxyio/goproxy">goproxy.io</a>. Among them, goproxy.io is given on the official site as <a href="https://goproxy.io/zh/docs/enterprise.html">method for on-premises deployment</a>, and based on that, we&rsquo;ll implement our solution based on goproxy.io (the rest of the goproxy implementations should all work as well).</p>
<p>We install goproxy by performing the following steps on the in-house goproxy node in the above diagram.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$mkdir</span> ~/.bin/goproxy
<span class="nv">$cd</span> ~/.bin/goproxy
<span class="nv">$git</span> clone https://github.com/goproxyio/goproxy.git
<span class="nv">$cd</span> goproxy
<span class="nv">$make</span>
</code></pre></td></tr></table>
</div>
</div><p>After compiling, you will see the executable file named goproxy under the current bin directory (~/.bin/goproxy/goproxy/bin).</p>
<p>To create the goproxy cache directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$mkdir</span> /root/.bin/goproxy/goproxy/bin/cache
</code></pre></td></tr></table>
</div>
</div><p>Start goproxy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$./goproxy -listen<span class="o">=</span>0.0.0.0:8081 -cacheDir<span class="o">=</span>/root/.bin/goproxy/goproxy/bin/cache -proxy https://goproxy.io
goproxy.io: ProxyHost https://goproxy.io
</code></pre></td></tr></table>
</div>
</div><p>After startup goproxy listens on port 8081 (even if not specified, the default port for goproxy is 8081) and the specified upstream goproxy service is goproxy.io.</p>
<blockquote>
<p>Note: This startup parameter of goproxy is not the final version, here we just want to verify that goproxy works as expected.</p>
</blockquote>
<p>Next, let&rsquo;s verify that goproxy is working as we expect.</p>
<p>We configure the GOPROXY environment variable on the development machine to point to 10.10.20.20:8081.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// .bashrc
<span class="nb">export</span> <span class="nv">GOPROXY</span><span class="o">=</span>http://10.10.20.20:8081
</code></pre></td></tr></table>
</div>
</div><p>Once the environment variables are in effect, execute the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> get github.com/pkg/errors
</code></pre></td></tr></table>
</div>
</div><p>The result is as expected, the dev machine downloaded the github.com/pkg/errors package without any problems.</p>
<p>On the goproxy side, we see the following logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">goproxy.io: ------ --- /github.com/pkg/@v/list <span class="o">[</span>proxy<span class="o">]</span>
goproxy.io: ------ --- /github.com/pkg/errors/@v/list <span class="o">[</span>proxy<span class="o">]</span>
goproxy.io: ------ --- /github.com/@v/list <span class="o">[</span>proxy<span class="o">]</span>
goproxy.io: 0.146s <span class="m">404</span> /github.com/@v/list
goproxy.io: 0.156s <span class="m">404</span> /github.com/pkg/@v/list
goproxy.io: 0.157s <span class="m">200</span> /github.com/pkg/errors/@v/list
</code></pre></td></tr></table>
</div>
</div><p>And we also see the downloaded and cached github.com/pkg/errors package in the cache directory of goproxy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> /root/.bin/goproxy/goproxy/bin/cache
<span class="nv">$tree</span>
.
└── pkg
    └── mod
        └── cache
            └── download
                └── github.com
                    └── pkg
                        └── errors
                            └── @v
                                └── list

<span class="m">8</span> directories, <span class="m">1</span> file
</code></pre></td></tr></table>
</div>
</div><h3 id="2-customize-the-package-import-path-and-map-it-to-the-internal-vcs-repository">2. Customize the package import path and map it to the internal vcs repository</h3>
<p>The small factory may not assign a domain name to the vcs server, and we can&rsquo;t put an ip address in the import path of the Go private package, so we need to customize a path for our private go module, for example: <code>mycompany.com/go/module1</code>. We uniformly put the private go module in the code repository under <code>mycompany.com/go</code>.</p>
<p>The next problem is that when goproxy goes to pull <code>mycompany.com/go/module1</code>, it should get the address of the module1 repository on the internal vcs corresponding to <code>mycompany.com/go/module1</code>, so that goproxy can download the code corresponding to module1 from the internal vcs code server.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/5e69caf100084251bf4216cbdd7d7b87.png" alt="go module"></p>
<p>There is actually more than one solution. Here we use a tool called govanityurls, which I mentioned in my previous article.</p>
<p>By combining govanityurls and nginx, we can map the import path of a private go module to the real address of its code repository on vcs. The following diagram explains the exact principle.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/503a9d2503bf43849fe8ba2011640ca5.png" alt="govanityurls"></p>
<p>First, for goproxy to not forward incoming requests for pulling private go modules (mycompany.com/go/module1) to the public proxy, it needs to do something with its startup parameters, such as the following modified goproxy startup command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$./goproxy -listen<span class="o">=</span>0.0.0.0:8081 -cacheDir<span class="o">=</span>/root/.bin/goproxy/goproxy/bin/cache -proxy https://goproxy.io -exclude <span class="s2">&#34;mycompany.com/go&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>So any go module pull request that matches the value after -exclude, goproxy will not forward it to goproxy.io, but directly request the &ldquo;source&rdquo; of the go module. What you need to do in the above diagram is to convert the address of this &ldquo;source&rdquo; to a repository address in the internal vcs service. Since the domain name mycompany.com does not exist, we can see from the diagram that we have added this entry to /etc/hosts on the node where goproxy is located.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">127.0.0.1 mycompany.com
</code></pre></td></tr></table>
</div>
</div><p>Thus, the requests sent by goproxy to mycompany.com are actually sent to the local machine. In the above diagram, it is nginx that is listening on port 80 of the local machine. nginx has the following configuration for the mycompany.com host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">//</span> <span class="s">/etc/nginx/conf.d/gomodule.conf</span>

<span class="s">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">mycompany.com</span><span class="p">;</span>

        <span class="kn">location</span> <span class="s">/go</span> <span class="p">{</span>
                <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
                <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>

                <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;upgrade&#34;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that for the request with path <code>mycompany.com/go/xxx</code>, nginx forwards the request to 127.0.0.1:8080, which is exactly the address of the service <a href="https://github.com/GoogleCloudPlatform/govanityurls">govanityurls</a> tool listens to the address.</p>
<p>The tool govanityurls is a tool open sourced by <a href="https://rakyll.org/">Jaana B. Dogan</a>, a former member of the Go core development team, which helps gopher quickly implement a go get import path for custom Go packages.</p>
<p>govanityurls itself is like a &ldquo;navigation&rdquo; server. When the go command makes a request to a custom package address, it actually sends the request to the govanityurls service, and then govanityurls returns the real address of the requested package repository (read from the vanity.yaml configuration file) to the go command, which then gets the package data from the real repository address.</p>
<blockquote>
<p>Note: The installation method of govanityurls is simple, just go install/go get github.com/GoogleCloudPlatform/govanityurls directly.</p>
</blockquote>
<p>In our example, the configuration of vanity.yaml is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">mycompany.com</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">/go/module1</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l">ssh://admin@10.10.30.30/module1</span><span class="w">
</span><span class="w">      </span><span class="nt">vcs</span><span class="p">:</span><span class="w"> </span><span class="l">git</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>That means when govanityurls receives a request forwarded by nginx, it will match the request with the module path configured in vanity.yaml, and if the match is ok, the real repo address of the module will be returned in the response format expected by the go command. Here we see that the repository address on the real vcs corresponding to module1 is: <code>ssh://admin@10.10.30.30/module1</code>.</p>
<p>So goproxy receives this address, makes another request to this real address, and eventually caches module1 to the local cache and returns it to the client.</p>
<blockquote>
<p>Note: Since this scenario is the same as the second scenario of the big factory, goproxy needs to have access to all the real vcs repositories corresponding to the go modules under <code>mycompany.com/go</code>.</p>
</blockquote>
<h3 id="3-development-machine-client-setup">3. Development machine (client) setup</h3>
<p>In the previous example, we have set the GOPROXY environment variable of the development machine to the service address of goproxy. But we said that all go modules pulled by GOPROXY will have their sum values verified by the go command to the public GOSUM server by default. But we are essentially pulling a private go module, and the GOSUM server does not have the sum data of our go module. This will cause the go build command to report an error and prevent the build process from continuing.</p>
<p>Therefore, the development machine client also needs to set <code>mycompany.com/go</code> as a value to the GONOSUMDB environment variable, which tells the go command that any go module that matches <code>mycompany.com/go</code> does not need to do sum checksum.</p>
<h3 id="4-the-shortcomings-of-the-solution">4. The &ldquo;shortcomings&rdquo; of the solution</h3>
<p>Of course, the above solution is not perfect, it has its own shortcomings.</p>
<ul>
<li>Developers still need to configure additional GONOSUMDB variables</li>
</ul>
<p>Since the Go command by default checksum the go module pulled from GOPROXY, we need to configure the private go module to the GONOSUMDB environment variable, which brings a small &ldquo;burden&rdquo; to the developer.</p>
<p>Mitigation measures: small companies can put private go projects under a specific domain, so there is no need to add GONOSUMDB configuration for each go private project separately, you only need to configure it once.</p>
<ul>
<li>Add a private go module, vanity.yaml needs to be updated manually</li>
</ul>
<p>This is the most inflexible part of this solution. Due to the limited functionality of govanityurls, we may need to configure each private go module separately with its corresponding vcs repository address and access method (git, svn or hg).</p>
<p>Mitigation solution: manage multiple private go modules in a single vcs repository, as in <a href="https://github.com/etcd-io/etcd">etcd</a>. Compared to the original go official recommendation of one repo managing only one module, newer versions of go have come a long way in terms of <a href="https://golang.google.cn/doc/modules/managing-source#multiple-module-source">one repo managing multiple go modules</a> has come a long way.</p>
<p>But for small companies, this extra work should be nothing compared to the benefits gained! ^_^</p>
<ul>
<li>Unable to divide permissions</li>
</ul>
<p>As mentioned in the above scenario, the node where goproxy is located needs to have access to all private go modules in the vcs repo, but it is not possible to make differential authorization to the go developer side, so that as long as the private go module can be pulled by goproxy, the go developer can pull it.</p>
<p>However, for most small companies, all internal source code is in principle public within the enterprise, and this problem does not seem to be too big. If you think this is a problem, then you can only use the first option of the big manufacturers above.</p>
<h2 id="3-summary">3. Summary</h2>
<p>Large and small companies alike, as the use of Go grows deeper, more people are accepted, and more and more complex projects are developed, issues like pulling private go modules will certainly come to the table.</p>
<p>For gopher in large companies, this may not be a problem, or even transparent to them. But for small companies and other organizations with incomplete internal IT infrastructure, it does require a do-it-yourself solution.</p>
<p>This article provides an idea and a reference implementation for small companies to build Go private libraries and pull private go modules from private libraries.</p>
<p>If you think the above installation and configuration steps are a bit tedious, those who are interested in going deeper can package the above programs (goproxy, nginx, govanityurls) into a container image to achieve one-click installation and setup.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/when-variables-captured-by-closures-are-recycled-in-go/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">When will variables caught by closures be recycled in Go?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/the-design-of-the-response-for-grpc-server/">
            <span class="next-text nav-default">Response design for gRPC services</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
