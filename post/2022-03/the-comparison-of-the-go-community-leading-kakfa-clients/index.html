<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A brief comparison of mainstream Kafka clients in the Go community - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article compared three mainstream kafka client packages from the Go community: Shopify/sarama, confluent-kafka-go, and segmentio/kafka-go. sarama is the most widely used and the one I have studied for the longest time, but it also has the most pitfalls and is abandoned; confluent-kafka-go is official but based on cgo. go is official but based on cgo, so I have no choice but to give up; finally, we chose segmentio/kafka-go, which has been running online for some time and no major problems have been found so far." /><meta name="keywords" content="golang, Kafka Clients" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/the-comparison-of-the-go-community-leading-kakfa-clients/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="A brief comparison of mainstream Kafka clients in the Go community" />
<meta property="og:description" content="This article compared three mainstream kafka client packages from the Go community: Shopify/sarama, confluent-kafka-go, and segmentio/kafka-go. sarama is the most widely used and the one I have studied for the longest time, but it also has the most pitfalls and is abandoned; confluent-kafka-go is official but based on cgo. go is official but based on cgo, so I have no choice but to give up; finally, we chose segmentio/kafka-go, which has been running online for some time and no major problems have been found so far." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/the-comparison-of-the-go-community-leading-kakfa-clients/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-28T09:57:23+08:00" />
<meta property="article:modified_time" content="2022-03-28T09:57:23+08:00" />

<meta itemprop="name" content="A brief comparison of mainstream Kafka clients in the Go community">
<meta itemprop="description" content="This article compared three mainstream kafka client packages from the Go community: Shopify/sarama, confluent-kafka-go, and segmentio/kafka-go. sarama is the most widely used and the one I have studied for the longest time, but it also has the most pitfalls and is abandoned; confluent-kafka-go is official but based on cgo. go is official but based on cgo, so I have no choice but to give up; finally, we chose segmentio/kafka-go, which has been running online for some time and no major problems have been found so far."><meta itemprop="datePublished" content="2022-03-28T09:57:23+08:00" />
<meta itemprop="dateModified" content="2022-03-28T09:57:23+08:00" />
<meta itemprop="wordCount" content="4528">
<meta itemprop="keywords" content="golang,Kafka," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A brief comparison of mainstream Kafka clients in the Go community"/>
<meta name="twitter:description" content="This article compared three mainstream kafka client packages from the Go community: Shopify/sarama, confluent-kafka-go, and segmentio/kafka-go. sarama is the most widely used and the one I have studied for the longest time, but it also has the most pitfalls and is abandoned; confluent-kafka-go is official but based on cgo. go is official but based on cgo, so I have no choice but to give up; finally, we chose segmentio/kafka-go, which has been running online for some time and no major problems have been found so far."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A brief comparison of mainstream Kafka clients in the Go community</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-28 09:57:23 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4528 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#i-background">I. Background</a></li>
            <li><a href="#ii-shopifysarama-more-stars-dont-necessarily-mean-better">II. Shopify/sarama: more stars don&rsquo;t necessarily mean better</a></li>
            <li><a href="#iii-confluent-kafka-go-the-package-that-requires-cgo-to-be-opened-is-still-a-bit-annoying">III. confluent-kafka-go: the package that requires cgo to be opened is still a bit annoying</a></li>
            <li><a href="#iv-segmentiokafka-go-sync-is-slow-async-is-fast">iv. segmentio/kafka-go: sync is slow, async is fast</a></li>
            <li><a href="#v-write-performance">V. Write performance</a></li>
            <li><a href="#vi-summary">VI. Summary</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/28/e948b0433944450eaecaaf3d923abca6.png" alt="golang Kafka"></p>
<h3 id="i-background">I. Background</h3>
<p>As we all know, <a href="https://kafka.apache.org/">Kafka</a> is a star open source project under the Apache Open Source Foundation. As an open source distributed event streaming platform, it is used by thousands of companies for high-performance data pipelines, stream analysis, data integration, and mission-critical applications. In China, large and small companies, whether they deploy their own or use Kafka cloud services like those provided by AliCloud, many Internet applications are already inseparable from Kafka.</p>
<blockquote>
<p>The Internet is not bound to a certain programming language, but many people don&rsquo;t like that Kafka is developed by Scala/Java. Especially for those programmers who have a &ldquo;religious&rdquo; devotion to a language and a &ldquo;hammer in their hands and nails in their eyes&rdquo;, there is always an urge to rewrite Kafka. But just like many fans of the new language want to rewrite Kubernetes, Kafka has already established a huge start and ecological advantage, and it is difficult to establish a mega-project with the same specifications and the corresponding ecology in the short term (the same hot Kafka-like <a href="https://github.com/apache/">Apache pulsar</a> in the last two years pulsar) was created in the same time as Kafka, but it was incorporated into the Apache Foundation hosting later).</p>
</blockquote>
<p>The Kafka ecosystem is robust, with Kafka clients for all programming languages. The company behind Kafka <a href="https://confluent.io/">confluent.inc</a> also maintains clients for all major languages.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/28/8f5fae7f094c4b00b80af061b5495285.png" alt="Kafka clients for all programming languages"></p>
<p>Developers of other major languages just need to take advantage of these client sides and make good connections to the Kafka cluster. Well done so much pavement, the following talk about why to write this article.</p>
<p>The current logging scheme for the production environment of the business line is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/28/3a2e0af5cfa04388a5d1759ef241b268.png" alt="logging scheme for the production environment of the business line"></p>
<p>From the diagram we see: <strong>The business system writes logs to Kafka, and then consumes the logs through the logstash tool and aggregates them to the Elastic Search Cluster behind for query use</strong> . The business system is mainly implemented in Java, and in order to prevent the log from blocking the business process, the business system uses <a href="https://logback.qos.ch/">logback</a>, which supports the fallback appender, to write the logs: <strong>This way, when the Kafka write fails, the logs This way, when Kafka writes fail, the logs can be written to an alternate file to ensure that the logs are not lost as much as possible</strong> .</p>
<p>Considering the reuse of existing IT facilities and solutions, our new system implemented in Go also converges to this no-drop log aggregation solution, which requires that our logger also supports writing to Kafka and supports the fallback mechanism.</p>
<p>Our log package is based on the uber zap package, <a href="https://github.com/uber-go/zap">uber&rsquo;s zap log package</a> is currently one of the most widely used, high-performance log packages in the Go community, Issue 25 <a href="https://www.thoughtworks.com/zh-cn/radar">thoughtworks technical radar</a> also lists zap as a recommended tool for the experimental phase, and the thoughtworks team is already using it on a large scale.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/28/595a051f9da243f180dd6235e99e7470.png" alt="uber zap"></p>
<p>However, zap does not natively support writing Kafka, but zap is extensible, and we need to add extensions to it for writing Kafka. And to write Kafka, we can&rsquo;t do without the Kafka Client package. Currently the mainstream Kafka client in Go community are <a href="https://github.com/Shopify/sarama">sarama from Shopify</a>, <a href="https://github.com/confluentinc/confluent-kafka-go">confluent-kafka-go</a> maintained by confluent.inc, the company behind Kafka, and <a href="https://github.com/segmentio/kafka-go/">segmentio/kafka-go</a>.</p>
<p>In this post, I&rsquo;ll talk about my experience with each of these three clients based on my usage history.</p>
<p>Here, let&rsquo;s start with Shopify/sarama, which has the most stars.</p>
<h3 id="ii-shopifysarama-more-stars-dont-necessarily-mean-better">II. Shopify/sarama: more stars don&rsquo;t necessarily mean better</h3>
<p>The Kafka client package that has the most stars and is most widely used in the Go community is sarama for Shopify, a foreign e-commerce platform.</p>
<p>Here I will demonstrate how to extend zap to support writing kafka based on sarama. in the previous article, I introduced zap built on top of zapcore, which consists of Encoder, WriteSyncer and LevelEnabler, for our functional requirements of writing Kafka We just need to <strong>define an implementation that gives a WriteSyncer interface to assemble a logger that supports writing to Kafka</strong> .</p>
<p>Let&rsquo;s start by looking at the function that creates the logger from the top down.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/zapkafka/log.go
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Logger</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">l</span>     <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span> <span class="c1">// zap ensure that zap.Logger is safe for concurrent use
</span><span class="c1"></span>    <span class="nx">cfg</span>   <span class="nx">zap</span><span class="p">.</span><span class="nx">Config</span>
    <span class="nx">level</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">AtomicLevel</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">level</span> <span class="kt">int8</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">writer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;the writer is nil&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">atomicLevel</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewAtomicLevelAt</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nf">Level</span><span class="p">(</span><span class="nx">level</span><span class="p">))</span>

    <span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">cfg</span><span class="p">:</span>   <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">(),</span>
        <span class="nx">level</span><span class="p">:</span> <span class="nx">atomicLevel</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">logger</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">.</span><span class="nx">EncodeTime</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">enc</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">PrimitiveArrayEncoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">enc</span><span class="p">.</span><span class="nf">AppendString</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">))</span> <span class="c1">// 2021-11-19 10:11:30.777
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">.</span><span class="nx">TimeKey</span> <span class="p">=</span> <span class="s">&#34;logtime&#34;</span>

    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">writer</span><span class="p">),</span>
        <span class="nx">atomicLevel</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">l</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">core</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">logger</span>
<span class="p">}</span>

<span class="c1">// SetLevel alters the logging level on runtime
</span><span class="c1">// it is concurrent-safe
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">SetLevel</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int8</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">.</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nf">Level</span><span class="p">(</span><span class="nx">level</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There is nothing related to the kafka client in this code. The New function is used to create a *Logger instance, which takes the first argument of the io. Note that <strong>we use the zap.AtomicLevel type to store the logger&rsquo;s level information, based on the fact that the <code>zap.AtomicLevel</code> level supports hot updates, we can dynamically modify the logger&rsquo;s log level at runtime</strong>.</p>
<p>Next, we will implement a type that satisfies the zapcore.WriteSyncer interface based on sarama&rsquo;s AsyncProducer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/zapkafka/kafka_syncer.go
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">kafkaWriteSyncer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">topic</span>          <span class="kt">string</span>
    <span class="nx">producer</span>       <span class="nx">sarama</span><span class="p">.</span><span class="nx">AsyncProducer</span>
    <span class="nx">fallbackSyncer</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">WriteSyncer</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewKafkaAsyncProducer</span><span class="p">(</span><span class="nx">addrs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">sarama</span><span class="p">.</span><span class="nx">AsyncProducer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">config</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">Producer</span><span class="p">.</span><span class="nx">Return</span><span class="p">.</span><span class="nx">Errors</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewAsyncProducer</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewKafkaSyncer</span><span class="p">(</span><span class="nx">producer</span> <span class="nx">sarama</span><span class="p">.</span><span class="nx">AsyncProducer</span><span class="p">,</span> <span class="nx">topic</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fallbackWs</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">WriteSyncer</span><span class="p">)</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">WriteSyncer</span> <span class="p">{</span>
    <span class="nx">w</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">kafkaWriteSyncer</span><span class="p">{</span>
        <span class="nx">producer</span><span class="p">:</span>       <span class="nx">producer</span><span class="p">,</span>
        <span class="nx">topic</span><span class="p">:</span>          <span class="nx">topic</span><span class="p">,</span>
        <span class="nx">fallbackSyncer</span><span class="p">:</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">fallbackWs</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">producer</span><span class="p">.</span><span class="nf">Errors</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">val</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Msg</span><span class="p">.</span><span class="nx">Value</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">continue</span>
            <span class="p">}</span>

            <span class="nx">fallbackWs</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">return</span> <span class="nx">w</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>NewKafkaSyncer is the same function that creates zapcore.WriteSyncer, which uses the sarama.AsyncProducer interface type for its first argument, in order to be able to take advantage of the <a href="https://github.com/Shopify/sarama/tree/main/mocks">mock test package provided by sarama</a>. The last parameter is the WriteSyncer parameter used during fallback.</p>
<p>NewKafkaAsyncProducer function is used to facilitate the user to create sarama.AsyncProducer quickly, where the config uses the default config value. In the config default value, the default value of Return.Successes is false, which means that the client does not care about the success status of messages written to Kafka, and we do not need to create a separate goroutine to consume AsyncProducer.Successes(). But we need to focus on write failures, so we set Return.Errors to true and start a goroutine in NewKafkaSyncer to handle the log data of write failures and write them to the fallback syncer.</p>
<p>Next, let&rsquo;s look at the Write and Sync methods of the kafkaWriteSyncer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/zapkafka/kafka_syncer.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">ws</span> <span class="o">*</span><span class="nx">kafkaWriteSyncer</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b1</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">b1</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="c1">// b is reused, we must pass its copy b1 to sarama
</span><span class="c1"></span>    <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sarama</span><span class="p">.</span><span class="nx">ProducerMessage</span><span class="p">{</span>
        <span class="nx">Topic</span><span class="p">:</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">topic</span><span class="p">,</span>
        <span class="nx">Value</span><span class="p">:</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">ByteEncoder</span><span class="p">(</span><span class="nx">b1</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">producer</span><span class="p">.</span><span class="nf">Input</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="nx">msg</span><span class="p">:</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="c1">// if producer block on input channel, write log entry to default fallbackSyncer
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">fallbackSyncer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">b1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b1</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ws</span> <span class="o">*</span><span class="nx">kafkaWriteSyncer</span><span class="p">)</span> <span class="nf">Sync</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">ws</span><span class="p">.</span><span class="nx">producer</span><span class="p">.</span><span class="nf">AsyncClose</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">fallbackSyncer</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: b in the above code will be reused by zap, so we need to make a copy of b and send the copy to sarama before throwing it to the sarama channel.</p>
</blockquote>
<p>From the above code, here we are wrapping the data to be written into a <code>sarama.ProducerMessage</code> and send it to the input channel of the producer. What is the reason for this situation? This is mainly because the kafka logger based on sarama v1.30.0 had a hang in our validation environment, and the network might have fluctuated at that time, causing the connection between the logger and kafka to be abnormal, and we initially suspect that this position is blocking, causing the business to be blocked. There is a <a href="https://github.com/Shopify/sarama/pull/2133">fix in sarama v1.32.0</a>, which is very similar to our hang phenomenon.</p>
<p>But there is a serious problem with doing so, that is, in the stress test, we found that a large number of logs could not be written to kafka, but were written to the fallback syncer. The reason for this is that we see in sarama&rsquo;s async_producer.go that the input channel is an unbuffered channel, and there is only one dispatcher goroutine that reads messages from the input channel, and considering the scheduling of the goroutine, the logs are written to the fallback syncer. Considering the scheduling of the goroutine, it is not surprising that a large number of logs are written to the fallback syncer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/Shopify/sarama@v1.32.0/async_producer.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newAsyncProducer</span><span class="p">(</span><span class="nx">client</span> <span class="nx">Client</span><span class="p">)</span> <span class="p">(</span><span class="nx">AsyncProducer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check that we are not dealing with a closed Client before processing any other arguments
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Closed</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrClosedClient</span>
    <span class="p">}</span>

    <span class="nx">txnmgr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newTransactionManager</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">Config</span><span class="p">(),</span> <span class="nx">client</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">asyncProducer</span><span class="p">{</span>
        <span class="nx">client</span><span class="p">:</span>     <span class="nx">client</span><span class="p">,</span>
        <span class="nx">conf</span><span class="p">:</span>       <span class="nx">client</span><span class="p">.</span><span class="nf">Config</span><span class="p">(),</span>
        <span class="nx">errors</span><span class="p">:</span>     <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">ProducerError</span><span class="p">),</span>
        <span class="nx">input</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">ProducerMessage</span><span class="p">),</span> <span class="c1">// 笔者注：这是一个unbuffer channel
</span><span class="c1"></span>        <span class="nx">successes</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">ProducerMessage</span><span class="p">),</span>
        <span class="nx">retries</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">ProducerMessage</span><span class="p">),</span>
        <span class="nx">brokers</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Broker</span><span class="p">]</span><span class="o">*</span><span class="nx">brokerProducer</span><span class="p">),</span>
        <span class="nx">brokerRefs</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">brokerProducer</span><span class="p">]</span><span class="kt">int</span><span class="p">),</span>
        <span class="nx">txnmgr</span><span class="p">:</span>     <span class="nx">txnmgr</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="o">...</span> <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Some people say here can add timer (Timer) to do timeout, to know the log are on the critical path of program execution, every write a log to start a Timer feels too consuming (even Reset reuse Timer). <strong>If sarama doesn&rsquo;t hang the input channel at any time, then let&rsquo;s not use a trick like select-default in the Write method</strong>.</p>
<p>A nice thing about sarama is that it provides the <a href="https://github.com/Shopify/sarama/tree/main/mocks">mocks test package</a>, which can be used both for self-testing of sarama and for self-testing of go packages that depend on sarama, taking the above implementation as an example, we can write some tests based on the mocks test package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/zapkafka/log_test.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">TestWriteFailWithKafkaSyncer</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">config</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewAsyncProducer</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>

    <span class="kd">var</span> <span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="nx">w</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">))</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="nf">NewKafkaSyncer</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="nf">NewFileSyncer</span><span class="p">(</span><span class="nx">w</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nx">p</span><span class="p">.</span><span class="nf">ExpectInputAndFail</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;produce error&#34;</span><span class="p">))</span>
    <span class="nx">p</span><span class="p">.</span><span class="nf">ExpectInputAndFail</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;produce error&#34;</span><span class="p">))</span>

    <span class="c1">// all below will be written to the fallback sycner
</span><span class="c1"></span>    <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo1&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="s">&#34;ok&#34;</span><span class="p">))</span> <span class="c1">// write to the kafka syncer
</span><span class="c1"></span>    <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo2&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="s">&#34;ok&#34;</span><span class="p">))</span> <span class="c1">// write to the kafka syncer
</span><span class="c1"></span>
    <span class="c1">// make sure the goroutine which handles the error writes the log to the fallback syncer
</span><span class="c1"></span>    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>

    <span class="nx">s</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&#34;demo1&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;want true, actual false&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&#34;demo2&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;want true, actual false&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>NewAsyncProducer<code>returns an implementation that satisfies the</code>sarama.AsyncProducer` interface. Then set expect, for each message, and write two logs here, so set it twice. Note: <strong>Since we are handling the Errors channel in a separate goroutine, there are some competing conditions here</strong> . In concurrent programs, the Fallback syncer must also support concurrent writes. zapcore provides zapcore.Lock which can be used to wrap a normal zapcore.WriteSyncer into a concurrency-safe WriteSyncer.</p>
<p>However, there was a &ldquo;serious&rdquo; problem with sarama. We remove the select-default operation for the input channel and create a concurrent-write applet for concurrently writing logs to kafka.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/zapkafka/cmd/concurrent_write/main.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">SaramaProducer</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">NewKafkaAsyncProducer</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;localhost:29092&#34;</span><span class="p">})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nf">NewKafkaSyncer</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)),</span> <span class="nb">int8</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="kd">var</span> <span class="nx">cnt</span> <span class="kt">int64</span>

    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="kt">string</span>
            <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
                <span class="nx">value</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%02d-%04d-%s&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">now</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;15:04:05&#34;</span><span class="p">))</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;log message:&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span>
                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
        <span class="p">}(</span><span class="nx">j</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
    <span class="nb">println</span><span class="p">(</span><span class="s">&#34;cnt =&#34;</span><span class="p">,</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cnt</span><span class="p">))</span>
    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">SaramaProducer</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We start a kafka service locally using <a href="https://developer.confluent.io/quickstart/kafka-docker/">docker-compose.yml</a>, which is officially provided by kafka.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> benchmark
<span class="nv">$docker</span>-compose up -d
</code></pre></td></tr></table>
</div>
</div><p>Then we use the consumer tool that comes with the kafka container to consume data from the topic named test, and the consumed data is redirected to 1.log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$docker</span> <span class="nb">exec</span> benchmark_kafka_1 /bin/kafka-console-consumer --bootstrap-server localhost:9092 --topic <span class="nb">test</span> --from-beginning &gt; 1.log 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>Then we run concurrent_write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ make
$./concurrent_write &gt; 1.log 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>The concurrent_write program starts 10 goroutines, each goroutine writes 1w logs to kafka, most of the time you can see 10w logs in the 1.log in the benchmark directory, but when using sarama v1.30.0, sometimes you can see less than 10w logs. but when I use sarama v1.30.0, I sometimes see less than 10w logs, and I don&rsquo;t know where the &ldquo;missing&rdquo; logs are. With sarama v1.32.0, this has not happened yet.</p>
<p>Well, it&rsquo;s time to look at the next kafka client package!</p>
<h3 id="iii-confluent-kafka-go-the-package-that-requires-cgo-to-be-opened-is-still-a-bit-annoying">III. confluent-kafka-go: the package that requires cgo to be opened is still a bit annoying</h3>
<p>The <a href="https://github.com/confluentinc/confluent-kafka-go/">confluent-kafka-go package</a> is a Go client maintained by confluent.inc, the technology company behind kafka, and can be considered the official Go client for Kafka. The only &ldquo;problem&rdquo; with this package, however, is that it is built on the <a href="https://github.com/edenhill/librdkafka">kafka c/c++ library librdkafka</a>, which means that once your Go application relies on the confluent-kafka-go, you will have a hard time achieving static compilation of Go applications and cross-platform compilation. Since all business systems rely on log packages, once the dependency on confluent-kafka-go can only be dynamically linked, our build toolchain all needs to be changed, which is slightly more costly.</p>
<p>However, confluent-kafka-go is easy to use, has good write performance, and does not have the same &ldquo;lost messages&rdquo; as the previous sarama, here is an example of a confluent-kafka-go based producer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/confluent-kafka-go-static-build/producer.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="nx">configFile</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">kafka</span><span class="p">.</span><span class="nx">ConfigMap</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">ConfigValue</span><span class="p">)</span>
    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;Failed to open file: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="nx">scanner</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewScanner</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">scanner</span><span class="p">.</span><span class="nf">Scan</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">line</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">scanner</span><span class="p">.</span><span class="nf">Text</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;#&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">kv</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;=&#34;</span><span class="p">)</span>
            <span class="nx">parameter</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">value</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nx">m</span><span class="p">[</span><span class="nx">parameter</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Failed to read file: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">m</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">conf</span> <span class="o">:=</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="s">&#34;./producer.conf&#34;</span><span class="p">)</span>

    <span class="nx">topic</span> <span class="o">:=</span> <span class="s">&#34;test&#34;</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kafka</span><span class="p">.</span><span class="nf">NewProducer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conf</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Failed to create producer: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="kd">var</span> <span class="nx">cnt</span> <span class="kt">int64</span>

    <span class="c1">// Go-routine to handle message delivery reports and
</span><span class="c1"></span>    <span class="c1">// possibly other event types (errors, stats, etc)
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Events</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">*</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Message</span><span class="p">:</span>
                <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">.</span><span class="nx">Error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Failed to deliver message: %v\n&#34;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Produced event to topic %s: key = %-10s value = %s\n&#34;</span><span class="p">,</span>
                        <span class="o">*</span><span class="nx">ev</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">.</span><span class="nx">Topic</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Key</span><span class="p">),</span> <span class="nb">string</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Value</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="kt">string</span>
            <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="nx">key</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
                <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
                <span class="nx">value</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%02d-%04d-%s&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">now</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;15:04:05&#34;</span><span class="p">))</span>
                <span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
                <span class="nx">p</span><span class="p">.</span><span class="nf">Produce</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
                    <span class="nx">TopicPartition</span><span class="p">:</span> <span class="nx">kafka</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">{</span><span class="nx">Topic</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">Partition</span><span class="p">:</span> <span class="nx">kafka</span><span class="p">.</span><span class="nx">PartitionAny</span><span class="p">},</span>
                    <span class="nx">Key</span><span class="p">:</span>            <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span>
                    <span class="nx">Value</span><span class="p">:</span>          <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span>
                <span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
                <span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
        <span class="p">}(</span><span class="nx">j</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
    <span class="c1">// Wait for all messages to be delivered
</span><span class="c1"></span>    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="nx">p</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we still use 10 goroutines to write 1w messages each to kafka. Note: Producer instances created with kafka.NewProducer by default are not concurrency safe, so here a sync.Mutex is used to manage their Produce calls synchronously. We can verify that confluent-kafka-go is running by starting a kafka service locally, as in the example in sarama.</p>
<p>Since the confluent-kafka-go package is implemented based on the kafka c library, we cannot turn off CGO, and if we do, we will encounter the following compilation problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build
<span class="c1"># producer</span>
./producer.go:15:42: undefined: kafka.ConfigMap
./producer.go:17:29: undefined: kafka.ConfigValue
./producer.go:50:18: undefined: kafka.NewProducer
./producer.go:85:22: undefined: kafka.Message
./producer.go:86:28: undefined: kafka.TopicPartition
./producer.go:86:75: undefined: kafka.PartitionAny
</code></pre></td></tr></table>
</div>
</div><p>Therefore, by default Go programs that rely on the confluent-kafka-go package will be dynamically linked, and the compiled program results are viewed via ldd as follows (on CentOS).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$make</span> build
<span class="nv">$ldd</span> producer
    linux-vdso.so.1 <span class="o">=</span>&gt;  <span class="o">(</span>0x00007ffcf87ec000<span class="o">)</span>
    libm.so.6 <span class="o">=</span>&gt; /lib64/libm.so.6 <span class="o">(</span>0x00007f473d014000<span class="o">)</span>
    libdl.so.2 <span class="o">=</span>&gt; /lib64/libdl.so.2 <span class="o">(</span>0x00007f473ce10000<span class="o">)</span>
    libpthread.so.0 <span class="o">=</span>&gt; /lib64/libpthread.so.0 <span class="o">(</span>0x00007f473cbf4000<span class="o">)</span>
    librt.so.1 <span class="o">=</span>&gt; /lib64/librt.so.1 <span class="o">(</span>0x00007f473c9ec000<span class="o">)</span>
    libc.so.6 <span class="o">=</span>&gt; /lib64/libc.so.6 <span class="o">(</span>0x00007f473c61e000<span class="o">)</span>
    /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007f473d316000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>So is it possible to compile statically with CGO on? Theoretically, yes.</p>
<p>But the confluent-kafka-go package is officially confirmed not to support static compilation yet. Let&rsquo;s try statically compiling it with CGO on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// on CentOS
$ go build -buildvcs<span class="o">=</span><span class="nb">false</span> -o producer-static -ldflags <span class="s1">&#39;-linkmode &#34;external&#34; -extldflags &#34;-static&#34;&#39;</span>
$ producer
/root/.bin/go1.18beta2/pkg/tool/linux_amd64/link: running gcc failed: <span class="nb">exit</span> status <span class="m">1</span>
/usr/bin/ld: 找不到 -lm
/usr/bin/ld: 找不到 -ldl
/usr/bin/ld: 找不到 -lpthread
/usr/bin/ld: 找不到 -lrt
/usr/bin/ld: 找不到 -lpthread
/usr/bin/ld: 找不到 -lc
collect2: 错误：ld 返回 <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>Static linking will statically link the symbols of the c part of confluent-kafka-go, which may be in c runtime libraries such as libc, libpthread, or system libraries, but by default CentOS does not have the .a (archive) versions of these libraries installed. We need to install them manually.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-h" data-lang="h"><span class="err">$</span><span class="n">yum</span> <span class="n">install</span> <span class="n">glibc</span><span class="o">-</span><span class="k">static</span>
</code></pre></td></tr></table>
</div>
</div><p>After installation, we then execute the static compile command above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> build -buildvcs<span class="o">=</span><span class="nb">false</span> -o producer-static -ldflags <span class="s1">&#39;-linkmode &#34;external&#34; -extldflags &#34;-static&#34;&#39;</span>
$ producer
/root/go/pkg/mod/github.com/confluentinc/confluent-kafka-go@v1.8.2/kafka/librdkafka_vendor/librdkafka_glibc_linux.a<span class="o">(</span>rddl.o<span class="o">)</span>：在函数<span class="s1">&#39;rd_dl_open&#39;</span>中：
<span class="o">(</span>.text+0x1d<span class="o">)</span>: 警告：Using <span class="s1">&#39;dlopen&#39;</span> in statically linked applications requires at runtime the shared libraries from the glibc version used <span class="k">for</span> linking
/root/go/pkg/mod/github.com/confluentinc/confluent-kafka-go@v1.8.2/kafka/librdkafka_vendor/librdkafka_glibc_linux.a<span class="o">(</span>rdaddr.o<span class="o">)</span>：在函数<span class="s1">&#39;rd_getaddrinfo&#39;</span>中：
<span class="o">(</span>.text+0x440<span class="o">)</span>: 警告：Using <span class="s1">&#39;getaddrinfo&#39;</span> in statically linked applications requires at runtime the shared libraries from the glibc version used <span class="k">for</span> linking
</code></pre></td></tr></table>
</div>
</div><p>This time our static compilation worked!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ldd producer-static
    不是动态可执行文件
</code></pre></td></tr></table>
</div>
</div><p>But there are some warnings! Let&rsquo;s ignore these warnings and try to see if the compiled producer-static is available. Starting the local kafka service with docker-compose and executing producer-static, we find that the application can write 10w messages to kafka normally, without errors occurring in between. At least in the producer scenario, the application does not execute the code containing dlopen, getaddrinfo.</p>
<p>However, this does not mean that the above static compilation approach is not problematic in other scenarios, so let&rsquo;s wait for the official solution to be released. Or use the builder container to build your confluent-kafka-go based application.</p>
<p>Let&rsquo;s move on to segmentio/kafka-go.</p>
<h3 id="iv-segmentiokafka-go-sync-is-slow-async-is-fast">iv. segmentio/kafka-go: sync is slow, async is fast</h3>
<p>Like sarama, segmentio/kafka-go is a pure go implementation of the kafka client and has been tested in many companies' production environments. segmentio/kafka-go provides low-level conn api and high-level api (reader and writer), taking writer as an example. Relative to the low-level api, it is concurrently safe, but also provides connection hold and retry, without the need for developers to implement their own, in addition writer also supports sync and async write, timeout write with context.</p>
<p>But Writer&rsquo;s sync mode is very slow, only a few dozen a second, but async mode is fast!</p>
<p>However, like confluent-kafka-go, segmentio/kafka-go does not provide a mock test package like sarama, we need to build our own environment to test. kafka-go official advice: <strong>start a kafka service locally and run the test</strong> . In the age of lightweight containers, <strong>it&rsquo;s worth thinking about whether mock is needed</strong>.</p>
<p>The experience with segmentio/kafka-go has been great, and I haven&rsquo;t encountered any major problems so far, so I won&rsquo;t give examples here. See the benchmark section below for examples.</p>
<h3 id="v-write-performance">V. Write performance</h3>
<p>Even a brief comparison cannot be done without benchmark, and test cases for sequential benchmark and concurrent benchmark are created here for each of the three packages above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/blob/master/kafka-clients/benchmark/kafka_clients_test.go
</span><span class="c1"></span>
<span class="kd">var</span> <span class="nx">m</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;this is benchmark for three mainstream kafka client&#34;</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">BenchmarkSaramaAsync</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">config</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="nx">producer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewAsyncProducer</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;localhost:29092&#34;</span><span class="p">},</span> <span class="nx">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">message</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sarama</span><span class="p">.</span><span class="nx">ProducerMessage</span><span class="p">{</span><span class="nx">Topic</span><span class="p">:</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">ByteEncoder</span><span class="p">(</span><span class="nx">m</span><span class="p">)}</span>

    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">producer</span><span class="p">.</span><span class="nf">Input</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="nx">message</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkSaramaAsyncInParalell</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">config</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="nx">producer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">NewAsyncProducer</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;localhost:29092&#34;</span><span class="p">},</span> <span class="nx">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">message</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sarama</span><span class="p">.</span><span class="nx">ProducerMessage</span><span class="p">{</span><span class="nx">Topic</span><span class="p">:</span> <span class="s">&#34;test&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">sarama</span><span class="p">.</span><span class="nf">ByteEncoder</span><span class="p">(</span><span class="nx">m</span><span class="p">)}</span>

    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>

    <span class="nx">b</span><span class="p">.</span><span class="nf">RunParallel</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">pb</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">PB</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">producer</span><span class="p">.</span><span class="nf">Input</span><span class="p">()</span> <span class="o">&lt;-</span> <span class="nx">message</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkKafkaGoAsync</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">w</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">kafkago</span><span class="p">.</span><span class="nx">Writer</span><span class="p">{</span>
        <span class="nx">Addr</span><span class="p">:</span>     <span class="nx">kafkago</span><span class="p">.</span><span class="nf">TCP</span><span class="p">(</span><span class="s">&#34;localhost:29092&#34;</span><span class="p">),</span>
        <span class="nx">Topic</span><span class="p">:</span>    <span class="s">&#34;test&#34;</span><span class="p">,</span>
        <span class="nx">Balancer</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">kafkago</span><span class="p">.</span><span class="nx">LeastBytes</span><span class="p">{},</span>
        <span class="nx">Async</span><span class="p">:</span>    <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">WriteMessages</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">kafkago</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">m</span><span class="p">)})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkKafkaGoAsyncInParalell</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">w</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">kafkago</span><span class="p">.</span><span class="nx">Writer</span><span class="p">{</span>
        <span class="nx">Addr</span><span class="p">:</span>     <span class="nx">kafkago</span><span class="p">.</span><span class="nf">TCP</span><span class="p">(</span><span class="s">&#34;localhost:29092&#34;</span><span class="p">),</span>
        <span class="nx">Topic</span><span class="p">:</span>    <span class="s">&#34;test&#34;</span><span class="p">,</span>
        <span class="nx">Balancer</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">kafkago</span><span class="p">.</span><span class="nx">LeastBytes</span><span class="p">{},</span>
        <span class="nx">Async</span><span class="p">:</span>    <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>

    <span class="nx">b</span><span class="p">.</span><span class="nf">RunParallel</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">pb</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">PB</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">w</span><span class="p">.</span><span class="nf">WriteMessages</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">kafkago</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">m</span><span class="p">)})</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="nx">configFile</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nx">ConfigMap</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">ckafkago</span><span class="p">.</span><span class="nx">ConfigValue</span><span class="p">)</span>

    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">configFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;Failed to open file: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="nx">scanner</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewScanner</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">scanner</span><span class="p">.</span><span class="nf">Scan</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">line</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">scanner</span><span class="p">.</span><span class="nf">Text</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;#&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">kv</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;=&#34;</span><span class="p">)</span>
            <span class="nx">parameter</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nx">value</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="nx">m</span><span class="p">[</span><span class="nx">parameter</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Failed to read file: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">m</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkConfluentKafkaGoAsync</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">conf</span> <span class="o">:=</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="s">&#34;./confluent-kafka-go.conf&#34;</span><span class="p">)</span>

    <span class="nx">topic</span> <span class="o">:=</span> <span class="s">&#34;test&#34;</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nf">NewProducer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conf</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Events</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="nx">key</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">.</span><span class="nf">Produce</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ckafkago</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
            <span class="nx">TopicPartition</span><span class="p">:</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">{</span><span class="nx">Topic</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">Partition</span><span class="p">:</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nx">PartitionAny</span><span class="p">},</span>
            <span class="nx">Key</span><span class="p">:</span>            <span class="nx">key</span><span class="p">,</span>
            <span class="nx">Value</span><span class="p">:</span>          <span class="nx">m</span><span class="p">,</span>
        <span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkConfluentKafkaGoAsyncInParalell</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">conf</span> <span class="o">:=</span> <span class="nf">ReadConfig</span><span class="p">(</span><span class="s">&#34;./confluent-kafka-go.conf&#34;</span><span class="p">)</span>

    <span class="nx">topic</span> <span class="o">:=</span> <span class="s">&#34;test&#34;</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nf">NewProducer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conf</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Events</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="kd">var</span> <span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">key</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">RunParallel</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">pb</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">PB</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
            <span class="nx">p</span><span class="p">.</span><span class="nf">Produce</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ckafkago</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
                <span class="nx">TopicPartition</span><span class="p">:</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nx">TopicPartition</span><span class="p">{</span><span class="nx">Topic</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">Partition</span><span class="p">:</span> <span class="nx">ckafkago</span><span class="p">.</span><span class="nx">PartitionAny</span><span class="p">},</span>
                <span class="nx">Key</span><span class="p">:</span>            <span class="nx">key</span><span class="p">,</span>
                <span class="nx">Value</span><span class="p">:</span>          <span class="nx">m</span><span class="p">,</span>
            <span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Start a kafka service locally and run the benchmark.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> <span class="nb">test</span> -bench .
goos: linux
goarch: amd64
pkg: kafka_clients
cpu: Intel<span class="o">(</span>R<span class="o">)</span> Core<span class="o">(</span>TM<span class="o">)</span> i7-9700 CPU @ 3.00GHz
BenchmarkSaramaAsync-4                            <span class="m">802070</span>          <span class="m">2267</span> ns/op         <span class="m">294</span> B/op          <span class="m">1</span> allocs/op
BenchmarkSaramaAsyncInParalell-4                 <span class="m">1000000</span>          <span class="m">1913</span> ns/op         <span class="m">294</span> B/op          <span class="m">1</span> allocs/op
BenchmarkKafkaGoAsync-4                          <span class="m">1000000</span>          <span class="m">1208</span> ns/op         <span class="m">376</span> B/op          <span class="m">5</span> allocs/op
BenchmarkKafkaGoAsyncInParalell-4                <span class="m">1768538</span>          703.4 ns/op        <span class="m">368</span> B/op          <span class="m">5</span> allocs/op
BenchmarkConfluentKafkaGoAsync-4                 <span class="m">1000000</span>          <span class="m">3154</span> ns/op         <span class="m">389</span> B/op         <span class="m">10</span> allocs/op
BenchmarkConfluentKafkaGoAsyncInParalell-4        <span class="m">742476</span>          <span class="m">1863</span> ns/op         <span class="m">390</span> B/op         <span class="m">10</span> allocs/op
</code></pre></td></tr></table>
</div>
</div><p>We see that although sarama has an advantage in memory allocation, the overall performance is segmentio/kafka-go optimal.</p>
<h3 id="vi-summary">VI. Summary</h3>
<p>This article compared three mainstream kafka client packages from the Go community: Shopify/sarama, confluent-kafka-go, and segmentio/kafka-go. sarama is the most widely used and the one I have studied for the longest time, but it also has the most pitfalls and is abandoned; confluent-kafka-go is official but based on cgo. go is official but based on cgo, so I have no choice but to give up; finally, we chose segmentio/kafka-go, which has been running online for some time and no major problems have been found so far.</p>
<p>However, the comparison in this article is limited to the scenario of Producer, which is an &ldquo;incomplete&rdquo; introduction. We will add more practical experience in more scenarios later.</p>
<p>The source code in this article can be downloaded from <a href="https://github.com/bigwhite/experiments/blob/master/kafka-clients">here</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/kafka/">Kafka</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/global-images-distribution-network/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A global images distribution network</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/process-creation-in-linux/">
            <span class="next-text nav-default">Process creation in Linux</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
