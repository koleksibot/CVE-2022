<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Build container images in the pipeline using the docker in pod method - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="docker has been criticized in the Kubernetes community for being a CRI, but it&amp;rsquo;s important to understand that CRIs are only part of docker&amp;rsquo;s functionality. There are still many areas that rely heavily on docker for local development testing or CI/CD streamline image builds. For example, docker&amp;rsquo;s official build-push-action is the preferred method for building container images on GitHub. Even docker&amp;rsquo;s rivals podman &#43; skopeo &#43; buildah are using docker" /><meta name="keywords" content="Docker, Pod" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/docker-in-pod/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Build container images in the pipeline using the docker in pod method" />
<meta property="og:description" content="docker has been criticized in the Kubernetes community for being a CRI, but it&rsquo;s important to understand that CRIs are only part of docker&rsquo;s functionality. There are still many areas that rely heavily on docker for local development testing or CI/CD streamline image builds. For example, docker&rsquo;s official build-push-action is the preferred method for building container images on GitHub. Even docker&rsquo;s rivals podman &#43; skopeo &#43; buildah are using docker" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/docker-in-pod/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-18T09:03:05+08:00" />
<meta property="article:modified_time" content="2022-03-18T09:03:05+08:00" />

<meta itemprop="name" content="Build container images in the pipeline using the docker in pod method">
<meta itemprop="description" content="docker has been criticized in the Kubernetes community for being a CRI, but it&rsquo;s important to understand that CRIs are only part of docker&rsquo;s functionality. There are still many areas that rely heavily on docker for local development testing or CI/CD streamline image builds. For example, docker&rsquo;s official build-push-action is the preferred method for building container images on GitHub. Even docker&rsquo;s rivals podman &#43; skopeo &#43; buildah are using docker"><meta itemprop="datePublished" content="2022-03-18T09:03:05+08:00" />
<meta itemprop="dateModified" content="2022-03-18T09:03:05+08:00" />
<meta itemprop="wordCount" content="3169">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Build container images in the pipeline using the docker in pod method"/>
<meta name="twitter:description" content="docker has been criticized in the Kubernetes community for being a CRI, but it&rsquo;s important to understand that CRIs are only part of docker&rsquo;s functionality. There are still many areas that rely heavily on docker for local development testing or CI/CD streamline image builds. For example, docker&rsquo;s official build-push-action is the preferred method for building container images on GitHub. Even docker&rsquo;s rivals podman &#43; skopeo &#43; buildah are using docker"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Build container images in the pipeline using the docker in pod method</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-18 09:03:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3169 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#jenkins-streaming">Jenkins Streaming</a></li>
        <li><a href="#docker-in-pod">docker in pod</a>
          <ul>
            <li><a href="#sidecar">sidecar</a></li>
            <li><a href="#daemonset">daemonset</a></li>
            <li><a href="#deployment">deployment</a></li>
          </ul>
        </li>
        <li><a href="#jenkinsfile">Jenkinsfile</a>
          <ul>
            <li><a href="#sidecare">sidecare</a></li>
            <li><a href="#daemonset-1">daemonset</a></li>
            <li><a href="#deployment-1">deployment</a></li>
          </ul>
        </li>
        <li><a href="#other">Other</a>
          <ul>
            <li><a href="#readinessprobe">readinessProbe</a></li>
            <li><a href="#port-23752376">Port 2375/2376</a></li>
            <li><a href="#dinp-must-be-enabled-with-privileged-true">dinp must be enabled with privileged: true</a></li>
            <li><a href="#rootless-usermax_user_namespaces">rootless user.max_user_namespaces</a></li>
            <li><a href="#only-one-dinp-can-run-on-the-same-node-in-non-rootless-mode">Only one dinp can run on the same node in non-rootless mode</a></li>
            <li><a href="#varlibdocker-does-not-support-shared-storage">/var/lib/docker does not support shared storage</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>docker has been criticized in the Kubernetes community for being a CRI, but it&rsquo;s important to understand that CRIs are only part of docker&rsquo;s functionality. There are still many areas that rely heavily on docker for local development testing or CI/CD streamline image builds. For example, docker&rsquo;s official <a href="https://github.com/docker/build-push-action">build-push-action</a> is the preferred method for building container images on GitHub. Even docker&rsquo;s rivals <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a> are using docker to build their own container images <a href="https://github.com/containers/buildah/blob/main/.github/workflows/multi-arch-build.yaml">multi-arch-build.yaml</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">multi</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">multi-arch image build</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">REPONAME</span><span class="p">:</span><span class="w"> </span><span class="l">buildah </span><span class="w"> </span><span class="c"># No easy way to parse this out of $GITHUB_REPOSITORY</span><span class="w">
</span><span class="w">      </span><span class="c"># Server/namespace value used to format FQIN</span><span class="w">
</span><span class="w">      </span><span class="nt">REPONAME_QUAY_REGISTRY</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/buildah</span><span class="w">
</span><span class="w">      </span><span class="nt">CONTAINERS_QUAY_REGISTRY</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/containers</span><span class="w">
</span><span class="w">      </span><span class="c"># list of architectures for build</span><span class="w">
</span><span class="w">      </span><span class="nt">PLATFORMS</span><span class="p">:</span><span class="w"> </span><span class="l">linux/amd64,linux/s390x,linux/ppc64le,linux/arm64</span><span class="w">
</span><span class="w">      </span><span class="c"># Command to execute in container to obtain project version number</span><span class="w">
</span><span class="w">      </span><span class="nt">VERSION_CMD</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;buildah --version&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># build several images (upstream, testing, stable) in parallel</span><span class="w">
</span><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># By default, failure of one matrix item cancels all others</span><span class="w">
</span><span class="w">      </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># Builds are located under contrib/&lt;reponame&gt;image/&lt;source&gt; directory</span><span class="w">
</span><span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">upstream</span><span class="w">
</span><span class="w">          </span>- <span class="l">testing</span><span class="w">
</span><span class="w">          </span>- <span class="l">stable</span><span class="w">
</span><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span><span class="w">    </span><span class="c"># internal registry caches build for inspection before push</span><span class="w">
</span><span class="w">    </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/libpod/registry:2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="m">5000</span><span class="p">:</span><span class="m">5000</span><span class="w">
</span><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout</span><span class="w">
</span><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up QEMU</span><span class="w">
</span><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-qemu-action@v1</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up Docker Buildx</span><span class="w">
</span><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-buildx-action@v1</span><span class="w">
</span><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">driver-opts</span><span class="p">:</span><span class="w"> </span><span class="l">network=host</span><span class="w">
</span><span class="w">          </span><span class="nt">install</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build and locally push image</span><span class="w">
</span><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/build-push-action@v2</span><span class="w">
</span><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">contrib/${{ env.REPONAME }}image/${{ matrix.source }}</span><span class="w">
</span><span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">./contrib/${{ env.REPONAME }}image/${{ matrix.source }}/Dockerfile</span><span class="w">
</span><span class="w">          </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.PLATFORMS }}</span><span class="w">
</span><span class="w">          </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:5000/${{ env.REPONAME }}/${{ matrix.source }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="jenkins-streaming">Jenkins Streaming</h2>
<p>Our CI/CD pipeline uses Jenkins + Kubernetes plugin to dynamically create Pods as Jenkins Slave on Kubernetes.</p>
<p>In the case of using docker as the container, the Jenkins Slave Pod mounts the <code>/var/run/docker.sock</code> file from the host to the pod container by way of hostPath.</p>
<p>The docker CLI inside the container can then communicate with the host&rsquo;s docker daemon via this sock, so that commands such as docker build and push can be used seamlessly inside the pod container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">// Kubernetes pod template to run.</span><span class="w">
</span><span class="w"></span><span class="l">podTemplate(</span><span class="w">
</span><span class="w">    </span><span class="nt">cloud</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;default&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME,</span><span class="w">
</span><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME,</span><span class="w">
</span><span class="w">    </span><span class="nt">yaml</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;&#34;
</span><span class="s2">apiVersion: v1
</span><span class="s2">kind: Pod
</span><span class="s2">spec:
</span><span class="s2">  containers:
</span><span class="s2">  - name: debian
</span><span class="s2">    image: &#34;</span><span class="l">${JENKINS_POD_IMAGE_NAME}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dockersock</span><span class="w">
</span><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/docker.sock</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">jnlp</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;\$(JENKINS_SECRET)&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;\$(JENKINS_NAME)&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;jenkins/inbound-agent:4.3-4-alpine&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dockersock</span><span class="w">
</span><span class="w">      </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/docker.sock</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;&#34;</span><span class="l">&#34;,</span><span class="w">
</span><span class="w"></span><span class="l">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>When docker is no longer used as the container runtime for Kubernetes, there is no longer a docker daemon on the host and mounting <code>/var/run/docker.sock</code> will not work, so we need to find some alternative.</p>
<p>There are two options that I can think of: option 1 is to replace docker and use another image builder like <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a>.</p>
<p>Shaowen Chen blogger in &ldquo;<a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html">Kubernetes-based Jenkins service can also go to Docker</a>&rdquo; talks about this solution in detail. But our Makefile has some docker buildKit feature parameters sewn into it that can&rsquo;t be simply and brutally replaced by <code>alias docker=podman</code> aliases 😂.</p>
<p>For example, podman build images do not support <code>--output type=local,dest=path</code> <a href="https://github.com/containers/buildah/issues/3789">Support custom build outputs #3789</a> This feature. It seems that podman still has a long way to go to completely replace docker&rsquo;s big brother status, especially since podman has not solved the awkward problem of building its own images from docker.</p>
<p>Option 2 is to continue using docker as the image builder. Just because the docker daemon is gone from the cluster nodes does not mean that docker cannot be used in the Kubernetes cluster. Instead of deploying docker as systemd on the node, we can run docker as a pod in the kubernetes cluster. Then we can continue to use docker seamlessly by accessing the TCP port of docker through the service IP or Node IP. So the dinp (docker-in-pod) nesting operation is based on dind (docker-in-docker), which is essentially the same thing, except that the deployment and access methods are different.</p>
<p>Comparing these two options, option 1 is a bit of a speculative replacement for docker via <code>alias docker=podman</code>, and should rarely be used in a formal production pipeline unless your Makefile or image build script does not rely on docker&rsquo;s feature parameters to be fully podman compatible. Option 2 is more stable and reliable, it just replaces the docker daemon on the host node with a Pod in the cluster, and the user only needs to modify the way to access docker, i.e. <code>DOCKER_HOST</code> environment variable. Therefore, we choose option 2 to introduce several ways to deploy and use dind/dinp in a K8s cluster.</p>
<h2 id="docker-in-pod">docker in pod</h2>
<p>Unlike docker in docker, docker in pod doesn&rsquo;t care what the underlying container runtime is, it can be either docker or containerd. running and using docker inside a pod personally summarized the following three more suitable ways, you can choose a suitable one according to different scenarios.</p>
<h3 id="sidecar">sidecar</h3>
<p>Run the dind container as a <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#using-pods">sidecar container</a> and the main container accesses docker&rsquo;s 2375/2376 TCP port by way of localhost. port. The advantage of this solution is that if multiple Pods are created, each Pod is independent of each other, and the dind container will not be shared to other Pods, so the isolation is better. The disadvantage is also obvious, each Pod with a dind container takes up more system resources, which is a bit too big and too small.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-sidecar</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker:20.10.12</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sleep&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;3600&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_TLS_VERIFY</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_HOST</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">tcp://localhost:2375</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dind</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker:20.10.12-dind-rootless</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;--insecure-registry=$(REGISTRY)&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 如果镜像仓库域名为自签证书，需要在这里配置 insecure-registry</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">REGISTRY</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">hub.k8s.li</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_TLS_CERTDIR</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_HOST</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">tcp://localhost:2375</span><span class="w">
</span><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># 使用 docker info 命令就绪探针来确保 dind 容器正常启动 </span><span class="w">
</span><span class="w">    </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;docker&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;info&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="daemonset">daemonset</h3>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">daemonset</a> runs a dind Pod on each Node of the cluster and uses the hostNetwork method to expose 2375/2376 TCP ports. Users can access the 2375/2376 TCP port of the host through <code>status.hostIP</code> to communicate with docker, and the dind container&rsquo;s <code>/var/lib/docker</code> data is stored persistently through the hostPath mount, which can cache some data to improve the efficiency of image building.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-daemonset</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-daemonset</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-daemonset</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dind</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker:20.10.12-dind</span><span class="w">
</span><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;--insecure-registry=$(REGISTRY)&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">REGISTRY</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">hub.k8s.li</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_TLS_CERTDIR</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">docker-storage</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w">  </span><span class="l">/var/lib/docker</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;docker&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;info&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;docker&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;info&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">docker-storage</span><span class="w">
</span><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="deployment">deployment</h3>
<p>Deployment is the deployment of one or more dind Pods in a cluster. users access docker ports 2375/2376 via service IP, if the dind containers are started in a non-TLS way. Using service IP to access docker is more secure than using host IP in the previous daemonset.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dind</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker:20.10.12-dind</span><span class="w">
</span><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;--insecure-registry=$(REGISTRY)&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">REGISTRY</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">hub.k8s.li</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_TLS_CERTDIR</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DOCKER_HOST</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">tcp://localhost:2375</span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">docker-storage</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w">  </span><span class="l">/var/lib/docker</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;docker&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;info&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;docker&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;info&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">docker-storage</span><span class="w">
</span><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/docker</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 定义 service name，使用者通过它来访问 docker 的 2375 端口</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dinp-deployment</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2375</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">2375</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="jenkinsfile">Jenkinsfile</h2>
<p>In the Jenkins podTemplate template, you can choose from several different templates depending on the dinp deployment method.</p>
<h3 id="sidecare">sidecare</h3>
<p>Pod containers share the same network stack, so you can access the TCP port of docker through localhost. It is also best to start the dind container in rootless mode, so that you can run multiple instances of this pod on the same node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">def <span class="nv">JOB_NAME</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.JOB_BASE_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">BUILD_NUMBER</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">POD_NAME</span> <span class="o">=</span> <span class="s2">&#34;jenkins-</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">K8S_CLUSTER</span> <span class="o">=</span> params.k8s_cluster ?: kubernetes

// Kubernetes pod template to run.
podTemplate<span class="o">(</span>
    cloud: K8S_CLUSTER,
    namespace: <span class="s2">&#34;default&#34;</span>,
    name: POD_NAME,
    label: POD_NAME,
    yaml: <span class="s2">&#34;&#34;&#34;
</span><span class="s2">apiVersion: v1
</span><span class="s2">kind: Pod
</span><span class="s2">spec:
</span><span class="s2">  containers:
</span><span class="s2">  - name: runner
</span><span class="s2">    image: golang:1.17-buster
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">    tty: true
</span><span class="s2">    env:
</span><span class="s2">    - name: DOCKER_HOST
</span><span class="s2">      vaule: tcp://localhost:2375
</span><span class="s2">    - name: DOCKER_TLS_VERIFY
</span><span class="s2">      value: &#34;&#34;
</span><span class="s2">  - name: jnlp
</span><span class="s2">    args: [&#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_SECRET<span class="o">)</span><span class="s2">&#34;, &#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_NAME<span class="o">)</span><span class="s2">&#34;]
</span><span class="s2">    image: &#34;</span>jenkins/inbound-agent:4.11.2-4-alpine<span class="s2">&#34;
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">  - name: dind
</span><span class="s2">    image: docker:20.10.12-dind-rootless
</span><span class="s2">    args: [&#34;</span>--insecure-registry<span class="o">=</span><span class="k">$(</span>REGISTRY<span class="k">)</span><span class="s2">&#34;]
</span><span class="s2">    env:
</span><span class="s2">    - name: REGISTRY
</span><span class="s2">      value: hub.k8s.li
</span><span class="s2">    - name: DOCKER_TLS_CERTDIR
</span><span class="s2">      value: &#34;&#34;
</span><span class="s2">    securityContext:
</span><span class="s2">      privileged: true
</span><span class="s2">    tty: true
</span><span class="s2">    readinessProbe:
</span><span class="s2">      exec:
</span><span class="s2">        command: [&#34;</span>docker<span class="s2">&#34;, &#34;</span>info<span class="s2">&#34;]
</span><span class="s2">      initialDelaySeconds: 10
</span><span class="s2">      failureThreshold: 6
</span><span class="s2">&#34;&#34;&#34;</span>,
<span class="o">)</span> <span class="o">{</span>
    node<span class="o">(</span>POD_NAME<span class="o">)</span> <span class="o">{</span>
        container<span class="o">(</span><span class="s2">&#34;runner&#34;</span><span class="o">)</span> <span class="o">{</span>
            stage<span class="o">(</span><span class="s2">&#34;Checkout&#34;</span><span class="o">)</span> <span class="o">{</span>
                retry<span class="o">(</span>10<span class="o">)</span> <span class="o">{</span>
                    checkout<span class="o">([</span>
                        <span class="nv">$class</span>: <span class="s1">&#39;GitSCM&#39;</span>,
                        branches: scm.branches,
                        doGenerateSubmoduleConfigurations: scm.doGenerateSubmoduleConfigurations,
                        extensions: <span class="o">[[</span><span class="nv">$class</span>: <span class="s1">&#39;CloneOption&#39;</span>, noTags: false, shallow: false, depth: 0, reference: <span class="s1">&#39;&#39;</span><span class="o">]]</span>,
                        userRemoteConfigs: scm.userRemoteConfigs,
                    <span class="o">])</span>
                <span class="o">}</span>
            <span class="o">}</span>
            stage<span class="o">(</span><span class="s2">&#34;Build&#34;</span><span class="o">)</span> <span class="o">{</span>
                sh <span class="s2">&#34;&#34;&#34;
</span><span class="s2">                # make docker-build
</span><span class="s2">                docker build -t app:v1.0.0-alpha.1 .
</span><span class="s2">                &#34;&#34;&#34;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="daemonset-1">daemonset</h3>
<p>Since you are using hostNetwork, you can access the TCP port of docker through the host IP, but you can also access it through the service name like deployment, so I won&rsquo;t demonstrate it here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">def <span class="nv">JOB_NAME</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.JOB_BASE_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">BUILD_NUMBER</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">POD_NAME</span> <span class="o">=</span> <span class="s2">&#34;jenkins-</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">K8S_CLUSTER</span> <span class="o">=</span> params.k8s_cluster ?: kubernetes

// Kubernetes pod template to run.
podTemplate<span class="o">(</span>
    cloud: K8S_CLUSTER,
    namespace: <span class="s2">&#34;default&#34;</span>,
    name: POD_NAME,
    label: POD_NAME,
    yaml: <span class="s2">&#34;&#34;&#34;
</span><span class="s2">apiVersion: v1
</span><span class="s2">kind: Pod
</span><span class="s2">spec:
</span><span class="s2">  containers:
</span><span class="s2">  - name: runner
</span><span class="s2">    image: golang:1.17-buster
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">    tty: true
</span><span class="s2">    env:
</span><span class="s2">    - name: DOCKER_HOST
</span><span class="s2">      valueFrom:
</span><span class="s2">        fieldRef:
</span><span class="s2">          fieldPath: status.hostIP
</span><span class="s2">    - name: DOCKER_TLS_VERIFY
</span><span class="s2">      value: &#34;&#34;
</span><span class="s2">  - name: jnlp
</span><span class="s2">    args: [&#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_SECRET<span class="o">)</span><span class="s2">&#34;, &#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_NAME<span class="o">)</span><span class="s2">&#34;]
</span><span class="s2">    image: &#34;</span>jenkins/inbound-agent:4.11.2-4-alpine<span class="s2">&#34;
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">&#34;&#34;&#34;</span>,
<span class="o">)</span> <span class="o">{</span>
    node<span class="o">(</span>POD_NAME<span class="o">)</span> <span class="o">{</span>
        container<span class="o">(</span><span class="s2">&#34;runner&#34;</span><span class="o">)</span> <span class="o">{</span>
            stage<span class="o">(</span><span class="s2">&#34;Checkout&#34;</span><span class="o">)</span> <span class="o">{</span>
                retry<span class="o">(</span>10<span class="o">)</span> <span class="o">{</span>
                    checkout<span class="o">([</span>
                        <span class="nv">$class</span>: <span class="s1">&#39;GitSCM&#39;</span>,
                        branches: scm.branches,
                        doGenerateSubmoduleConfigurations: scm.doGenerateSubmoduleConfigurations,
                        extensions: <span class="o">[[</span><span class="nv">$class</span>: <span class="s1">&#39;CloneOption&#39;</span>, noTags: false, shallow: false, depth: 0, reference: <span class="s1">&#39;&#39;</span><span class="o">]]</span>,
                        userRemoteConfigs: scm.userRemoteConfigs,
                    <span class="o">])</span>
                <span class="o">}</span>
            <span class="o">}</span>
            stage<span class="o">(</span><span class="s2">&#34;Build&#34;</span><span class="o">)</span> <span class="o">{</span>
                sh <span class="s2">&#34;&#34;&#34;
</span><span class="s2">                # make docker-build
</span><span class="s2">                docker build -t app:v1.0.0-alpha.1 .
</span><span class="s2">                &#34;&#34;&#34;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="deployment-1">deployment</h3>
<p>Access to docker by service name, all other parameters are the same as daemonset.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">def <span class="nv">JOB_NAME</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.JOB_BASE_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">BUILD_NUMBER</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">env</span><span class="p">.BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">POD_NAME</span> <span class="o">=</span> <span class="s2">&#34;jenkins-</span><span class="si">${</span><span class="nv">JOB_NAME</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">BUILD_NUMBER</span><span class="si">}</span><span class="s2">&#34;</span>
def <span class="nv">K8S_CLUSTER</span> <span class="o">=</span> params.k8s_cluster ?: kubernetes

// Kubernetes pod template to run.
podTemplate<span class="o">(</span>
    cloud: K8S_CLUSTER,
    namespace: <span class="s2">&#34;default&#34;</span>,
    name: POD_NAME,
    label: POD_NAME,
    yaml: <span class="s2">&#34;&#34;&#34;
</span><span class="s2">apiVersion: v1
</span><span class="s2">kind: Pod
</span><span class="s2">spec:
</span><span class="s2">  containers:
</span><span class="s2">  - name: runner
</span><span class="s2">    image: golang:1.17-buster
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">    tty: true
</span><span class="s2">    env:
</span><span class="s2">    - name: DOCKER_HOST
</span><span class="s2">       value: tcp://dinp-deployment:2375
</span><span class="s2">    - name: DOCKER_TLS_VERIFY
</span><span class="s2">      value: &#34;&#34;
</span><span class="s2">  - name: jnlp
</span><span class="s2">    args: [&#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_SECRET<span class="o">)</span><span class="s2">&#34;, &#34;</span><span class="se">\$</span><span class="o">(</span>JENKINS_NAME<span class="o">)</span><span class="s2">&#34;]
</span><span class="s2">    image: &#34;</span>jenkins/inbound-agent:4.11.2-4-alpine<span class="s2">&#34;
</span><span class="s2">    imagePullPolicy: IfNotPresent
</span><span class="s2">&#34;&#34;&#34;</span>,
<span class="o">)</span> <span class="o">{</span>
    node<span class="o">(</span>POD_NAME<span class="o">)</span> <span class="o">{</span>
        container<span class="o">(</span><span class="s2">&#34;runner&#34;</span><span class="o">)</span> <span class="o">{</span>
            stage<span class="o">(</span><span class="s2">&#34;Checkout&#34;</span><span class="o">)</span> <span class="o">{</span>
                retry<span class="o">(</span>10<span class="o">)</span> <span class="o">{</span>
                    checkout<span class="o">([</span>
                        <span class="nv">$class</span>: <span class="s1">&#39;GitSCM&#39;</span>,
                        branches: scm.branches,
                        doGenerateSubmoduleConfigurations: scm.doGenerateSubmoduleConfigurations,
                        extensions: <span class="o">[[</span><span class="nv">$class</span>: <span class="s1">&#39;CloneOption&#39;</span>, noTags: false, shallow: false, depth: 0, reference: <span class="s1">&#39;&#39;</span><span class="o">]]</span>,
                        userRemoteConfigs: scm.userRemoteConfigs,
                    <span class="o">])</span>
                <span class="o">}</span>
            <span class="o">}</span>
            stage<span class="o">(</span><span class="s2">&#34;Build&#34;</span><span class="o">)</span> <span class="o">{</span>
                sh <span class="s2">&#34;&#34;&#34;
</span><span class="s2">                # make docker-build
</span><span class="s2">                docker build -t app:v1.0.0-alpha.1 .
</span><span class="s2">                &#34;&#34;&#34;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="other">Other</h2>
<h3 id="readinessprobe">readinessProbe</h3>
<p>There are times when dind does not start properly, so be sure to set the readiness probe to ensure that the diind container will start properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">readinessProbe:
  exec:
    command: <span class="o">[</span><span class="s2">&#34;docker&#34;</span>, <span class="s2">&#34;info&#34;</span><span class="o">]</span>
  initialDelaySeconds: <span class="m">10</span>
  failureThreshold: <span class="m">6</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="port-23752376">Port 2375/2376</h3>
<p>If you set the environment variable <code>DOCKER_TLS_CERTDIR</code> to null, it will start in non-TLS mode and listen on port 2375, which will not verify TLS certificates. If you use port 2376, you will need a persistent store to share the docker-generated certificates with the client, which is a bit tricky. So if you don&rsquo;t want to mess around with it, you should use 2375 non-TLS 😂.</p>
<h3 id="dinp-must-be-enabled-with-privileged-true">dinp must be enabled with privileged: true</h3>
<p>If you run docker as a pod, whether it is in rootless mode or not, you have to set <code>privileged: true</code> in the <code>securityContext</code> of the pod container, otherwise the pod will not start properly. And rootless mode also has some limitations, it needs to rely on some kernel features, it&rsquo;s only experimental at the moment, you should try not to use rootless features without special needs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl logs -f dinp-sidecar</span>
error: a container name must be specified <span class="k">for</span> pod dinp-sidecar, choose one of: <span class="o">[</span>debug dind<span class="o">]</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl logs -f dinp-sidecar -c dind</span>
Device <span class="s2">&#34;ip_tables&#34;</span> does not exist.
ip_tables              <span class="m">27126</span>  <span class="m">4</span> iptable_raw,iptable_mangle,iptable_filter,iptable_nat
modprobe: can<span class="s1">&#39;t change directory to &#39;</span>/lib/modules<span class="err">&#39;</span>: No such file or directory
WARN<span class="o">[</span>0000<span class="o">]</span> failed to mount sysfs, falling back to read-only mount: operation not permitted
WARN<span class="o">[</span>0000<span class="o">]</span> failed to mount sysfs: operation not permitted
open: No such file or directory
<span class="o">[</span>rootlesskit:child <span class="o">]</span> error: executing <span class="o">[[</span>ip tuntap add name tap0 mode tap<span class="o">]</span> <span class="o">[</span>ip link <span class="nb">set</span> tap0 address 02:50:00:00:00:01<span class="o">]]</span>: <span class="nb">exit</span> status <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rootless-usermax_user_namespaces">rootless user.max_user_namespaces</h3>
<p>Rootless mode depends on some kernel parameters <a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a>. On CentOS 7.9, there is a <a href="https://github.com/docker-library/docker/issues/201">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces</a> problem. The solution is to modify the <code>user.max_user_namespaces=28633</code> kernel parameter.</p>
<blockquote>
<p>Add user.max_user_namespaces=28633 to /etc/sysctl.conf (or /etc/sysctl.d) and run sudo sysctl -p</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl get pod -w</span>
NAME                              READY   STATUS   RESTARTS     AGE
dinp-deployment-cf488bfd8-g8vxx   0/1     CrashLoopBackOff   <span class="m">1</span> <span class="o">(</span>2s ago<span class="o">)</span>   4s
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl logs -f dinp-deployment-cf488bfd8-m5cms</span>
Device <span class="s2">&#34;ip_tables&#34;</span> does not exist.
ip_tables              <span class="m">27126</span>  <span class="m">5</span> iptable_raw,iptable_mangle,iptable_filter,iptable_nat
modprobe: can<span class="s1">&#39;t change directory to &#39;</span>/lib/modules<span class="s1">&#39;: No such file or directory
</span><span class="s1">error: attempting to run rootless dockerd but need &#39;</span>user.max_user_namespaces<span class="err">&#39;</span> <span class="o">(</span>/proc/sys/user/max_user_namespaces<span class="o">)</span> <span class="nb">set</span> to a sufficiently large value
</code></pre></td></tr></table>
</div>
</div><h3 id="only-one-dinp-can-run-on-the-same-node-in-non-rootless-mode">Only one dinp can run on the same node in non-rootless mode</h3>
<p>If you deploy dinp using deployment, you can only have one dinp Pod on a node, and any extra Pods will not start properly. So if you want to run more than one dinp Pod, it is recommended to run it in daemonset mode.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl get deploy</span>
NAME              READY   UP-TO-DATE   AVAILABLE   AGE
dinp-deployment   1/3     <span class="m">3</span>            <span class="m">1</span>           4m16s
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl get pod -w</span>
NAME                               READY   STATUS    RESTARTS      AGE
dinp-deployment-547bd9bb6d-2mn6c   0/1     Running   <span class="m">3</span> <span class="o">(</span>61s ago<span class="o">)</span>   4m9s
dinp-deployment-547bd9bb6d-8ht8l   1/1     Running   <span class="m">0</span>             4m9s
dinp-deployment-547bd9bb6d-x5vpv   0/1     Running   <span class="m">3</span> <span class="o">(</span>61s ago<span class="o">)</span>   4m9s
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># kubectl logs -f dinp-deployment-547bd9bb6d-2mn6c</span>
INFO<span class="o">[</span>2022-03-14T14:14:10.905652548Z<span class="o">]</span> Starting up
WARN<span class="o">[</span>2022-03-14T14:14:10.906986721Z<span class="o">]</span> could not change group /var/run/docker.sock to docker: group docker not found
WARN<span class="o">[</span>2022-03-14T14:14:10.907249071Z<span class="o">]</span> Binding to IP address without --tlsverify is insecure and gives root access on this machine to everyone who has access to your network.  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
WARN<span class="o">[</span>2022-03-14T14:14:10.907269951Z<span class="o">]</span> Binding to an IP address, even on localhost, can also give access to scripts run in a browser. Be safe out there!  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
WARN<span class="o">[</span>2022-03-14T14:14:11.908057635Z<span class="o">]</span> Binding to an IP address without --tlsverify is deprecated. Startup is intentionally being slowed down to show this message  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
WARN<span class="o">[</span>2022-03-14T14:14:11.908103696Z<span class="o">]</span> Please consider generating tls certificates with client validation to prevent exposing unauthenticated root access to your network  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
WARN<span class="o">[</span>2022-03-14T14:14:11.908114541Z<span class="o">]</span> You can override this by explicitly specifying <span class="s1">&#39;--tls=false&#39;</span> or <span class="s1">&#39;--tlsverify=false&#39;</span>  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
WARN<span class="o">[</span>2022-03-14T14:14:11.908125477Z<span class="o">]</span> Support <span class="k">for</span> listening on TCP without authentication or explicit intent to run without authentication will be removed in the next release  <span class="nv">host</span><span class="o">=</span><span class="s2">&#34;tcp://0.0.0.0:2375&#34;</span>
INFO<span class="o">[</span>2022-03-14T14:14:26.914587276Z<span class="o">]</span> libcontainerd: started new containerd process  <span class="nv">pid</span><span class="o">=</span><span class="m">41</span>
INFO<span class="o">[</span>2022-03-14T14:14:26.914697125Z<span class="o">]</span> parsed scheme: <span class="s2">&#34;unix&#34;</span>                         <span class="nv">module</span><span class="o">=</span>grpc
INFO<span class="o">[</span>2022-03-14T14:14:26.914710376Z<span class="o">]</span> scheme <span class="s2">&#34;unix&#34;</span> not registered, fallback to default scheme  <span class="nv">module</span><span class="o">=</span>grpc
INFO<span class="o">[</span>2022-03-14T14:14:26.914785052Z<span class="o">]</span> ccResolverWrapper: sending update to cc: <span class="o">{[{</span>unix:///var/run/docker/containerd/containerd.sock  &lt;nil&gt; <span class="m">0</span> &lt;nil&gt;<span class="o">}]</span> &lt;nil&gt; &lt;nil&gt;<span class="o">}</span>  <span class="nv">module</span><span class="o">=</span>grpc
INFO<span class="o">[</span>2022-03-14T14:14:26.914796039Z<span class="o">]</span> ClientConn switching balancer to <span class="s2">&#34;pick_first&#34;</span>  <span class="nv">module</span><span class="o">=</span>grpc
INFO<span class="o">[</span>2022-03-14T14:14:26.930311832Z<span class="o">]</span> starting containerd                           <span class="nv">revision</span><span class="o">=</span>7b11cfaabd73bb80907dd23182b9347b4245eb5d <span class="nv">version</span><span class="o">=</span>v1.4.12
INFO<span class="o">[</span>2022-03-14T14:14:26.953641900Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.content.v1.content&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.content.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.953721059Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.aufs&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960295816Z<span class="o">]</span> skip loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.aufs&#34;</span>...  <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;aufs is not supported (modprobe aufs failed: exit status 1 \&#34;ip: can&#39;t find device &#39;aufs&#39;\\nmodprobe: can&#39;t change directory to &#39;/lib/modules&#39;: No such file or directory\\n\&#34;): skip plugin&#34;</span> <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960329840Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.btrfs&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960524514Z<span class="o">]</span> skip loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.btrfs&#34;</span>...  <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;path /var/lib/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs (xfs) must be a btrfs filesystem to be used with the btrfs snapshotter: skip plugin&#34;</span> <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960537441Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.devmapper&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
WARN<span class="o">[</span>2022-03-14T14:14:26.960558843Z<span class="o">]</span> failed to load plugin io.containerd.snapshotter.v1.devmapper  <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;devmapper not configured&#34;</span>
INFO<span class="o">[</span>2022-03-14T14:14:26.960569516Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.native&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960593224Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.overlayfs&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960678728Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.zfs&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960814844Z<span class="o">]</span> skip loading plugin <span class="s2">&#34;io.containerd.snapshotter.v1.zfs&#34;</span>...  <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;path /var/lib/docker/containerd/daemon/io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin&#34;</span> <span class="nv">type</span><span class="o">=</span>io.containerd.snapshotter.v1
INFO<span class="o">[</span>2022-03-14T14:14:26.960827133Z<span class="o">]</span> loading plugin <span class="s2">&#34;io.containerd.metadata.v1.bolt&#34;</span>...  <span class="nv">type</span><span class="o">=</span>io.containerd.metadata.v1
WARN<span class="o">[</span>2022-03-14T14:14:26.960839223Z<span class="o">]</span> could not use snapshotter devmapper in metadata plugin  <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;devmapper not configured&#34;</span>
INFO<span class="o">[</span>2022-03-14T14:14:26.960848698Z<span class="o">]</span> metadata content store policy <span class="nb">set</span>             <span class="nv">policy</span><span class="o">=</span>shared
WARN<span class="o">[</span>2022-03-14T14:14:27.915528371Z<span class="o">]</span> grpc: addrConn.createTransport failed to connect to <span class="o">{</span>unix:///var/run/docker/containerd/containerd.sock  &lt;nil&gt; <span class="m">0</span> &lt;nil&gt;<span class="o">}</span>. Err :connection error: <span class="nv">desc</span> <span class="o">=</span> <span class="s2">&#34;transport: error while dialing: dial unix:///var/run/docker/containerd/containerd.sock: timeout&#34;</span>. Reconnecting...  <span class="nv">module</span><span class="o">=</span>grpc
WARN<span class="o">[</span>2022-03-14T14:14:30.722257725Z<span class="o">]</span> grpc: addrConn.createTransport failed to connect to <span class="o">{</span>unix:///var/run/docker/containerd/containerd.sock  &lt;nil&gt; <span class="m">0</span> &lt;nil&gt;<span class="o">}</span>. Err :connection error: <span class="nv">desc</span> <span class="o">=</span> <span class="s2">&#34;transport: error while dialing: dial unix:///var/run/docker/containerd/containerd.sock: timeout&#34;</span>. Reconnecting...  <span class="nv">module</span><span class="o">=</span>grpc
WARN<span class="o">[</span>2022-03-14T14:14:35.549453706Z<span class="o">]</span> grpc: addrConn.createTransport failed to connect to <span class="o">{</span>unix:///var/run/docker/containerd/containerd.sock  &lt;nil&gt; <span class="m">0</span> &lt;nil&gt;<span class="o">}</span>. Err :connection error: <span class="nv">desc</span> <span class="o">=</span> <span class="s2">&#34;transport: error while dialing: dial unix:///var/run/docker/containerd/containerd.sock: timeout&#34;</span>. Reconnecting...  <span class="nv">module</span><span class="o">=</span>grpc
WARN<span class="o">[</span>2022-03-14T14:14:41.759010407Z<span class="o">]</span> grpc: addrConn.createTransport failed to connect to <span class="o">{</span>unix:///var/run/docker/containerd/containerd.sock  &lt;nil&gt; <span class="m">0</span> &lt;nil&gt;<span class="o">}</span>. Err :connection error: <span class="nv">desc</span> <span class="o">=</span> <span class="s2">&#34;transport: error while dialing: dial unix:///var/run/docker/containerd/containerd.sock: timeout&#34;</span>. Reconnecting...  <span class="nv">module</span><span class="o">=</span>grpc
failed to start containerd: timeout waiting <span class="k">for</span> containerd to start
</code></pre></td></tr></table>
</div>
</div><h3 id="varlibdocker-does-not-support-shared-storage">/var/lib/docker does not support shared storage</h3>
<p>Chen Shaowen blogger has mentioned in &ldquo;<a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html">Can /var/lib/docker mount remote storage</a>&rdquo; that docker currently does not support mounting <code>/var/lib/docker</code> on remote storage, so it is recommended to use hostPath to store docker persistent storage data.</p>
<blockquote>
<p>The Docker version used for this test is 20.10.6, and it is not possible to mount <code>/var/lib/docker</code> for use with remote storage. The main reason is that the container implementation relies on kernel capabilities (xttrs), which are not available on remote storage like NFS Server. If Device Mapper is used for mapping, it is possible to use disk mounts, but only for migration and not for sharing.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">INFO<span class="o">[</span>2022-03-13T13:43:08.750810130Z<span class="o">]</span> ClientConn switching balancer to <span class="s2">&#34;pick_first&#34;</span>  <span class="nv">module</span><span class="o">=</span>grpc
ERRO<span class="o">[</span>2022-03-13T13:43:08.781932359Z<span class="o">]</span> failed to mount overlay: invalid argument     storage-driver<span class="o">=</span>overlay2
ERRO<span class="o">[</span>2022-03-13T13:43:08.782078828Z<span class="o">]</span> exec: <span class="s2">&#34;fuse-overlayfs&#34;</span>: executable file not found in <span class="nv">$PATH</span>  storage-driver<span class="o">=</span>fuse-overlayfs
ERRO<span class="o">[</span>2022-03-13T13:43:08.793311119Z<span class="o">]</span> AUFS was not found in /proc/filesystems       storage-driver<span class="o">=</span>aufs
ERRO<span class="o">[</span>2022-03-13T13:43:08.813505621Z<span class="o">]</span> failed to mount overlay: invalid argument     storage-driver<span class="o">=</span>overlay
ERRO<span class="o">[</span>2022-03-13T13:43:08.813529990Z<span class="o">]</span> Failed to built-in GetDriver graph devicemapper /var/lib/docker
INFO<span class="o">[</span>2022-03-13T13:43:08.897769363Z<span class="o">]</span> Loading containers: start.
WARN<span class="o">[</span>2022-03-13T13:43:08.919252078Z<span class="o">]</span> Running modprobe bridge br_netfilter failed with message: ip: can<span class="s1">&#39;t find device &#39;</span>bridge<span class="err">&#39;</span>
<span class="o">[</span>root@localhost dinp<span class="o">]</span><span class="c1"># kubectl exec -it dinp-sidecar -c debug sh</span>
/ <span class="c1"># docker pull alpine</span>
Using default tag: latest
Error response from daemon: error creating temporary lease: file resize error: truncate /var/lib/docker/containerd/daemon/io.containerd.metadata.v1.bolt/meta.db: bad file descriptor: unknown
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/ripgrep/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Replace grep with ripgrep</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/redis-multi-threaded-network-model/">
            <span class="next-text nav-default">Redis Multi-Threaded Network Model</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
