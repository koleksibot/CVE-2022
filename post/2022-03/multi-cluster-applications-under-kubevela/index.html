<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Multi-cluster applications under Kubevela - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article discusses the application of Kubevela in multiple clusters." /><meta name="keywords" content="Kubevela Cluster, Applications" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/multi-cluster-applications-under-kubevela/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Multi-cluster applications under Kubevela" />
<meta property="og:description" content="This article discusses the application of Kubevela in multiple clusters." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/multi-cluster-applications-under-kubevela/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-20T11:07:29+08:00" />
<meta property="article:modified_time" content="2022-03-20T11:07:29+08:00" />

<meta itemprop="name" content="Multi-cluster applications under Kubevela">
<meta itemprop="description" content="This article discusses the application of Kubevela in multiple clusters."><meta itemprop="datePublished" content="2022-03-20T11:07:29+08:00" />
<meta itemprop="dateModified" content="2022-03-20T11:07:29+08:00" />
<meta itemprop="wordCount" content="1735">
<meta itemprop="keywords" content="kubevela," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Multi-cluster applications under Kubevela"/>
<meta name="twitter:description" content="This article discusses the application of Kubevela in multiple clusters."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Multi-cluster applications under Kubevela</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-20 11:07:29 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1735 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-what-kubevela-can-solve">1. What Kubevela can solve</a></li>
        <li><a href="#2-challenges-for-applications-under-multiple-clusters">2. Challenges for applications under multiple clusters</a></li>
        <li><a href="#3-multi-cluster-application-under-appdeployment">3. Multi-Cluster Application under AppDeployment</a></li>
        <li><a href="#4-multi-cluster-applications-under-workflow">4 Multi-Cluster Applications under Workflow</a>
          <ul>
            <li><a href="#41-configuring-open-cluster-management-ocm">4.1 Configuring Open Cluster Management (OCM)</a></li>
            <li><a href="#42-create-a-new-workflowstepdefinition-to-describe-cross-cluster-resources">4.2 Create a new WorkflowStepDefinition to describe cross-cluster resources</a></li>
            <li><a href="#43-creating-an-application-for-distribution">4.3 Creating an application for distribution</a></li>
            <li><a href="#44-possible-issues-to-be-encountered">4.4 Possible issues to be encountered</a></li>
          </ul>
        </li>
        <li><a href="#5-summary">5. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Kubevela is currently at version 1.1. In general, we consider version 1.x to be relatively stable enough to try to introduce into production. As we continue to track and learn, we&rsquo;ve learned some good things about Kubevela, and this is a short summary document.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/20/5f13637eedf941259a4c3080e052165f.png" alt="Kubevela"></p>
<h2 id="1-what-kubevela-can-solve">1. What Kubevela can solve</h2>
<ul>
<li>For platform developers</li>
</ul>
<p>Several roles need to be distinguished: development, operations and maintenance, and operations and maintenance development. Development is oriented to business needs, Ops is oriented to business stability, and Ops development is oriented to efficiency. Operation and maintenance development provides a variety of tools to break the barrier between development and operation and maintenance, both to quickly meet the business online. And to ensure business stability.</p>
<p>Kubevela is not too attractive to development and ODM, but it is refreshing to ODM. Because, Kubevela can significantly improve the platform level of the team, straight to the mainstream echelon.</p>
<ul>
<li>Application lifecycle management</li>
</ul>
<p>Kubevela provides solutions for managing the application lifecycle, application definition applications, deployment appdeployments, versioning applicationrevisions, rollback approllouts, grayscale traits, approllouts. using these CRD objects can cover a large portion of business requirements.</p>
<ul>
<li>Componentization of Application Loads and Features</li>
</ul>
<p>Kubevela allows platform developers to assemble and customize the platform to fit their business through these two abstractions.</p>
<p>The orchestration capabilities provided by Workflow add more possibilities to integrate various cloud native components, even extending to the CICD domain.</p>
<h2 id="2-challenges-for-applications-under-multiple-clusters">2. Challenges for applications under multiple clusters</h2>
<ul>
<li>Unified view</li>
</ul>
<p>Switching clusters on an application-oriented platform is a very bad user experience. What we need is not to deploy a set of managed services on each cluster and then view the data on different clusters by modifying the data sources.</p>
<p>We should be application-centric, where the cluster is just an attribute of the application, and the application should not be attributed to a particular cluster. A unified view is the desire to provide users with a UI that contains a complete description of the application, the runtime where it is located, a real-time service portrait, and other information.</p>
<ul>
<li>Definition of an application</li>
</ul>
<p>No two platform teams in the world have the same definition of an application.</p>
<p>There are many details to be pushed and considered about what attributes an application should contain, what features it should have, and what restrictions are placed on what fields. Of course you can also choose to take on technical debt, defer issues and deliver a few versions quickly. But it is a long and increasingly difficult road.</p>
<p>Every team defines the application with some business attributes attached. Self-help is not possible, and cumbersome business requirements will not give the developers of the platform a break.</p>
<p>Therefore, the emergence of OAM is an opportunity to unify Application Lifecycle Management (ALM). Although Kubernetes Applications died on the beach before, Kubevela is like a star in the dark night, giving people infinite hope.</p>
<ul>
<li>Batch Releases</li>
</ul>
<p>Batch releases have two dimensions, multiple copies of an application in a single cluster, and the same application in multiple clusters.</p>
<p>Multiple copies on a single cluster are not updated at once, but need to be released in batches. This process, called rollout, is a gradual release process.</p>
<p>Services in multiple clusters or multiple regions, when updated, also need to observe time, and can not be released all at once.</p>
<h2 id="3-multi-cluster-application-under-appdeployment">3. Multi-Cluster Application under AppDeployment</h2>
<p>Here, we mainly use AppDeployment as the main object to distribute the application on multiple clusters.</p>
<ul>
<li>Adding multiple sub-clusters to the main cluster</li>
</ul>
<p>You need to configure multiple cluster contexts in the same kubeconfig, and then follow the official documentation. Here you add two clusters, prod-cluster-1 and prod-cluster-2. Here are the commands to view the clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get clusters.core.oam.dev

NAME             AGE
prod-cluster-1   57d
prod-cluster-2   57d
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Define the Application</li>
</ul>
<p>The components and traits need to be defined in advance, and the following is the definition of the application.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">core.oam.dev/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-test-app-cloneset</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app.oam.dev/revision-only</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">helloworld-cloneset</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">cloneset</span><span class="w">
</span><span class="w">      </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">oamdev/helloworld-python:v1</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TARGET&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;KubeVela-v1&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">      </span><span class="nt">traits</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">expose-nodeport</span><span class="w">
</span><span class="w">          </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TCP&#34;</span><span class="w">
</span><span class="w">                </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Since there are Annotations for <code>app.oam.dev/revision-only: &quot;true&quot;</code>, the associated resources are not created. We are just defining the application here and do not need to create the corresponding load.</p>
<ul>
<li>Modify the application version to produce a different application version</li>
</ul>
<p>To more closely match the production environment, we modify the parameters of the above Application, such as environment variables, image versions, etc., to generate different versions of the application.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get applicationrevisions.core.oam.dev

NAME                  AGE
cluster-test-app-v1   57d
cluster-test-app-v2   57d
cluster-test-app-v3   57d
</code></pre></td></tr></table>
</div>
</div><p>The final version of the application that is distributed to each cluster is created. These versions, which are roughly the same with minor differences, are similar to daily application updates.</p>
<ul>
<li>AppDeployment Distributes Applications in Multiple Clusters</li>
</ul>
<p>AppDeployment provides a perspective that is closer to the user&rsquo;s understanding of the application. The application contains not only the definition of the application, but also the choice of runtime. Here, cluster-test-app-v1 is deployed to the prod-cluster-1 cluster, setting the number of copies to 3, while cluster-test-app-v2 is deployed to the prod-cluster-2 cluster, setting the number of copies to 4.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">core.oam.dev/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AppDeployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cross-cluster-app</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">appRevisions</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">revisionName</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-test-app-v1</span><span class="w">
</span><span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">clusterSelector</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">stage</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prod-cluster-1</span><span class="w">
</span><span class="w">          </span><span class="nt">distribution</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">revisionName</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-test-app-v2</span><span class="w">
</span><span class="w">      </span><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">clusterSelector</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">production</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prod-cluster-2</span><span class="w">
</span><span class="w">          </span><span class="nt">distribution</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="4-multi-cluster-applications-under-workflow">4 Multi-Cluster Applications under Workflow</h2>
<p>Workflow is a new feature added in recent versions of Kubevela and is used here mainly to generate cross-cluster resource objects needed by OCM.</p>
<h3 id="41-configuring-open-cluster-management-ocm">4.1 Configuring Open Cluster Management (OCM)</h3>
<ul>
<li>Install Open Cluster Management using the vela command</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">vela addon <span class="nb">enable</span> ocm-cluster-manager
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add multiple subclusters to the main cluster</li>
</ul>
<p>You need to configure the context of multiple clusters in the same kubeconfig. on the dev1 cluster, add the kubeconfig of the dev2 cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl config get-contexts

CURRENT   NAME           CLUSTER              AUTHINFO                NAMESPACE
*         dev1-context   dev1.cluster.local   dev1-kubernetes-admin
          dev2-context   dev2.cluster.local   dev2-kubernetes-admin
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Configure environment variables</li>
</ul>
<p>Use dev1 (master cluster) to manage dev2 (subcluster). On the master cluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">export HUB_CLUSTER_NAME=dev1
export MANAGED_CLUSTER_NAME=dev2
export CTX_HUB_CLUSTER=dev1-context
export CTX_MANAGED_CLUSTER=dev2-context
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Find the Token to add a subcluster</li>
</ul>
<p>On the master cluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">clusteradm get token

xxxxxxxxxxxxxx
</code></pre></td></tr></table>
</div>
</div><p>Take the token value from it and Base64 decode it to get a valid hub-token value.</p>
<ul>
<li>Adding subclusters</li>
</ul>
<p>The hub-apiserver here is the access address of the kube-apiserver of the main cluster. On the master cluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">clusteradm join --context <span class="si">${</span><span class="nv">CTX_MANAGED_CLUSTER</span><span class="si">}</span> --hub-token xxxxxxxxxxxxxx --hub-apiserver https://1.1.1.1:6443 --cluster-name <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Accept a new cluster add request</li>
</ul>
<p>On the master cluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">clusteradm accept --clusters dev2
</code></pre></td></tr></table>
</div>
</div><ul>
<li>To view the managed clusters</li>
</ul>
<p>On the master cluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get managedcluster

NAME   HUB ACCEPTED   MANAGED CLUSTER URLS                JOINED   AVAILABLE   AGE
dev2   <span class="nb">true</span>           https://dev1.chenshaowen.com:6443   True     True    
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Install Kubevela rollout on the managed cluster</li>
</ul>
<p>On the subcluster, execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">helm repo add kubevela https://charts.kubevela.net/core
helm install vela-rollout  --create-namespace -n vela-system kubevela/vela-rollout
</code></pre></td></tr></table>
</div>
</div><h3 id="42-create-a-new-workflowstepdefinition-to-describe-cross-cluster-resources">4.2 Create a new WorkflowStepDefinition to describe cross-cluster resources</h3>
<p>Use Workflow in the primary cluster to define cross-cluster resources in a WorkflowStepDefinition. Here is one of the resources that will be used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">core.oam.dev/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WorkflowStepDefinition</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dispatch-traits</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vela-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">schematic</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cue</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        import (&#34;vela/op&#34;)
</span><span class="sd">
</span><span class="sd">        comp: op.#Load &amp; {
</span><span class="sd">           component: parameter.component
</span><span class="sd">        }
</span><span class="sd">
</span><span class="sd">        apply: op.#Apply &amp; {
</span><span class="sd">            value: {
</span><span class="sd">                apiVersion: &#34;work.open-cluster-management.io/v1&#34;
</span><span class="sd">                kind: &#34;ManifestWork&#34;
</span><span class="sd">                metadata: {
</span><span class="sd">                   namespace: parameter.cluster
</span><span class="sd">                   name: parameter.component + &#34;-traits&#34;
</span><span class="sd">                }
</span><span class="sd">                spec: {
</span><span class="sd">                   workload: manifests : comp.value.auxiliaries
</span><span class="sd">                }
</span><span class="sd">            }
</span><span class="sd">        }
</span><span class="sd">
</span><span class="sd">
</span><span class="sd">        parameter: {
</span><span class="sd">          component: string
</span><span class="sd">          cluster: string
</span><span class="sd">        }        </span><span class="w">        
</span></code></pre></td></tr></table>
</div>
</div><p>Where ManifestWork defines the configuration and resource information to be distributed to a cluster. Only dispatch-traits are defined here, and accordingly we also need to define dispatch-comp-rev.</p>
<p>The process of distributing resources can be understood as packaging the resources to be distributed into ManifestWork objects on the main cluster, distributing them via OCM to AppliedManifestworks objects on the subclusters, and then having the subclusters extract the resources for creation.</p>
<h3 id="43-creating-an-application-for-distribution">4.3 Creating an application for distribution</h3>
<p>Here we use Application to define an application on the main cluster dev1 and distribute it to the subcluster dev2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">core.oam.dev/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Application</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">workflow-rollout-demo</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-server</span><span class="w">
</span><span class="w">      </span><span class="nt">externalRevision</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-server-v1</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">webservice</span><span class="w">
</span><span class="w">      </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.20.0</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="nt">traits</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rollout</span><span class="w">
</span><span class="w">          </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">targetRevision</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-server-v1</span><span class="w">
</span><span class="w">            </span><span class="nt">targetSize</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">            </span><span class="nt">rolloutBatches</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">              </span>- <span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">workflow</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dispatch-comp-rev-v1</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">dispatch-comp-rev</span><span class="w">
</span><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">compRev</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-server-v1</span><span class="w">
</span><span class="w">           </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">dev2</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dispatchRollout</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">dispatch-traits</span><span class="w">
</span><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-server</span><span class="w">
</span><span class="w">          </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">dev2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In the scenario of OCM multi-cluster applications, sub-clusters need to deploy Kubevela rollout components. As a result, Kubevela is able to control the subcluster rollout process in a more granular way, such as the ratio and number of batches per rollout process, etc.</p>
<h3 id="44-possible-issues-to-be-encountered">4.4 Possible issues to be encountered</h3>
<ul>
<li>OCM errors when creating resources in subclusters</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">E0905 14:36:23.461052       <span class="m">1</span> base_controller.go:270<span class="o">]</span> <span class="s2">&#34;ManifestWorkAgent&#34;</span> controller failed to sync <span class="s2">&#34;nginx-server-traits&#34;</span>, err: rollouts.standard.oam.dev <span class="s2">&#34;nginx-server&#34;</span> is forbidden: User <span class="s2">&#34;system:serviceaccount:open-cluster-management-agent:klusterlet-work-sa&#34;</span> cannot get resource <span class="s2">&#34;rollouts&#34;</span> in API group <span class="s2">&#34;standard.oam.dev&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>The hint is that there are not enough permissions, and on the subcluster, an admin permission is bound directly to klusterlet-work-sa.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-ocm</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rbac.authorization.kubernetes.io/autoupdate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">klusterlet-work-sa</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">open-cluster-management-agent</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="5-summary">5. Summary</h2>
<p>This article discusses the application of Kubevela in multiple clusters, and the main content is as follows:</p>
<ul>
<li>Applications under multiple clusters, unlike single clusters, cannot simply switch data sources to achieve, and their interaction design has higher requirements. Multi-cluster application platform needs to have a unified view to view the service portrait of the application under multi-cluster, and to take the application as the center, treat the cluster as the property, and separate the priority.</li>
<li>AppDeployment is a good abstraction and can give some inspiration to the platform design, and also see some KubeFed figure. AppDeployment is a multi-cluster application presented in the user&rsquo;s perspective, but the current processing granularity of Workload is too large, for the whole Application, that is, the full amount of delete, update, create Workload. If it is used for production, it also needs to be updated with rollout.</li>
<li>We can integrate Kubevela multi-cluster application under OCM with Workflow for more scalability, and we can also switch to other multi-cluster components, such as Karmada, and use the distribution capability of OCM and Kubevela rollout component on sub-clusters to achieve batch release and rolling update.</li>
</ul>
<p>Kubevela is for visible applications, but it needs more underlying components to support the whole application platform.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubevela/">kubevela</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/how-to-add-entrance-to-kubernetes-apiserver/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to add an entrance to Kubernetes Apiserver.</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/time-timezeon-tips/">
            <span class="next-text nav-default">Time and Time Zone in Go</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
