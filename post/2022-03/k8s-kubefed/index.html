<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Multi-Cluster Management with Kubernetes Kubefed - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The previous article &amp;ldquo;Kubernetes Multi-Cluster Management: Kubefed (Federation v2)&amp;rdquo; gave a brief introduction to the basic concepts and working principles of Federation v2, and this article focuses on the use of Kubefed. The experimental environment for this article is v0.1.0-rc6. 1 2 $ kubefedctl version kubefedctl version: version.Info{Version:&amp;#34;v0.1.0-rc6&amp;#34;, GitCommit:&amp;#34;7586b42f4f477f1912caf28287fa2e0a7f68f407&amp;#34;, GitTreeState:&amp;#34;clean&amp;#34;, BuildDate:&amp;#34;2019-08-17T03:55:05Z&amp;#34;, GoVersion:&amp;#34;go1.12.5&amp;#34;, Compiler:&amp;#34;gc&amp;#34;, Platform:&amp;#34;linux/amd64&amp;#34;} Installation The installation of Federation v2 is divided into two parts, one is Controller Plan and" /><meta name="keywords" content="kubernetes, Multi-Cluster, kubefed" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/k8s-kubefed/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Multi-Cluster Management with Kubernetes Kubefed" />
<meta property="og:description" content="The previous article &ldquo;Kubernetes Multi-Cluster Management: Kubefed (Federation v2)&rdquo; gave a brief introduction to the basic concepts and working principles of Federation v2, and this article focuses on the use of Kubefed. The experimental environment for this article is v0.1.0-rc6. 1 2 $ kubefedctl version kubefedctl version: version.Info{Version:&#34;v0.1.0-rc6&#34;, GitCommit:&#34;7586b42f4f477f1912caf28287fa2e0a7f68f407&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2019-08-17T03:55:05Z&#34;, GoVersion:&#34;go1.12.5&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;} Installation The installation of Federation v2 is divided into two parts, one is Controller Plan and" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/k8s-kubefed/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-14T09:45:34+08:00" />
<meta property="article:modified_time" content="2022-03-14T09:45:34+08:00" />

<meta itemprop="name" content="Multi-Cluster Management with Kubernetes Kubefed">
<meta itemprop="description" content="The previous article &ldquo;Kubernetes Multi-Cluster Management: Kubefed (Federation v2)&rdquo; gave a brief introduction to the basic concepts and working principles of Federation v2, and this article focuses on the use of Kubefed. The experimental environment for this article is v0.1.0-rc6. 1 2 $ kubefedctl version kubefedctl version: version.Info{Version:&#34;v0.1.0-rc6&#34;, GitCommit:&#34;7586b42f4f477f1912caf28287fa2e0a7f68f407&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2019-08-17T03:55:05Z&#34;, GoVersion:&#34;go1.12.5&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;} Installation The installation of Federation v2 is divided into two parts, one is Controller Plan and"><meta itemprop="datePublished" content="2022-03-14T09:45:34+08:00" />
<meta itemprop="dateModified" content="2022-03-14T09:45:34+08:00" />
<meta itemprop="wordCount" content="1551">
<meta itemprop="keywords" content="kubernetes,kubefed," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Multi-Cluster Management with Kubernetes Kubefed"/>
<meta name="twitter:description" content="The previous article &ldquo;Kubernetes Multi-Cluster Management: Kubefed (Federation v2)&rdquo; gave a brief introduction to the basic concepts and working principles of Federation v2, and this article focuses on the use of Kubefed. The experimental environment for this article is v0.1.0-rc6. 1 2 $ kubefedctl version kubefedctl version: version.Info{Version:&#34;v0.1.0-rc6&#34;, GitCommit:&#34;7586b42f4f477f1912caf28287fa2e0a7f68f407&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2019-08-17T03:55:05Z&#34;, GoVersion:&#34;go1.12.5&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;} Installation The installation of Federation v2 is divided into two parts, one is Controller Plan and"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Multi-Cluster Management with Kubernetes Kubefed</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-14 09:45:34 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1551 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#controller-plan">Controller Plan</a></li>
            <li><a href="#kubefedctl">kubefedctl</a></li>
          </ul>
        </li>
        <li><a href="#multicluster-management">Multicluster Management</a>
          <ul>
            <li><a href="#resources">Resources</a></li>
            <li><a href="#scheduling">Scheduling</a></li>
            <li><a href="#networking">Networking</a></li>
          </ul>
        </li>
        <li><a href="#deployment">Deployment</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The previous article &ldquo;Kubernetes Multi-Cluster Management: Kubefed (Federation v2)&rdquo; gave a brief introduction to the basic concepts and working principles of Federation v2, and this article focuses on the use of Kubefed.</p>
<p>The experimental environment for this article is <code>v0.1.0-rc6</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubefedctl version
kubefedctl version: version.Info<span class="o">{</span>Version:<span class="s2">&#34;v0.1.0-rc6&#34;</span>, GitCommit:<span class="s2">&#34;7586b42f4f477f1912caf28287fa2e0a7f68f407&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2019-08-17T03:55:05Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.12.5&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;linux/amd64&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="installation">Installation</h2>
<p>The installation of Federation v2 is divided into two parts, one is Controller Plan and kubefedctl.</p>
<h3 id="controller-plan">Controller Plan</h3>
<p>Controller Plan can be deployed using Helm (currently Helm is still using v2 version), refer to the official installation documentation: <a href="https://github.com/kubernetes-sigs/kubefed/blob/master/charts/kubefed/README.md">https://github.com/kubernetes-sigs/kubefed/blob/master/charts/kubefed/README.md</a></p>
<p>To add the helm repo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm repo add kubefed-charts https://raw.githubusercontent.com/kubernetes-sigs/kubefed/master/charts

$ helm repo list
NAME            URL
kubefed-charts   https://raw.githubusercontent.com/kubernetes-sigs/kubefed/master/charts
</code></pre></td></tr></table>
</div>
</div><p>Find the current version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm search kubefed
NAME                        	CHART VERSION	APP VERSION	DESCRIPTION
kubefed-charts/kubefed      	0.1.0-rc6    	           	KubeFed helm chart
kubefed-charts/federation-v2	0.0.10       	           	Kubernetes Federation V2 helm chart
</code></pre></td></tr></table>
</div>
</div><p>Then use helm to install the latest version directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm install kubefed-charts/kubefed --name kubefed --version<span class="o">=</span>0.1.0-rc6 --namespace kube-federation-system
</code></pre></td></tr></table>
</div>
</div><h3 id="kubefedctl">kubefedctl</h3>
<p>kubefedctl is a binary program, the latest version of which can be found for download on Github&rsquo;s Release page: <a href="https://github.com/kubernetes-sigs/kubefed/releases">https://github.com/kubernetes-sigs/kubefed/releases</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ wget https://github.com/kubernetes-sigs/kubefed/releases/download/v0.1.0-rc6/kubefedctl-0.1.0-rc6-linux-amd64.tgz

$ tar -zxvf kubefedctl-0.1.0-rc6-linux-amd64.tgz

$ mv kubefedctl /usr/local/bin/
</code></pre></td></tr></table>
</div>
</div><p>kubefedctl provides a lot of convenient operations, such as cluster registration, resource registration, etc.</p>
<h2 id="multicluster-management">Multicluster Management</h2>
<p>You can use the <code>kubefedctl join</code> command to access new clusters. Before accessing them, you need to configure multiple clusters information in the local kubeconfig.</p>
<p>The basic usage is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">kubefedctl join &lt;集群名称&gt; --cluster-context &lt;要接入集群的 context 名称&gt; --host-cluster-context &lt;HOST 集群的 context&gt;
</code></pre></td></tr></table>
</div>
</div><p>For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">kubefedctl join cluster1 --cluster-context cluster1 \
    --host-cluster-context cluster1 --v=2
kubefedctl join cluster2 --cluster-context cluster2 \
    --host-cluster-context cluster1 --v=2
</code></pre></td></tr></table>
</div>
</div><p>Kubefed uses CR to store the data it needs, so when you use <code>kubefedctl join</code>, you can see the cluster information in the host cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl -n kube-federation-system get kubefedclusters
NAME       READY   AGE
cluster1   True    3d22h
cluster2   True    3d22h
cluster3   True    3d22h
</code></pre></td></tr></table>
</div>
</div><p>The <code>kubefedctl join</code> command simply translates the configuration in Kubeconfig into a <code>KubeFedCluster</code> custom resource stored in the <code>kube-federation-system</code> namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">$ kubectl -n kube-federation-system get kubefedclusters cluster1 -o yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">core.kubefed.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeFedCluster</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-10-24T08:05:38Z&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-federation-system</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;647452&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/core.kubefed.io/v1beta1/namespaces/kube-federation-system/kubefedclusters/cluster1</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">4c5eb57f-5ed4-4cec-89f3-cfc062492ae0</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiEndpoint</span><span class="p">:</span><span class="w"> </span><span class="l">https://172.16.200.1:6443</span><span class="w">
</span><span class="w">  </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">LS....Qo=</span><span class="w">
</span><span class="w">  </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1-shb2x</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">lastProbeTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-10-28T06:25:58Z&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-10-28T05:13:47Z&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">/healthz responded with ok</span><span class="w">
</span><span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterReady</span><span class="w">
</span><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Ready</span><span class="w">
</span><span class="w">  </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="resources">Resources</h3>
<p>One of the reasons for the obsolescence of Federation v1 is the rigidity of resource expansion (the need to expand the API Server) and the lack of the expected large-scale application of CRD, so Federation v2 is very flexible in resource management.</p>
<p>For KubeFed, there are two types of resource management, one is resource type management, and the other is federated resource management.</p>
<p>For resource types, kubefedctl provides enable to enable new resources to be federated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubefedctl <span class="nb">enable</span> &lt;target kubernetes API type&gt;
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Types, i.e. Kind (e.g. Deployment)</li>
<li>plural nouns (e.g. deployments)</li>
<li>Plural resource nouns with api groups (e.g. deployment.apps)</li>
<li>Abbreviations (e.g. deploy)</li>
</ul>
<p>For example, if we need to give the VirtualService resources in istio to the federation to manage, we can use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubefedctl <span class="nb">enable</span> VirtualService
</code></pre></td></tr></table>
</div>
</div><p>Because Kubefed manages resources through CRDs. Therefore, when enable is executed, you can see that a new CRD named <code>federatedvirtualservices</code> has been added to the Host Cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get crd <span class="p">|</span> grep virtualservice
federatedvirtualservices.types.kubefed.io            2019-10-24T13:12:46Z
virtualservices.networking.istio.io                  2019-10-24T08:06:01Z
</code></pre></td></tr></table>
</div>
</div><p>This CRD describes required fields of type <code>federatedvirtualservices</code>, such as <code>placement</code>, <code>overrides</code>, etc.</p>
<p><code>kubefedctl enable</code> completes the management of resource types, and resource management edits that need to be federated are started based on the newly created CRD. However, before deploying resources, you need to create <code>federatednamespaces</code>, and resources from multiple clusters will only be deployed to namespaces that are managed by kubefed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get federatednamespaces
NAME      AGE
default   3d21h
</code></pre></td></tr></table>
</div>
</div><p>Here is an attempt to create a resource of type <code>federatedvirtualservices</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get federatedvirtualservices
NAME            AGE
service-route   3d4h
</code></pre></td></tr></table>
</div>
</div><p>Complete yaml.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">types.kubefed.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">FederatedVirtualService</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-route</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster2</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster3</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-route</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">service-gateway</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">        </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">destination</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">service-a-1</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>At this point, Kubefed creates the corresponding <code>virtualservice</code> resource for the target cluster based on the description in the <code>template</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get virtualservices
NAME            GATEWAYS            HOSTS   AGE
service-route   <span class="o">[</span>service-gateway<span class="o">]</span>   <span class="o">[</span>*<span class="o">]</span>     3d4h
</code></pre></td></tr></table>
</div>
</div><h3 id="scheduling">Scheduling</h3>
<p>Kubefed can currently only do some simple inter-cluster scheduling, i.e., manual assignment.</p>
<p>For manually specified scheduling there are two main parts, one is to specify the destination directly in the resource, and the other is to do proportional allocation via <code>ReplicaSchedulingPreference</code>.</p>
<p>For each federated resource, there is a <code>placement</code> field to describe which cluster it will be deployed to, which can be understood from the CRD&rsquo;s description of the definition idea.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">clusterSelector</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">              </span><span class="nt">operator</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">              </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">array</span><span class="w">
</span><span class="w">            </span><span class="nt">required</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">key</span><span class="w">
</span><span class="w">            </span>- <span class="l">operator</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">array</span><span class="w">
</span><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">name</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">array</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Usage examples are as follows, either by specifying a <code>cluster</code> list via clusters, or by selecting clusters based on cluster tags via <code>clusterSelector</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster2</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1</span><span class="w">
</span><span class="w">    </span><span class="nt">clusterSelector</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>However, there are two things to note.</p>
<ol>
<li>if the <code>clusters</code> field is specified, <code>clusterSelector</code> will be ignored</li>
<li>the selected clusters are equal and the resource will deploy an undifferentiated replica in each selected cluster</li>
</ol>
<p>If you need to schedule differently across multiple clusters you need to introduce <code>ReplicaSchedulingPreference</code> for scaled scheduling.</p>
<p><code>ReplicaSchedulingPreference</code> defines a scheduling policy that includes several scheduling-related fields.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">scheduling.kubefed.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSchedulingPreference</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-deployment</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">test-ns</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">targetKind</span><span class="p">:</span><span class="w"> </span><span class="l">FederatedDeployment</span><span class="w">
</span><span class="w">  </span><span class="nt">totalReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">9</span><span class="w">
</span><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">A</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">      </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">B</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">      </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span><span class="w">      </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>totalReplicas defines the total number of replicas</li>
<li>clusters describes the maximum and minimum replicas of different clusters and their weights</li>
</ul>
<p>Kubefed maintains the number of replicas for different clusters according to the scheduling policy definition, as detailed in the documentation: (<a href="https://github.com/kubernetes-sigs/kubefed/blob/master/docs/userguide.md#replicaschedulingpreference">https://github.com/kubernetes-sigs/kubefed/blob/master/docs/userguide.md#replicaschedulingpreference</a>).</p>
<h3 id="networking">Networking</h3>
<p>Another highlight feature of Kubefed is network access across clusters. kubefed makes cross-cluster traffic configurable by introducing an external DNS that combines the Ingress Controller with an external LB such as metallb.</p>
<p>In the case of Ingress, for example, users can create <code>IngressDNSRecord</code> type resources and specify domain names, and Kubefed will custom configure the relevant DNS policies based on the <code>IngressDNSRecord</code> and apply them to the external servers.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/9bf6aad6727c41bc84e706d1d0bdaf4f.png" alt="Kubefed Networking"></p>
<p>Creates a resource of type <code>IngressDNSRecord</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multiclusterdns.kubefed.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressDNSRecord</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-ingress</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">test-namespace</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">ingress.example.com</span><span class="w">
</span><span class="w">  </span><span class="nt">recordTTL</span><span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The DNS Endpoint controller will generate the associated <code>DNSEndpoint</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">$ kubectl -n test-namespace get dnsendpoints -o yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">items</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">multiclusterdns.kubefed.io/v1alpha1</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DNSEndpoint</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="ld">2018-10-10T20:37:38Z</span><span class="w">
</span><span class="w">    </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-test-ingress</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">test-namespace</span><span class="w">
</span><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;251874&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/multiclusterdns.kubefed.io/v1alpha1/namespaces/test-namespace/dnsendpoints/ingress-test-ingress</span><span class="w">
</span><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">538d1063-cccc-11e8-bebb-42010a8a00b8</span><span class="w">
</span><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">dnsName</span><span class="p">:</span><span class="w"> </span><span class="l">ingress.example.com</span><span class="w">
</span><span class="w">      </span><span class="nt">recordTTL</span><span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w">      </span><span class="nt">recordType</span><span class="p">:</span><span class="w"> </span><span class="l">A</span><span class="w">
</span><span class="w">      </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">$CLUSTER1_INGRESS_IP</span><span class="w">
</span><span class="w">      </span>- <span class="l">$CLUSTER2_INGRESS_IP</span><span class="w">
</span><span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">List</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The ExternalDNS controller listens to the <code>DNSEndpoint</code> resource and applies the record to the DNS server upon receipt of the event. If the internal DNS server of the member cluster uses the external DNS server as the upstream server, then the member cluster can access it directly for the domain name to enable cross-cluster access.</p>
<h2 id="deployment">Deployment</h2>
<blockquote>
<p>There is a full example in the official repository for experimentation, see: <a href="https://github.com/kubernetes-sigs/kubefed/tree/master/example">https://github.com/kubernetes-sigs/kubefed/tree/master/example</a></p>
</blockquote>
<p>In addition to scheduling, Kubefed enables differential deployment between clusters via the <code>overrides</code> field.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">types.kubefed.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">FederatedDeployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-deployment</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">test-namespace</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">placement</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster2</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1</span><span class="w">
</span><span class="w">  </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">cluster2</span><span class="w">
</span><span class="w">    </span><span class="nt">clusterOverrides</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/spec/replicas&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/spec/template/spec/containers/0/image&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx:1.17.0-alpine&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/metadata/annotations&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">op</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;add&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span><span class="w">    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/metadata/annotations/foo&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">op</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;remove&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>After deploying the Deployment, you can check the deployment status via <code>kubectl describe</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">$ kubectl describe federateddeployment.types.kubefed.io/test-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">Name</span><span class="p">:</span><span class="w">         </span><span class="l">test-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l">&lt;none&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">Annotations</span><span class="p">:</span><span class="w">  </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>{<span class="s2">&#34;apiVersion&#34;</span><span class="p">:</span><span class="s2">&#34;types.kubefed.io/v1beta1&#34;</span><span class="p">,</span><span class="s2">&#34;kind&#34;</span><span class="p">:</span><span class="s2">&#34;FederatedDeployment&#34;</span><span class="p">,</span><span class="s2">&#34;metadata&#34;</span><span class="p">:</span>{<span class="s2">&#34;annotations&#34;</span><span class="p">:</span>{}<span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;test-deployment&#34;</span><span class="p">,</span><span class="s2">&#34;namespace&#34;</span><span class="p">:</span><span class="s2">&#34;d...
</span><span class="s2">API Version:  types.kubefed.io/v1beta1
</span><span class="s2">Kind:         FederatedDeployment
</span><span class="s2">Metadata:
</span><span class="s2">  Creation Timestamp:  2019-10-28T07:55:34Z
</span><span class="s2">  Finalizers:
</span><span class="s2">    kubefed.io/sync-controller
</span><span class="s2">  Generation:        1
</span><span class="s2">  Resource Version:  657714
</span><span class="s2">  Self Link:         /apis/types.kubefed.io/v1beta1/namespaces/default/federateddeployments/test-deployment
</span><span class="s2">  UID:               6016a3eb-7e7f-4756-ba40-b655581f06ad
</span><span class="s2">Spec:
</span><span class="s2">  Overrides:
</span><span class="s2">    Cluster Name:  cluster2
</span><span class="s2">    Cluster Overrides:
</span><span class="s2">      Path:   /spec/replicas
</span><span class="s2">      Value:  5
</span><span class="s2">      Path:   /spec/template/spec/containers/0/image
</span><span class="s2">      Value:  nginx:1.17.0-alpine
</span><span class="s2">      Op:     add
</span><span class="s2">      Path:   /metadata/annotations
</span><span class="s2">      Value:
</span><span class="s2">        Foo:  bar
</span><span class="s2">      Op:     remove
</span><span class="s2">      Path:   /metadata/annotations/foo
</span><span class="s2">  Placement:
</span><span class="s2">    Clusters:
</span><span class="s2">      Name:  cluster2
</span><span class="s2">      Name:  cluster1
</span><span class="s2">  Template:
</span><span class="s2">    Metadata:
</span><span class="s2">      Labels:
</span><span class="s2">        App:  nginx
</span><span class="s2">    Spec:
</span><span class="s2">      Replicas:  3
</span><span class="s2">      Selector:
</span><span class="s2">        Match Labels:
</span><span class="s2">          App:  nginx
</span><span class="s2">      Template:
</span><span class="s2">        Metadata:
</span><span class="s2">          Labels:
</span><span class="s2">            App:  nginx
</span><span class="s2">        Spec:
</span><span class="s2">          Containers:
</span><span class="s2">            Image:  nginx
</span><span class="s2">            Name:   nginx
</span><span class="s2">Status:
</span><span class="s2">  Clusters:
</span><span class="s2">    Name:  cluster1
</span><span class="s2">    Name:  cluster2
</span><span class="s2">  Conditions:
</span><span class="s2">    Last Transition Time:  2019-10-28T07:55:35Z
</span><span class="s2">    Last Update Time:      2019-10-28T07:55:49Z
</span><span class="s2">    Status:                True
</span><span class="s2">    Type:                  Propagation
</span><span class="s2">Events:
</span><span class="s2">  Type    Reason           Age                From                            Message
</span><span class="s2">  ----    ------           ----               ----                            -------
</span><span class="s2">  Normal  CreateInCluster  14s                federateddeployment-controller  Creating Deployment &#34;</span><span class="l">default/test-deployment&#34; in cluster &#34;cluster2&#34;</span><span class="w">
</span><span class="w">  </span><span class="l">Normal  CreateInCluster  14s                federateddeployment-controller  Creating Deployment &#34;default/test-deployment&#34; in cluster &#34;cluster1&#34;</span><span class="w">
</span><span class="w">  </span><span class="l">Normal  UpdateInCluster  0s (x10 over 12s)  federateddeployment-controller  Updating Deployment &#34;default/test-deployment&#34; in cluster &#34;cluster2&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>and the differences that can be seen between the different clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl --context<span class="o">=</span>cluster1 get deploy <span class="p">|</span> grep <span class="nb">test</span>
test-deployment   3/3     <span class="m">3</span>            <span class="m">3</span>           98s

$ kubectl --context<span class="o">=</span>cluster2 get deploy <span class="p">|</span> grep <span class="nb">test</span>
test-deployment   5/5     <span class="m">5</span>            <span class="m">5</span>           105s
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/kubefed/">kubefed</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/microsoft-type-annotations-for-javascript/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Microsoft proposes to add type annotation to JavaScript natively</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubefed/">
            <span class="next-text nav-default">Kubernetes Multi-Cluster Management: Kubefed (Federation v2)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
