<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The confusing socket udp connection problem - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The company&amp;rsquo;s internal golang middleware reported a UDP connection exception log, the problem is obvious, the service on the other side down. Restart it and it will be fine. But the question I&amp;rsquo;m wondering is how does udp detect when the other side is down? 1 2 3 4 5 6 7 err: write udp 172.16.44.62:62651-&amp;gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&amp;gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&amp;gt;172.16.0.46:29999:" /><meta name="keywords" content="golang, Udp" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/golang-udp-connection-problem/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="The confusing socket udp connection problem" />
<meta property="og:description" content="The company&rsquo;s internal golang middleware reported a UDP connection exception log, the problem is obvious, the service on the other side down. Restart it and it will be fine. But the question I&rsquo;m wondering is how does udp detect when the other side is down? 1 2 3 4 5 6 7 err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/golang-udp-connection-problem/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-09T09:30:16+08:00" />
<meta property="article:modified_time" content="2022-03-09T09:30:16+08:00" />

<meta itemprop="name" content="The confusing socket udp connection problem">
<meta itemprop="description" content="The company&rsquo;s internal golang middleware reported a UDP connection exception log, the problem is obvious, the service on the other side down. Restart it and it will be fine. But the question I&rsquo;m wondering is how does udp detect when the other side is down? 1 2 3 4 5 6 7 err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999:"><meta itemprop="datePublished" content="2022-03-09T09:30:16+08:00" />
<meta itemprop="dateModified" content="2022-03-09T09:30:16+08:00" />
<meta itemprop="wordCount" content="1462">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The confusing socket udp connection problem"/>
<meta name="twitter:description" content="The company&rsquo;s internal golang middleware reported a UDP connection exception log, the problem is obvious, the service on the other side down. Restart it and it will be fine. But the question I&rsquo;m wondering is how does udp detect when the other side is down? 1 2 3 4 5 6 7 err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused err: write udp 172.16.44.62:62651-&gt;172.16.0.46:29999:"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The confusing socket udp connection problem</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-09 09:30:16 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1462 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#use-tcpdump-to-capture-packets">Use tcpdump to capture packets</a></li>
        <li><a href="#testing-of-various-cases">Testing of various cases</a></li>
        <li><a href="#logic-of-netcat-nc-udp">logic of netcat nc udp</a></li>
        <li><a href="#udp-connection-information">UDP connection information</a></li>
        <li><a href="#client-re-instantiation-problem-">Client re-instantiation problem ?</a></li>
        <li><a href="#golang-test-code">Golang test code</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The company&rsquo;s internal golang middleware reported a UDP connection exception log, the problem is obvious, the service on the other side down. Restart it and it will be fine.</p>
<p>But the question I&rsquo;m wondering is how does udp detect when the other side is down?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">err:  write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused

err:  write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused

err:  write udp 172.16.44.62:62651-&gt;172.16.0.46:29999: write: connection refused

...
</code></pre></td></tr></table>
</div>
</div><p>The udp protocol has neither three handshakes nor TCP status control messages, so how can we determine if the UDP port on the other side is open?</p>
<p>By grabbing the packet, we can find that when the server&rsquo;s port is not open, the server&rsquo;s system returns <code>icmp ECONNREFUSED</code> message to the client, indicating that the connection is abnormal.</p>
<p>When the client system parses the message, it finds the corresponding socket by the five-tuple, and errno returns an exception error, if the client is waiting, it wakes up and sets the error status.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/09/ff9df7c1acd64677ab61321d3f1d1913.png" alt="imcp udp"></p>
<p>(above is icmp under udp exception, below is normal icmp)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/09/231e58a3113149b7b39232baefc066ad.png" alt="udp imcp"></p>
<p>When the UDP connection is abnormal, you can use the tcpdmp utility to specify the ICMP protocol to catch the abnormal message, after all, the other side is ECONNREFUSED via icmp.</p>
<h2 id="use-tcpdump-to-capture-packets">Use tcpdump to capture packets</h2>
<p><strong>Request command:</strong></p>
<p>First find a host that can ping through, then use nc to simulate a udp client to request a port that does not exist, and <code>Connection refused</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@ocean ~<span class="o">]</span><span class="c1"># nc -vzu 172.16.0.46 8888</span>
Ncat: Version 7.50 <span class="o">(</span> https://nmap.org/ncat <span class="o">)</span>
Ncat: Connected to 172.16.0.46:8888.
Ncat: Connection refused.
</code></pre></td></tr></table>
</div>
</div><p><strong>The packet capture information is as follows:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[root@ocean ~]# tcpdump -i any icmp -nn
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
17:01:14.075617 IP 172.16.0.46 &gt; 172.16.0.62: ICMP 172.16.0.46 udp port 8888 unreachable, length 37
17:01:17.326145 IP 172.16.0.46 &gt; 172.16.0.62: ICMP 172.16.0.46 udp port 8888 unreachable, length 37
17:01:17.927480 IP 172.16.0.46 &gt; 172.16.0.62: ICMP 172.16.0.46 udp port 8888 unreachable, length 37
17:01:18.489560 IP 172.16.0.46 &gt; 172.16.0.62: ICMP 172.16.0.46 udp port 8888 unreachable, length 37
</code></pre></td></tr></table>
</div>
</div><p>Also note that telnet does not support udp, only tcp, so it is recommended to use nc to probe udp.</p>
<h2 id="testing-of-various-cases">Testing of various cases</h2>
<p><strong>Summary of cases:</strong></p>
<ul>
<li>When udp client connects when ip cannot be connected, it usually shows success.</li>
<li>When the udp server program is closed, but the system still exists, the other system will `icmp ECONNREFUSE error.</li>
<li>When the other side has iptables udp port drop, the client will also usually show success.</li>
</ul>
<p><strong>If the IP cannot be connected:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[root@host-46 ~ ]ping 172.16.0.65
PING 172.16.0.65 (172.16.0.65) 56(84) bytes of data.
From 172.16.0.46 icmp_seq=1 Destination Host Unreachable
From 172.16.0.46 icmp_seq=2 Destination Host Unreachable
From 172.16.0.46 icmp_seq=3 Destination Host Unreachable
From 172.16.0.46 icmp_seq=4 Destination Host Unreachable
From 172.16.0.46 icmp_seq=5 Destination Host Unreachable
From 172.16.0.46 icmp_seq=6 Destination Host Unreachable
^C
--- 172.16.0.65 ping statistics ---
6 packets transmitted, 0 received, +6 errors, 100% packet loss, time 4999ms
pipe 4

[root@host-46 ~ ] nc -vzu 172.16.0.65 8888
Ncat: Version 7.50 ( https://nmap.org/ncat )
Ncat: Connected to 172.16.0.65:8888.
Ncat: UDP packet sent successfully
Ncat: 1 bytes sent, 0 bytes received in 2.02 seconds.
</code></pre></td></tr></table>
</div>
</div><p>Also, to be clear again udp does not have status messages like tcp, so simply grabbing packets for UDP will not see any abnormal information.</p>
<p>So why does NC UDP command show success when the IP is not connected ?</p>
<h2 id="logic-of-netcat-nc-udp">logic of netcat nc udp</h2>
<p>Why does it return a successful connection when the ip is not connected or the message is DROPed ????</p>
<p>Because nc&rsquo;s default detection logic is simple, as long as no <code>icmp ECONNREFUSED</code> exception message is received within 2 seconds, then the UDP connection is considered successful. 😅</p>
<p>Here is how the nc udp command is executed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">setsockopt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">30000</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">&#34;172.16.0.111&#34;</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">)</span>          <span class="o">=</span> <span class="mi">1</span> <span class="p">(</span><span class="n">out</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">getsockopt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ERROR</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;Ncat: &#34;</span><span class="p">,</span> <span class="mi">6</span><span class="nl">Ncat</span><span class="p">:</span> <span class="p">)</span>                   <span class="o">=</span> <span class="mi">6</span>
<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;Connected to 172.16.0.111:29999.&#34;</span><span class="p">...,</span> <span class="mi">33</span><span class="n">Connected</span> <span class="n">to</span> <span class="mf">172.16.0.111</span><span class="o">:</span><span class="mf">29999.</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">33</span>
<span class="n">sendto</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\0</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>          <span class="o">=</span> <span class="mi">1</span>

<span class="c1">// select 多路复用方法里加入了超时逻辑.
</span><span class="c1"></span><span class="n">select</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">{</span><span class="n">tv_sec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tv_usec</span><span class="o">=</span><span class="mi">0</span><span class="p">})</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">)</span>

<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;Ncat: &#34;</span><span class="p">,</span> <span class="mi">6</span><span class="nl">Ncat</span><span class="p">:</span> <span class="p">)</span>                   <span class="o">=</span> <span class="mi">6</span>
<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;UDP packet sent successfully</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">29U</span><span class="n">DP</span> <span class="n">packet</span> <span class="n">sent</span> <span class="n">successfully</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">29</span>
<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;Ncat: &#34;</span><span class="p">,</span> <span class="mi">6</span><span class="nl">Ncat</span><span class="p">:</span> <span class="p">)</span>                   <span class="o">=</span> <span class="mi">6</span>
<span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;1 bytes sent, 0 bytes received i&#34;</span><span class="p">...,</span> <span class="mi">481</span> <span class="n">bytes</span> <span class="n">sent</span><span class="p">,</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">received</span> <span class="n">in</span> <span class="mf">2.02</span> <span class="n">seconds</span><span class="p">.</span>
<span class="p">)</span> <span class="o">=</span> <span class="mi">48</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
</code></pre></td></tr></table>
</div>
</div><p>A UDP client written in golang/ python will not actually report an error when sending a UDP message to an unreachable address, it will usually assume that it was sent successfully.</p>
<p>Still, UDP doesn&rsquo;t have the handshake step that TCP has, so if you can&rsquo;t get a response to a TCP syn, the stack will try 6 times with time avoidance, and the kernel will give you an errno value when you don&rsquo;t get a response after 6 attempts.</p>
<h2 id="udp-connection-information">UDP connection information</h2>
<p>On the client host, you can see the UDP quintuplet connection information via ss lsof netstat.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@host-46 ~ <span class="o">]</span>$ netstat -tunalp<span class="p">|</span>grep <span class="m">29999</span>
udp        <span class="m">0</span>      <span class="m">0</span> 172.16.0.46:44136       172.16.0.46:29999       ESTABLISHED 1285966/cccc
</code></pre></td></tr></table>
</div>
</div><p>UDP connection information is usually not visible on the server side, only udp listen information !!!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[root@host-62 ~ ]# netstat -tunalp|grep 29999
udp       0      0 :::29999                :::*                                4038720/ss
</code></pre></td></tr></table>
</div>
</div><h2 id="client-re-instantiation-problem-">Client re-instantiation problem ?</h2>
<p>When the client and server are connected and the server restarts manually, the client does not need to re-instantiate the connection again and can continue to send data, and when the server starts again, it can still receive messages from the client.</p>
<p>udp has no handshake process, and its udp connect() only creates the socket information locally. The udp quintet of sockets is not visible on the server side using netstat.</p>
<h2 id="golang-test-code">Golang test code</h2>
<p><strong>server-side code:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;net&#34;</span>
<span class="p">)</span>

<span class="c1">// UDP 服务端
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">listen</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenUDP</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span>
        <span class="nx">IP</span><span class="p">:</span>   <span class="nx">net</span><span class="p">.</span><span class="nf">IPv4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="nx">Port</span><span class="p">:</span> <span class="mi">29999</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Listen failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">listen</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="p">[</span><span class="mi">1024</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">n</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">listen</span><span class="p">.</span><span class="nf">ReadFromUDP</span><span class="p">(</span><span class="nx">data</span><span class="p">[:])</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read udp failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;data:%v addr:%v count:%v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">]),</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Client Code:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;net&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="c1">// UDP 客户端
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">DialUDP</span><span class="p">(</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">UDPAddr</span><span class="p">{</span>
        <span class="nx">IP</span><span class="p">:</span>   <span class="nx">net</span><span class="p">.</span><span class="nf">IPv4</span><span class="p">(</span><span class="mi">172</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
        <span class="nx">Port</span><span class="p">:</span> <span class="mi">29999</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;连接UDP服务器失败，err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mf">1e9</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nx">sendData</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;Hello Server&#34;</span><span class="p">)</span>
        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">sendData</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;发送数据失败，err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;已发送&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>When the machine on the udp server side can be connected and there is no exception, the client will usually show success. However, when there is an exception, the following situation will occur:</p>
<ul>
<li>When the ip address is not available, the udp client will usually show success when connecting.</li>
<li>When the udp server program is closed, but the system still exists, the other system returns an error via <code>icmp ECONNREFUSE</code>, and the client will report an error.</li>
<li>The client will also show success when the other side has iptables udp port drop operation.</li>
<li>When the client and server share data, the UDP client cannot sense the shutdown status immediately when the service process hangs, and the client can only sense that the other side is down when the other side responds with an <code>icmp ECONNREFUSE</code> exception message when sending data again.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/go-concurrency-safe/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Concurrency Safety for Go</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/google-fuchsia-os/">
            <span class="next-text nav-default">Google&#39;s grand unification? Fuchsia OS already offers the full Chrome browser experience</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
