<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to Distribute Files and Scripts to Vm Under Kubernetes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. What this article is about Growth in business volume and evolution of business forms require solid and robust IT systems to support them. Business content is transparent to the market, but IT systems can&amp;rsquo;t be built overnight. The competition between companies in the future will mainly come from the competition between IT systems, and the ability to respond quickly to business needs is the key to victory.
IT systems are constantly evolving." /><meta name="keywords" content="Kubernetes, Distribute Files, Vm" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/how-to-distribute-files-and-scripts-to-vm-under-kubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to Distribute Files and Scripts to Vm Under Kubernetes" />
<meta property="og:description" content="1. What this article is about Growth in business volume and evolution of business forms require solid and robust IT systems to support them. Business content is transparent to the market, but IT systems can&rsquo;t be built overnight. The competition between companies in the future will mainly come from the competition between IT systems, and the ability to respond quickly to business needs is the key to victory.
IT systems are constantly evolving." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/how-to-distribute-files-and-scripts-to-vm-under-kubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-21T09:49:30+08:00" />
<meta property="article:modified_time" content="2022-03-21T09:49:30+08:00" />

<meta itemprop="name" content="How to Distribute Files and Scripts to Vm Under Kubernetes">
<meta itemprop="description" content="1. What this article is about Growth in business volume and evolution of business forms require solid and robust IT systems to support them. Business content is transparent to the market, but IT systems can&rsquo;t be built overnight. The competition between companies in the future will mainly come from the competition between IT systems, and the ability to respond quickly to business needs is the key to victory.
IT systems are constantly evolving."><meta itemprop="datePublished" content="2022-03-21T09:49:30+08:00" />
<meta itemprop="dateModified" content="2022-03-21T09:49:30+08:00" />
<meta itemprop="wordCount" content="1760">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to Distribute Files and Scripts to Vm Under Kubernetes"/>
<meta name="twitter:description" content="1. What this article is about Growth in business volume and evolution of business forms require solid and robust IT systems to support them. Business content is transparent to the market, but IT systems can&rsquo;t be built overnight. The competition between companies in the future will mainly come from the competition between IT systems, and the ability to respond quickly to business needs is the key to victory.
IT systems are constantly evolving."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to Distribute Files and Scripts to Vm Under Kubernetes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-21 09:49:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1760 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-what-this-article-is-about">1. What this article is about</a></li>
        <li><a href="#2-why-you-need-a-paas-platform">2. Why You Need a PaaS Platform</a></li>
        <li><a href="#3-how-to-implement-file-distribution-script-execution">3. How to implement file distribution, script execution</a>
          <ul>
            <li><a href="#31-in-a-traditional-paas-platform">3.1 In a traditional PaaS platform</a></li>
            <li><a href="#32-under-kubernetes">3.2 Under Kubernetes</a></li>
          </ul>
        </li>
        <li><a href="#4-kubernetes-distributes-files-executes-script-plans">4. Kubernetes distributes files, executes script plans</a>
          <ul>
            <li><a href="#41-preparing-for-the-walkthrough">4.1 Preparing for the walkthrough</a></li>
            <li><a href="#42-content-of-the-exercise">4.2 Content of the exercise</a></li>
            <li><a href="#43-objectives-of-the-walkthrough">4.3 Objectives of the walkthrough</a></li>
          </ul>
        </li>
        <li><a href="#5-kubernetes-distributes-files-executes-scripts">5. Kubernetes distributes files, executes scripts</a>
          <ul>
            <li><a href="#51-cluster-description">5.1 Cluster description</a></li>
            <li><a href="#52-preparing-distribution-files-and-executing-scripts">5.2 Preparing distribution files and executing scripts</a></li>
            <li><a href="#53-building-images">5.3 Building images</a></li>
            <li><a href="#54-kubernetes-node-preprocessing">5.4 Kubernetes Node Preprocessing</a></li>
            <li><a href="#55-distribute-scripts-to-specified-nodes-and-execute-them">5.5 Distribute scripts to specified nodes and execute them</a></li>
            <li><a href="#56-distribute-files-to-the-specified-node">5.6 Distribute files to the specified node</a></li>
          </ul>
        </li>
        <li><a href="#6-summary">6. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-what-this-article-is-about">1. What this article is about</h2>
<p>Growth in business volume and evolution of business forms require solid and robust IT systems to support them. Business content is transparent to the market, but IT systems can&rsquo;t be built overnight. The competition between companies in the future will mainly come from the competition between IT systems, and the ability to respond quickly to business needs is the key to victory.</p>
<p>IT systems are constantly evolving. The cost of building efficient and intelligent IT systems is very high. At first, it only needs to be enough, then it is good, and finally it becomes the core competence.</p>
<p>Change is not scary, what is scary is the heavy historical baggage. For technicians, new requirements are not difficult, what is difficult is replacing components at high flight speeds. Both to ensure that the original function is normal, but also to meet the new needs, but also to replace the IT infrastructure.</p>
<p>In making the containerized, Kubernetes-ized transition, how to directly distribute files to virtual machines (VMs) and execute scripts on them is the focus of this paper&rsquo;s thinking. Directly manipulating VMs does not fit the definition of cloud-native immutable infrastructure, but historical business scenarios require that a solution be provided as an IT platform party. This paper will provide an answer to this.</p>
<h2 id="2-why-you-need-a-paas-platform">2. Why You Need a PaaS Platform</h2>
<p>When an IT Ops team starts building PaaS, they are really standing up.</p>
<p>In the current environment, business models and patterns are no longer trade secrets. The rapid flow of information and people has put companies in a naked confrontation with each other. I can have the business you have, and you can add the features I have. The era of short-time explosive business growth has passed, and we are in an era of refined operation and data-based decision making.</p>
<p>The new era has more demands on IT system, and these demands cannot be met in the traditional model. The traditional model is to develop SaaS services for specific scenarios, encapsulating skills in fixed processes, reducing costs and increasing efficiency, and controlling risks. This is also sufficient in the early days, but as the business scale grows, operations and maintenance staff will be caught in endless overtime to change and add features.</p>
<p>The purpose of PaaS is to abstract some public functionality. The middle office is also built in such a way that the unchanged domain implementation is landed to the platform and the external service interface is provided. Let the front-end is directly bound to the business to cope with the rapid changes in the market.</p>
<p>When there is a PaaS platform, IT skills will have a direction of sedimentation, and IT personnel can be taken out of the repetitive and complicated tasks to think about the business, and through the collocation can quickly support the business.</p>
<h2 id="3-how-to-implement-file-distribution-script-execution">3. How to implement file distribution, script execution</h2>
<h3 id="31-in-a-traditional-paas-platform">3.1 In a traditional PaaS platform</h3>
<p>If you ask a maintenance person to distribute a file or execute a script in bulk, he can do it quickly using Ansible.</p>
<p>But the above mentions the need to free up your hands and build a PaaS platform. Here is a diagram of a traditional IT facility architecture.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/21/b2ef6309d6744aaf8223f6e8d1221f14.png" alt="diagram of a traditional IT facility architecture"></p>
<p>In the traditional IT process, each machine purchased needs to be registered in CMDB, and then the Agent is installed for management. Through the file and script pipeline provided by Agent, the upper platform can realize the function of file distribution and script execution.</p>
<p>However, the development cost of Agent is very high. In some open source solutions, Agent is not open source as the core of company IT.</p>
<h3 id="32-under-kubernetes">3.2 Under Kubernetes</h3>
<p>In a cloud-native context, it is not allowed to directly modify the state of the IaaS tier VMs, called immutable infrastructure. In some practices, SSHD is even disabled for the container, and the container will instantly exit once an SSH login is available.</p>
<p>Distributing files and executing scripts directly to nodes is not advocated under Kubernetes.</p>
<p>The logic of immutable infrastructure (IaC) is designed to ensure that state is reproducible, consistent with declarative semantics. Directly modifying the infrastructure is a procedural operation where the infrastructure is in a running state with a lot of uncertainty and cannot be accurately described.</p>
<p>Below is a diagram of the IT facility architecture under cloud-native.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/21/df352c90667c409bb8bed266b91d0de0.png" alt="diagram of the IT facility architecture under cloud-native"></p>
<p>Kubernetes takes over the resources of the IaaS layer and controls the operation of the whole system. The services of the business are mainly distributed through the image repository, and the log collection and monitoring of the business need to be done with other open source components.</p>
<h2 id="4-kubernetes-distributes-files-executes-script-plans">4. Kubernetes distributes files, executes script plans</h2>
<h3 id="41-preparing-for-the-walkthrough">4.1 Preparing for the walkthrough</h3>
<p>Here is the list:</p>
<ul>
<li>A Kuberentes cluster, which needs to be able to execute the kubectl command</li>
<li>VMs to be distributed have been added to the cluster nodes</li>
<li>Docker environment and Dockerhub account</li>
</ul>
<h3 id="42-content-of-the-exercise">4.2 Content of the exercise</h3>
<p>The walkthrough is divided into the following steps:</p>
<ol>
<li>prepare scripts and files for execution</li>
<li>Build and push the image</li>
<li>create Kubernetes Jobs for distribution</li>
</ol>
<h3 id="43-objectives-of-the-walkthrough">4.3 Objectives of the walkthrough</h3>
<p>The goals of the walkthrough are as follows:</p>
<ul>
<li>Run a web service on a virtual machine that provides file downloading capabilities</li>
<li>Distribute a file to the virtual machine and add it to the download service</li>
</ul>
<h2 id="5-kubernetes-distributes-files-executes-scripts">5. Kubernetes distributes files, executes scripts</h2>
<h3 id="51-cluster-description">5.1 Cluster description</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get node -o wide

NAME   STATUS   ROLES           AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
<span class="nb">test</span>   Ready    master,worker   6d2h   v1.17.9   10.160.6.35   &lt;none&gt;        CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>   3.10.0-957.21.3.el7.x86_64   docker://20.10.6
</code></pre></td></tr></table>
</div>
</div><p>Due to budget constraints, a multi-node environment is not laid out here. However, in order to fit the real scenario, nodeSelector is used to select the specified nodes during Job execution without letting the distribution process get out of control.</p>
<h3 id="52-preparing-distribution-files-and-executing-scripts">5.2 Preparing distribution files and executing scripts</h3>
<ol>
<li>
<p>file directory structure</p>
<ul>
<li>demo</li>
<li>Dockerfile</li>
<li>start.sh</li>
</ul>
<p>The following commands related to building the image are executed in the demo directory.</p>
</li>
<li>
<p>script start.sh content</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">cd</span> /data
nohup python -m SimpleHTTPServer 8000<span class="p">&amp;</span>
</code></pre></td></tr></table>
</div>
</div><p>The Kubernetes cluster is using the CentOS 7 operating system, which comes with a Python 2 interpreter. Here, for simplicity, we use <code>SimpleHTTPServer</code> to provide the download service.</p>
</li>
<li>
<p>Dockerfile content</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> docker.io/alpine:3.12</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> file<span class="err">
</span><span class="err"></span><span class="k">ADD</span> <span class="si">${</span><span class="nv">file</span><span class="si">}</span> /data/<span class="err">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Contents of the file to be distributed</p>
<p>The file can be a local file in the build environment, or can be any URL file link. Here I chose a PDF file link:<code>https://www.chenshaowen.com/static/file/ui-autotest.pdf</code></p>
</li>
</ol>
<h3 id="53-building-images">5.3 Building images</h3>
<p>OCI images are common in Kubernetes, so you need to package files and scripts into images and distribute them through the image repository.</p>
<ul>
<li>
<p>Package the files to be distributed into a image</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --build-arg <span class="nv">file</span><span class="o">=</span>https://www.chenshaowen.com/static/file/ui-autotest.pdf -t shaowenchen/file-1:latest ./
</code></pre></td></tr></table>
</div>
</div><p>Push image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker push shaowenchen/file-1:latest 
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Package the script to be executed into the image</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --build-arg <span class="nv">file</span><span class="o">=</span>./start.sh -t shaowenchen/shell-1:latest ./
</code></pre></td></tr></table>
</div>
</div><p>Push</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker push shaowenchen/shell-1:latest 
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>View images in Dockerhub</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/21/a1dbddf598f948d5bf2ace264e1c98f2.png" alt="images in Dockerhub"></p>
</li>
</ul>
<h3 id="54-kubernetes-node-preprocessing">5.4 Kubernetes Node Preprocessing</h3>
<p>In addition to the nodes to be distributed that need to be added to the Kubernetes cluster, another important area is the preprocessing of the nodes.</p>
<p>Node preprocessing is mainly about adding labels to nodes to mark them for accurate distribution. In production, the network is usually partitioned, so two dimensions of labeling are introduced: zone and ip.</p>
<ul>
<li>Labeling nodes zone, ip</li>
</ul>
<p>zone indicates the partition, here labeled a. ip indicates the IP address of the virtual machine in this partition. In practice, this can be handled in bulk when installing a Kubernetes cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl label node <span class="nb">test</span> <span class="nv">zone</span><span class="o">=</span>a
kubectl label node <span class="nb">test</span> <span class="nv">ip</span><span class="o">=</span>10.160.6.35
</code></pre></td></tr></table>
</div>
</div><ul>
<li>View tagged tags</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get nodes --show-labels

NAME   STATUS   ROLES           AGE    VERSION   LABELS
<span class="nb">test</span>   Ready    master,worker   6d2h   v1.17.9   beta.kubernetes.io/arch<span class="o">=</span>amd64,beta.kubernetes.io/os<span class="o">=</span>linux,ip<span class="o">=</span>10.160.6.35,kubernetes.io/arch<span class="o">=</span>amd64,kubernetes.io/hostname<span class="o">=</span>test,kubernetes.io/os<span class="o">=</span>linux,node-role.kubernetes.io/master<span class="o">=</span>,node-role.kubernetes.io/worker<span class="o">=</span>,zone<span class="o">=</span>a
</code></pre></td></tr></table>
</div>
</div><h3 id="55-distribute-scripts-to-specified-nodes-and-execute-them">5.5 Distribute scripts to specified nodes and execute them</h3>
<p>Here we mainly use hostpath to mount the files from the container to the host, and then use nsenter to access the namespace of the host to do the operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span><span class="s">apiVersion: batch/v1
</span><span class="s">kind: Job
</span><span class="s">metadata:
</span><span class="s">  name: shell-1
</span><span class="s">spec:
</span><span class="s">  template:
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: shell-1
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: shell-1
</span><span class="s">        command: [&#34;sh&#34;]
</span><span class="s">        args: [&#34;-c&#34;, &#34;cp /data/start.sh /hostdata/; echo &#39;sh /data/start.sh&amp;&#39; | nsenter -t 1 -m -u -i -n;sleep 99999&#34;]
</span><span class="s">        image: shaowenchen/shell-1:latest 
</span><span class="s">        securityContext:
</span><span class="s">          privileged: true
</span><span class="s">        volumeMounts:
</span><span class="s">        - name: hostdata
</span><span class="s">          mountPath: /hostdata
</span><span class="s">      hostIPC: true
</span><span class="s">      hostNetwork: true
</span><span class="s">      hostPID: true
</span><span class="s">      volumes:
</span><span class="s">      - name: hostdata
</span><span class="s">        hostPath:
</span><span class="s">          path: /data/
</span><span class="s">      restartPolicy: Never
</span><span class="s">      nodeSelector:
</span><span class="s">        zone: a
</span><span class="s">        ip: 10.160.6.35
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>Since the image is small, the script gets executed very quickly. Log on to the VM and check if there are any relevant service processes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">ps aux <span class="p">|</span>grep SimpleHTTPServer

root     <span class="m">16523</span>  0.1  0.0 <span class="m">198028</span> <span class="m">10120</span> ?        S    22:38   0:00 python -m SimpleHTTPServer <span class="m">8000</span>
root     <span class="m">17558</span>  0.0  0.0 <span class="m">112684</span>  <span class="m">1000</span> pts/1    S+   22:39   0:00 grep --color<span class="o">=</span>auto SimpleHTTPServer
</code></pre></td></tr></table>
</div>
</div><p>Indicates that the SimpleHTTPServer service has run successfully on the virtual machine.</p>
<h3 id="56-distribute-files-to-the-specified-node">5.6 Distribute files to the specified node</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">cat &lt;&lt;EOF | kubectl apply -f -</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">file-1</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">file-1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">file-1</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;cp -R /data/* /hostdata/; sleep 10&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">shaowenchen/file-1:latest </span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hostdata</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/hostdata</span><span class="w">
</span><span class="w">      </span><span class="nt">hostIPC</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">hostPID</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hostdata</span><span class="w">
</span><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data/</span><span class="w">
</span><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">zone</span><span class="p">:</span><span class="w"> </span><span class="l">a</span><span class="w">
</span><span class="w">        </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">10.160.6.35</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The download page provided can be viewed by visiting the page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/21/b47ff72f3d2941439fe5bfd1de9c958b.png" alt="download page"></p>
<p>View the distributed files on the virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">ls /data/

start.sh  ui-autotest.pdf
</code></pre></td></tr></table>
</div>
</div><h2 id="6-summary">6. Summary</h2>
<p>This article demonstrates how to distribute files and execute scripts for virtual machines under Kubernetes, and gives you some ideas on how to design a PaaS platform.</p>
<ul>
<li>Kubelet is used as a traditional Agent, Kubelet manages Pods and Agent manages IaaS, there are commonalities between the two. In addition, Kubernetes supports up to 5000 nodes in a single cluster, which can meet most of the demand scenarios. More nodes can be supported with multiple clusters.</li>
<li>Binary distribution from more sources can be supported. The example uses https files, or you can use local files, and you can download files from S3 and package them locally. Also, the final image is only a few M larger than the original file.</li>
<li>Script execution can be further optimized. When the Job execution finishes, the script execution will also finish. In practice, you should add hosted services to the host. Here, for the sake of simplicity of demonstration, it is not deeper.</li>
<li>Using a Pod with hostIPC/hostPID directly instead of a service process on a traditional VM is also an option.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/go-s-test-questions/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Can you answer this Go question correctly?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kuberentes-federation/">
            <span class="next-text nav-default">Kubernetes, cluster federation, and resource distribution</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
