<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Creating custom K8s AdmissionWebhooks with Kubebuilder - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Kubebuilder can build AdmissionWebhooks in addition to CRD APIs and their Controllers, and this article will analyze how Kubebuilder builds AdmissionWebhooks in detail.
AdmissionWebhooks for K8s First of all, it is important to know what AdmissionWebhooks is in K8s and what its purpose is.
Let&amp;rsquo;s start with the scenario. If we need to make configuration changes or checks on a pod before it is created, this part of the work would require the administrator to compile it into a binary file in ApiServer, which would be very annoying if the configuration changes were made in a custom form." /><meta name="keywords" content="k8s, Custom, AdmissionWebhooks" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/creating-custom-k8s-admissionwebhooks/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Creating custom K8s AdmissionWebhooks with Kubebuilder" />
<meta property="og:description" content="Kubebuilder can build AdmissionWebhooks in addition to CRD APIs and their Controllers, and this article will analyze how Kubebuilder builds AdmissionWebhooks in detail.
AdmissionWebhooks for K8s First of all, it is important to know what AdmissionWebhooks is in K8s and what its purpose is.
Let&rsquo;s start with the scenario. If we need to make configuration changes or checks on a pod before it is created, this part of the work would require the administrator to compile it into a binary file in ApiServer, which would be very annoying if the configuration changes were made in a custom form." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/creating-custom-k8s-admissionwebhooks/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-11T09:09:19+08:00" />
<meta property="article:modified_time" content="2022-03-11T09:09:19+08:00" />

<meta itemprop="name" content="Creating custom K8s AdmissionWebhooks with Kubebuilder">
<meta itemprop="description" content="Kubebuilder can build AdmissionWebhooks in addition to CRD APIs and their Controllers, and this article will analyze how Kubebuilder builds AdmissionWebhooks in detail.
AdmissionWebhooks for K8s First of all, it is important to know what AdmissionWebhooks is in K8s and what its purpose is.
Let&rsquo;s start with the scenario. If we need to make configuration changes or checks on a pod before it is created, this part of the work would require the administrator to compile it into a binary file in ApiServer, which would be very annoying if the configuration changes were made in a custom form."><meta itemprop="datePublished" content="2022-03-11T09:09:19+08:00" />
<meta itemprop="dateModified" content="2022-03-11T09:09:19+08:00" />
<meta itemprop="wordCount" content="1332">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creating custom K8s AdmissionWebhooks with Kubebuilder"/>
<meta name="twitter:description" content="Kubebuilder can build AdmissionWebhooks in addition to CRD APIs and their Controllers, and this article will analyze how Kubebuilder builds AdmissionWebhooks in detail.
AdmissionWebhooks for K8s First of all, it is important to know what AdmissionWebhooks is in K8s and what its purpose is.
Let&rsquo;s start with the scenario. If we need to make configuration changes or checks on a pod before it is created, this part of the work would require the administrator to compile it into a binary file in ApiServer, which would be very annoying if the configuration changes were made in a custom form."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Creating custom K8s AdmissionWebhooks with Kubebuilder</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-11 09:09:19 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1332 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#admissionwebhooks-for-k8s">AdmissionWebhooks for K8s</a></li>
        <li><a href="#creating-custom-admissionwebhooks">Creating Custom AdmissionWebhooks</a>
          <ul>
            <li><a href="#initialize-api-and-controller">Initialize API and Controller</a></li>
            <li><a href="#creating-a-webhook-server">Creating a Webhook Server</a></li>
            <li><a href="#running-webhook-server">Running Webhook Server</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Kubebuilder can build AdmissionWebhooks in addition to CRD APIs and their Controllers, and this article will analyze how Kubebuilder builds AdmissionWebhooks in detail.</p>
<h2 id="admissionwebhooks-for-k8s">AdmissionWebhooks for K8s</h2>
<p>First of all, it is important to know what AdmissionWebhooks is in K8s and what its purpose is.</p>
<p>Let&rsquo;s start with the scenario. If we need to make configuration changes or checks on a pod before it is created, this part of the work would require the administrator to compile it into a binary file in ApiServer, which would be very annoying if the configuration changes were made in a custom form. Admission controllers are tools for this scenario, and are attached to ApiServer in the form of plug-ins, of which AdmissionWebhooks is one.</p>
<p>K8s' AdmissionWebhooks are of two kinds: <code>MutatingAdmissionWebhook</code> and <code>ValidatingAdmissionWebhook</code>, which together are a special type of <code>admission controllers</code>, one dealing with resource changes and the other with validation.</p>
<p><code>MutatingAdmissionWebhook</code> does three main things.</p>
<ol>
<li>MutatingWebhookConfiguration: the configuration for MutatingAdmissionWebhook to register itself with the ApiServer.</li>
<li>MutatingAdmissionWebhook itself: an admission controller in the form of a plugin that needs to register itself with the ApiServer.</li>
<li>Webhook Admission Server: an http server attached to the k8s ApiServer that receives requests from the ApiServer.</li>
</ol>
<p>If we use Kubebuilder to build AdmissionWebhooks, Kubebuilder will automatically generate the Webhook Server for us and leave a few functions for us to add our own logic.</p>
<h2 id="creating-custom-admissionwebhooks">Creating Custom AdmissionWebhooks</h2>
<p>Here&rsquo;s a demo using a simple scenario where we customize a resource called App, and when a user creates an App instance, we create a Deployment based on the user&rsquo;s description.</p>
<p>Then we add a <code>MutatingAdmissionWebhook</code> that automatically adds a sidecar container to the Pod when the user creates a Deployment via the App (using nginx as the sidecar here).</p>
<h3 id="initialize-api-and-controller">Initialize API and Controller</h3>
<p>The first step is to create the CRD and its Controller, which can be done with a few lines of command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">export</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on

$ mkdir <span class="nv">$GOPATH</span>/src/zww-app
$ <span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/zww-app
$ kubebuilder init --domain o0w0o.cn --owner <span class="s2">&#34;zwwhdls&#34;</span>

$ kubebuilder create api --group app --version v1 --kind App
</code></pre></td></tr></table>
</div>
</div><p>What I&rsquo;ve done here is relatively simple. The <code>AppSpec</code> only defines a deploy property (which is <code>appsv1.DeploymentSpec</code>), and the Controller generates the corresponding Deployment based on the deploy property.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">AppSpec</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span><span class="c1"></span>	<span class="c1">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span><span class="c1"></span>	<span class="nx">Deploy</span> <span class="nx">appsv1</span><span class="p">.</span><span class="nx">DeploymentSpec</span> <span class="s">`json:&#34;deploy,omitempty&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After refining the <code>Reconcile</code> functions of <code>AppSpec</code> and Controller, make Kubebuilder regenerate the code and apply the CRD yaml under <code>config/crd</code> to the current cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">make
make install
</code></pre></td></tr></table>
</div>
</div><h3 id="creating-a-webhook-server">Creating a Webhook Server</h3>
<p>The next step is to use Kubebuilder to generate Webhooks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubebuilder create webhook --group app --version v1 --kind App
</code></pre></td></tr></table>
</div>
</div><p>A file named <code>app_webhook.go</code> is generated under the path <code>api/v1</code>. You can see that Kubebuilder has defined two variables for you.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">var _ webhook.Defaulter <span class="o">=</span> <span class="p">&amp;</span>App<span class="o">{}</span>
var _ webhook.Validator <span class="o">=</span> <span class="p">&amp;</span>App<span class="o">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>These two variables represent MutatingWebhookServer and ValidatingWebhookServer respectively, which will run up when the program starts.</p>
<p>For MutatingWebhookServer, Kubebuilder reserves the <code>Default()</code> function for users to fill in their own logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Default implements webhook.Defaulter so a webhook will be registered for the type
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nf">Default</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">applog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>

	<span class="c1">// TODO(user): fill in your defaulting logic.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For what kind of changes we want the Webhook to trigger when the resource changes, you can modify it with this comment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// +kubebuilder:webhook:path<span class="o">=</span>/mutate-app-o0w0o-cn-v1-app,mutating<span class="o">=</span>true,failurePolicy<span class="o">=</span>fail,groups<span class="o">=</span>app.o0w0o.cn,resources<span class="o">=</span>apps,verbs<span class="o">=</span>create<span class="p">;</span>update,versions<span class="o">=</span>v1,name<span class="o">=</span>mapp.kb.io
</code></pre></td></tr></table>
</div>
</div><p>The corresponding parameters are.</p>
<ul>
<li>failurePolicy: indicates the failure policy when the ApiServer cannot communicate with the webhook server, takes the value of &ldquo;ignore&rdquo; or &ldquo;fail&rdquo;.</li>
<li>groups: indicates the Api Group under which this webhook will receive requests.</li>
<li>mutating: this parameter is a bool type, indicating whether it is a mutating type.</li>
<li>name: the name of the webhook, which should correspond to the configuration.</li>
<li>path: the path of the webhook.</li>
<li>resources: indicates which resource the webhook will receive a request for when it changes.</li>
<li>verbs: indicates the webhook will receive requests for which resource changes, and takes the values &ldquo;create&rdquo;, &ldquo;update&rdquo;, &ldquo;delete&rdquo;, &ldquo;connect&rdquo;, or &ldquo;*&rdquo; (i.e., all).</li>
<li>versions: indicates at which version of the resource this webhook will receive a request when it changes.</li>
</ul>
<p>For ValidatingWebhookServer, Kubebuilder handles it in the same way as MutatingWebhookServer, so I won&rsquo;t go over it here.</p>
<p>For convenience, I only defined the <code>Default</code> function of MutatingWebhookServer to inject an nginx sidecar container for each pod of App-type resources.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nf">Default</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">applog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">cns</span> <span class="p">[]</span><span class="nx">core</span><span class="p">.</span><span class="nx">Container</span>
	<span class="nx">cns</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Deploy</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span>

	<span class="nx">container</span> <span class="o">:=</span> <span class="nx">core</span><span class="p">.</span><span class="nx">Container</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;sidecar-nginx&#34;</span><span class="p">,</span>
		<span class="nx">Image</span><span class="p">:</span> <span class="s">&#34;nginx:1.12.2&#34;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">cns</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cns</span><span class="p">,</span> <span class="nx">container</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Deploy</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span> <span class="p">=</span> <span class="nx">cns</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="running-webhook-server">Running Webhook Server</h3>
<p>This article only shares the debugging solution for local development testing, please refer to the <a href="https://book.kubebuilder.io/cronjob-tutorial/running.html">official documentation</a> for the online deployment solution.</p>
<p>First, you need to modify MutatingWebhookConfiguration slightly to make ApiServer communicate with Webhook Server. The specific method is as follows.</p>
<h4 id="configuring-server-path">Configuring Server Path</h4>
<p>The first step is to configure Server Path; remove the service and replace it with <code>url: https://&lt;server_ip&gt;:9443/mutate-app-o0w0o-cn-v1-app</code>, where <code>server_ip</code> is the ip of the Webhook Server, or if running locally, the local ip. Note that the path in the url should be the same as the one defined in <code>app_webhook.go</code>.</p>
<h4 id="configure-the-certificate">Configure the certificate</h4>
<p>The second step is to configure caBundle; since all components interacting with ApiServer in Kube require bi-directional TLS authentication with ApiServer, we need to manually issue a self-signed CA certificate here first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ openssl genrsa -out ca.key <span class="m">2048</span>
$ openssl req -x509 -new -nodes -key ca.key -subj <span class="s2">&#34;/CN=&lt;server_ip&gt;&#34;</span> -days <span class="m">10000</span> -out ca.crt
$ openssl genrsa -out server.key <span class="m">2048</span>
$ cat <span class="s">&lt;&lt; EOF &gt;csr.conf
</span><span class="s">&gt; [ req ]
</span><span class="s">&gt; default_bits = 2048
</span><span class="s">&gt; prompt = no
</span><span class="s">&gt; default_md = sha256
</span><span class="s">&gt; req_extensions = req_ext
</span><span class="s">&gt; distinguished_name = dn
</span><span class="s">&gt; 
</span><span class="s">&gt; [ dn ]
</span><span class="s">&gt; C = &lt;country&gt;
</span><span class="s">&gt; ST = &lt;state&gt;
</span><span class="s">&gt; L = &lt;city&gt;
</span><span class="s">&gt; O = &lt;organization&gt;
</span><span class="s">&gt; OU = &lt;organization unit&gt;
</span><span class="s">&gt; CN = &lt;server_ip&gt;
</span><span class="s">&gt; 
</span><span class="s">&gt; [ req_ext ]
</span><span class="s">&gt; subjectAltName = @alt_names
</span><span class="s">&gt; 
</span><span class="s">&gt; [ alt_names ]
</span><span class="s">&gt; IP.1 = &lt;server_ip&gt;
</span><span class="s">&gt; 
</span><span class="s">&gt; [ v3_ext ]
</span><span class="s">&gt; authorityKeyIdentifier=keyid,issuer:always
</span><span class="s">&gt; basicConstraints=CA:FALSE
</span><span class="s">&gt; keyUsage=keyEncipherment,dataEncipherment
</span><span class="s">&gt; extendedKeyUsage=serverAuth,clientAuth
</span><span class="s">&gt; subjectAltName=@alt_names
</span><span class="s">&gt; EOF</span>
$ openssl req -new -key server.key -out server.csr -config csr.conf
$ openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days <span class="m">10000</span> -extensions v3_ext -extfile csr.conf
</code></pre></td></tr></table>
</div>
</div><p>After certificate generation, copy <code>server.key</code> and <code>server.crt</code> to the private key and certificate path of the webhook server set by Kubebuilder: <code>$(TMPDIR)/k8s-webhook-server/serving-certs/tls.key</code>.</p>
<ul>
<li>Path to the private key of the webhook server: <code>$(TMPDIR)/k8s-webhook-server/serving-certs/tls.key</code></li>
<li>Path to webhook server&rsquo;s certificate: <code>$(TMPDIR)/k8s-webhook-server/serving-certs/tls.crt</code></li>
</ul>
<p><em>Note: If $(TMPDIR) is empty, the default path is &ldquo;/tmp/k8s-webhook-server/&hellip;&rdquo; but the default path for android is &ldquo;/data/local/tmp/k8s-webhook-server/&hellip;&rdquo;.</em></p>
<p>And the caBundle in MutatingWebhookConfiguration is the base64 encoded result of ca.crt. The final yaml result is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">admissionregistration.k8s.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MutatingWebhookConfiguration</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mutating-webhook-configuration</span><span class="w">
</span><span class="w"></span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">clientConfig</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJTiBDRVJ...FLS0tLS0=</span><span class="w">
</span><span class="w">  </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">https://&lt;server_ip&gt;:9443/mutate-app-o0w0o-cn-v1-app</span><span class="w">
</span><span class="w">  </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Fail</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mapp.kb.io</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ValidatingWebhookConfiguration is similar to MutatingWebhookConfiguration, just note that the server path is the same as in <code>app_webhook.go</code>. After both configuration files are modified, apply them in the cluster.</p>
<h4 id="runs">runs</h4>
<p>Finally, run the CRD Controller and Webhook Server directly locally.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">make run
</code></pre></td></tr></table>
</div>
</div><h4 id="verification">Verification</h4>
<p>Simply run an app and try it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">app.o0w0o.cn/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">App</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-sample</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">app-sample</span><span class="w">
</span><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample</span><span class="w">
</span><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">app-sample</span><span class="w">
</span><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cn</span><span class="w">
</span><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">daocloud.io/library/redis:4.0.14-alpine</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>To see if the sidecar container has been injected.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f config/samples/app_v1_app.yaml
$ kubectl get app
NAME         AGE
app-sample   43s
$ kubectl get deploy
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
app-sample-deploy   0/1     <span class="m">1</span>            <span class="m">0</span>           43s
$ kubectl get po
NAME                                 READY   STATUS              RESTARTS   AGE
app-sample-deploy-5b5cfb9c9b-z8jk5   0/2     ContainerCreating   <span class="m">0</span>          43s
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/operator-framework/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Build and maintain operators using the Operator Framework toolkit</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/golang-concurrency-programming-tips/">
            <span class="next-text nav-default">Golang Common Concurrency Programming Tips</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
