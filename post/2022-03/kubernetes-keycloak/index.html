<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Unified User Management for Kubernetes with KeyCloak - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="As we all know, in the K8s permission management system, you can bind RoleBinding to ServiceAccount, User and Group to achieve permission assignment.
We often use ServiceAccount to restrict the permissions of a pod; for User and Group, there are no specific resources to correspond to them except for some special system groups, which is very unfriendly to the user management in traditional projects.
This article talks about how to unify user management in K8s clusters." /><meta name="keywords" content="kubernetes, Keycloak" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/kubernetes-keycloak/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Unified User Management for Kubernetes with KeyCloak" />
<meta property="og:description" content="As we all know, in the K8s permission management system, you can bind RoleBinding to ServiceAccount, User and Group to achieve permission assignment.
We often use ServiceAccount to restrict the permissions of a pod; for User and Group, there are no specific resources to correspond to them except for some special system groups, which is very unfriendly to the user management in traditional projects.
This article talks about how to unify user management in K8s clusters." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/kubernetes-keycloak/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-11T09:37:24+08:00" />
<meta property="article:modified_time" content="2022-03-11T09:37:24+08:00" />

<meta itemprop="name" content="Unified User Management for Kubernetes with KeyCloak">
<meta itemprop="description" content="As we all know, in the K8s permission management system, you can bind RoleBinding to ServiceAccount, User and Group to achieve permission assignment.
We often use ServiceAccount to restrict the permissions of a pod; for User and Group, there are no specific resources to correspond to them except for some special system groups, which is very unfriendly to the user management in traditional projects.
This article talks about how to unify user management in K8s clusters."><meta itemprop="datePublished" content="2022-03-11T09:37:24+08:00" />
<meta itemprop="dateModified" content="2022-03-11T09:37:24+08:00" />
<meta itemprop="wordCount" content="1350">
<meta itemprop="keywords" content="kubernetes,keycloak," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Unified User Management for Kubernetes with KeyCloak"/>
<meta name="twitter:description" content="As we all know, in the K8s permission management system, you can bind RoleBinding to ServiceAccount, User and Group to achieve permission assignment.
We often use ServiceAccount to restrict the permissions of a pod; for User and Group, there are no specific resources to correspond to them except for some special system groups, which is very unfriendly to the user management in traditional projects.
This article talks about how to unify user management in K8s clusters."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Unified User Management for Kubernetes with KeyCloak</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-11 09:37:24 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1350 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preparation">Preparation</a>
          <ul>
            <li><a href="#configuration-in-keycloak">Configuration in KeyCloak</a></li>
            <li><a href="#configuration-of-apiserver">Configuration of ApiServer</a></li>
            <li><a href="#kubeconfig-configuration">KubeConfig configuration</a></li>
          </ul>
        </li>
        <li><a href="#user-management">User Management</a>
          <ul>
            <li><a href="#rbac">RBAC</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>As we all know, in the K8s permission management system, you can bind RoleBinding to ServiceAccount, User and Group to achieve permission assignment.</p>
<p>We often use ServiceAccount to restrict the permissions of a pod; for User and Group, there are no specific resources to correspond to them except for some special system groups, which is very unfriendly to the user management in traditional projects.</p>
<p>This article talks about how to unify user management in K8s clusters.</p>
<h2 id="preparation">Preparation</h2>
<p>First we need an Identity Provider to unify the management of users in K8s and provide OIDC protocol services, this article uses KeyCloak as the Identity Provider.</p>
<h3 id="configuration-in-keycloak">Configuration in KeyCloak</h3>
<p>To implement user management, we need to use the concept of group in K8s to assign privileges to a group of users, which requires the use of the Claim concept in the OIDC protocol to implement the grouping of users in K8s.</p>
<p>Claim is the information carried in the ID Token, which refers to the range of information requested by the client, such as user name, email address, etc., and these can be extended to carry some information about the group to which the user belongs, etc.</p>
<p>So the first step is to extend the Claim in KeyCloak, as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/eb62444cc3d8436ea269b6986e35c48b.png" alt="Configuration in KeyCloak"></p>
<p>We added a &ldquo;User Attribute&rdquo; to the Client and added it to the ID Token; Multivalued must be set to ON to ensure that the value of the &ldquo;groups&rdquo; Claim is a String array, where each value represents a group to which the User A User can belong to multiple groups at the same time, and each value is separated by a comma.</p>
<p>The second step is to set the &ldquo;groups&rdquo; property for the user.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/972b00c9062648b286125e21b45cbf38.png" alt="Configuration in KeyCloak"></p>
<p>Once everything is set up, you can see the &ldquo;groups&rdquo; attribute in the ID Token of the user &ldquo;admin&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;jti&#34;</span><span class="p">:</span><span class="s2">&#34;9259af9c-8a3d-45ff-94f6-6780f2a79580&#34;</span><span class="p">,</span>
    <span class="nt">&#34;exp&#34;</span><span class="p">:</span><span class="mi">1564739637</span><span class="p">,</span>
    <span class="nt">&#34;nbf&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;iat&#34;</span><span class="p">:</span><span class="mi">1564739337</span><span class="p">,</span>
    <span class="nt">&#34;iss&#34;</span><span class="p">:</span><span class="s2">&#34;https://172.16.105.1:8082/auth/realms/hdls&#34;</span><span class="p">,</span>
    <span class="nt">&#34;aud&#34;</span><span class="p">:</span><span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span>
    <span class="nt">&#34;sub&#34;</span><span class="p">:</span><span class="s2">&#34;f846ddb1-4435-429f-9ce5-faba7a791d43&#34;</span><span class="p">,</span>
    <span class="nt">&#34;typ&#34;</span><span class="p">:</span><span class="s2">&#34;ID&#34;</span><span class="p">,</span>
    <span class="nt">&#34;azp&#34;</span><span class="p">:</span><span class="s2">&#34;kubernetes&#34;</span><span class="p">,</span>
    <span class="nt">&#34;auth_time&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;session_state&#34;</span><span class="p">:</span><span class="s2">&#34;37b1a2ca-1b3b-4c61-ae2c-f8c14818ca6e&#34;</span><span class="p">,</span>
    <span class="nt">&#34;acr&#34;</span><span class="p">:</span><span class="s2">&#34;1&#34;</span><span class="p">,</span>
    <span class="nt">&#34;email_verified&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
    <span class="nt">&#34;groups&#34;</span><span class="p">:[</span>
        <span class="s2">&#34;manager&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;preferred_username&#34;</span><span class="p">:</span><span class="s2">&#34;admin&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="configuration-of-apiserver">Configuration of ApiServer</h3>
<p>There are several configurable environment variables left in ApiServer to support the OIDC plugin, <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server">official link</a>.</p>
<p><code>oidc-issuer-url</code> : URL of OIDC Server, only accepts https protocol.
<code>oidc-client-id</code> : The client_id configured in OIDC Server, which is unique.
<code>oidc-username-claim</code> : Specify the claim used to identify the user name in the ID Token.
<code>oidc-username-prefix</code> : Username prefix, &ldquo;-&rdquo; means no prefix.
<code>oidc-groups-claim</code> : A claim in the ID Token that identifies the user&rsquo;s group. The claim must be in the form of an array, so the user can belong to multiple groups.
<code>oidc-groups-prefix</code> : group prefix.
<code>oidc-ca-file</code>: the path where the CA certificate of Identity Provider is located.</p>
<p>The configuration parameters of this article are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">    - --oidc-issuer-url<span class="o">=</span>https://172.16.105.1:8082/auth/realms/hdls
    - --oidc-client-id<span class="o">=</span>kubernetes
    - --oidc-username-claim<span class="o">=</span>preferred_username
    - --oidc-username-prefix<span class="o">=</span>-
    - --oidc-groups-claim<span class="o">=</span>groups
    - --oidc-ca-file<span class="o">=</span>/etc/kubernetes/pki/ca.crt
</code></pre></td></tr></table>
</div>
</div><h3 id="kubeconfig-configuration">KubeConfig configuration</h3>
<p>As a user, we need to access the API Server through the Client Application. kubectl is obviously the preferred Client, so that kubectl can access Kubernetes as the user we created, &ldquo;admin&rdquo;, and pass the authentication, and this requires a configuration of KubeConfig to complete the following processes.</p>
<ol>
<li>create a kubeconfig user: &ldquo;admin&rdquo;.</li>
<li>Configure client-id, client credential, id-token, refresh-token, certficaite, etc. for &ldquo;admin&rdquo;.</li>
<li>Create a user context for &ldquo;admin&rdquo;.</li>
<li>Set it to the current context.</li>
</ol>
<p>The following command generates the configuration with one click.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl config set-credentials USER_NAME <span class="se">\
</span><span class="se"></span>   --auth-provider<span class="o">=</span>oidc <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>idp-issuer-url<span class="o">=(</span> issuer url <span class="o">)</span> <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>client-id<span class="o">=(</span> your client id <span class="o">)</span> <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>client-secret<span class="o">=(</span> your client secret <span class="o">)</span> <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>refresh-token<span class="o">=(</span> your refresh token <span class="o">)</span> <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>idp-certificate-authority<span class="o">=(</span> path to your ca certificate <span class="o">)</span> <span class="se">\
</span><span class="se"></span>   --auth-provider-arg<span class="o">=</span>id-token<span class="o">=(</span> your id_token <span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="how-to-get-token">How to get Token</h4>
<p>There are various ways to generate ID Token and Refresh Token, the easiest way is to use curl to authenticate with Password Grant to get the desired ID Token and Refresh Token.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ curl -k <span class="s1">&#39;https://172.16.105.1:8082/auth/realms/hdls/protocol/openid-connect/token&#39;</span> -d <span class="s2">&#34;client_id=kubernetes&#34;</span> -d <span class="s2">&#34;client_secret=40dc1fef...c3eeec6&#34;</span> -d <span class="s2">&#34;response_type=code token&#34;</span> -d <span class="s2">&#34;grant_type=password&#34;</span> -d <span class="s2">&#34;username=test&#34;</span> -d <span class="s2">&#34;password=dangerous&#34;</span> -d <span class="s2">&#34;scope=openid&#34;</span>
<span class="o">{</span>
    <span class="s2">&#34;access_token&#34;</span>:<span class="s2">&#34;eyJhbGciOiJSU...0CMPw&#34;</span>,
    <span class="s2">&#34;expires_in&#34;</span>:300,
    <span class="s2">&#34;refresh_expires_in&#34;</span>:1800,
    <span class="s2">&#34;refresh_token&#34;</span>:<span class="s2">&#34;eyJhbGciOiJ...W1VUA&#34;</span>,
    <span class="s2">&#34;token_type&#34;</span>:<span class="s2">&#34;bearer&#34;</span>,
    <span class="s2">&#34;id_token&#34;</span>:<span class="s2">&#34;eyJhbGc...z3TaGJGQ&#34;</span>,
    <span class="s2">&#34;not-before-policy&#34;</span>:0,
    <span class="s2">&#34;session_state&#34;</span>:<span class="s2">&#34;2845e...92ff2&#34;</span>,
    <span class="s2">&#34;scope&#34;</span>:<span class="s2">&#34;openid profile email&#34;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, this requires manually generating a Token and filling it into KubeConfig each time, which is a pain. The good news is that there are already many tools in the community that can automatically write Token into KubeConfig for you that work very well, such as</p>
<ol>
<li><a href="https://github.com/int128/kubelogin">kubelogin</a></li>
<li><a href="https://github.com/vimond/k8s-auth-client">k8s-auth-client</a></li>
<li><a href="https://github.com/making/k8s-keycloak-oidc-helper">k8s-keycloak-oidc-helper</a></li>
<li><a href="https://github.com/negz/kuberos">kuberos</a></li>
<li><a href="https://github.com/micahhausler/k8s-oidc-helper">k8s-oidc-helper</a></li>
</ol>
<h2 id="user-management">User Management</h2>
<p>After getting everything configured successfully, let&rsquo;s look at assigning permissions to users. This takes into account K8s' RBAC system.</p>
<h3 id="rbac">RBAC</h3>
<p>For users with group manager, we assign them the &ldquo;cluster-admin&rdquo; role which comes with the system, i.e. the administrator privileges of the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">keycloak-admin-group</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">manager</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We &ldquo;add&rdquo; the admin user to the &ldquo;manager&rdquo; group in keyCloak.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/5e1e1a0d2c844cc1ad7e384709227923.png" alt="manager group in keyCloak"></p>
<p>Then use this user to access APIServer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubelogin --username=admin --password=dangerous</span>
You got a valid token <span class="k">until</span> 2019-08-03 15:32:42 +0800 CST
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get cs</span>
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span><span class="o">}</span>
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get no</span>
NAME           STATUS   ROLES    AGE   VERSION
172-16-105-1   Ready    master   54d   v1.14.1
172-16-105-2   Ready    &lt;none&gt;   54d   v1.14.1
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get po</span>
No resources found.
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get all</span>
NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
service/kubernetes       ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        54d
</code></pre></td></tr></table>
</div>
</div><p>You can see that the &ldquo;admin&rdquo; user has access to all resources.</p>
<p>Then, we create a new role called &ldquo;hdls-role&rdquo; for the user whose group is developer, and only give them access to the pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-role</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-rolebinding</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-role</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">developer</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>&ldquo;Add&rdquo; the test user to the &ldquo;developer&rdquo; group in keyCloak.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/e273ba5fa5bc4efb8a55352b5bef5950.png" alt="developer group in keyCloak"></p>
<p>Then use that user to access APIServer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubelogin --username=test --password=dangerous</span>
You got a valid token <span class="k">until</span> 2019-08-03 15:40:21 +0800 CST
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get po</span>
No resources found.
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get no</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: nodes is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;nodes&#34;</span> in API group <span class="s2">&#34;&#34;</span> at the cluster scope
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get cs</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: componentstatuses is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;componentstatuses&#34;</span> in API group <span class="s2">&#34;&#34;</span> at the cluster scope
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@172-16-105-1 ~<span class="o">]</span><span class="c1"># kubectl get all</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: replicationcontrollers is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;replicationcontrollers&#34;</span> in API group <span class="s2">&#34;&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: services is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;services&#34;</span> in API group <span class="s2">&#34;&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: daemonsets.apps is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;daemonsets&#34;</span> in API group <span class="s2">&#34;apps&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: deployments.apps is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;deployments&#34;</span> in API group <span class="s2">&#34;apps&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: replicasets.apps is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;replicasets&#34;</span> in API group <span class="s2">&#34;apps&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: statefulsets.apps is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;statefulsets&#34;</span> in API group <span class="s2">&#34;apps&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: horizontalpodautoscalers.autoscaling is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;horizontalpodautoscalers&#34;</span> in API group <span class="s2">&#34;autoscaling&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: jobs.batch is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;jobs&#34;</span> in API group <span class="s2">&#34;batch&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: cronjobs.batch is forbidden: User <span class="s2">&#34;test&#34;</span> cannot list resource <span class="s2">&#34;cronjobs&#34;</span> in API group <span class="s2">&#34;batch&#34;</span> in the namespace <span class="s2">&#34;default&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>The test user is restricted from accessing all resources except for pod information.</p>
<h2 id="summary">Summary</h2>
<p>This article only introduced how to manage users in K8s through KeyCloak and kubectl, accordingly, if your own user center implements the OIDC protocol, and the client accesses APIServer as &ldquo;bearer token&rdquo; through ID Token, you can really connect the permission system of K8s with the superstructure.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/keycloak/">keycloak</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/kubernetes-coredns/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes Service Discovery - coreDNS</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/operator-framework/">
            <span class="next-text nav-default">Build and maintain operators using the Operator Framework toolkit</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
