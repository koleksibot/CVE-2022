<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Using Mock and Interface for Golang Unit Testing - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In my work I often find that many engineers&#39; Golang unit tests are written in a problematic way, simply calling the code for output and including various IO operations, making it impossible to run the unit tests everywhere.
Golang Unit Testing with Mock and Interface This article explains how to do unit tests properly in Golang.
What is unit testing? Features of unit testing Unit testing is a very important part of quality assurance." /><meta name="keywords" content="golang, Mock, Test" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/use-mock-to-test/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Using Mock and Interface for Golang Unit Testing" />
<meta property="og:description" content="In my work I often find that many engineers&#39; Golang unit tests are written in a problematic way, simply calling the code for output and including various IO operations, making it impossible to run the unit tests everywhere.
Golang Unit Testing with Mock and Interface This article explains how to do unit tests properly in Golang.
What is unit testing? Features of unit testing Unit testing is a very important part of quality assurance." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/use-mock-to-test/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-07T15:46:52+08:00" />
<meta property="article:modified_time" content="2022-03-07T15:46:52+08:00" />

<meta itemprop="name" content="Using Mock and Interface for Golang Unit Testing">
<meta itemprop="description" content="In my work I often find that many engineers&#39; Golang unit tests are written in a problematic way, simply calling the code for output and including various IO operations, making it impossible to run the unit tests everywhere.
Golang Unit Testing with Mock and Interface This article explains how to do unit tests properly in Golang.
What is unit testing? Features of unit testing Unit testing is a very important part of quality assurance."><meta itemprop="datePublished" content="2022-03-07T15:46:52+08:00" />
<meta itemprop="dateModified" content="2022-03-07T15:46:52+08:00" />
<meta itemprop="wordCount" content="1689">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Mock and Interface for Golang Unit Testing"/>
<meta name="twitter:description" content="In my work I often find that many engineers&#39; Golang unit tests are written in a problematic way, simply calling the code for output and including various IO operations, making it impossible to run the unit tests everywhere.
Golang Unit Testing with Mock and Interface This article explains how to do unit tests properly in Golang.
What is unit testing? Features of unit testing Unit testing is a very important part of quality assurance."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Using Mock and Interface for Golang Unit Testing</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-07 15:46:52 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1689 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#golang-unit-testing-with-mock-and-interface">Golang Unit Testing with Mock and Interface</a>
          <ul>
            <li><a href="#what-is-unit-testing-features-of-unit-testing">What is unit testing? Features of unit testing</a></li>
            <li><a href="#what-is-mock">What is Mock?</a></li>
            <li><a href="#what-is-interface">What is Interface?</a></li>
            <li><a href="#some-other-examples">Some other examples</a></li>
            <li><a href="#other-tips">other tips</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In my work I often find that many engineers' <code>Golang</code> unit tests are written in a problematic way, simply calling the code for output and including various <code>IO</code> operations, making it impossible to run the unit tests everywhere.</p>
<h2 id="golang-unit-testing-with-mock-and-interface">Golang Unit Testing with Mock and Interface</h2>
<p>This article explains how to do unit tests properly in <code>Golang</code>.</p>
<h3 id="what-is-unit-testing-features-of-unit-testing">What is unit testing? Features of unit testing</h3>
<p>Unit testing is a very important part of quality assurance. A good unit test not only finds problems in time, but also facilitates debugging and improves productivity, so many people think that writing unit tests takes extra time and will reduce productivity, which is the biggest prejudice and misunderstanding of unit testing.</p>
<p>Unit testing will isolate the module corresponding to the test for testing, so we have to remove all relevant external dependencies as much as possible and only unit test the relevant modules.</p>
<p>So some of the unit tests you see in the business code repository that call <code>HTTP</code> in the <code>client</code> module are actually irregular, because <code>HTTP</code> is an external dependency and your unit tests will fail if your target server fails.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Test_xxx</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">DemoClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">demo</span><span class="p">.</span><span class="nx">DemoClient</span><span class="p">{</span><span class="nx">url</span><span class="p">:</span> <span class="s">&#34;http://localhost:8080&#34;</span><span class="p">}</span>
 <span class="nx">DemoClient</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
 <span class="nx">resp</span> <span class="o">:=</span> <span class="nx">DemoCliten</span><span class="p">.</span><span class="nf">DoHTTPReq</span><span class="p">()</span>
 <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above example, <code>DemoClient</code> will call the <code>http.Get</code> method when doing the <code>DoHTTPReq</code> method, which contains an external dependency that means he will request the local server, if a new colleague just got your code and there is no local server, then your unit test will fail.</p>
<p>And in the above example, the function <code>DoHTTPReq</code> is simply an output without any check on the return value. If the internal logic is modified and the return value is modified, although your test can still <code>pass</code>, your unit test will not work.</p>
<p>From the above example, we can summarize two unit test features:</p>
<ul>
<li>No external dependencies, no side effects as much as possible, and the ability to run everywhere</li>
<li>Checking the output</li>
</ul>
<p>Another point I would like to mention is that there is actually a ranking of the difficulty of writing unit tests.</p>
<p>UI &gt; Service &gt; Utils</p>
<p>So for writing unit tests, we will give priority to the unit tests for <code>Utils</code>, because <code>Utils</code> will not have too many dependencies. Next is the unit test for <code>Service</code>, because the unit test for <code>Service</code> mainly depends on the upstream service and database, so we only need to separate the dependencies and then we can test the logic.</p>
<p>So how do you isolate the dependencies? Let&rsquo;s go to the next section, where we will cover how to separate out dependencies.</p>
<h3 id="what-is-mock">What is Mock?</h3>
<p>For <code>IO</code> dependencies, we can use <code>Mock</code> to mock the data so that we don&rsquo;t have to worry about unstable data sources.</p>
<p>So what is <code>Mock</code>? And how do we <code>Mock</code> it? Think of a scenario where you and your colleague are working on a collaborative project and your side is progressing faster and is almost done with your development, but your colleague is progressing a little slower and you are still dependent on his services. How do you continue development without <code>block</code> your progress?</p>
<p>Here you can use <code>Mock</code>, that is, you and your colleague can work out the data format you need to interact with in advance, and in your test code, you can write a client that can generate the corresponding data format, and the data is false, then you can continue writing your code, and when your colleague finishes his part of the code, you just need to replace the <code>Mock Clients</code> with the real <code>Clients</code> and you&rsquo;re done. That&rsquo;s what <code>Mock</code> does.</p>
<p>Similarly, we can use <code>Mock</code> to mock the data on which the module needs to be tested. The following is an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">myapp_test</span>
<span class="c1">// TestYoClient provides mockable implementation of yo.Client.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">TestYoClient</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">SendFunc</span> <span class="kd">func</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TestYoClient</span><span class="p">)</span> <span class="nf">Send</span><span class="p">(</span><span class="nx">recipient</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SendFunc</span><span class="p">(</span><span class="nx">recipient</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">TestMyApplication_SendYo</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">TestYoClient</span><span class="p">{}</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">MyApplication</span><span class="p">{</span><span class="nx">YoClient</span><span class="p">:</span> <span class="nx">c</span><span class="p">}</span>
    <span class="c1">// Mock our send function to capture the argument.
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">recipient</span> <span class="kt">string</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">SendFunc</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">recipient</span> <span class="p">=</span> <span class="nx">s</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="c1">// Send the yo and verify the recipient.
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">Yo</span><span class="p">(</span><span class="s">&#34;susy&#34;</span><span class="p">)</span>
    <span class="nf">ok</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="nf">equals</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;susy&#34;</span><span class="p">,</span> <span class="nx">recipient</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We will have a <code>MyApplication</code> that also depends on a <code>YoClient</code> that sends reports. In the above code we will replace the dependent <code>YoClient</code> with <code>TestYoClient</code>, so that when the code calls <code>MyApplication.Yo</code>, it actually executes <code>TestYoClient.Send</code>, so that we can customize the input and output of the external dependency.</p>
<p>It is also interesting to note that we have replaced <code>SendFunc</code> with <code>func(string) error</code> in <code>TestYoClient</code> so that we can control the input and output more flexibly. For different tests, we only need to change the value of <code>SendFunc</code>. This way we can control the input and output of each test as much as we want.</p>
<p>Another problem you will find at this point is that if you want to successfully inject <code>TestYoClient</code> into <code>MyApplication</code>, the corresponding member variable needs to be either the concrete type <code>TestYoClient</code> or an interface type that satisfies the <code>Send()</code> method. But if we use a concrete type, there is no way to replace the real <code>Client</code> with the <code>Mock Client</code>.</p>
<p>So we can use the interface type to replace it.</p>
<h3 id="what-is-interface">What is Interface?</h3>
<p>In <code>Golang</code> the interface may be different from the interfaces of other languages you&rsquo;ve come across, in <code>Golang</code> the interface is a collection of functions. And <code>Golang</code> interfaces are implicit and do not need to be defined explicitly.</p>
<p>Personally, I agree with this design, because after much practice, I have found that pre-defined abstractions often do not accurately describe the behavior of concrete implementations. So you need to do abstraction afterwards, instead of writing types to meet <code>interface</code>, you should write interfaces to meet the usage requirements.</p>
<blockquote>
<p>Always <em>abstract</em> things when you actually need them, never when you just foresee that you need them.</p>
</blockquote>
<p>My personal recommendation is that for several similar processes, we can first organize the code by writing several structures, and then after we find that these structures have similar behaviors, we can abstract an interface to describe these behaviors, which is the most accurate.</p>
<p>At the same time, the number of methods included in the interface in <code>Golang</code> should be limited, not too many, 1-3 methods is enough. The reason for this is that if your interface contains too many methods, you will have a lot of trouble adding a new code that implements the type, and the code is not easy to maintain. Likewise if your interface has many implementations and many methods, it will be difficult to add one more function to the interface, and you will need to implement those methods in each structure.</p>
<p>Back to the topic, for <code>YoClient</code>, initially if we don&rsquo;t use the <code>TDD</code> approach, then <code>MyApplication</code> must depend on a formal concrete type, at this point we can write an instance of <code>TestYoClient</code> type in the test code, extract the common functions to extract the interface, and then go to replace <code>YoClient</code> in <code>MyApplication</code> with the interface type.</p>
<p>This will accomplish our goal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">myapp</span>
<span class="kd">type</span> <span class="nx">MyApplication</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">YoClient</span> <span class="kd">interface</span> <span class="p">{</span>
        <span class="nf">Send</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">MyApplication</span><span class="p">)</span> <span class="nf">Yo</span><span class="p">(</span><span class="nx">recipient</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">YoClient</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">recipient</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="some-other-examples">Some other examples</h3>
<p>I have also provided an example for reference, mostly from official production code, that masks sensitive information.</p>
<p>This example is a <code>mock</code> of the external dependency <code>etcd</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ETCD</span> <span class="kd">interface</span> <span class="p">{</span>
 <span class="nf">GetWithTimeout</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
 <span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">MockEtcdClient</span> <span class="kd">struct</span> <span class="p">{</span>
 <span class="nx">GetWithTimeoutFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
 <span class="nx">WatchFunc</span>          <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">MockEtcdClient</span><span class="p">)</span> <span class="nf">GetWithTimeout</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nf">GetWithTimeoutFunc</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="nx">MockEtcdClient</span><span class="p">)</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span> <span class="p">{</span>
 <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nf">WatchFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>An example of a unit test:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Test_saveTestConf</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">etcd</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">MockEtcdClient</span><span class="p">{</span>
  <span class="nx">GetWithTimeoutFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="o">&amp;</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">{</span>
    <span class="nx">Kvs</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mvccpb</span><span class="p">.</span><span class="nx">KeyValue</span><span class="p">{</span>
     <span class="p">{</span>
      <span class="nx">Key</span><span class="p">:</span>   <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;/xxxx/xxx/config&#34;</span><span class="p">),</span>
      <span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;{\&#34;xxx\&#34;:\&#34;xxx\&#34;}&#34;</span><span class="p">),</span>
     <span class="p">},</span>
    <span class="p">},</span>
   <span class="p">},</span> <span class="kc">nil</span>
  <span class="p">},</span>
  <span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">)</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span> <span class="p">{</span>
   <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">},</span>
 <span class="p">}</span>

 <span class="nx">configKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">saveTestConf</span><span class="p">(</span><span class="nx">etcd</span> <span class="p">,</span><span class="s">&#34;xxxx&#34;</span><span class="p">,</span> <span class="s">&#34;/xxxx/xxx/config&#34;</span><span class="p">)</span>
 <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;/xxxx/xxx/config&#34;</span><span class="p">,</span> <span class="nx">configKey</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="other-tips">other tips</h3>
<p>There are some tips you may not know about testing on my end</p>
<h4 id="golangs-interal-and-external-testing">golang&rsquo;s interal and external testing</h4>
<p>For a package&rsquo;s exported methods and variables you can create <code>test</code> files under the same package to test them, just by changing the package name suffix to <code>_test</code>. This way you can do <code>black box testing</code>. The advantage is that you can describe your test from the caller&rsquo;s point of view, rather than writing your test from an internal point of view. It can also be used as an example to show users how to use it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// in example.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">example</span>

<span class="kd">var</span> <span class="nx">start</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="nx">start</span> <span class="o">+=</span> <span class="nx">n</span>
  <span class="k">return</span> <span class="nx">start</span>
<span class="p">}</span>

<span class="c1">// in example_test.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">example_test</span>

<span class="kn">import</span> <span class="p">(</span>
 <span class="s">&#34;testing&#34;</span>

 <span class="p">.</span> <span class="s">&#34;bitbucket.org/splice/blog/example&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestAdd</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">got</span> <span class="o">:=</span> <span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">got</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;got %d, want 1&#34;</span><span class="p">,</span> <span class="nx">got</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Alternatively you can test unexported methods and variables by creating a file with the suffix <code>_internal_test</code> to identify that you want to test unexported methods and variables.</p>
<h2 id="summary">Summary</h2>
<ul>
<li>Features of <code>Golang</code> unit tests.
<ul>
<li>No external dependencies, no side effects as much as possible, ability to run everywhere</li>
<li>Need to check the output</li>
<li>Can be used as an example to show users how to use</li>
</ul>
</li>
<li><code>Golang</code> can use interfaces to replace dependencies</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/typescript-generic-perspect-of-set-thoery/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">TypeScript generic development practices from a set perspective</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/relation-between-iptables-and-linux-kernal/">
            <span class="next-text nav-default">The relationship between iptables and the Linux kernel</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
