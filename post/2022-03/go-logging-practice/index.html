<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Talking about engineering practices for Go application output logging - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article is mainly to chat about the engineering practices of Go application output logging." /><meta name="keywords" content="golang, Logging, Practice" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/go-logging-practice/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Talking about engineering practices for Go application output logging" />
<meta property="og:description" content="This article is mainly to chat about the engineering practices of Go application output logging." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/go-logging-practice/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-25T14:08:26+08:00" />
<meta property="article:modified_time" content="2022-03-25T14:08:26+08:00" />

<meta itemprop="name" content="Talking about engineering practices for Go application output logging">
<meta itemprop="description" content="This article is mainly to chat about the engineering practices of Go application output logging."><meta itemprop="datePublished" content="2022-03-25T14:08:26+08:00" />
<meta itemprop="dateModified" content="2022-03-25T14:08:26+08:00" />
<meta itemprop="wordCount" content="2880">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Talking about engineering practices for Go application output logging"/>
<meta name="twitter:description" content="This article is mainly to chat about the engineering practices of Go application output logging."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Talking about engineering practices for Go application output logging</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-25 14:08:26 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2880 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#i-the-state-of-go-logging">I. The State of Go Logging</a>
          <ul>
            <li><a href="#go-standard-library-log-packages">Go Standard Library log packages</a></li>
            <li><a href="#glog">glog</a></li>
            <li><a href="#structured-logging-package">Structured logging package</a></li>
          </ul>
        </li>
        <li><a href="#ii-the-main-problems-in-engineering-practice">II. The main problems in engineering practice</a></li>
        <li><a href="#iii-interim-solutions-community-efforts-and-expectations">III. Interim solutions, community efforts and expectations</a></li>
        <li><a href="#iv-summary">IV. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/25/f2e71e0561474457b7fc4a490d257522.png" alt="golang log"></p>
<p>Go is a back-end language that is known for developing various services, middleware and system platforms. When learning Go, logging is not indispensable or even unnecessary, but once we get to the real Go engineering practice, output logging is an inevitable problem we must face.</p>
<p>Most of the services developed by Go have the property of continuous and autonomous operation, usually running 7×24 hours, and it is impossible for the development and operation personnel to keep an eye on the running state of the service, which requires recording the running log of the service. The essence of logs is <strong>to be checked</strong>. Through logs, we can.</p>
<ul>
<li>Check the running status of the system</li>
<li>Discover anomalies</li>
<li>Audit behavior</li>
<li>Aid in the diagnosis of problems</li>
</ul>
<p>In today&rsquo;s cloud-native era, where Observability is all the rage, logs are known as <a href="https://www.oreilly.com/library/view/the-future-of/9781098118433/">&ldquo;the three pillars of Observability&rdquo;</a> (the other two are metrics and tracing), and is an essential part of cloud-native system devops.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/25/4ddd6cf45f6c40b68aa06a0598b14903.png" alt="the three pillars of Observability"></p>
<p>So what is the current state of Go&rsquo;s support for logging output in Go engineering practice? What are the problems? What are the common problem-solving approaches? And what are the community efforts and expectations? In this article, I&rsquo;ll talk about these issues.</p>
<h2 id="i-the-state-of-go-logging">I. The State of Go Logging</h2>
<p>Go is a &ldquo;bring-your-own-battery&rdquo; language that works out of the box. This means that there are ready-made <a href="https://pkg.go.dev/log">log packages</a> in the Go standard library for developers to use.</p>
<h3 id="go-standard-library-log-packages">Go Standard Library log packages</h3>
<p>As part of the Go standard library, the Go log package is very easy to use. You can simply import the log package and output logs to standard errors (stderr) without having to do any creation or setup operations, because the log package has a built-in default logger named std:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// $GOROOT/src/log/log.go
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">std</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">LstdFlags</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>This pattern of having a default logger instance built in is also emulated by many third-party logging packages. The following is a simple example of using the default logger to output logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;log&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;hello, go log&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output of the above example program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">2022/02/27 14:40:41 hello, go log
</code></pre></td></tr></table>
</div>
</div><p>We see: go log provides a printf-like style log API, which means that the code will work just as well if the log in the code is replaced with fmt. go log supports three types of APIs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">Println/Printf
Panicln/Panicf // 相当于PrintX + panic
Fatalln/Fatalf // 相当于PrintX + exit
</code></pre></td></tr></table>
</div>
</div><p>The go log package allows for some &ldquo;customization&rdquo; of the logger through the following three export methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">SetFlags</span><span class="p">(</span><span class="nx">flag</span> <span class="kt">int</span><span class="p">)</span>       <span class="c1">// 主要用于设置日志的时间戳格式，也可以设置前缀字符串在log输出中的位置，默认flag为LstdFlags
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetOutput</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>   <span class="c1">// 设置日志的输出目的地，比如文件、网络socket、syslog等
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SetPrefix</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">)</span> <span class="c1">// 设置日志前缀
</span></code></pre></td></tr></table>
</div>
</div><p>But go log package does not support setting log level and output by level, and the built-in std logger also does not support log level. If you have a need for log level, you can use the go log package for secondary packaging. The following is a simple wrapping demo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;io&#34;</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;os&#34;</span>
    <span class="s">&#34;sync/atomic&#34;</span>
<span class="p">)</span>

<span class="c1">// log level
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">LDEBUG</span> <span class="p">=</span> <span class="kc">iota</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// 1
</span><span class="c1"></span>    <span class="nx">LWARN</span>             <span class="c1">// 2
</span><span class="c1"></span>    <span class="nx">LINFO</span>             <span class="c1">// 3
</span><span class="c1"></span>    <span class="nx">LERROR</span>            <span class="c1">// 4
</span><span class="c1"></span>    <span class="nx">LFATAL</span>            <span class="c1">// 5
</span><span class="c1"></span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">myLogger</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">level</span>       <span class="kt">int64</span>
    <span class="nx">w</span>           <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
    <span class="nx">debugLogger</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="nx">warnLogger</span>  <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="nx">infoLogger</span>  <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="nx">errLogger</span>   <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="nx">fatalLogger</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">level</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">flag</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">myLogger</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">w</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">flag</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">flag</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">LstdFlags</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">myLogger</span><span class="p">{</span>
        <span class="nx">w</span><span class="p">:</span>           <span class="nx">w</span><span class="p">,</span>
        <span class="nx">level</span><span class="p">:</span>       <span class="nx">level</span><span class="p">,</span>
        <span class="nx">debugLogger</span><span class="p">:</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[DEBUG] &#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">|</span><span class="nx">log</span><span class="p">.</span><span class="nx">Lmsgprefix</span><span class="p">),</span>
        <span class="nx">warnLogger</span><span class="p">:</span>  <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[WARN] &#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">|</span><span class="nx">log</span><span class="p">.</span><span class="nx">Lmsgprefix</span><span class="p">),</span>
        <span class="nx">infoLogger</span><span class="p">:</span>  <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[INFO] &#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">|</span><span class="nx">log</span><span class="p">.</span><span class="nx">Lmsgprefix</span><span class="p">),</span>
        <span class="nx">errLogger</span><span class="p">:</span>   <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[ERROR] &#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">|</span><span class="nx">log</span><span class="p">.</span><span class="nx">Lmsgprefix</span><span class="p">),</span>
        <span class="nx">fatalLogger</span><span class="p">:</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[FATAL] &#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">|</span><span class="nx">log</span><span class="p">.</span><span class="nx">Lmsgprefix</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">myLogger</span><span class="p">)</span> <span class="nf">SetLevel</span><span class="p">(</span><span class="nx">level</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">level</span> <span class="p">&lt;</span> <span class="nx">LDEBUG</span> <span class="o">||</span> <span class="nx">level</span> <span class="p">&gt;</span> <span class="nx">LFATAL</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">myLogger</span><span class="p">)</span> <span class="nf">Debugln</span><span class="p">(</span><span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">LDEBUG</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">debugLogger</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">myLogger</span><span class="p">)</span> <span class="nf">Debugf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">LDEBUG</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">debugLogger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">v</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">myLogger</span><span class="p">)</span> <span class="nf">Infoln</span><span class="p">(</span><span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">LINFO</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">infoLogger</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">myLogger</span><span class="p">)</span> <span class="nf">Infof</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">LINFO</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">infoLogger</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">v</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">LWARN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">Infoln</span><span class="p">(</span><span class="s">&#34;info level log demo&#34;</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">Debugln</span><span class="p">(</span><span class="s">&#34;debug level log demo&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Run this demo, the output log is as follows: (Since the LWARN level is set, only the info level log will be output, the debug level log will be ignored).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">2022/02/27 15:41:01 [INFO] info level log demo
</code></pre></td></tr></table>
</div>
</div><h3 id="glog">glog</h3>
<p>A Google internal use, Go version of <a href="https://github.com/golang/glog">glog</a> is also available under the golang organization of github.</p>
<blockquote>
<p>Note: glog is google&rsquo;s own internal logging package, and does not accept external PRs for adding features.</p>
</blockquote>
<p>glog supports hierarchical logging and provides a dedicated API to output logs by specific log level, such as: InfoXx, WarningXx, ErrorXx, FatalXx, etc. The following is an example of using glog.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;flag&#34;</span>

    <span class="s">&#34;github.com/golang/glog&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Prepare to repel boarders&#34;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting transaction...&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infoln</span><span class="p">(</span><span class="s">&#34;Processed&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#34;elements&#34;</span><span class="p">)</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>glog specifies the log level by flag, so you must call the Parse function of the Go standard library flag package to parse the command line flag before using glog to output the log. executing this example, the output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">$go run main.go -logtostderr -v=2
I0227 16:14:35.968922   40869 main.go:12] Prepare to repel boarders
I0227 16:14:35.969024   40869 main.go:15] Starting transaction...
I0227 16:14:35.969027   40869 main.go:17] Processed 5 elements
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: Using -logtostderr makes the log output to the standard error, otherwise the default output is to a temporary file in the system temporary file directory; if you want to output the log to a specific directory, you can remove -logtostderr and specify -log_dir, but we can&rsquo;t specify the log file name, glog has a set of built-in automatic naming mechanism for log files.</p>
</blockquote>
<p>Although there are many differences between glog and the standard library log package, they generally belong to a class of log packages that share a common feature: <strong>Developers need to compose an unstructured log by themselves through the class Printf API, such logs are easy for humans to read, but not for machines to read (parse)</strong>.</p>
<h3 id="structured-logging-package">Structured logging package</h3>
<p>Well, this brings us to another class of log packages, which are the opposite of the standard library log and golang/glog above: <strong>Developers don&rsquo;t need to self-organize the log format when using this class of log packages, they just need to give the fields to be output by key-value, and the log package will automatically organize these fields into a structured log like the following</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">// 以zap包输出为例：

{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:1646256841.204795,&#34;caller&#34;:&#34;zap/testzap.go:13&#34;,&#34;msg&#34;:&#34;failed to fetch URL&#34;,&#34;url&#34;:&#34;http://tonybai.com&#34;,&#34;attempt&#34;:3,&#34;backoff&#34;:1}
</code></pre></td></tr></table>
</div>
</div><p>We can easily see that this is a legitimate json data, such log packages mostly use json as the output form of structured logs. And, even if some packages provide a Printf-like API, they actually just use a self-assembled string as the value of a specific key (e.g., the zap package uses msg).</p>
<p>The vast majority of third-party log packages open-sourced by the <strong>Go community belong to this type of structured logging package</strong>, including the two most highly ranked and widely adopted packages on github, <code>sirupsen/logrus</code> and <code>uber-go/zap</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/25/ea106f3ef3ed46b5aa40a6c7dfb76564.png" alt="sirupsen/logrus and uber-go/zap"></p>
<p>I use uber/zap in production, and I&rsquo;ll talk more about how to use the zap package when I get a chance.</p>
<p>The main reason for the popularity of structured logging packages is that they are easy to be &ldquo;read&rdquo; by machines, <strong>nowadays it is no longer a best practice to &ldquo;write&rdquo; logs to a centralized logging platform of class [ELK] for review, but a must</strong>.</p>
<p>Some say that performance is also a consideration. That&rsquo;s true, or at least I would focus on a high-performing logging package in my selection. For example: zap beats std log in concurrent benchmark.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">goos: linux
goarch: amd64
pkg: demo
cpu: Intel(R) Core(TM) i7-9700 CPU @ 3.00GHz
BenchmarkGolog-4         4126830        290.7 ns/op    24 B/op      1 allocs/op
BenchmarkGooglelog-4     711428    1427 ns/op      216 B/op     2 allocs/op
BenchmarkZap-4      11572719        97.08 ns/op     0 B/op      0 allocs/op
PASS
</code></pre></td></tr></table>
</div>
</div><p>What you may not know is that zap performance is actually inferior to std log under a single goroutine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">goos: linux
goarch: amd64
pkg: demo
cpu: Intel(R) Core(TM) i7-9700 CPU @ 3.00GHz
BenchmarkGolog-4         4470559        273.4 ns/op    24 B/op      1 allocs/op
BenchmarkGooglelog-4     789846    1363 ns/op      216 B/op     2 allocs/op
BenchmarkZap-4       2934202        400.4 ns/op     0 B/op      0 allocs/op
PASS
</code></pre></td></tr></table>
</div>
</div><p>However, which Go application as a backend service today does not start several goroutines? Concurrency is the main scenario for log applications.</p>
<p>Whether you choose the unstructured std log package or the structured, high-performance zap log package, you will still encounter some problems during the application. Next, let&rsquo;s take a look at the main problems that exist in the engineering practice of logging.</p>
<h2 id="ii-the-main-problems-in-engineering-practice">II. The main problems in engineering practice</h2>
<p>In engineering practice, you will encounter many problems in dealing with logs, such as: how to log selection, how to evaluate log performance, how to set log output (including: setting the purpose of log output io.Writer, log format, log rotation (rotate) and archive (archive), etc.).</p>
<p>But these are not the main problems, log selection can refer to the most widely used community log package; log performance can be judged by a simple benchmark; log settings, look at the doc and example provided by each package can mostly be handled.</p>
<p>So what is the main problem? Actually, it is <strong>log adaptation</strong>. Why is there a log adaptation problem? Let me give you an example to understand.</p>
<p>Now I have a Go project P1, P1 relies on uber/zap package to output log. through the previous understanding of zap, we know that zap output log style is like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;warn&#34;</span><span class="p">,</span><span class="nt">&#34;logtime&#34;</span><span class="p">:</span><span class="s2">&#34;2022-02-27T15:24:57+08:00&#34;</span><span class="p">,</span><span class="nt">&#34;caller&#34;</span><span class="p">:</span><span class="s2">&#34;xx/log.go:19&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;[f:1,l:33372,t:4,c:33372,a:33372] [00103:00001] t24 cast vote from n00003 index 33373 term 24, log term: 5&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now P1 wants to implement distributed and strongly consistent data synchronization based on the <a href="https://github.com/lni/dragonboat">dragonboat package</a>, but dragonboat uses a custom logger, whose internal module outputs logs in the style of</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">2022-02-27 16:25:40.259479 I | raft: [f:1,l:33375,t:26,c:33374,a:33374] [00101:00001] t26 became leader
</code></pre></td></tr></table>
</div>
</div><p>We see: the problem arises: <strong>P1 outputs some logs in zap log format and some in dragonboat&rsquo;s custom format, which is not only difficult for human to read, but also impossible for the machine to parse</strong>.</p>
<p>The good thing is that the dragonboat package is kind enough to provide an external export function <strong>SetLoggerFactory</strong> to set its internal logger, but only if the type of the logger instance set should satisfy the following interface type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// dragonboat包中的logger/logger.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ILogger</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">SetLevel</span><span class="p">(</span><span class="nx">LogLevel</span><span class="p">)</span>
    <span class="nf">Debugf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nf">Infof</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nf">Warningf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nf">Errorf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nf">Panicf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The good thing is that the zap package provides a &ldquo;Sugar&rdquo; style Printf-like API that can be used to adapt the above ILogger interface, we take the <a href="https://github.com/lni/dragonboat-example">dragonboat-example</a> as an example to adapt the project to the zap-style log, we provide a log.go file for the helloworld project with the following source code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//helloworld/log.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/lni/dragonboat/v3/logger&#34;</span>
    <span class="s">&#34;go.uber.org/zap&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">LogLevel</span> <span class="p">=</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">LogLevel</span>

<span class="kd">type</span> <span class="nx">Mylogger</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">SetLevel</span><span class="p">(</span><span class="nx">level</span> <span class="nx">LogLevel</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">Warningf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">().</span><span class="nf">Warnf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">Debugf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">().</span><span class="nf">Debugf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">Errorf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">().</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">Infof</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">().</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Mylogger</span><span class="p">)</span> <span class="nf">Panicf</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Sugar</span><span class="p">().</span><span class="nf">Panicf</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">ILogger</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">Mylogger</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">factory</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">pkgName</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">ILogger</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProduction</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Mylogger</span><span class="p">{</span>
        <span class="nx">Logger</span><span class="p">:</span> <span class="nx">logger</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then use the SetLoggerFactory provided by dragonboat to reset the logger instance used internally by dragonboat in the main.go of helloworld.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span> <span class="o">...</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">SetLoggerFactory</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Factory</span><span class="p">(</span><span class="nx">factory</span><span class="p">))</span>

    <span class="c1">// change the log verbosity
</span><span class="c1"></span>    <span class="nx">logger</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="s">&#34;raft&#34;</span><span class="p">).</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="s">&#34;rsm&#34;</span><span class="p">).</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">WARNING</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">).</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">WARNING</span><span class="p">)</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">(</span><span class="s">&#34;grpc&#34;</span><span class="p">).</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logger</span><span class="p">.</span><span class="nx">WARNING</span><span class="p">)</span>
    <span class="o">...</span> <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When we run the helloworld example after this change, we can see that its output log style has changed to zap style.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;warn&#34;</span><span class="p">,</span><span class="nt">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1646300185.9349403</span><span class="p">,</span><span class="nt">&#34;caller&#34;</span><span class="p">:</span><span class="s2">&#34;helloworld/log.go:18&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;[f:1,l:4,t:2,c:4,a:4] [00128:00001] t3 received 2 votes and 0 rejections, quorum is 2&#34;</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1646300185.9352179</span><span class="p">,</span><span class="nt">&#34;caller&#34;</span><span class="p">:</span><span class="s2">&#34;helloworld/log.go:30&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;[f:1,l:5,t:3,c:4,a:4] [00128:00001] t3 became leader&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here, some people may say: <strong>Adapting a logging package seems to be okay</strong>! In fact, if you come across a package like dragonboat, it means we are lucky that it provides a logger interface for you to adapt, but what if it doesn&rsquo;t provide such an interface? What if zap didn&rsquo;t provide a Printf-like API? We can&rsquo;t even blend zap with dragonboat like above.</p>
<p>Furthermore, I&rsquo;d say the seriousness of the problem lies in the <strong>uncertainty</strong> that comes from the <strong>unpredictability of future logging interface format compatibility</strong> with some newly introduced third-party package, and the root of the problem lies in the fact that <a href="https://github.com/golang/go/issues/13182"><strong>there is no official Go logging interface for all projects to follow</strong></a>.</p>
<p>As we said earlier in the state of logging, the Go standard library Logger is a structure, a concrete implementation, and not decoupled.</p>
<h2 id="iii-interim-solutions-community-efforts-and-expectations">III. Interim solutions, community efforts and expectations</h2>
<p>So what do we do when we encounter such engineering problems? In the absence of a unified log interface provided by Go, we may encounter the following two scenarios (Project P, Dependency D).</p>
<ul>
<li>If D provides a log interface for adaptation like dragonboat above, and the style of the log interface is compatible with the style of P&rsquo;s own log package (e.g., both support the Printf-like API), then we need to provide a logger implementation in project P for adaptation to D, as in the above example.</li>
<li>If D does not provide a logging interface for adaptation, and its output logging style is not consistent with P&rsquo;s own logging style or D&rsquo;s logging API style is not compatible with P&rsquo;s own logging package API, in this case, either raise an issue or pr with the author of the D library (which may be rejected in most cases), or be more practical and fork the D project yourself and develop it twice, replacing the logger or add an interface for adaptation.</li>
</ul>
<p>To solve the log engineering problem once and for all, or the need to Go official definition of a unified log interface, the community in this regard can not say no effort, in 2017 a group of Go community gods on the establishment of a unified log interface committee, and <a href="https://groups.google.com/g/golang-dev/c/F3l9Iz1JX4g">discussion</a> came up with a <a href="https://docs.google.com/document/d/1shW9DZJXOeGbG9Mr9Us9MiaPqmlcVatD_D8lrOXRNMU/edit">proposal</a> to try to add a unified log interface to the Go standard library, but the proposal was not accepted by the Go core team. After that, the topic gradually fell silent, forming the current status quo.</p>
<p>The Go community can only take the peripheral route, so there are many Go community version of java-like <a href="https://www.slf4j.org/">SLF4J</a>(Simple Logging Facade for Java) projects, such as <a href="https://github.com/go-logr/logr">logr</a>, <a href="https://github.com/go-eden/slf4go">slf4go</a>, etc. The more active log API at the moment is the logr project, which provides adapted implementations of most major log packages. If you don&rsquo;t have a better solution, you can think about adopting logr&rsquo;s API specification.</p>
<h2 id="iv-summary">IV. Summary</h2>
<p>The problem of log in engineering practice is not singled out in the <a href="https://go.dev/blog/survey2020-results">Go Annual User Survey</a>, but it does exist, and I think it should be part of the &ldquo;Missing or immature I think it should be part of the &ldquo;Missing or immature libraries&rdquo; survey, and the sooner this problem is solved, the better, it will bring great convenience to developers and save a lot of time spent on implementing log adaptations.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/how-gc-detect-pointer-in-mem-obj/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How Go GC detects if a memory object contains a pointer</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/dependency-hell-in-go/">
            <span class="next-text nav-default">Why does the &#34;dependency hell&#34; problem persist with the Go module?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
