<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Things to know about the gRPC client - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article we have learned about the four communication modes of gRPC. We focused on the things to consider on the gRPC Client side in the most common simple RPC (unary RPC) mode." /><meta name="keywords" content="golang, grpc client" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/golang-grpc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Things to know about the gRPC client" />
<meta property="og:description" content="In this article we have learned about the four communication modes of gRPC. We focused on the things to consider on the gRPC Client side in the most common simple RPC (unary RPC) mode." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/golang-grpc/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-29T09:22:45+08:00" />
<meta property="article:modified_time" content="2022-03-29T09:22:45+08:00" />

<meta itemprop="name" content="Things to know about the gRPC client">
<meta itemprop="description" content="In this article we have learned about the four communication modes of gRPC. We focused on the things to consider on the gRPC Client side in the most common simple RPC (unary RPC) mode."><meta itemprop="datePublished" content="2022-03-29T09:22:45+08:00" />
<meta itemprop="dateModified" content="2022-03-29T09:22:45+08:00" />
<meta itemprop="wordCount" content="5543">
<meta itemprop="keywords" content="golang,grpc," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Things to know about the gRPC client"/>
<meta name="twitter:description" content="In this article we have learned about the four communication modes of gRPC. We focused on the things to consider on the gRPC Client side in the most common simple RPC (unary RPC) mode."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Things to know about the gRPC client</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-29 09:22:45 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 5543 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-the-default-grpc-client">1. The default gRPC client</a></li>
        <li><a href="#2-connecting-multiple-instances-of-a-service-instance">2. Connecting multiple instances of a Service (instance)</a>
          <ul>
            <li><a href="#1-staticresolver">1) StaticResolver</a></li>
            <li><a href="#2-resolver-principle">2) Resolver Principle</a></li>
            <li><a href="#3-nacosresolver">3) NacosResolver</a></li>
          </ul>
        </li>
        <li><a href="#3-customizing-the-client-balancer">3. Customizing the client balancer</a></li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/52b2763487b447e8aa1a5ff403712e19.png" alt="golang grcp"></p>
<p>In the era of cloud-native and microservices-dominated architectural models, there are only two types of communication protocols used for internal service interactions: HTTP API (RESTful API) and RPC. With today&rsquo;s hardware configurations and network conditions, modern RPC implementations generally perform better than HTTP API. We compare json over http with <a href="https://grpc.io/">gRPC</a>(insecure), using <a href="https://github.com/bojand/ghz">ghz</a> and <a href="https://github.com/rakyll/hey">hey</a> stress test the gRPC and json over http implementations. The performance of gRPC (Requests/sec: 59924.34) is 20% higher than the http api performance (Requests/sec: 49969.9234). The codec performance of protobuf used by gPRC is measured to be 2-3 times of the fastest json codec, and more than 10 times of the Go standard library json package codec performance.</p>
<p>For performance-sensitive systems with few internal communication protocol changes, using RPC for internal services is probably the choice of most people. Although gRPC is not the best RPC implementation in terms of performance, it is naturally the most widely used by developers because it is backed by Google and is <a href="https://www.cncf.io/projects/">the only RPC project of the CNCF</a>.</p>
<p>In this article, we will also talk about gRPC, but we will focus more on the gRPC client, and we will take a look at the things we consider when using the gRPC client (all code in this article is based on gRPC v1.40.0, Go 1.17.</p>
<h2 id="1-the-default-grpc-client">1. The default gRPC client</h2>
<p>gRPC supports four communication modes, which are (the following four diagrams are taken from [the book &ldquo;gRPC: Up and Running&rdquo;])</p>
<ul>
<li>Simple RPC (Simple RPC): the simplest and most commonly used gRPC communication mode, which is simply <strong>one request, one response</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/9add399ae1634df7a9a72586ad988d83.png" alt="one request, one response"></p>
<ul>
<li>Server-streaming RPC (Server-streaming RPC): <strong>one request, many responses</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/97d504db37e94d72bd9547edfa9f1cf2.png" alt="one request, many responses"></p>
<ul>
<li>Client-streaming RPC (Client-streaming RPC): <strong>Multiple requests, one response</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/f1ab281a735a401982aff377a85a28fd.png" alt="Multiple requests, one response"></p>
<ul>
<li>Bidirectional-Streaming RPC (BSRPC): <strong>Multiple requests, multiple responses</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/d382f0d73a2f475d8ae2a1bf554d4967.png" alt="one request, many responses"></p>
<p>Let&rsquo;s take the most commonly used Simple RPC (also known as Unary RPC) as an example to see how to implement a gRPC version of helloworld.</p>
<p>We don&rsquo;t need to write the helloworld.proto from scratch and generate the corresponding gRPC code ourselves. <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld">There is an official example of helloworld provided by gRPC</a>, and we only need to modify it a little.</p>
<p>The IDL file helloworld.proto of the helloworld example is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/grpc/grpc-go/tree/master/examples/helloworld/helloworld/helloworld.proto
</span><span class="c1"></span>
<span class="nx">syntax</span> <span class="p">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span>

<span class="nx">option</span> <span class="nx">go_package</span> <span class="p">=</span> <span class="s">&#34;google.golang.org/grpc/examples/helloworld/helloworld&#34;</span><span class="p">;</span>
<span class="nx">option</span> <span class="nx">java_multiple_files</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">option</span> <span class="nx">java_package</span> <span class="p">=</span> <span class="s">&#34;io.grpc.examples.helloworld&#34;</span><span class="p">;</span>
<span class="nx">option</span> <span class="nx">java_outer_classname</span> <span class="p">=</span> <span class="s">&#34;HelloWorldProto&#34;</span><span class="p">;</span>

<span class="kn">package</span> <span class="nx">helloworld</span><span class="p">;</span>

<span class="c1">// The greeting service definition.
</span><span class="c1"></span><span class="nx">service</span> <span class="nx">Greeter</span> <span class="p">{</span>
  <span class="c1">// Sends a greeting
</span><span class="c1"></span>  <span class="nx">rpc</span> <span class="nf">SayHello</span> <span class="p">(</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">HelloReply</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// The request message containing the user&#39;s name.
</span><span class="c1"></span><span class="nx">message</span> <span class="nx">HelloRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="nx">name</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The response message containing the greetings
</span><span class="c1"></span><span class="nx">message</span> <span class="nx">HelloReply</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="nx">message</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can refer to the <a href="https://grpc.io/docs/what-is-grpc/core-concepts/">grpc official documentation</a> for an explanation of the specification of the .proto file, so I won&rsquo;t go over it here. Obviously the above IDL is the ultimate simplicity. Here a service is defined: Greeter, which contains only one method SayHello, and the parameters and return value of this method are a structure containing only a string field.</p>
<p>We don&rsquo;t need to execute the protoc command manually to generate the corresponding Greeter service implementation and HelloRequest and HelloReply protobuf codec implementation based on the .proto file, because gRPC has already placed the generated Go source file under example, we can refer to it directly. Note here that the latest <a href="https://github.com/grpc/grpc-go">grpc-go project repository</a> adopts a multi-module management model, and examples exists as an independent go module, so we need to import it into its user&rsquo;s project as a separate module. Take the gRPC client greeter_client as an example, its go.mod should be written like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo1/greeter_client/go.mod
</span><span class="c1"></span><span class="nx">module</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">grpc</span><span class="o">-</span><span class="nx">client</span><span class="o">/</span><span class="nx">demo1</span>

<span class="k">go</span> <span class="mf">1.17</span>

<span class="nf">require</span> <span class="p">(</span>
    <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">grpc</span> <span class="nx">v1</span><span class="mf">.40.0</span>
    <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">grpc</span><span class="o">/</span><span class="nx">examples</span> <span class="nx">v1</span><span class="mf">.40.0</span>
<span class="p">)</span>

<span class="nf">require</span> <span class="p">(</span>
    <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">golang</span><span class="o">/</span><span class="nx">protobuf</span> <span class="nx">v1</span><span class="mf">.4.3</span> <span class="c1">// indirect
</span><span class="c1"></span>    <span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">x</span><span class="o">/</span><span class="nx">net</span> <span class="nx">v0</span><span class="mf">.0.0</span><span class="o">-</span><span class="mi">20201021035429</span><span class="o">-</span><span class="nx">f5854403a974</span> <span class="c1">// indirect
</span><span class="c1"></span>    <span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">x</span><span class="o">/</span><span class="nx">sys</span> <span class="nx">v0</span><span class="mf">.0.0</span><span class="o">-</span><span class="mi">20200930185726</span><span class="o">-</span><span class="nx">fdedc70b468f</span> <span class="c1">// indirect
</span><span class="c1"></span>    <span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">x</span><span class="o">/</span><span class="nx">text</span> <span class="nx">v0</span><span class="mf">.3.3</span> <span class="c1">// indirect
</span><span class="c1"></span>    <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">genproto</span> <span class="nx">v0</span><span class="mf">.0.0</span><span class="o">-</span><span class="mi">20200806141610</span><span class="o">-</span><span class="mi">86</span><span class="nx">f49bd18e98</span> <span class="c1">// indirect
</span><span class="c1"></span>    <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">protobuf</span> <span class="nx">v1</span><span class="mf">.25.0</span> <span class="c1">// indirect
</span><span class="c1"></span><span class="p">)</span>

<span class="nx">replace</span> <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">grpc</span> <span class="nx">v1</span><span class="mf">.40.0</span> <span class="p">=&gt;</span> <span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">tonybai</span><span class="o">/</span><span class="nx">Go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">grpc</span><span class="o">/</span><span class="nx">grpc</span><span class="o">-</span><span class="k">go</span>

<span class="nx">replace</span> <span class="nx">google</span><span class="p">.</span><span class="nx">golang</span><span class="p">.</span><span class="nx">org</span><span class="o">/</span><span class="nx">grpc</span><span class="o">/</span><span class="nx">examples</span> <span class="nx">v1</span><span class="mf">.40.0</span> <span class="p">=&gt;</span> <span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">tonybai</span><span class="o">/</span><span class="nx">Go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">grpc</span><span class="o">/</span><span class="nx">grpc</span><span class="o">-</span><span class="k">go</span><span class="o">/</span><span class="nx">examples</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: The tag of the grpc-go project seems to have a problem, because there is no grpc/examples/v1.40.0 tag, the go command cannot find the examples in the v1.40.0 tag of grpc-go, so a replace trick is used in the above go.mod (the v1.40.0 tag of the example module&rsquo;s v1.40.0 version is false) to point the examples module to the local code.</p>
</blockquote>
<p>We also modified the two ends of the gRPC communication slightly. The original greeter_client only sends one request and then exits, here we change it to send requests every 2s (for easy follow-up), as shown in the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo1/greeter_client/main.go
</span><span class="c1"></span><span class="o">...</span> <span class="o">...</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Set up a connection to the server.
</span><span class="c1"></span>    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cf1</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nf">cf1</span><span class="p">()</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">DialContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">(),</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithBlock</span><span class="p">())</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;did not connect: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">NewGreeterClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>

    <span class="c1">// Contact the server and print out its response.
</span><span class="c1"></span>    <span class="nx">name</span> <span class="o">:=</span> <span class="nx">defaultName</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s-%d&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;could not greet: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Greeting: %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">())</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>greeter_server adds a command line option -port and supports graceful exit of the gRPC server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo1/greeter_server/main.go
</span><span class="c1"></span><span class="o">...</span> <span class="o">...</span>

<span class="kd">var</span> <span class="nx">port</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nf">IntVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">port</span><span class="p">,</span> <span class="s">&#34;port&#34;</span><span class="p">,</span> <span class="mi">50051</span><span class="p">,</span> <span class="s">&#34;listen port&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
    <span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;localhost:%d&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to listen: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
    <span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterGreeterServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{})</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to serve: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="kd">var</span> <span class="nx">c</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span>
    <span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Kill</span><span class="p">)</span>
    <span class="o">&lt;-</span><span class="nx">c</span>
    <span class="nx">s</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;exit&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After fixing go.mod and modifying client and server ok, we can build and run greeter_client and greeter_server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">编译和启动server：

<span class="nv">$cd</span> grpc-client/demo1/greeter_server
<span class="nv">$make</span>
$./demo1-server -port <span class="m">50051</span>
2021/09/11 12:10:33 Received: world-1
2021/09/11 12:10:35 Received: world-2
2021/09/11 12:10:37 Received: world-3
... ...

编译和启动client：
<span class="nv">$cd</span> grpc-client/demo1/greeter_client
<span class="nv">$make</span>
$./demo1-client
2021/09/11 12:10:33 Greeting: Hello world-1
2021/09/11 12:10:35 Greeting: Hello world-2
2021/09/11 12:10:37 Greeting: Hello world-3
... ...
</code></pre></td></tr></table>
</div>
</div><p>We see: greeter_client and greeter_server start up and can communicate normally! Let&rsquo;s focus on greeter_client.</p>
<p>The target parameter passed by greeter_client to DialContext during Dial server is a static service address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
      <span class="nx">address</span>     <span class="p">=</span> <span class="s">&#34;localhost:50051&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>This form of target is parsed by <code>google.golang.org/grpc/internal/grpcutil.ParseTarget</code> and returns a <code>resolver.Target</code> with a value of nil. So gRPC uses the default scheme: <code>passthrough</code> (<code>github.com/grpc/grpc-go/resolver/resolver.go</code>), and the default &quot; passthrough&quot; scheme, gRPC will use the built-in passthrough resolver (<code>google.golang.org/grpc/internal/resolver/passthrough</code>). How does this passthrough resolver by default set the address of the service to connect to? The following is an excerpt from the passthrough resolver code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/internal/resolver/passthrough/passthrough.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">passthroughResolver</span><span class="p">)</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">Addresses</span><span class="p">:</span> <span class="p">[]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{{</span><span class="nx">Addr</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">}}})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that it passes the target.Endpoint, i.e. localhost:50051, directly to ClientConnection (r.cc in the above code), which will establish a tcp connection to this address. This corresponds to the name of the resolver: <strong>passthrough</strong> .</p>
<p>The above greeter_client connection is only one instance of the service, if we start three instances of the service at the same time, for example by using <a href="https://github.com/mattn/goreman">goreman</a> to load a script file to start multiple service instances by loading a script file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo1/greeter_server/Procfile

<span class="c1"># Use goreman to run `go get github.com/mattn/goreman`</span>
demo1-server1: ./demo1-server -port <span class="m">50051</span>
demo1-server2: ./demo1-server -port <span class="m">50052</span>
demo1-server3: ./demo1-server -port <span class="m">50053</span>

同时启动多实例：

<span class="nv">$goreman</span> start
15:22:12 demo1-server3 <span class="p">|</span> Starting demo1-server3 on port <span class="m">5200</span>
15:22:12 demo1-server2 <span class="p">|</span> Starting demo1-server2 on port <span class="m">5100</span>
15:22:12 demo1-server1 <span class="p">|</span> Starting demo1-server1 on port <span class="m">5000</span>
</code></pre></td></tr></table>
</div>
</div><p>So how should we tell greeter_client to connect to these three instances? Is it possible to change the address to something like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">address</span>     <span class="p">=</span> <span class="s">&#34;localhost:50051,localhost:50052,localhost:50053&#34;</span>
    <span class="nx">defaultName</span> <span class="p">=</span> <span class="s">&#34;world&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s change it, recompile greeter_client after the change, start greeter_client and we see the following result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$./demo1-client
2021/09/11 15:26:32 did not connect: context deadline exceeded
</code></pre></td></tr></table>
</div>
</div><p>greeter_client connects to server timeout! That means simply passing in multiple instances of addresses like the above won&rsquo;t work! Then the question arises! How do we get greeter_client to connect to multiple instances of a service? Let&rsquo;s continue to look down.</p>
<h2 id="2-connecting-multiple-instances-of-a-service-instance">2. Connecting multiple instances of a Service (instance)</h2>
<p>The target of grpc.Dial/grpc.DialContext is not simply the service address of the service instance, <strong>its real parameter (argument) determines which resolver the gRPC client will use to determine the set of addresses of the service instance</strong> .</p>
<p>Let&rsquo;s take a StaticResolver that returns a static set of service instances (i.e., a fixed number of service instances and a fixed service address) as an example to see how the gRPC client can connect multiple instances of a Service.</p>
<h3 id="1-staticresolver">1) StaticResolver</h3>
<p>Let&rsquo;s first design the target form to be passed to grpc.DialContext. <a href="https://github.com/grpc/grpc/blob/master/doc/naming.md">For gRPC naming resolution, gRPC has special documentation on this</a>. Here, we also create a new scheme: static, where the service addresses of multiple service instances are passed in via comma-separated strings, as in the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo2/greeter_client/main.go
</span><span class="c1"></span>
<span class="kd">const</span> <span class="p">(</span>
      <span class="nx">address</span> <span class="p">=</span> <span class="s">&#34;static:///localhost:50051,localhost:50052,localhost:50053&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>When address is passed into grpc.DialContext as a real parameter to target, it is parsed by grpcutil.ParseTarget into a resolver. This structure contains three fields.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/resolver/resolver.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Target</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Scheme</span>    <span class="kt">string</span>
    <span class="nx">Authority</span> <span class="kt">string</span>
    <span class="nx">Endpoint</span>  <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Scheme is &ldquo;static&rdquo;, Authority is empty, and Endpoint is &ldquo;localhost:50051,localhost:50052,localhost:50053″.</p>
<p>Next, gRPC will look for the corresponding Resolver Builder instance in the builder map of the resolver package based on the value of Target. So far none of the built-in resolver builders in gRPC can match the Scheme value. It&rsquo;s time to customize a StaticResolver Builder!</p>
<p>The grpc resolve package defines the interface that a Builder instance needs to implement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/resolver/resolver.go 
</span><span class="c1"></span>
<span class="c1">// Builder creates a resolver that will be used to watch name resolution updates.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Builder</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Build creates a new resolver for the given target.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// gRPC dial calls Build synchronously, and fails if the returned error is
</span><span class="c1"></span>    <span class="c1">// not nil.
</span><span class="c1"></span>    <span class="nf">Build</span><span class="p">(</span><span class="nx">target</span> <span class="nx">Target</span><span class="p">,</span> <span class="nx">cc</span> <span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">BuildOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Resolver</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="c1">// Scheme returns the scheme supported by this resolver.
</span><span class="c1"></span>    <span class="c1">// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.
</span><span class="c1"></span>    <span class="nf">Scheme</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Scheme method returns the scheme corresponding to this Builder, while the Build method is the real method used to build the Resolver instance, let&rsquo;s look at the implementation of StaticBuilder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo2/greeter_client/builder.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">resolver</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">StaticBuilder</span><span class="p">{})</span> <span class="c1">//在init函数中将StaticBuilder实例注册到resolver包的Resolver map中
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">StaticBuilder</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sb</span> <span class="o">*</span><span class="nx">StaticBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">target</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">cc</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span>
    <span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Resolver</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 解析target.Endpoint (例如：localhost:50051,localhost:50052,localhost:50053)
</span><span class="c1"></span>    <span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>

    <span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StaticResolver</span><span class="p">{</span>
        <span class="nx">endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
        <span class="nx">cc</span><span class="p">:</span>        <span class="nx">cc</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">{})</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sb</span> <span class="o">*</span><span class="nx">StaticBuilder</span><span class="p">)</span> <span class="nf">Scheme</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;static&#34;</span> <span class="c1">// 返回StaticBuilder对应的scheme字符串
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this StaticBuilder implementation, the init function registers a StaticBuilder instance into the Resolver map of the resolver package upon package initialization. The build method is the key to the StaticBuilder. In this method, it first resolves the incoming target. StaticResolver instance, and calls the ResolveNow method of the StaticResolver instance to determine the set of service instances to be connected.</p>
<p>Like Builder, grpc&rsquo;s resolver package also defines the Resolver interface that each resolver needs to implement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/resolver/resolver.go 
</span><span class="c1"></span>
<span class="c1">// Resolver watches for the updates on the specified target.
</span><span class="c1">// Updates include address updates and service config updates.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Resolver</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// ResolveNow will be called by gRPC to try to resolve the target name
</span><span class="c1"></span>    <span class="c1">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// It could be called multiple times concurrently.
</span><span class="c1"></span>    <span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">ResolveNowOptions</span><span class="p">)</span>
    <span class="c1">// Close closes the resolver.
</span><span class="c1"></span>    <span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can also see from this interface annotation that the Resolver implementation is responsible for monitoring (watch) the address and configuration changes measured by the service and updating the changes to the grpc&rsquo;s ClientConn. Let&rsquo;s take a look at our StaticResolver implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo2/greeter_client/resolver.go
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">StaticResolver</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">endpoints</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="nx">cc</span>        <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">StaticResolver</span><span class="p">)</span> <span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">doResolve</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">StaticResolver</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">StaticResolver</span><span class="p">)</span> <span class="nf">doResolve</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">addrs</span> <span class="p">[]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">endpoints</span> <span class="p">{</span>
        <span class="nx">addrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{</span>
            <span class="nx">Addr</span><span class="p">:</span>       <span class="nx">addr</span><span class="p">,</span>
            <span class="nx">ServerName</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;instance-%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="nx">newState</span> <span class="o">:=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
        <span class="nx">Addresses</span><span class="p">:</span> <span class="nx">addrs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">r</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: The annotation of the resolver.Resolver interface requires that the ResolveNow method is to support concurrency safety, so here we implement synchronization via sync.</p>
</blockquote>
<p>Since the number of service addresses and information on the service side are unchanged, there is no watch and update process here, but only the implementation of ResolveNow (and called in the Build method in the Builder), which updates the address set of the service instance in ResolveNow to ClientConnection(r.cc).</p>
<p>Next, let&rsquo;s compile and run the client and server of demo2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> grpc-client/demo2/greeter_server
<span class="nv">$make</span>
<span class="nv">$goreman</span> start
22:58:21 demo2-server1 <span class="p">|</span> Starting demo2-server1 on port <span class="m">5000</span>
22:58:21 demo2-server2 <span class="p">|</span> Starting demo2-server2 on port <span class="m">5100</span>
22:58:21 demo2-server3 <span class="p">|</span> Starting demo2-server3 on port <span class="m">5200</span>

<span class="nv">$cd</span> grpc-client/demo2/greeter_client
<span class="nv">$make</span>
$./demo2-client
</code></pre></td></tr></table>
</div>
</div><p>After executing for a while, you will find a problem in the logs on the server side, as shown in the following log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">22:57:16 demo2-server1 | 2021/09/11 22:57:16 Received: world-1
22:57:18 demo2-server1 | 2021/09/11 22:57:18 Received: world-2
22:57:20 demo2-server1 | 2021/09/11 22:57:20 Received: world-3
22:57:22 demo2-server1 | 2021/09/11 22:57:22 Received: world-4
22:57:24 demo2-server1 | 2021/09/11 22:57:24 Received: world-5
22:57:26 demo2-server1 | 2021/09/11 22:57:26 Received: world-6
22:57:28 demo2-server1 | 2021/09/11 22:57:28 Received: world-7
22:57:30 demo2-server1 | 2021/09/11 22:57:30 Received: world-8
22:57:32 demo2-server1 | 2021/09/11 22:57:32 Received: world-9
</code></pre></td></tr></table>
</div>
</div><p>There are clearly three addresses in our Service instance collection, why only server1 received the rpc request, the other two servers are in idle state? This is the client&rsquo;s load balancing policy at work! By default, grpc selects the built-in &ldquo;pick_first&rdquo; load balancing policy for the client, i.e., it selects the first intance in the service instance set for the request. In this example, with the pick_first policy, grpc will always choose demo2-server1 to initiate the rpc request.</p>
<p>If we want to send requests to individual servers, we can change the load balancing policy to another built-in policy: round_robin, like the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo2/greeter_client/main.go
</span><span class="c1"></span>
<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">DialContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">(),</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithBlock</span><span class="p">(),</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithBalancerName</span><span class="p">(</span><span class="s">&#34;round_robin&#34;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>After recompiling and running greeter_client, we can see in the server test that the rpc requests are polled to each server instance.</p>
<h3 id="2-resolver-principle">2) Resolver Principle</h3>
<p>Let&rsquo;s use a diagram to sort out how the Builder and Resolver work.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/a1601938d54046fd8372424b069611fb.png" alt="how the Builder and Resolver work"></p>
<p>The SchemeResolver in the diagram refers to a resolver that implements a particular scheme. as shown in the diagram, the steps of the service instance collection resolve process are roughly as follows.</p>
<ul>
<li>SchemeBuilder registers its own instance to the map of the resolver package.</li>
<li>grpc.Dial/DialContext when using a specific form of target parameter</li>
<li>After parsing the target, find the Buider corresponding to the Scheme in the map of the resolver package according to target.Scheme.</li>
<li>Build method of Buider is called</li>
<li>Build method to build the SchemeResolver instance.</li>
<li>Subsequently, the SchemeResolver instance monitors the service instance change status and updates the ClientConnection when there is a change.</li>
</ul>
<h3 id="3-nacosresolver">3) NacosResolver</h3>
<p>In the production environment, considering the high availability and scalability of services, we seldom use the fixed address and fixed number of service instance collections, and more often achieve the update of service instance collections automatically through the service registration and discovery mechanism. Here we implement a NacosResolver based on <a href="https://nacos.io/zh-cn/">nacos</a> to achieve automatic adjustment of the grpc Client when the service instance changes (Note: see the text appendix for the local single-node installation scheme of nacos), so that the example has real-world significance ^_^.</p>
<p>With the above description of the Resolver principle, here is a simplified description.</p>
<p>First, like StaticResolver, let&rsquo;s design the form of the target. nacos has the concept of namespace, group, so we will design the target as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">nacos://<span class="o">[</span>authority<span class="o">]</span>/host:port/namespace/group/serviceName
</code></pre></td></tr></table>
</div>
</div><p>Specifically in our greeter_client, its address is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo3/greeter_client/main.go
</span><span class="c1"></span>
<span class="kd">const</span> <span class="p">(</span>
      <span class="nx">address</span> <span class="p">=</span> <span class="s">&#34;nacos:///localhost:8848/public/group-a/demo3-service&#34;</span> <span class="c1">//no authority
</span><span class="c1"></span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Next we look at NacosBuilder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo3/greeter_client/builder.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">nb</span> <span class="o">*</span><span class="nx">NacosBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">target</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
    <span class="nx">cc</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span>
    <span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Resolver</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// use info in target to access naming service
</span><span class="c1"></span>    <span class="c1">// parse the target.endpoint
</span><span class="c1"></span>    <span class="c1">// target.Endpoint - localhost:8848/public/DEFAULT_GROUP/serviceName, the addr of naming service :nacos endpoint
</span><span class="c1"></span>    <span class="nx">sl</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
    <span class="nx">nacosAddr</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">namespace</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">group</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="nx">serviceName</span> <span class="o">:=</span> <span class="nx">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="nx">sl1</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">nacosAddr</span><span class="p">,</span> <span class="s">&#34;:&#34;</span><span class="p">)</span>
    <span class="nx">host</span> <span class="o">:=</span> <span class="nx">sl1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">port</span> <span class="o">:=</span> <span class="nx">sl1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">namingClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">initNamingClient</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">NacosResolver</span><span class="p">{</span>
        <span class="nx">namingClient</span><span class="p">:</span> <span class="nx">namingClient</span><span class="p">,</span>
        <span class="nx">cc</span><span class="p">:</span>           <span class="nx">cc</span><span class="p">,</span>
        <span class="nx">namespace</span><span class="p">:</span>    <span class="nx">namespace</span><span class="p">,</span>
        <span class="nx">group</span><span class="p">:</span>        <span class="nx">group</span><span class="p">,</span>
        <span class="nx">serviceName</span><span class="p">:</span>  <span class="nx">serviceName</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// initialize the cc&#39;s states
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">{})</span>

    <span class="c1">// subscribe and watch
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nf">watch</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">nb</span> <span class="o">*</span><span class="nx">NacosBuilder</span><span class="p">)</span> <span class="nf">Scheme</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;nacos&#34;</span>
<span class="p">}</span>
<span class="nx">NacosB</span>
</code></pre></td></tr></table>
</div>
</div><p>The process of the Build method of NacosBuilder is the same as StaticBuilder, first we also parse the incoming target&rsquo;s Endpoint, i.e. &ldquo;localhost:8848/public/group-a/demo3-service&rdquo;, and store the parsed segments in the newly created NacosResolver instance. &ldquo;The NacosResolver also needs one more piece of information, which is the connection to nacos. here we use initNamingClient to create a nacos client-side instance (call <a href="https://github.com/nacos-group/nacos-sdk-go">nacos provided go sdk</a>).</p>
<p>Next we call NacosResolver&rsquo;s ResolveNow to get a list of service instances of demo3-services on nacos and initialize ClientConn, and finally we call NacosResolver&rsquo;s watch method to subscribe and monitor demo3-services for instance changes. The following is a partial implementation of NacosResolver.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo3/greeter_client/resolver.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">NacosResolver</span><span class="p">)</span> <span class="nf">doResolve</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">instances</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">namingClient</span><span class="p">.</span><span class="nf">SelectAllInstances</span><span class="p">(</span><span class="nx">vo</span><span class="p">.</span><span class="nx">SelectAllInstancesParam</span><span class="p">{</span>
        <span class="nx">ServiceName</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
        <span class="nx">GroupName</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;service %s has zero instance\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// update cc.States
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">addrs</span> <span class="p">[]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">instances</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nx">inst</span><span class="p">.</span><span class="nx">Enable</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">Weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">addrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{</span>
            <span class="nx">Addr</span><span class="p">:</span>       <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%d&#34;</span><span class="p">,</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">Ip</span><span class="p">,</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">Port</span><span class="p">),</span>
            <span class="nx">ServerName</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;instance-%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">addrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;service %s has zero valid instance\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">newState</span> <span class="o">:=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
        <span class="nx">Addresses</span><span class="p">:</span> <span class="nx">addrs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">NacosResolver</span><span class="p">)</span> <span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">doResolve</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">NacosResolver</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">namingClient</span><span class="p">.</span><span class="nf">Unsubscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vo</span><span class="p">.</span><span class="nx">SubscribeParam</span><span class="p">{</span>
        <span class="nx">ServiceName</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
        <span class="nx">GroupName</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">NacosResolver</span><span class="p">)</span> <span class="nf">watch</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">namingClient</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vo</span><span class="p">.</span><span class="nx">SubscribeParam</span><span class="p">{</span>
        <span class="nx">ServiceName</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
        <span class="nx">GroupName</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span>
        <span class="nx">SubscribeCallback</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">services</span> <span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">SubscribeService</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;subcallback: %#v\n&#34;</span><span class="p">,</span> <span class="nx">services</span><span class="p">)</span>
            <span class="nx">r</span><span class="p">.</span><span class="nf">doResolve</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">{})</span>
        <span class="p">},</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>An important implementation here is the doResolve method called by both ResolveNow and watch, which gets all instances of demo-service3 via SelectAllInstances in the nacos-go sdk and updates the resulting set of enabled(=true) and weight(weight) The set of legal instances that are not 0 is updated to ClientConn(r.cc.UpdateState).</p>
<p>In the watch method of NacosResolver, we subscribe to demo3-service and provide a callback function via the Subscribe method in the nacos-go sdk. This callback will be called whenever the instance of demo3-service changes. In this callback we can update the ClientConn based on the latest set of service instances passed back (services []model.SubscribeService), but here we reuse the doResolve method, i.e. we go to nacos again to get an instance of demo-service3.</p>
<p>Compile and run greeter_server under demo3.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> grpc-client/demo3/greeter_server
<span class="nv">$make</span>
<span class="nv">$goreman</span> start
06:06:02 demo3-server3 <span class="p">|</span> Starting demo3-server3 on port <span class="m">5200</span>
06:06:02 demo3-server1 <span class="p">|</span> Starting demo3-server1 on port <span class="m">5000</span>
06:06:02 demo3-server2 <span class="p">|</span> Starting demo3-server2 on port <span class="m">5100</span>
06:06:02 demo3-server3 <span class="p">|</span> 2021-09-12T06:06:02.913+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50053&gt;   cacheDir:&lt;/tmp/nacos/cache/50053&gt;
06:06:02 demo3-server2 <span class="p">|</span> 2021-09-12T06:06:02.913+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50052&gt;   cacheDir:&lt;/tmp/nacos/cache/50052&gt;
06:06:02 demo3-server1 <span class="p">|</span> 2021-09-12T06:06:02.913+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50051&gt;   cacheDir:&lt;/tmp/nacos/cache/50051&gt;
</code></pre></td></tr></table>
</div>
</div><p>After running greeter_server, we will see all instances of demo-service3 on the nacos dashboard.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/93eae5f854e04c788be536ea072cf3fb.png" alt="nacos dashboard">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/9533180005a94e83b6c691e0e16649af.png" alt="nacos dashboard"></p>
<p>Compile and run greeter_client under demo3.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$cd</span> grpc-client/demo3/greeter_client
<span class="nv">$make</span>
$./demo3-client
2021-09-12T06:08:25.551+0800    INFO    nacos_client/nacos_client.go:87 logDir:&lt;/Users/tonybai/go/src/github.com/bigwhite/experiments/grpc-client/demo3/greeter_client/log&gt;   cacheDir:&lt;/Users/tonybai/go/src/github.com/bigwhite/experiments/grpc-client/demo3/greeter_client/cache&gt;
2021/09/12 06:08:25 Greeting: Hello world-1
2021/09/12 06:08:27 Greeting: Hello world-2
2021/09/12 06:08:29 Greeting: Hello world-3
2021/09/12 06:08:31 Greeting: Hello world-4
2021/09/12 06:08:33 Greeting: Hello world-5
2021/09/12 06:08:35 Greeting: Hello world-6
... ...
</code></pre></td></tr></table>
</div>
</div><p>Due to the round robin load policy, each server (with a weight of 1) on the greeter_server side will receive rpc requests equally.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">06:06:36 demo3-server1 | 2021/09/12 06:06:36 Received: world-1
06:06:38 demo3-server3 | 2021/09/12 06:06:38 Received: world-2
06:06:40 demo3-server2 | 2021/09/12 06:06:40 Received: world-3
06:06:42 demo3-server1 | 2021/09/12 06:06:42 Received: world-4
06:06:44 demo3-server3 | 2021/09/12 06:06:44 Received: world-5
06:06:46 demo3-server2 | 2021/09/12 06:06:46 Received: world-6
... ...
</code></pre></td></tr></table>
</div>
</div><p>At this point we can adjust the instance weight of demo3-service or take offline an instance through nacos dashboard, for example, take offline service-instance-2 (port 50052), after that we will see the greeter_client callback function executed, after that only the greeter_server side will instance-1 and instance-3 will receive rpc requests. After bringing service instance-2 back online, everything will be back to normal.</p>
<h2 id="3-customizing-the-client-balancer">3. Customizing the client balancer</h2>
<p>In reality, the server-side instances are deployed on different hosts (VMs/containers) with different computing power, so if all instances use the same weight1, it is definitely unscientific and wastes computing power. However, the built-in balancer of grpc-go is limited and cannot meet our needs, so we need to customize a balancer that can meet our needs.</p>
<p>Here we take a custom Weighted Round Robin (wrr) balancer as an example, and see the steps to customize the balancer (we refer to the built-in <a href="https://github.com/grpc/grpc-go/tree/">implementation of round_robin</a> in grpc-go) master/balancer/roundrobin)).</p>
<p>Similar to the resolver package, balancer is instantiated by a Builder (creation schema), and the Balancer interface of balancer is similar to resolver.Balancer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/balancer/balancer.go 
</span><span class="c1"></span>
<span class="c1">// Builder creates a balancer.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Builder</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Build creates a new balancer with the ClientConn.
</span><span class="c1"></span>    <span class="nf">Build</span><span class="p">(</span><span class="nx">cc</span> <span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">BuildOptions</span><span class="p">)</span> <span class="nx">Balancer</span>
    <span class="c1">// Name returns the name of balancers built by this builder.
</span><span class="c1"></span>    <span class="c1">// It will be used to pick balancers (for example in service config).
</span><span class="c1"></span>    <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Build method we build an implementation of the Balancer interface, the Balancer interface is defined as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/balancer/balancer.go 
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Balancer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// UpdateClientConnState is called by gRPC when the state of the ClientConn
</span><span class="c1"></span>    <span class="c1">// changes.  If the error returned is ErrBadResolverState, the ClientConn
</span><span class="c1"></span>    <span class="c1">// will begin calling ResolveNow on the active name resolver with
</span><span class="c1"></span>    <span class="c1">// exponential backoff until a subsequent call to UpdateClientConnState
</span><span class="c1"></span>    <span class="c1">// returns a nil error.  Any other errors are currently ignored.
</span><span class="c1"></span>    <span class="nf">UpdateClientConnState</span><span class="p">(</span><span class="nx">ClientConnState</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c1">// ResolverError is called by gRPC when the name resolver reports an error.
</span><span class="c1"></span>    <span class="nf">ResolverError</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
    <span class="c1">// UpdateSubConnState is called by gRPC when the state of a SubConn
</span><span class="c1"></span>    <span class="c1">// changes.
</span><span class="c1"></span>    <span class="nf">UpdateSubConnState</span><span class="p">(</span><span class="nx">SubConn</span><span class="p">,</span> <span class="nx">SubConnState</span><span class="p">)</span>
    <span class="c1">// Close closes the balancer. The balancer is not required to call
</span><span class="c1"></span>    <span class="c1">// ClientConn.RemoveSubConn for its existing SubConns.
</span><span class="c1"></span>    <span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, Balancer is much more complex than Resolver. gRPC&rsquo;s core developers saw this and provided a package that simplifies the creation of custom Balancers: <code>google.golang.org/grpc/balancer/base</code>. gRPC&rsquo;s built-in round_ robin Balancer is also based on the base package.</p>
<p>The base package provides NewBalancerBuilder to quickly return an implementation of balancer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/balancer/base/base.go 
</span><span class="c1"></span>
<span class="c1">// NewBalancerBuilder returns a base balancer builder configured by the provided config.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewBalancerBuilder</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">pb</span> <span class="nx">PickerBuilder</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">Config</span><span class="p">)</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Builder</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">baseBuilder</span><span class="p">{</span>
        <span class="nx">name</span><span class="p">:</span>          <span class="nx">name</span><span class="p">,</span>
        <span class="nx">pickerBuilder</span><span class="p">:</span> <span class="nx">pb</span><span class="p">,</span>
        <span class="nx">config</span><span class="p">:</span>        <span class="nx">config</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that this function takes one parameter: pb, which is of type PikcerBuilder, and this interface type is relatively simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/balancer/base/base.go 
</span><span class="c1"></span>
<span class="c1">// PickerBuilder creates balancer.Picker.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PickerBuilder</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Build returns a picker that will be used by gRPC to pick a SubConn.
</span><span class="c1"></span>    <span class="nf">Build</span><span class="p">(</span><span class="nx">info</span> <span class="nx">PickerBuildInfo</span><span class="p">)</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Picker</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We only need to provide an implementation of PickerBuilder and an implementation of balancer.Picker, which is an interface type with only one method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/grpc/grpc-go/balancer/balancer.go 
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Picker</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Pick</span><span class="p">(</span><span class="nx">info</span> <span class="nx">PickInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">PickResult</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Nested somewhat more, we use the following diagram to watch the creation and use process of balancer directly.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/29/dcb1bad528344cd989c11121fe694968.png" alt="balancer"></p>
<p>To recapitulate the general process.</p>
<ul>
<li>First register a balancer Builder:wrrBuilder named &ldquo;my_weighted_round_robin&rdquo;, which is built by the NewBalancerBuilder of the base package.</li>
<li>The NewBalancerBuilder function of the base package requires a PickerBuilder implementation to be passed in, so we need to customize a PickerBuilder that returns a Picker interface implementation.</li>
<li>grpc.Dial is called by passing in a WithBalancerName(&ldquo;my_weighted_round_robin&rdquo;). grpc selects our implementation from the registered balancer builder by balancer Name and call wrrrBuilder to create Picker: wrrPicker.</li>
<li>When the grpc implementation rpc calls SayHello, the Pick method of wrrrPicker is called, a Connection is selected, and an rpc request is sent on that connection.</li>
</ul>
<p>Due to the weight values used, our resolver implementation needs to make some changes, mainly setting the weight of the service instance to the ClientConnection via Attribute in the doResolve method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo4/greeter_client/resolver.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">NacosResolver</span><span class="p">)</span> <span class="nf">doResolve</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">instances</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">namingClient</span><span class="p">.</span><span class="nf">SelectAllInstances</span><span class="p">(</span><span class="nx">vo</span><span class="p">.</span><span class="nx">SelectAllInstancesParam</span><span class="p">{</span>
        <span class="nx">ServiceName</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
        <span class="nx">GroupName</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;service %s has zero instance\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// update cc.States
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">addrs</span> <span class="p">[]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">instances</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nx">inst</span><span class="p">.</span><span class="nx">Enable</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">Weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{</span>
            <span class="nx">Addr</span><span class="p">:</span>       <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%d&#34;</span><span class="p">,</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">Ip</span><span class="p">,</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">Port</span><span class="p">),</span>
            <span class="nx">ServerName</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;instance-%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="nx">addr</span><span class="p">.</span><span class="nx">Attributes</span> <span class="p">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;weight&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">Weight</span><span class="p">))</span> <span class="c1">//考虑权重并纳入cc的状态中
</span><span class="c1"></span>        <span class="nx">addrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">addrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;service %s has zero valid instance\n&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">newState</span> <span class="o">:=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
        <span class="nx">Addresses</span><span class="p">:</span> <span class="nx">addrs</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Next we focus on the implementation of wrrPickerBuilder and wrrPicker in greeter_client.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/bigwhite/experiments/tree/master/grpc-client/demo4/greeter_client/balancer.go
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">wrrPickerBuilder</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">wrrPickerBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">info</span> <span class="nx">base</span><span class="p">.</span><span class="nx">PickerBuildInfo</span><span class="p">)</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Picker</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">ReadySCs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">base</span><span class="p">.</span><span class="nf">NewErrPicker</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrNoSubConnAvailable</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">scs</span> <span class="p">[]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>
    <span class="c1">// 提取已经就绪的connection的权重信息，作为Picker实例的输入
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">subConn</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">info</span><span class="p">.</span><span class="nx">ReadySCs</span> <span class="p">{</span>
        <span class="nx">weight</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="s">&#34;weight&#34;</span><span class="p">).(</span><span class="kt">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">weight</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">weight</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">weight</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="nx">scs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">scs</span><span class="p">,</span> <span class="nx">subConn</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">wrrPicker</span><span class="p">{</span>
        <span class="nx">subConns</span><span class="p">:</span> <span class="nx">scs</span><span class="p">,</span>
        <span class="c1">// Start at a random index, as the same RR balancer rebuilds a new
</span><span class="c1"></span>        <span class="c1">// picker when SubConn states change, and we don&#39;t want to apply excess
</span><span class="c1"></span>        <span class="c1">// load to the first server in the list.
</span><span class="c1"></span>        <span class="nx">next</span><span class="p">:</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">scs</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">wrrPicker</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// subConns is the snapshot of the roundrobin balancer when this picker was
</span><span class="c1"></span>    <span class="c1">// created. The slice is immutable. Each Get() will do a round robin
</span><span class="c1"></span>    <span class="c1">// selection from it and return the selected SubConn.
</span><span class="c1"></span>    <span class="nx">subConns</span> <span class="p">[]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>

    <span class="nx">mu</span>   <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">next</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// 选出一个Connection
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">wrrPicker</span><span class="p">)</span> <span class="nf">Pick</span><span class="p">(</span><span class="nx">info</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">PickInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">PickResult</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">sc</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">next</span><span class="p">]</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subConns</span><span class="p">)</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">PickResult</span><span class="p">{</span><span class="nx">SubConn</span><span class="p">:</span> <span class="nx">sc</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is a simple Weighted Round Robin implementation, the weighting algorithm is very simple, if the weight of a conn is n, then add n conn in the weighted result set, so that in the subsequent Pick does not need to consider the weighting problem, just to the ordinary Round Robin as Pick out one by one.</p>
<p>After running demo4 greeter_server, we change the weight of instance-1 to 5 at nacos, and we subsequently see the following output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">$goreman start
09:20:18 demo4-server3 | Starting demo4-server3 on port 5200
09:20:18 demo4-server2 | Starting demo4-server2 on port 5100
09:20:18 demo4-server1 | Starting demo4-server1 on port 5000
09:20:18 demo4-server2 | 2021-09-12T09:20:18.633+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50052&gt;   cacheDir:&lt;/tmp/nacos/cache/50052&gt;
09:20:18 demo4-server1 | 2021-09-12T09:20:18.633+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50051&gt;   cacheDir:&lt;/tmp/nacos/cache/50051&gt;
09:20:18 demo4-server3 | 2021-09-12T09:20:18.633+0800   INFO    nacos_client/nacos_client.go:87 logDir:&lt;/tmp/nacos/log/50053&gt;   cacheDir:&lt;/tmp/nacos/cache/50053&gt;
09:20:23 demo4-server2 | 2021/09/12 09:20:23 Received: world-1
09:20:25 demo4-server3 | 2021/09/12 09:20:25 Received: world-2
09:20:27 demo4-server1 | 2021/09/12 09:20:27 Received: world-3
09:20:29 demo4-server2 | 2021/09/12 09:20:29 Received: world-4
09:20:31 demo4-server3 | 2021/09/12 09:20:31 Received: world-5
09:20:33 demo4-server1 | 2021/09/12 09:20:33 Received: world-6
09:20:35 demo4-server2 | 2021/09/12 09:20:35 Received: world-7
09:20:37 demo4-server3 | 2021/09/12 09:20:37 Received: world-8
09:20:39 demo4-server1 | 2021/09/12 09:20:39 Received: world-9
09:20:41 demo4-server2 | 2021/09/12 09:20:41 Received: world-10
09:20:43 demo4-server1 | 2021/09/12 09:20:43 Received: world-11
09:20:45 demo4-server2 | 2021/09/12 09:20:45 Received: world-12
09:20:47 demo4-server3 | 2021/09/12 09:20:47 Received: world-13
//这里将权重改为5后
09:20:49 demo4-server1 | 2021/09/12 09:20:49 Received: world-14
09:20:51 demo4-server1 | 2021/09/12 09:20:51 Received: world-15
09:20:53 demo4-server1 | 2021/09/12 09:20:53 Received: world-16
09:20:55 demo4-server1 | 2021/09/12 09:20:55 Received: world-17
09:20:57 demo4-server1 | 2021/09/12 09:20:57 Received: world-18
09:20:59 demo4-server2 | 2021/09/12 09:20:59 Received: world-19
09:21:01 demo4-server3 | 2021/09/12 09:21:01 Received: world-20
09:21:03 demo4-server1 | 2021/09/12 09:21:03 Received: world-21
</code></pre></td></tr></table>
</div>
</div><p>Note: Each time the service instance of nacos changes, balancer will rebuild a new Picker instance and subsequently use the new Picker instance to Pick out a conn in its Connection collection.</p>
<h2 id="4-summary">4. Summary</h2>
<p>In this article we have learned about the four communication modes of gRPC. We focused on the things to consider on the gRPC Client side in the most common simple RPC (unary RPC) mode, including.</p>
<ul>
<li>How to implement a helloworld for one-to-one communication</li>
<li>How to implement a custom Resolver to enable communication from a client to a collection of static service instances</li>
<li>How to implement a custom Resolver to enable communication from a client to a collection of dynamic service instances</li>
<li>How to customize the client Balancer</li>
</ul>
<p>The code in this article is for example use only and does not consider much exception handling.</p>
<p>All code involved in this article can be downloaded from <a href="https://github.com/bigwhite/experiments/tree/master/grpc-client">here</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/grpc/">grpc</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/golang-reflect/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Use the reflect package to read and write variables of all types in the reflection world</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/thanos-guide/">
            <span class="next-text nav-default">Thanos Advanced User Guide</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
