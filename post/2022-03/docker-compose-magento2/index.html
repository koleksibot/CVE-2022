<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deploying magento2 with docker-compose - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Environment centos 7 2-core 8g docker 1.13.1 docker-compose 1.24.1 Versions of each container php:7.3-fpm-buster mysql:8.0 nginx:1.21 redis:6.2 frp using debian:10-slim as the base image build The specific version is 0.38.0 frp&amp;rsquo;s main role is to act as a proxy for xdebug elasticsearch:7.9 The magento version is 2.3.4 The following section assumes that docker and docker-compose are already installed. This is intended as a development environment, so the code is not" /><meta name="keywords" content="Docker-Compose, Magento2" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/docker-compose-magento2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Deploying magento2 with docker-compose" />
<meta property="og:description" content="Environment centos 7 2-core 8g docker 1.13.1 docker-compose 1.24.1 Versions of each container php:7.3-fpm-buster mysql:8.0 nginx:1.21 redis:6.2 frp using debian:10-slim as the base image build The specific version is 0.38.0 frp&rsquo;s main role is to act as a proxy for xdebug elasticsearch:7.9 The magento version is 2.3.4 The following section assumes that docker and docker-compose are already installed. This is intended as a development environment, so the code is not" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/docker-compose-magento2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-07T10:11:51+08:00" />
<meta property="article:modified_time" content="2022-03-07T10:11:51+08:00" />

<meta itemprop="name" content="Deploying magento2 with docker-compose">
<meta itemprop="description" content="Environment centos 7 2-core 8g docker 1.13.1 docker-compose 1.24.1 Versions of each container php:7.3-fpm-buster mysql:8.0 nginx:1.21 redis:6.2 frp using debian:10-slim as the base image build The specific version is 0.38.0 frp&rsquo;s main role is to act as a proxy for xdebug elasticsearch:7.9 The magento version is 2.3.4 The following section assumes that docker and docker-compose are already installed. This is intended as a development environment, so the code is not"><meta itemprop="datePublished" content="2022-03-07T10:11:51+08:00" />
<meta itemprop="dateModified" content="2022-03-07T10:11:51+08:00" />
<meta itemprop="wordCount" content="4000">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploying magento2 with docker-compose"/>
<meta name="twitter:description" content="Environment centos 7 2-core 8g docker 1.13.1 docker-compose 1.24.1 Versions of each container php:7.3-fpm-buster mysql:8.0 nginx:1.21 redis:6.2 frp using debian:10-slim as the base image build The specific version is 0.38.0 frp&rsquo;s main role is to act as a proxy for xdebug elasticsearch:7.9 The magento version is 2.3.4 The following section assumes that docker and docker-compose are already installed. This is intended as a development environment, so the code is not"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deploying magento2 with docker-compose</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-07 10:11:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4000 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#environment">Environment</a></li>
        <li><a href="#configuration-files">Configuration files</a></li>
        <li><a href="#build-and-run">Build and run</a></li>
        <li><a href="#cautions-and-references">Cautions and references</a></li>
        <li><a href="#one-click-deployment-script">One-click deployment script</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="environment">Environment</h2>
<ul>
<li>centos 7
<ul>
<li>2-core 8g</li>
</ul>
</li>
<li>docker 1.13.1</li>
<li>docker-compose 1.24.1</li>
</ul>
<p>Versions of each container</p>
<ul>
<li>php:7.3-fpm-buster</li>
<li>mysql:8.0</li>
<li>nginx:1.21</li>
<li>redis:6.2</li>
<li>frp
<ul>
<li>using debian:10-slim as the base image build</li>
<li>The specific version is 0.38.0</li>
<li>frp&rsquo;s main role is to act as a proxy for xdebug</li>
</ul>
</li>
<li>elasticsearch:7.9</li>
</ul>
<p>The magento version is 2.3.4</p>
<p>The following section assumes that docker and docker-compose are already installed.</p>
<p>This is intended as a development environment, so the code is not packaged into the image.</p>
<p>For ease of presentation, we will assume that the root directory of magento is /var/html/www.</p>
<h2 id="configuration-files">Configuration files</h2>
<ol>
<li>
<p>Create a new docker folder in the root directory of magento, and a new vm folder in docker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">mkdir -p docker/vm
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create the following file in the vm folder</p>
<ul>
<li>
<p>Dockerfile</p>
</li>
<li>
<p>docker-compose.yml</p>
</li>
<li>
<p>nginx folder</p>
</li>
<li>
<p>frps folder</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">touch Dockerfile docker-compose.yml
mkdir nginx frps
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>Write the following in the /var/html/www/docker/vm/Dockerfile file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> php:7.3-fpm-buster</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sS -o composer.phar https://getcomposer.org/composer-1.phar <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    chmod <span class="m">0755</span> composer.phar <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    mv composer.phar /usr/local/bin/composer<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">requirements</span><span class="o">=</span><span class="s2">&#34;git cron rsync vim libpng-dev libmcrypt-dev libmcrypt4 libcurl3-dev libfreetype6 libjpeg62-turbo libjpeg62-turbo-dev libpng-dev libfreetype6-dev libicu-dev libxslt1-dev libzip-dev  unzip libc-client-dev libkrb5-dev&#34;</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    apt-get install -y <span class="nv">$requirements</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    rm -rf /var/lib/apt/lists/*<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> pdo_mysql <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-configure gd --with-freetype-dir<span class="o">=</span>/usr/include/ --with-jpeg-dir<span class="o">=</span>/usr/include/ <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> gd <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> mbstring <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> zip <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> intl <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> xsl <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> soap <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> bcmath <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> opcache <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-configure imap --with-kerberos --with-imap-ssl <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> imap <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-install -j<span class="k">$(</span>nproc<span class="k">)</span> sockets <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">requirementsToRemove</span><span class="o">=</span><span class="s2">&#34;libpng-dev libmcrypt-dev libcurl3-dev libpng-dev libfreetype6-dev libjpeg62-turbo-dev&#34;</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    apt-get purge --auto-remove -y <span class="nv">$requirementsToRemove</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">printf</span> <span class="s2">&#34;\n\n\n&#34;</span> <span class="p">|</span> pecl install redis-4.0.0 <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-enable redis<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> pecl install xdebug-2.9.8 <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    docker-php-ext-enable xdebug <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.remote_enable=on&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.remote_host=frps&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.remote_port=9003&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.show_local_vars=on&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.default_enable=on&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;xdebug.idekey=vscode&#34;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> cp /usr/local/etc/php/php.ini-development /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/short_open_tag = Off/short_open_tag = On/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/memory_limit = 128M/memory_limit = 4G/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/;max_input_vars = 1000/max_input_vars = 10000/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/;date.timezone=/date.timezone = &#34;Asia\/Hong_Kong&#34;/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/;opcache.enable=1/opcache.enable=1/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/;opcache.enable_cli=0/opcache.enable_cli=1/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/max_execution_time = 30/max_execution_time = 900/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/upload_max_filesize = 2M/upload_max_filesize = 64M/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/post_max_size = 8M/post_max_size = 128M/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/max_input_time = 60/max_input_time = 300/g&#39;</span> /usr/local/etc/php/php.ini <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/pm = dynamic/pm = static/g&#39;</span> /usr/local/etc/php-fpm.d/www.conf <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/pm.max_children = 5/pm.max_children = 32/g&#39;</span> /usr/local/etc/php-fpm.d/www.conf <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    sed -i <span class="s1">&#39;s/;pm.max_requests = 500/pm.max_requests = 500/g&#39;</span> /usr/local/etc/php-fpm.d/www.conf<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /var/www/html</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown root:root -R /var/www <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    chmod <span class="m">777</span> -R /var/www<span class="err">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Execute this command in the /var/html/www/docker/vm/nginx folder, mainly to generate the https certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">openssl req -newkey rsa:4096 -nodes -keyout rsa_private_key.pem -x509 -days <span class="m">365</span> -out domain.crt -subj <span class="s2">&#34;/C=CN/ST=State/L=City/O=Ltd/OU=Section/CN=test.magento2.com&#34;</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create a new file called nginx.conf in the /var/html/www/docker/vm/nginx folder and write the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">user  root;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                    &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                    &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/default.conf;

    upstream fastcgi_backend {
        server  php:9000;
    }
    server {
        listen 80;

        listen 443 ssl http2;
        ssl_certificate  ./cert/domain.crt;
        ssl_certificate_key ./cert/rsa_private_key.pem;

        access_log  /var/log/nginx/magento.access.log;
        error_log  /var/log/nginx/magento.error.log;

        server_name test.magento2.com; # 这里的域名要和证书的域名一致
        set $MAGE_ROOT /var/www/html; # 这里是 magento 的根目录
        set $MAGE_DEBUG_SHOW_ARGS 1;
        include /var/www/html/nginx.conf.sample; # 这里是 magento 的根目录里的 nginx.conf.sample
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create a new file called frps.ini in the /var/html/www/docker/vm/frps folder and write the following</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[common]</span>
<span class="na">bind_port</span><span class="o">=</span><span class="s">8999</span>
<span class="na">token</span><span class="o">=</span><span class="s">sdfjsldfwqefwnjnvosadfp</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create a new file called Dockerfile in the /var/html/www/docker/vm/frps folder and write the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> debian:10-slim</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">FRP_VERSION</span><span class="o">=</span><span class="m">0</span>.38.0<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y wget<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /tmp</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">set</span> -x <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> wget https://github.com/fatedier/frp/releases/download/v<span class="si">${</span><span class="nv">FRP_VERSION</span><span class="si">}</span>/frp_<span class="si">${</span><span class="nv">FRP_VERSION</span><span class="si">}</span>_linux_amd64.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> tar -zxf frp_<span class="si">${</span><span class="nv">FRP_VERSION</span><span class="si">}</span>_linux_amd64.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mv frp_<span class="si">${</span><span class="nv">FRP_VERSION</span><span class="si">}</span>_linux_amd64 /var/frp <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /var/frp/conf <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt remove -y wget <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt autoremove -y <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> frps.ini /var/frp/conf/frps.ini<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /var/frp</span><span class="err">
</span><span class="err"></span><span class="k">ENTRYPOINT</span> ./frps -c ./conf/frps.ini<span class="err">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Write the following in the /var/html/www/docker/vm/docker-compose.yml file</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.2&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">php</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w"> </span><span class="c"># 相对于 docker-compose.yml 的路径</span><span class="w">
</span><span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w"> </span><span class="c"># 相对于 context 的路径</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">php</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">mysqld</span><span class="w">
</span><span class="w">        </span>- <span class="l">redis</span><span class="w">
</span><span class="w">        </span>- <span class="l">frps</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">./../../:/var/www/html</span><span class="w"> </span><span class="c"># 相对于 docker-compose.yml 的路径</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;php-fpm&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="l">Asia/Shanghai</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">nginx</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.21</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="m">80</span><span class="p">:</span><span class="m">80</span><span class="w">
</span><span class="w">        </span>- <span class="m">443</span><span class="p">:</span><span class="m">443</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">php</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">./../../:/var/www/html:ro</span><span class="w">
</span><span class="w">        </span>- <span class="l">./nginx/nginx.conf:/etc/nginx/nginx.conf:ro</span><span class="w">
</span><span class="w">        </span>- <span class="l">./nginx/domain.crt:/etc/nginx/cert/domain.crt:ro</span><span class="w">
</span><span class="w">        </span>- <span class="l">./nginx/rsa_private_key.pem:/etc/nginx/cert/rsa_private_key.pem:ro</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="l">Asia/Shanghai</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mysqld</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mysql:5.7</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">mysqld</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="m">3306</span><span class="p">:</span><span class="m">3306</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">~/mysql-data:/var/lib/mysql</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">MYSQL_DATABASE</span><span class="p">:</span><span class="w"> </span><span class="l">magento234</span><span class="w">
</span><span class="w">    </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">        </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="l">Asia/Shanghai</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">redis:6.2</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="m">6379</span><span class="p">:</span><span class="m">6379</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">TZ</span><span class="p">:</span><span class="w"> </span><span class="l">Asia/Shanghai</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">frps</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./frps</span><span class="w">
</span><span class="w">    </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">frps</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="m">8999</span><span class="p">:</span><span class="m">8999</span><span class="w">
</span><span class="w">        </span>- <span class="m">9003</span><span class="p">:</span><span class="m">9003</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">elasticsearch</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch:7.9.3</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="m">9200</span><span class="p">:</span><span class="m">9200</span><span class="w">
</span><span class="w">        </span>- <span class="m">9300</span><span class="p">:</span><span class="m">9300</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">discovery.type</span><span class="p">:</span><span class="w"> </span><span class="l">single-node</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="build-and-run">Build and run</h2>
<ol>
<li>
<p>To build the image, run this command from the root of magento.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker-compose -f ./docker/vm/docker-compose.yml build
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>To run the container, run this command from the root of magento.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker-compose -f ./docker/vm/docker-compose.yml up -d
or
docker-compose -f ./docker/vm/docker-compose.yml up
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Stop the container and run this command from the root of magento, or ctrl-c if it&rsquo;s not running in the background.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker-compose -f ./docker/vm/docker-compose.yml stop
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Uninstall the container and run this command from the root of magento.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker-compose -f ./docker/vm/docker-compose.yml down
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="cautions-and-references">Cautions and references</h2>
<p>If you change the Dockerfile, you will have to rebuild the image.</p>
<p>Pay attention to the permissions of the directory where the container is mounted. Both fpm and nginx need permission to access the magento directory.</p>
<p>After the container is started, you need to go into the fpm container and run the magento build command, assuming the fpm container name is php.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker ps -a
docker <span class="nb">exec</span> -it php /bin/bash
</code></pre></td></tr></table>
</div>
</div><p>If you have an existing magento project, import the database and change the fields in the core_config_data table before running the build command.</p>
<p>Remember to modify the hosts file.</p>
<h2 id="one-click-deployment-script">One-click deployment script</h2>
<p>Assuming that docker and docker-compose are installed and the corresponding ports are not occupied</p>
<ul>
<li>2.3</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># 假设已经安装好 docker 和 docker-compose</span>

<span class="c1"># 下载源码</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;100<span class="p">;</span>i++<span class="o">))</span>
<span class="k">do</span>
    curl -L -o magento2.tar.gz --connect-timeout <span class="m">120</span> --max-time <span class="m">3600</span> --retry <span class="m">100</span> --retry-delay <span class="m">5</span> https://github.com/magento/magento2/archive/refs/tags/2.3.4.tar.gz
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">break</span>
    <span class="k">fi</span>
<span class="k">done</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;can not download magento source code&#34;</span>
    <span class="nb">exit</span> 1<span class="p">;</span>
<span class="k">fi</span>

<span class="c1"># 解压源码</span>

tar -zxf magento2.tar.gz
mv magento2-2.3.4 magento234

<span class="c1"># 在新建对应的文件</span>

<span class="nb">cd</span> magento234
rm -r .github
mkdir -p docker/vm
<span class="nb">cd</span> docker/vm
touch Dockerfile docker-compose.yml
mkdir nginx frps

<span class="nb">cd</span> nginx
openssl req -newkey rsa:4096 -nodes -keyout rsa_private_key.pem -x509 -days <span class="m">365</span> -out domain.crt -subj <span class="s2">&#34;/C=CN/ST=State/L=City/O=Ltd/OU=Section/CN=test.magento2.com&#34;</span>

cat &gt; nginx.conf <span class="s">&lt;&lt; EOF
</span><span class="s">user  root;
</span><span class="s">worker_processes  auto;
</span><span class="s">
</span><span class="s">error_log  /var/log/nginx/error.log notice;
</span><span class="s">pid        /var/run/nginx.pid;
</span><span class="s">
</span><span class="s">
</span><span class="s">events {
</span><span class="s">    worker_connections  1024;
</span><span class="s">}
</span><span class="s">
</span><span class="s">
</span><span class="s">http {
</span><span class="s">    include       /etc/nginx/mime.types;
</span><span class="s">    default_type  application/octet-stream;
</span><span class="s">
</span><span class="s">    log_format  main  &#39;\$remote_addr - \$remote_user [\$time_local] &#34;\$request&#34; &#39;
</span><span class="s">                    &#39;\$status $body_bytes_sent &#34;\$http_referer&#34; &#39;
</span><span class="s">                    &#39;&#34;\$http_user_agent&#34; &#34;\$http_x_forwarded_for&#34;&#39;;
</span><span class="s">
</span><span class="s">    access_log  /var/log/nginx/access.log  main;
</span><span class="s">
</span><span class="s">    sendfile        on;
</span><span class="s">    #tcp_nopush     on;
</span><span class="s">
</span><span class="s">    keepalive_timeout  65;
</span><span class="s">
</span><span class="s">    #gzip  on;
</span><span class="s">
</span><span class="s">    include /etc/nginx/conf.d/default.conf;
</span><span class="s">
</span><span class="s">    upstream fastcgi_backend {
</span><span class="s">        server  php:9000;
</span><span class="s">    }
</span><span class="s">    server {
</span><span class="s">        listen 80;
</span><span class="s">
</span><span class="s">        listen 443 ssl http2;
</span><span class="s">        ssl_certificate  ./cert/domain.crt;
</span><span class="s">        ssl_certificate_key ./cert/rsa_private_key.pem;
</span><span class="s">
</span><span class="s">        access_log  /var/log/nginx/magento.access.log;
</span><span class="s">        error_log  /var/log/nginx/magento.error.log;
</span><span class="s">
</span><span class="s">        server_name test.magento2.com; # 这里的域名要和证书的域名一致
</span><span class="s">        set \$MAGE_ROOT /var/www/html; # 这里是 magento 的根目录
</span><span class="s">        set \$MAGE_DEBUG_SHOW_ARGS 1;
</span><span class="s">        include /var/www/html/nginx.conf.sample; # 这里是 magento 的根目录里的 nginx.conf.sample
</span><span class="s">        fastcgi_buffers 16 16k;
</span><span class="s">        fastcgi_buffer_size 32k;
</span><span class="s">        proxy_buffer_size 128k;
</span><span class="s">        proxy_buffers 4 256k;
</span><span class="s">        proxy_busy_buffers_size 256k;
</span><span class="s">    }
</span><span class="s">}
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
<span class="nb">cd</span> frps
cat &gt; frps.ini <span class="s">&lt;&lt; EOF
</span><span class="s">[common]
</span><span class="s">bind_port=8999
</span><span class="s">token=sdfjsldfwqefwnjnvosadfp
</span><span class="s">EOF</span>

cat &gt; Dockerfile <span class="s">&lt;&lt; EOF
</span><span class="s">FROM debian:10-slim
</span><span class="s">
</span><span class="s">ARG FRP_VERSION=0.38.0
</span><span class="s">
</span><span class="s">RUN apt update \
</span><span class="s">    &amp;&amp; apt install -y wget
</span><span class="s">
</span><span class="s">WORKDIR /tmp
</span><span class="s">RUN set -x \
</span><span class="s">    &amp;&amp; wget https://github.com/fatedier/frp/releases/download/v\${FRP_VERSION}/frp_\${FRP_VERSION}_linux_amd64.tar.gz \
</span><span class="s">    &amp;&amp; tar -zxf frp_\${FRP_VERSION}_linux_amd64.tar.gz \
</span><span class="s">    &amp;&amp; mv frp_\${FRP_VERSION}_linux_amd64 /var/frp \
</span><span class="s">    &amp;&amp; mkdir -p /var/frp/conf \
</span><span class="s">    &amp;&amp; apt remove -y wget \
</span><span class="s">    &amp;&amp; apt autoremove -y \
</span><span class="s">    &amp;&amp; rm -rf /var/lib/apt/lists/*
</span><span class="s">
</span><span class="s">COPY frps.ini /var/frp/conf/frps.ini
</span><span class="s">
</span><span class="s">WORKDIR /var/frp
</span><span class="s">ENTRYPOINT ./frps -c ./conf/frps.ini
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
cat &gt; Dockerfile <span class="s">&lt;&lt; EOF
</span><span class="s">FROM php:7.3-fpm-buster
</span><span class="s">
</span><span class="s">RUN curl -sS -o composer.phar https://getcomposer.org/composer-1.phar &amp;&amp; \
</span><span class="s">    chmod 0755 composer.phar &amp;&amp; \
</span><span class="s">    mv composer.phar /usr/local/bin/composer
</span><span class="s">
</span><span class="s">RUN apt-get update &amp;&amp; \
</span><span class="s">    requirements=&#34;git cron rsync vim libpng-dev libmcrypt-dev libmcrypt4 libcurl3-dev libfreetype6 libjpeg62-turbo libjpeg62-turbo-dev libpng-dev libfreetype6-dev libicu-dev libxslt1-dev libzip-dev unzip libc-client-dev libkrb5-dev&#34; &amp;&amp; \
</span><span class="s">    apt-get install -y \$requirements &amp;&amp; \
</span><span class="s">    rm -rf /var/lib/apt/lists/*
</span><span class="s">
</span><span class="s">RUN docker-php-ext-install -j\$(nproc) pdo_mysql &amp;&amp; \
</span><span class="s">    docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) gd &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) mbstring &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) zip &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) intl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) xsl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) soap &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) bcmath &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) opcache &amp;&amp; \
</span><span class="s">    docker-php-ext-configure imap --with-kerberos --with-imap-ssl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) imap &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) sockets &amp;&amp; \
</span><span class="s">    requirementsToRemove=&#34;libpng-dev libmcrypt-dev libcurl3-dev libpng-dev libfreetype6-dev libjpeg62-turbo-dev&#34; &amp;&amp; \
</span><span class="s">    apt-get purge --auto-remove -y \$requirementsToRemove &amp;&amp; \
</span><span class="s">    printf &#34;\n\n\n&#34; | pecl install redis-4.0.0 &amp;&amp; \
</span><span class="s">    docker-php-ext-enable redis
</span><span class="s">
</span><span class="s">RUN pecl install xdebug-2.9.8 &amp;&amp; \
</span><span class="s">    docker-php-ext-enable xdebug &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_enable=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_host=frps&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_port=9003&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.show_local_vars=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.default_enable=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.idekey=vscode&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
</span><span class="s">
</span><span class="s">RUN cp /usr/local/etc/php/php.ini-development /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/short_open_tag = Off/short_open_tag = On/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/memory_limit = 128M/memory_limit = 4G/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;max_input_vars = 1000/max_input_vars = 10000/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;date.timezone=/date.timezone = &#34;Asia\/Hong_Kong&#34;/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;opcache.enable=1/opcache.enable=1/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;opcache.enable_cli=0/opcache.enable_cli=1/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/max_execution_time = 30/max_execution_time = 900/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/upload_max_filesize = 2M/upload_max_filesize = 64M/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/post_max_size = 8M/post_max_size = 128M/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/max_input_time = 60/max_input_time = 300/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/pm = dynamic/pm = static/g&#39; /usr/local/etc/php-fpm.d/www.conf &amp;&amp; \
</span><span class="s">    sed -i &#39;s/pm.max_children = 5/pm.max_children = 32/g&#39; /usr/local/etc/php-fpm.d/www.conf &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;pm.max_requests = 500/pm.max_requests = 500/g&#39; /usr/local/etc/php-fpm.d/www.conf
</span><span class="s">
</span><span class="s">WORKDIR /var/www/html
</span><span class="s">RUN chown root:root -R /var/www &amp;&amp; \
</span><span class="s">    chmod 777 -R /var/www
</span><span class="s">EOF</span>

cat &gt; docker-compose.yml <span class="s">&lt;&lt; EOF
</span><span class="s">version: &#39;3.2&#39;
</span><span class="s">services:
</span><span class="s">  php:
</span><span class="s">    build:
</span><span class="s">      context: . # 相对于 docker-compose.yml 的路径
</span><span class="s">      dockerfile: Dockerfile # 相对于 context 的路径
</span><span class="s">    restart: always
</span><span class="s">    container_name: php
</span><span class="s">    depends_on:
</span><span class="s">      - mysqld
</span><span class="s">      - redis
</span><span class="s">      - frps
</span><span class="s">    volumes:
</span><span class="s">      - ./../../:/var/www/html # 相对于 docker-compose.yml 的路径
</span><span class="s">    user: root
</span><span class="s">    command: [&#34;php-fpm&#34;]
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  nginx:
</span><span class="s">    image: nginx:1.21
</span><span class="s">    restart: always
</span><span class="s">    container_name: nginx
</span><span class="s">    ports:
</span><span class="s">      - 80:80
</span><span class="s">      - 443:443
</span><span class="s">    depends_on:
</span><span class="s">      - php
</span><span class="s">    volumes:
</span><span class="s">      - ./../../:/var/www/html:ro
</span><span class="s">      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
</span><span class="s">      - ./nginx/domain.crt:/etc/nginx/cert/domain.crt:ro
</span><span class="s">      - ./nginx/rsa_private_key.pem:/etc/nginx/cert/rsa_private_key.pem:ro
</span><span class="s">    user: root
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  mysqld:
</span><span class="s">    image: mysql:5.7
</span><span class="s">    restart: always
</span><span class="s">    container_name: mysqld
</span><span class="s">    ports:
</span><span class="s">      - 3307:3306
</span><span class="s">    volumes:
</span><span class="s">      - ~/mysql-data:/var/lib/mysql
</span><span class="s">    environment:
</span><span class="s">      MYSQL_DATABASE: magento234
</span><span class="s">      MYSQL_ROOT_PASSWORD: 123456
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  redis:
</span><span class="s">    image: redis:6.2
</span><span class="s">    restart: always
</span><span class="s">    container_name: redis
</span><span class="s">    ports:
</span><span class="s">      - 6379:6379
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  frps:
</span><span class="s">    build:
</span><span class="s">      context: ./frps
</span><span class="s">      dockerfile: Dockerfile
</span><span class="s">    container_name: frps
</span><span class="s">    ports:
</span><span class="s">      - 8999:8999
</span><span class="s">      - 9003:9003
</span><span class="s">
</span><span class="s">  # elasticsearch:
</span><span class="s">  #   image: elasticsearch:7.9.3
</span><span class="s">  #   restart: always
</span><span class="s">  #   container_name: elasticsearch
</span><span class="s">  #   ports:
</span><span class="s">  #     - 9200:9200
</span><span class="s">  #     - 9300:9300
</span><span class="s">  #   environment:
</span><span class="s">  #     discovery.type: single-node
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
<span class="nb">cd</span> ..
<span class="nb">pwd</span>

<span class="c1"># 运行构建命令</span>

docker-compose -f ./docker/vm/docker-compose.yml build

docker-compose -f ./docker/vm/docker-compose.yml up -d

sleep <span class="m">10</span>

cat &gt; init.sh <span class="s">&lt;&lt; EOF
</span><span class="s">#!/bin/bash
</span><span class="s">
</span><span class="s">chmod 777 -R /var/www
</span><span class="s">
</span><span class="s">composer install
</span><span class="s">
</span><span class="s">php bin/magento setup:install \
</span><span class="s">    --base-url=https://localhost-magento/ \
</span><span class="s">    --db-host=mysqld \
</span><span class="s">    --db-name=magento234 \
</span><span class="s">    --db-user=root \
</span><span class="s">    --db-password=123456 \
</span><span class="s">    --cleanup-database \
</span><span class="s">    --admin-firstname=admin \
</span><span class="s">    --admin-lastname=admin \
</span><span class="s">    --admin-email=admin@admin.com \
</span><span class="s">    --admin-user=admin \
</span><span class="s">    --admin-password=admin123 \
</span><span class="s">    --backend-frontname=admin \
</span><span class="s">    --language=en_US \
</span><span class="s">    --currency=USD \
</span><span class="s">    --timezone=Asia/Shanghai \
</span><span class="s">    --use-rewrites=1
</span><span class="s">
</span><span class="s">php bin/magento setup:config:set --cache-backend=redis --cache-backend-redis-server=redis --cache-backend-redis-db=0
</span><span class="s">php bin/magento setup:config:set --page-cache=redis --page-cache-redis-server=redis --page-cache-redis-db=1
</span><span class="s">
</span><span class="s">php bin/magento deploy:mode:set developer
</span><span class="s">php bin/magento setup:upgrade
</span><span class="s">php bin/magento setup:static-content:deploy -f
</span><span class="s">php bin/magento indexer:reindex
</span><span class="s">php bin/magento cache:flush
</span><span class="s">
</span><span class="s">chmod 777 -R /var/www
</span><span class="s">
</span><span class="s">EOF</span>

chmod <span class="m">777</span> init.sh
docker cp <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/init.sh php:/var/www/html/init.sh
sleep <span class="m">1</span>
docker <span class="nb">exec</span> php /var/www/html/init.sh

<span class="c1"># curl http://doututuan.com/test.sh|bash</span>
<span class="c1"># vim install23.sh</span>
<span class="c1"># chmod 755 install23.sh</span>
<span class="c1"># ./install23.sh</span>
<span class="c1"># time ./install23.sh</span>
<span class="c1"># docker-compose -f ./magento234/docker/vm/docker-compose.yml stop</span>
<span class="c1"># rm magento2.tar.gz &amp;&amp; rm -r magento234 &amp;&amp; rm -r mysql-data</span>
<span class="c1"># docker rm `docker ps -a | grep Exited | awk &#39;{print $1}&#39;`</span>
2.4
<span class="c1">#!/bin/bash</span>

<span class="c1"># 假设已经安装好 docker 和 docker-compose</span>

<span class="c1"># 下载源码</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;100<span class="p">;</span>i++<span class="o">))</span>
<span class="k">do</span>
    curl -L -o magento2.tar.gz --connect-timeout <span class="m">120</span> --max-time <span class="m">3600</span> --retry <span class="m">100</span> --retry-delay <span class="m">5</span> https://github.com/magento/magento2/archive/refs/tags/2.4.2.tar.gz
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">break</span>
    <span class="k">fi</span>
<span class="k">done</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;can not download magento source code&#34;</span>
    <span class="nb">exit</span> 1<span class="p">;</span>
<span class="k">fi</span>

<span class="c1"># 解压源码</span>

tar -zxf magento2.tar.gz
mv magento2-2.4.2 magento242

<span class="c1"># 在新建对应的文件</span>

<span class="nb">cd</span> magento242
rm -r .github
mkdir -p docker/vm
<span class="nb">cd</span> docker/vm
touch Dockerfile docker-compose.yml
mkdir nginx frps

<span class="nb">cd</span> nginx
openssl req -newkey rsa:4096 -nodes -keyout rsa_private_key.pem -x509 -days <span class="m">365</span> -out domain.crt -subj <span class="s2">&#34;/C=CN/ST=State/L=City/O=Ltd/OU=Section/CN=test.magento2.com&#34;</span>

cat &gt; nginx.conf <span class="s">&lt;&lt; EOF
</span><span class="s">user  root;
</span><span class="s">worker_processes  auto;
</span><span class="s">
</span><span class="s">error_log  /var/log/nginx/error.log notice;
</span><span class="s">pid        /var/run/nginx.pid;
</span><span class="s">
</span><span class="s">
</span><span class="s">events {
</span><span class="s">    worker_connections  1024;
</span><span class="s">}
</span><span class="s">
</span><span class="s">
</span><span class="s">http {
</span><span class="s">    include       /etc/nginx/mime.types;
</span><span class="s">    default_type  application/octet-stream;
</span><span class="s">
</span><span class="s">    log_format  main  &#39;\$remote_addr - \$remote_user [\$time_local] &#34;\$request&#34; &#39;
</span><span class="s">                    &#39;\$status $body_bytes_sent &#34;\$http_referer&#34; &#39;
</span><span class="s">                    &#39;&#34;\$http_user_agent&#34; &#34;\$http_x_forwarded_for&#34;&#39;;
</span><span class="s">
</span><span class="s">    access_log  /var/log/nginx/access.log  main;
</span><span class="s">
</span><span class="s">    sendfile        on;
</span><span class="s">    #tcp_nopush     on;
</span><span class="s">
</span><span class="s">    keepalive_timeout  65;
</span><span class="s">
</span><span class="s">    #gzip  on;
</span><span class="s">
</span><span class="s">    include /etc/nginx/conf.d/default.conf;
</span><span class="s">
</span><span class="s">    upstream fastcgi_backend {
</span><span class="s">        server  php:9000;
</span><span class="s">    }
</span><span class="s">    server {
</span><span class="s">        listen 80;
</span><span class="s">
</span><span class="s">        listen 443 ssl http2;
</span><span class="s">        ssl_certificate  ./cert/domain.crt;
</span><span class="s">        ssl_certificate_key ./cert/rsa_private_key.pem;
</span><span class="s">
</span><span class="s">        access_log  /var/log/nginx/magento.access.log;
</span><span class="s">        error_log  /var/log/nginx/magento.error.log;
</span><span class="s">
</span><span class="s">        server_name test.magento2.com; # 这里的域名要和证书的域名一致
</span><span class="s">        set \$MAGE_ROOT /var/www/html; # 这里是 magento 的根目录
</span><span class="s">        set \$MAGE_DEBUG_SHOW_ARGS 1;
</span><span class="s">        include /var/www/html/nginx.conf.sample; # 这里是 magento 的根目录里的 nginx.conf.sample
</span><span class="s">        fastcgi_buffers 16 16k;
</span><span class="s">        fastcgi_buffer_size 32k;
</span><span class="s">        proxy_buffer_size 128k;
</span><span class="s">        proxy_buffers 4 256k;
</span><span class="s">        proxy_busy_buffers_size 256k;
</span><span class="s">    }
</span><span class="s">}
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
<span class="nb">cd</span> frps
cat &gt; frps.ini <span class="s">&lt;&lt; EOF
</span><span class="s">[common]
</span><span class="s">bind_port=8999
</span><span class="s">token=sdfjsldfwqefwnjnvosadfp
</span><span class="s">EOF</span>

cat &gt; Dockerfile <span class="s">&lt;&lt; EOF
</span><span class="s">FROM debian:10-slim
</span><span class="s">
</span><span class="s">ARG FRP_VERSION=0.38.0
</span><span class="s">
</span><span class="s">RUN apt update \
</span><span class="s">    &amp;&amp; apt install -y wget
</span><span class="s">
</span><span class="s">WORKDIR /tmp
</span><span class="s">RUN set -x \
</span><span class="s">    &amp;&amp; wget https://github.com/fatedier/frp/releases/download/v\${FRP_VERSION}/frp_\${FRP_VERSION}_linux_amd64.tar.gz \
</span><span class="s">    &amp;&amp; tar -zxf frp_\${FRP_VERSION}_linux_amd64.tar.gz \
</span><span class="s">    &amp;&amp; mv frp_\${FRP_VERSION}_linux_amd64 /var/frp \
</span><span class="s">    &amp;&amp; mkdir -p /var/frp/conf \
</span><span class="s">    &amp;&amp; apt remove -y wget \
</span><span class="s">    &amp;&amp; apt autoremove -y \
</span><span class="s">    &amp;&amp; rm -rf /var/lib/apt/lists/*
</span><span class="s">
</span><span class="s">COPY frps.ini /var/frp/conf/frps.ini
</span><span class="s">
</span><span class="s">WORKDIR /var/frp
</span><span class="s">ENTRYPOINT ./frps -c ./conf/frps.ini
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
cat &gt; Dockerfile <span class="s">&lt;&lt; EOF
</span><span class="s">FROM php:7.4-fpm-buster
</span><span class="s">
</span><span class="s">RUN curl -sS -o composer.phar https://getcomposer.org/composer.phar &amp;&amp; \
</span><span class="s">    chmod 0755 composer.phar &amp;&amp; \
</span><span class="s">    mv composer.phar /usr/local/bin/composer
</span><span class="s">
</span><span class="s">RUN apt-get update &amp;&amp; \
</span><span class="s">    requirements=&#34;git cron rsync vim libpng-dev libmcrypt-dev libmcrypt4 libcurl3-dev libfreetype6 libjpeg62-turbo libjpeg62-turbo-dev libpng-dev libfreetype6-dev libicu-dev libxslt1-dev libzip-dev unzip libc-client-dev libkrb5-dev libonig-dev&#34; &amp;&amp; \
</span><span class="s">    apt-get install -y \$requirements &amp;&amp; \
</span><span class="s">    rm -rf /var/lib/apt/lists/*
</span><span class="s">
</span><span class="s">RUN docker-php-ext-install -j\$(nproc) pdo_mysql &amp;&amp; \
</span><span class="s">    docker-php-ext-configure gd --with-freetype --with-jpeg &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) gd &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) mbstring &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) zip &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) intl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) xsl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) soap &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) bcmath &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) opcache &amp;&amp; \
</span><span class="s">    docker-php-ext-configure imap --with-kerberos --with-imap-ssl &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) imap &amp;&amp; \
</span><span class="s">    docker-php-ext-install -j\$(nproc) sockets &amp;&amp; \
</span><span class="s">    requirementsToRemove=&#34;libpng-dev libmcrypt-dev libcurl3-dev libpng-dev libfreetype6-dev libjpeg62-turbo-dev&#34; &amp;&amp; \
</span><span class="s">    apt-get purge --auto-remove -y \$requirementsToRemove &amp;&amp; \
</span><span class="s">    printf &#34;\n\n\n&#34; | pecl install redis-4.0.0 &amp;&amp; \
</span><span class="s">    docker-php-ext-enable redis
</span><span class="s">
</span><span class="s">RUN apt-get -y install libonig-dev &amp;&amp; \
</span><span class="s">    pecl install xdebug-2.9.8 &amp;&amp; \
</span><span class="s">    docker-php-ext-enable xdebug &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_enable=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_host=frps&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.remote_port=9003&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.show_local_vars=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.default_enable=on&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini &amp;&amp; \
</span><span class="s">    echo &#34;xdebug.idekey=vscode&#34; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
</span><span class="s">
</span><span class="s">RUN cp /usr/local/etc/php/php.ini-development /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/short_open_tag = Off/short_open_tag = On/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/memory_limit = 128M/memory_limit = 4G/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;max_input_vars = 1000/max_input_vars = 10000/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;date.timezone=/date.timezone = &#34;Asia\/Hong_Kong&#34;/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;opcache.enable=1/opcache.enable=1/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;opcache.enable_cli=0/opcache.enable_cli=1/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/max_execution_time = 30/max_execution_time = 900/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/upload_max_filesize = 2M/upload_max_filesize = 64M/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/post_max_size = 8M/post_max_size = 128M/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/max_input_time = 60/max_input_time = 300/g&#39; /usr/local/etc/php/php.ini &amp;&amp; \
</span><span class="s">    sed -i &#39;s/pm = dynamic/pm = static/g&#39; /usr/local/etc/php-fpm.d/www.conf &amp;&amp; \
</span><span class="s">    sed -i &#39;s/pm.max_children = 5/pm.max_children = 32/g&#39; /usr/local/etc/php-fpm.d/www.conf &amp;&amp; \
</span><span class="s">    sed -i &#39;s/;pm.max_requests = 500/pm.max_requests = 500/g&#39; /usr/local/etc/php-fpm.d/www.conf
</span><span class="s">
</span><span class="s">WORKDIR /var/www/html
</span><span class="s">RUN chown root:root -R /var/www &amp;&amp; \
</span><span class="s">    chmod 777 -R /var/www
</span><span class="s">EOF</span>

cat &gt; docker-compose.yml <span class="s">&lt;&lt; EOF
</span><span class="s">version: &#39;3.2&#39;
</span><span class="s">services:
</span><span class="s">  php:
</span><span class="s">    build:
</span><span class="s">      context: . # 相对于 docker-compose.yml 的路径
</span><span class="s">      dockerfile: Dockerfile # 相对于 context 的路径
</span><span class="s">    restart: always
</span><span class="s">    container_name: php
</span><span class="s">    depends_on:
</span><span class="s">      - mysqld
</span><span class="s">      - redis
</span><span class="s">      - frps
</span><span class="s">    volumes:
</span><span class="s">      - ./../../:/var/www/html # 相对于 docker-compose.yml 的路径
</span><span class="s">    user: root
</span><span class="s">    command: [&#34;php-fpm&#34;]
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  nginx:
</span><span class="s">    image: nginx:1.21
</span><span class="s">    restart: always
</span><span class="s">    container_name: nginx
</span><span class="s">    ports:
</span><span class="s">      - 80:80
</span><span class="s">      - 443:443
</span><span class="s">    depends_on:
</span><span class="s">      - php
</span><span class="s">    volumes:
</span><span class="s">      - ./../../:/var/www/html:ro
</span><span class="s">      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
</span><span class="s">      - ./nginx/domain.crt:/etc/nginx/cert/domain.crt:ro
</span><span class="s">      - ./nginx/rsa_private_key.pem:/etc/nginx/cert/rsa_private_key.pem:ro
</span><span class="s">    user: root
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  mysqld:
</span><span class="s">    image: mysql:8.0
</span><span class="s">    restart: always
</span><span class="s">    container_name: mysqld
</span><span class="s">    ports:
</span><span class="s">      - 3307:3306
</span><span class="s">    volumes:
</span><span class="s">      - ~/mysql-data:/var/lib/mysql
</span><span class="s">    environment:
</span><span class="s">      MYSQL_DATABASE: magento242
</span><span class="s">      MYSQL_ROOT_PASSWORD: 123456
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  redis:
</span><span class="s">    image: redis:6.2
</span><span class="s">    restart: always
</span><span class="s">    container_name: redis
</span><span class="s">    ports:
</span><span class="s">      - 6379:6379
</span><span class="s">    environment:
</span><span class="s">      TZ: Asia/Shanghai
</span><span class="s">
</span><span class="s">  frps:
</span><span class="s">    build:
</span><span class="s">      context: ./frps
</span><span class="s">      dockerfile: Dockerfile
</span><span class="s">    container_name: frps
</span><span class="s">    ports:
</span><span class="s">      - 8999:8999
</span><span class="s">      - 9003:9003
</span><span class="s">
</span><span class="s">  elasticsearch:
</span><span class="s">    image: elasticsearch:7.9.3
</span><span class="s">    restart: always
</span><span class="s">    container_name: elasticsearch
</span><span class="s">    ports:
</span><span class="s">      - 9200:9200
</span><span class="s">      - 9300:9300
</span><span class="s">    environment:
</span><span class="s">      discovery.type: single-node
</span><span class="s">EOF</span>

<span class="nb">cd</span> ..
<span class="nb">cd</span> ..
<span class="nb">pwd</span>

<span class="c1"># 运行构建命令</span>

docker-compose -f ./docker/vm/docker-compose.yml build

docker-compose -f ./docker/vm/docker-compose.yml up -d

sleep <span class="m">10</span>

cat &gt; init.sh <span class="s">&lt;&lt; EOF
</span><span class="s">#!/bin/bash
</span><span class="s">
</span><span class="s">chmod 777 -R /var/www
</span><span class="s">
</span><span class="s">composer install
</span><span class="s">
</span><span class="s">php bin/magento setup:install \
</span><span class="s">    --base-url=https://localhost-magento/ \
</span><span class="s">    --db-host=mysqld \
</span><span class="s">    --db-name=magento242 \
</span><span class="s">    --db-user=root \
</span><span class="s">    --db-password=123456 \
</span><span class="s">    --cleanup-database \
</span><span class="s">    --admin-firstname=admin \
</span><span class="s">    --admin-lastname=admin \
</span><span class="s">    --admin-email=admin@admin.com \
</span><span class="s">    --admin-user=admin \
</span><span class="s">    --admin-password=admin123 \
</span><span class="s">    --backend-frontname=admin \
</span><span class="s">    --language=en_US \
</span><span class="s">    --currency=USD \
</span><span class="s">    --timezone=Asia/Shanghai \
</span><span class="s">    --use-rewrites=1 \
</span><span class="s">    --search-engine=elasticsearch7 \
</span><span class="s">    --elasticsearch-host=elasticsearch \
</span><span class="s">    --elasticsearch-port=9200 \
</span><span class="s">    --elasticsearch-index-prefix=magento2
</span><span class="s">
</span><span class="s">php bin/magento setup:config:set --cache-backend=redis --cache-backend-redis-server=redis --cache-backend-redis-db=0
</span><span class="s">php bin/magento setup:config:set --page-cache=redis --page-cache-redis-server=redis --page-cache-redis-db=1
</span><span class="s">
</span><span class="s">php bin/magento deploy:mode:set developer
</span><span class="s">php bin/magento setup:upgrade
</span><span class="s">php bin/magento setup:static-content:deploy -f
</span><span class="s">php bin/magento indexer:reindex
</span><span class="s">php bin/magento cache:flush
</span><span class="s">
</span><span class="s">chmod 777 -R /var/www
</span><span class="s">
</span><span class="s">EOF</span>

chmod <span class="m">777</span> init.sh
docker cp <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/init.sh php:/var/www/html/init.sh
sleep <span class="m">1</span>
docker <span class="nb">exec</span> php /var/www/html/init.sh

<span class="c1"># curl http://doututuan.com/test.sh|bash</span>
<span class="c1"># vim install24.sh</span>
<span class="c1"># chmod 755 install24.sh</span>
<span class="c1"># ./install24.sh</span>
<span class="c1"># time ./install24.sh</span>
<span class="c1"># docker-compose -f ./magento242/docker/vm/docker-compose.yml stop</span>
<span class="c1"># rm magento2.tar.gz &amp;&amp; rm -r magento242 &amp;&amp; rm -r mysql-data</span>
<span class="c1"># docker rm `docker ps -a | grep Exited | awk &#39;{print $1}&#39;`</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/linux-kernel-new-cgroups-vulnerability/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">New cgroups vulnerability in Linux kernel could elevate user privileges</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/js-prototype-chains/">
            <span class="next-text nav-default">Understanding of JS prototype chains</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
