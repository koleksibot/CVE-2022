<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Figuring out the Golang plugin - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article explains what the go plugin really is, what constraints it has on the user, and whether we should use it or not." /><meta name="keywords" content="golang, Plugin" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/golang-plugin/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Figuring out the Golang plugin" />
<meta property="og:description" content="This article explains what the go plugin really is, what constraints it has on the user, and whether we should use it or not." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/golang-plugin/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-27T10:22:33+08:00" />
<meta property="article:modified_time" content="2022-03-27T10:22:33+08:00" />

<meta itemprop="name" content="Figuring out the Golang plugin">
<meta itemprop="description" content="This article explains what the go plugin really is, what constraints it has on the user, and whether we should use it or not."><meta itemprop="datePublished" content="2022-03-27T10:22:33+08:00" />
<meta itemprop="dateModified" content="2022-03-27T10:22:33+08:00" />
<meta itemprop="wordCount" content="4869">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Figuring out the Golang plugin"/>
<meta name="twitter:description" content="This article explains what the go plugin really is, what constraints it has on the user, and whether we should use it or not."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Figuring out the Golang plugin</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-27 10:22:33 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4869 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#1-basic-usage-of-go-plugin">1. Basic usage of go plugin</a></li>
            <li><a href="#2-initialization-of-packages-in-the-plugin">2. Initialization of packages in the plugin</a></li>
            <li><a href="#3-go-plugin-usage-constraints">3. go plugin usage constraints</a></li>
            <li><a href="#4-plugin-version-management">4. plugin version management</a></li>
            <li><a href="#5-summary">5. Summary</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/27/55230947eab44f959f012d933274db68.png" alt="Golang plugin"></p>
<p>To count the features in Go that I haven&rsquo;t used yet, the <a href="https://pkg.go.dev/plugin@master">go plugin</a> introduced in Go 1.8 is one of them. Recently I wanted to design a plugin system for a gateway-type platform, so I thought of the go plugin ^_^.</p>
<p>Go plugin supports compiling Go packages to be distributed separately as shared libraries (.so), and the main application can dynamically load these go plugins compiled as dynamic shared library files at runtime, extracting the symbols of exported variables or functions from them and using them in the main application&rsquo;s packages. this feature of go plugin provides Go developers with more We can use it to implement a plugin system that supports hot-plugging.</p>
<p>But it&rsquo;s important to mention the fact that <strong>go plugin has been around for more than 4 years now, but it&rsquo;s still not widely used</strong>. The reason for this is that (I guess) on the one hand Go itself supports static compilation, which allows you to compile an application into an executable file that does not depend on the OS runtime library (usually libc) at all, which is an advantage of Go, while supporting the go plugin means that you can only compile the main application dynamically, which is contrary to the advantage of static compilation; and on the other hand, the other reason accounts for a larger proportion, which is that Go plugin itself has too many constraints on the user, which makes many Go developers discouraged.</p>
<p><strong>Only by experiencing it can you appreciate what it&rsquo;s like</strong> . In this article, we&rsquo;ll take a look at what the go plugin is, what constraints it imposes on users, and whether we should use it or not.</p>
<h3 id="1-basic-usage-of-go-plugin">1. Basic usage of go plugin</h3>
<p>As of Go 1.16, the official Go documentation clearly states that <strong>go plugin only supports Linux, FreeBSD and macOS</strong>, which is the first constraint of the go plugin. At the processor level, the go plugin mainly supports amd64 (x86-64), and support for arm series chips does not seem to be explicitly stated (I didn&rsquo;t see it in the release notes for each Go version, so maybe I missed it), but I used Go 1.16.2 (for arm64) version of Go 1.16.2 (for arm64) to build the plugin package and load the dynamic shared library.so file of the main program were compiled smoothly, and everything ran fine.</p>
<p>The main program loads the .so package and extracts the symbols from the .so file in the same way that a C application loads a dynamic link library and calls the functions in the library at runtime. Let&rsquo;s look at a visual example below.</p>
<p>The following is the structural layout of this example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">// github.com/bigwhite/experiments/tree/master/go-plugin

├── demo1
│   ├── go.mod
│   ├── main.go
│   └── pkg
│       └── pkg1
│           └── pkg1.go
└── demo1-plugins
    ├── Makefile
    ├── go.mod
    └── plugin1.go
</code></pre></td></tr></table>
</div>
</div><p>Where demo1 represents the main program project and demo1-plugins is the plugins project of the main program. The following is the code of the plugins project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo1-plugins/plugin1.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;plugin1 init&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">V</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="nf">F</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;plugin1: public integer variable V=%d\n&#34;</span><span class="p">,</span> <span class="nx">V</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">foo</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">foo</span><span class="p">)</span> <span class="nf">M1</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;plugin1: invoke foo.M1&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">Foo</span> <span class="nx">foo</span>
</code></pre></td></tr></table>
</div>
</div><p>The plugin package is not much different from the normal Go package, except that the plugin package has a constraint: its package name must be main, and we compile the plugin with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span><span class="k">go</span> <span class="nx">build</span> <span class="o">-</span><span class="nx">buildmode</span><span class="p">=</span><span class="nx">plugin</span> <span class="o">-</span><span class="nx">o</span> <span class="nx">plugin1</span><span class="p">.</span><span class="nx">so</span> <span class="nx">plugin1</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><p>If the plugin source code is not placed under the main package, we will encounter the following compiler error when compiling the plugin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="o">-</span><span class="nx">buildmode</span><span class="p">=</span><span class="nx">plugin</span> <span class="nx">requires</span> <span class="nx">exactly</span> <span class="nx">one</span> <span class="nx">main</span> <span class="kn">package</span>
</code></pre></td></tr></table>
</div>
</div><p>Next, let&rsquo;s look at the main program (demo1).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>

    <span class="s">&#34;github.com/bigwhite/demo1/pkg/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkg1</span><span class="p">.</span><span class="nf">LoadAndInvokeSomethingFromPlugin</span><span class="p">(</span><span class="s">&#34;../demo1-plugins/plugin1.so&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin ok&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The following is the key code in the main demo1 project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo1/main.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>

    <span class="s">&#34;github.com/bigwhite/demo1/pkg/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkg1</span><span class="p">.</span><span class="nf">LoadAndInvokeSomethingFromPlugin</span><span class="p">(</span><span class="s">&#34;../demo1-plugins/plugin1.so&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin ok&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We call the LoadAndInvokeSomethingFromPlugin function of the pkg1 package in the main function, which loads the go plugin passed in by the main function, finds the corresponding symbols in the plugin and uses the exported variables, functions, etc. in the plugin through these symbols. The following is the implementation of the LoadAndInvokeSomethingFromPlugin function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo1/pkg/pkg1/pkg1.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">pkg1</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;errors&#34;</span>
    <span class="s">&#34;plugin&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg1 init&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">MyInterface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">M1</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">LoadAndInvokeSomethingFromPlugin</span><span class="p">(</span><span class="nx">pluginPath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">pluginPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="c1">// 导出整型变量
</span><span class="c1"></span>    <span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;V&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="nx">v</span><span class="p">.(</span><span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="p">=</span> <span class="mi">15</span>

    <span class="c1">// 导出函数变量
</span><span class="c1"></span>    <span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;F&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">f</span><span class="p">.(</span><span class="kd">func</span><span class="p">())()</span>

    <span class="c1">// 导出自定义类型变量
</span><span class="c1"></span>    <span class="nx">f1</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;Foo&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">f1</span><span class="p">.(</span><span class="nx">MyInterface</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;f1 does not implement MyInterface&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">i</span><span class="p">.</span><span class="nf">M1</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the LoadAndInvokeSomethingFromPlugin function, we use the Lookup method provided by the Plugin type provided by the plugin package to find the corresponding exported symbols in the loaded .so, such as V, F and Foo above, etc. The Lookup method returns the plugin.Symbol type, and the Symbol type is defined as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// $GOROOT/src/plugin/plugin.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Symbol</span> <span class="kd">interface</span><span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that the underlying type of Symbol is interface{}, so it can carry any type of variable, function (thanks to the fact that functions are first-class citizens) symbol found in plugin. The types defined in the plugin are not looked up by the main program, and usually the main program does not rely on the types defined in the plugin.</p>
<p>Once the lookup succeeds, we can take the symbols by type assert to get instances of their real types, and with these instances (variables or functions) we can call the logic implemented in plugin. After compiling the plugin and running the main program above, we can see the following results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> run main.go
2021/06/15 10:05:22 pkg1 init
try to LoadAndInvokeSomethingFromPlugin...
2021/06/15 10:05:22 plugin1 init
plugin1: public integer variable <span class="nv">V</span><span class="o">=</span><span class="m">15</span>
plugin1: invoke foo.M1
LoadAndInvokeSomethingFromPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>So, how does the main program know whether the exported symbol is a function or a variable? This depends on the design of the main program plug-in system, because there must be some kind of &ldquo;contract&rdquo; or &ldquo;agreement&rdquo; between the main program and the plug-in. For example, the MyInterface interface type defined by the main program above is a convention between the main program and the plugin. As long as the plugin exposes an instance of the type that implements the interface, the main program can establish a connection with it and call the implementation in the plugin through the MyInterface interface type instance.</p>
<h3 id="2-initialization-of-packages-in-the-plugin">2. Initialization of packages in the plugin</h3>
<p>In the above example, we see that the initialization of the plugin (plugin1 init) happens when the main program opens the .so file. According to the official documentation: &quot; <strong>When a plugin is opened for the first time, the init functions of all packages in the plugin that are not part of the main program will be called, but a plugin is only initialized once and cannot be closed</strong> &ldquo;.</p>
<p>Let&rsquo;s verify that the same plugin is loaded multiple times in the main program, this time we upgrade the program to demo2 and demo2-plugins:.</p>
<p>The main program code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo2/main.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>

    <span class="s">&#34;github.com/bigwhite/demo2/pkg/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;try to LoadPlugin...&#34;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkg1</span><span class="p">.</span><span class="nf">LoadPlugin</span><span class="p">(</span><span class="s">&#34;../demo2-plugins/plugin1.so&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadPlugin error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadPlugin ok&#34;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">pkg1</span><span class="p">.</span><span class="nf">LoadPlugin</span><span class="p">(</span><span class="s">&#34;../demo2-plugins/plugin1.so&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Re-LoadPlugin error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Re-LoadPlugin ok&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kn">package</span> <span class="nx">pkg1</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;plugin&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pkg1 init&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">LoadPlugin</span><span class="p">(</span><span class="nx">pluginPath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">pluginPath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since it only verifies the initialization, we removed the lookup symbols and calls. plugin&rsquo;s code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo2-plugins/plugin1.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;log&#34;</span>

    <span class="nx">_</span> <span class="s">&#34;github.com/bigwhite/common&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;plugin1 init&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In demo2&rsquo;s plugin, we also keep only the initialization-related code, and here we also add an external dependency in demo2&rsquo;s plugin1: <code>github.com/bigwhite/common</code>.</p>
<p>Run the above code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> run main.go
2021/06/15 10:50:47 pkg1 init
try to LoadPlugin...
2021/06/15 10:50:47 common init
2021/06/15 10:50:47 plugin1 init
LoadPlugin ok
Re-LoadPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>With this output, we verify two claims.</p>
<ul>
<li>repeated loading of the same plugin does not trigger the initialization of the plugin package multiple times, as in the above result <strong>only output once</strong> : &ldquo;plugin1 init&rdquo;.</li>
<li>Packages that are dependent in the plugin but not in the main application, these packages will be initialized when the plugin is loaded, e.g.: &ldquo;commin init&rdquo;.</li>
</ul>
<p>If the main program also depends on the <code>github.com/bigwhite/common</code> package, we add a line to the main program&rsquo;s main package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo2/main.go
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>   

    <span class="nx">_</span> <span class="s">&#34;github.com/bigwhite/common&#34;</span>    <span class="c1">// 增加这一行
</span><span class="c1"></span>    <span class="s">&#34;github.com/bigwhite/demo2/pkg/pkg1&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Then we execute demo2 again and output the following result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">2021/06/15 11:00:00 common init
2021/06/15 11:00:00 pkg1 init
try to LoadPlugin...
2021/06/15 11:00:00 plugin1 init
LoadPlugin ok
Re-LoadPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>We see that the common package is already initialized in the main demo2 application, so that when the plugin is loaded, the common package will not be initialized again.</p>
<h3 id="3-go-plugin-usage-constraints">3. go plugin usage constraints</h3>
<p>As we mentioned in the beginning, one of the main reasons why the go plugin is not widely used is because of its many constraints, so let&rsquo;s look at what constraints the go plugin has.</p>
<h4 id="1-the-version-of-the-common-dependency-package-of-the-main-program-and-plugin-must-be-the-same">1) The version of the common dependency package of the main program and plugin must be the same</h4>
<p>In demo2 above, the <code>github.com/bigwhite/common</code> package that the main application and plugin depend on is a local module, and we use replace in go.mod to point to the local path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo2/go.mod
</span><span class="c1"></span>
<span class="nx">module</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">demo2</span>

<span class="nx">replace</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">common</span> <span class="p">=&gt;</span> <span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">tonybai</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">experiments</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">plugin</span><span class="o">/</span><span class="nx">common</span>

<span class="nx">require</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">bigwhite</span><span class="o">/</span><span class="nx">common</span> <span class="nx">v0</span><span class="mf">.0.0</span><span class="o">-</span><span class="mi">20180202201655</span><span class="o">-</span><span class="nx">eb2c6b5be1b6</span> <span class="c1">// 这个版本号是自行&#34;伪造&#34;的
</span><span class="c1"></span>
<span class="k">go</span> <span class="mf">1.16</span>
</code></pre></td></tr></table>
</div>
</div><p>If I clone a copy of the common package, put it in the common1 directory, and point the <code>replace github.com/bigwhite/common</code> statement in the plugin&rsquo;s go.mod to the common1 directory, and we recompile the main program and the plugin and run the main program, we will get the following Result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> run main.go
2021/06/15 14:09:07 common init
2021/06/15 14:09:07 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo2-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package github.com/bigwhite/common
</code></pre></td></tr></table>
</div>
</div><p>We see that the plugin fails to load because the common version is different. This is a constraint used by the plugin: <strong>The main application and the plugin must have the same version of the common dependency package</strong> .</p>
<p>Let&rsquo;s look at an example where the main application and the plugin have a common package. We create demo3, in which both the main program and plugin depend on the logrus logging package, but the main program uses logrus version 1.8.1 and plugin uses logrus version 1.8.0. After compiling separately, we run the main program as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo3

2021/06/15 14:18:35 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo3-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package github.com/sirupsen/logrus
</code></pre></td></tr></table>
</div>
</div><p>We see that the main program runs with the same error as the previous example suggests, both because it uses a third-party package with an inconsistent version. To solve this problem, we just need to keep the version of the logrus package used by both consistent, for example by downgrading the logrus of the main program from v1.8.1 to v1.8.0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> get github.com/sirupsen/logrus@v1.8.0
go get: downgraded github.com/sirupsen/logrus v1.8.1 <span class="o">=</span>&gt; v1.8.0
<span class="nv">$go</span> run main.go
2021/06/15 14:19:09 pkg1 init
try to LoadPlugin...
2021/06/15 14:19:09 plugin1 init
LoadPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>We see that after downgrading the logrus version, the main program can load the plugin normally.</p>
<p>There is another case, that is, the main program and plugin use different major versions of the same module, because the major version is different, although it is the same module, but in fact two different packages, this will not affect the main program to load plugin. However, the problem is that the module that is co-dependent also has its own dependency package, and when the version of a package that it depends on differs from one major version to another, it will also cause the main program to have problems loading the plugin. For example, if the main application depends on v6.15.9+incompatible version of go-redis/redis, and the plugin depends on go-redis/redis/v8, when we use such a main application to load the plugin, we will encounter the following error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo3

<span class="nv">$go</span> run main.go
2021/06/15 14:32:11 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo3-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package golang.org/x/sys/unix
</code></pre></td></tr></table>
</div>
</div><p>We see that the redis version is not wrong, but the problem is that redis and redis/v8 depend on different versions of golang.org/x/sys, <strong>this indirect dependency on the version of the module inconsistency will also cause the go plugin to fail to load</strong>, this is also one of the constraints of the use of the go plugin.</p>
<h4 id="2-if-modvendor-build-is-used-then-the-main-application-and-plugin-must-be-built-from-the-same-vendor-directory">2) If mod=vendor build is used, then the main application and plugin must be built from the same vendor directory</h4>
<p>The build based on vendor is a feature introduced in go 1.5. After go 1.11 introduced the go module build mode, the vendor build was retained. So the question is, if either the main application or the plugin uses vendor build or both, will the main application be able to load the plugin properly? Let&rsquo;s verify this with the sample demo4. (demo4 and demo3 is more or less the same, here will not list the specific code).</p>
<p>First we generate the vendor directory for the main program (demo4) and the plugins (demo4-plugins) respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
</span><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">mod</span> <span class="nx">vendor</span>

<span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4-plugins
</span><span class="c1"></span><span class="err">$</span><span class="k">go</span> <span class="nx">mod</span> <span class="nx">vendor</span>
</code></pre></td></tr></table>
</div>
</div><p>We test the following three cases (go version 1.16 gives preference to build with vendor when available by default. So to build based on mod you need to explicitly pass in -mod=mod).</p>
<ul>
<li>the main application is built based on mod, the plugin is built based on vendor</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4-plugins
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -buildmode<span class="o">=</span>plugin -o plugin1.so plugin1.go

// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build -mod<span class="o">=</span>mod -o main.mod main.go

<span class="nv">$main</span>.mod
2021/06/15 15:41:21 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo4-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package golang.org/x/sys/unix
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The main program is built on vendor, the plug-in is built on mod</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4-plugins
<span class="nv">$go</span> build -mod<span class="o">=</span>mod -buildmode<span class="o">=</span>plugin -o plugin1.so plugin1.go

// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -o main.vendor main.go

$./main.vendor
2021/06/15 15:44:15 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo4-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package golang.org/x/sys/unix
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The main application and the plug-in are built on their own vendor</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4-plugins
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -buildmode<span class="o">=</span>plugin -o plugin1.so plugin1.go

// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -o main.vendor main.go

$./main.vendor
2021/06/15 15:45:11 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo4-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package golang.org/x/sys/unix
</code></pre></td></tr></table>
</div>
</div><p>From the above test, we see that the main program will fail to load the plugin no matter which side uses vendor build or both sides are based on their respective vendor build. How to solve this problem? <strong>Make the main program and plugin build based on the same vendor</strong> !</p>
<p>We copy plugin1.go to demo4, and then build the main program and plugin1.go with separate vendor builds:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -o main.vendor main.go

// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build -mod<span class="o">=</span>vendor -buildmode<span class="o">=</span>plugin -o plugin1.so plugin1.go
</code></pre></td></tr></table>
</div>
</div><p>Copy the compiled plugin1.so into demo4-plugins, and run main.vendor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$cp</span> plugin1.so ../demo4-plugins
<span class="nv">$main</span>.vendor
2021/06/15 15:48:56 pkg1 init
try to LoadPlugin...
2021/06/15 15:48:56 plugin1 init
LoadPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>We see that main programs and plugins based on the same vendor are compatible. The following table summarizes the compatibility between the main program and the plugin when they are built in different build modes.</p>
<table>
<thead>
<tr>
<th>plugin build method \ main program build method</th>
<th>mod based</th>
<th>based on own vendor</th>
</tr>
</thead>
<tbody>
<tr>
<td>mod-based</td>
<td>load-successful</td>
<td>load-failure</td>
</tr>
<tr>
<td>mod-based</td>
<td>load-fail</td>
<td>load-fail</td>
</tr>
</tbody>
</table>
<p><strong>In vendor build mode, the plugin can only be loaded successfully by the main program if it is built based on the same vendor directory</strong> !</p>
<h4 id="3-the-compiler-version-used-by-the-main-program-and-the-plugin-must-be-the-same">3) The compiler version used by the main program and the plugin must be the same</h4>
<p>If we use different versions of the Go compiler to compile the main program and the plugin separately, will they be compatible? Let&rsquo;s also take demo4 to verify it. I have go 1.16.5 and go 1.16 compilers on the host, go 1.16.5 is the patch maintenance version of go 1.16, the difference is not of the same magnitude compared to go 1.16 and go 1.15, we compile the main program with go 1.16 and the plugin with go 1.16.5.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4-plugins
<span class="nv">$go</span> version
go version go1.16.5 darwin/amd64
<span class="nv">$go</span> build -buildmode<span class="o">=</span>plugin -o plugin1.so plugin1.go

// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> version
go version go1.16 darwin/amd64

<span class="nv">$go</span> run main.go
2021/06/15 15:58:44 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin.Open<span class="o">(</span><span class="s2">&#34;../demo4-plugins/plugin1&#34;</span><span class="o">)</span>: plugin was built with a different version of package runtime/internal/sys
</code></pre></td></tr></table>
</div>
</div><p>We see that the plugin is not compatible with the main program even when compiled with the patch version. We upgrade demo4 to compile with go version 1.16.5.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> version
go version go1.16.5 darwin/amd64
<span class="nv">$go</span> run main.go
2021/06/15 15:59:05 pkg1 init
try to LoadPlugin...
2021/06/15 15:59:05 plugin1 init
LoadPlugin ok
</code></pre></td></tr></table>
</div>
</div><p>We have seen that only when the main program and the plugin are compiled with the exact same version (the patch version should also be the same), they are compatible and the main program can load the plugin properly.</p>
<p>So does the OS version affect the compatibility of the main program and plugin? There are no official instructions for this, so I tested it myself. I built demo4-plugin (based on mod=mod) on centos 7.6 (amd64, go 1.16.5) and then copied it to a host with ubuntu 18.04 (amd64, go 1.16.5), the demo4 main program on the ubuntu host was compatible with the plugin.</p>
<h4 id="4-master-programs-with-plugins-can-only-use-dynamic-links">4) Master programs with plugins can only use dynamic links</h4>
<p>Go is known for being statically compiled for ease of distribution and deployment, but <strong>main programs using plugins can only use dynamic links</strong>. Don&rsquo;t believe me? Then let&rsquo;s challenge the main program in demo4 to compile statically.</p>
<p>First, let&rsquo;s look at the default compilation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
<span class="nv">$go</span> build main.go
<span class="nv">$ldd</span> main
    linux-vdso.so.1 <span class="o">(</span>0x00007ffc05b73000<span class="o">)</span>
    libdl.so.2 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libdl.so.2 <span class="o">(</span>0x00007f6a9fa3f000<span class="o">)</span>
    libpthread.so.0 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libpthread.so.0 <span class="o">(</span>0x00007f6a9f820000<span class="o">)</span>
    libc.so.6 <span class="o">=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span class="o">(</span>0x00007f6a9f42f000<span class="o">)</span>
    /lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007f6a9fc43000<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that the demo4 main program is compiled by default as an executable that needs to be dynamically linked at runtime, and it relies on a number of linux runtime libraries, e.g. libc.</p>
<p>The reason for all this is that we use some standard libraries implemented via cgo in demo4, such as the plugin package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// $GOROOT/src/plugin/plugin_dlopen.go
</span><span class="c1"></span>
<span class="c1">// +build linux,cgo darwin,cgo freebsd,cgo
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">plugin</span>

<span class="cm">/*
</span><span class="cm">#cgo linux LDFLAGS: -ldl
</span><span class="cm">#include &lt;dlfcn.h&gt;
</span><span class="cm">#include &lt;limits.h&gt;
</span><span class="cm">#include &lt;stdlib.h&gt;
</span><span class="cm">#include &lt;stdint.h&gt;
</span><span class="cm">
</span><span class="cm">#include &lt;stdio.h&gt;
</span><span class="cm">
</span><span class="cm">static uintptr_t pluginOpen(const char* path, char** err) {
</span><span class="cm">    void* h = dlopen(path, RTLD_NOW|RTLD_GLOBAL);
</span><span class="cm">    if (h == NULL) {
</span><span class="cm">        *err = (char*)dlerror();
</span><span class="cm">    }
</span><span class="cm">    return (uintptr_t)h;
</span><span class="cm">}
</span><span class="cm">... ...
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that plugin_dlopen.go has the build indicator in the header, which is only compiled if cgo is on. If we remove cgo, for example, using the following command line.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4
$ <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build main.go
$ ldd main
    not a dynamic executable
</code></pre></td></tr></table>
</div>
</div><p>We do compile a statically linked executable, but when we execute the file, we get the following results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ./main
2021/06/15 17:01:51 pkg1 init
try to LoadPlugin...
LoadPlugin error: plugin: not implemented
</code></pre></td></tr></table>
</div>
</div><p>We see that some functions of the plugin package were not compiled into the final executable because cgo was turned off, so the error &ldquo;not implemented&rdquo; was reported!</p>
<p>With CGO turned on, we can still let the external linker use static links, so let&rsquo;s try again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo4

$ go build -o main-static -ldflags <span class="s1">&#39;-linkmode &#34;external&#34; -extldflags &#34;-static&#34;&#39;</span> main.go
<span class="c1"># command-line-arguments</span>
/tmp/go-link-638385712/000001.o: In <span class="k">function</span> <span class="sb">`</span>pluginOpen<span class="s1">&#39;:
</span><span class="s1">/usr/local/go/src/plugin/plugin_dlopen.go:19: warning: Using &#39;</span>dlopen<span class="err">&#39;</span> in statically linked applications requires at runtime the shared libraries from the glibc version used <span class="k">for</span> linking
$ ldd main-static
    not a dynamic executable
</code></pre></td></tr></table>
</div>
</div><p>We do get a statically compiled binary, but the compiler also gives a WARNING.</p>
<p>To execute this file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ./main-static
2021/06/15 17:02:35 pkg1 init
try to LoadPlugin...
fatal error: runtime: no plugin module data

goroutine <span class="m">1</span> <span class="o">[</span>running<span class="o">]</span>:
runtime.throw<span class="o">(</span>0x5d380a, 0x1e<span class="o">)</span>
    /usr/local/go/src/runtime/panic.go:1117 +0x72 <span class="nv">fp</span><span class="o">=</span>0xc000091b50 <span class="nv">sp</span><span class="o">=</span>0xc000091b20 <span class="nv">pc</span><span class="o">=</span>0x435712
plugin.lastmoduleinit<span class="o">(</span>0xc000076210, 0x1001, 0x1001, 0xc000010040, 0x24db1f0<span class="o">)</span>
    /usr/local/go/src/runtime/plugin.go:20 +0xb50 <span class="nv">fp</span><span class="o">=</span>0xc000091c48 <span class="nv">sp</span><span class="o">=</span>0xc000091b50 <span class="nv">pc</span><span class="o">=</span>0x466750
plugin.open<span class="o">(</span>0x5d284c, 0x18, 0xc0000788f0, 0x0, 0x0<span class="o">)</span>
    /usr/local/go/src/plugin/plugin_dlopen.go:77 +0x4ef <span class="nv">fp</span><span class="o">=</span>0xc000091ec0 <span class="nv">sp</span><span class="o">=</span>0xc000091c48 <span class="nv">pc</span><span class="o">=</span>0x4dad8f
plugin.Open<span class="o">(</span>...<span class="o">)</span>
    /usr/local/go/src/plugin/plugin.go:32
github.com/bigwhite/demo4/pkg/pkg1.LoadPlugin<span class="o">(</span>0x5d284c, 0x1b, 0xc000091f48, 0x1<span class="o">)</span>
    /root/test/go/plugin/demo4/pkg/pkg1/pkg1.go:13 +0x35 <span class="nv">fp</span><span class="o">=</span>0xc000091ef8 <span class="nv">sp</span><span class="o">=</span>0xc000091ec0 <span class="nv">pc</span><span class="o">=</span>0x4dbbb5
main.main<span class="o">()</span>
    /root/test/go/plugin/demo4/main.go:12 +0xa5 <span class="nv">fp</span><span class="o">=</span>0xc000091f88 <span class="nv">sp</span><span class="o">=</span>0xc000091ef8 <span class="nv">pc</span><span class="o">=</span>0x4ee805
runtime.main<span class="o">()</span>
    /usr/local/go/src/runtime/proc.go:225 +0x256 <span class="nv">fp</span><span class="o">=</span>0xc000091fe0 <span class="nv">sp</span><span class="o">=</span>0xc000091f88 <span class="nv">pc</span><span class="o">=</span>0x438196
runtime.goexit<span class="o">()</span>
    /usr/local/go/src/runtime/asm_amd64.s:1371 +0x1 <span class="nv">fp</span><span class="o">=</span>0xc000091fe8 <span class="nv">sp</span><span class="o">=</span>0xc000091fe0 <span class="nv">pc</span><span class="o">=</span>0x46a841
</code></pre></td></tr></table>
</div>
</div><p>The warning eventually evolved into a runtime panic, and it seems that the main program using the plugin can only be compiled into a dynamically linked executable. The current go project has several issues related to this.</p>
<ul>
<li><a href="https://github.com/golang/go/issues/33072">https://github.com/golang/go/issues/33072</a></li>
<li><a href="https://github.com/golang/go/issues/17150">https://github.com/golang/go/issues/17150</a></li>
<li><a href="https://github.com/golang/go/issues/18123">https://github.com/golang/go/issues/18123</a></li>
</ul>
<h3 id="4-plugin-version-management">4. plugin version management</h3>
<p>One of the bigger issues in implementing a plugin system using dynamic linking is the versioning of the plugin.</p>
<p>Dynamic link libraries on linux are versioned using soname. soname&rsquo;s key feature is that it provides compatibility criteria when upgrading a library on the system, and the soname of the new library is the same as the soname of the old library, so that programs generated by linking with the old library will still work fine with the new library. This feature makes it very easy to upgrade programs that make shared libraries and locate errors under Linux.</p>
<p>What is soname? In directories like /lib and /usr/lib where shared libraries are centrally located, you will always see something like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">2019-12-10 12:28 libfoo.so -&gt; libfoo.so.0.0.0*
2019-12-10 12:28 libfoo.so.0 -&gt; libfoo.so.0.0.0*
2019-12-10 12:28 libfoo.so.0.0.0*
</code></pre></td></tr></table>
</div>
</div><p>Regarding libfoo.so there are actually three file entries, of which libfoo.so.0.0.0 is the real shared library file, while the other two file entries are symbolic links to libfoo.so.0.0.0. Why is this the case? It has to do with the naming convention and versioning of shared libraries.</p>
<p>The shared library convention has multiple name attributes for each shared library, including real name, soname, and linker name.</p>
<ul>
<li>real name</li>
</ul>
<p>real name refers to the name of the file that actually contains the shared library code (e.g. libfoo.so.0.0.0 in the above example), and is the argument that follows -o on the shared library compile command line.</p>
<ul>
<li>soname</li>
</ul>
<p>soname is the abbreviation for shared object name, and is the most important of the three names. The system linker uniquely identifies a shared library by its soname (e.g., libfoo.so.0 in the above example), both at the compilation stage and at the runtime stage. Even if the real name is the same but the soname is different, it will be considered by the linker as two different libraries. The soname of the shared library can be specified during compilation by passing parameters to the linker, e.g. we can specify it by &ldquo;gcc -shared -Wl,-soname -Wl,libfoo.so.0 -o libfoo.so.0.0.0 libfoo.o&rdquo; libfoo.so.0.0.0 has a soname of libfoo.so.0. ldconfig -n directory_with_shared_libraries will automatically generate a symbolic link named soname to the real name file based on the soname of the shared library, but you can also You can also create this symbolic link yourself by using the ln command. Also in linux we can check the soname of the shared libraries with readelf -d. The list of shared libraries that the lldd file depends on shows the soname and the path of the shared libraries.</p>
<ul>
<li>linker name</li>
</ul>
<p>linker name is the name provided to the compiler at compilation stage (e.g. libfoo.so in the above example). If you build a shared library with a real name that looks like libfoo.so.0.0.0 in the example above with a version number, then you cannot get the linker to find the corresponding shared library file by using -L path -lfoo directly in the compiler command unless you provide a linker name for libfoo.so.0.0.0 (e.g. libfoo.so, a symbolic link to libfoo.so.0.0.0). linker names are usually created manually during shared library installation.</p>
<p>So can the go plugin be versioned in the same way as soname? Let&rsquo;s create demo5 based on demo1 and experiment with it.</p>
<p>In demo5-plugins, we add version information to the .so build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/go-plugin/demo5-plugins

<span class="nv">$go</span> build -buildmode<span class="o">=</span>plugin -o plugin1.so.1.1 plugin1.go
<span class="nv">$ln</span> -s plugin1.so.1.1 plugin1.so.1
<span class="nv">$ls</span> -l
lrwxr-xr-x  <span class="m">1</span> tonybai  staff       <span class="m">14</span>  <span class="m">7</span> <span class="m">16</span> 05:42 plugin1.so.1@ -&gt; plugin1.so.1.1
-rw-r--r--  <span class="m">1</span> tonybai  staff  <span class="m">2888408</span>  <span class="m">7</span> <span class="m">16</span> 05:42 plugin1.so.1.1
</code></pre></td></tr></table>
</div>
</div><p>We created a symbolic link plugin1.so.1 for the built plugin1.so.1 with the ln command, and plugin1.so.1 was passed to demo5 as the soname of our plugin:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo5/main.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;try to LoadAndInvokeSomethingFromPlugin...&#34;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkg1</span><span class="p">.</span><span class="nf">LoadAndInvokeSomethingFromPlugin</span><span class="p">(</span><span class="s">&#34;../demo5-plugins/plugin1.so.1&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;LoadAndInvokeSomethingFromPlugin ok&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Running demo5.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/go-plugin/demo5
</span><span class="c1"></span>
<span class="err">$</span><span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="mi">2021</span><span class="o">/</span><span class="mo">07</span><span class="o">/</span><span class="mi">16</span> <span class="mo">05</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">33</span> <span class="nx">pkg1</span> <span class="nx">init</span>
<span class="nx">try</span> <span class="nx">to</span> <span class="nx">LoadAndInvokeSomethingFromPlugin</span><span class="o">...</span>
<span class="mi">2021</span><span class="o">/</span><span class="mo">07</span><span class="o">/</span><span class="mi">16</span> <span class="mo">05</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">33</span> <span class="nx">plugin1</span> <span class="nx">init</span>
<span class="nx">plugin1</span><span class="p">:</span> <span class="nx">public</span> <span class="nx">integer</span> <span class="nx">variable</span> <span class="nx">V</span><span class="p">=</span><span class="mi">15</span>
<span class="nx">plugin1</span><span class="p">:</span> <span class="nx">invoke</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">M1</span>
<span class="nx">LoadAndInvokeSomethingFromPlugin</span> <span class="nx">ok</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that the plugin passed in as soname is loaded and extracts the symbols without any problems.</p>
<p>Later, if the plugin changes, such as patch, we only need to upgrade the plugin to plugin1.so.1.2, then soname remains the same, and the main program does not need to change.</p>
<p><strong>Note: If the plugin name is the same and the content is the same, the main program will not have problems loading multiple times; but if the plugin name is the same but the content is different, the main program will cause a runtime panic when running multiple loads, and it is a panic that cannot be recovered. So be sure to do a good job of plug-in version management</strong> .</p>
<h3 id="5-summary">5. Summary</h3>
<p>go plugin is a go plugin solution provided natively by the go language (non-go plugin solution, you can use c shared library, etc.). However, after the above experiments and learning, we have seen many constraints on the use of plugins, which does create a big obstacle to the promotion of the use of go plugin, resulting in the current go plugin is not very widely used.</p>
<p>According to the constraints seen above, if you want to apply go plugin, you have to do:</p>
<ul>
<li>Consistent build environment</li>
<li>Consistent versioning of third-party packages.</li>
</ul>
<p>Therefore, the industry uses builder containers to ensure that the main application and the plugin use the same build environment when using the go plugin.</p>
<p>Among the few users of the go plugin, there are three well-known open source projects that deserve careful follow-up study.</p>
<ul>
<li><a href="https://github.com/vladimirvivien/gosh">gosh</a></li>
<li><a href="https://github.com/TykTechnologies/tyk">tyk api gateway</a></li>
<li><a href="https://github.com/pingcap/tidb">tidb</a></li>
</ul>
<p>In particular, tidb, also gives its plug-in system using <a href="https://github.com/pingcap/tidb/blob/master/docs/design/2018-12-10-plugin-framework.md">go plugin&rsquo;s complete design scheme</a>, which is worth everyone read carefully.</p>
<p>All the source code involved in this article can be downloaded from <a href="https://github.com/bigwhite/experiments/tree/master/go-plugin/">here</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/uber-zap-advanced-usage/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to use the uber open source zap log library very well</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/go-multiplexing-tcp/">
            <span class="next-text nav-default">Go I/O multiplexing based TCP protocol stream parsing in practice</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
