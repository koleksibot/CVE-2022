<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang interface Principle - Type Conversion - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, I&amp;rsquo;ll take a look at the interface from the internal degree assignment &#43; assembly perspective, to understand how the interface works.
This article will focus on type conversions and related error-prone areas.
eface 1 2 3 4 5 6  func main() { var ti interface{} var a int = 100 ti = a fmt.Println(ti) }   This most common code now raises some questions.
 How to see if ti is eface or iface ?" /><meta name="keywords" content="golang, Interface, Type Conversion" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/go-interface/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Golang interface Principle - Type Conversion" />
<meta property="og:description" content="In this article, I&rsquo;ll take a look at the interface from the internal degree assignment &#43; assembly perspective, to understand how the interface works.
This article will focus on type conversions and related error-prone areas.
eface 1 2 3 4 5 6  func main() { var ti interface{} var a int = 100 ti = a fmt.Println(ti) }   This most common code now raises some questions.
 How to see if ti is eface or iface ?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/go-interface/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-15T09:13:47+08:00" />
<meta property="article:modified_time" content="2022-03-15T09:13:47+08:00" />

<meta itemprop="name" content="Golang interface Principle - Type Conversion">
<meta itemprop="description" content="In this article, I&rsquo;ll take a look at the interface from the internal degree assignment &#43; assembly perspective, to understand how the interface works.
This article will focus on type conversions and related error-prone areas.
eface 1 2 3 4 5 6  func main() { var ti interface{} var a int = 100 ti = a fmt.Println(ti) }   This most common code now raises some questions.
 How to see if ti is eface or iface ?"><meta itemprop="datePublished" content="2022-03-15T09:13:47+08:00" />
<meta itemprop="dateModified" content="2022-03-15T09:13:47+08:00" />
<meta itemprop="wordCount" content="1077">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang interface Principle - Type Conversion"/>
<meta name="twitter:description" content="In this article, I&rsquo;ll take a look at the interface from the internal degree assignment &#43; assembly perspective, to understand how the interface works.
This article will focus on type conversions and related error-prone areas.
eface 1 2 3 4 5 6  func main() { var ti interface{} var a int = 100 ti = a fmt.Println(ti) }   This most common code now raises some questions.
 How to see if ti is eface or iface ?"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang interface Principle - Type Conversion</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-15 09:13:47 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1077 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#eface">eface</a></li>
        <li><a href="#iface">iface</a>
          <ul>
            <li><a href="#type-assertion">Type assertion</a></li>
            <li><a href="#traps">Traps</a></li>
            <li><a href="#suggestions-for-reading-the-interface-source-code">Suggestions for reading the interface source code</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In this article, I&rsquo;ll take a look at the interface from the <strong>internal degree assignment + assembly</strong> perspective, to understand how the interface works.</p>
<p>This article will focus on type conversions and related error-prone areas.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/15/49008400e26548578056c1a092a46b78.png" alt="Golang interface"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/15/fc3e0e7265b247669dd859b4bb0865d5.png" alt="Golang interface"></p>
<h2 id="eface">eface</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ti</span> <span class="kd">interface</span><span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="nx">ti</span> <span class="p">=</span> <span class="nx">a</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">ti</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This most common code now raises some questions.</p>
<ul>
<li>How to see if ti is eface or iface ?</li>
<li>Where is the value 100 stored?</li>
<li>How can I see the real value type of ti?</li>
</ul>
<p>Most of the source code analysis is done from the assembly, so here is the corresponding assembly posted as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">0x0040 00064 (main.go:44)	MOVQ	$100, (SP)
0x0048 00072 (main.go:44)	CALL	runtime.convT64(SB)
0x004d 00077 (main.go:44)	MOVQ	8(SP), AX
0x0052 00082 (main.go:44)	MOVQ	AX, &#34;&#34;..autotmp_3+64(SP)
0x0057 00087 (main.go:44)	LEAQ	type.int(SB), CX
0x005e 00094 (main.go:44)	MOVQ	CX, &#34;&#34;.ti+72(SP)
0x0063 00099 (main.go:44)	MOVQ	AX, &#34;&#34;.ti+80(SP)
</code></pre></td></tr></table>
</div>
</div><p>This assembly has the following features.</p>
<ul>
<li>CALL runtime.convT64(SB): takes 100 as the argument to runtime.convT64, which requests a section of memory into which 100 is placed</li>
<li>put the type type.int into SP+72</li>
<li>puts the pointer to the memory containing 100 into SP + 80</li>
</ul>
<p>This assembly is intuitively invisible from the conversion of interface to eface. How can this be observed? This requires the use of gdb.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/15/8d0de4a1753949abbc859d5d71929dda.png" alt="assembly gdb"></p>
<p>To dig deeper, how can we use the memory distribution to verify that it is eface? We need to add some additional code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">eface</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">_type</span> <span class="o">*</span><span class="nx">_type</span>
    <span class="nx">data</span>  <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">_type</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">size</span>       <span class="kt">uintptr</span>
    <span class="nx">ptrdata</span>    <span class="kt">uintptr</span> <span class="c1">// size of memory prefix holding all pointers
</span><span class="c1"></span>    <span class="nx">hash</span>       <span class="kt">uint32</span>
    <span class="nx">tflag</span>      <span class="nx">tflag</span>
    <span class="nx">align</span>      <span class="kt">uint8</span>
    <span class="nx">fieldAlign</span> <span class="kt">uint8</span>
    <span class="nx">kind</span>       <span class="kt">uint8</span>
    <span class="nx">equal</span>      <span class="kd">func</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nx">gcdata</span>     <span class="o">*</span><span class="kt">byte</span>
    <span class="nx">str</span>        <span class="nx">nameOff</span>
    <span class="nx">ptrToThis</span>  <span class="nx">typeOff</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ti</span> <span class="kd">interface</span><span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="nx">ti</span> <span class="p">=</span> <span class="nx">a</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;type:&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">eface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ti</span><span class="p">)).</span><span class="nx">_type</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;data:&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">int</span><span class="p">)((</span><span class="o">*</span><span class="nx">eface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ti</span><span class="p">)).</span><span class="nx">data</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">((</span><span class="o">*</span><span class="nx">eface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ti</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span><span class="p">:</span> <span class="p">{</span><span class="mi">8</span> <span class="mi">0</span> <span class="mi">4149441018</span> <span class="mi">15</span> <span class="mi">8</span> <span class="mi">8</span> <span class="mi">2</span> <span class="mh">0x10032e0</span> <span class="mh">0x10e6b60</span> <span class="mi">959</span> <span class="mi">27232</span><span class="p">}</span>
<span class="nx">data</span><span class="p">:</span> <span class="mi">100</span>
<span class="o">&amp;</span><span class="p">{</span><span class="mh">0x10ade20</span> <span class="mh">0x1155bc0</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>From this result, we can see that</p>
<ul>
<li>eface.kind = 2, which corresponds to runtime.kindInt</li>
<li>eface.data = 100</li>
</ul>
<p>From the memory allocation, we can basically see the memory layout of eface and the corresponding final eface type conversion result.</p>
<h2 id="iface">iface</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kd">type</span> <span class="nx">Person</span> <span class="kd">interface</span> <span class="p">{</span>
	  <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Man</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Man</span><span class="p">)</span> <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	  <span class="k">return</span> <span class="s">&#34;Man&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>

    <span class="nx">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Man</span><span class="p">{}</span>
    <span class="nx">p</span> <span class="p">=</span> <span class="nx">m</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Say</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>iface We also look at the assembly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">0x0029 00041 (main.go:24)	LEAQ	runtime.zerobase(SB), AX
0x0030 00048 (main.go:24)	MOVQ	AX, &#34;&#34;..autotmp_6+48(SP)
0x0035 00053 (main.go:24)	MOVQ	AX, &#34;&#34;.m+32(SP)
0x003a 00058 (main.go:25)	MOVQ	AX, &#34;&#34;..autotmp_3+64(SP)
0x003f 00063 (main.go:25)	LEAQ	go.itab.*&#34;&#34;.Man,&#34;&#34;.Person(SB), CX
0x0046 00070 (main.go:25)	MOVQ	CX, &#34;&#34;.p+72(SP)
0x004b 00075 (main.go:25)	MOVQ	AX, &#34;&#34;.p+80(SP)
</code></pre></td></tr></table>
</div>
</div><p>In this assembly, we can see that there is an itab, but the assembly still does not reflect whether it is actually converted to iface.</p>
<p>Again, we continue to use gdb to see that the Person interface is indeed converted to iface.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/15/73df275df3d74fd8a45b6404a14cc5ed.png" alt="assembly"></p>
<p>About iface memory layout, we still add some code to see it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">itab</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">inter</span> <span class="o">*</span><span class="nx">interfacetype</span>
    <span class="nx">_type</span> <span class="o">*</span><span class="nx">_type</span>
    <span class="nx">hash</span>  <span class="kt">uint32</span>
    <span class="nx">_</span>     <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">byte</span>
    <span class="nx">fun</span>   <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="kt">uintptr</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">iface</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">tab</span>  <span class="o">*</span><span class="nx">itab</span>
    <span class="nx">data</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Person</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Man</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Man</span><span class="p">)</span> <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;Man&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>

    <span class="nx">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Man</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;hhf&#34;</span><span class="p">}</span>
    <span class="nx">p</span> <span class="p">=</span> <span class="nx">m</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Say</span><span class="p">())</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;itab:&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">iface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">)).</span><span class="nx">tab</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;data:&#34;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">Man</span><span class="p">)((</span><span class="o">*</span><span class="nx">iface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">)).</span><span class="nx">data</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">Man
itab: {0x10b3ba0 0x10b1900 1224794265 [0 0 0 0] [17445152]}
data: {hhf}
</code></pre></td></tr></table>
</div>
</div><p>For those who want to continue exploring the memory layout of eface, iface, you can use unsafe&rsquo;s related functions to look at the values on the corresponding memory locations based on the above code.</p>
<h3 id="type-assertion">Type assertion</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">interface</span> <span class="p">{</span>
	  <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Man</span> <span class="kd">struct</span> <span class="p">{</span>
	  <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Man</span><span class="p">)</span> <span class="nf">Say</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	  <span class="k">return</span> <span class="s">&#34;Man&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	  <span class="kd">var</span> <span class="nx">p</span> <span class="nx">Person</span>

    <span class="nx">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Man</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;hhf&#34;</span><span class="p">}</span>
    <span class="nx">p</span> <span class="p">=</span> <span class="nx">m</span>

    <span class="k">if</span> <span class="nx">m1</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.(</span><span class="o">*</span><span class="nx">Man</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">m1</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We will focus only on the type assertion piece, posting the corresponding assembly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">0x0087 00135 (main.go:23)	MOVQ	&#34;&#34;.p+104(SP), AX
0x008c 00140 (main.go:23)	MOVQ	&#34;&#34;.p+112(SP), CX
0x0091 00145 (main.go:23)	LEAQ	go.itab.*&#34;&#34;.Man,&#34;&#34;.Person(SB), DX
0x0098 00152 (main.go:23)	CMPQ	DX, AX
</code></pre></td></tr></table>
</div>
</div><p>Person(SB)` to compare whether they are equal to determine whether the real type of Person is Man.</p>
<p>Another way to assert the type is switch, which is essentially the same thing.</p>
<h3 id="traps">Traps</h3>
<p>The most famous trap of interface is the following one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">*</span><span class="kt">int</span> <span class="p">=</span> <span class="kc">nil</span>
    
    <span class="nf">isNil</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="nf">isNil</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">isNil</span><span class="p">(</span><span class="nx">x</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;empty interface&#34;</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;non-empty interface&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">empty interface
non-empty interface
</code></pre></td></tr></table>
</div>
</div><p>Why is this the case? It comes down to the way interface == nil is determined. In general, interface == nil is true only if the type and data of eface are both nil.</p>
<p>When we copy b to interface, x._type.Kind = kindPtr. x.data = nil, but the interface == nil condition is not met.</p>
<h3 id="suggestions-for-reading-the-interface-source-code">Suggestions for reading the interface source code</h3>
<p>A little advice on reading the interface source code, if you want to use assembly to read the source code, try to choose go1.14.x.</p>
<p>If you choose Go assembly to look at the interface, you basically want to see whether the interface is eventually converted to eface or iface, which functions of runtime are called, and the corresponding function stack distribution. If you choose too high a Go version, the Go assembly will change too much and you may not see the corresponding content in the assembly.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/gomod/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to Spoof Go Mod?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/go-timer/">
            <span class="next-text nav-default">How Go timers are scheduled</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
