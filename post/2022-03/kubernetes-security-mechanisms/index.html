<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubernetes Security Mechanisms Explained - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In Kubernetes, all access and changes to resources revolve around the APIServer. For example, kubectl commands and client-side HTTP RESTFUL requests are all done by calling the APIServer API, so this article focuses on what k8s does for cluster security.
First, the official Kubernetes documentation gives the diagram above. It describes the authentication, authorization, and access control mechanisms of the APIServer that users need to go through before they can access or change resources." /><meta name="keywords" content="kubernetes, Security Mechanisms" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/kubernetes-security-mechanisms/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kubernetes Security Mechanisms Explained" />
<meta property="og:description" content="In Kubernetes, all access and changes to resources revolve around the APIServer. For example, kubectl commands and client-side HTTP RESTFUL requests are all done by calling the APIServer API, so this article focuses on what k8s does for cluster security.
First, the official Kubernetes documentation gives the diagram above. It describes the authentication, authorization, and access control mechanisms of the APIServer that users need to go through before they can access or change resources." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/kubernetes-security-mechanisms/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-11T14:01:15+08:00" />
<meta property="article:modified_time" content="2022-03-11T14:01:15+08:00" />

<meta itemprop="name" content="Kubernetes Security Mechanisms Explained">
<meta itemprop="description" content="In Kubernetes, all access and changes to resources revolve around the APIServer. For example, kubectl commands and client-side HTTP RESTFUL requests are all done by calling the APIServer API, so this article focuses on what k8s does for cluster security.
First, the official Kubernetes documentation gives the diagram above. It describes the authentication, authorization, and access control mechanisms of the APIServer that users need to go through before they can access or change resources."><meta itemprop="datePublished" content="2022-03-11T14:01:15+08:00" />
<meta itemprop="dateModified" content="2022-03-11T14:01:15+08:00" />
<meta itemprop="wordCount" content="2398">
<meta itemprop="keywords" content="kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes Security Mechanisms Explained"/>
<meta name="twitter:description" content="In Kubernetes, all access and changes to resources revolve around the APIServer. For example, kubectl commands and client-side HTTP RESTFUL requests are all done by calling the APIServer API, so this article focuses on what k8s does for cluster security.
First, the official Kubernetes documentation gives the diagram above. It describes the authentication, authorization, and access control mechanisms of the APIServer that users need to go through before they can access or change resources."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubernetes Security Mechanisms Explained</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-11 14:01:15 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2398 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#users">Users</a></li>
        <li><a href="#authentication-mechanism-authentication">Authentication mechanism (Authentication)</a></li>
        <li><a href="#authorization-mechanism">Authorization mechanism</a>
          <ul>
            <li><a href="#rbac">RBAC</a></li>
            <li><a href="#abac">ABAC</a></li>
            <li><a href="#node">Node</a></li>
            <li><a href="#webhook">Webhook</a></li>
          </ul>
        </li>
        <li><a href="#access-controls-admission-controllers">Access Controls (Admission Controllers)</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In Kubernetes, all access and changes to resources revolve around the APIServer. For example, kubectl commands and client-side HTTP RESTFUL requests are all done by calling the APIServer API, so this article focuses on what k8s does for cluster security.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/a781abb056904f10a447919731889b1a.png" alt="Kubernetes Security"></p>
<p>First, the official Kubernetes documentation gives the diagram above. It describes the authentication, authorization, and access control mechanisms of the APIServer that users need to go through before they can access or change resources. These three mechanisms can be understood as follows: first check if the user is legitimate, then check if the request acts with permission, and finally do further authentication or add default parameters.</p>
<h2 id="users">Users</h2>
<p>There are two kinds of users in Kubernetes, the built-in &ldquo;user&rdquo; ServiceAccount and what I call a natural person.</p>
<p>A natural person is a &ldquo;person&rdquo; as opposed to a resource such as a pod, which can be understood as a person who actually operates the &ldquo;kubectl&rdquo; command. admin can distribute private keys, but a natural person can store a file like KeyStone or even a file containing an account password, so there is no API for natural persons in k8s. The natural person is not described as an API object in k8s.</p>
<p>In a typical Kubernetes cluster, the API is typically served on port 443, and the APIServer provides self-signed certificates. When you create a cluster user with <code>kube-up.sh</code>, the certificate is automatically created in <code>$USER/.kube/config</code>, and subsequent accesses to the APIServer with the <code>kubectl</code> command are made with this certificate.</p>
<p>In contrast, ServiceAccounts are described and managed in k8s as API objects, which are bound to a specific namespace and can be created automatically by APIServer or by manually calling the k8s API.</p>
<h2 id="authentication-mechanism-authentication">Authentication mechanism (Authentication)</h2>
<p>The authentication mechanism in k8s is the first step in the user&rsquo;s access to the APIServer. Usually a complete HTTP request is made, but this step often only detects the request header or client certificate.</p>
<p>The authentication mechanism currently has several modes: client certificate, bearer tokens, authenticating proxy, HTTP basic auth. There are usually the following ways to use them.</p>
<ol>
<li>X509 Client Certs: The client certificate mode requires the <code>-client-ca-file=&lt;SOMEFILE&gt;</code> parameter to be added to the <code>kubectl</code> command, specifying the location of the certificate. 2.</li>
<li>Static Token File: <code>-token-auth-file=&lt;SOMEFILE&gt;</code> parameter specifies the location of <code>bearer tokens</code>.</li>
<li>bearer tokens: Add <code>Authorization: Bearer &lt;TOKEN&gt;</code> to the HTTP request header.</li>
<li>Bootstrap Tokens: Same as <code>bearer tokens</code>, but in TOKEN format <code>[a-z0-9]{6}. [a-z0-9]{16}</code>. This method is called dynamically-managed Bearer token and is stored in <code>kube-system namespace</code> as <code>secret</code> and can be created and managed dynamically. Also, enabling this method requires turning on <code>--enable-bootstrap-token-auth</code> in APIServer, which is still in alpha stage.</li>
<li>Static Password File: Specify the location of the basic auth file with the parameter <code>-basic-auth-file=&lt;SOMEFILE&gt;</code>. This basic auth file is in the form of a csv file containing at least three pieces of information: password, username, user id, and this mode requires <code>Authorization: Basic BASE64ENCODED(USER:PASSWORD)</code> in the request header when used.</li>
<li>Service Account Tokens: This mode is usually used by pods to access ApiServer by specifying the ServiceAccount in <code>PodSpec</code>.</li>
</ol>
<p>In addition to the above listed methods, there are some special access methods, which are not explained in detail here.</p>
<h2 id="authorization-mechanism">Authorization mechanism</h2>
<p>Once the user is authenticated, k8s' authorization mechanism checks the user&rsquo;s behavior and so on for authorization. In other words, the request itself, whether it has permission restrictions on a resource, namespace, or operation.</p>
<p>There are currently 4 modes of authorization mechanism: RBAC, ABAC, Node, Webhook, and the following is an analysis of each of these 4 modes.</p>
<h3 id="rbac">RBAC</h3>
<p>Role-based access control (RBAC) is role-based access control, usually for &ldquo;built-in users&rdquo;. This mode was developed in k8s v1.6. To enable this mode, set the parameter <code>--authorization-mode=RBAC</code> at APIServer startup.</p>
<p>The API Group used by RBAC is <code>rbac.authorization.k8s.io/v1beta1</code> until Kubernetes v1.8, when the RBAC module reaches a stable level and the API Group used is <code>rbac.authorization.k8s.io/v1</code>.</p>
<p>Role-based access control means that a user is given a role, and that role usually determines what permissions are available to which resources.</p>
<h4 id="serviceaccount">ServiceAccount</h4>
<p>First, let&rsquo;s take a look at the &ldquo;built-in user&rdquo;. Most of the time we don&rsquo;t use the &ldquo;natural person&rdquo; feature, but rather the ServiceAccount, and granting a ServiceAccount to another resource makes it possible to access APIServer as a &ldquo;built-in user&rdquo;.</p>
<p>Creating a ServiceAccount is as simple as specifying its namespace and name. As an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-sa</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="role--rolebinding">Role &amp; Rolebinding</h4>
<p>The most important concepts in RBAC are <code>Role</code> and <code>RoleBinding</code>. A <code>Role</code> defines a set of permissions to operate on Kubernetes API objects, while a <code>RoleBinding</code> defines the relationship between a specific ServiceAccount and a Role.</p>
<p>An example of a Role is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">	</span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-role</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>where</p>
<ul>
<li>
<p>namespace: is limited to logical &ldquo;isolation&rdquo; and does not provide any actual isolation or multi-tenancy capabilities.</p>
</li>
<li>
<p>rules: defines the permission rules that allow the &ldquo;actee&rdquo; to GET and LIST the Pod objects under hdls.</p>
</li>
<li>
<p>apiGroups: is &quot;&quot; for core API Group.</p>
</li>
<li>
<p>resources: refers to the resource type, which can also be divided in detail, specifying the name of the resources that can be manipulated,such as.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;configmaps&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;my-config&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>verbs: refers to specific operations. All operations that can be performed on API objects in the current Kubernetes (v1.11) are &ldquo;get&rdquo;, &ldquo;list&rdquo;, &ldquo;watch&rdquo;, &ldquo;create&rdquo;, &ldquo;update&rdquo;, &ldquo;patch&rdquo;, &ldquo;delete&rdquo;.</p>
</li>
</ul>
<p>Look at the RoleBinding example again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-rolebinding</span><span class="w">
</span><span class="w">	</span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-sa</span><span class="w">
</span><span class="w">	</span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">	</span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-role</span><span class="w">
</span><span class="w">	</span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>As you can see, this RoleBinding object defines a subjects field, which is the &ldquo;acted upon&rdquo;. The subjects can also be User and Group, User is the user in k8s, and Group is the ServiceAccounts.</p>
<p>The <code>roleRef</code> field is used to refer to the Role object we defined earlier (hdls-role) directly by name, thus defining the binding relationship between Subject and Role.</p>
<p>At this point, if we look at the previous <code>ServiceAccount</code> with the <code>kubectl get sa -n hdls -o yaml</code> command, we can see <code>ServiceAccount.secret</code>, because k8s automatically creates and assigns a <code>Secret</code> object to a <code>ServiceAccount</code>. object for a <code>ServiceAccount</code>, and this <code>Secret</code> is the authorization file used to interact with the APIServer: <code>Token</code>. The content of the <code>Token</code> file is usually a certificate or password that is stored in etcd as a <code>Secret</code> object.</p>
<p>At this point, we define the field <code>.spec.serviceAccountName</code> as the <code>ServiceAccount name</code> above in our Pod&rsquo;s YAML file to be declared for use.</p>
<p>If a Pod does not declare <code>serviceAccountName</code>, Kubernetes will automatically create a default <code>ServiceAccount</code> called <code>default</code> under its Namespace and assign it to the Pod. That is, it has access to most of the APIServer at this point.</p>
<h4 id="clusterrole--clusterrolebinding">ClusterRole &amp; ClusterRoleBinding</h4>
<p>Note that both Role and RoleBinding objects are Namespaced objects and they only work on resources within their own Namespace.</p>
<p>If a Role needs to work on a non-Namespaced object (e.g. Node), or if it wants to work on all Namespaces, we need to use ClusterRole and ClusterRoleBinding to do the authorization.</p>
<p>The usage of these two API objects is exactly the same as Role and RoleBinding. Except that they do not have the Namespace field in their definitions.</p>
<p>It&rsquo;s worth noting that Kubernetes has a number of built-in <code>ClusterRole</code>s reserved for the system, whose names start with <code>system:</code>. In general, these system-level <code>ClusterRoles</code> are bound to the <code>ServiceAccount</code> of the corresponding Kubernetes system component.</p>
<p>In addition, Kubernetes also provides four built-in <code>ClusterRole</code>s for direct use by users.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/a3535665e1da4078a71712845115260e.png" alt="ClusterRole"></p>
<p>cluster-admin: the highest privilege of the whole cluster. If used in <code>ClusterRoleBinding</code>, it means that all resources in all namespaces in this cluster have the highest privileges and can do whatever they want; if used in <code>RoleBinding</code>, it means that they can do whatever they want in a particular namespace.</p>
<p>admin: administrator privileges. If used in <code>RoleBinding</code>, this means that you have read and write access to most resources in a namespace, including the ability to create Roles and RoleBinding, but no write access to the resource quota or the namespace itself.</p>
<p>edit: write access. In a namespace, you have read and write access to most resources, but no read or write access to the Role and RoleBinding.</p>
<p>view: read access. In a namespace, only read access to most resources, no read access to Role and RoleBinding, and no read access to seccrets.</p>
<h4 id="aggregated-clusterroles">Aggregated ClusterRoles</h4>
<p>After Kubernetes v1.9, there is a new way to define <code>ClusterRole</code>, which is to use <code>aggregationRule</code> to combine multiple <code>ClusterRoles</code> into a new <code>ClusterRole</code>.</p>
<p>Let&rsquo;s start with an example from the official k8s website.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring</span><span class="w">
</span><span class="w"></span><span class="nt">aggregationRule</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">clusterRoleSelectors</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">rbac.example.com/aggregate-to-monitoring</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>rules</code> field does not need to be defined and will be automatically populated by the <code>controller manager</code>.</p>
<p>You can see that <code>aggregationRule</code> is a combination of all <code>ClusterRole</code>s that satisfy the <code>label</code> condition into one <code>ClusterRole</code>, and the new <code>ClusterRole</code> permissions are the sum of the others.</p>
<h4 id="group">Group</h4>
<p>In contrast to User, k8s also has the concept of a <code>Group</code>, which means a group of <code>users</code>. The same concept of &ldquo;group&rdquo; applies to the &ldquo;built-in user&rdquo; ServiceAccount.</p>
<p>In fact, a ServiceAccount, in Kubernetes, corresponds to a &ldquo;user&rdquo; with the following name: <code>system:serviceaccount:&lt;ServiceAccount name&gt;</code>; and it corresponds to a built-in The name of the built-in &ldquo;user group&rdquo; is <code>system:serviceaccounts:&lt;Namespace name&gt;</code>.</p>
<p>As an example of the use of Groups, we define subjects in the RoleBinding like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:serviceaccounts:hdls</span><span class="w">
</span><span class="w">	</span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>This means that the permission rules for this Role apply to all ServiceAccounts in hdls.</p>
<p>If the Group is defined as <code>system:serviceaccounts</code> without specifying Namespace, it means that it applies to all ServiceAccounts in the whole system.</p>
<h3 id="abac">ABAC</h3>
<p>Attribute-based access control (ABAC) is attribute-based access control. To enable this mode, you need to enable the <code>--authorization-policy-file=&lt;SOME_FILENAME&gt;</code> and <code>--authorization-mode=ABAC</code> parameters when APIServer starts.</p>
<p>The policy file is used to specify permission rules and must be in the format of a json object for each line. You can specify user or group as a specific object and describe the permissions it has.</p>
<p>In line with the Yaml file, the attributes that must be described are apiVersion, kind, and spec, while spec describes the specific users, resources, and behaviors. See an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;abac.authorization.kubernetes.io/v1beta1&#34;</span><span class="p">,</span> <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Policy&#34;</span><span class="p">,</span> <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;bob&#34;</span><span class="p">,</span> <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;projectCaribou&#34;</span><span class="p">,</span> <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;pods&#34;</span><span class="p">,</span> <span class="nt">&#34;readonly&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">}}</span>
</code></pre></td></tr></table>
</div>
</div><p>This describes that the user bob only has read access to the pod under the namespace projectCaribou. Similarly, the User can be a person, a kubelet or a ServiceAccount, where the ServiceAccount needs to be written in full, e.g. <code>system:serviceaccount:kube-system:default</code>.</p>
<p>If you want to describe everyone under a namespace, you need to use a group, such as.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;abac.authorization.kubernetes.io/v1beta1&#34;</span><span class="p">,</span> <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Policy&#34;</span><span class="p">,</span> <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&#34;group&#34;</span><span class="p">:</span> <span class="s2">&#34;system:serviceaccounts:default&#34;</span><span class="p">,</span> <span class="nt">&#34;readonly&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;pods&#34;</span><span class="p">}}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="node">Node</h3>
<p>The Node authorization mechanism is a special mode of authorization for requests initiated by <code>kubelet</code>. To enable this mode, turn on the parameter <code>--authorization-mode=Node</code>.</p>
<p>By enabling <code>--enable-admission-plugins=... , NodeRestriction, ...</code> to restrict kubelet access to node, endpoint, pod, service, and related resources such as secret, configmap, PV, and PVC.</p>
<h3 id="webhook">Webhook</h3>
<p>The Webhook pattern is an HTTP callback pattern, a simple event notification implemented via the <code>HTTP POST</code> method. This mode requires the APIServer configuration parameter <code>-authorization-webhook-config-file=&lt;SOME_FILENAME&gt;</code>, and the format of the HTTP configuration file is similar to that of kubeconfig.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Kubernetes API version</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="c"># kind of the API object</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Config</span><span class="w">
</span><span class="w"></span><span class="c"># clusters refers to the remote service.</span><span class="w">
</span><span class="w"></span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">name-of-remote-authz-service</span><span class="w">
</span><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># CA for verifying the remote service.</span><span class="w">
</span><span class="w">      </span><span class="nt">certificate-authority</span><span class="p">:</span><span class="w"> </span><span class="l">/path/to/ca.pem</span><span class="w">
</span><span class="w">      </span><span class="c"># URL of remote service to query. Must use &#39;https&#39;. May not include parameters.</span><span class="w">
</span><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://authz.example.com/authorize</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># users refers to the API Server&#39;s webhook configuration.</span><span class="w">
</span><span class="w"></span><span class="nt">users</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">name-of-api-server</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l">/path/to/cert.pem</span><span class="w"> </span><span class="c"># cert for the webhook plugin to use</span><span class="w">
</span><span class="w">      </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l">/path/to/key.pem         </span><span class="w"> </span><span class="c"># key matching the cert</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># kubeconfig files require a context. Provide one for the API Server.</span><span class="w">
</span><span class="w"></span><span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l">webhook</span><span class="w">
</span><span class="w"></span><span class="nt">contexts</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">context</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">name-of-remote-authz-service</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">name-of-api-server</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webhook</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>where Cluster refers to the client where the callback is needed, specifying its access certificate and URL; user refers to the identity accessed at the callback, specifying its required certificate and key; and contexts refers to the content of the callback.</p>
<h2 id="access-controls-admission-controllers">Access Controls (Admission Controllers)</h2>
<p>After a request has passed the authentication mechanism and authorization authentication, it needs to go through a final layer of screening, namely the access control. The code for this access control module is usually in the APIServer and is compiled into a binary file for execution. The point of this layer of security checks is to check if the request meets the system&rsquo;s threshold, i.e. if it satisfies the system&rsquo;s default settings and adds default parameters.</p>
<p>Access control exists in the form of a plugin, which is turned on as <code>kube-apiserver --enable-admission-plugins=NamespaceLifecycle,LimitRanger ...</code></p>
<p>The shutdown is done as
<code>kube-apiserver --disable-admission-plugins=PodNodeSelector,AlwaysDeny ...</code></p>
<p>Commonly used access control plugins are.</p>
<ul>
<li>AlwaysAdmit: allows all requests to pass, officially opposed because there is no practical point.</li>
<li>AlwaysPullImages: change the image pull policy to always for each pod, which is used in multi-tenant clusters.</li>
<li>AlwaysDeny: disallow all requests to go through, objected to by officials because it makes no practical sense.</li>
<li>DefaultStorageClass: creates a default PV for each <code>PersistentVolumeClaim</code>.</li>
<li>DefaultTolerationSeconds: if the pod has no tolerance for the taint <code>node.kubernetes.io/not-ready:NoExecute</code> and <code>node.alpha.kubernetes.io/unreachable:NoExecute</code>, create a default 5-minute tolerance for its create default 5-minute tolerances for <code>notready:NoExecute</code> and <code>unreachable:NoExecute</code>.</li>
<li>LimitRanger: ensures that each request does not exceed the LimitRange under its namespace, and this access control plugin must be enabled if LimitRange objects are used in Deployment.</li>
<li>NamespaceAutoProvision: checks if the corresponding namespace exists in the request, and automatically creates it if it does not exist.</li>
<li>NamespaceExists: checks if the corresponding namespace exists in the request, and rejects the request if it does not exist; * NamespaceLifecycle: checks if the corresponding namespace exists in the request.</li>
<li>NamespaceLifecycle: ensures that no new resources are created in the deleted namespace.</li>
<li>NodeRestriction: does not allow kubelet to modify Node and Pod objects.</li>
<li>PodNodeSelector: controls which label selectors are available under a namespace by reading the annotations and global configuration of the namespace.</li>
<li>PodPreset: disallows pods that meet pre-set criteria to be created.</li>
<li>Priority: determine priority via <code>priorityClassName</code>.</li>
<li>ResourceQuota: guarantees the resource quota under namespace; * ServiceAccount: guarantees the ServiceAccount.</li>
<li>ServiceAccount: Ensures automatic creation of ServiceAccount, which is recommended to be enabled if ServiceAccount is used.</li>
</ul>
<p>The above is only a partial list, please move to the official Kubernetes documentation for more details.</p>
<p>Official recommendations.</p>
<ul>
<li>
<p>Version &gt; v1.10:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">--enable-admission-plugins<span class="o">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>v1.9</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">--admission-control<span class="o">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>v1.6 - v1.8</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">--admission-control<span class="o">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>v1.4 - v1.5</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">--admission-control<span class="o">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota
</code></pre></td></tr></table>
</div>
</div></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/kubernetes-networking/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Getting Started with Kubernetes - Networking Explained</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubernetes-job-and-cronjob/">
            <span class="next-text nav-default">Kubernetes Job and Cronjob</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
