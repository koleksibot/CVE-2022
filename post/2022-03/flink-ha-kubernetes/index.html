<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Flink JobManager HA on Kubernetes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article introduces the idea of implementing Flink&amp;rsquo;s JobManager HA on top of Kubernetes. flink 1.12 is not yet released, but we have seen this piece in the development plan. But this post is mainly about our internal implementation. 0. Flink HA HA stands for HighAvailability and is used in many distributed systems to solve the SPOF (single point of failure) problem. For example, the NameNode of HDFS, the distributed" /><meta name="keywords" content="Kubernetes, Flink JobManager  Ha" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/flink-ha-kubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Flink JobManager HA on Kubernetes" />
<meta property="og:description" content="This article introduces the idea of implementing Flink&rsquo;s JobManager HA on top of Kubernetes. flink 1.12 is not yet released, but we have seen this piece in the development plan. But this post is mainly about our internal implementation. 0. Flink HA HA stands for HighAvailability and is used in many distributed systems to solve the SPOF (single point of failure) problem. For example, the NameNode of HDFS, the distributed" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/flink-ha-kubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-18T09:40:24+08:00" />
<meta property="article:modified_time" content="2022-03-18T09:40:24+08:00" />

<meta itemprop="name" content="Flink JobManager HA on Kubernetes">
<meta itemprop="description" content="This article introduces the idea of implementing Flink&rsquo;s JobManager HA on top of Kubernetes. flink 1.12 is not yet released, but we have seen this piece in the development plan. But this post is mainly about our internal implementation. 0. Flink HA HA stands for HighAvailability and is used in many distributed systems to solve the SPOF (single point of failure) problem. For example, the NameNode of HDFS, the distributed"><meta itemprop="datePublished" content="2022-03-18T09:40:24+08:00" />
<meta itemprop="dateModified" content="2022-03-18T09:40:24+08:00" />
<meta itemprop="wordCount" content="4667">
<meta itemprop="keywords" content="flink,Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flink JobManager HA on Kubernetes"/>
<meta name="twitter:description" content="This article introduces the idea of implementing Flink&rsquo;s JobManager HA on top of Kubernetes. flink 1.12 is not yet released, but we have seen this piece in the development plan. But this post is mainly about our internal implementation. 0. Flink HA HA stands for HighAvailability and is used in many distributed systems to solve the SPOF (single point of failure) problem. For example, the NameNode of HDFS, the distributed"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Flink JobManager HA on Kubernetes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-18 09:40:24 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4667 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0-flink-ha">0. Flink HA</a>
          <ul>
            <li><a href="#1-leader-election">1. Leader Election</a></li>
            <li><a href="#2-flink-ha-service-interface">2. Flink HA Service Interface</a></li>
          </ul>
        </li>
        <li><a href="#1-ha-scheme-implementation-based-on-zookeeper">1. HA scheme implementation based on ZooKeeper</a>
          <ul>
            <li><a href="#1-zookeeper-master-selection">1. ZooKeeper master selection</a></li>
            <li><a href="#2-flink-leader-election">2. Flink Leader Election</a></li>
            <li><a href="#3-flink-leader-retrieval">3. Flink Leader Retrieval</a></li>
            <li><a href="#4-runningjobsregistry">4. RunningJobsRegistry</a></li>
          </ul>
        </li>
        <li><a href="#2-why-you-need-a-kubernetes-based-ha-solution">2. Why you need a Kubernetes-based HA solution</a></li>
        <li><a href="#3-specific-implementation-of-the-program">3. Specific implementation of the program</a>
          <ul>
            <li><a href="#1-k8s-based-leader-election">1. k8s-based leader election</a></li>
            <li><a href="#2-implementation-of-flink-ha-on-k8s">2. Implementation of Flink HA on k8s</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article introduces the idea of implementing Flink&rsquo;s JobManager HA on top of Kubernetes. flink 1.12 is not yet released, but we have seen this piece in the development plan. But this post is mainly about our internal implementation.</p>
<h2 id="0-flink-ha">0. Flink HA</h2>
<p>HA stands for HighAvailability and is used in many distributed systems to solve the SPOF (<em>single point of failure</em>) problem. For example, the NameNode of HDFS, the distributed file system of the Big Data ecosystem (which can be simply understood as the master in the master-slave structure), has to be enabled for HA in the production environment. Similarly, many HAs are for the master in the distributed architecture (master-slave).</p>
<p>So, how can HA solve the single point problem? In a non-HA system, once the master hangs, a lot of work undertaken by the master role will stop. For example, Flink&rsquo;s JobManager is responsible for task forwarding. In the non-HA case, we have to restart the job and start the computation from scratch. But with HA, when a JobManager hangs, a new JobManager will replace it so that the job can continue to run.</p>
<p>The need for HA requires the simultaneous existence of several identical service processes, but the real service should be only one process, which is the Leader, and how to choose one of these services to serve is the Leader election.</p>
<h3 id="1-leader-election">1. Leader Election</h3>
<p>In a typical Leader election, multiple candidates (candidates) compete for the position of leader (normally only one), a process called Leader Election. The leader needs to keep sending heartbeats in order to explain his role as leader to other followers. However, heartbeats have a disadvantage that they may lead to multiple owners when the network is unstable. In order to solve this problem, the concept of lease was introduced. The lease mechanism is simply a specific role to issue a lease to all the nodes in the system, and the node that gets the lease is the leader. the lease corresponds to a valid timeout, and before the timeout runs out, the leader needs to renew the lease, otherwise a new round of leader election is required.</p>
<p>In addition to implementing a consistency algorithm, we can also use some distributed coordination systems (coordinator), such as ZooKeeper, Etcd, and so on, to implement the leader election.</p>
<h3 id="2-flink-ha-service-interface">2. Flink HA Service Interface</h3>
<p>Currently Flink&rsquo;s HA service is abstracted as interface <em><strong>HighAvailabilityServices</strong></em>, we can implement our own HA service in a plug-in way. <em><strong>HighAvailabilityServices</strong></em> is responsible for all services that need to be guaranteed highly available, and its main tasks include</p>
<ul>
<li>ResourceManager leader election and leader acquisition. (ResourceManager is a component of JobManager)</li>
<li>JobManager leader election and leader acquisition.</li>
<li>Metadata storage for checkpoint. checkpoint is a distributed snapshot of the distributed computing system, and a new JobManager can read the checkpoint to restore the previous job state. The checkpoint itself is usually stored in a distributed file system, such as HDFS, and the HA service only needs to store the checkpoint&rsquo;s file path.</li>
<li>Register the latest checkpoint. checkpoint will be done once every fixed interval, when recovering, you can generally recover from the latest one.</li>
<li>Registry is responsible for managing the status of jobs.</li>
</ul>
<p>The following is the implementation of the interface, where some of the Deprecated methods have been removed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HighAvailabilityServices</span> <span class="kd">extends</span> <span class="n">ClientHighAvailabilityServices</span> <span class="o">{</span>
  <span class="c1">// 获取 resource manager 的 leader retriever
</span><span class="c1"></span>	<span class="n">LeaderRetrievalService</span> <span class="nf">getResourceManagerLeaderRetriever</span><span class="o">();</span>

  <span class="c1">// 获取 dispatcher 的 leader retriever
</span><span class="c1"></span>	<span class="n">LeaderRetrievalService</span> <span class="nf">getDispatcherLeaderRetriever</span><span class="o">();</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the leader retriever for the job JobMaster which is responsible for the given job.
</span><span class="cm">	 *
</span><span class="cm">	 * @param jobID The identifier of the job.
</span><span class="cm">	 * @param defaultJobManagerAddress JobManager address which will be returned by
</span><span class="cm">	 *                              a static leader retrieval service.
</span><span class="cm">	 * @return Leader retrieval service to retrieve the job manager for the given job
</span><span class="cm">	 */</span>
	<span class="n">LeaderRetrievalService</span> <span class="nf">getJobManagerLeaderRetriever</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">String</span> <span class="n">defaultJobManagerAddress</span><span class="o">);</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the leader election service for the cluster&#39;s resource manager.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Leader election service for the resource manager leader election
</span><span class="cm">	 */</span>
	<span class="n">LeaderElectionService</span> <span class="nf">getResourceManagerLeaderElectionService</span><span class="o">();</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the leader election service for the cluster&#39;s dispatcher.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Leader election service for the dispatcher leader election
</span><span class="cm">	 */</span>
	<span class="n">LeaderElectionService</span> <span class="nf">getDispatcherLeaderElectionService</span><span class="o">();</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the leader election service for the given job.
</span><span class="cm">	 *
</span><span class="cm">	 * @param jobID The identifier of the job running the election.
</span><span class="cm">	 * @return Leader election service for the job manager leader election
</span><span class="cm">	 */</span>
	<span class="n">LeaderElectionService</span> <span class="nf">getJobManagerLeaderElectionService</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">);</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the checkpoint recovery factory for the job manager.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Checkpoint recovery factory
</span><span class="cm">	 */</span>
	<span class="n">CheckpointRecoveryFactory</span> <span class="nf">getCheckpointRecoveryFactory</span><span class="o">();</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the submitted job graph store for the job manager.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Submitted job graph store
</span><span class="cm">	 * @throws Exception if the submitted job graph store could not be created
</span><span class="cm">	 */</span>
	<span class="n">JobGraphStore</span> <span class="nf">getJobGraphStore</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the registry that holds information about whether jobs are currently running.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Running job registry to retrieve running jobs
</span><span class="cm">	 */</span>
	<span class="n">RunningJobsRegistry</span> <span class="nf">getRunningJobsRegistry</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

	<span class="cm">/**
</span><span class="cm">	 * Creates the BLOB store in which BLOBs are stored in a highly-available fashion.
</span><span class="cm">	 *
</span><span class="cm">	 * @return Blob store
</span><span class="cm">	 * @throws IOException if the blob store could not be created
</span><span class="cm">	 */</span>
	<span class="n">BlobStore</span> <span class="nf">createBlobStore</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

	<span class="cm">/**
</span><span class="cm">	 * Gets the leader election service for the cluster&#39;s rest endpoint.
</span><span class="cm">	 *
</span><span class="cm">	 * @return the leader election service used by the cluster&#39;s rest endpoint
</span><span class="cm">	 */</span>
	<span class="k">default</span> <span class="n">LeaderElectionService</span> <span class="nf">getClusterRestEndpointLeaderElectionService</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// for backwards compatibility we delegate to getWebMonitorLeaderElectionService
</span><span class="c1"></span>		<span class="c1">// all implementations of this interface should override getClusterRestEndpointLeaderElectionService, though
</span><span class="c1"></span>		<span class="k">return</span> <span class="n">getWebMonitorLeaderElectionService</span><span class="o">();</span>
	<span class="o">}</span>

	
	<span class="k">default</span> <span class="n">LeaderRetrievalService</span> <span class="nf">getClusterRestEndpointLeaderRetriever</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// for backwards compatibility we delegate to getWebMonitorLeaderRetriever
</span><span class="c1"></span>		<span class="c1">// all implementations of this interface should override getClusterRestEndpointLeaderRetriever, though
</span><span class="c1"></span>		<span class="k">return</span> <span class="n">getWebMonitorLeaderRetriever</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// ------------------------------------------------------------------------
</span><span class="c1"></span>	<span class="c1">//  Shutdown and Cleanup
</span><span class="c1"></span>	<span class="c1">// ------------------------------------------------------------------------
</span><span class="c1"></span>
	<span class="cm">/**
</span><span class="cm">	 * Closes the high availability services, releasing all resources.
</span><span class="cm">	 *
</span><span class="cm">	 * &lt;p&gt;This method &lt;b&gt;does not delete or clean up&lt;/b&gt; any data stored in external stores
</span><span class="cm">	 * (file systems, ZooKeeper, etc). Another instance of the high availability
</span><span class="cm">	 * services will be able to recover the job.
</span><span class="cm">	 *
</span><span class="cm">	 * &lt;p&gt;If an exception occurs during closing services, this method will attempt to
</span><span class="cm">	 * continue closing other services and report exceptions only after all services
</span><span class="cm">	 * have been attempted to be closed.
</span><span class="cm">	 *
</span><span class="cm">	 * @throws Exception Thrown, if an exception occurred while closing these services.
</span><span class="cm">	 */</span>
	
	<span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

	<span class="cm">/**
</span><span class="cm">	 * Closes the high availability services (releasing all resources) and deletes
</span><span class="cm">	 * all data stored by these services in external stores.
</span><span class="cm">	 *
</span><span class="cm">	 * &lt;p&gt;After this method was called, the any job or session that was managed by
</span><span class="cm">	 * these high availability services will be unrecoverable.
</span><span class="cm">	 *
</span><span class="cm">	 * &lt;p&gt;If an exception occurs during cleanup, this method will attempt to
</span><span class="cm">	 * continue the cleanup and report exceptions only after all cleanup steps have
</span><span class="cm">	 * been attempted.
</span><span class="cm">	 *
</span><span class="cm">	 * @throws Exception Thrown, if an exception occurred while closing these services
</span><span class="cm">	 *                   or cleaning up data stored by them.
</span><span class="cm">	 */</span>
	<span class="kt">void</span> <span class="nf">closeAndCleanupAllData</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><em><strong>HighAvailabilityServices</strong></em> There are several other related interfaces involved.</p>
<p><em><strong>LedaerElectionService</strong></em> helps campaigners <em><strong>LeaderContender</strong></em> to participate in leader elections. All services that participate in leader elections need to implement the interface <em><strong>LeaderContender</strong></em>, which is implemented by four services in Flink.</p>
<ul>
<li>Dispatcher</li>
<li>JobManager</li>
<li>ResourceManager</li>
<li>WebMonitorEndpoint</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LeaderElectionService</span> <span class="o">{</span>
  <span class="c1">// 启动 leader 选举服务，内部在选举结束之后会根据成功或者失败调用 LeaderContender 的指定的回调函数
</span><span class="c1"></span>  <span class="c1">// 除此之外还会将 contender 加入到 listener 中，以便在之后的选举流程中使用
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">LeaderContender</span> <span class="n">contender</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

  <span class="c1">// 停止 leader 选举服务
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

  <span class="c1">// 确认竞争者接受了 leader 委派并发布其 leader 地址
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">confirmLeadership</span><span class="o">(</span><span class="n">UUID</span> <span class="n">leaderSessionID</span><span class="o">,</span> <span class="n">String</span> <span class="n">leaderAddress</span><span class="o">);</span>

  <span class="c1">// 返回在 leaderSessionId 内，与该 service 绑定的竞争者是否是 leader
</span><span class="c1"></span>	<span class="kt">boolean</span> <span class="nf">hasLeadership</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="n">UUID</span> <span class="n">leaderSessionId</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 需要参与 leader 选举的服务都需要实现该接口
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LeaderContender</span> <span class="o">{</span>
  <span class="c1">// 被选为 leader 时的回调函数
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">grantLeadership</span><span class="o">(</span><span class="n">UUID</span> <span class="n">leaderSessionID</span><span class="o">);</span>

  <span class="c1">// 之前的 leader 被剥夺 leader 角色时的调用函数
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">revokeLeadership</span><span class="o">();</span>

  <span class="c1">// 错误处理
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">handleError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="o">);</span>

	<span class="k">default</span> <span class="n">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">&#34;LeaderContender: &#34;</span> <span class="o">+</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><em><strong>LeaderRetrievalService</strong></em> is used to get the current leader of the supported HA services and to notify the listener of the new leader when the leader changes. The listener corresponds to <em><strong>LeaderRetrievalListener</strong></em>, which needs to be implemented by all services that want to receive notifications about new leaders.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LeaderRetrievalService</span> <span class="o">{</span>
  <span class="c1">// 启动 service，并且将 listener 加到回调队列中，当出现新的 leader 时进行回调。
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">LeaderRetrievalListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

	<span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LeaderRetrievalListener</span> <span class="o">{</span>
  <span class="c1">// 当新的 leader 被选出来时，会通过回调该方法进行通知
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">notifyLeaderAddress</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">leaderAddress</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">UUID</span> <span class="n">leaderSessionID</span><span class="o">);</span>

	<span class="kt">void</span> <span class="nf">handleError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><em><strong>CheckpointRecoveryFactory</strong></em> is the checkpoint related interface. HA Service only stores checkpoint metadata such as the checkpoint storage path (e.g. HDFS), and does not store checkpoint data. This part is mostly about checkpoint related logic, so I won&rsquo;t go over it here.</p>
<p><em><strong>RunningJobsRegistry</strong></em> is used to track the status of jobs. For example, when a leader switch occurs, the new jobmanager needs to recover with the help of <em><strong>RunningJobsRegistry</strong></em>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RunningJobsRegistry</span> <span class="o">{</span>
	<span class="kd">enum</span> <span class="n">JobSchedulingStatus</span> <span class="o">{</span>
		<span class="n">PENDING</span><span class="o">,</span>
		<span class="n">RUNNING</span><span class="o">,</span>
		<span class="n">DONE</span><span class="o">;</span>
	<span class="o">}</span>

  <span class="c1">// 将作业状态设置为 Running
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">setJobRunning</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

  <span class="c1">// 将作业状态设置为完成
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">setJobFinished</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

  <span class="c1">// 获得作业的 schedule 状态
</span><span class="c1"></span>	<span class="n">JobSchedulingStatus</span> <span class="nf">getJobSchedulingStatus</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

	<span class="kt">void</span> <span class="nf">clearJob</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="1-ha-scheme-implementation-based-on-zookeeper">1. HA scheme implementation based on ZooKeeper</h2>
<h3 id="1-zookeeper-master-selection">1. ZooKeeper master selection</h3>
<p>It is well known that zk can be used to select a master, and the principle is simple: all candidates participating in the master selection try to create a specified znode (the creation path is atomic), which is actually a path, and the successful one is the leader. persist and ephemeral. persist&rsquo;s znode and its stored data will always exist unless manually deleted; ephemeral&rsquo;s znode&rsquo;s lifecycle is consistent with the client that created it, strictly speaking with the lifecycle of the connection between the client and the server (i.e., the session). Once the client and server are disconnected, the ephemeral znode will be deleted. In addition, zk provides an api called watch, so that other followers can listen to the leader hang up by watching the leader&rsquo;s znode.</p>
<p>In short, by creating an ephemeral znode we can implement leader election and leader sensing.</p>
<h4 id="curator-leaderlatch">Curator leaderLatch</h4>
<p>Although it is relatively simple to implement leader election via zk, we generally do not write the code logic naked. Since the common uses of zk are relatively fixed (choosing a leader, distributed locks, etc.), Netflix has open-sourced a zk client-side operation framework: curator, and now everyone operates zk through curator, such as Spark and Flink.</p>
<p>To use LeaderLatch to select a master is very simple, basically follow the procedure below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">leaderLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LeaderLatch</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">latchPath</span><span class="o">);</span>	<span class="c1">// 创建 LeaderLatch
</span><span class="c1"></span><span class="n">leaderLatch</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>										<span class="c1">// 添加回调对象
</span><span class="c1"></span><span class="n">leaderLatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>				
</code></pre></td></tr></table>
</div>
</div><p>The second of these adds the callback object, which is actually the following interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LeaderLatchListener</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">isLeader</span><span class="o">();</span>	<span class="c1">// leader 回调
</span><span class="c1"></span>
    <span class="kt">void</span> <span class="nf">notLeader</span><span class="o">();</span>	<span class="c1">// 非 leader 回调
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The process that is successfully elected as leader will call back the method <code>isLeader()</code>, otherwise it will call back the method <code>notLeader()</code>.</p>
<h3 id="2-flink-leader-election">2. Flink Leader Election</h3>
<p>There are four services in Flink&rsquo;s <em><strong>HighAvailabilityServices</strong></em> that need to elect a leader: ResourceManager, Dispatcher, JobManager, and ClusterRestEndpoint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="cm">/**
</span><span class="cm"> * Gets the leader election service for the cluster&#39;s resource manager.
</span><span class="cm"> */</span>
<span class="n">LeaderElectionService</span> <span class="nf">getResourceManagerLeaderElectionService</span><span class="o">();</span>
 <span class="cm">/**
</span><span class="cm"> * Gets the leader election service for the cluster&#39;s dispatcher.
</span><span class="cm"> */</span>
<span class="n">LeaderElectionService</span> <span class="nf">getDispatcherLeaderElectionService</span><span class="o">();</span>
 <span class="cm">/**
</span><span class="cm"> * Gets the leader election service for the given job.
</span><span class="cm"> */</span>
<span class="n">LeaderElectionService</span> <span class="nf">getJobManagerLeaderElectionService</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">);</span>
 <span class="cm">/**
</span><span class="cm"> * Gets the leader election service for the cluster&#39;s rest endpoint.
</span><span class="cm"> */</span>
<span class="k">default</span> <span class="n">LeaderElectionService</span> <span class="nf">getClusterRestEndpointLeaderElectionService</span><span class="o">()</span>

</code></pre></td></tr></table>
</div>
</div><p>From the above analysis of zk leader selection, we can think that these four methods should return one implementation, but the path of the corresponding znode of zk is different. This is indeed the case, as they all return <em><strong>ZooKeeperLeaderElectionService</strong></em>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZooKeeperLeaderElectionService</span> <span class="kd">implements</span> <span class="n">LeaderElectionService</span><span class="o">,</span> <span class="n">LeaderLatchListener</span><span class="o">,</span> <span class="n">NodeCacheListener</span><span class="o">,</span> <span class="n">UnhandledErrorListener</span> <span class="o">{</span>
  <span class="c1">// zk 相关
</span><span class="c1"></span>  <span class="cm">/** Client to the ZooKeeper quorum. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">;</span>

	<span class="cm">/** Curator recipe for leader election. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">LeaderLatch</span> <span class="n">leaderLatch</span><span class="o">;</span>

	<span class="cm">/** Curator recipe to watch a given ZooKeeper node for changes. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">NodeCache</span> <span class="n">cache</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <em><strong>ZooKeeperLeaderElectionService</strong></em> member contains curator&rsquo;s LeaderLatch for selecting the master and NodeCache for listening to leader node changes. <em><strong>ZooKeeperLeaderElectionService</strong></em> implements Flink&rsquo;s interface <em><strong>LeaderElectionService</strong></em>, as well as curator&rsquo;s interface <em><strong>LeaderLatchListener</strong></em> and <em><strong>NodeCacheListener</strong></em> so that we can add the current object as a callback to zk&rsquo;s callback object. <em><strong>LeaderLatchListener</strong></em> is used for callbacks on the completion of the master selection (success or failure), <em><strong>NodeCacheListener</strong></em> is used for callbacks on node changes.</p>
<h3 id="3-flink-leader-retrieval">3. Flink Leader Retrieval</h3>
<p>Leader Retrieval is actually the interface <em><strong>LeaderRetrievalService</strong></em> in Flink&rsquo;s HaService, and as mentioned earlier, the biggest role of <em><strong>LeaderRetrievalService</strong></em> is to notify the client when the Leader changes. The main function of <em><strong>LeaderRetrievalService</strong></em> is to notify the client when the leader changes, which is actually Flink&rsquo;s TaskManager, etc. It is easy to think of zk&rsquo;s <em><strong>LeaderRetrievalService</strong></em> as extending the curator framework&rsquo;s <em><strong>NodeCacheListener</strong></em>, let&rsquo;s see if it is.</p>
<p>The interface <em><strong>LeaderRetrievalService</strong></em> is based on the zk implementation <em><strong>ZooKeeperLeaderRetrievalService</strong></em>. We have three methods listed below.</p>
<ul>
<li><em><strong>start</strong></em>: interface <em><strong>LeaderRetrievalService</strong></em> describes the <em><strong>start</strong></em> method as <strong>Starts the leader retrieval service with the given listener to Starts the leader retrieval service with the given listener to listen for new leaders.</strong> The core of this is to add the listener to the callback object to notify when the leader changes. But based on zk implementation, the callback is done by zk, but the <em><strong>start</strong></em> entry LeaderRetrievalListener does not work as a callback object for zk (no NodeCacheListener is implemented). So the callback here is actually zk calling back <em><strong>ZooKeeperLeaderRetrievalService</strong></em>, and then <em><strong>ZooKeeperLeaderRetrievalService</strong></em> notifying the real listener.</li>
<li><em><strong>stop</strong></em>: not much to say, relatively simple, mainly stop and clean up.</li>
<li><em><strong>nodeChanged</strong></em>: the callback function for zk when the leader changes.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZooKeeperLeaderRetrievalService</span> <span class="kd">implements</span> <span class="n">LeaderRetrievalService</span><span class="o">,</span> <span class="n">NodeCacheListener</span><span class="o">,</span> <span class="n">UnhandledErrorListener</span> <span class="o">{</span>
	<span class="cm">/** Connection to the used ZooKeeper quorum. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">;</span>

	<span class="cm">/** Curator recipe to watch changes of a specific ZooKeeper node. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">NodeCache</span> <span class="n">cache</span><span class="o">;</span>
  
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">LeaderRetrievalListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">leaderListener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>

			<span class="n">client</span><span class="o">.</span><span class="na">getUnhandledErrorListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
			<span class="n">cache</span><span class="o">.</span><span class="na">getListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
			<span class="n">cache</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

			<span class="n">client</span><span class="o">.</span><span class="na">getConnectionStateListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">connectionStateListener</span><span class="o">);</span>

			<span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

  
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">client</span><span class="o">.</span><span class="na">getUnhandledErrorListenable</span><span class="o">().</span><span class="na">removeListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		<span class="n">client</span><span class="o">.</span><span class="na">getConnectionStateListenable</span><span class="o">().</span><span class="na">removeListener</span><span class="o">(</span><span class="n">connectionStateListener</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">cache</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="s">&#34;Could not properly stop the ZooKeeperLeaderRetrievalService.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">nodeChanged</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Leader node has changed.&#34;</span><span class="o">);</span>

					<span class="n">ChildData</span> <span class="n">childData</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">getCurrentData</span><span class="o">();</span>

					<span class="n">String</span> <span class="n">leaderAddress</span><span class="o">;</span>
					<span class="n">UUID</span> <span class="n">leaderSessionID</span><span class="o">;</span>

					<span class="k">if</span> <span class="o">(</span><span class="n">childData</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">leaderAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
						<span class="n">leaderSessionID</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
						<span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">childData</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>

						<span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">leaderAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
							<span class="n">leaderSessionID</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
						<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
							<span class="n">ByteArrayInputStream</span> <span class="n">bais</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
							<span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">bais</span><span class="o">);</span>

							<span class="n">leaderAddress</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
							<span class="n">leaderSessionID</span> <span class="o">=</span> <span class="o">(</span><span class="n">UUID</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
						<span class="o">}</span>
					<span class="o">}</span>

					<span class="k">if</span> <span class="o">(!(</span><span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">leaderAddress</span><span class="o">,</span> <span class="n">lastLeaderAddress</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
						<span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">leaderSessionID</span><span class="o">,</span> <span class="n">lastLeaderSessionID</span><span class="o">)))</span> <span class="o">{</span>
						<span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
							<span class="s">&#34;New leader information: Leader={}, session ID={}.&#34;</span><span class="o">,</span>
							<span class="n">leaderAddress</span><span class="o">,</span>
							<span class="n">leaderSessionID</span><span class="o">);</span>

						<span class="n">lastLeaderAddress</span> <span class="o">=</span> <span class="n">leaderAddress</span><span class="o">;</span>
						<span class="n">lastLeaderSessionID</span> <span class="o">=</span> <span class="n">leaderSessionID</span><span class="o">;</span>
						<span class="n">leaderListener</span><span class="o">.</span><span class="na">notifyLeaderAddress</span><span class="o">(</span><span class="n">leaderAddress</span><span class="o">,</span> <span class="n">leaderSessionID</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">leaderListener</span><span class="o">.</span><span class="na">handleError</span><span class="o">(</span><span class="k">new</span> <span class="n">Exception</span><span class="o">(</span><span class="s">&#34;Could not handle node changed event.&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">));</span>
					<span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ignoring node change notification since the service has already been stopped.&#34;</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="4-runningjobsregistry">4. RunningJobsRegistry</h3>
<p>Another piece of HA Service is <em><strong>RunningJobsRegistry</strong></em>, which is used to record the running jobs. The zk-based implementation can be thought of as long as it is based on a fixed path for reading and writing, which is relatively simple and will not be repeated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * A zookeeper based registry for running jobs, highly available.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZooKeeperRunningJobsRegistry</span> <span class="kd">implements</span> <span class="n">RunningJobsRegistry</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ZooKeeperRunningJobsRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Charset</span> <span class="n">ENCODING</span> <span class="o">=</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">);</span>

	<span class="cm">/** The ZooKeeper client to use. */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">runningJobPath</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">ZooKeeperRunningJobsRegistry</span><span class="o">(</span><span class="kd">final</span> <span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="s">&#34;client&#34;</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">runningJobPath</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">HighAvailabilityOptions</span><span class="o">.</span><span class="na">ZOOKEEPER_RUNNING_JOB_REGISTRY_PATH</span><span class="o">);</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJobRunning</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">checkNotNull</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">writeEnumToZooKeeper</span><span class="o">(</span><span class="n">jobID</span><span class="o">,</span> <span class="n">JobSchedulingStatus</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;Failed to set RUNNING state in ZooKeeper for job &#34;</span> <span class="o">+</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJobFinished</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">checkNotNull</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">writeEnumToZooKeeper</span><span class="o">(</span><span class="n">jobID</span><span class="o">,</span> <span class="n">JobSchedulingStatus</span><span class="o">.</span><span class="na">DONE</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;Failed to set DONE state in ZooKeeper for job &#34;</span> <span class="o">+</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="n">JobSchedulingStatus</span> <span class="nf">getJobSchedulingStatus</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">checkNotNull</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kd">final</span> <span class="n">String</span> <span class="n">zkPath</span> <span class="o">=</span> <span class="n">createZkPath</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>
			<span class="kd">final</span> <span class="n">Stat</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">checkExists</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// found some data, try to parse it
</span><span class="c1"></span>				<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="kd">final</span> <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">ENCODING</span><span class="o">);</span>
						<span class="k">return</span> <span class="n">JobSchedulingStatus</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;Found corrupt data in ZooKeeper: &#34;</span> <span class="o">+</span>
								<span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34; is no valid job status&#34;</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="c1">// nothing found, yet, must be in status &#39;PENDING&#39;
</span><span class="c1"></span>			<span class="k">return</span> <span class="n">JobSchedulingStatus</span><span class="o">.</span><span class="na">PENDING</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;Get finished state from zk fail for job &#34;</span> <span class="o">+</span> <span class="n">jobID</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearJob</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
		<span class="n">checkNotNull</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kd">final</span> <span class="n">String</span> <span class="n">zkPath</span> <span class="o">=</span> <span class="n">createZkPath</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">newNamespaceAwareEnsurePath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">).</span><span class="na">ensure</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getZookeeperClient</span><span class="o">());</span>
			<span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">delete</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;Failed to clear job state from ZooKeeper for job &#34;</span> <span class="o">+</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">String</span> <span class="nf">createZkPath</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">runningJobPath</span> <span class="o">+</span> <span class="n">jobID</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeEnumToZooKeeper</span><span class="o">(</span><span class="n">JobID</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">JobSchedulingStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Setting scheduling state for job {} to {}.&#34;</span><span class="o">,</span> <span class="n">jobID</span><span class="o">,</span> <span class="n">status</span><span class="o">);</span>
		<span class="kd">final</span> <span class="n">String</span> <span class="n">zkPath</span> <span class="o">=</span> <span class="n">createZkPath</span><span class="o">(</span><span class="n">jobID</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">newNamespaceAwareEnsurePath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">).</span><span class="na">ensure</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getZookeeperClient</span><span class="o">());</span>
		<span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">setData</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="n">zkPath</span><span class="o">,</span> <span class="n">status</span><span class="o">.</span><span class="na">name</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">ENCODING</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="2-why-you-need-a-kubernetes-based-ha-solution">2. Why you need a Kubernetes-based HA solution</h2>
<p>To some extent, Kubernetes has become the de facto standard for cloud natives. (The de facto standard is whoever uses it more.) Now many big data ecosystems are gradually embracing the Kubernetes ecosystem, such as distributed computing frameworks like Flink and Spark. But Kubernetes clusters use etcd in distributed orchestration, not zk, so the zk-based HA solution mentioned above won&rsquo;t work. So can we build a zk cluster to do HA for Flink? Of course we can, but it is definitely not a good idea for users who have used Kubernetes before to manage a separate zk cluster for Flink&rsquo;s HA.</p>
<p>In this case, the Kubernetes-based Flink HA solution is more important. Some people may ask, &ldquo;Why not etcd-based? Simply, Kubernetes uses etcd, but does not expose the etcd service to users, but uses etcd as its own backend storage for metadata. But using k8s is also an indirect use of etcd.</p>
<h2 id="3-specific-implementation-of-the-program">3. Specific implementation of the program</h2>
<h3 id="1-k8s-based-leader-election">1. k8s-based leader election</h3>
<p>For zk, we implement leader election by creating atomic znode api, similarly for k8s. There is a 2016 blog in the official k8s documentation detailing how to do leader elections with the help of k8s: <a href="https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/">https://kubernetes.io/blog/2016/01/simple-leader-election-with-kubernetes/</a>. Simply put, the atomicity of the k8s API is wrapped into a distributed lock, and all candidates in the election compete for the lock, and the one who gets the lock is the leader.</p>
<p>In the k8s api for client-go, the above lock is called resourcelock, now client-go supports four <a href="https://github.com/kubernetes/client-go/tree/fb61a7c88cb9f599363919a34b7c54a605455ffc/tools/leaderelection/resourcelock">resourceLock</a>:</p>
<ul>
<li>configMapLock: Distributed lock based on the operation extension of the configMap resource</li>
<li>endpointLock: Distributed lock that extends operations based on the endPoint resource</li>
<li>leaseLock: based on lease resource, relatively lightweight leader resource</li>
<li>multiLock: a mix of locks resourceLock is essentially a lock that locks the resources of k8s and then provides a specific method for election. The specific method here is the method defined by the interfact of Lock, which mainly includes the following.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Interface offers a common interface for locking on arbitrary
</span><span class="c1">// resources used in leader election.  The Interface is used
</span><span class="c1">// to hide the details on specific implementations in order to allow
</span><span class="c1">// them to change over time.  This interface is strictly for use
</span><span class="c1">// by the leaderelection code.
</span><span class="c1"></span><span class="n">type</span> <span class="n">Interface</span> <span class="kd">interface</span> <span class="err">{</span>
	<span class="c1">// Get returns the LeaderElectionRecord
</span><span class="c1"></span>	<span class="n">Get</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">)</span> <span class="o">(*</span><span class="n">LeaderElectionRecord</span><span class="o">,</span> <span class="o">[]</span><span class="kt">byte</span><span class="o">,</span> <span class="n">error</span><span class="o">)</span>

	<span class="c1">// Create attempts to create a LeaderElectionRecord
</span><span class="c1"></span>	<span class="n">Create</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">ler</span> <span class="n">LeaderElectionRecord</span><span class="o">)</span> <span class="n">error</span>

	<span class="c1">// Update will update and existing LeaderElectionRecord
</span><span class="c1"></span>	<span class="n">Update</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">ler</span> <span class="n">LeaderElectionRecord</span><span class="o">)</span> <span class="n">error</span>

	<span class="c1">// RecordEvent is used to record events
</span><span class="c1"></span>	<span class="n">RecordEvent</span><span class="o">(</span><span class="n">string</span><span class="o">)</span>

	<span class="c1">// Identity will return the locks Identity
</span><span class="c1"></span>	<span class="n">Identity</span><span class="o">()</span> <span class="n">string</span>

	<span class="c1">// Describe is used to convert details on current resource lock
</span><span class="c1"></span>	<span class="c1">// into a string
</span><span class="c1"></span>	<span class="n">Describe</span><span class="o">()</span> <span class="n">string</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The implementation of resourceLock for a particular resource is actually a resource (configMap, endpoint, release, etc.) that is manipulated by calling the k8s api, for example, the Create implementation of configMapLock is as follows: it tries to create a specific name under a specific namespace configMap under a specific namespace and write the leader information to the annotation. (k8s API object annotation can basically write arbitrary information) When multiple candidates try to create a configMap with the same name under the same namespace at the same time, only one will succeed, and this is the leader.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Create attempts to create a LeaderElectionRecord annotation
</span><span class="c1"></span><span class="n">func</span> <span class="o">(</span><span class="n">cml</span> <span class="o">*</span><span class="n">ConfigMapLock</span><span class="o">)</span> <span class="n">Create</span><span class="o">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">ler</span> <span class="n">LeaderElectionRecord</span><span class="o">)</span> <span class="n">error</span> <span class="o">{</span>
	<span class="n">recordBytes</span><span class="o">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="na">Marshal</span><span class="o">(</span><span class="n">ler</span><span class="o">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="o">}</span>
	<span class="n">cml</span><span class="o">.</span><span class="na">cm</span><span class="o">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cml</span><span class="o">.</span><span class="na">Client</span><span class="o">.</span><span class="na">ConfigMaps</span><span class="o">(</span><span class="n">cml</span><span class="o">.</span><span class="na">ConfigMapMeta</span><span class="o">.</span><span class="na">Namespace</span><span class="o">).</span><span class="na">Create</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="o">.</span><span class="na">ConfigMap</span><span class="o">{</span>
		<span class="n">ObjectMeta</span><span class="o">:</span> <span class="n">metav1</span><span class="o">.</span><span class="na">ObjectMeta</span><span class="o">{</span>
			<span class="n">Name</span><span class="o">:</span>      <span class="n">cml</span><span class="o">.</span><span class="na">ConfigMapMeta</span><span class="o">.</span><span class="na">Name</span><span class="o">,</span>
			<span class="n">Namespace</span><span class="o">:</span> <span class="n">cml</span><span class="o">.</span><span class="na">ConfigMapMeta</span><span class="o">.</span><span class="na">Namespace</span><span class="o">,</span>
			<span class="n">Annotations</span><span class="o">:</span> <span class="n">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="o">{</span>
				<span class="n">LeaderElectionRecordAnnotationKey</span><span class="o">:</span> <span class="n">string</span><span class="o">(</span><span class="n">recordBytes</span><span class="o">),</span>
			<span class="o">},</span>
		<span class="o">},</span>
	<span class="o">},</span> <span class="n">metav1</span><span class="o">.</span><span class="na">CreateOptions</span><span class="o">{})</span>
	<span class="k">return</span> <span class="n">err</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>With the resourceLock package and leaderelection provided by client-go, we can easily implement our own leader election logic. Here is an example using leaseLock, the full code is available at: <a href="https://github.com/kubernetes/client-go/blob/master/examples/leader-election/main.go">https://github.com/kubernetes/client-go/blob/master/examples/leader-election/main.go</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"> <span class="c1">// we use the Lease lock type since edits to Leases are less common
</span><span class="c1">// and fewer objects in the cluster watch &#34;all Leases&#34;.
</span><span class="c1"></span><span class="nx">lock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">resourcelock</span><span class="p">.</span><span class="nx">LeaseLock</span><span class="p">{</span>
	<span class="nx">LeaseMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span>      <span class="nx">leaseLockName</span><span class="p">,</span>
		<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">leaseLockNamespace</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="nx">Client</span><span class="p">:</span> <span class="nx">client</span><span class="p">.</span><span class="nf">CoordinationV1</span><span class="p">(),</span>
	<span class="nx">LockConfig</span><span class="p">:</span> <span class="nx">resourcelock</span><span class="p">.</span><span class="nx">ResourceLockConfig</span><span class="p">{</span>
		<span class="nx">Identity</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// start the leader election code loop
</span><span class="c1"></span><span class="nx">leaderelection</span><span class="p">.</span><span class="nf">RunOrDie</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderElectionConfig</span><span class="p">{</span>
	<span class="nx">Lock</span><span class="p">:</span> <span class="nx">lock</span><span class="p">,</span>
	<span class="c1">// IMPORTANT: you MUST ensure that any code you have that
</span><span class="c1"></span>	<span class="c1">// is protected by the lease must terminate **before**
</span><span class="c1"></span>	<span class="c1">// you call cancel. Otherwise, you could have a background
</span><span class="c1"></span>	<span class="c1">// loop still running and another process could
</span><span class="c1"></span>	<span class="c1">// get elected before your background loop finished, violating
</span><span class="c1"></span>	<span class="c1">// the stated goal of the lease.
</span><span class="c1"></span>	<span class="nx">ReleaseOnCancel</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="nx">LeaseDuration</span><span class="p">:</span>   <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
	<span class="nx">RenewDeadline</span><span class="p">:</span>   <span class="mi">15</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
	<span class="nx">RetryPeriod</span><span class="p">:</span>     <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
	<span class="nx">Callbacks</span><span class="p">:</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">LeaderCallbacks</span><span class="p">{</span>
		<span class="nx">OnStartedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// we&#39;re notified when we start - this is where you would
</span><span class="c1"></span>			<span class="c1">// usually put your code
</span><span class="c1"></span>			<span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="nx">OnStoppedLeading</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="c1">// we can do cleanup here
</span><span class="c1"></span>			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;leader lost: %s&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="nx">OnNewLeader</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">identity</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// we&#39;re notified when new leader elected
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">identity</span> <span class="o">==</span> <span class="nx">id</span> <span class="p">{</span>
				<span class="c1">// I just got the lock
</span><span class="c1"></span>				<span class="k">return</span>
			<span class="p">}</span>
			<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;new leader elected: %s&#34;</span><span class="p">,</span> <span class="nx">identity</span><span class="p">)</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2-implementation-of-flink-ha-on-k8s">2. Implementation of Flink HA on k8s</h3>
<p>The leader election in k8s is described above in client-go, for Java calls we can use the java counterpart to the client SDK: <code>io.kubernetes:client-java-extend</code>. We can see that the code provides three types of resourceLock: configMapLock, endpointLock and leaseLock. Link: <a href="https://github.com/kubernetes-client/java/tree/master/extended/src/main/java/io/kubernetes/client/extended/leaderelection/resourcelock">https://github.com/kubernetes-client/java/tree/master/extended/src/main/java/io/kubernetes/client/extended/leaderelection/resourcelock</a></p>
<p>We use configMapLock internally, which means that we use the annotation of configMap to store the leader information.</p>
<h4 id="1-leaderelectionservice">1. LeaderElectionService</h4>
<p>To implement the Java version of the k8s-based <em><strong>LedaerElectionService</strong></em>, we can refer to the class: <a href="https://github.com/kubernetes-client/java/blob/master/extended/src/main/java/io/kubernetes/client/extended/leaderelection/LeaderElector.java"><em><strong>LeaderElector</strong></em></a> provided in the sdk. <em><strong>LeaderElector</strong></em> provides a run method to run leader elections.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">   * Runs the leader election in foreground.
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">startLeadingHook</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">stopLeadingHook</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">run</span><span class="o">(</span><span class="n">startLeadingHook</span><span class="o">,</span> <span class="n">stopLeadingHook</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
</span><span class="cm">   * Runs the leader election in foreground.
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span>
      <span class="n">Runnable</span> <span class="n">startLeadingHook</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">stopLeadingHook</span><span class="o">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">onNewLeaderHook</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">onNewLeaderHook</span> <span class="o">=</span> <span class="n">onNewLeaderHook</span><span class="o">;</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Start leader election with lock {}&#34;</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getLock</span><span class="o">().</span><span class="na">describe</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">acquire</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// Fail to acquire leadership
</span><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Successfully acquired lease, became leader&#34;</span><span class="o">);</span>
      <span class="c1">// Hook on start leading
</span><span class="c1"></span>      <span class="n">hookWorkers</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">startLeadingHook</span><span class="o">);</span>
      <span class="n">renewLoop</span><span class="o">();</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Failed to renew lease, lose leadership&#34;</span><span class="o">);</span>
      <span class="c1">// Hook on stop leading
</span><span class="c1"></span>      <span class="n">stopLeadingHook</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">stopLeadingHook</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>But this run method is a one-off. In order to implement Flink&rsquo;s <em><strong>LedaerElectionService</strong></em>, we need to write a class to do some auxiliary work, such as</p>
<ul>
<li>Encapsulate <strong>LeaderElector</strong> to run the leader election</li>
<li>Define a daemon process to run the leader election in a loop</li>
<li>Define a Listener interface for callbacks</li>
</ul>
<h4 id="2-leaderretrievalservice">2. <em><strong>LeaderRetrievalService</strong></em></h4>
<p>It is relatively simple to implement <em><strong>LeaderRetrievalService</strong></em> based on k8s, because we store the leader information in the annotation of a specific resource (ConfigMap, Endpoint, Lease) of k8s, so we can directly read the annotation of the corresponding resource. annotation of the corresponding resource. However, we also need to extend a resident process and Listener interface to notify the Listener when the Leader information changes.</p>
<p>The remaining two <em><strong>CheckpointRecoveryFactory</strong></em> and <em><strong>RunningJobsRegistry</strong></em> are similar.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/flink/">flink</a>
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/pulsar-repeat-consume/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Pulsar Repeat Consumption</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/ripgrep/">
            <span class="next-text nav-default">Replace grep with ripgrep</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
