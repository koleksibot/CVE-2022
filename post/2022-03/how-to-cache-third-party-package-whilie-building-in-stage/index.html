<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to cache third-party dependencies in a phased build - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In non-phased build scenarios, when using containers for builds, we can mount the cache directory in the container to the build host to perform the build task; then copy the product to the run image to make the application image. However, in a phased build, the build image and the run image are in the same Dockerfile, which makes it difficult to optimize the cache for third-party dependencies.
1. Create a Vue instance project   Install the Vue CLI" /><meta name="keywords" content="docker, Cache Third Party Package, Building in Stage" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/how-to-cache-third-party-package-whilie-building-in-stage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to cache third-party dependencies in a phased build" />
<meta property="og:description" content="In non-phased build scenarios, when using containers for builds, we can mount the cache directory in the container to the build host to perform the build task; then copy the product to the run image to make the application image. However, in a phased build, the build image and the run image are in the same Dockerfile, which makes it difficult to optimize the cache for third-party dependencies.
1. Create a Vue instance project   Install the Vue CLI" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/how-to-cache-third-party-package-whilie-building-in-stage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-19T11:39:38+08:00" />
<meta property="article:modified_time" content="2022-03-19T11:39:38+08:00" />

<meta itemprop="name" content="How to cache third-party dependencies in a phased build">
<meta itemprop="description" content="In non-phased build scenarios, when using containers for builds, we can mount the cache directory in the container to the build host to perform the build task; then copy the product to the run image to make the application image. However, in a phased build, the build image and the run image are in the same Dockerfile, which makes it difficult to optimize the cache for third-party dependencies.
1. Create a Vue instance project   Install the Vue CLI"><meta itemprop="datePublished" content="2022-03-19T11:39:38+08:00" />
<meta itemprop="dateModified" content="2022-03-19T11:39:38+08:00" />
<meta itemprop="wordCount" content="2016">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to cache third-party dependencies in a phased build"/>
<meta name="twitter:description" content="In non-phased build scenarios, when using containers for builds, we can mount the cache directory in the container to the build host to perform the build task; then copy the product to the run image to make the application image. However, in a phased build, the build image and the run image are in the same Dockerfile, which makes it difficult to optimize the cache for third-party dependencies.
1. Create a Vue instance project   Install the Vue CLI"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to cache third-party dependencies in a phased build</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-19 11:39:38 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2016 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-create-a-vue-instance-project">1. Create a Vue instance project</a></li>
        <li><a href="#2-optimize-with-buildkit-mounted-cache">2. Optimize with Buildkit Mounted Cache</a>
          <ul>
            <li><a href="#21-turning-on-buildkit">2.1 Turning on Buildkit</a></li>
            <li><a href="#22-mounting-the-cache-using-bind">2.2 Mounting the cache using Bind</a></li>
          </ul>
        </li>
        <li><a href="#3-optimization-with-s3-storage-cache">3. Optimization with S3 storage cache</a>
          <ul>
            <li><a href="#31-quickly-deploying-a-minio">3.1 Quickly deploying a minio</a></li>
            <li><a href="#32-configuring-the-secret-key">3.2 Configuring the secret key</a></li>
            <li><a href="#33-adapting-dockerfile-to-s3-cache">3.3 Adapting Dockerfile to S3 cache</a></li>
          </ul>
        </li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In non-phased build scenarios, when using containers for builds, we can mount the cache directory in the container to the build host to perform the build task; then copy the product to the run image to make the application image. However, in a phased build, the build image and the run image are in the same Dockerfile, which makes it difficult to optimize the cache for third-party dependencies.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/19/2cae399fa1ec4c309ab888372c845fa9.png" alt="a phased build"></p>
<h2 id="1-create-a-vue-instance-project">1. Create a Vue instance project</h2>
<ul>
<li>
<p>Install the Vue CLI</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">npm install -g @vue/cli --force
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Initialize the sample project</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">vue create hello-world
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>Using the default configuration, create the sample project: hello-world</p>
<ul>
<li>Run the project</li>
</ul>
<p>At this point, the project already contains all the dependencies and you can run the project directly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">npm run serve
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Remove dependencies</li>
</ul>
<p>Dependency packages are usually not committed to the code repository, so to better simulate the build scenario, here we remove the dependency and build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">rm -rf node_modules
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add the Dockerfile file to the project</li>
</ul>
<p>Go to the project directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">cd</span> hello-world
</code></pre></td></tr></table>
</div>
</div><p>Edit and save the Dockerfile file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="l">vim Dockerfile</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">FROM node:lts-alpine as builder</span><span class="w">
</span><span class="w"></span><span class="l">WORKDIR /</span><span class="w">
</span><span class="w"></span><span class="l">COPY package.json /</span><span class="w">
</span><span class="w"></span><span class="l">RUN npm install</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">COPY . .</span><span class="w">
</span><span class="w"></span><span class="l">RUN npm run build</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">FROM nginx:alpine</span><span class="w">
</span><span class="w"></span><span class="l">COPY --from=builder /dist/ /usr/share/nginx/html/</span><span class="w">
</span><span class="w"></span><span class="l">EXPOSE 80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Build the image</li>
</ul>
<p>Execute the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --no-cache -t shaowenchen/hello-world:v1 -f Dockerfile .

<span class="o">[</span>+<span class="o">]</span> Building 139.2s <span class="o">(</span>13/13<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Dockerfile                                                                                                                        2.6s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 228B                                                                                                                                        0.2s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                                                                                                                                           3.4s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                                                                                                                                             0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/nginx:alpine                                                                                                             4.2s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/node:lts-alpine                                                                                                          4.3s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>builder 1/6<span class="o">]</span> FROM docker.io/library/node:lts-alpine@sha256:2c6c59cf4d34d4f937ddfcf33bab9d8bbad8658d1b9de7b97622566a52167f2b                                     0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                                                                                                                                           1.8s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 5.03kB                                                                                                                                         0.4s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>stage-1 1/2<span class="o">]</span> FROM docker.io/library/nginx:alpine@sha256:da9c94bec1da829ebd52431a84502ec471c8e548ffb2cedbf36260fd9bd1d4d3                                        0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 2/6<span class="o">]</span> COPY package.json /                                                                                                                                       5.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 3/6<span class="o">]</span> RUN npm install                                                                                                                                          93.1s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 4/6<span class="o">]</span> COPY . .                                                                                                                                                  5.9s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 5/6<span class="o">]</span> RUN npm run build                                                                                                                                        13.6s
 <span class="o">=</span>&gt; <span class="o">[</span>stage-1 2/2<span class="o">]</span> COPY --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/                                                                                                         4.0s
 <span class="o">=</span>&gt; exporting to image                                                                                                                                                      4.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                                                                                                                                                     2.3s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:dc0f72b655eb95235b51d8fb30c430c3c1803c2d538d9948941f3e7afd23ab56                                                                                0.2s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/shaowenchen/hello-world:v1            
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Test image</li>
</ul>
<p>Execute the command to create a container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker run --rm -it -p 80:80 shaowenchen/hello-world:v1
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Accessing the service</li>
</ul>
<p>Open locally: <code>http://localhost</code>, you can see the page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/19/6c6deda740ca4985a2ea29bc08541c32.png" alt="vue page"></p>
<h2 id="2-optimize-with-buildkit-mounted-cache">2. Optimize with Buildkit Mounted Cache</h2>
<p>The idea of this approach is to store third-party packages in a separate cache image and mount the files from the cache image to the build environment when building the application image.</p>
<h3 id="21-turning-on-buildkit">2.1 Turning on Buildkit</h3>
<p>Buildkit is turned off by default. There are two ways to turn on Buildkit:</p>
<ul>
<li>The first is to add a buildkit configuration to <code>/etc/docker/daemon.json</code>, <code>{ &quot;features&quot;: { &quot;buildkit&quot;: true }}</code> to turn on buildkit features by default.</li>
<li>The second is to add the environment variable <code>DOCKER_BUILDKIT=1</code> each time you execute the docker command.</li>
</ul>
<h3 id="22-mounting-the-cache-using-bind">2.2 Mounting the cache using Bind</h3>
<ul>
<li>Prepare the Dockerfile for the cached image</li>
</ul>
<p>Create the Dockerfile file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">vim Dockerfile-Cache

FROM node:lts-alpine as builder
WORKDIR /
COPY . .
RUN npm install
RUN npm run build
</code></pre></td></tr></table>
</div>
</div><p>One small detail here is that you need <code>npm run build</code> to compile third-party packages. You can&rsquo;t get good acceleration by just caching third-party packages. Also, pre-compiling reduces CPU and memory consumption.</p>
<ul>
<li>Compile a cached image with third-party packages.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --no-cache -t shaowenchen/hello-world:cache -f Dockerfile-Cache .

<span class="o">[</span>+<span class="o">]</span> Building 111.9s <span class="o">(</span>9/9<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Dockerfile-Cache                                                                                                                  1.8s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 132B                                                                                                                                        0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                                                                                                                                           2.9s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                                                                                                                                             0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/node:lts-alpine                                                                                                          4.2s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                                                                                                                                           1.7s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 4.57kB                                                                                                                                         0.2s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>1/5<span class="o">]</span> FROM docker.io/library/node:lts-alpine@sha256:2c6c59cf4d34d4f937ddfcf33bab9d8bbad8658d1b9de7b97622566a52167f2b                                             0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>2/5<span class="o">]</span> COPY . .                                                                                                                                                          3.6s
 <span class="o">=</span>&gt; <span class="o">[</span>3/5<span class="o">]</span> RUN npm install                                                                                                                                                  69.2s
 <span class="o">=</span>&gt; <span class="o">[</span>4/5<span class="o">]</span> RUN npm run build                                                                                                                                                14.5s
 <span class="o">=</span>&gt; exporting to image                                                                                                                                                     13.9s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                                                                                                                                                    13.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:e6ba7406f5d0c33d446ecc9a3c8e35fa593176ec9dedd899d39a1c00a14a5179                                                                                0.2s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/shaowenchen/hello-world:cache              
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Prepare the build Dockerfile file for the application</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile">vim Dockerfile-Bind<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> node:lts-alpine as builder</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err"></span><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/node_modules,target<span class="o">=</span>/node_modules <span class="se">\
</span><span class="se"></span>--mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/root/.npm,target<span class="o">=</span>/root/.npm npm install<span class="err">
</span><span class="err"></span><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/node_modules,target<span class="o">=</span>/node_modules <span class="se">\
</span><span class="se"></span>--mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/root/.npm,target<span class="o">=</span>/root/.npm npm run build<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> nginx:alpine</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/<span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Each command that uses the cache needs to be preceded by <code>-mount</code>.</p>
<ul>
<li>Compile the application image image</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --no-cache -t shaowenchen/hello-world:v1-bind -f Dockerfile-Bind .

<span class="o">[</span>+<span class="o">]</span> Building 55.3s <span class="o">(</span>13/13<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Dockerfile-Bind                                                                                                                   2.5s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 42B                                                                                                                                         0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                                                                                                                                           3.4s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                                                                                                                                             0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/nginx:alpine                                                                                                             4.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/node:lts-alpine                                                                                                          3.8s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                                                                                                                                           2.4s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 4.47kB                                                                                                                                         0.2s
 <span class="o">=</span>&gt; CACHED FROM docker.io/shaowenchen/hello-world:cache                                                                                                                     0.3s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>stage-1 1/2<span class="o">]</span> FROM docker.io/library/nginx:alpine@sha256:da9c94bec1da829ebd52431a84502ec471c8e548ffb2cedbf36260fd9bd1d4d3                                        0.0s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>builder 1/5<span class="o">]</span> FROM docker.io/library/node:lts-alpine@sha256:2c6c59cf4d34d4f937ddfcf33bab9d8bbad8658d1b9de7b97622566a52167f2b                                     0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 2/5<span class="o">]</span> COPY . .                                                                                                                                                  4.2s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 3/5<span class="o">]</span> RUN --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/node_modules,target<span class="o">=</span>/node_modules --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache  16.8s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 4/5<span class="o">]</span> RUN --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache,source<span class="o">=</span>/node_modules,target<span class="o">=</span>/node_modules --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>bind,from<span class="o">=</span>shaowenchen/hello-world:cache  13.2s
 <span class="o">=</span>&gt; <span class="o">[</span>stage-1 2/2<span class="o">]</span> COPY --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/                                                                                                         3.7s
 <span class="o">=</span>&gt; exporting to image                                                                                                                                                      4.8s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                                                                                                                                                     3.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:de18663c5752a41cd61c23fb2cbbc1ac9c4c79cf5fdbe15ca16e806d0ce18d9d                                                                                0.2s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/shaowenchen/hello-world:v1-bind                
</code></pre></td></tr></table>
</div>
</div><p>As you can see, after adding the cache, the total time to execute install and build drops from over 100 seconds to less than 30 seconds.</p>
<h2 id="3-optimization-with-s3-storage-cache">3. Optimization with S3 storage cache</h2>
<h3 id="31-quickly-deploying-a-minio">3.1 Quickly deploying a minio</h3>
<h3 id="32-configuring-the-secret-key">3.2 Configuring the secret key</h3>
<p>Create the credentials file <code>.s3cfg</code> in the hello-world directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">host_base</span> <span class="o">=</span> 1.1.1.1:9000
<span class="nv">host_bucket</span> <span class="o">=</span> 1.1.1.1:9000
<span class="nv">use_https</span> <span class="o">=</span> False

<span class="nv">access_key</span> <span class="o">=</span>  minio
<span class="nv">secret_key</span> <span class="o">=</span> minio123

<span class="nv">signature_v2</span> <span class="o">=</span> False
</code></pre></td></tr></table>
</div>
</div><h3 id="33-adapting-dockerfile-to-s3-cache">3.3 Adapting Dockerfile to S3 cache</h3>
<p>The main point of work here is:</p>
<ol>
<li>install s3cmd</li>
<li>get and unpack the cache, ignoring errors (first time is empty)</li>
<li>&hellip; install dependencies and build</li>
<li>compress and upload the cache</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile">vim Dockerfile-S3<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> node:lts-alpine as builder</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> BUCKETNAME<span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">BUCKETNAME</span><span class="o">=</span><span class="nv">$BUCKETNAME</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk add python3 <span class="o">&amp;&amp;</span> ln -sf python3 /usr/bin/python <span class="o">&amp;&amp;</span> apk add py3-pip<span class="err">
</span><span class="err"></span><span class="k">RUN</span> wget https://sourceforge.net/projects/s3tools/files/s3cmd/2.2.0/s3cmd-2.2.0.tar.gz <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> mkdir -p /usr/local/s3cmd <span class="o">&amp;&amp;</span> tar -zxf s3cmd-2.2.0.tar.gz -C /usr/local/s3cmd <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> ln -s /usr/local/s3cmd/s3cmd-2.2.0/s3cmd /usr/bin/s3cmd <span class="o">&amp;&amp;</span> pip3 install python-dateutil<span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Get Cache</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> .s3cfg /root/<span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd get s3://<span class="nv">$BUCKETNAME</span>/node_modules.tar.gz <span class="o">&amp;&amp;</span> tar xf node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd get s3://<span class="nv">$BUCKETNAME</span>/npm.tar.gz <span class="o">&amp;&amp;</span> tar xf npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span><span class="err"></span><span class="k">RUN</span> npm install<span class="err">
</span><span class="err"></span><span class="k">RUN</span> npm run build<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Uploda Cache</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd del s3://<span class="nv">$BUCKETNAME</span>/node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd del s3://<span class="nv">$BUCKETNAME</span>/npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> tar cvfz node_modules.tar.gz node_modules<span class="err">
</span><span class="err"></span><span class="k">RUN</span> tar cvfz npm.tar.gz ~/.npm<span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd put node_modules.tar.gz s3://<span class="nv">$BUCKETNAME</span>/<span class="err">
</span><span class="err"></span><span class="k">RUN</span> s3cmd put npm.tar.gz s3://<span class="nv">$BUCKETNAME</span>/<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> nginx:alpine</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/<span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>First time building an application image using S3 cache</li>
</ul>
<p>Before you build, you need to create a Bucket named hello-world in advance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker build --no-cache --build-arg <span class="nv">BUCKETNAME</span><span class="o">=</span><span class="s2">&#34;hello-world&#34;</span> -t shaowenchen/hello-world:v1-s3 -f Dockerfile-S3 .

<span class="o">[</span>+<span class="o">]</span> Building 244.7s <span class="o">(</span>23/23<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Dockerfile-S3                                                                                                                     1.7s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 40B                                                                                                                                         0.1s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                                                                                                                                           2.6s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                                                                                                                                             0.1s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/nginx:alpine                                                                                                             2.6s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/node:lts-alpine                                                                                                          0.0s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>builder  1/16<span class="o">]</span> FROM docker.io/library/node:lts-alpine                                                                                                           0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                                                                                                                                           2.2s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 4.53kB                                                                                                                                         0.1s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>stage-1 1/2<span class="o">]</span> FROM docker.io/library/nginx:alpine@sha256:da9c94bec1da829ebd52431a84502ec471c8e548ffb2cedbf36260fd9bd1d4d3                                        0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  2/16<span class="o">]</span> RUN apk add python3 <span class="o">&amp;&amp;</span> ln -sf python3 /usr/bin/python <span class="o">&amp;&amp;</span> apk add py3-pip                                                                               32.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  3/16<span class="o">]</span> RUN wget https://sourceforge.net/projects/s3tools/files/s3cmd/2.2.0/s3cmd-2.2.0.tar.gz     <span class="o">&amp;&amp;</span> mkdir -p /usr/local/s3cmd <span class="o">&amp;&amp;</span> tar -zxf s3cmd-2.2.0.tar.g  12.8s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  4/16<span class="o">]</span> COPY .s3cfg /root/                                                                                                                                      5.8s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  5/16<span class="o">]</span> RUN s3cmd get s3://hello-world/node_modules.tar.gz <span class="o">&amp;&amp;</span> tar xf node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                              6.7s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  6/16<span class="o">]</span> RUN s3cmd get s3://hello-world/npm.tar.gz <span class="o">&amp;&amp;</span> tar xf npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                                7.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  7/16<span class="o">]</span> COPY . .                                                                                                                                                5.7s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  8/16<span class="o">]</span> RUN npm install                                                                                                                                        71.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  9/16<span class="o">]</span> RUN npm run build                                                                                                                                      14.4s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 10/16<span class="o">]</span> RUN s3cmd del s3://hello-world/node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                                            7.5s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 11/16<span class="o">]</span> RUN s3cmd del s3://hello-world/npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                                                     6.9s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 12/16<span class="o">]</span> RUN tar cvfz node_modules.tar.gz node_modules                                                                                                          11.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 13/16<span class="o">]</span> RUN tar cvfz npm.tar.gz ~/.npm                                                                                                                          9.4s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 14/16<span class="o">]</span> RUN s3cmd put node_modules.tar.gz s3://hello-world/                                                                                                    14.8s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 15/16<span class="o">]</span> RUN s3cmd put npm.tar.gz s3://hello-world/                                                                                                             15.9s
 <span class="o">=</span>&gt; <span class="o">[</span>stage-1 2/2<span class="o">]</span> COPY --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/                                                                                                         4.5s
 <span class="o">=</span>&gt; exporting to image                                                                                                                                                      3.9s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                                                                                                                                                     2.5s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:dceead698b2c5f3980bf17f246078fe967dda2d9b009c30d9fdb0c60263146e5                                                                                0.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/shaowenchen/hello-world:v1-s3                                                              
</code></pre></td></tr></table>
</div>
</div><p>You can see the relevant cache files in the Minio UI.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/19/f06fffdfad074818b3f5e5a71e36a0fa.png" alt="Minio UI"></p>
<ul>
<li>Build the application image again using the S3 cache</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"> docker build --no-cache --build-arg <span class="nv">BUCKETNAME</span><span class="o">=</span><span class="s2">&#34;hello-world&#34;</span> -t shaowenchen/hello-world:v1-s3 -f Dockerfile-S3 .
<span class="o">[</span>+<span class="o">]</span> Building 213.8s <span class="o">(</span>23/23<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Dockerfile-S3                                                                                                                     2.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 40B                                                                                                                                         0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                                                                                                                                           2.7s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                                                                                                                                             0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/nginx:alpine                                                                                                             4.6s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/library/node:lts-alpine                                                                                                          0.0s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>builder  1/16<span class="o">]</span> FROM docker.io/library/node:lts-alpine                                                                                                           0.0s
 <span class="o">=</span>&gt; CACHED <span class="o">[</span>stage-1 1/2<span class="o">]</span> FROM docker.io/library/nginx:alpine@sha256:da9c94bec1da829ebd52431a84502ec471c8e548ffb2cedbf36260fd9bd1d4d3                                        0.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                                                                                                                                           1.9s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 4.53kB                                                                                                                                         0.1s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  2/16<span class="o">]</span> RUN apk add python3 <span class="o">&amp;&amp;</span> ln -sf python3 /usr/bin/python <span class="o">&amp;&amp;</span> apk add py3-pip                                                                               30.9s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  3/16<span class="o">]</span> RUN wget https://sourceforge.net/projects/s3tools/files/s3cmd/2.2.0/s3cmd-2.2.0.tar.gz     <span class="o">&amp;&amp;</span> mkdir -p /usr/local/s3cmd <span class="o">&amp;&amp;</span> tar -zxf s3cmd-2.2.0.tar.g  13.2s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  4/16<span class="o">]</span> COPY .s3cfg /root/                                                                                                                                      5.5s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  5/16<span class="o">]</span> RUN s3cmd get s3://hello-world/node_modules.tar.gz <span class="o">&amp;&amp;</span> tar xf node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                             16.7s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  6/16<span class="o">]</span> RUN s3cmd get s3://hello-world/npm.tar.gz <span class="o">&amp;&amp;</span> tar xf npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                               15.3s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  7/16<span class="o">]</span> COPY . .                                                                                                                                                4.7s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  8/16<span class="o">]</span> RUN npm install                                                                                                                                        18.4s
 <span class="o">=</span>&gt; <span class="o">[</span>builder  9/16<span class="o">]</span> RUN npm run build                                                                                                                                      13.6s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 10/16<span class="o">]</span> RUN s3cmd del s3://hello-world/node_modules.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                                            7.4s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 11/16<span class="o">]</span> RUN s3cmd del s3://hello-world/npm.tar.gz <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>                                                                                                     7.9s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 12/16<span class="o">]</span> RUN tar cvfz node_modules.tar.gz node_modules                                                                                                          10.8s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 13/16<span class="o">]</span> RUN tar cvfz npm.tar.gz ~/.npm                                                                                                                         10.0s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 14/16<span class="o">]</span> RUN s3cmd put node_modules.tar.gz s3://hello-world/                                                                                                    17.9s
 <span class="o">=</span>&gt; <span class="o">[</span>builder 15/16<span class="o">]</span> RUN s3cmd put npm.tar.gz s3://hello-world/                                                                                                             16.3s
 <span class="o">=</span>&gt; <span class="o">[</span>stage-1 2/2<span class="o">]</span> COPY --from<span class="o">=</span>builder /dist/ /usr/share/nginx/html/                                                                                                         5.0s
 <span class="o">=</span>&gt; exporting to image                                                                                                                                                      3.8s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                                                                                                                                                     2.5s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:a9c46eef6073b3ef8e6c4cd33cc1ed11c94dcebdb0883c89283883d9434de331                                                                                0.2s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/shaowenchen/hello-world:v1-s3                                                                                                                    0.2s

</code></pre></td></tr></table>
</div>
</div><p>As you can see, the install and build commands take about 80 seconds, but the S3 cache-related operations take about 50 seconds.</p>
<p>The 80 seconds can be optimized because the network speed limit between the build environment and S3 service is 1.2 MB/S, which causes the pull and push time to be too long, so there is more room for optimization. I think it is more reasonable to be within 30 seconds.</p>
<h2 id="4-summary">4. Summary</h2>
<p>Cache acceleration is a difficult issue for CI products. Users use it in different ways, and all we can do is provide solutions for their scenarios without forcing them to change their usage habits. In my previous CI product, the cache was mounted on the host and accelerated in the build environment, which is not applicable to the phased build scenario. There are two main options here:</p>
<p>The first one is to enable the Buildkit feature to store third-party dependencies in a cache image. The cache image can be updated regularly according to the policy. When building the image, the third-party packages in the cache image are mounted.</p>
<p>The second way is to use S3 to store third-party dependencies and use the s3cmd command to manage the cache at build time.</p>
<p>Neither of these two approaches is very good. The main reason is that they both require changes to the Dockerfile, which is more invasive to the business.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/several-open-source-kubernetes-web-management-tools/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Several open source Kubernetes web-side management tools</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/how-to-migrate-docker-storage-to-new-disk/">
            <span class="next-text nav-default">Migrating Docker storage to a new drive</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
