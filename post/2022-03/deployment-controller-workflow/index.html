<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deployment Controller Workflow - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article is based on reading the source code of Kubernetes v1.16 and describes the workflow of Deployment Controller through flowcharts, but also contains related code for reference.
 In the previous article, &amp;ldquo;How Kubernetes Controller Manager Works&amp;rdquo;, we explained how the Controller Manager manages the Controller, and we know that the Controller only needs to implement the event handler and does not need to care about the upper logic." /><meta name="keywords" content="kubernetes, Controller, Workflow" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/deployment-controller-workflow/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Deployment Controller Workflow" />
<meta property="og:description" content="This article is based on reading the source code of Kubernetes v1.16 and describes the workflow of Deployment Controller through flowcharts, but also contains related code for reference.
 In the previous article, &ldquo;How Kubernetes Controller Manager Works&rdquo;, we explained how the Controller Manager manages the Controller, and we know that the Controller only needs to implement the event handler and does not need to care about the upper logic." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/deployment-controller-workflow/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-10T14:18:10+08:00" />
<meta property="article:modified_time" content="2022-03-10T14:18:10+08:00" />

<meta itemprop="name" content="Deployment Controller Workflow">
<meta itemprop="description" content="This article is based on reading the source code of Kubernetes v1.16 and describes the workflow of Deployment Controller through flowcharts, but also contains related code for reference.
 In the previous article, &ldquo;How Kubernetes Controller Manager Works&rdquo;, we explained how the Controller Manager manages the Controller, and we know that the Controller only needs to implement the event handler and does not need to care about the upper logic."><meta itemprop="datePublished" content="2022-03-10T14:18:10+08:00" />
<meta itemprop="dateModified" content="2022-03-10T14:18:10+08:00" />
<meta itemprop="wordCount" content="2934">
<meta itemprop="keywords" content="kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deployment Controller Workflow"/>
<meta name="twitter:description" content="This article is based on reading the source code of Kubernetes v1.16 and describes the workflow of Deployment Controller through flowcharts, but also contains related code for reference.
 In the previous article, &ldquo;How Kubernetes Controller Manager Works&rdquo;, we explained how the Controller Manager manages the Controller, and we know that the Controller only needs to implement the event handler and does not need to care about the upper logic."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deployment Controller Workflow</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-10 14:18:10 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2934 words </span>
          <span class="more-meta"> 14 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#deployment-and-controller-model">Deployment and controller model</a></li>
        <li><a href="#how-k8s-manages-deployment">How K8s manages Deployment</a></li>
        <li><a href="#deployment-controller">Deployment Controller</a>
          <ul>
            <li><a href="#architecture">Architecture</a></li>
            <li><a href="#workflow">Workflow</a></li>
            <li><a href="#workqueue">workqueue</a></li>
            <li><a href="#the-adoption-and-abandonment-process-of-replicaset">The adoption and abandonment process of replicaSet</a></li>
            <li><a href="#rolloutrecreate">rolloutRecreate</a></li>
            <li><a href="#rolloutrolling">rolloutRolling</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p>This article is based on reading the source code of Kubernetes v1.16 and describes the workflow of Deployment Controller through flowcharts, but also contains related code for reference.</p>
</blockquote>
<p>In the previous article, &ldquo;How Kubernetes Controller Manager Works&rdquo;, we explained how the Controller Manager manages the Controller, and we know that the Controller only needs to implement the event handler and does not need to care about the upper logic. This article is based on that article and describes what the Deployment Controller does when it receives an event from the Informer.</p>
<h2 id="deployment-and-controller-model">Deployment and controller model</h2>
<p>In K8s, pods are the smallest resource unit, and the replica management of pods is implemented through ReplicaSet(RS); deployment is actually based on RS to do higher-level work.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/56bd5ef146b84824a81540b60df734dd.png" alt="Deployment and controller model"></p>
<p>This is the controller model of Kubernetes, where top-level resources extend new capabilities by controlling lower-level resources. deployment does not manage pods directly, but rather controls the replicas of pods by managing rs. deployment implements versioning by controlling rs: each release corresponds to a version, each version has an rs Deployment only needs to ensure that the state of rs is expected in all cases, and rs ensures that the state of the pod is expected in all cases.</p>
<h2 id="how-k8s-manages-deployment">How K8s manages Deployment</h2>
<p>With an understanding of where deployment fits into K8s, let&rsquo;s look at how this resource achieves its desired state.</p>
<p>Kubernetes APIs and controllers are based on horizontal triggering, which facilitates self-healing and periodic orchestration of the system.</p>
<blockquote>
<p>The concept of horizontal triggering comes from hardware interrupts, which can be triggered either horizontally or edge-triggered.</p>
<ul>
<li>Horizontal triggering : The system depends only on the current state. Even if the system misses an event (maybe it hangs due to a fault), when it recovers, it can still respond correctly by looking at the current state of the signal.</li>
<li>Edge triggering : The system depends not only on the current state, but also on the past state. If the system misses an event (&ldquo;edge&rdquo;), it must look at that event again to recover the system.</li>
</ul>
</blockquote>
<p>The Kubernetes horizontal triggering API is implemented in such a way that the controller monitors the actual state of the resource object, compares it to the desired state of the object, and then adjusts the actual state to match the desired state.</p>
<p>The horizontally triggered API is also called the declarative API, and the controller that monitors the deployment resource object and determines that it meets expectations is the deployment controller, and the corresponding controller for rs is the rs controller.</p>
<h2 id="deployment-controller">Deployment Controller</h2>
<h3 id="architecture">Architecture</h3>
<p>First look at the definition of <code>DeploymentController</code> in K8s.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">DeploymentController</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">rsControl</span>     <span class="nx">controller</span><span class="p">.</span><span class="nx">RSControlInterface</span>
	<span class="nx">client</span>        <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span>
	<span class="nx">eventRecorder</span> <span class="nx">record</span><span class="p">.</span><span class="nx">EventRecorder</span>

	<span class="nx">syncHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">dKey</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
	<span class="nx">enqueueDeployment</span> <span class="kd">func</span><span class="p">(</span><span class="nx">deployment</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span>

	<span class="nx">dLister</span> <span class="nx">appslisters</span><span class="p">.</span><span class="nx">DeploymentLister</span>
	<span class="nx">rsLister</span> <span class="nx">appslisters</span><span class="p">.</span><span class="nx">ReplicaSetLister</span>
	<span class="nx">podLister</span> <span class="nx">corelisters</span><span class="p">.</span><span class="nx">PodLister</span>

	<span class="nx">dListerSynced</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span>
	<span class="nx">rsListerSynced</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span>
	<span class="nx">podListerSynced</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span>

	<span class="nx">queue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There are several main components.</p>
<ul>
<li><code>rsControl</code> is a <code>ReplicaSet Controller</code> tool for claiming and discarding rs.</li>
<li><code>client</code> is the client that communicates with the APIServer.</li>
<li><code>eventRecorder</code> is used to record events.</li>
<li><code>syncHandler</code> is used to handle the synchronization of the deployment.</li>
<li><code>enqueueDeployment</code> is a method that puts the deployment into a queue.</li>
<li><code>dLister</code>, <code>rsLister</code>, and <code>podLister</code> are methods for fetching resources from the <code>shared informer store</code>, respectively.</li>
<li><code>dListerSynced</code>, <code>rsListerSynced</code>, and <code>podListerSynced</code> are used to identify whether or not a resource has been synchronized in the <code>shared informer store</code>, respectively.</li>
<li>The <code>queue</code> is the workqueue. When the deployment, replicaSet, and pod change, the corresponding deployment will be pushed into this queue, and the <code>syncHandler()</code> method will handle the deployment from the workqueue uniformly.</li>
</ul>
<h3 id="workflow">Workflow</h3>
<p>Next, look at the workflow of the deployment controller.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/250752141dea4594827e7c872380a0c9.png" alt="workflow of the deployment controller"></p>
<p>The deployment controller takes advantage of the informer&rsquo;s ability to listen to resources and work with other controllers. There are three shared informers &ndash; deployment informer, rs informer, and pod informer.</p>
<p>First, the deployment controller registers hook functions with the three shared informers, and the three hook functions will push the relevant deployment into the workqueue when the corresponding event comes.</p>
<p>When the deployment controller starts, a worker controls the syncHandler function to push out the items in the workqueue in real time and perform tasks based on the items. The main tasks include: adopting and discarding rs, distributing events to eventRecorder, and deciding how to handle subordinate resources based on the escalation policy.</p>
<h3 id="workqueue">workqueue</h3>
<p>First of all, let&rsquo;s take a look at workqueue, which is actually a queue used to assist informer in distributing events. The whole process can be sorted out in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/4b41279997874ce29a0941f43ec46dd9.png" alt="workqueue"></p>
<p>As you can see, the workqueue is divided into three parts, one is a first-in-first-out queue, which is implemented by slicing, and two are maps called dirty and processing. the whole workflow is divided into three actions, add, get, and done.</p>
<p>add is to push the message into the queue. The message comes from the informer, in fact, the message is not the whole event, but the resource key, that is, namespace/name, in this form to inform the business logic that a resource change event has come, you need to take this key to get the specific resources in the indexer. As the process shown in green above, after the message is carried out, first check whether it exists in dirty, if it already exists, do not do any processing, indicating that the event is already in the queue, do not need to repeat the process; if it does not exist in dirty, the key will be stored in dirty (as the key of the map, the value of the empty structure), and then pushed into the queue a copy.</p>
<p>get is the process of getting the key from the queue by the handle function. When the key is popped out of the queue, it is put into processing and its index in dirty is removed. The reason for this step is that putting the item in processing marks it as being processed, and removing it from dirty does not affect the events that will be added to the queue later.</p>
<p>done is the step the handle must perform after processing the key, which is equivalent to sending an ack to the workqueue that I have finished processing and the action will just remove it from the processing.</p>
<p>With this small and beautiful first-in-first-out queue, we can avoid duplicate fetching of resources from the indexer when multiple events occur. Let&rsquo;s go through the deployment controller process.</p>
<h3 id="the-adoption-and-abandonment-process-of-replicaset">The adoption and abandonment process of replicaSet</h3>
<p>In the workflow of deployment controller, you can notice that in addition to the three hook functions of deployment, there are also hook functions of rs and pods. Among the three hook functions of rs, the process of adoption and abandonment of rs by deployment is involved.</p>
<h4 id="rs-adoption">rs adoption</h4>
<p>First, let&rsquo;s look at the adoption process of rs.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/81ed6c05c7e945f8b1d81f67f04c1164.png" alt="adoption process of rs"></p>
<p>In all three hook functions of rs, the process of recognition is involved.</p>
<p>When listening to the change of rs, it will find the corresponding deployment into the queue according to the ownerReferences field of the rs; if the field is empty, it means it is an orphan rs and starts the rs recognition mechanism.</p>
<p>The first step is to iterate through all the deployments, determine whether the selector of the deployment matches the labels of the current rs, and find all the deployments that match it.</p>
<p>Then determine how many deployments there are in total, if there are 0, return directly, no one is willing to adopt, do nothing, the adoption process is finished; if there are more than 1, throw the error out, because this is abnormal behavior, do not allow multiple deployments to have the same rs at the same time; if there is and only one deployment matches, then find the deployment that is willing to adopt, put it into queue.</p>
<p>The adoption process of <code>addReplicaSet()</code> and <code>updateReplicaSet()</code> is similar, so only the code of <code>addReplicaSet()</code> is shown here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="o">*</span><span class="nx">DeploymentController</span><span class="p">)</span> <span class="nf">addReplicaSet</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">rs</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">dc</span><span class="p">.</span><span class="nf">deleteReplicaSet</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">controllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">GetControllerOf</span><span class="p">(</span><span class="nx">rs</span><span class="p">);</span> <span class="nx">controllerRef</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">d</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">resolveControllerRef</span><span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">controllerRef</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">d</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;ReplicaSet %s added.&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="nx">dc</span><span class="p">.</span><span class="nf">enqueueDeployment</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">ds</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">getDeploymentsForReplicaSet</span><span class="p">(</span><span class="nx">rs</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Orphan ReplicaSet %s added.&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ds</span> <span class="p">{</span>
		<span class="nx">dc</span><span class="p">.</span><span class="nf">enqueueDeployment</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="deployment-adoption-and-abandonment">deployment adoption and abandonment</h4>
<p>The process of adoption and abandonment of rs by a deployment is the process of processing items from the workqueue and finding all rs owned by the current deployment.</p>
<p>This process will poll all rs, and if there is an owner and it is the current deployment, then determine whether the label satisfies the deployment&rsquo;s selector, and include the result if it does; if it does not, start the abandonment mechanism, and just delete the ownerReferences of the rs, making it an orphan and do nothing else. This is the reason why there is one more rs with replicas!=0 after the deployment selector is modified.</p>
<p>If rs has no owner and is an orphan, determine whether the label satisfies the deployment&rsquo;s selector, and if it does, start the adoption mechanism, set its ownerReferences to the current deployment, and then include the result.</p>
<p>The following is the source code of the whole process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">BaseControllerRefManager</span><span class="p">)</span> <span class="nf">ClaimObject</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">match</span> <span class="kd">func</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">adopt</span><span class="p">,</span> <span class="nx">release</span> <span class="kd">func</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">controllerRef</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">GetControllerOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">controllerRef</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">controllerRef</span><span class="p">.</span><span class="nx">UID</span> <span class="o">!=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetUID</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nf">match</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">release</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nf">match</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nf">GetDeletionTimestamp</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">adopt</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Functions of adoption and abandonment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ReplicaSetControllerRefManager</span><span class="p">)</span> <span class="nf">AdoptReplicaSet</span><span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">CanAdopt</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;can&#39;t adopt ReplicaSet %v/%v (%v): %v&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">addControllerPatch</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
		<span class="s">`{&#34;metadata&#34;:{&#34;ownerReferences&#34;:[{&#34;apiVersion&#34;:&#34;%s&#34;,&#34;kind&#34;:&#34;%s&#34;,&#34;name&#34;:&#34;%s&#34;,&#34;uid&#34;:&#34;%s&#34;,&#34;controller&#34;:true,&#34;blockOwnerDeletion&#34;:true}],&#34;uid&#34;:&#34;%s&#34;}}`</span><span class="p">,</span>
		<span class="nx">m</span><span class="p">.</span><span class="nx">controllerKind</span><span class="p">.</span><span class="nf">GroupVersion</span><span class="p">(),</span> <span class="nx">m</span><span class="p">.</span><span class="nx">controllerKind</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span>
		<span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetUID</span><span class="p">(),</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">rsControl</span><span class="p">.</span><span class="nf">PatchReplicaSet</span><span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">addControllerPatch</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ReplicaSetControllerRefManager</span><span class="p">)</span> <span class="nf">ReleaseReplicaSet</span><span class="p">(</span><span class="nx">replicaSet</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;patching ReplicaSet %s_%s to remove its controllerRef to %s/%s:%s&#34;</span><span class="p">,</span>
		<span class="nx">replicaSet</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">replicaSet</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">controllerKind</span><span class="p">.</span><span class="nf">GroupVersion</span><span class="p">(),</span> <span class="nx">m</span><span class="p">.</span><span class="nx">controllerKind</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetName</span><span class="p">())</span>
	<span class="nx">deleteOwnerRefPatch</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`{&#34;metadata&#34;:{&#34;ownerReferences&#34;:[{&#34;$patch&#34;:&#34;delete&#34;,&#34;uid&#34;:&#34;%s&#34;}],&#34;uid&#34;:&#34;%s&#34;}}`</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nf">GetUID</span><span class="p">(),</span> <span class="nx">replicaSet</span><span class="p">.</span><span class="nx">UID</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">rsControl</span><span class="p">.</span><span class="nf">PatchReplicaSet</span><span class="p">(</span><span class="nx">replicaSet</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">replicaSet</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">deleteOwnerRefPatch</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsInvalid</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rolloutrecreate">rolloutRecreate</h3>
<p>If the deployment&rsquo;s update policy is Recreate, the process is to delete the old pod and start a new one, as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/d5449fb58c334d3c8e6d4cab6a7997ee.png" alt="rolloutRecreate process"></p>
<p>First, according to the adoption and abandonment process of rs in the previous step, get all the rs of the current deployment, sort them to find the latest rs, compare their pod template with the pod template of the deployment, and create new rs if they do not match.</p>
<p>The process of creating new rs is: calculate the hash value of the pod template of the current deployment and add it to the rs label and selector.</p>
<p>Calculate the maximum revision of all the old rs, add it by one and use it as the revision of the new rs, and set the following annotation for the new rs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">&#34;deployment.kubernetes.io/revision&#34;
&#34;deployment.kubernetes.io/desired-replicas&#34;
&#34;deployment.kubernetes.io/max-replicas&#34;
</code></pre></td></tr></table>
</div>
</div><p>set the revision of the current deployment to the latest if it is not up to date, and update its status if it needs to be updated.</p>
<p>Downgrade the old rs, i.e. set the number of copies to 0.</p>
<p>Determine whether all the old pods are currently stopped. The condition is that the pod state is failed or succeed, unknown or all other states are not stopped; if not all the pods are stopped, exit this operation and process again in the next loop.</p>
<p>If all pods are stopped, upgrade the new rs, i.e., set its copy number to the number of copies of the deployment.</p>
<p>Finally, cleanup work is done, such as deleting excess rs when the number of old rs is too high.</p>
<p>Here is the source code of rolloutRecreate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="o">*</span><span class="nx">DeploymentController</span><span class="p">)</span> <span class="nf">rolloutRecreate</span><span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="nx">rsList</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">,</span> <span class="nx">podMap</span> <span class="kd">map</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">UID</span><span class="p">][]</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">newRS</span><span class="p">,</span> <span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">getAllReplicaSetsAndSyncRevision</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">rsList</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">allRSs</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">newRS</span><span class="p">)</span>
	<span class="nx">activeOldRSs</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">FilterActiveReplicaSets</span><span class="p">(</span><span class="nx">oldRSs</span><span class="p">)</span>

	<span class="nx">scaledDown</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">scaleDownOldReplicaSetsForRecreate</span><span class="p">(</span><span class="nx">activeOldRSs</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">scaledDown</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncRolloutStatus</span><span class="p">(</span><span class="nx">allRSs</span><span class="p">,</span> <span class="nx">newRS</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nf">oldPodsRunning</span><span class="p">(</span><span class="nx">newRS</span><span class="p">,</span> <span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">podMap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncRolloutStatus</span><span class="p">(</span><span class="nx">allRSs</span><span class="p">,</span> <span class="nx">newRS</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">newRS</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">newRS</span><span class="p">,</span> <span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">getAllReplicaSetsAndSyncRevision</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">rsList</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">allRSs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">newRS</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">scaleUpNewReplicaSetForRecreate</span><span class="p">(</span><span class="nx">newRS</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">util</span><span class="p">.</span><span class="nf">DeploymentComplete</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">cleanupDeployment</span><span class="p">(</span><span class="nx">oldRSs</span><span class="p">,</span> <span class="nx">d</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">syncRolloutStatus</span><span class="p">(</span><span class="nx">allRSs</span><span class="p">,</span> <span class="nx">newRS</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rolloutrolling">rolloutRolling</h3>
<p>If the update policy of the deployment is Recreate, the process is to delete the old pod and start a new one as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/10/cfc13b9a69d147c69207bb1d5009d877.png" alt="rolloutRolling"></p>
<p>As you can see from the above diagram, the process from start to creation of new rs is the same as the rolloutRecreate process, the only difference is the process of setting the number of copies of new rs. In the rolloutRolling process, the number of copies of the new rs is <code>deploy.replicas + maxSurge - currentPodCount</code>. The code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewRSNewReplicas</span><span class="p">(</span><span class="nx">deployment</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="nx">allRSs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">,</span> <span class="nx">newRS</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">)</span> <span class="p">(</span><span class="kt">int32</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">RollingUpdateDeploymentStrategyType</span><span class="p">:</span>
		<span class="c1">// Check if we can scale up.
</span><span class="c1"></span>		<span class="nx">maxSurge</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">intstrutil</span><span class="p">.</span><span class="nf">GetValueFromIntOrPercent</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">RollingUpdate</span><span class="p">.</span><span class="nx">MaxSurge</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)),</span> <span class="kc">true</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="c1">// Find the total number of pods
</span><span class="c1"></span>		<span class="nx">currentPodCount</span> <span class="o">:=</span> <span class="nf">GetReplicaCountForReplicaSets</span><span class="p">(</span><span class="nx">allRSs</span><span class="p">)</span>
		<span class="nx">maxTotalPods</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">maxSurge</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">currentPodCount</span> <span class="o">&gt;=</span> <span class="nx">maxTotalPods</span> <span class="p">{</span>
			<span class="c1">// Cannot scale up.
</span><span class="c1"></span>			<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="nx">newRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">),</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="c1">// Scale up.
</span><span class="c1"></span>		<span class="nx">scaleUpCount</span> <span class="o">:=</span> <span class="nx">maxTotalPods</span> <span class="o">-</span> <span class="nx">currentPodCount</span>
		<span class="c1">// Do not exceed the number of desired replicas.
</span><span class="c1"></span>		<span class="nx">scaleUpCount</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">integer</span><span class="p">.</span><span class="nf">IntMin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">scaleUpCount</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span><span class="o">-*</span><span class="p">(</span><span class="nx">newRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="nx">newRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="o">+</span> <span class="nx">scaleUpCount</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">RecreateDeploymentStrategyType</span><span class="p">:</span>
		<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">),</span> <span class="kc">nil</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;deployment type %v isn&#39;t supported&#34;</span><span class="p">,</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then it comes to the process of increasing and decreasing the number of copies of old and new rs. The process of scale up new rs is the same as above; the process of scale down old rs is to calculate a maximum number of scale down copies first, and if it is less than 0, no operation is done; then an optimization is done in the time of scale down, first scale down unhealthy rs; finally, if there is still a balance, then scale down normal rs. This ensures that the unhealthy copies are removed first; finally, if there is still a balance, the normal rs are scaled down again.</p>
<p>The number of copies for each scale down is <code>allAvailablePodCount - minAvailable</code>, i.e. <code>allAvailablePodCount - (deploy.replicas - maxUnavailable)</code>. The code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">dc</span> <span class="o">*</span><span class="nx">DeploymentController</span><span class="p">)</span> <span class="nf">scaleDownOldReplicaSetsForRollingUpdate</span><span class="p">(</span><span class="nx">allRSs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">,</span> <span class="nx">oldRSs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">ReplicaSet</span><span class="p">,</span> <span class="nx">deployment</span> <span class="o">*</span><span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span> <span class="p">(</span><span class="kt">int32</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">maxUnavailable</span> <span class="o">:=</span> <span class="nx">deploymentutil</span><span class="p">.</span><span class="nf">MaxUnavailable</span><span class="p">(</span><span class="o">*</span><span class="nx">deployment</span><span class="p">)</span>

	<span class="c1">// Check if we can scale down.
</span><span class="c1"></span>	<span class="nx">minAvailable</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="o">-</span> <span class="nx">maxUnavailable</span>
	<span class="c1">// Find the number of available pods.
</span><span class="c1"></span>	<span class="nx">availablePodCount</span> <span class="o">:=</span> <span class="nx">deploymentutil</span><span class="p">.</span><span class="nf">GetAvailableReplicaCountForReplicaSets</span><span class="p">(</span><span class="nx">allRSs</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">availablePodCount</span> <span class="o">&lt;=</span> <span class="nx">minAvailable</span> <span class="p">{</span>
		<span class="c1">// Cannot scale down.
</span><span class="c1"></span>		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Found %d available pods in deployment %s, scaling down old RSes&#34;</span><span class="p">,</span> <span class="nx">availablePodCount</span><span class="p">,</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>

	<span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nf">ReplicaSetsByCreationTimestamp</span><span class="p">(</span><span class="nx">oldRSs</span><span class="p">))</span>

	<span class="nx">totalScaledDown</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="nx">totalScaleDownCount</span> <span class="o">:=</span> <span class="nx">availablePodCount</span> <span class="o">-</span> <span class="nx">minAvailable</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">targetRS</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">oldRSs</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">totalScaledDown</span> <span class="o">&gt;=</span> <span class="nx">totalScaleDownCount</span> <span class="p">{</span>
			<span class="c1">// No further scaling required.
</span><span class="c1"></span>			<span class="k">break</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="o">*</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="c1">// cannot scale down this ReplicaSet.
</span><span class="c1"></span>			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="c1">// Scale down.
</span><span class="c1"></span>		<span class="nx">scaleDownCount</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">integer</span><span class="p">.</span><span class="nf">IntMin</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nx">totalScaleDownCount</span><span class="o">-</span><span class="nx">totalScaledDown</span><span class="p">)))</span>
		<span class="nx">newReplicasCount</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scaleDownCount</span>
		<span class="k">if</span> <span class="nx">newReplicasCount</span> <span class="p">&gt;</span> <span class="o">*</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;when scaling down old RS, got invalid request to scale down %s/%s %d -&gt; %d&#34;</span><span class="p">,</span> <span class="nx">targetRS</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">targetRS</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">),</span> <span class="nx">newReplicasCount</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dc</span><span class="p">.</span><span class="nf">scaleReplicaSetAndRecordEvent</span><span class="p">(</span><span class="nx">targetRS</span><span class="p">,</span> <span class="nx">newReplicasCount</span><span class="p">,</span> <span class="nx">deployment</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">totalScaledDown</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="nx">totalScaledDown</span> <span class="o">+=</span> <span class="nx">scaleDownCount</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">totalScaledDown</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>Because Kubernetes uses a declarative API, all a Controller does is calculate an expected state based on current events, determine whether the actual state meets the expected state, and if not, take action to bring it closer.</p>
<p>In this article, we analyze the workflow of Deployment Controller, and although it is tedious, what it does is centered around the goal of &ldquo;converging to the expected&rdquo;.</p>
<p>I hope these two articles have given you a glimpse into the general workflow and implementation of Kubernetes Controller Manager.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/golang-concurrency-programming-tips/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Golang Common Concurrency Programming Tips</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/how-kubernetes-controller-manager-works/">
            <span class="next-text nav-default">How Kubernetes Controller Manager works</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
