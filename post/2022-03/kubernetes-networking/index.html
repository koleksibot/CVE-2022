<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Getting Started with Kubernetes - Networking Explained - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Service is the core concept of the k8s networking part, and in k8s, Service is mainly responsible for four layers of load balancing. This article explains the network-related principles of k8s in terms of load balancing, extranet access, DNS service construction, and the Ingress seven-layer routing mechanism. Service Explained Service is the main mechanism used to implement the application to provide services to the outside world. As shown in the" /><meta name="keywords" content="kubernetes, Networking" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/kubernetes-networking/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Getting Started with Kubernetes - Networking Explained" />
<meta property="og:description" content="Service is the core concept of the k8s networking part, and in k8s, Service is mainly responsible for four layers of load balancing. This article explains the network-related principles of k8s in terms of load balancing, extranet access, DNS service construction, and the Ingress seven-layer routing mechanism. Service Explained Service is the main mechanism used to implement the application to provide services to the outside world. As shown in the" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/kubernetes-networking/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-11T14:22:04+08:00" />
<meta property="article:modified_time" content="2022-03-11T14:22:04+08:00" />

<meta itemprop="name" content="Getting Started with Kubernetes - Networking Explained">
<meta itemprop="description" content="Service is the core concept of the k8s networking part, and in k8s, Service is mainly responsible for four layers of load balancing. This article explains the network-related principles of k8s in terms of load balancing, extranet access, DNS service construction, and the Ingress seven-layer routing mechanism. Service Explained Service is the main mechanism used to implement the application to provide services to the outside world. As shown in the"><meta itemprop="datePublished" content="2022-03-11T14:22:04+08:00" />
<meta itemprop="dateModified" content="2022-03-11T14:22:04+08:00" />
<meta itemprop="wordCount" content="1614">
<meta itemprop="keywords" content="kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting Started with Kubernetes - Networking Explained"/>
<meta name="twitter:description" content="Service is the core concept of the k8s networking part, and in k8s, Service is mainly responsible for four layers of load balancing. This article explains the network-related principles of k8s in terms of load balancing, extranet access, DNS service construction, and the Ingress seven-layer routing mechanism. Service Explained Service is the main mechanism used to implement the application to provide services to the outside world. As shown in the"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Getting Started with Kubernetes - Networking Explained</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-11 14:22:04 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1614 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#service-explained">Service Explained</a>
          <ul>
            <li><a href="#service-creation">Service creation</a></li>
            <li><a href="#load-distribution-policies">Load Distribution Policies</a></li>
          </ul>
        </li>
        <li><a href="#extranet-access">Extranet access</a>
          <ul>
            <li><a href="#extranet-access-to-pod">Extranet access to Pod</a></li>
            <li><a href="#extranet-access-service">Extranet Access Service</a></li>
          </ul>
        </li>
        <li><a href="#dns-build">DNS build</a>
          <ul>
            <li><a href="#dns-provided-by-k8s">DNS provided by k8s</a></li>
            <li><a href="#how-dns-works">How DNS works</a></li>
          </ul>
        </li>
        <li><a href="#ingress">Ingress</a>
          <ul>
            <li><a href="#ingress-controller">Ingress Controller</a></li>
            <li><a href="#defining-ingress">Defining Ingress</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Service is the core concept of the k8s networking part, and in k8s, Service is mainly responsible for four layers of load balancing. This article explains the network-related principles of k8s in terms of load balancing, extranet access, DNS service construction, and the Ingress seven-layer routing mechanism.</p>
<h2 id="service-explained">Service Explained</h2>
<p>Service is the main mechanism used to implement the application to provide services to the outside world.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/11/7fcabd4a8d714b31bfbe15cb11798adc.png" alt="k8s service"></p>
<p>As shown in the figure above, Service is a layer of abstraction for Pod, mainly through TCP/IP mechanism and listening IP and port number to provide services to the outside world. Unlike Pods, once a Service is created, the system distributes a ClusterIP for it (or you can specify it yourself), and it will not change during its lifetime.</p>
<h3 id="service-creation">Service creation</h3>
<h4 id="command-line-quick-creation">Command Line Quick Creation</h4>
<p>After creating an RC, you can quickly create a corresponding Service by using the command line <code>kubectl expose</code>. For example, there is now an rc named hdls.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl expose rc hdls
</code></pre></td></tr></table>
</div>
</div><p>The ClusterIP of a Service created in this way is automatically assigned to it, and the port number of the Service is copied from the containerPort in the Pod.</p>
<h4 id="created-via-yaml">created via YAML</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">   </span><span class="c"># Service 的虚拟端口</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">  </span><span class="c"># 指定后端 Pod 的端口号</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">  </span><span class="c"># Label 选择器</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Once the YAML file is defined, it can be created with the command <code>kubectl create -f &lt;service.yml&gt;</code>. The Service definition requires the following key fields to be specified.</p>
<ul>
<li>ports
<ul>
<li>port: the virtual port of the Service.</li>
<li>targetPort: The port number of the backend Pod, if not filled in, it will be the same as the Service&rsquo;s port by default.</li>
</ul>
</li>
<li>selector: Label selector, specifying the Label owned by the backend Pod.</li>
</ul>
<h3 id="load-distribution-policies">Load Distribution Policies</h3>
<p>k8s provides two load distribution strategies.</p>
<ul>
<li>RoundRobin: Polling method. That is, polling to forward requests to each Pod on the backend.</li>
<li>SessionAffinity: Session holding mode based on client IP address. That is, requests from clients with the same IP address are forwarded to the same Pod.</li>
</ul>
<p>By default, k8s uses polling mode for routing. However, we can also enable SessionAffinity mode by setting &ldquo;service.spec.SessionAffinity&rdquo; to ClusterIP.</p>
<h4 id="some-special-cases">Some special cases</h4>
<p><strong>Headless Service.</strong></p>
<p>In this case, k8s is implemented through the concept of Headless Service, where the Service is not given a ClusterIP (no ingress IP) and only the list of back-end Pods is returned to the calling client via Label Selector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">   
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w"> 
</span><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The Service does not have a virtual ClusterIP and access to it can get a list of all Pods with <code>app=hdls</code>, the client needs to implement its own responsible balancing policy and then determine which Pod to access.</p>
<p><strong>No LabelSelector Service.</strong></p>
<p>Typically, applications need to connect to an external database as a backend service, or a service in another cluster or namespace as a backend service. In these cases, this can be achieved by creating a Service without Label Selector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">   
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w"> 
</span></code></pre></td></tr></table>
</div>
</div><p>The Service does not have a tag selector, i.e., it cannot select a backend Pod; in this case, the Endpoint is not created automatically, and an Endpoint with the same name as the Service needs to be created manually to point to the actual backend access address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls </span><span class="w"> </span><span class="c"># 与 Service 同名</span><span class="w">
</span><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">addresss</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">IP</span><span class="p">:</span><span class="w"> </span><span class="m">1.2.3.4</span><span class="w">   </span><span class="c"># 用户指定的 IP </span><span class="w">
</span><span class="w">   </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In this case, the Endpoint is created as in the YAML above, and accessing the Service without Label Selector routes the request to the user-specified Endpoint.</p>
<p><strong>Multi-Port Service.</strong>.</p>
<p>Define multiple ports in service.spec.ports, including the name and protocol of the specified port.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dns</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">   
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dns-tcp</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> 
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="extranet-access">Extranet access</h2>
<p>Pods and Services are virtual concepts inside the k8s cluster, so they are not accessible to clients outside the cluster. However, under some special conditions, we need to have external access to Pod or Service, then we need to map the port number of Pod or Service to the host, so that clients can access the container application through the physical machine.</p>
<h3 id="extranet-access-to-pod">Extranet access to Pod</h3>
<p>Map the port number of the container application to the physical machine. There are two ways to do this, as follows.</p>
<h4 id="set-the-container-level-hostport">Set the container level hostPort</h4>
<p>This kind is to map the port number of the container application to the physical machine. The settings are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-pod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-container</span><span class="w">
</span><span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="cp">***</span><span class="w">
</span><span class="w">   </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span><span class="w">     </span><span class="nt">hostPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="set-pod-level-hostnetworktrue">Set Pod level hostNetwork=true</h4>
<p>This maps all container port numbers in that Pod directly to the physical machine. Note that in the container ports definition section, if hostPort is not specified, the default hostPort=containerPort, and if hostPort is set, hostPort must be equal to containerPort. set as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-pod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-container</span><span class="w">
</span><span class="w">   </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="cp">***</span><span class="w">
</span><span class="w">   </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="extranet-access-service">Extranet Access Service</h3>
<p>There are also two ways to do this.</p>
<h4 id="set-nodeport-mapping-to-physical-machine">Set nodePort mapping to physical machine</h4>
<p>First you need to set the nodePort mapping to the physical machine, and you need to set the Service type to NodePort.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort </span><span class="w"> </span><span class="c"># 指定类型为 NodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> 
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w"> 
</span><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">   </span><span class="c"># 指定 nodePort</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> 
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="set-up-loadbalancer-mapping-to-the-loadbalancer-address-provided-by-the-cloud-service-provider">Set up LoadBalancer mapping to the LoadBalancer address provided by the cloud service provider</h4>
<p>This usage is only used in scenarios where the service is set up on the cloud platform of the public cloud service provider. The service.status.loadBalancer.address.ip needs to be set to the IP of the load balancer provided by the cloud service provider. The load balancing implementation depends on the implementation mechanism of the LoadBalancer provided by the cloud provider.</p>
<h2 id="dns-build">DNS build</h2>
<p>To enable mutual access to services within the cluster by service name, a virtual DNS service needs to be created to resolve the service name to the ClusterIP.</p>
<h3 id="dns-provided-by-k8s">DNS provided by k8s</h3>
<p>The DNS service provided by k8s is called skydns and consists of the following four components.</p>
<ul>
<li>etcd: DNS storage.</li>
<li>kube2sky: registers the Service in k8s Master to etcd; * kube2sky: registers the Service in k8s Master to etcd.</li>
<li>skyDNS: DNS domain name resolution service.</li>
<li>healthz: health check for skyDNS.</li>
</ul>
<p>The skyDNS service consists of an RC and a Service. In the configuration file of the RC, four containers, etcd / kube2sky / skydns / healthz, need to be defined to ensure that the DNS service works properly. It is important to note that:</p>
<ol>
<li>the kube2sky container needs to access the k8s Master, so you need to configure the IP address and port of the physical host where the Master is located in the configuration file for it.</li>
<li>you need to set the startup parameter <code>--domain</code> of kube2sky and skydns containers to the domain name of the Service in the k8s cluster. After the container is started, kube2sky will monitor the definition of all services in the cluster through API Server, generate the corresponding records and save them to etcd; 3.
The skydns startup parameter <code>-addr=&lt;IP:Port&gt;</code> indicates that the local TCP and UDP port provides services.</li>
</ol>
<p>In the DNS Service configuration file, we need to specify the ClusterIP of skydns, which will be used by each Node kubelet and will not be automatically assigned by the system; in addition, this IP needs to be in the kube-apiserver startup parameter <code>-service-cluster-ip-range</code>.</p>
<p>Before the skydns container is created, you need to modify the kubelet startup parameters on each Node: * &ndash;cluster_dns</p>
<ul>
<li><code>--cluster_dns=&lt;dns_cluster_ip&gt;</code>, dns_cluster_ip is the ClusterIP of the DNS service.</li>
<li><code>--cluster_domain=&lt;dns_domain&gt;</code>, dns_domain is the domain name set in the DNS service.</li>
</ul>
<h3 id="how-dns-works">How DNS works</h3>
<ol>
<li>first kube2sky container application gets all the service information in the cluster by calling k8s Master&rsquo;s API, and continuously monitors the new service generation and writes it to etcd;</li>
<li>According to the kubelet startup parameters, kubelet will set the DNS resolution configuration file <code>/etc/resolv.conf</code> to add a nameserver configuration and a search configuration in each newly created Pod, and the nameserver will actually access the DNS resolution service provided by skydns on the corresponding port. The DNS resolution service provided by skydns on the corresponding port.</li>
<li>Finally, the application can access the service just by its name, just like a website domain name.</li>
</ol>
<h2 id="ingress">Ingress</h2>
<p>Service works at TCP/IP layer, and Ingress forwards different URL access requests to different services at the backend, implementing the business routing mechanism at HTTP layer. In k8s, you need to combine Ingress and Ingress Controller to form a complete HTTP load balancing.</p>
<h3 id="ingress-controller">Ingress Controller</h3>
<p>The Ingress Controller is used to provide a unified entry point for all back-end services, and needs to implement load distribution rules based on different HTTP URLs forwarded backwards.</p>
<ul>
<li>Listen to APIServer and get all Ingress definitions.</li>
<li>Generate the required Nginx configuration file <code>/etc/nginx/nginx.conf</code> based on the Ingress definitions.</li>
<li>Execute <code>nginx -s reload</code> to reload the contents of the nginx.conf configuration file.</li>
</ul>
<h3 id="defining-ingress">Defining Ingress</h3>
<p>There is a separate resource in k8s called Ingress where you can set forwarding rules to the backend service in its configuration file. For example, define an ingress.yml for hdls.me.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hdls-ingress</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">hdls.me</span><span class="w">
</span><span class="w">   </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/web</span><span class="w">
</span><span class="w">       </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">hdls</span><span class="w">
</span><span class="w">         </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Finally, use <code>kubectl create -f ingress.yml</code> to create Ingress, and log in to the nginx-ingress Pod to see the contents of its automatically generated nginx.conf configuration file.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/python-coroutine/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python Coroutine</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/kubernetes-security-mechanisms/">
            <span class="next-text nav-default">Kubernetes Security Mechanisms Explained</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
