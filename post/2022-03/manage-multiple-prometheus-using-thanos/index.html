<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Centralized data management of multiple Prometheus instances with Thanos - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This post focuses on some ideas for using Thanos to centrally manage data across multiple Prometheus instances." /><meta name="keywords" content="Prometheus, Thanos" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/manage-multiple-prometheus-using-thanos/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Centralized data management of multiple Prometheus instances with Thanos" />
<meta property="og:description" content="This post focuses on some ideas for using Thanos to centrally manage data across multiple Prometheus instances." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/manage-multiple-prometheus-using-thanos/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-22T14:51:27+08:00" />
<meta property="article:modified_time" content="2022-03-22T14:51:27+08:00" />

<meta itemprop="name" content="Centralized data management of multiple Prometheus instances with Thanos">
<meta itemprop="description" content="This post focuses on some ideas for using Thanos to centrally manage data across multiple Prometheus instances."><meta itemprop="datePublished" content="2022-03-22T14:51:27+08:00" />
<meta itemprop="dateModified" content="2022-03-22T14:51:27+08:00" />
<meta itemprop="wordCount" content="1815">
<meta itemprop="keywords" content="Prometheus,Thanos," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Centralized data management of multiple Prometheus instances with Thanos"/>
<meta name="twitter:description" content="This post focuses on some ideas for using Thanos to centrally manage data across multiple Prometheus instances."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Centralized data management of multiple Prometheus instances with Thanos</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-22 14:51:27 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1815 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-layering-of-monitoring">1. layering of monitoring</a></li>
        <li><a href="#2-current-situation-and-selection">2. Current Situation and Selection</a></li>
        <li><a href="#3-several-ways-to-deploy-thanos">3. Several ways to deploy Thanos</a>
          <ul>
            <li><a href="#31-basic-components">3.1 Basic components</a></li>
            <li><a href="#32-receive-mode">3.2 Receive mode</a></li>
            <li><a href="#33-sidecar-mode">3.3 Sidecar mode</a></li>
          </ul>
        </li>
        <li><a href="#4-deploying-thanos">4. Deploying Thanos</a>
          <ul>
            <li><a href="#41-deploying-a-minio">4.1 Deploying a Minio</a></li>
            <li><a href="#42-create-a-bucket-named-thanos-on-minio">4.2 Create a Bucket named thanos on Minio</a></li>
            <li><a href="#43-checking-prometheus-version-compliance-with-thanos-requirements">4.3 Checking Prometheus version compliance with Thanos requirements</a></li>
            <li><a href="#44-deploying-thanos">4.4 Deploying Thanos</a></li>
            <li><a href="#45-accessing-thanos-query">4.5 Accessing Thanos Query</a></li>
          </ul>
        </li>
        <li><a href="#5-add-thanos-sidecar-to-prometheus">5. Add Thanos Sidecar to Prometheus</a>
          <ul>
            <li><a href="#51-add-s3-access-credentials-to-the-prometheus-namespace">5.1 Add S3 access credentials to the Prometheus namespace</a></li>
            <li><a href="#52-adding-additional-label-tag-instances-to-prometheus">5.2 Adding additional Label tag instances to Prometheus</a></li>
            <li><a href="#53-modifying-prometheus-startup-parameters-to-turn-off-compression">5.3 Modifying Prometheus startup parameters to turn off compression</a></li>
            <li><a href="#54-adding-thanos-sidecar-to-prometheus">5.4 Adding Thanos Sidecar to Prometheus</a></li>
            <li><a href="#55-adding-a-grpc-remote-access-port-to-prometheus-sidecar">5.5 Adding a Grpc Remote Access Port to Prometheus Sidecar</a></li>
            <li><a href="#56-adding-store-grpc-addresses-to-thanos-query">5.6 Adding Store Grpc Addresses to Thanos Query</a></li>
            <li><a href="#57-viewing-synchronized-data-in-minio">5.7 Viewing synchronized data in Minio</a></li>
          </ul>
        </li>
        <li><a href="#6-grafana-configuration">6. Grafana Configuration</a>
          <ul>
            <li><a href="#61-adding-a-data-source">6.1 Adding a Data Source</a></li>
            <li><a href="#62-modifying-the-grafana-panel-to-accommodate-cluster-tag-filtering">6.2 Modifying the Grafana panel to accommodate cluster tag filtering</a></li>
            <li><a href="#63-viewing-thanos-and-prometheus-data-sources">6.3 Viewing Thanos and Prometheus Data Sources</a></li>
          </ul>
        </li>
        <li><a href="#7-summary">7. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-layering-of-monitoring">1. layering of monitoring</h2>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/dd600a38dd1342a5ac87f40ae9d850d0.png" alt="layering of monitoring"></p>
<p>As shown above, two strategies are used when building a monitoring system:</p>
<ol>
<li>The advantage of separating IaaS, MySQL middleware, and App tier monitoring is that the systems are highly available and fault-tolerant to each other. When the App tier monitoring does not work, the IaaS tier monitoring will immediately show up.</li>
<li>Separation of long and short term metrics. Short-term metrics are used to provide alerting systems with high frequency queries for recent data, and long-term metrics are used to provide people with queries for data sets that span a larger period of time.</li>
</ol>
<p>This is collectively referred to here as a layering strategy for monitoring, except that one is layered in the infrastructure dimension and one is layered in the time dimension.</p>
<h2 id="2-current-situation-and-selection">2. Current Situation and Selection</h2>
<p>The current situation is that there is no long- and short-term stratification of monitoring, and a common set of Prometheus. When querying long-period metrics, the memory and CPU usage of the server where Prometheus is located rises sharply, even causing monitoring and alerting services to be unavailable.</p>
<p>The reason is twofold:</p>
<ul>
<li>Prometheus loads a lot of data into memory when querying long-period data.</li>
<li>Prometheus is not loading downsampled data</li>
</ul>
<p>The larger the range of queries, the more memory is needed. In another production scenario, we used VictoriaMetrics standalone as remote storage, deploying up to 128 GB of memory. Also, there was data loss in this approach.</p>
<p>The Prometheus Federation approach, on the other hand, only addresses the aggregation of multiple Prometheus, and does not provide the ability to sample and accelerate long-term metrics queries, which is not applicable to the current remote storage scenario.</p>
<p>Finally, seeing that the Thanos Compact component can compress and downsample metrics data, I decided to try using Thanos as the current remote storage for multiple Prometheus.</p>
<h2 id="3-several-ways-to-deploy-thanos">3. Several ways to deploy Thanos</h2>
<h3 id="31-basic-components">3.1 Basic components</h3>
<ul>
<li>Query, which implements the Prometheus API and provides a Prometheus-compliant query interface to the outside world</li>
<li>Sidecar, which is used to connect to Prometheus, providing Query query interface, and can also report data</li>
<li>Store Gateway, which accesses metric data placed in object stores</li>
<li>Compactor, which compresses samples and cleans up data in the object store</li>
<li>Receiver, receives data from Prometheus Remote Write</li>
<li>Ruler, configures and manages alerting rules</li>
</ul>
<h3 id="32-receive-mode">3.2 Receive mode</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/dafe4f0533c547848846074c00d1cfbd.png" alt="Receive mode"></p>
<p>In Receive mode, you need to configure a remote write in each Prometheus instance to upload data to Thanos, where the real-time data is stored in the Thanos Receiver, so the Sidecar component is not needed to complete the query.</p>
<p>Benefits.</p>
<ul>
<li>Data centralization</li>
<li>Prometheus is stateless</li>
<li>Only the Receiver needs to be exposed for Prometheus to access</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>Receiver is subject to a lot of remote write writes from Prometheus</li>
</ul>
<h3 id="33-sidecar-mode">3.3 Sidecar mode</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/dbbbf319a90a4124bac5ada48cf80ad3.png" alt="Sidecar mode"></p>
<p>In Sidecar mode, a Thanos Sidecar component is added next to each Prometheus instance to enable management of Prometheus. There are two main functions.</p>
<ul>
<li>Accepting query requests from the Query component. When Thanos queries short-term data, the request will go to Sidecar.</li>
<li>Uploading short-term metrics data for Prometheus. By default, every two hours, a block is created and uploaded to the object store.</li>
</ul>
<p>Advantages:</p>
<ul>
<li>Easy integration, no need to modify the original configuration</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>Recent data requires network requests between Query and Sidecar, which adds additional time.</li>
<li>Requires Store Gateway to have access to each Prometheus instance</li>
</ul>
<h2 id="4-deploying-thanos">4. Deploying Thanos</h2>
<h3 id="41-deploying-a-minio">4.1 Deploying a Minio</h3>
<blockquote>
<p>Please consult the official documentation.</p>
</blockquote>
<p>Once the installation is complete, test the configuration according to the documentation to ensure that the Minio service works properly.</p>
<h3 id="42-create-a-bucket-named-thanos-on-minio">4.2 Create a Bucket named thanos on Minio</h3>
<p>as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/72eb6dab66e048a4af50c197cea3756c.png" alt="Create a Bucket named thanos on Minio"></p>
<h3 id="43-checking-prometheus-version-compliance-with-thanos-requirements">4.3 Checking Prometheus version compliance with Thanos requirements</h3>
<p>Currently Thanos requires that Prometheus version should preferably be no lower than v2.13.</p>
<h3 id="44-deploying-thanos">4.4 Deploying Thanos</h3>
<ul>
<li>Ensure that default storage is available on the Kubernetes cluster</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl get sc

NAME                         PROVISIONER        RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
openebs-device               openebs.io/local   Delete          WaitForFirstConsumer   <span class="nb">false</span>                  4d5h
openebs-hostpath <span class="o">(</span>default<span class="o">)</span>   openebs.io/local   Delete          WaitForFirstConsumer   <span class="nb">false</span>                  4d5h
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Create a new namespace thanos</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl create ns thanos
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Deploying Thanos</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/shaowenchen/demo
</code></pre></td></tr></table>
</div>
</div><p>Modify the Minio access address in the <code>demo/objectstorage.yaml</code>* View related loads file. Then create the Thanos-related load.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl apply -f ./demo/thanos-0.25/
</code></pre></td></tr></table>
</div>
</div><ul>
<li>View related loads</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n thanos top pod

NAME                           CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
thanos-compact-0               1m           30Mi
thanos-query-7c745f5d7-svlgn   2m           76Mi
thanos-receive-0               1m           15Mi
thanos-rule-0                  1m           18Mi
thanos-store-0                 1m           55Mi
</code></pre></td></tr></table>
</div>
</div><p>Deploying Thanos consumes few resources.</p>
<h3 id="45-accessing-thanos-query">4.5 Accessing Thanos Query</h3>
<ul>
<li>View the ports of Thanos related services</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n thanos get svc

NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                           AGE
thanos-compact   ClusterIP   10.233.47.253   &lt;none&gt;        10902/TCP                         11h
thanos-query     NodePort    10.233.45.138   &lt;none&gt;        10901:32180/TCP,9090:32612/TCP    11h
thanos-receive   ClusterIP   None            &lt;none&gt;        10902/TCP,19291/TCP,10901/TCP     11h
thanos-rule      ClusterIP   None            &lt;none&gt;        10901/TCP,10902/TCP               11h
thanos-store     NodePort    10.233.41.159   &lt;none&gt;        10901:30901/TCP,10902:31426/TCP   10h
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Accessing the Thanos Query page</li>
</ul>
<p>thanos-query provides an http access portal on port 9090, so here the pages provided by the Query component are accessed through the host IP:32612 port.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/188759a3efa148c8b4be1432f007f7b7.png" alt="Accessing the Thanos Query page"></p>
<h2 id="5-add-thanos-sidecar-to-prometheus">5. Add Thanos Sidecar to Prometheus</h2>
<p>Sidecar mode requires less Thanos configuration, while Receiver mode needs to keep receiving Remote Write from many Prometheus, so Sidecar mode is chosen here for cost reasons.</p>
<h3 id="51-add-s3-access-credentials-to-the-prometheus-namespace">5.1 Add S3 access credentials to the Prometheus namespace</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Secret
</span><span class="s">metadata:
</span><span class="s">  name: thanos-objectstorage
</span><span class="s">  namespace: minitor
</span><span class="s">type: Opaque
</span><span class="s">stringData:
</span><span class="s">  objectstorage.yaml: |
</span><span class="s">    type: S3
</span><span class="s">    config:
</span><span class="s">        bucket: &#34;thanos&#34;
</span><span class="s">        endpoint: &#34;0.0.0.0:9000&#34;
</span><span class="s">        insecure: true
</span><span class="s">        access_key: &#34;minioadmin&#34;
</span><span class="s">        secret_key: &#34;minioadmin&#34;
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>The administrator account is used directly here. For production, a separate account should be created for Thanos' use of Minio.</p>
<h3 id="52-adding-additional-label-tag-instances-to-prometheus">5.2 Adding additional Label tag instances to Prometheus</h3>
<p>By adding <code>external_labels</code> to Prometheus you can add an additional label to each Prometheus instance globally to uniquely mark an instance.</p>
<ul>
<li>Edit the configuration file</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n monitor edit cm prometheus-server
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add the following</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">  </span><span class="nt">prometheus.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    global:
</span><span class="sd">      external_labels:
</span><span class="sd">        cluster: dev    </span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>A tag named cluster=dev has been added here. All metrics reported by this Prometheus instance will carry this tag for easy querying and filtering.</p>
<h3 id="53-modifying-prometheus-startup-parameters-to-turn-off-compression">5.3 Modifying Prometheus startup parameters to turn off compression</h3>
<ul>
<li>Edit the Prometheus deployment file</li>
</ul>
<p>Some deployments are done with Deployment and some are done with StatefulSet, both need to modify the Prometheus startup parameters</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n monitor edit deploy prometheus-server
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Modify tsdb to store blocks with equal maximum and minimum values</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">        - --storage.tsdb.max-block-duration<span class="o">=</span>2h
        - --storage.tsdb.min-block-duration<span class="o">=</span>2h
        image: quay.io/prometheus/prometheus:v2.31.1
</code></pre></td></tr></table>
</div>
</div><p><code>storage.tsdb.min-block-duration</code> and <code>storage.tsdb.max-block-duration</code> are equal to guarantee that Prometheus has local compression turned off to avoid Thanos upload failures when compressing.</p>
<h3 id="54-adding-thanos-sidecar-to-prometheus">5.4 Adding Thanos Sidecar to Prometheus</h3>
<ul>
<li>Edit the Prometheus deployment file</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n monitor edit deploy prometheus-server
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add the following containers</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">sidecar</span><span class="w">
</span><span class="w">        </span>- --<span class="l">log.level=debug</span><span class="w">
</span><span class="w">        </span>- --<span class="l">tsdb.path=/data</span><span class="w">
</span><span class="w">        </span>- --<span class="l">prometheus.url=http://127.0.0.1:9090</span><span class="w">
</span><span class="w">        </span>- --<span class="l">objstore.config-file=/etc/objectstorage.yaml</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">thanos-sidecar</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">thanosio/thanos:v0.25.0</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-sidecar</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">10902</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grpc</span><span class="w">
</span><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">10901</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10902</span><span class="w">
</span><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/-/healthy</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10902</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/-/ready</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">storage-volume</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">thanos-objectstorage</span><span class="w">
</span><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">objectstorage.yaml</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/objectstorage.yaml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>New mount secret key</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">thanos-objectstorage</span><span class="w">
</span><span class="w">        </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">thanos-objectstorage</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Reboot Prometheus</li>
</ul>
<p>Rolling upgrades will encounter the following error, caused by the previous Prometheus Pod not releasing the file directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ts</span><span class="o">=</span>2022-03-21T04:06:39.267Z <span class="nv">caller</span><span class="o">=</span>main.go:932 <span class="nv">level</span><span class="o">=</span>error <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;opening storage failed: lock DB directory: resource temporarily unavailable&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>So you need to set the number of copies to 0 first, then set it to 1 and restart Prometheus.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n monitor scale deploy prometheus-server --replicas<span class="o">=</span><span class="m">0</span>
kubectl -n monitor scale deploy prometheus-server --replicas<span class="o">=</span><span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="55-adding-a-grpc-remote-access-port-to-prometheus-sidecar">5.5 Adding a Grpc Remote Access Port to Prometheus Sidecar</h3>
<ul>
<li>Edit the Prometheus Service configuration</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n monitor edit svc prometheus-server
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add a Service port to expose the Grpc service to Thanos Store Gateway</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sidecar-grpc</span><span class="w">
</span><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30901</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10901</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">10901</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="56-adding-store-grpc-addresses-to-thanos-query">5.6 Adding Store Grpc Addresses to Thanos Query</h3>
<p>Finally, you need to add the Grpc address of the Prometheus Sidecar above to the Thanos Store Gateway.</p>
<ul>
<li>Edit Thanos Query</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n thanos edit deploy thanos-query
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Add <code>--store=0.0.0.0:30901</code> to the startup parameters</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">query</span><span class="w">
</span><span class="w">        </span>- --<span class="l">log.level=debug</span><span class="w">
</span><span class="w">        </span>- --<span class="l">query.auto-downsampling</span><span class="w">
</span><span class="w">        </span>- --<span class="l">grpc-address=0.0.0.0:10901</span><span class="w">
</span><span class="w">        </span>- --<span class="l">http-address=0.0.0.0:9090</span><span class="w">
</span><span class="w">        </span>- --<span class="l">query.partial-response</span><span class="w">
</span><span class="w">        </span>- --<span class="l">query.replica-label=prometheus_replica</span><span class="w">
</span><span class="w">        </span>- --<span class="l">query.replica-label=rule_replica</span><span class="w">
</span><span class="w">        </span>- --<span class="l">store=0.0.0.0:30901</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">thanosio/thanos:v0.25.0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Here <code>0.0.0.0:30901</code> needs to be replaced with the Grpc access portal exposed by Prometheus Sidecar above. This way, when Thanos Query provides query capabilities, short-term data will call Grpc queries instead of querying data in the object store.</p>
<p>At this point, the Thanos Query page mentioned above and the new <code>0.0.0.0:30901</code> Endpoint record can be seen, and the status should be <code>Up</code>.</p>
<h3 id="57-viewing-synchronized-data-in-minio">5.7 Viewing synchronized data in Minio</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/8eec0748a1d94fa0b6413018a391274e.png" alt="Viewing synchronized data in Minio"></p>
<p>A total of 6 clusters were added, each with about 40 Pods, using about 2.1 GB of storage and 303 objects in half a day.</p>
<h2 id="6-grafana-configuration">6. Grafana Configuration</h2>
<h3 id="61-adding-a-data-source">6.1 Adding a Data Source</h3>
<p>Adding a Thanos Query data source to Grafana is done in the same way as adding Prometheus. As shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/76c798444d584184ab5c092f05db1b06.png" alt="Adding a Thanos Query data source to Grafana"></p>
<h3 id="62-modifying-the-grafana-panel-to-accommodate-cluster-tag-filtering">6.2 Modifying the Grafana panel to accommodate cluster tag filtering</h3>
<p>Here is a slight modification to the Kubernetes cluster-based view panel.</p>
<ul>
<li>Add variables for cluster filtering</li>
</ul>
<p>Above, I added a global <code>external_labels</code> to each Prometheus to distinguish between clusters by the <code>cluster</code> field.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/9f3c39ad4d7342399342f89a52041d4b.png" alt="added a global external_labels to each Prometheus"></p>
<p>As shown above, add a Cluster variable to the panel and filter it using the <code>cluster</code> tag in the metrics.</p>
<ul>
<li>Edit the filtering query criteria for each view</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/eda26be8403043c0a91d50dfd23ecd8f.png" alt="Edit the filtering query criteria for each view"></p>
<p>As shown above, you need to add an additional filter condition, <code>cluster=~&quot;^$Cluster$&quot;}</code>, to the expression of each view. Of course, you can also export the panel, make bulk changes in the editor, and then import it into Grafana.</p>
<h3 id="63-viewing-thanos-and-prometheus-data-sources">6.3 Viewing Thanos and Prometheus Data Sources</h3>
<ul>
<li>Using the Thanos data source</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/8864c9c79f144ccda1958b8ea2ad6026.png" alt="Using the Thanos data source"></p>
<ul>
<li>Using the Prometheus data source</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/22/bb66975cf90d45e58fc969f9dce97268.png" alt="Using the Prometheus data source"></p>
<p>Comparing the data from both panels, we can see that they show the same metrics. Therefore, we can use one Thanos data source instead of a scenario where multiple Prometheus data sources are managed decentralized.</p>
<p>Here the time scale of the data does not reach the parameter settings of the Thanos Compact component, so the effect of downsampling is not reflected.</p>
<h2 id="7-summary">7. Summary</h2>
<p>This article is mainly about some ideas for monitoring data layer management.</p>
<p>First of all, the data should be tiered, with short-term data stored directly in the nearest Prometheus and long-term data stored in Thanos' object storage. Short-term data is provided to the alarm system for high-frequency queries, and long-term data is provided to people for analysis.</p>
<p>The main reason for choosing Thanos is its downsampling; the Thanos compact component provides 5-minute and 1-hour downsampling, and with Prometheus sampling every 15s, the compression will be 20x and 240x, which can greatly relieve the pressure of long-period queries. In Sidecar mode, short-term data is queried through Grpc using Prometheus' API.</p>
<p>Finally, of course, all 6 local clusters are connected to Thanos, and only after trying it out, we can really appreciate some of the details and processing logic. I&rsquo;ve read a lot of architecture diagrams, documents and blogs, but it&rsquo;s not as good as trying it out myself.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/prometheus/">Prometheus</a>
          <a href="/tags/thanos/">Thanos</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/k8s-managed-lifecycle/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Lifecycle Management Design Patterns in K8s</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/k8s-automatic-scheduling/">
            <span class="next-text nav-default">Automatic scheduling design pattern in K8s</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
