<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to use the uber open source zap log library very well - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1" /><meta name="keywords" content="golang, Zap Zap, log" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/uber-zap-advanced-usage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to use the uber open source zap log library very well" />
<meta property="og:description" content="1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/uber-zap-advanced-usage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-27T10:50:58+08:00" />
<meta property="article:modified_time" content="2022-03-27T10:50:58+08:00" />

<meta itemprop="name" content="How to use the uber open source zap log library very well">
<meta itemprop="description" content="1"><meta itemprop="datePublished" content="2022-03-27T10:50:58+08:00" />
<meta itemprop="dateModified" content="2022-03-27T10:50:58+08:00" />
<meta itemprop="wordCount" content="4428">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use the uber open source zap log library very well"/>
<meta name="twitter:description" content="1"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to use the uber open source zap log library very well</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-27 10:50:58 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4428 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-wrapping-zap-to-make-it-more-usable">1. Wrapping zap to make it more usable</a></li>
        <li><a href="#2-customizing-encoder">2. Customizing encoder</a></li>
        <li><a href="#3-writing-multiple-log-files">3. writing multiple log files</a></li>
        <li><a href="#4-make-log-files-support-auto-rotate-rotation">4. Make log files support auto-rotate (rotation)</a></li>
        <li><a href="#5-summary">5. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/27/54973860fa3f4a7e8505526ec9bee039.png" alt="golang uber zap"></p>
<p>Logging has an important place in the back-end system. Not only can logs visualize the current running state of the program, but more importantly they can provide clues to developers when something goes wrong with the program.</p>
<p>In the Go ecosystem, logrus is probably the most used Go logging library, which not only provides structured logs, but more importantly is compatible with the standard library log package at the api level. In performance-insensitive domains, logrus is really the way to go.</p>
<p>But in performance-sensitive areas and scenarios, logrus will be less fragrant, and more appearances are made by the big factory uber open source log library called <a href="https://github.com/uber-go/zap">zap</a>. The reason why zap is more fragrant in these scenarios is that although it is known for its high performance, the backing of uber is also extremely important. uber has too many performance and latency-sensitive scenarios, and its production environment now has thousands of microservices developed in Go, most of which are estimated to use zap, a log library that has been tested in performance-sensitive scenarios by uber. There is a guarantee that someone will continue to maintain it, and it is naturally favored by everyone.</p>
<p>The main optimization points of zap include</p>
<ul>
<li>avoiding the overhead of using interface{} (unboxing, object escape to the heap)</li>
<li>Firmly refrain from using reflection, and carry type information for each field to be output (this reduces the developer&rsquo;s experience with zap, but this reduction in experience seems to be nothing compared to the performance gains it achieves).</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span>
    <span class="c1">// Structured context as strongly typed Field values.
</span><span class="c1"></span>    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="s">`http://foo.com`</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;attempt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="nx">zap</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;backoff&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Use sync.Pool to reduce heap memory allocation (for zapcore.Entry representing a full log message) and reduce pressure on GC.</li>
</ul>
<p>Here is a simple zap vs logrus performance benchmark benchmark comparison.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/benchmark/log_lib_test.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;io&#34;</span>
    <span class="s">&#34;testing&#34;</span>
    <span class="s">&#34;time&#34;</span>

    <span class="s">&#34;github.com/sirupsen/logrus&#34;</span>
    <span class="s">&#34;go.uber.org/zap&#34;</span>
    <span class="s">&#34;go.uber.org/zap/zapcore&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">BenchmarkLogrus</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">logrus</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">SetOutput</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Discard</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">logrus</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span>
            <span class="s">&#34;url&#34;</span><span class="p">:</span>     <span class="s">&#34;http://foo.com&#34;</span><span class="p">,</span>
            <span class="s">&#34;attempt&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s">&#34;backoff&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
        <span class="p">}).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkZap</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Discard</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nx">InfoLevel</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">core</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;failed to fetch URL&#34;</span><span class="p">,</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="s">`http://foo.com`</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;attempt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;backoff&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the benchmark test above, we used logrus and zap to write the same content to io.Discard respectively, and the benchmark ran as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> <span class="nb">test</span> -bench .
goos: darwin
goarch: amd64
pkg: github.com/bigwhite/zap-usage
cpu: Intel<span class="o">(</span>R<span class="o">)</span> Core<span class="o">(</span>TM<span class="o">)</span> i5-8257U CPU @ 1.40GHz
BenchmarkLogrus-8         <span class="m">281667</span>          <span class="m">4001</span> ns/op        <span class="m">1365</span> B/op         <span class="m">25</span> allocs/op
BenchmarkZap-8           <span class="m">1319922</span>           901.1 ns/op       <span class="m">192</span> B/op          <span class="m">1</span> allocs/op
PASS
ok      github.com/bigwhite/zap-usage   3.296s
</code></pre></td></tr></table>
</div>
</div><p>We see that zap&rsquo;s write logging performance is four times that of logrus, and with only one memory allocation per op, logrus is indeed inferior in terms of performance and memory allocation.</p>
<p>There are strengths and weaknesses. As mentioned earlier, while zap is a top performer, it leaves a &ldquo;shadow&rdquo; on developers' experience. For example, in the performance benchmark above, instead of writing to stdout or stderr, which is the default, we set output to <code>io.Discard</code>. Such a change requires only one line in logrus.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">logger</span><span class="p">.</span><span class="nf">SetOutput</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Discard</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>In the official home page of the zap project, I couldn&rsquo;t find a way to make this change, and only after a while of searching and reading did I find the correct method (note: the method is not unique).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
<span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Discard</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nx">InfoLevel</span><span class="p">,</span>
<span class="p">)</span>
<span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">core</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The above comparison of logrus and zap&rsquo;s approach to creating loggers written to io.</p>
<p>So after choosing zap, how can we use zap better to try to bridge the gap with logrus and other logging libraries in terms of experience? That&rsquo;s what I want to share with you in this article.</p>
<h2 id="1-wrapping-zap-to-make-it-more-usable">1. Wrapping zap to make it more usable</h2>
<p>When you enter the Go world, the first log library you use will be the log package that comes with the Go standard library, which is &ldquo;out of the box&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/stdlog/demo1.go 
</span><span class="c1"></span>
<span class="kn">import</span> <span class="s">&#34;log&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;this is go standard log package&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The sample code above outputs a line of log content directly to the standard error (stderr), and we didn&rsquo;t even create a logger variable. Even writing the log to a file seems to be a very easy thing to do in the log package, see the following code snippet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/stdlog/demo2.go 
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;os&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;./demo2.log&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_APPEND</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">SetOutput</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;this is go standard log package&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>File, which implements io.Writer, to the SetOutput function of the log package. This way of writing logs without creating logger variables but directly using the package name + function reduces the complexity of passing and managing logger variables, and this user experience is the goal of our encapsulation of zap. However, we also need to have in mind that zap is a generic logging library, and after we package it, we only need to provide the features we need, there is no need to package it as a generic library like zap. In addition, users only need to rely on our packaged logging package, not explicitly on <code>zap/zapcore</code>.</p>
<p>Let&rsquo;s build demo1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo1
</span><span class="c1"></span><span class="err">$</span><span class="nx">tree</span> <span class="nx">demo1</span>
<span class="nx">demo1</span>
<span class="err">├──</span> <span class="k">go</span><span class="p">.</span><span class="nx">mod</span>
<span class="err">├──</span> <span class="k">go</span><span class="p">.</span><span class="nx">sum</span>
<span class="err">├──</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="err">└──</span> <span class="nx">pkg</span>
    <span class="err">├──</span> <span class="nx">log</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="nx">log</span><span class="p">.</span><span class="k">go</span>
    <span class="err">└──</span> <span class="nx">pkg1</span>
        <span class="err">└──</span> <span class="nx">pkg1</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><p>Our wrapper for zap is in pkg/log/log.go:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo1/pkg/log/log.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">log</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;io&#34;</span>
    <span class="s">&#34;os&#34;</span>

    <span class="s">&#34;go.uber.org/zap&#34;</span>
    <span class="s">&#34;go.uber.org/zap/zapcore&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">InfoLevel</span>   <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">InfoLevel</span>   <span class="c1">// 0, default level
</span><span class="c1"></span>    <span class="nx">WarnLevel</span>   <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">WarnLevel</span>   <span class="c1">// 1
</span><span class="c1"></span>    <span class="nx">ErrorLevel</span>  <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">ErrorLevel</span>  <span class="c1">// 2
</span><span class="c1"></span>    <span class="nx">DPanicLevel</span> <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">DPanicLevel</span> <span class="c1">// 3, used in development log
</span><span class="c1"></span>    <span class="c1">// PanicLevel logs a message, then panics
</span><span class="c1"></span>    <span class="nx">PanicLevel</span> <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">PanicLevel</span> <span class="c1">// 4
</span><span class="c1"></span>    <span class="c1">// FatalLevel logs a message, then calls os.Exit(1).
</span><span class="c1"></span>    <span class="nx">FatalLevel</span> <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">FatalLevel</span> <span class="c1">// 5
</span><span class="c1"></span>    <span class="nx">DebugLevel</span> <span class="nx">Level</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">DebugLevel</span> <span class="c1">// -1
</span><span class="c1"></span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Field</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Field</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Debug</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Warn</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Error</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">DPanic</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">DPanic</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Panic</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Panic</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Fatal</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="o">...</span><span class="nx">Field</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">fields</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// function variables for all field types
</span><span class="c1">// in github.com/uber-go/zap/field.go
</span><span class="c1"></span>
<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">Skip</span>        <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Skip</span>
    <span class="nx">Binary</span>      <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Binary</span>
    <span class="nx">Bool</span>        <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Bool</span>
    <span class="nx">Boolp</span>       <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Boolp</span>
    <span class="nx">ByteString</span>  <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">ByteString</span>
    <span class="o">...</span> <span class="o">...</span>
    <span class="nx">Float64</span>     <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Float64</span>
    <span class="nx">Float64p</span>    <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Float64p</span>
    <span class="nx">Float32</span>     <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Float32</span>
    <span class="nx">Float32p</span>    <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Float32p</span>
    <span class="nx">Durationp</span>   <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Durationp</span>
    <span class="o">...</span> <span class="o">...</span>
    <span class="nx">Any</span>         <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Any</span>

    <span class="nx">Info</span>   <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Info</span>
    <span class="nx">Warn</span>   <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Warn</span>
    <span class="nx">Error</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Error</span>
    <span class="nx">DPanic</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">DPanic</span>
    <span class="nx">Panic</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Panic</span>
    <span class="nx">Fatal</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Fatal</span>
    <span class="nx">Debug</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Debug</span>
<span class="p">)</span>

<span class="c1">// not safe for concurrent use
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ResetDefault</span><span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">std</span> <span class="p">=</span> <span class="nx">l</span>
    <span class="nx">Info</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Info</span>
    <span class="nx">Warn</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Warn</span>
    <span class="nx">Error</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Error</span>
    <span class="nx">DPanic</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">DPanic</span>
    <span class="nx">Panic</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Panic</span>
    <span class="nx">Fatal</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Fatal</span>
    <span class="nx">Debug</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Debug</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Logger</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">l</span>     <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span> <span class="c1">// zap ensure that zap.Logger is safe for concurrent use
</span><span class="c1"></span>    <span class="nx">level</span> <span class="nx">Level</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">std</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nb">int8</span><span class="p">(</span><span class="nx">InfoLevel</span><span class="p">))</span>

<span class="kd">func</span> <span class="nf">Default</span><span class="p">()</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">std</span>
<span class="p">}</span>

<span class="c1">// New create a new logger (not support log rotating).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">level</span> <span class="nx">Level</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">writer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;the writer is nil&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">writer</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">Level</span><span class="p">(</span><span class="nx">level</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">l</span><span class="p">:</span>     <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">core</span><span class="p">),</span>
        <span class="nx">level</span><span class="p">:</span> <span class="nx">level</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">logger</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="nf">Sync</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Sync</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">std</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">std</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this package, we have the following notes.</p>
<ul>
<li>Referring to the standard library log package, we provide the package level function interface, the bottom is the default Logger created: std.</li>
<li>You can use the New function to create your own Logger variable, but at this time can only use the methods of the instance to achieve log output, if you expect to use the package level function interface to output log, you need to call ResetDefault to replace the value of the updated std instance, so that subsequent calls to package level functions (Info, Debug), etc. will be output to the new instance of the target io. Writer. However, it is best to call ResetDefault to replace std before outputting any logs.</li>
<li>Since zap has to tell the specific type when outputting logs, zap wraps out Field and some sugar functions (Int, String, etc.). Here, in order not to expose zap to the user, we use <a href="https://tip.golang.org/ref/spec#Type_declarations">type alias syntax</a> to define our own equivalent to zap.Field for the type log.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">type</span> <span class="nv">Field</span> <span class="o">=</span> zap.Field
</code></pre></td></tr></table>
</div>
</div><ul>
<li>We expose some of zap&rsquo;s sugar functions (Int, String, etc.) to the user based on the &ldquo;functions are first-class citizens&rdquo; feature (this is also a method often used by Go unit tests in export_test.go).</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
    <span class="nx">Skip</span>        <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Skip</span>
    <span class="nx">Binary</span>      <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Binary</span>
    <span class="nx">Bool</span>        <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Bool</span>
    <span class="nx">Boolp</span>       <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Boolp</span>
    <span class="nx">ByteString</span>  <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">ByteString</span>
    <span class="o">...</span> <span class="o">...</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>We use <a href="https://tip.golang.org/ref/spec#Method_values">method value syntax</a> to expose each method of the std instance to the user as a package-level function, simplifying the user&rsquo;s access to the logger instance.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
    <span class="nx">Info</span>   <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Info</span>
    <span class="nx">Warn</span>   <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Warn</span>
    <span class="nx">Error</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Error</span>
    <span class="nx">DPanic</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">DPanic</span>
    <span class="nx">Panic</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Panic</span>
    <span class="nx">Fatal</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Fatal</span>
    <span class="nx">Debug</span>  <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nx">Debug</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>The following is an example of how we can output logs directly to stderr using the default std using package level functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo1/main.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/log&#34;</span>
    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo1:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;start ok&#34;</span><span class="p">),</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;major version&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nx">pkg1</span><span class="p">.</span><span class="nf">Foo</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this main.go, we use package level functions directly to achieve log output like the standard library log package, and we don&rsquo;t need to create logger instances, and we don&rsquo;t need to manage and pass logger instances, in the log package another user pkg1 package, we can also use package level functions directly to output log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo1/pkg/pkg1/pkg1.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">pkg1</span>

<span class="kn">import</span> <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/log&#34;</span>

<span class="kd">func</span> <span class="nf">Foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;call foo&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="s">&#34;https://tonybai.com&#34;</span><span class="p">),</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;attempt&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If you don&rsquo;t want to use the default std, but want to create a logger that writes to a filesystem file, we can handle it like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo1/main_new_logger.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;os&#34;</span>

    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/log&#34;</span>
    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/pkg1&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;./demo1.log&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_APPEND</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">InfoLevel</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">ResetDefault</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Sync</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo1:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;start ok&#34;</span><span class="p">),</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;major version&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="nx">pkg1</span><span class="p">.</span><span class="nf">Foo</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We use log.New to create a new instance of Logger and then replace std with it via log.ResetDefault so that subsequent package level function calls (log.Info) will use the newly created Logger instance.</p>
<h2 id="2-customizing-encoder">2. Customizing encoder</h2>
<p>Running demo1 above, we will get the log content in a format similar to the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1625954037.630399</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;demo1:&#34;</span><span class="p">,</span><span class="nt">&#34;app&#34;</span><span class="p">:</span><span class="s2">&#34;start ok&#34;</span><span class="p">,</span><span class="nt">&#34;major version&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
<span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;ts&#34;</span><span class="p">:</span><span class="mf">1625954037.630462</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;call foo&#34;</span><span class="p">,</span><span class="nt">&#34;url&#34;</span><span class="p">:</span><span class="s2">&#34;https://tonybai.com&#34;</span><span class="p">,</span><span class="nt">&#34;attempt&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can customize the output content format of zap.</p>
<p>Before customizing, let&rsquo;s take a look at the internal structure of zap.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/27/d58aa5d9b6fa4fa9848f7a5b4608bc02.png" alt="zap"></p>
<p>Similar to other log libraries, zap is composed of two key processes: creating loggers and writing logs. Core is a logging interface defined by zap, and as the name suggests, around this Core, zap provides upper-level logging objects and corresponding methods (zap.Logger combines zapcore.Core), and developers can also customize their own logging packages based on this interface ( For example: the previous implementation of our New function).</p>
<p>We generally create an instance that implements zapcore.Core through the zapcore.NewCore function. NewCore receives three parameters, which are also the main components of Core, and they are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">                                ┌───────────────┐
                                 │               │
                                 │               │
                      ┌─────────►│     Encoder   │
                      │          │               │
                      │          │               │
                      │          └───────────────┘
┌────────────────┐    │
│                ├────┘
│                │               ┌───────────────┐
│                │               │               │
│      Core      ├──────────────►│  WriteSyncer  │
│                │               │               │
│                ├─────┐         │               │
└────────────────┘     │         └───────────────┘
                       │
                       │
                       │         ┌───────────────┐
                       │         │               │
                       └────────►│  LevelEnabler │
                                 │               │
                                 │               │
                                 └───────────────┘
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Encoder is the encoder for log messages.</li>
<li>WriteSyncer is an io.Writer that supports the Sync method, meaning the log output, and we can easily convert an io.Writer to a WriteSyncer that supports the Sync method via zap.AddSync.</li>
<li>LevelEnabler, on the other hand, is a log level related parameter.</li>
</ul>
<p>From this we see that to customize the output format of the log, our focus is on the Encoder.</p>
<p>In terms of broad categories, zap has two built-in types of encoders, a ConsoleEncoder and a JSONEncoder. consoleEncoder is more suitable for human reading, while JSONEncoder is more suitable for machine processing. zap provides the two most commonly used functions for creating Loggers. NewProduction and NewDevelopment use JSONEncoder and ConsoleEncoder, respectively. a comparison of the default output of the two encoders is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// ConsoleEncoder（NewDevelopment创建<span class="o">)</span>
2021-07-11T09:39:04.418+0800    INFO    zap/testzap2.go:12  failed to fetch URL <span class="o">{</span><span class="s2">&#34;url&#34;</span>: <span class="s2">&#34;localhost:8080&#34;</span>, <span class="s2">&#34;attempt&#34;</span>: 3, <span class="s2">&#34;backoff&#34;</span>: <span class="s2">&#34;1s&#34;</span><span class="o">}</span>

// JSONEncoder <span class="o">(</span>NewProduction创建<span class="o">)</span>
<span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:1625968332.269727,<span class="s2">&#34;caller&#34;</span>:<span class="s2">&#34;zap/testzap1.go:12&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;failed to fetch URL&#34;</span>,<span class="s2">&#34;url&#34;</span>:<span class="s2">&#34;localhost:8080&#34;</span>,<span class="s2">&#34;attempt&#34;</span>:3,<span class="s2">&#34;backoff&#34;</span>:1<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ConsoleEncoder output is more suitable for reading, while JSONEncoder output is more suitable for machine/program processing. As we said before, our packaged log package is not intended to be a generic log package, we do not need to support both types of Encoder, so we chose to use JSONEncoder in the above example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">writer</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">Level</span><span class="p">(</span><span class="nx">level</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Based on Encoder, there are many things we can customize, and most developers are probably interested in customizing the date format, whether to display caller information for this log, etc.</p>
<p>The zap library itself also provides an Option interface based on the functional option model.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// zap options.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">apply</span><span class="p">(</span><span class="o">*</span><span class="nx">Logger</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">WithCaller</span><span class="p">(</span><span class="nx">enabled</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">optionFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">log</span> <span class="o">*</span><span class="nx">Logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">addCaller</span> <span class="p">=</span> <span class="nx">enabled</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If our log library is to provide some Encoder customization capability, we also need to expose zap.Option to the user through the type alias syntax like Field, and export part of zap&rsquo;s option to the user in the form of a function type variable. As for the timestamp, we can fix it after choosing a format that suits us. The following is the demo2 log package, which is based on the demo1 log with some customizations to the encoder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo2/pkg/log/log.go
</span><span class="c1"></span>
<span class="kd">var</span> <span class="nx">std</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="nx">InfoLevel</span><span class="p">,</span> <span class="nf">WithCaller</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>

<span class="kd">type</span> <span class="nx">Option</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Option</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">WithCaller</span>    <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">WithCaller</span>
    <span class="nx">AddStacktrace</span> <span class="p">=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">AddStacktrace</span>
<span class="p">)</span>

<span class="c1">// New create a new logger (not support log rotating).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">level</span> <span class="nx">Level</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">writer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;the writer is nil&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
    <span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">.</span><span class="nx">EncodeTime</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">enc</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">PrimitiveArrayEncoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">enc</span><span class="p">.</span><span class="nf">AppendString</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02T15:04:05.000Z0700&#34;</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">writer</span><span class="p">),</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nf">Level</span><span class="p">(</span><span class="nx">level</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">l</span><span class="p">:</span>     <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">core</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">),</span>
        <span class="nx">level</span><span class="p">:</span> <span class="nx">level</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">logger</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After customization, the output of our log package will look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo2/
<span class="nv">$go</span> run main.go
<span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2021-07-11T10:45:38.858+0800&#34;</span>,<span class="s2">&#34;caller&#34;</span>:<span class="s2">&#34;log/log.go:33&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;demo1:&#34;</span>,<span class="s2">&#34;app&#34;</span>:<span class="s2">&#34;start ok&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-writing-multiple-log-files">3. writing multiple log files</h2>
<p>After customizing encoder, let&rsquo;s take a look at writeSyncer. nginx, which I&rsquo;m sure no one has ever used, has two important log files: access.log and error.log, the former being the normal access log and the latter being the error report log. If we also want to learn nginx and create two types of log files for the business system, one is similar to access.log, which records the log of normal business blowing, and the other is similar to error.log, which records the error log of the system, how should we design and implement it? Some people may say, then create two loggers. Yes, this is indeed a solution. But what if I just want to use a package level function to write multiple log files without passing logger instances? zap provides NewTee as an export function to write multiple log files.</p>
<p>Let&rsquo;s do this with demo3, where we also provide an external NewTee function to create a logger that writes multiple log files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo3/pkg/log/log.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">LevelEnablerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span>

<span class="kd">type</span> <span class="nx">TeeOption</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">W</span>   <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
    <span class="nx">Lef</span> <span class="nx">LevelEnablerFunc</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewTee</span><span class="p">(</span><span class="nx">tops</span> <span class="p">[]</span><span class="nx">TeeOption</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cores</span> <span class="p">[]</span><span class="nx">zapcore</span><span class="p">.</span><span class="nx">Core</span>
    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
    <span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">.</span><span class="nx">EncodeTime</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">enc</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">PrimitiveArrayEncoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">enc</span><span class="p">.</span><span class="nf">AppendString</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02T15:04:05.000Z0700&#34;</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">top</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tops</span> <span class="p">{</span>
        <span class="nx">top</span> <span class="o">:=</span> <span class="nx">top</span>
        <span class="k">if</span> <span class="nx">top</span><span class="p">.</span><span class="nx">W</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;the writer is nil&#34;</span><span class="p">)</span>
        <span class="p">}</span>         

        <span class="nx">lv</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">LevelEnablerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">top</span><span class="p">.</span><span class="nf">Lef</span><span class="p">(</span><span class="nf">Level</span><span class="p">(</span><span class="nx">lvl</span><span class="p">))</span>
        <span class="p">})</span>        

        <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
            <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
            <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">top</span><span class="p">.</span><span class="nx">W</span><span class="p">),</span>
            <span class="nx">lv</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nx">cores</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cores</span><span class="p">,</span> <span class="nx">core</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">l</span><span class="p">:</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewTee</span><span class="p">(</span><span class="nx">cores</span><span class="o">...</span><span class="p">),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">logger</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that since multiple log files may choose whether to drop into the file based on the level of the log written, we provide a TeeOption type with a io.Writer and a level enabler func in the type definition, so let&rsquo;s see how to use this NewTee function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo3/main.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;os&#34;</span>

    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/log&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">file1</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;./access.log&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_APPEND</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">file2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="s">&#34;./error.log&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_APPEND</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tops</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">log</span><span class="p">.</span><span class="nx">TeeOption</span><span class="p">{</span>
        <span class="p">{</span>
            <span class="nx">W</span><span class="p">:</span> <span class="nx">file1</span><span class="p">,</span>
            <span class="nx">Lef</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">lvl</span> <span class="o">&lt;=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">InfoLevel</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">W</span><span class="p">:</span> <span class="nx">file2</span><span class="p">,</span>
            <span class="nx">Lef</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">lvl</span> <span class="p">&gt;</span> <span class="nx">log</span><span class="p">.</span><span class="nx">InfoLevel</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">NewTee</span><span class="p">(</span><span class="nx">tops</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">ResetDefault</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>

    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo3:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;start ok&#34;</span><span class="p">),</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;major version&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;demo3:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;crash&#34;</span><span class="p">),</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;reason&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We create two TeeOptions, corresponding to access.log and error.log, the former accepting logs at level&lt;=info and the latter accepting logs at level&gt;error. Let&rsquo;s run the program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">$go</span> run main.go
<span class="nv">$cat</span> access.log
<span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2021-07-11T12:09:47.736+0800&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;demo3:&#34;</span>,<span class="s2">&#34;app&#34;</span>:<span class="s2">&#34;start ok&#34;</span>,<span class="s2">&#34;major version&#34;</span>:3<span class="o">}</span>
<span class="nv">$cat</span> error.log
<span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;error&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2021-07-11T12:09:47.737+0800&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;demo3:&#34;</span>,<span class="s2">&#34;app&#34;</span>:<span class="s2">&#34;crash&#34;</span>,<span class="s2">&#34;reason&#34;</span>:-1<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As we expected, different levels of logs are written to different files, and we can just call package level functions without having to manage and pass different loggers.</p>
<h2 id="4-make-log-files-support-auto-rotate-rotation">4. Make log files support auto-rotate (rotation)</h2>
<p>If logs are written to a file, then sooner or later the file will be full! We can&rsquo;t just sit back and do nothing! The industry&rsquo;s common solution is log rotate, which means that when the log file size reaches a certain size, the file is archived and a new file is created to continue writing, a process that is transparent to the application.</p>
<p>There are usually two kinds of log rotate solutions, one is an external solution based on the logrotate tool, and the other is a log library that supports rotation itself. <a href="https://github.com/uber-go/zap/issues/797">The compatibility of the zap library with the logrotate tool seems to be somewhat problematic</a>, zap <a href="https://github.com/uber-go/zap/blob/">the official FAQ also recommends the second option</a> master/FAQ.md#does-zap-support-log-rotation).</p>
<p>However, zap does not support rotate natively, but through an external package. zap provides a WriteSyncer interface that allows us to easily add rotate functionality to zap. Currently, natefinch&rsquo;s lumberjack is the most official package in terms of logrotate support, so let&rsquo;s see how to add logrotate to demo3&rsquo;s multiple log files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/demo4/pkg/log/log.go
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">RotateOptions</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">MaxSize</span>    <span class="kt">int</span>
    <span class="nx">MaxAge</span>     <span class="kt">int</span>
    <span class="nx">MaxBackups</span> <span class="kt">int</span>
    <span class="nx">Compress</span>   <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">TeeOption</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Filename</span> <span class="kt">string</span>
    <span class="nx">Ropt</span>     <span class="nx">RotateOptions</span>
    <span class="nx">Lef</span>      <span class="nx">LevelEnablerFunc</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewTeeWithRotate</span><span class="p">(</span><span class="nx">tops</span> <span class="p">[]</span><span class="nx">TeeOption</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cores</span> <span class="p">[]</span><span class="nx">zapcore</span><span class="p">.</span><span class="nx">Core</span>
    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">NewProductionConfig</span><span class="p">()</span>
    <span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">.</span><span class="nx">EncodeTime</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">enc</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">PrimitiveArrayEncoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">enc</span><span class="p">.</span><span class="nf">AppendString</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02T15:04:05.000Z0700&#34;</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">top</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tops</span> <span class="p">{</span>
        <span class="nx">top</span> <span class="o">:=</span> <span class="nx">top</span>

        <span class="nx">lv</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">LevelEnablerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">top</span><span class="p">.</span><span class="nf">Lef</span><span class="p">(</span><span class="nf">Level</span><span class="p">(</span><span class="nx">lvl</span><span class="p">))</span>
        <span class="p">})</span>

        <span class="nx">w</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lumberjack</span><span class="p">.</span><span class="nx">Logger</span><span class="p">{</span>
            <span class="nx">Filename</span><span class="p">:</span>   <span class="nx">top</span><span class="p">.</span><span class="nx">Filename</span><span class="p">,</span>
            <span class="nx">MaxSize</span><span class="p">:</span>    <span class="nx">top</span><span class="p">.</span><span class="nx">Ropt</span><span class="p">.</span><span class="nx">MaxSize</span><span class="p">,</span>
            <span class="nx">MaxBackups</span><span class="p">:</span> <span class="nx">top</span><span class="p">.</span><span class="nx">Ropt</span><span class="p">.</span><span class="nx">MaxBackups</span><span class="p">,</span>
            <span class="nx">MaxAge</span><span class="p">:</span>     <span class="nx">top</span><span class="p">.</span><span class="nx">Ropt</span><span class="p">.</span><span class="nx">MaxAge</span><span class="p">,</span>
            <span class="nx">Compress</span><span class="p">:</span>   <span class="nx">top</span><span class="p">.</span><span class="nx">Ropt</span><span class="p">.</span><span class="nx">Compress</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="nx">core</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewCore</span><span class="p">(</span>
            <span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewJSONEncoder</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">),</span>
            <span class="nx">zapcore</span><span class="p">.</span><span class="nf">AddSync</span><span class="p">(</span><span class="nx">w</span><span class="p">),</span>
            <span class="nx">lv</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nx">cores</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cores</span><span class="p">,</span> <span class="nx">core</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">logger</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">l</span><span class="p">:</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nf">NewTee</span><span class="p">(</span><span class="nx">cores</span><span class="o">...</span><span class="p">),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">logger</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We added RotateOptions to TeeOption (this binding is not necessary, of course) and used lumberjack.Logger as the io.Writer to pass to zapcore.AddSync, thus creating a logger with the ability to write multiple log files and giving each log file the ability to automatically rotate function.</p>
<p>We use this log in main.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage/main.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/bigwhite/zap-usage/pkg/log&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tops</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">log</span><span class="p">.</span><span class="nx">TeeOption</span><span class="p">{</span>
        <span class="p">{</span>
            <span class="nx">Filename</span><span class="p">:</span> <span class="s">&#34;access.log&#34;</span><span class="p">,</span>
            <span class="nx">Ropt</span><span class="p">:</span> <span class="nx">log</span><span class="p">.</span><span class="nx">RotateOptions</span><span class="p">{</span>
                <span class="nx">MaxSize</span><span class="p">:</span>    <span class="mi">1</span><span class="p">,</span>
                <span class="nx">MaxAge</span><span class="p">:</span>     <span class="mi">1</span><span class="p">,</span>
                <span class="nx">MaxBackups</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="nx">Compress</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="nx">Lef</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">lvl</span> <span class="o">&lt;=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">InfoLevel</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">Filename</span><span class="p">:</span> <span class="s">&#34;error.log&#34;</span><span class="p">,</span>
            <span class="nx">Ropt</span><span class="p">:</span> <span class="nx">log</span><span class="p">.</span><span class="nx">RotateOptions</span><span class="p">{</span>
                <span class="nx">MaxSize</span><span class="p">:</span>    <span class="mi">1</span><span class="p">,</span>
                <span class="nx">MaxAge</span><span class="p">:</span>     <span class="mi">1</span><span class="p">,</span>
                <span class="nx">MaxBackups</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="nx">Compress</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="nx">Lef</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">lvl</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Level</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">lvl</span> <span class="p">&gt;</span> <span class="nx">log</span><span class="p">.</span><span class="nx">InfoLevel</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">NewTeeWithRotate</span><span class="p">(</span><span class="nx">tops</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">ResetDefault</span><span class="p">(</span><span class="nx">logger</span><span class="p">)</span>

    <span class="c1">// 为了演示自动rotate效果，这里多次调用log输出
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">20000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;demo3:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;start ok&#34;</span><span class="p">),</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;major version&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;demo3:&#34;</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="s">&#34;crash&#34;</span><span class="p">),</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;reason&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Running the above main package, we will see the following output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">// demo4

$go run main.go
$ls -l
total 3680
drwxr-xr-x  10 tonybai  staff      320  7 11 12:54 ./
drwxr-xr-x   8 tonybai  staff      256  7 11 12:23 ../
-rw-r--r--   1 tonybai  staff     3938  7 11 12:54 access-2021-07-11T04-54-04.697.log.gz
-rw-r--r--   1 tonybai  staff  1011563  7 11 12:54 access.log
-rw-r--r--   1 tonybai  staff     3963  7 11 12:54 error-2021-07-11T04-54-04.708.log.gz
-rw-r--r--   1 tonybai  staff   851580  7 11 12:54 error.log
</code></pre></td></tr></table>
</div>
</div><p>We see that both access.log and error.log complete an automatic rotation after the size exceeds 1M, and the archived logs are compressed according to the previous configuration (compress).</p>
<h2 id="5-summary">5. Summary</h2>
<p>This article provides an in-depth explanation of how to use the zap log library, including a way to encapsulate zap so that we can output logs directly through package-level functions like the standard library log package without having to manage and pass logger variables; we can customize the zap encoder (time, whether to output caller, etc.); with NewTee we can create We can customize the zap encoder (time, whether to output caller, etc.); with NewTee, we can create loggers that write to multiple log files at once, and we can determine whether to accept writes by log level; finally, we make zap logs support automatic rotation.</p>
<p>If there is a shortcoming, it is that <a href="https://github.com/uber-go/zap/issues/870">zap does not support dynamically setting the log level of the global logger</a>, but there seems to be a third-party solution, so we won&rsquo;t go deeper here and leave it as a legacy issue.</p>
<p>The code involved in this article can be downloaded at <a href="https://github.com/bigwhite/experiments/tree/master/uber-zap-advanced-usage">here</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/go-metrics/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Using go-metrics to add metrics to Go applications</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/golang-plugin/">
            <span class="next-text nav-default">Figuring out the Golang plugin</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
