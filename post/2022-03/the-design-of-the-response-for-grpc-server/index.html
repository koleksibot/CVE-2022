<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Response design for gRPC services - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, we talked about gRPC server-side response design." /><meta name="keywords" content="golang, Grpc, Design, Response" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/the-design-of-the-response-for-grpc-server/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Response design for gRPC services" />
<meta property="og:description" content="In this article, we talked about gRPC server-side response design." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/the-design-of-the-response-for-grpc-server/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-26T11:20:36+08:00" />
<meta property="article:modified_time" content="2022-03-26T11:20:36+08:00" />

<meta itemprop="name" content="Response design for gRPC services">
<meta itemprop="description" content="In this article, we talked about gRPC server-side response design."><meta itemprop="datePublished" content="2022-03-26T11:20:36+08:00" />
<meta itemprop="dateModified" content="2022-03-26T11:20:36+08:00" />
<meta itemprop="wordCount" content="1911">
<meta itemprop="keywords" content="Grpc," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Response design for gRPC services"/>
<meta name="twitter:description" content="In this article, we talked about gRPC server-side response design."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Response design for gRPC services</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-26 11:20:36 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1911 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-status-of-server-side-response">1. Status of server-side response</a></li>
        <li><a href="#2-grpc-server-side-response-design-ideas">2. gRPC server-side response design ideas</a></li>
        <li><a href="#3-how-the-server-side-constructs-error-and-how-the-client-side-parses-error">3. How the server side constructs error and how the client side parses error</a></li>
        <li><a href="#4-empty-response">4. Empty response</a></li>
        <li><a href="#5-summary">5. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/cb81249bc8a044879fdf4686de7f5241.png" alt="gRPC"></p>
<h2 id="1-status-of-server-side-response">1. Status of server-side response</h2>
<p>Developers doing back-end services are always sensitive to error handling, so they will always be very careful when doing the service response (response/reply) design.</p>
<p>If the back-end service is selected from HTTP API (rest api), such as json over http, the API response (Response) will mostly contain the following information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;ok&#34;</span><span class="p">,</span>
    <span class="nt">&#34;payload&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="err">...</span> <span class="err">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the response design of this http api, the first two states identify the response status of the request. This status consists of a status code (code) and a status message (msg). The status message is a detailed explanation of the cause of the error corresponding to the status code. The payload follows only when the status is normal (code = 0), and the payload is obviously the business information intended to be passed to the client in the response.</p>
<p>Such a service response design is currently more common and mature program, it is also very easy to understand.</p>
<p>Okay, now let&rsquo;s look at another big class of services: services provided by RPC. Let&rsquo;s take the most widely used gRPC as an example. In gRPC, a service is defined as follows (let&rsquo;s borrow the <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld">helloworld example</a> provided by grpc-go).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.proto
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">helloworld</span><span class="p">;</span>

<span class="c1">// The greeting service definition.
</span><span class="c1"></span><span class="nx">service</span> <span class="nx">Greeter</span> <span class="p">{</span>
  <span class="c1">// Sends a greeting
</span><span class="c1"></span>  <span class="nx">rpc</span> <span class="nf">SayHello</span> <span class="p">(</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">HelloReply</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// The request message containing the user&#39;s name.
</span><span class="c1"></span><span class="nx">message</span> <span class="nx">HelloRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="nx">name</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The response message containing the greetings
</span><span class="c1"></span><span class="nx">message</span> <span class="nx">HelloReply</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="nx">message</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>grpc has a constraint for each rpc method (e.g. SayHello) that it can only have one input parameter and one return value. The go code generated by this .proto definition via protoc becomes this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld_grpc.pb.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">GreeterServer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Sends a greeting
</span><span class="c1"></span>    <span class="nf">SayHello</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="o">*</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="o">...</span> <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that for the SayHello RPC method, the go code generated by protoc has an additional error return value in the SayHello method&rsquo;s return value list that Gopher&rsquo;s are familiar with. For gophers who are used to the HTTP API response design, here&rsquo;s the problem! Is the code and msg in the http api response that represent the status of the response defined in the HelloReply business response data, or is it returned via error? This grpc official documentation does not seem to specify (if you find the location, you can tell me oh).</p>
<h2 id="2-grpc-server-side-response-design-ideas">2. gRPC server-side response design ideas</h2>
<p>We are not in a hurry to draw conclusions! We continue to borrow helloworld this sample program to test the response of the client when the error return value is not nil! First, change the code of <a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go">greeter_server</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SayHello implements helloworld.GreeterServer
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Received: %v&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">())</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="s">&#34;Hello &#34;</span> <span class="o">+</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">()},</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;test grpc error&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, we deliberately construct an error and return it to the client that called the method. Let&rsquo;s run the service and start <a href="https://github.com/grpc/grpc-go/tree/master/examples/helloworld/greeter_client">greeter_client</a> to access the service. On the client side, we get the following result are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">2021/09/20 17:04:35 could not greet: rpc error: <span class="nv">code</span> <span class="o">=</span> Unknown <span class="nv">desc</span> <span class="o">=</span> <span class="nb">test</span> grpc error
</code></pre></td></tr></table>
</div>
</div><p>From the output of the client, we see the content of our custom error (test grpc error). But we also find that the error output also has a &ldquo;code = Unknown&rdquo; output. It seems that grpc expects the error to be in the form of code and desc.</p>
<p>At this point, I have to check the <a href="https://pkg.go.dev/google.golang.org/grpc#section-readme">gprc-go (v1.40.0) reference documentation</a>! In the documentation of grpc-go we find several functions related to Error that are DEPRECATED.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/801d447a74f14d58bf02ac5f00e6ec11.png" alt="gprc-go (v1.40.0) reference documentation"></p>
<p>The documentation for these deprecated functions mentions replacing them with functions of the same name from the status package. So who is this status package? Looking through the source code of grpc-go, we finally found the status package, and we found the answer in the first sentence of the package description.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt">Package status implements errors returned by gRPC.
</code></pre></td></tr></table>
</div>
</div><p>It turns out that the status package implements the type of error expected by the grpc client above. So what does this type look like? Let&rsquo;s trace the code step by step.</p>
<p>In the grpc-go/status package we see the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Status</span> <span class="p">=</span> <span class="nx">status</span><span class="p">.</span><span class="nx">Status</span>

<span class="c1">// New returns a Status representing c and msg.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">c</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The status package uses Status from the internal/status package. Let&rsquo;s look again at the definition of the Status structure in the internal/status package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// internal/status
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Status</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">*</span><span class="nx">spb</span><span class="p">.</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// New returns a Status representing c and msg.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">c</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Status</span><span class="p">{</span><span class="nx">s</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">spb</span><span class="p">.</span><span class="nx">Status</span><span class="p">{</span><span class="nx">Code</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">Message</span><span class="p">:</span> <span class="nx">msg</span><span class="p">}}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Status structure of the internal/status package combines a field of type *spb.Status (the type in the google.golang.org/genproto/googleapis/rpc/statu s package). Continue tracing the spb.Status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://pkg.go.dev/google.golang.org/genproto/googleapis/rpc/status
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Status</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// The status code, which should be an enum value of [google.rpc.Code][google.rpc.Code].
</span><span class="c1"></span>    <span class="nx">Code</span> <span class="kt">int32</span> <span class="s">`protobuf:&#34;varint,1,opt,name=code,proto3&#34; json:&#34;code,omitempty&#34;`</span>
    <span class="c1">// A developer-facing error message, which should be in English. Any
</span><span class="c1"></span>    <span class="c1">// user-facing error message should be localized and sent in the
</span><span class="c1"></span>    <span class="c1">// [google.rpc.Status.details][google.rpc.Status.details] field, or localized by the client.
</span><span class="c1"></span>    <span class="nx">Message</span> <span class="kt">string</span> <span class="s">`protobuf:&#34;bytes,2,opt,name=message,proto3&#34; json:&#34;message,omitempty&#34;`</span>
    <span class="c1">// A list of messages that carry the error details.  There is a common set of
</span><span class="c1"></span>    <span class="c1">// message types for APIs to use.
</span><span class="c1"></span>    <span class="nx">Details</span> <span class="p">[]</span><span class="o">*</span><span class="nx">anypb</span><span class="p">.</span><span class="nx">Any</span> <span class="s">`protobuf:&#34;bytes,3,rep,name=details,proto3&#34; json:&#34;details,omitempty&#34;`</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that this last Status structure contains Code and Message, so it is clear that grpc is designed to expect the developer to include the response status of the rpc method in the return value of error, while the custom response structure only needs to contain the data required by the business. Let&rsquo;s use a diagram to establish the mapping between the http api and the rpc response horizontally.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/26/72db32a10c904f9bbf83f8bb65dad36a.png" alt="http api and the rpc response horizontally."></p>
<p>With this diagram in hand, we&rsquo;ll be well-equipped to face the problem of how to design grpc method responses!</p>
<p>grpc-go defines more than 10 error codes required by the grpc specification in the <a href="https://pkg.go.dev/google.golang.org/grpc@v1.40.0/codes#Code">codes package</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
    <span class="c1">// OK is returned on success.
</span><span class="c1"></span>    <span class="nx">OK</span> <span class="nx">Code</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="c1">// Canceled indicates the operation was canceled (typically by the caller).
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// The gRPC framework will generate this error code when cancellation
</span><span class="c1"></span>    <span class="c1">// is requested.
</span><span class="c1"></span>    <span class="nx">Canceled</span> <span class="nx">Code</span> <span class="p">=</span> <span class="mi">1</span>

    <span class="c1">// Unknown error. An example of where this error may be returned is
</span><span class="c1"></span>    <span class="c1">// if a Status value received from another address space belongs to
</span><span class="c1"></span>    <span class="c1">// an error-space that is not known in this address space. Also
</span><span class="c1"></span>    <span class="c1">// errors raised by APIs that do not return enough error information
</span><span class="c1"></span>    <span class="c1">// may be converted to this error.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// The gRPC framework will generate this error code in the above two
</span><span class="c1"></span>    <span class="c1">// mentioned cases.
</span><span class="c1"></span>    <span class="nx">Unknown</span> <span class="nx">Code</span> <span class="p">=</span> <span class="mi">2</span>

    <span class="c1">// InvalidArgument indicates client specified an invalid argument.
</span><span class="c1"></span>    <span class="c1">// Note that this differs from FailedPrecondition. It indicates arguments
</span><span class="c1"></span>    <span class="c1">// that are problematic regardless of the state of the system
</span><span class="c1"></span>    <span class="c1">// (e.g., a malformed file name).
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// This error code will not be generated by the gRPC framework.
</span><span class="c1"></span>    <span class="nx">InvalidArgument</span> <span class="nx">Code</span> <span class="p">=</span> <span class="mi">3</span>

    <span class="o">...</span> <span class="o">...</span>

    <span class="c1">// Unauthenticated indicates the request does not have valid
</span><span class="c1"></span>    <span class="c1">// authentication credentials for the operation.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// The gRPC framework will generate this error code when the
</span><span class="c1"></span>    <span class="c1">// authentication metadata is invalid or a Credentials callback fails,
</span><span class="c1"></span>    <span class="c1">// but also expect authentication middleware to generate it.
</span><span class="c1"></span>    <span class="nx">Unauthenticated</span> <span class="nx">Code</span> <span class="p">=</span> <span class="mi">16</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition to these standard error codes, we can also extend to define our own error codes and error descriptions.</p>
<h2 id="3-how-the-server-side-constructs-error-and-how-the-client-side-parses-error">3. How the server side constructs error and how the client side parses error</h2>
<p>As mentioned earlier, the gRPC server uses the last return value of the rpc method, error, to carry the response status. The <code>google.golang.org/grpc/status</code> package provides some convenient functions for constructing client-side parsable error, let&rsquo;s look at the following example (based on the above helloworld&rsquo;s <a href="https://github.com/grpc/grpc-go/">greeter_server</a>) blob/master/examples/helloworld/greeter_server/main.go) is modified).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Received: %v&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">())</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">InvalidArgument</span><span class="p">,</span> <span class="s">&#34;you have a wrong name: %s&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nf">GetName</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The status package provides a function similar to fmt.Errorf, so we can easily construct an error instance with code and msg and return it to the client.</p>
<p>The client can also parse out the information carried in the error through the functions provided by the status package, as shown in the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;tony&#34;</span><span class="p">)})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">errStatus</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Convert</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;SayHello return error: code: %d, msg: %s\n&#34;</span><span class="p">,</span> <span class="nx">errStatus</span><span class="p">.</span><span class="nf">Code</span><span class="p">(),</span> <span class="nx">errStatus</span><span class="p">.</span><span class="nf">Message</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Greeting: %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that: the information carried in the error returned by the rpc method that is not nil can be extracted very briefly by the status.Convert function.</p>
<h2 id="4-empty-response">4. Empty response</h2>
<p>The gRPC proto file specification requires that the definition of each rpc method must contain a return value, and the return value cannot be null, such as the SayHello method in the .proto file of the above helloworld project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>If you remove the HelloReply return value, then protoc will report an error when generating code!</p>
<p>But some methods do not need to return business data themselves, so we need to define an empty response message for them, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="kd">message</span> <span class="nc">Empty</span> <span class="p">{</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>Considering that every project has to repeat the wheel defined by Empty message above when it encounters an empty response, grpc officially provides an empty message that can be reused.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/empty.proto
</span><span class="c1"></span>
<span class="c1">// A generic empty message that you can re-use to avoid defining duplicated
</span><span class="c1">// empty messages in your APIs. A typical example is to use it as the request
</span><span class="c1">// or the response type of an API method. For instance:
</span><span class="c1">//
</span><span class="c1">//     service Foo {
</span><span class="c1">//       rpc Bar(google.protobuf.Empty) returns (google.protobuf.Empty);
</span><span class="c1">//     }
</span><span class="c1">//
</span><span class="c1">// The JSON representation for `Empty` is empty JSON object `{}`.
</span><span class="c1"></span><span class="nx">message</span> <span class="nx">Empty</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>We just need to import that empty.proto in the .proto file and use Empty, like the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xxx.proto
</span><span class="c1"></span>
<span class="nx">syntax</span> <span class="p">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span>

<span class="kn">import</span> <span class="s">&#34;google/protobuf/empty.proto&#34;</span><span class="p">;</span>

<span class="nx">service</span> <span class="nx">MyService</span> <span class="p">{</span>
    <span class="nx">rpc</span> <span class="nf">MyRPCMethod</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">google</span><span class="p">.</span><span class="nx">protobuf</span><span class="p">.</span><span class="nx">Empty</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Of course <code>google.protobuf.Empty</code> is not just for empty responses, but also for empty requests, which is left to you to complete on your own.</p>
<h2 id="5-summary">5. Summary</h2>
<p>In this article, we talked about gRPC server-side response design, the main point is to directly use the gRPC-generated rpc aspect of the error return value to indicate the response status of the rpc call, and not to repeat the code and msg fields in the custom Message structure to indicate the response status.</p>
<p>btw, to do the API error design, <a href="https://cloud.google.com/apis/design/errors">google this API design reference</a> is very good. You must have time to read it well.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/grpc/">Grpc</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/private-go-module/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Small company internal private Go module pulling solution</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/replace-empty-interface-with-any-first-after-switching-to-go-1-18/">
            <span class="next-text nav-default">The first thing to do after switching to Go 1.18: replace all interfaces{} with any</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
