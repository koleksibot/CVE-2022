<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A simple analysis of how the ElasticSearch Operator works - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="ElasticSearch Operator The core features of the current ElasticSearch Operator.
 Elasticsearch, Kibana and APM Server deployments TLS Certificates management Safe Elasticsearch cluster configuration &amp;amp; topology changes Persistent volumes usage Custom node configuration and attributes Secure settings keystore updates  Installation Installing ElasticSearch Operator is very simple, based on &amp;lsquo;all in one yaml&amp;rsquo;, quickly pulling up all the components of Operator and registering the CRD.
1  kubectl apply -f https://download." /><meta name="keywords" content="elasticsearch, Operator" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/elasticsearch-operator/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="A simple analysis of how the ElasticSearch Operator works" />
<meta property="og:description" content="ElasticSearch Operator The core features of the current ElasticSearch Operator.
 Elasticsearch, Kibana and APM Server deployments TLS Certificates management Safe Elasticsearch cluster configuration &amp; topology changes Persistent volumes usage Custom node configuration and attributes Secure settings keystore updates  Installation Installing ElasticSearch Operator is very simple, based on &lsquo;all in one yaml&rsquo;, quickly pulling up all the components of Operator and registering the CRD.
1  kubectl apply -f https://download." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/elasticsearch-operator/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-14T12:27:57+08:00" />
<meta property="article:modified_time" content="2022-03-14T12:27:57+08:00" />

<meta itemprop="name" content="A simple analysis of how the ElasticSearch Operator works">
<meta itemprop="description" content="ElasticSearch Operator The core features of the current ElasticSearch Operator.
 Elasticsearch, Kibana and APM Server deployments TLS Certificates management Safe Elasticsearch cluster configuration &amp; topology changes Persistent volumes usage Custom node configuration and attributes Secure settings keystore updates  Installation Installing ElasticSearch Operator is very simple, based on &lsquo;all in one yaml&rsquo;, quickly pulling up all the components of Operator and registering the CRD.
1  kubectl apply -f https://download."><meta itemprop="datePublished" content="2022-03-14T12:27:57+08:00" />
<meta itemprop="dateModified" content="2022-03-14T12:27:57+08:00" />
<meta itemprop="wordCount" content="2382">
<meta itemprop="keywords" content="elasticsearch," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A simple analysis of how the ElasticSearch Operator works"/>
<meta name="twitter:description" content="ElasticSearch Operator The core features of the current ElasticSearch Operator.
 Elasticsearch, Kibana and APM Server deployments TLS Certificates management Safe Elasticsearch cluster configuration &amp; topology changes Persistent volumes usage Custom node configuration and attributes Secure settings keystore updates  Installation Installing ElasticSearch Operator is very simple, based on &lsquo;all in one yaml&rsquo;, quickly pulling up all the components of Operator and registering the CRD.
1  kubectl apply -f https://download."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A simple analysis of how the ElasticSearch Operator works</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-14 12:27:57 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2382 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#elasticsearch-operator">ElasticSearch Operator</a>
          <ul>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#crd">CRD</a></li>
            <li><a href="#elasticsearch-cluster-demo">ElasticSearch Cluster Demo</a></li>
          </ul>
        </li>
        <li><a href="#operator-management-of-elasticsearch">Operator management of ElasticSearch</a>
          <ul>
            <li><a href="#cluster-creation">Cluster creation</a></li>
            <li><a href="#rolling-upgrades">Rolling Upgrades</a></li>
            <li><a href="#watch">Watch</a></li>
          </ul>
        </li>
        <li><a href="#operators-license-management">Operator&rsquo;s License Management</a>
          <ul>
            <li><a href="#license-validation-and-use">License validation and use</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="elasticsearch-operator">ElasticSearch Operator</h2>
<p>The core features of the current ElasticSearch Operator.</p>
<ul>
<li>Elasticsearch, Kibana and APM Server deployments</li>
<li>TLS Certificates management</li>
<li>Safe Elasticsearch cluster configuration &amp; topology changes</li>
<li>Persistent volumes usage</li>
<li>Custom node configuration and attributes</li>
<li>Secure settings keystore updates</li>
</ul>
<h3 id="installation">Installation</h3>
<p>Installing ElasticSearch Operator is very simple, based on &lsquo;all in one yaml&rsquo;, quickly pulling up all the components of Operator and registering the CRD.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl apply -f https://download.elastic.co/downloads/eck/1.1.2/all-in-one.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="crd">CRD</h3>
<p>Operator has registered three main CRDs: APM, ElasticSearch, Kibana.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">k get crd <span class="p">|</span> grep elastic
apmservers.apm.k8s.elastic.co                  2020-05-10T08:02:15Z
elasticsearches.elasticsearch.k8s.elastic.co   2020-05-10T08:02:15Z
kibanas.kibana.k8s.elastic.co                  2020-05-10T08:02:15Z
</code></pre></td></tr></table>
</div>
</div><h3 id="elasticsearch-cluster-demo">ElasticSearch Cluster Demo</h3>
<p>A complete ElasticSearch Cluster Yaml, including the creation of ES clusters, local PV and Kibana.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-stack</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch.k8s.elastic.co/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Elasticsearch</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-stack</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">7.6.2</span><span class="w">
</span><span class="w">  </span><span class="nt">nodeSets</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">    </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">node.master</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">node.data</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">node.ingest</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">node.store.allow_mmap</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kibana.k8s.elastic.co/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Kibana</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kibana</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-stack</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">7.6.2</span><span class="w">
</span><span class="w">  </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">elasticsearchRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">es-db-0</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/data/elastic/db-0&#34;</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">es-db-1</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/data/elastic/db-1&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="operator-management-of-elasticsearch">Operator management of ElasticSearch</h2>
<p>Like many declarative Api-based implementations of the Operator, the focus of the Elastic Operator revolves around the Reconcile function.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/c9b7a3c57ed24680b6ebd4f12af33f1b.png" alt="Operator management of ElasticSearch"></p>
<p>The Reconcile function completes the entire lifecycle management of the ES cluster, which is of interest to me and briefly explains the implementation of the following functions.</p>
<ol>
<li>configuration initialization and management</li>
<li>scale up and scale down of cluster nodes</li>
<li>lifecycle management of stateful applications</li>
</ol>
<h3 id="cluster-creation">Cluster creation</h3>
<p>After receiving an ElasticSearch CR, the Reconcile function first performs a number of legitimacy checks on the CR, starting with the Operator&rsquo;s control over the CR, including whether it has a pause flag and whether it meets the Operator&rsquo;s version restrictions. Once it passes, it calls internalReconcile for further processing.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/8850b93742874f4fa1cd1b3d3d1c66fa.png" alt="Cluster creation"></p>
<p>The internalReconcile function begins by focusing on checking the business legitimacy of ElasticSearch CRs by defining a number of <code>validations</code> that check the legitimacy of the parameters of the CRs that are about to perform subsequent operations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">validation</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Elasticsearch</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span>

<span class="c1">// validations are the validation funcs that apply to creates or updates
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">validations</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">validation</span><span class="p">{</span>
	<span class="nx">noUnknownFields</span><span class="p">,</span>
	<span class="nx">validName</span><span class="p">,</span>
	<span class="nx">hasMaster</span><span class="p">,</span>
	<span class="nx">supportedVersion</span><span class="p">,</span>
	<span class="nx">validSanIP</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">updateValidation</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Elasticsearch</span><span class="p">,</span> <span class="o">*</span><span class="nx">Elasticsearch</span><span class="p">)</span> <span class="nx">field</span><span class="p">.</span><span class="nx">ErrorList</span>

<span class="c1">// updateValidations are the validation funcs that only apply to updates
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">updateValidations</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">updateValidation</span><span class="p">{</span>
	<span class="nx">noDowngrades</span><span class="p">,</span>
	<span class="nx">validUpgradePath</span><span class="p">,</span>
	<span class="nx">pvcModification</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once the ES CR legitimacy check is passed, the real Reconcile logic begins.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/95109f50abf5454cb8505375c9eac52d.png" alt="ES CR legitimacy check"></p>
<p>I have divided the subsequent Driver operations into three parts.</p>
<ol>
<li>Reconcile Kubernetes Resource</li>
<li>Reconcile ElasticSearch Cluster Business Config &amp; Resource</li>
<li>Reconcile Node Spec</li>
</ol>
<p>The first step is to clean up the mismatched Kubernetes resources, then check and create the Script ConfigMap, and the two Services.</p>
<p>ElasticSearch will use two services, which are created and corrected in this step.</p>
<ul>
<li>TransportService: headless service, used by the es cluster zen discovery</li>
<li>ExternalService: L4 load balancing for es data nodes</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ k -n elastic-stack get svc
NAME                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
elasticsearch-es-http        ClusterIP   10.96.42.27     &lt;none&gt;        9200/TCP   103d
elasticsearch-es-transport   ClusterIP   None            &lt;none&gt;        9300/TCP   103d
</code></pre></td></tr></table>
</div>
</div><p>Script ConfigMap is an operation that surprised me, because ES Cluster is stateful, so there is part of the startup initialization and downtime wrap-up. Operator generates the relevant scripts and mounts them to the Pod via ConfigMap and executes them in the Pod&rsquo;s Lifecycle hook. The Operator renders three scripts, which are also self-explanatory in their naming:</p>
<ul>
<li><code>readiness-probe-script.sh</code></li>
<li><code>pre-stop-hook-script.sh</code></li>
<li><code>prepare-fs.sh</code></li>
</ul>
<p>After the K8s resources are created, other dependencies needed for the ES cluster to run, such as CAs and certificates, user and permission profiles, seed host configuration, etc., are created with the appropriate ConfigMap or Secret and are waiting to be injected into the Pod at startup.</p>
<p>In addition, the Operator also initializes the Observer here, which is a component that periodically polls the ES state and caches the latest state of the current Cluster, which is also a disguised implementation of Cluster Stat Watch, as will be explained later.</p>
<p>Once these startup dependencies are ready, all that remains is to create the specific resources to try to pull the Pod up.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/559a15edea7b4aaf92001d9a1a5f55e9.png" alt="Operator also initializes the Observer here"></p>
<p>Formal creation and correction of ES resources is done in two phases, with the watershed being the readiness of the ES Cluster (whether the ES cluster is accessible via Service).</p>
<p>The first phase starts with a construction security check.</p>
<ol>
<li>the local cache of resource objects meets expectations</li>
<li>whether the StatefulSet and Pods are in order (number of Generations and Pods)</li>
</ol>
<p>Then the expected StatefulSet &amp; Service resources are constructed according to the CR and the subsequent operation is to try to approximate the final state constructed here.</p>
<p>For the resources described in the end-state, the Operator will create a limited flow, which is a bit more complicated here, but the basic process is to gradually modify the number of copies of the StatefulSet until it reaches the expectation.</p>
<p>If there is an old Pod that needs to be updated, the Pod will be deleted by a simple and effective <code>delete po</code> to force the update. This is the end of the first phase, and the associated K8s resources are basically created.</p>
<p>However, the creation of the ES cluster is not yet complete. Once the Operator can access the ES cluster through the http client, the second phase of creation is performed.</p>
<p>The first step is to adjust the Zen Discovery configuration based on the current Master count and the Voting-related configuration.</p>
<p>Later on, we will scale down and roll upgrade, but the creation of the cluster is complete.</p>
<h3 id="rolling-upgrades">Rolling Upgrades</h3>
<p>Since ElasticSearch is a stateful application like a database, I am interested in ES cluster upgrades and subsequent lifecycle maintenance. In Reconcile Node Specs, Scale Up is relatively simple to do, thanks to ES&rsquo;s domain-based self-discovery via Zen, so new Pods are automatically added to the cluster when they are added to Endpoints.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/4a20c3d3dabd4b52a4fcf2313e90e316.png" alt="Rolling Upgrades"></p>
<p>However, since each node maintains part of the shard, node offline or node upgrade will involve the handling of shard data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">HandleDownscale</span><span class="p">(</span>
	<span class="nx">downscaleCtx</span> <span class="nx">downscaleContext</span><span class="p">,</span>
	<span class="nx">expectedStatefulSets</span> <span class="nx">sset</span><span class="p">.</span><span class="nx">StatefulSetList</span><span class="p">,</span>
	<span class="nx">actualStatefulSets</span> <span class="nx">sset</span><span class="p">.</span><span class="nx">StatefulSetList</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="nx">reconciler</span><span class="p">.</span><span class="nx">Results</span> <span class="p">{</span>
	<span class="nx">results</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">reconciler</span><span class="p">.</span><span class="nx">Results</span><span class="p">{}</span>

	<span class="c1">// make sure we only downscale nodes we&#39;re allowed to
</span><span class="c1"></span>	<span class="nx">downscaleState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newDownscaleState</span><span class="p">(</span><span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">k8sClient</span><span class="p">,</span> <span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">es</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">results</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// compute the list of StatefulSet downscales and deletions to perform
</span><span class="c1"></span>	<span class="nx">downscales</span><span class="p">,</span> <span class="nx">deletions</span> <span class="o">:=</span> <span class="nf">calculateDownscales</span><span class="p">(</span><span class="o">*</span><span class="nx">downscaleState</span><span class="p">,</span> <span class="nx">expectedStatefulSets</span><span class="p">,</span> <span class="nx">actualStatefulSets</span><span class="p">)</span>

	<span class="c1">// remove actual StatefulSets that should not exist anymore (already downscaled to 0 in the past)
</span><span class="c1"></span>	<span class="c1">// this is safe thanks to expectations: we&#39;re sure 0 actual replicas means 0 corresponding pods exist
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">deleteStatefulSets</span><span class="p">(</span><span class="nx">deletions</span><span class="p">,</span> <span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">k8sClient</span><span class="p">,</span> <span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">es</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">results</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// migrate data away from nodes that should be removed
</span><span class="c1"></span>	<span class="c1">// if leavingNodes is empty, it clears any existing settings
</span><span class="c1"></span>	<span class="nx">leavingNodes</span> <span class="o">:=</span> <span class="nf">leavingNodeNames</span><span class="p">(</span><span class="nx">downscales</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">migration</span><span class="p">.</span><span class="nf">MigrateData</span><span class="p">(</span><span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">parentCtx</span><span class="p">,</span> <span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">es</span><span class="p">,</span> <span class="nx">downscaleCtx</span><span class="p">.</span><span class="nx">esClient</span><span class="p">,</span> <span class="nx">leavingNodes</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">results</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">downscale</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">downscales</span> <span class="p">{</span>
		<span class="c1">// attempt the StatefulSet downscale (may or may not remove nodes)
</span><span class="c1"></span>		<span class="nx">requeue</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">attemptDownscale</span><span class="p">(</span><span class="nx">downscaleCtx</span><span class="p">,</span> <span class="nx">downscale</span><span class="p">,</span> <span class="nx">actualStatefulSets</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">results</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">requeue</span> <span class="p">{</span>
			<span class="c1">// retry downscaling this statefulset later
</span><span class="c1"></span>			<span class="nx">results</span><span class="p">.</span><span class="nf">WithResult</span><span class="p">(</span><span class="nx">defaultRequeue</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">results</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The logic of Scale Down, or downline nodes, is not complicated and still involves calculating the difference between the expected and current. Determine to what amount the StatefuleSet should adjust the replica.</p>
<p>If the replica is zero, the StatefulSet is deleted directly, if not, the node downs are started.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/849e7ee0c7804586b7d6be02f2cde092.png" alt="es"></p>
<p>The first step is to calculate which Nodes need to be taken offline, and then trigger the reallocation of shards through the setting api to exclude the Nodes that will be taken offline.</p>
<p>Finally, it checks if the shard in the Node is cleared, and if not, it requeue for the next processing, and if it is cleared, it starts the real update replica operation.</p>
<p>The first step is to calculate the old and new resources and clear the old ones. After the clearing is done, ShardsAllocation is opened via ES Client to ensure the recovery of shards in the Cluster.</p>
<h3 id="watch">Watch</h3>
<p>As mentioned above, the ElasticSearch Operator has a built-in Observer module that implements Watch for ES cluster state by polling.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/c58da7f0878d44e592bf19c29b6e845c.png" alt="ElasticSearch Operator has a built-in Observer module"></p>
<p>ObserverManager manages several Observer, each ES Cluster has a single instance of Observer and polls the state of ES Cluster regularly. If the state changes, it will trigger the registered listeners.</p>
<p>There is only one listener implemented, <code>healthChangeListener</code>, which is very simple, it is to send an event to the chan when it finds a state change, and the cluster health has changed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// healthChangeListener returns an OnObservation listener that feeds a generic
</span><span class="c1">// event when a cluster&#39;s observed health has changed.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">healthChangeListener</span><span class="p">(</span><span class="nx">reconciliation</span> <span class="kd">chan</span> <span class="nx">event</span><span class="p">.</span><span class="nx">GenericEvent</span><span class="p">)</span> <span class="nx">OnObservation</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cluster</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">previous</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">new</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// no-op if health hasn&#39;t change
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nf">hasHealthChanged</span><span class="p">(</span><span class="nx">previous</span><span class="p">,</span> <span class="nx">new</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="c1">// trigger a reconciliation event for that cluster
</span><span class="c1"></span>		<span class="nx">evt</span> <span class="o">:=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">GenericEvent</span><span class="p">{</span>
			<span class="nx">Meta</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
				<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
				<span class="nx">Name</span><span class="p">:</span>      <span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">}</span>
		<span class="nx">reconciliation</span> <span class="o">&lt;-</span> <span class="nx">evt</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The chan is related to the Watch capability provided by contoller-runtime, which triggers the Reconcile process started by the Operator when an event is posted. This enables the discovery of a change in the business state and the continuation of the CR to the Operator for correction.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Controller implements a Kubernetes API.  A Controller manages a work queue fed reconcile.Requests
</span><span class="c1">// from source.Sources.  Work is performed through the reconcile.Reconciler for each enqueued item.
</span><span class="c1">// Work typically is reads and writes Kubernetes objects to make the system state match the state specified
</span><span class="c1">// in the object Spec.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Controller</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Reconciler is called to reconcile an object by Namespace/Name
</span><span class="c1"></span>	<span class="nx">reconcile</span><span class="p">.</span><span class="nx">Reconciler</span>

	<span class="c1">// Watch takes events provided by a Source and uses the EventHandler to
</span><span class="c1"></span>	<span class="c1">// enqueue reconcile.Requests in response to the events.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Watch may be provided one or more Predicates to filter events before
</span><span class="c1"></span>	<span class="c1">// they are given to the EventHandler.  Events will be passed to the
</span><span class="c1"></span>	<span class="c1">// EventHandler if all provided Predicates evaluate to true.
</span><span class="c1"></span>	<span class="nf">Watch</span><span class="p">(</span><span class="nx">src</span> <span class="nx">source</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">eventhandler</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">EventHandler</span><span class="p">,</span> <span class="nx">predicates</span> <span class="o">...</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Predicate</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// Start starts the controller.  Start blocks until stop is closed or a
</span><span class="c1"></span>	<span class="c1">// controller has an error starting.
</span><span class="c1"></span>	<span class="nf">Start</span><span class="p">(</span><span class="nx">stop</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="operators-license-management">Operator&rsquo;s License Management</h2>
<p>ElasticSearch is a commercially licensed software, and the license management in Operator really gives me a new understanding of App On K8s license management.</p>
<p>At the end of last year, I was involved in the development of a K8s-based system, and I was confused about how to manage the license of a &ldquo;cloud operating system&rdquo; like K8s, and ES Operator gave me a concrete solution.</p>
<p>The first is the structure of the license, Operator defines two kinds of licenses, one is the license provided to ES Cluster, and this model will be applied to the ES cluster eventually.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// License models the Elasticsearch license applied to a cluster. Signature will be empty on reads. IssueDate,  ExpiryTime and Status can be empty on writes.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">License</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Status</span>             <span class="kt">string</span>     <span class="s">`json:&#34;status,omitempty&#34;`</span>
	<span class="nx">UID</span>                <span class="kt">string</span>     <span class="s">`json:&#34;uid&#34;`</span>
	<span class="nx">Type</span>               <span class="kt">string</span>     <span class="s">`json:&#34;type&#34;`</span>
	<span class="nx">IssueDate</span>          <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;issue_date,omitempty&#34;`</span>
	<span class="nx">IssueDateInMillis</span>  <span class="kt">int64</span>      <span class="s">`json:&#34;issue_date_in_millis&#34;`</span>
	<span class="nx">ExpiryDate</span>         <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;expiry_date,omitempty&#34;`</span>
	<span class="nx">ExpiryDateInMillis</span> <span class="kt">int64</span>      <span class="s">`json:&#34;expiry_date_in_millis&#34;`</span>
	<span class="nx">MaxNodes</span>           <span class="kt">int</span>        <span class="s">`json:&#34;max_nodes,omitempty&#34;`</span>
	<span class="nx">MaxResourceUnits</span>   <span class="kt">int</span>        <span class="s">`json:&#34;max_resource_units,omitempty&#34;`</span>
	<span class="nx">IssuedTo</span>           <span class="kt">string</span>     <span class="s">`json:&#34;issued_to&#34;`</span>
	<span class="nx">Issuer</span>             <span class="kt">string</span>     <span class="s">`json:&#34;issuer&#34;`</span>
	<span class="nx">StartDateInMillis</span>  <span class="kt">int64</span>      <span class="s">`json:&#34;start_date_in_millis&#34;`</span>
	<span class="nx">Signature</span>          <span class="kt">string</span>     <span class="s">`json:&#34;signature,omitempty&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The other is the License structure that is managed by the Operator, which performs verification and logical processing based on these models.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ElasticsearchLicense</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">License</span> <span class="nx">client</span><span class="p">.</span><span class="nx">License</span> <span class="s">`json:&#34;license&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">EnterpriseLicense</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">License</span> <span class="nx">LicenseSpec</span> <span class="s">`json:&#34;license&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">LicenseSpec</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Status</span>             <span class="kt">string</span>                 <span class="s">`json:&#34;status,omitempty&#34;`</span>
	<span class="nx">UID</span>                <span class="kt">string</span>                 <span class="s">`json:&#34;uid&#34;`</span>
	<span class="nx">Type</span>               <span class="nx">OperatorLicenseType</span>    <span class="s">`json:&#34;type&#34;`</span>
	<span class="nx">IssueDate</span>          <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>             <span class="s">`json:&#34;issue_date,omitempty&#34;`</span>
	<span class="nx">IssueDateInMillis</span>  <span class="kt">int64</span>                  <span class="s">`json:&#34;issue_date_in_millis&#34;`</span>
	<span class="nx">ExpiryDate</span>         <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>             <span class="s">`json:&#34;expiry_date,omitempty&#34;`</span>
	<span class="nx">ExpiryDateInMillis</span> <span class="kt">int64</span>                  <span class="s">`json:&#34;expiry_date_in_millis&#34;`</span>
	<span class="nx">MaxInstances</span>       <span class="kt">int</span>                    <span class="s">`json:&#34;max_instances,omitempty&#34;`</span>
	<span class="nx">MaxResourceUnits</span>   <span class="kt">int</span>                    <span class="s">`json:&#34;max_resource_units,omitempty&#34;`</span>
	<span class="nx">IssuedTo</span>           <span class="kt">string</span>                 <span class="s">`json:&#34;issued_to&#34;`</span>
	<span class="nx">Issuer</span>             <span class="kt">string</span>                 <span class="s">`json:&#34;issuer&#34;`</span>
	<span class="nx">StartDateInMillis</span>  <span class="kt">int64</span>                  <span class="s">`json:&#34;start_date_in_millis&#34;`</span>
	<span class="nx">Signature</span>          <span class="kt">string</span>                 <span class="s">`json:&#34;signature,omitempty&#34;`</span>
	<span class="nx">ClusterLicenses</span>    <span class="p">[]</span><span class="nx">ElasticsearchLicense</span> <span class="s">`json:&#34;cluster_licenses&#34;`</span>
	<span class="nx">Version</span>            <span class="kt">int</span>                    <span class="c1">// not marshalled but part of the signature
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="license-validation-and-use">License validation and use</h3>
<p>The Operator&rsquo;s License is simple but adequate (probably legal enough), and is done by the License Controller and ElasticSearch Controller together.</p>
<p>The License Controller watches the ElasticSearch CR, and after receiving a new event, it looks for a Secret containing a License under the same Namespace as the Operator, and looks for an available License based on the expiration time, ES version, and other information.</p>
<p>Then, using the public key injected at the compilation stage, the License is checked for signature, and if it passes, a specific Secret (Cluster Name with a fixed suffix) containing the License is created for the ElasticSearch CR.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/14/bda1f0c5858c4cbe9fba2ab8c2c2d968.png" alt="License validation and use"></p>
<p>The ElasticSearch Controller is the main controller that manages the life cycle of ElasticSearch and determines if the ES Cluster is ready after receiving events from the CR (Http requests can be made through the Service). If it is ready, it will look for the Secret containing the License according to the name convention, and if it exists, it will update the License through the Http Client.</p>
<h2 id="summary">Summary</h2>
<p>As a stateful application, ElasticSearch Operator not only manages K8s
In addition to managing K8s resources, the ElasticSearch Operator also uses the ES Client to complete lifecycle management through a babysitting service. This is a clever design, but it relies heavily on the ES Cluster&rsquo;s own self-management capabilities (e.g., rescheduling of data slices, self-discovery, etc.).</p>
<p>If the stateful application that needs to be managed does not have such perfect self-management capabilities, each correction operation will require multiple requeue reconcile to complete, which will inevitably make the recovery time long. For stateful applications, the longer the recovery time (downtime), the more damage is done. Perhaps it is a better direction to separate instance management (Pod management), and business management (application configuration and data recovery, etc.).</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/elasticsearch/">elasticsearch</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/go-timer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How Go timers are scheduled</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/microsoft-type-annotations-for-javascript/">
            <span class="next-text nav-default">Microsoft proposes to add type annotation to JavaScript natively</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
