<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go&#39;s distributed transaction framework - seata - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Seata Introduction Seata is a distributed transaction service open source by Ali , currently provides users with AT, TCC, SAGA, XA transaction mode , the overall use of a two-phase commit protocol. go version of seata-golang currently seems to implement only mysql AT, TCC mode , the author is not much updated now . Seata has several core roles. TC(Transaction Coordinator) - Transaction coordinator. (Maintains the state of global and" /><meta name="keywords" content="seata, golang" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/seata-golang/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go&#39;s distributed transaction framework - seata" />
<meta property="og:description" content="Seata Introduction Seata is a distributed transaction service open source by Ali , currently provides users with AT, TCC, SAGA, XA transaction mode , the overall use of a two-phase commit protocol. go version of seata-golang currently seems to implement only mysql AT, TCC mode , the author is not much updated now . Seata has several core roles. TC(Transaction Coordinator) - Transaction coordinator. (Maintains the state of global and" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/seata-golang/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-16T11:03:59+08:00" />
<meta property="article:modified_time" content="2022-03-16T11:03:59+08:00" />

<meta itemprop="name" content="Go&#39;s distributed transaction framework - seata">
<meta itemprop="description" content="Seata Introduction Seata is a distributed transaction service open source by Ali , currently provides users with AT, TCC, SAGA, XA transaction mode , the overall use of a two-phase commit protocol. go version of seata-golang currently seems to implement only mysql AT, TCC mode , the author is not much updated now . Seata has several core roles. TC(Transaction Coordinator) - Transaction coordinator. (Maintains the state of global and"><meta itemprop="datePublished" content="2022-03-16T11:03:59+08:00" />
<meta itemprop="dateModified" content="2022-03-16T11:03:59+08:00" />
<meta itemprop="wordCount" content="2687">
<meta itemprop="keywords" content="seata,golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go&#39;s distributed transaction framework - seata"/>
<meta name="twitter:description" content="Seata Introduction Seata is a distributed transaction service open source by Ali , currently provides users with AT, TCC, SAGA, XA transaction mode , the overall use of a two-phase commit protocol. go version of seata-golang currently seems to implement only mysql AT, TCC mode , the author is not much updated now . Seata has several core roles. TC(Transaction Coordinator) - Transaction coordinator. (Maintains the state of global and"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go&#39;s distributed transaction framework - seata</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-16 11:03:59 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2687 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#seata-introduction">Seata Introduction</a>
          <ul>
            <li><a href="#tc">TC</a></li>
            <li><a href="#tm">TM</a></li>
            <li><a href="#rm">RM</a></li>
          </ul>
        </li>
        <li><a href="#seata-golang">seata-golang</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="seata-introduction">Seata Introduction</h2>
<p>Seata is a distributed transaction service open source by Ali , currently provides users with AT, TCC, SAGA, XA transaction mode , the overall use of a two-phase commit protocol. go version of seata-golang currently seems to implement only mysql AT, TCC mode , the author is not much updated now .</p>
<p>Seata has several core roles.</p>
<ul>
<li>TC(Transaction Coordinator) - Transaction coordinator. (Maintains the state of global and branch transactions, drives global transaction commit or rollback)</li>
<li>TM(Transaction Manager) - Transaction Manager. (Defines the scope of global transactions: start global transactions, commit or rollback global transactions.)</li>
<li>RM(Resource Manager)-Resource Manager. (Manages resources for branch transaction processing, talks to TC to register branch transactions and report on the status of branch transactions, and drives branch transactions to commit or rollback)</li>
</ul>
<p>Of course, looking at it this way, it may not be very understandable, I take a diagram from the official website to explain.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/16/3a444ad3abb146698156635fb7e15ef7.png" alt="seata"></p>
<p>As you can see from the above diagram, the tasks that these three roles are responsible for are as follows.</p>
<h3 id="tc">TC</h3>
<ul>
<li>Maintains the global and branch transaction state, which needs to be stored.</li>
<li>When a distributed transaction is finished processing, it needs to be notified to each RM whether it is commit or rollback.</li>
</ul>
<h3 id="tm">TM</h3>
<ul>
<li>Request to TC to open a distributed transaction and get a globally unique distributed id.</li>
<li>Based on the feedback from each RM participating in the first phase of the distributed transaction, decide whether to request the TC to commit or rollback the distributed transaction in the second phase (in most scenarios, if either RM fails in the first phase, the distributed transaction fails)</li>
</ul>
<h3 id="rm">RM</h3>
<p>To put it plainly is to manage the various services involved in the distributed transaction (such as the classic order scenario involving: order services, inventory services, marketing services, etc.)</p>
<p>ps: personal feeling, here the RM is somewhat similar to the intermediate processing layer in microservices (professional terminology they call this bff-&gt;backend for fronted).</p>
<ul>
<li>One stage prepare behavior (active): each RM calls <strong>custom</strong> prepare logic.</li>
<li>Second stage commit behavior (passive trigger): If all RMs succeed in the first stage of this distributed transaction, TC invokes the commit logic of each RM <strong>custom</strong> after processing its own state change. (All RMs in the first phase are successful)</li>
<li>If any RM in the first phase of this distributed transaction fails, the TC invokes the rollback logic of each RM <strong>custom</strong> after processing its own state changes. (Any RM fails in the first phase)</li>
</ul>
<p>OK. Here you can see some details of seata-golang implementation, seata-golang underlying use gRPC for communication.</p>
<h2 id="seata-golang">seata-golang</h2>
<p>Let&rsquo;s look at the RM section structure first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ResourceManager</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">addressing</span>     <span class="kt">string</span> <span class="c1">//rm地址
</span><span class="c1"></span>	<span class="nx">rpcClient</span>      <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerServiceClient</span> <span class="c1">//rm rpc客户端
</span><span class="c1"></span>  <span class="nx">managers</span>       <span class="kd">map</span><span class="p">[</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchType</span><span class="p">]</span><span class="nx">ResourceManagerInterface</span> <span class="c1">//存储rm事务模式（比如TCC、AT等）
</span><span class="c1"></span>	<span class="nx">branchMessages</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span> <span class="c1">//存储将要向TC响应的消息
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ResourceManagerServiceClient</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="c1">// 和 TC 流数据交互接口
</span><span class="c1"></span>   <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">ResourceManagerService_BranchCommunicateClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
  <span class="c1">// 向TC 注册分支
</span><span class="c1"></span>   <span class="nf">BranchRegister</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">BranchRegisterRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchRegisterResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
  <span class="c1">//.....
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As for the managers, the major transaction patterns supported are stored (TCC, etc.), and each pattern only needs to implement this interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ResourceManagerInterface</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="c1">// 分支提交
</span><span class="c1"></span>	<span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
 <span class="c1">// 分支回退
</span><span class="c1"></span>	<span class="nf">BranchRollback</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
  <span class="c1">// ......
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Look at the structure of the TC section again (only the fields that will be involved will be kept, other details can be checked by yourself).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">TransactionCoordinator</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// ....
</span><span class="c1"></span>	<span class="nx">holder</span>             <span class="o">*</span><span class="nx">holder</span><span class="p">.</span><span class="nx">SessionHolder</span> <span class="c1">//数据存储
</span><span class="c1"></span>  <span class="c1">// ......
</span><span class="c1"></span>  <span class="nx">futures</span>            <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span> <span class="c1">//临时存储RM响应数据，有g在接受处理
</span><span class="c1"></span>  <span class="c1">// ......
</span><span class="c1"></span>	<span class="nx">callBackMessages</span>   <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span> <span class="c1">//临时存储TC即将向RM发送的消息,有格外g在发送数据
</span><span class="c1"></span><span class="p">}</span>


<span class="kd">type</span> <span class="nx">SessionHolder</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">manager</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">SessionManager</span>
<span class="p">}</span>


<span class="c1">// SessionManager stored the globalTransactions and branchTransactions.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SessionManager</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Add global session.
</span><span class="c1"></span>	<span class="nf">AddGlobalSession</span><span class="p">(</span><span class="nx">session</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c1">// Find global session.
</span><span class="c1"></span>	<span class="nf">FindGlobalSession</span><span class="p">(</span><span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span>

	<span class="c1">// Find global sessions list.
</span><span class="c1"></span>	<span class="nf">FindGlobalSessions</span><span class="p">(</span><span class="nx">statuses</span> <span class="p">[]</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>TC&rsquo;s storage of data currently supports mysql and pgsql, that is, the implementation of the SessionManager interface, and then injected into the SessionHolder&rsquo;s manager.</p>
<p>After the introduction of these two basic structures, remember what we said above about the relationship between them?</p>
<p>The second stage TC will inform RM whether to commit or rollback according to the current transaction status.</p>
<p>When the ResourceManager is initialized:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">InitResourceManager</span><span class="p">(</span><span class="nx">addressing</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerServiceClient</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">defaultResourceManager</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">ResourceManager</span><span class="p">{</span>
		<span class="nx">addressing</span><span class="p">:</span>     <span class="nx">addressing</span><span class="p">,</span>
		<span class="nx">rpcClient</span><span class="p">:</span>      <span class="nx">client</span><span class="p">,</span>
		<span class="nx">managers</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchType</span><span class="p">]</span><span class="nx">ResourceManagerInterface</span><span class="p">),</span>
		<span class="nx">branchMessages</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 会单独开启一个g调用
</span><span class="c1"></span>		<span class="nx">defaultResourceManager</span><span class="p">.</span><span class="nf">branchCommunicate</span><span class="p">()</span>
	<span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="o">*</span><span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">branchCommunicate</span><span class="p">()</span> <span class="p">{</span>
     <span class="c1">//省略代码。。。。。。。
</span><span class="c1"></span>      <span class="nx">stream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">rpcClient</span><span class="p">.</span><span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
      <span class="c1">// 省略代码
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We see that eventually a grpc interface branchCommunicate will be called for TC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">ResourceManagerService_BranchCommunicateClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ResourceManagerService_BranchCommunicateClient</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Send</span><span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">)</span> <span class="kt">error</span>
	<span class="nf">Recv</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientStream</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Corresponds to the server side.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">rpc</span> <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">BranchMessage</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">stream</span> <span class="nx">BranchMessage</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ResourceManagerService_BranchCommunicateServer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Send</span><span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">)</span> <span class="kt">error</span>
	<span class="nf">Recv</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerStream</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We know that gRPC has four basic communication modes.</p>
<ul>
<li>Unary mode (Unary RPC)</li>
<li>Server-side Streaming RPC (Server Sreaming RPC)</li>
<li>Client Streaming RPC (Client Streaming RPC)</li>
<li>Bidirectional Streaming RPC (Bidirectional Streaming RPC)</li>
</ul>
<p>If you want the stream form is also very simple, just add the stream tag in front of the corresponding request|response parameters in the proto method definition, then the interface is streamed. As for which stream, it depends on which side you add stream to, if both request and response are added, then it is a two-way stream.</p>
<p>Both the client and the server can send a request via stream.</p>
<p>When RM calls BranchCommunicate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="o">*</span><span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">branchCommunicate</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">{</span>
      <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">AppendToOutgoingContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;addressing&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">addressing</span><span class="p">)</span>
      <span class="c1">// 得到steam
</span><span class="c1"></span>      <span class="nx">stream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">rpcClient</span><span class="p">.</span><span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
      <span class="c1">// 即-&gt;
</span><span class="c1">//      type ResourceManagerService_BranchCommunicateClient interface {
</span><span class="c1">//       	Send(*BranchMessage) error
</span><span class="c1">//	      Recv() (*BranchMessage, error)
</span><span class="c1">//      	grpc.ClientStream
</span><span class="c1">//       }
</span><span class="c1"></span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
         <span class="k">continue</span>
      <span class="p">}</span>

      <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
      <span class="c1">// 另开一个g用来响应消息给TC
</span><span class="c1"></span>      <span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// 死循环
</span><span class="c1"></span>         <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
               <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
                  <span class="k">return</span>
               <span class="p">}</span>
               <span class="c1">// 如果branchMessages 有数据，说明是处理完tc的响应数据，通过send响应给tc
</span><span class="c1"></span>            <span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span><span class="p">:</span>
               <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>


<span class="c1">// 另一个死循环是用来接受从tc发送过来的数据
</span><span class="c1"></span>      <span class="k">for</span> <span class="p">{</span>
      <span class="c1">// 接受数据
</span><span class="c1"></span>         <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Recv</span><span class="p">()</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
            <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
            <span class="k">break</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
            <span class="k">break</span>
         <span class="p">}</span>
         <span class="c1">// 判断tc发送数据的类型，是提交分支事务类型还是回滚类型
</span><span class="c1"></span>         <span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">BranchMessageType</span> <span class="p">{</span>
         <span class="c1">// 如果是分支提交的消息
</span><span class="c1"></span>         <span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommit</span><span class="p">:</span>
            <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">{}</span>
            <span class="nx">data</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
               <span class="k">continue</span>
            <span class="p">}</span>
            <span class="c1">// 处理分支提交，得到处理结果
</span><span class="c1"></span>            <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="c1">// 再把处理完的结果包装一下塞到branchMessages等待发送出去
</span><span class="c1"></span>                  <span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
                     <span class="nx">ID</span><span class="p">:</span>                <span class="nx">msg</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
                     <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommitResult</span><span class="p">,</span>
                     <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1">// 如果是回滚的消息，本质上流程差不多
</span><span class="c1"></span>         <span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollback</span><span class="p">:</span>
            <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackRequest</span><span class="p">{}</span>
            <span class="nx">data</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
               <span class="k">continue</span>
            <span class="p">}</span>
            <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">BranchRollback</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
                     <span class="nx">ID</span><span class="p">:</span>                <span class="nx">msg</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
                     <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollBackResult</span><span class="p">,</span>
                     <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// 关闭流
</span><span class="c1"></span>      <span class="nx">err</span> <span class="p">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">CloseSend</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The final processing branch transaction calls manager.BranchCommit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// 根据事务模式调用对应的处理
</span><span class="c1"></span>	<span class="nx">rm</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">managers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">rm</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">{</span>
		<span class="nx">ResultCode</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResultCodeFailed</span><span class="p">,</span>
		<span class="nx">Message</span><span class="p">:</span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;there is no resource manager for %s&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Correspondingly, when TC is called by RM after BranchCommunicate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">tc</span> <span class="o">*</span><span class="nx">TransactionCoordinator</span><span class="p">)</span> <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerService_BranchCommunicateServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">addressing</span> <span class="kt">string</span>
	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>

	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
	<span class="nx">md</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">FromIncomingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
  
  <span class="c1">//省略一些无关代码
</span><span class="c1"></span>  <span class="c1">//............
</span><span class="c1"></span>	<span class="nx">addressing</span> <span class="p">=</span> <span class="nx">md</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;addressing&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

 <span class="c1">//这里很好懂吧
</span><span class="c1"></span>	<span class="nx">queue</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">callBackMessages</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">addressing</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">))</span>
	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">queue</span><span class="p">.(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">)</span>

  
  <span class="c1">// 单独一个g 运行
</span><span class="c1"></span>  <span class="c1">// 用来从callBackMessages中取数据发送给客户端
</span><span class="c1"></span>	<span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 死循环
</span><span class="c1"></span>		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
				<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
					<span class="k">return</span>
				<span class="p">}</span>
        <span class="c1">// 如果能拿到数据，说明有数据需要发送给客户端
</span><span class="c1"></span>			<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="nx">q</span><span class="p">:</span>
				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>

  <span class="c1">// 下面的死循环逻辑主要是从stearm 接受客户端响应数据，然后塞入到future中，根据唯一的branch_message_Id
</span><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">default</span><span class="p">:</span>
      <span class="c1">//有数据
</span><span class="c1"></span>			<span class="nx">branchMessage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Recv</span><span class="p">()</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
				<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
      <span class="c1">// 要区分是什么响应
</span><span class="c1"></span>      <span class="c1">// 根据是 事务commit的响应，还是对rollback的响应,交给不同逻辑处理。
</span><span class="c1"></span>			<span class="k">switch</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetBranchMessageType</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 分支事务提交的响应
</span><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommitResult</span><span class="p">:</span>
				<span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">{}</span>
				<span class="nx">data</span> <span class="o">:=</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
        <span class="c1">// 解析数据
</span><span class="c1"></span>				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
					<span class="k">continue</span>
				<span class="p">}</span>
        
        <span class="c1">// 说明发送commit的动作在等待响应
</span><span class="c1"></span>				<span class="nx">resp</span><span class="p">,</span> <span class="nx">loaded</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">loaded</span> <span class="p">{</span>
          <span class="c1">// 赋值响应数据
</span><span class="c1"></span>					<span class="nx">future</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.(</span><span class="o">*</span><span class="nx">common2</span><span class="p">.</span><span class="nx">MessageFuture</span><span class="p">)</span>
					<span class="nx">future</span><span class="p">.</span><span class="nx">Response</span> <span class="p">=</span> <span class="nx">response</span>
          <span class="c1">// 通知数据到了
</span><span class="c1"></span>					<span class="nx">future</span><span class="p">.</span><span class="nx">Done</span> <span class="o">&lt;-</span> <span class="kc">true</span>
					<span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
				<span class="p">}</span>
        <span class="c1">// 和上面差不多逻辑除了响应数据不同
</span><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollBackResult</span><span class="p">:</span>
				<span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackResponse</span><span class="p">{}</span>
				<span class="nx">data</span> <span class="o">:=</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
					<span class="k">continue</span>
				<span class="p">}</span>
				<span class="nx">resp</span><span class="p">,</span> <span class="nx">loaded</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">loaded</span> <span class="p">{</span>
					<span class="nx">future</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.(</span><span class="o">*</span><span class="nx">common2</span><span class="p">.</span><span class="nx">MessageFuture</span><span class="p">)</span>
					<span class="nx">future</span><span class="p">.</span><span class="nx">Response</span> <span class="p">=</span> <span class="nx">response</span>
					<span class="nx">future</span><span class="p">.</span><span class="nx">Done</span> <span class="o">&lt;-</span> <span class="kc">true</span>
					<span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>How does the data come from the above notifications to RM to commit or rollback?</p>
<p>When TC wants to notify RM of a branch commit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">tc</span> <span class="o">*</span><span class="nx">TransactionCoordinator</span><span class="p">)</span> <span class="nf">branchCommit</span><span class="p">(</span><span class="nx">bs</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">{</span>
      <span class="nx">XID</span><span class="p">:</span>             <span class="nx">bs</span><span class="p">.</span><span class="nx">XID</span><span class="p">,</span>
      <span class="nx">BranchID</span><span class="p">:</span>        <span class="nx">bs</span><span class="p">.</span><span class="nx">BranchID</span><span class="p">,</span>
      <span class="nx">ResourceID</span><span class="p">:</span>      <span class="nx">bs</span><span class="p">.</span><span class="nx">ResourceID</span><span class="p">,</span>
      <span class="nx">LockKey</span><span class="p">:</span>         <span class="nx">bs</span><span class="p">.</span><span class="nx">LockKey</span><span class="p">,</span>
      <span class="nx">BranchType</span><span class="p">:</span>      <span class="nx">bs</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
      <span class="nx">ApplicationData</span><span class="p">:</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">ApplicationData</span><span class="p">,</span>
   <span class="p">}</span>

   <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">err</span>
   <span class="p">}</span>
   <span class="nx">message</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
      <span class="nx">ID</span><span class="p">:</span>                <span class="nb">int64</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">idGenerator</span><span class="p">.</span><span class="nf">Inc</span><span class="p">()),</span>
      <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommit</span><span class="p">,</span>
      <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
   <span class="p">}</span>
  
    <span class="c1">//上面是封装数据
</span><span class="c1"></span>   <span class="nx">queue</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">callBackMessages</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">bs</span><span class="p">.</span><span class="nx">Addressing</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">))</span>
   <span class="nx">q</span> <span class="o">:=</span> <span class="nx">queue</span><span class="p">.(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">)</span>
   <span class="k">select</span> <span class="p">{</span>
     <span class="c1">// 在这把数据塞到callBackMessages
</span><span class="c1"></span>   <span class="k">case</span> <span class="nx">q</span> <span class="o">&lt;-</span> <span class="nx">message</span><span class="p">:</span>
   <span class="k">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">err</span>
   <span class="p">}</span>

  <span class="c1">// 这里创建了RM响应格式，根据 messageid，塞入到结果futures(sync.map中)，
</span><span class="c1"></span>   <span class="nx">resp</span> <span class="o">:=</span> <span class="nx">common2</span><span class="p">.</span><span class="nf">NewMessageFuture</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
   <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>

   <span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">streamMessageTimeout</span><span class="p">)</span>
   <span class="k">select</span> <span class="p">{</span>
     <span class="c1">// RM响应超时了，GG
</span><span class="c1"></span>   <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
      <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;wait branch commit response timeout&#34;</span><span class="p">)</span>
   <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Done</span><span class="p">:</span>
      <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
   <span class="p">}</span>

  <span class="c1">// 响应成功，解析数据处理。
</span><span class="c1"></span>   <span class="nx">response</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Response</span><span class="p">.(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">)</span>
   <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;rollback response: %v&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;response type not right&#34;</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">ResultCode</span> <span class="o">==</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResultCodeSuccess</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">BranchStatus</span><span class="p">,</span> <span class="kc">nil</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The last one is TM, not much difficulty in understanding.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// tm request to  tc
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">TransactionManagerInterface</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// GlobalStatus_Begin a new global transaction.
</span><span class="c1"></span>	<span class="nf">Begin</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">timeout</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Global commit.
</span><span class="c1"></span>	<span class="nf">Commit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Global rollback.
</span><span class="c1"></span>	<span class="nf">Rollback</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Get current status of the give transaction.
</span><span class="c1"></span>	<span class="nf">GetStatus</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Global report.
</span><span class="c1"></span>	<span class="nf">GlobalReport</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">globalStatus</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">TransactionManager</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">addressing</span> <span class="kt">string</span>
	<span class="nx">rpcClient</span>  <span class="nx">apis</span><span class="p">.</span><span class="nx">TransactionManagerServiceClient</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">InitTransactionManager</span><span class="p">(</span><span class="nx">addressing</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TransactionManagerServiceClient</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">defaultTransactionManager</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">TransactionManager</span><span class="p">{</span>
		<span class="nx">addressing</span><span class="p">:</span> <span class="nx">addressing</span><span class="p">,</span>
		<span class="nx">rpcClient</span><span class="p">:</span>  <span class="nx">client</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/seata/">seata</a>
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/linux-io-and-zero-copy/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Linux I/O Principles and Zero-copy Technology</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/cap/">
            <span class="next-text nav-default">Understanding of CAP theory</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
