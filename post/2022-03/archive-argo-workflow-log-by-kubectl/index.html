<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Automatically archiving argo workflow logs using kubectl - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The project uses argo-workflow as the workflow engine to orchestrate and run some hyperconverged cluster deployment related tasks, and the whole environment runs on a single node K3s. The main reason for choosing argo-workflow &#43; K3s is to consume as few system resources as possible, since this environment will run on various laptops with different hardware configurations in the future ðŸ˜‚. After researching some common K8s deployment tools, we finally chose K3s, which consumes less system resources." /><meta name="keywords" content="kubectl, Archive, argo-workflows, log" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/archive-argo-workflow-log-by-kubectl/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Automatically archiving argo workflow logs using kubectl" />
<meta property="og:description" content="The project uses argo-workflow as the workflow engine to orchestrate and run some hyperconverged cluster deployment related tasks, and the whole environment runs on a single node K3s. The main reason for choosing argo-workflow &#43; K3s is to consume as few system resources as possible, since this environment will run on various laptops with different hardware configurations in the future ðŸ˜‚. After researching some common K8s deployment tools, we finally chose K3s, which consumes less system resources." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/archive-argo-workflow-log-by-kubectl/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-07T09:46:51+08:00" />
<meta property="article:modified_time" content="2022-03-07T09:46:51+08:00" />

<meta itemprop="name" content="Automatically archiving argo workflow logs using kubectl">
<meta itemprop="description" content="The project uses argo-workflow as the workflow engine to orchestrate and run some hyperconverged cluster deployment related tasks, and the whole environment runs on a single node K3s. The main reason for choosing argo-workflow &#43; K3s is to consume as few system resources as possible, since this environment will run on various laptops with different hardware configurations in the future ðŸ˜‚. After researching some common K8s deployment tools, we finally chose K3s, which consumes less system resources."><meta itemprop="datePublished" content="2022-03-07T09:46:51+08:00" />
<meta itemprop="dateModified" content="2022-03-07T09:46:51+08:00" />
<meta itemprop="wordCount" content="866">
<meta itemprop="keywords" content="kubectl,argo-workflows," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automatically archiving argo workflow logs using kubectl"/>
<meta name="twitter:description" content="The project uses argo-workflow as the workflow engine to orchestrate and run some hyperconverged cluster deployment related tasks, and the whole environment runs on a single node K3s. The main reason for choosing argo-workflow &#43; K3s is to consume as few system resources as possible, since this environment will run on various laptops with different hardware configurations in the future ðŸ˜‚. After researching some common K8s deployment tools, we finally chose K3s, which consumes less system resources."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Automatically archiving argo workflow logs using kubectl</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-07 09:46:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 866 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kubectl">kubectl</a>
          <ul>
            <li><a href="#filtering-pods">Filtering pods</a></li>
            <li><a href="#get-the-log">Get the log</a></li>
            <li><a href="#workflow">workflow</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The project uses <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> as the workflow engine to orchestrate and run some <a href="https://www.smartx.com/solution/virtualization/">hyperconverged</a> cluster deployment related tasks, and the whole environment runs on a single node K3s. The main reason for choosing argo-workflow + K3s is to consume as few system resources as possible, since this environment will run on various laptops with different hardware configurations in the future ðŸ˜‚. After researching some common K8s deployment tools, we finally chose K3s, which consumes less system resources.</p>
<p>One of the requirements of the project is that we need to archive the workflow logs after a cluster deployment completes or fails. While it is possible to use <code>archiveLogs: true</code> in the spec field of workflow to have argo automatically archive the logs for us, this feature relies on an S3 object store <a href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/">Artifact Repository</a>. This means deploying another component that supports S3 object stores like <a href="https://min.io/">Minio</a> &hellip;</p>
<p>In fact, this requirement is very simple, I just want to save a log file, you still let me install a <a href="https://min.io/">Minio</a>, it is too much! Originally, the system&rsquo;s resources are very limited, and need to minimize the installation of some unnecessary dependencies, in order to minimize resource utilization. But now in order to archive a log file storage and go to great lengths to install a minio is really not cost-effective. It&rsquo;s like going through the trouble of deploying a 3-node kubernetes cluster just to run a static blog ðŸ˜‚</p>
<blockquote>
<p>Deployed my blog on Kubernetes <a href="https://t.co/XHXWLrmYO4">pic.twitter.com/XHXWLrmYO4</a></p>
<p>â€” For DevOps Eyes Only (@dexhorthy) <a href="https://twitter.com/dexhorthy/status/856639005462417409?ref_src=twsrc%5Etfw">April 24, 2017</a></p>
</blockquote>
<p>For poor kids like us who can&rsquo;t afford to use S3 object storage, it&rsquo;s better to think of some other ways, after all, do it yourself and eat well.</p>
<h2 id="kubectl">kubectl</h2>
<p>It&rsquo;s relatively easy to implement, and for YAML engineers like us, kubectl is naturally familiar. To get the workflow logs, you just need to use the kubectl logs command to get the pod logs created by the workflow, no need for S3 object storage ðŸ˜–.</p>
<h3 id="filtering-pods">Filtering pods</h3>
<p>For the same workflow, the pod name created by each stage has a certain pattern. When defining a workflow, the <a href="https://argoproj.github.io/argo-workflows/fields/#objectmeta">generateName</a> parameter is usually in the <code>${name}-</code> format. With <code>-</code> as a separator, the last field is a randomly generated numeric ID, the penultimate field is the randomly generated workflow ID from argo, and the remaining preceding characters are the generateName we defined.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Workflow</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">generateName</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">archive-log-test-jzt8n-3498199655                          0/2     Completed   0               4m18s
archive-log-test-jzt8n-3618624526                          0/2     Completed   0               4m8s
archive-log-test-jzt8n-2123203324                          0/2     Completed   0               3m58s
</code></pre></td></tr></table>
</div>
</div><p>The labels of the pod also contain the ID of the workflow, so we can filter out the pods created by the workflow based on these labels.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">workflows.argoproj.io/node-id</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-jzt8n-3498199655</span><span class="w">
</span><span class="w">    </span><span class="nt">workflows.argoproj.io/node-name</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-jzt8n[0].list-default-running-pods</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2022-02-28T12:53:32Z&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">workflows.argoproj.io/completed</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">workflows.argoproj.io/workflow</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-jzt8n</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-jzt8n-3498199655</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">ownerReferences</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span><span class="w">    </span><span class="nt">blockOwnerDeletion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Workflow</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-jzt8n</span><span class="w">
</span><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">e91df2cb-b567-4cf0-9be5-3dd6c72854cd</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1251330&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">ce37a709-8236-445b-8d00-a7926fa18ed0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Filter out pods created by a workflow by <code>-l lables</code>; sort by creation time by <code>-sort-by</code>; output only the name of the pod by <code>-o name</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ kubectl get pods -l workflows.argoproj.io/workflow=archive-log-test-jzt8n --sort-by=&#39;.metadata.creationTimestamp&#39; -o name
pod/archive-log-test-jzt8n-3498199655
pod/archive-log-test-jzt8n-3618624526
pod/archive-log-test-jzt8n-2123203324
</code></pre></td></tr></table>
</div>
</div><h3 id="get-the-log">Get the log</h3>
<p>We can get the list of pods created by a workflow by following the steps above. Then we can use the kubectl logs command to get the logs of the main container in the pod. To distinguish the workflow corresponding to the logs, we will use the workflow ID as the prefix name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl logs archive-log-test-jzt8n-3618624526 -c main
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">LOG_PATH</span><span class="o">=</span>/var/log
<span class="nv">NAME</span><span class="o">=</span>archive-log-test-jzt8n
kubectl get pods -l workflows.argoproj.io/workflow<span class="o">=</span><span class="si">${</span><span class="nv">NAME</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>--sort-by<span class="o">=</span><span class="s1">&#39;.metadata.creationTimestamp&#39;</span> -o name <span class="se">\
</span><span class="se"></span><span class="p">|</span> xargs -I <span class="o">{}</span> -t kubectl logs <span class="o">{}</span> -c main &gt;&gt; <span class="si">${</span><span class="nv">LOG_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">NAME</span><span class="si">}</span>.log
</code></pre></td></tr></table>
</div>
</div><h3 id="workflow">workflow</h3>
<p>According to the official <a href="https://github.com/argoproj/argo-workflows/blob/master/examples/exit-handlers.yaml"><strong>exit-handlers.yaml</strong></a> provided by argo-workflow example, we&rsquo;ll make a step that automatically calls the workflow logs using kubectl after workflow exits, and define the exit-handler as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exit-handler</span><span class="w">
</span><span class="w">    </span><span class="nt">container</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubectl&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">lachlanevenson/k8s-kubectl:v1.23.2</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">sh</span><span class="w">
</span><span class="w">        </span>- -<span class="l">c</span><span class="w">
</span><span class="w">        </span>- <span class="p">|</span><span class="sd">
</span><span class="sd">          kubectl get pods -l workflows.argoproj.io/workflow=${POD_NAME%-*} \
</span><span class="sd">          --sort-by=&#34;.metadata.creationTimestamp&#34; -o name | grep -v ${POD_NAME} \
</span><span class="sd">          | xargs -I {} -t kubectl logs {} -c main &gt;&gt; ${LOG_PATH}/${POD_NAME%-*}.log</span><span class="w">          
</span><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">LOG_PATH</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/workflow</span><span class="w">
</span><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-datastore</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/workflow</span><span class="w">
</span><span class="w">    </span><span class="nt">retryStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">limit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">retryPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span><span class="w"></span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test</span><span class="w">
</span><span class="w"></span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-datastore</span><span class="w">
</span><span class="w">    </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">NFS_SERVER</span><span class="w">
</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data/workflow/log</span><span class="w">
</span><span class="w"></span><span class="nt">onExit</span><span class="p">:</span><span class="w"> </span><span class="l">exit-handler</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Just copy and paste the <code>exit-handler</code> defined above into your workflow spec configuration. Since the logs need to be stored persistently, I am using NFS storage here, but you can change to other storage if you want, just change the <code>volumes</code> configuration.</p>
<p>The complete <a href="https://gist.github.com/muzi502/9b26c6854c509c42ecd7f7004436ca23">workflow example</a> is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Workflow</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">generateName</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test-</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test</span><span class="w">
</span><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- - <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">list-default-running-pods</span><span class="w">
</span><span class="w">            </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl</span><span class="w">
</span><span class="w">            </span><span class="nt">arguments</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">namespace</span><span class="w">
</span><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">        </span>- - <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">list-kube-system-running-pods</span><span class="w">
</span><span class="w">            </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl</span><span class="w">
</span><span class="w">            </span><span class="nt">arguments</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">namespace</span><span class="w">
</span><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl</span><span class="w">
</span><span class="w">      </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">namespace</span><span class="w">
</span><span class="w">      </span><span class="nt">container</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubectl&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">lachlanevenson/k8s-kubectl:v1.23.2</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">sh</span><span class="w">
</span><span class="w">          </span>- -<span class="l">c</span><span class="w">
</span><span class="w">          </span>- <span class="p">|</span><span class="sd">
</span><span class="sd">            </span><span class="w">            </span><span class="l">kubectl get pods --field-selector=status.phase=Running -n {{inputs.parameters.namespace}}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">exit-handler</span><span class="w">
</span><span class="w">      </span><span class="nt">container</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubectl&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">lachlanevenson/k8s-kubectl:v1.23.2</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">sh</span><span class="w">
</span><span class="w">          </span>- -<span class="l">c</span><span class="w">
</span><span class="w">          </span>- <span class="p">|</span><span class="sd">
</span><span class="sd">            kubectl get pods -l workflows.argoproj.io/workflow=${POD_NAME%-*} \
</span><span class="sd">            --sort-by=&#34;.metadata.creationTimestamp&#34; -o name | grep -v ${POD_NAME} \
</span><span class="sd">            | xargs -I {} -t kubectl logs {} -c main &gt;&gt; ${LOG_PATH}/${POD_NAME%-*}.log</span><span class="w">            
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span><span class="w">            </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">LOG_PATH</span><span class="w">
</span><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/workflow</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-datastore</span><span class="w">
</span><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/workflow</span><span class="w">
</span><span class="w">      </span><span class="nt">retryStrategy</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">limit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">retryPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span><span class="w">  </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">archive-log-test</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-datastore</span><span class="w">
</span><span class="w">      </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">NFS_SERVER</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data/workflow/log</span><span class="w">
</span><span class="w">  </span><span class="nt">onExit</span><span class="p">:</span><span class="w"> </span><span class="l">exit-handler</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>s</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubectl/">kubectl</a>
          <a href="/tags/argo-workflows/">argo-workflows</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/js-prototype-chains/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Understanding of JS prototype chains</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/qdir-stdfilesystem/">
            <span class="next-text nav-default">A simple comparison of QDir and std::filesystem</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
