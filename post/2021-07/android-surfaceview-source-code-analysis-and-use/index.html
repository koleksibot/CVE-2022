<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Android Surfaceview Source Code Analysis and Use - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="SurfaceView is a special kind of view in Android. The biggest difference between it and TextView and Button is that it is not on the same view layer as its view container, and its UI display can be done in a separate thread, so the drawing of SurfaceView does not affect the main thread. surfaceView does not affect the main thread. Combining these features, SurfaceView is generally used to implement dynamic or complex images and animations." /><meta name="keywords" content="android,Surfaceview" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-07/android-surfaceview-source-code-analysis-and-use/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Android Surfaceview Source Code Analysis and Use" />
<meta property="og:description" content="SurfaceView is a special kind of view in Android. The biggest difference between it and TextView and Button is that it is not on the same view layer as its view container, and its UI display can be done in a separate thread, so the drawing of SurfaceView does not affect the main thread. surfaceView does not affect the main thread. Combining these features, SurfaceView is generally used to implement dynamic or complex images and animations." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-07/android-surfaceview-source-code-analysis-and-use/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-14T09:32:08+08:00" />
<meta property="article:modified_time" content="2021-07-14T09:32:08+08:00" />

<meta itemprop="name" content="Android Surfaceview Source Code Analysis and Use">
<meta itemprop="description" content="SurfaceView is a special kind of view in Android. The biggest difference between it and TextView and Button is that it is not on the same view layer as its view container, and its UI display can be done in a separate thread, so the drawing of SurfaceView does not affect the main thread. surfaceView does not affect the main thread. Combining these features, SurfaceView is generally used to implement dynamic or complex images and animations."><meta itemprop="datePublished" content="2021-07-14T09:32:08+08:00" />
<meta itemprop="dateModified" content="2021-07-14T09:32:08+08:00" />
<meta itemprop="wordCount" content="2232">
<meta itemprop="keywords" content="android ," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Android Surfaceview Source Code Analysis and Use"/>
<meta name="twitter:description" content="SurfaceView is a special kind of view in Android. The biggest difference between it and TextView and Button is that it is not on the same view layer as its view container, and its UI display can be done in a separate thread, so the drawing of SurfaceView does not affect the main thread. surfaceView does not affect the main thread. Combining these features, SurfaceView is generally used to implement dynamic or complex images and animations."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Android Surfaceview Source Code Analysis and Use</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-07-14 09:32:08 </span>
        <div class="post-category">
            <a href="/categories/android/"> android </a>
            <a href="/categories/implementation-details/"> implementation-details </a>
            </div>
          <span class="more-meta"> 2232 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#mvc-framework-for-surfaceview">MVC framework for SurfaceView</a></li>
        <li><a href="#application-scenarios">Application Scenarios</a></li>
        <li><a href="#analyze-the-source-code">Analyze the source code</a>
          <ul>
            <li><a href="#surface">Surface</a></li>
            <li><a href="#surfaceholder">SurfaceHolder</a></li>
            <li><a href="#surfaceview">SurfaceView</a></li>
          </ul>
        </li>
        <li><a href="#using-surfaceview">Using SurfaceView</a>
          <ul>
            <li><a href="#example">Example</a></li>
          </ul>
        </li>
        <li><a href="#some-problems-that-may-be-encountered">Some problems that may be encountered</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>SurfaceView is a special kind of view in Android. The biggest difference between it and TextView and Button is that it is not on the same view layer as its view container, and its UI display can be done in a separate thread, so the drawing of SurfaceView does not affect the main thread. surfaceView does not affect the main thread. Combining these features, SurfaceView is generally used to implement dynamic or complex images and animations.</p>
<h2 id="mvc-framework-for-surfaceview">MVC framework for SurfaceView</h2>
<p>The relationship between Surface, SurfaceHolder, and SurfaceView is essentially what is known as MVC, or Model-View-Controller. Model means model, or data model, or more simply, data, which is Surface in this case; View means view, which represents the user interaction interface, which is SurfaceView in this case; SurfaceHolder can obviously be understood as the Controller in MVC. (controller).</p>
<h2 id="application-scenarios">Application Scenarios</h2>
<p>Unlike normal controls, SurfaceView can run outside the main thread and does not need to respond to user input in a timely manner, nor does it cause ANR problems. surfaceView is generally used for complex UI and efficient image display for games, video, photography, etc., which require a separate thread for image processing.</p>
<h2 id="analyze-the-source-code">Analyze the source code</h2>
<p>Analyze the Surface, SurfaceHolder, and SurfaceView classes</p>
<h3 id="surface">Surface</h3>
<p>android.view.SurfaceView</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm"> * Handle onto a raw buffer that is being managed by the screen compositor.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Surface</span> <span class="kd">implements</span> <span class="n">Parcelable</span> <span class="o">{</span>  
    <span class="c1">// code......
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>First, look at the Surface class, which implements the Parcelable interface for serialization (here it is mainly used to pass surface objects between processes) and is used to handle the data in the screen display buffer, which is commented in the source code as: Handle onto a raw buffer that is being managed by the screen compositor. Surface is a handle to a raw buffer that is being managed by the screen compositor.</p>
<p>A handle to the raw buffer managed by the screen compositor (similar to a handle) - Explanation of the term: Handle, English: HANDLE, the memory address of a data object is obtained after it enters memory, but the memory address is not fixed and a handle is needed to store the memory address where the content is located. In terms of data type it is just a 32-bit (or 64-bit) unsigned integer. - Surface acts as a handle to get the source buffer and its contents - the raw buffer is used to store the pixel data of the current window - so it is clear that Surface is the place for drawing in Android, specifically it is the Canvas in Surface Surface defines the Canvas object related to the canvas</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">Canvas</span> <span class="n">mCanvas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompatibleCanvas</span><span class="o">();</span>  
</code></pre></td></tr></table>
</div>
</div><p>Java, drawing is usually done on a Canvas object, Surface also contains a Canvas object, here CompatibleCanvas is an internal class in Surface.java, which contains a matrix object Matrix (variable name mOrigMatrix). The Matrix Matrix is a memory area where all the drawing operations for the View are stored.
Surface has an internal class CompatibleCanvas, which is designed to be compatible with Android screens of various resolutions and to handle different image data according to the resolution of different screens.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CompatibleCanvas</span> <span class="kd">extends</span> <span class="n">Canvas</span> <span class="o">{</span>  
        <span class="c1">// A temp matrix to remember what an application obtained via {@link getMatrix}
</span><span class="c1"></span>        <span class="kd">private</span> <span class="n">Matrix</span> <span class="n">mOrigMatrix</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMatrix</span><span class="o">(</span><span class="n">Matrix</span> <span class="n">matrix</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCompatibleMatrix</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mOrigMatrix</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mOrigMatrix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">matrix</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// don&#39;t scale the matrix if it&#39;s not compatibility mode, or
</span><span class="c1"></span>                <span class="c1">// the matrix was obtained from getMatrix.
</span><span class="c1"></span>                <span class="kd">super</span><span class="o">.</span><span class="na">setMatrix</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">Matrix</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Matrix</span><span class="o">(</span><span class="n">mCompatibleMatrix</span><span class="o">);</span>
                <span class="n">m</span><span class="o">.</span><span class="na">preConcat</span><span class="o">(</span><span class="n">matrix</span><span class="o">);</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">setMatrix</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getMatrix</span><span class="o">(</span><span class="n">Matrix</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">getMatrix</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mOrigMatrix</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mOrigMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Matrix</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">mOrigMatrix</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="two-important-methods">Two important methods</h4>
<p>It is important to note that the lockCanvas is not the lockCanvas and unlockCanvasAndPost methods that are called by the SurfaceHolder object when the SurfaceView is actually used for drawing. The methods used in the actual example are wrapped inside the SurfaceView after wrapping these two methods. - lockCanvas(&hellip;) + Gets a Canvas object for drawing into this surface. + After drawing into the provided Canvas, the caller must invoke After drawing into the provided Canvas, the caller must invoke unlockCanvasAndPost to post the new contents to the surface. After drawing a frame of data, the unlockCanvasAndPost method needs to be called to unlock the canvas and then post the drawn image to the current screen. When a Canvas is being drawn, it is locked, meaning it must wait for the frame being drawn to finish and unlock the canvas before doing anything else + The actual locking of the Canvas is done at the jni level - unlockCanvasAndPost(&hellip;) + Posts the new contents of the Canvas to the surface and releases the Canvas. The actual release process is done at the jni layer)</p>
<p>Surface&rsquo;s lockCanvas and unlockCanvasAndPost methods end up calling the jni layer methods to handle the process.
/frameworks/native/libs/gui/Surface.cpp /frameworks/base/core/jni/android_view_Surface.cpp</p>
<h3 id="surfaceholder">SurfaceHolder</h3>
<p>SurfaceHolder SurfaceHolder is actually an interface that acts as a controller.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SurfaceHolder</span> <span class="o">{</span>  
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="lets-see-what-the-commentary-says">Let&rsquo;s see what the commentary says</h4>
<ul>
<li>Abstract interface to someone holding a display surface.</li>
<li>Allows you to control the surface size and format, edit the pixels in the surface, and monitor changes to the surface. The bare bones Controller role that controls the size and format of the Surface, monitors changes to the Surface (and handles changes to the Surface in a callback function)</li>
<li>When using this interface from a thread other than the one running its SurfaceView, you will want to carefully read the methods - When using this interface from a thread other than the one running its SurfaceView, you will want to carefully read the methods of Callback.surfaceCreated() If you are using a subthread to handle the drawing of the SurfaceView, you will need to use the surfaceCreated method of the key interface Callback, which is described next. As you can see in the example given earlier, the thread that draws the animation is opened in the surfaceCreated method</li>
</ul>
<h4 id="critical-interfaces-callback">Critical Interfaces Callback</h4>
<p>Callback is an interface inside the SurfaceHolder, which is implemented in the example to control the thread that draws the animation.
There are three methods in the interface - <code>public void surfaceCreated(SurfaceHolder holder); + Surface</code> is called the first time it is created, for example when the SurfaceView goes from the invisible state to the visible state + Between the time this method is called and the time the Surface objects can be manipulated between the time this method is called and the time the surfaceDestroyed method is called, which in the case of SurfaceView means that if the SurfaceView is visible on the interface, it can be drawn and animated + Another thing to note here is that Surface If you have already rendered the data in another thread, you don&rsquo;t need to open a thread here to draw the Surface - <code>public void surfaceChanged(SurfaceHolder holder, int format, int width, int height);</code> + The surface will be called when the size and format change, for example, if you need to handle Sufface images and animations when switching between horizontal and vertical screens, you need to implement it here + This method will be called at least once after the surfaceCreated - <code>public void surfaceDestroyed(SurfaceHolder holder); + Surface</code> is called when it is destroyed, e.g. when the SurfaceView is invisible from the visible state + After this method is called, no more operations can be performed on the Surface object. So you need to make sure that the drawing thread does not operate on the Surface after this method is called, otherwise it will report an error</p>
<h3 id="surfaceview">SurfaceView</h3>
<p>android.view.SurfaceView</p>
<p>SurfaceView, which is the View used to display the Surface data, is used to see the Surface data through the SurfaceView.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SurfaceView</span> <span class="kd">extends</span> <span class="n">View</span> <span class="o">{</span>  
    <span class="c1">// code.....
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="analyze-the-comments-on-the-surfaceview-in-the-source-code">Analyze the comments on the SurfaceView in the source code</h4>
<ul>
<li>Provides a dedicated drawing surface embedded inside of a view hierarchy.</li>
<li>the SurfaceView punches a hole in its window to allow its surface to be displayed. SurfaceView</li>
<li>The Surface will be created for you while the SurfaceView&rsquo;s window is visible.</li>
<li>you should implement SurfaceHolder.Callback#surfaceCreated and SurfaceHolder.Callback#surfaceDestroyed to discover when the Surface is created and destroyed as the window is shown and hidden.</li>
</ul>
<h2 id="using-surfaceview">Using SurfaceView</h2>
<p>The example shows how to use the SurfaceView</p>
<ol>
<li>you need to implement the <code>SurfaceHolder.Callback</code> interface</li>
<li>Callback<code>in the</code>surfaceCreated<code>method of</code>SurfaceHolder.<code>Callback</code> to open a thread to draw the animation frame by frame.</li>
<li>you need to end the drawing thread in the <code>surfaceDestroyed</code> method of <code>SurfaceHolder.Callback</code> and call the <code>removeCallbck</code> method of <code>SurfaceHolder</code>.</li>
<li>the <code>lockCanvas</code> method needs to be called before each frame of the drawing thread starts to lock the canvas for drawing</li>
<li>After drawing a frame of data, you need to call the <code>unlockCanvasAndPost</code> method to submit the data to display the image</li>
</ol>
<h3 id="example">Example</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.Bitmap</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.Canvas</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.Color</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.Paint</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.Paint.Style</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.graphics.drawable.BitmapDrawable</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.view.SurfaceHolder</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.view.SurfaceView</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.view.KeyEvent</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.view.MotionEvent</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">android.view.SurfaceHolder.Callback</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySurfaceView</span> <span class="kd">extends</span> <span class="n">SurfaceView</span> <span class="kd">implements</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">SurfaceHolder</span><span class="o">.</span><span class="na">Callback</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="n">SurfaceHolder</span> <span class="n">mHolder</span><span class="o">;</span> <span class="c1">// Used to control SurfaceView
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Thread</span> <span class="n">t</span><span class="o">;</span> <span class="c1">// Declare a thread
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">flag</span><span class="o">;</span> <span class="c1">// Identifier of the thread running, used to control the thread
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Canvas</span> <span class="n">mCanvas</span><span class="o">;</span> <span class="c1">// Declare a canvas
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Paint</span> <span class="n">p</span><span class="o">;</span> <span class="c1">// Declare a paintbrush
</span><span class="c1"></span>    <span class="kt">float</span> <span class="n">m_circle_r</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MySurfaceView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

        <span class="n">mHolder</span> <span class="o">=</span> <span class="n">getHolder</span><span class="o">();</span> <span class="c1">// Get SurfaceHolder object
</span><span class="c1"></span>        <span class="n">mHolder</span><span class="o">.</span><span class="na">addCallback</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">// Adding a state listener to SurfaceView
</span><span class="c1"></span>        <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Paint</span><span class="o">();</span> <span class="c1">// Create a brush object
</span><span class="c1"></span>        <span class="n">p</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">WHITE</span><span class="o">);</span> <span class="c1">// Set the color of the brush to white
</span><span class="c1"></span>        <span class="n">setFocusable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// Set Focus
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * This function is called when the SurfaceView is created
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceCreated</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">// Create a thread object
</span><span class="c1"></span>        <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Set the thread run flag to true
</span><span class="c1"></span>        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// Start threads
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Call this function when the SurfaceView&#39;s view changes
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceChanged</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">format</span><span class="o">,</span> <span class="kt">int</span> <span class="n">width</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * This function is called when the SurfaceView is destroyed
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">surfaceDestroyed</span><span class="o">(</span><span class="n">SurfaceHolder</span> <span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Set the thread run flag to false
</span><span class="c1"></span>        <span class="n">mHolder</span><span class="o">.</span><span class="na">removeCallback</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Called when the screen is touched
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTouchEvent</span><span class="o">(</span><span class="n">MotionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Called when the user presses a key
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onKeyDown</span><span class="o">(</span><span class="kt">int</span> <span class="n">keyCode</span><span class="o">,</span> <span class="n">KeyEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">keyCode</span> <span class="o">==</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">KEYCODE_DPAD_UP</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onKeyDown</span><span class="o">(</span><span class="n">keyCode</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onKeyUp</span><span class="o">(</span><span class="kt">int</span> <span class="n">keyCode</span><span class="o">,</span> <span class="n">KeyEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">surfaceDestroyed</span><span class="o">(</span><span class="n">mHolder</span><span class="o">);</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onKeyDown</span><span class="o">(</span><span class="n">keyCode</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mHolder</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">100</span><span class="o">);</span> <span class="c1">// Let threads rest for 100 milliseconds
</span><span class="c1"></span>                    <span class="n">Draw</span><span class="o">();</span> <span class="c1">// Calling custom drawing methods
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mCanvas</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// mHolder.unlockCanvasAndPost(mCanvas);//End the lock drawing and commit the changes.
</span><span class="c1"></span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Customize a method to draw a circle on the canvas
</span><span class="cm">     */</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">Draw</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mCanvas</span> <span class="o">=</span> <span class="n">mHolder</span><span class="o">.</span><span class="na">lockCanvas</span><span class="o">();</span> <span class="c1">// Get the canvas object and start drawing on the canvas
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mCanvas</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Paint</span> <span class="n">paint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Paint</span><span class="o">(</span><span class="n">Paint</span><span class="o">.</span><span class="na">ANTI_ALIAS_FLAG</span><span class="o">);</span>
            <span class="n">paint</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>
            <span class="n">paint</span><span class="o">.</span><span class="na">setStrokeWidth</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
            <span class="n">paint</span><span class="o">.</span><span class="na">setStyle</span><span class="o">(</span><span class="n">Style</span><span class="o">.</span><span class="na">FILL</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">m_circle_r</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="n">getWidth</span><span class="o">()</span> <span class="o">/</span> <span class="n">10</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">m_circle_r</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">m_circle_r</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">Bitmap</span> <span class="n">pic</span> <span class="o">=</span> <span class="o">((</span><span class="n">BitmapDrawable</span><span class="o">)</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getDrawable</span><span class="o">(</span>
                    <span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">qq</span><span class="o">)).</span><span class="na">getBitmap</span><span class="o">();</span>
            <span class="n">mCanvas</span><span class="o">.</span><span class="na">drawBitmap</span><span class="o">(</span><span class="n">pic</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">8</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>
                    <span class="n">mCanvas</span><span class="o">.</span><span class="na">drawCircle</span><span class="o">(</span>
                            <span class="o">(</span><span class="n">getWidth</span><span class="o">()</span> <span class="o">/</span> <span class="n">5</span><span class="o">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="o">(</span><span class="n">getWidth</span><span class="o">()</span> <span class="o">/</span> <span class="n">10</span><span class="o">),</span>
                            <span class="o">(</span><span class="n">getHeight</span><span class="o">()</span> <span class="o">/</span> <span class="n">8</span><span class="o">)</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="o">(</span><span class="n">getHeight</span><span class="o">()</span> <span class="o">/</span> <span class="n">16</span><span class="o">),</span>
                            <span class="n">m_circle_r</span><span class="o">,</span> <span class="n">paint</span><span class="o">);</span>
            <span class="n">mHolder</span><span class="o">.</span><span class="na">unlockCanvasAndPost</span><span class="o">(</span><span class="n">mCanvas</span><span class="o">);</span> <span class="c1">// Complete the drawing and display the canvas on the screen
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="some-problems-that-may-be-encountered">Some problems that may be encountered</h2>
<p>Why does a SurfaceView display a black area when placed in a layout file without a task image drawn?</p>
<p>The reason for this phenomenon can be seen in the draw and dispatchDraw methods of the SurfaceView, where the windownType variable is initialized to WindowManager. MEDIA, so the entire Canvas will be painted black during the process of creating and drawing this View</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Default value of windowType
</span><span class="c1"></span><span class="kt">int</span> <span class="n">mWindowType</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_APPLICATION_MEDIA</span><span class="o">;</span>

<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">draw</span><span class="o">(</span><span class="n">Canvas</span> <span class="n">canvas</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mWindowType</span> <span class="o">!=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_APPLICATION_PANEL</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// draw() is not called when SKIP_DRAW is set
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="n">PFLAG_SKIP_DRAW</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// punch a whole in the view-hierarchy below us
</span><span class="c1"></span>                <span class="n">canvas</span><span class="o">.</span><span class="na">drawColor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">PorterDuff</span><span class="o">.</span><span class="na">Mode</span><span class="o">.</span><span class="na">CLEAR</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">draw</span><span class="o">(</span><span class="n">canvas</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><hr>
<p>Reference <code>https://tech.youzan.com/surfaceview-sourcecode/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/android/">android </a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-07/the-type-system-of-javascript/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The Type System of Javascript</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-07/web-worker-tutorial/">
            <span class="next-text nav-default">Web Worker Tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
