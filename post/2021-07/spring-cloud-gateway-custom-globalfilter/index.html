<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Cloud Gateway Custom Globalfilter - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The scope of GlobalFilter is all the routing configuration, we can do additional extensions by customizing GlobalFilter, which can be used to implement some global functions.
How to customize GlobalFilter The interface definition for org.springframework.cloud.gateway.filter.GlobalFilter is as follows.
1 2 3 4  public interface GlobalFilter { Mono&amp;lt;Void&amp;gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); }   We just need to implement the org.springframework.cloud.gateway.filter.GlobalFilter interface and register the implementation class in Spring&amp;rsquo;s container, the official example is as follows." /><meta name="keywords" content="spring-cloud-gateway,Globalfilter,spring-cloud" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-custom-globalfilter/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Cloud Gateway Custom Globalfilter" />
<meta property="og:description" content="The scope of GlobalFilter is all the routing configuration, we can do additional extensions by customizing GlobalFilter, which can be used to implement some global functions.
How to customize GlobalFilter The interface definition for org.springframework.cloud.gateway.filter.GlobalFilter is as follows.
1 2 3 4  public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); }   We just need to implement the org.springframework.cloud.gateway.filter.GlobalFilter interface and register the implementation class in Spring&rsquo;s container, the official example is as follows." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-custom-globalfilter/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-02T11:05:59+08:00" />
<meta property="article:modified_time" content="2021-07-02T11:05:59+08:00" />

<meta itemprop="name" content="Spring Cloud Gateway Custom Globalfilter">
<meta itemprop="description" content="The scope of GlobalFilter is all the routing configuration, we can do additional extensions by customizing GlobalFilter, which can be used to implement some global functions.
How to customize GlobalFilter The interface definition for org.springframework.cloud.gateway.filter.GlobalFilter is as follows.
1 2 3 4  public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); }   We just need to implement the org.springframework.cloud.gateway.filter.GlobalFilter interface and register the implementation class in Spring&rsquo;s container, the official example is as follows."><meta itemprop="datePublished" content="2021-07-02T11:05:59+08:00" />
<meta itemprop="dateModified" content="2021-07-02T11:05:59+08:00" />
<meta itemprop="wordCount" content="671">
<meta itemprop="keywords" content="spring-cloud,spring-cloud-gateway," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Cloud Gateway Custom Globalfilter"/>
<meta name="twitter:description" content="The scope of GlobalFilter is all the routing configuration, we can do additional extensions by customizing GlobalFilter, which can be used to implement some global functions.
How to customize GlobalFilter The interface definition for org.springframework.cloud.gateway.filter.GlobalFilter is as follows.
1 2 3 4  public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); }   We just need to implement the org.springframework.cloud.gateway.filter.GlobalFilter interface and register the implementation class in Spring&rsquo;s container, the official example is as follows."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Cloud Gateway Custom Globalfilter</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-07-02 11:05:59 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/microservices/"> microservices </a>
            </div>
          <span class="more-meta"> 671 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#how-to-customize-globalfilter">How to customize GlobalFilter</a></li>
        <li><a href="#practices">Practices</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/07/02/e206c56471b1463b85e5477dec6788d9.png" alt=" "></p>
<p>The scope of <code>GlobalFilter</code> is all the routing configuration, we can do additional extensions by customizing <code>GlobalFilter</code>, which can be used to implement some global functions.</p>
<h2 id="how-to-customize-globalfilter">How to customize GlobalFilter</h2>
<p>The interface definition for <code>org.springframework.cloud.gateway.filter.GlobalFilter</code> is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GlobalFilter</span> <span class="o">{</span>

    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">);</span>
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>We just need to implement the <code>org.springframework.cloud.gateway.filter.GlobalFilter</code> interface and register the implementation class in Spring&rsquo;s container, the official example is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="nd">@Order</span><span class="o">(-</span><span class="n">1</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">GlobalFilter</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;first pre filter&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;third post filter&#34;</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">};</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="nd">@Order</span><span class="o">(</span><span class="n">0</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">GlobalFilter</span> <span class="nf">b</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;second pre filter&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;second post filter&#34;</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">};</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="nd">@Order</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">GlobalFilter</span> <span class="nf">c</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;third pre filter&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;first post filter&#34;</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">};</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="practices">Practices</h2>
<p>We implement a custom <code>GlobalFilter</code> to achieve similar functionality to <code>Nginx</code>&rsquo;s <code>Access Log</code>, that is, to log some core parameters of the request and some core parameters of the response for each request. Note that the <code>GlobalFilter</code> we implement is of type <code>pre</code> and type <code>post</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessLogGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">();</span>
        <span class="n">InetSocketAddress</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="n">HttpStatus</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;requestPath:{},remoteIP :{},statusCode:{}&#34;</span><span class="o">,</span> <span class="n">path</span><span class="o">,</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">statusCode</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the example above, we only printed.</p>
<ul>
<li>The path of the request.</li>
<li>The remote IP address of the request.</li>
<li>The response code.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">curl http://localhost:9090/order/remote
</code></pre></td></tr></table>
</div>
</div><p>The log output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2019-05-04 19:13:19.101  INFO 25388 --- [ctor-http-nio-7] c.t.route.support.AccessLogGlobalFilter  : requestPath:/order/remote,remoteIP :/0:0:0:0:0:0:0:1:63861,statusCode:200 OK
</code></pre></td></tr></table>
</div>
</div><p>This is obviously not detailed enough, so we then try to add the following parameters.</p>
<ul>
<li>If it is a GET request, then extract its Query parameters, and if it is a POST request, then try to read the RequestBody parameters and print the parameters of the request.</li>
<li>RequestMethod.</li>
<li>TargetURI.</li>
</ul>
<p>Modify the code as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessLogGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DataBufferFactory</span> <span class="n">dataBufferFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NettyDataBufferFactory</span><span class="o">(</span><span class="n">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">();</span>
        <span class="n">HttpMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>
        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">URI</span> <span class="n">targetUri</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ServerWebExchangeUtils</span><span class="o">.</span><span class="na">GATEWAY_REQUEST_URL_ATTR</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">queryParams</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getQueryParams</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">queryParams</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JsonProcessingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
            <span class="n">ServerHttpRequest</span> <span class="n">serverHttpRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getURI</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
            <span class="n">body</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">dataBuffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">dataBuffer</span><span class="o">.</span><span class="na">asInputStream</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">StreamUtils</span><span class="o">.</span><span class="na">copyToString</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="c1">// Rewrite the request body, because the request data can only be consumed once
</span><span class="c1"></span>            <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpRequestDecorator</span><span class="o">(</span><span class="n">serverHttpRequest</span><span class="o">)</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">dataBufferFactory</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)));</span>
                <span class="o">}</span>
            <span class="o">};</span>
        <span class="o">}</span>
        <span class="n">InetSocketAddress</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">build</span><span class="o">()).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="n">HttpStatus</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;requestPath:{},remoteIP :{},requestMethod:{},requestParam:{},targetURI:{},statusCode:{}&#34;</span><span class="o">,</span>
                    <span class="n">path</span><span class="o">,</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">targetUri</span><span class="o">,</span> <span class="n">statusCode</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">curl -X POST -d <span class="s2">&#34;name=doge&#34;</span> localhost:9090/order/remote
</code></pre></td></tr></table>
</div>
</div><p>Since the downstream service only accepts GET method requests, the gateway prints the log as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">requestPath:/order/remote,remoteIP :/0:0:0:0:0:0:0:1:65158,requestMethod:POST,requestParam:name=doge,targetURI:http://localhost:9091/order/remote,statusCode:405 METHOD_NOT_ALLOWED
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>In fact, since <code>GlobalFilter</code> will take effect for all routing configurations, we extend it to achieve the general global functionality. The above example involves redecorating the request object, and the operation of parsing the request parameters will have some performance loss, depending on the actual application scenario.</p>
<hr>
<p>Reference <code>https://www.throwx.cn/2019/05/05/spring-cloud-gateway-custom-global-filter/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring-cloud/">spring-cloud</a>
          <a href="/tags/spring-cloud-gateway/">spring-cloud-gateway</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-07/spring-cloud-gateway-guide/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Spring Cloud Gateway Guide</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-07/pulsar-getting-started-and-introduction/">
            <span class="next-text nav-default">Pulsar Getting Started and Introduction</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
