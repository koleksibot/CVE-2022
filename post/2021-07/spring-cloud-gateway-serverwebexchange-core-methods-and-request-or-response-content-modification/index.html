<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Cloud Gateway-ServerWebExchange Core Methods and Request or Response Content Modification - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Prerequisites This article was written using Spring Cloud Gateway version Greenwich.SR1. When we use Spring Cloud Gateway, we notice that the filters (including GatewayFilter, GlobalFilter and the filter chain GatewayFilterChain), all depend on the ServerWebExchange. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface GlobalFilter { Mono&amp;lt;Void&amp;gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); } public interface GatewayFilter extends ShortcutConfigurable { Mono&amp;lt;Void&amp;gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);" /><meta name="keywords" content="spring-cloud-gateway,Content,Modification" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-serverwebexchange-core-methods-and-request-or-response-content-modification/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Cloud Gateway-ServerWebExchange Core Methods and Request or Response Content Modification" />
<meta property="og:description" content="Prerequisites This article was written using Spring Cloud Gateway version Greenwich.SR1. When we use Spring Cloud Gateway, we notice that the filters (including GatewayFilter, GlobalFilter and the filter chain GatewayFilterChain), all depend on the ServerWebExchange. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); } public interface GatewayFilter extends ShortcutConfigurable { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-serverwebexchange-core-methods-and-request-or-response-content-modification/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-08T15:12:02+08:00" />
<meta property="article:modified_time" content="2021-07-08T15:12:02+08:00" />

<meta itemprop="name" content="Spring Cloud Gateway-ServerWebExchange Core Methods and Request or Response Content Modification">
<meta itemprop="description" content="Prerequisites This article was written using Spring Cloud Gateway version Greenwich.SR1. When we use Spring Cloud Gateway, we notice that the filters (including GatewayFilter, GlobalFilter and the filter chain GatewayFilterChain), all depend on the ServerWebExchange. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); } public interface GatewayFilter extends ShortcutConfigurable { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);"><meta itemprop="datePublished" content="2021-07-08T15:12:02+08:00" />
<meta itemprop="dateModified" content="2021-07-08T15:12:02+08:00" />
<meta itemprop="wordCount" content="13142">
<meta itemprop="keywords" content="spring-cloud,spring-cloud-gateway," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Cloud Gateway-ServerWebExchange Core Methods and Request or Response Content Modification"/>
<meta name="twitter:description" content="Prerequisites This article was written using Spring Cloud Gateway version Greenwich.SR1. When we use Spring Cloud Gateway, we notice that the filters (including GatewayFilter, GlobalFilter and the filter chain GatewayFilterChain), all depend on the ServerWebExchange. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface GlobalFilter { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain); } public interface GatewayFilter extends ShortcutConfigurable { Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Cloud Gateway-ServerWebExchange Core Methods and Request or Response Content Modification</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-07-08 15:12:02 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/microservices/"> microservices </a>
            </div>
          <span class="more-meta"> 13142 words </span>
          <span class="more-meta"> 27 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#prerequisites">Prerequisites</a></li>
        <li><a href="#understanding-serverwebexchange">Understanding ServerWebExchange</a>
          <ul>
            <li><a href="#serverwebexchange-interface">ServerWebExchange Interface</a></li>
            <li><a href="#serverhttprequest-interface">ServerHttpRequest interface</a></li>
            <li><a href="#serverhttpresponse-interface">ServerHttpResponse interface</a></li>
            <li><a href="#serverwebexchangeutils-and-context-properties">ServerWebExchangeUtils and Context Properties</a></li>
          </ul>
        </li>
        <li><a href="#modify-request-body">Modify request body</a></li>
        <li><a href="#modify-response-body">Modify response body</a></li>
        <li><a href="#problems-with-oversized-request-or-response-body-messages">Problems with oversized request or response body messages</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/07/02/e206c56471b1463b85e5477dec6788d9.png" alt=" "></p>
<h2 id="prerequisites">Prerequisites</h2>
<blockquote>
<p>This article was written using <code>Spring Cloud Gateway</code> version <code>Greenwich.SR1</code>.</p>
</blockquote>
<p>When we use <code>Spring Cloud Gateway</code>, we notice that the filters (including <code>GatewayFilter</code>, <code>GlobalFilter</code> and the filter chain <code>GatewayFilterChain</code>), all depend on the <code>ServerWebExchange</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GlobalFilter</span> <span class="o">{</span>

    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GatewayFilter</span> <span class="kd">extends</span> <span class="n">ShortcutConfigurable</span> <span class="o">{</span>

	<span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GatewayFilterChain</span> <span class="o">{</span>

    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">);</span>
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>The design here is similar to <code>Filter</code> in <code>Servlet</code>, the current filter can decide whether to execute the logic of the next filter by <code>GatewayFilterChain#filter()</code> is called or not to decide. And <code>ServerWebExchange</code> is equivalent to the context of the current request and response. The <code>ServerWebExchange</code> instance not only stores the <code>Request</code> and <code>Response</code> objects, but also provides some extension methods, so if you want to implement the transformation of the request parameters or response parameters, you must have a deeper understanding of the <code>ServerWebExchange</code>.</p>
<h2 id="understanding-serverwebexchange">Understanding ServerWebExchange</h2>
<p>First, look at the annotation of <code>ServerWebExchange</code>.</p>
<blockquote>
<p>Contract for an HTTP request-response interaction. Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes.</p>
</blockquote>
<p>In fact, the <code>ServerWebExchange</code> named Service Web Exchange holds important request-response attributes, request instances and response instances, etc., somewhat like the role of <code>Context</code>.</p>
<h3 id="serverwebexchange-interface">ServerWebExchange Interface</h3>
<p>All methods of the ServerWebExchange interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerWebExchange</span> <span class="o">{</span>

    <span class="c1">// KEY of the log prefix property, with the value org.springframework.web.server.ServerWebExchange.LOG_ID
</span><span class="c1"></span>    <span class="c1">// 可to be understood as attributes.set(&#34;org.springframework.web.server.ServerWebExchange.LOG_ID&#34;, &#34;specific value of log prefix&#34;);
</span><span class="c1"></span>    <span class="c1">// The effect is to print the logs will be spliced this KEY to drink the prefix value, the default value is &#34;&#34;
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">LOG_ID_ATTRIBUTE</span> <span class="o">=</span> <span class="n">ServerWebExchange</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.LOG_ID&#34;</span><span class="o">;</span>
    <span class="n">String</span> <span class="nf">getLogPrefix</span><span class="o">();</span>

    <span class="c1">// Get ServerHttpRequest object
</span><span class="c1"></span>    <span class="n">ServerHttpRequest</span> <span class="nf">getRequest</span><span class="o">();</span>

    <span class="c1">// Get ServerHttpResponse object
</span><span class="c1"></span>    <span class="n">ServerHttpResponse</span> <span class="nf">getResponse</span><span class="o">();</span>
    
    <span class="c1">// Returns the requested property of the current exchange, the result is a variable Map
</span><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">();</span>
    
    <span class="c1">// Get request properties based on KEY
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="k">default</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">getAttributes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// Get request attributes based on KEY, made non-empty judgment
</span><span class="c1"></span>    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
    <span class="k">default</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getRequiredAttribute</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">T</span> <span class="n">value</span> <span class="o">=</span> <span class="n">getAttribute</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">&#34;Required attribute &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39; is missing&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

     <span class="c1">// Get request properties based on KEY, need to provide default values
</span><span class="c1"></span>    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
    <span class="k">default</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getAttributeOrDefault</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">T</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">getAttributes</span><span class="o">().</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">);</span>
    <span class="o">}</span> 

    <span class="c1">// Returns the current requested network session
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">WebSession</span><span class="o">&gt;</span> <span class="nf">getSession</span><span class="o">();</span>

    <span class="c1">// Returns the currently requested authenticated user, if one exists
</span><span class="c1"></span>    <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">Principal</span><span class="o">&gt;</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getPrincipal</span><span class="o">();</span>  
    
    <span class="c1">// Return the requested form data or an empty Map, only when the Content-Type is application/x-www-form-urlencoded this method will return a non-empty Map -- this is generally used for form data submission
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">getFormData</span><span class="o">();</span>   
    
    <span class="c1">// Return the part data of multipart request or an empty Map, only when Content-Type is multipart/form-data this method will return a non-empty Map -- this is generally used for file uploads
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Part</span><span class="o">&gt;&gt;</span> <span class="nf">getMultipartData</span><span class="o">();</span>
    
    <span class="c1">// Return the Spring context
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="n">ApplicationContext</span> <span class="nf">getApplicationContext</span><span class="o">();</span>   

    <span class="c1">// These methods are related to the lastModified property
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isNotModified</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">checkNotModified</span><span class="o">(</span><span class="n">Instant</span> <span class="n">lastModified</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">checkNotModified</span><span class="o">(</span><span class="n">String</span> <span class="n">etag</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">checkNotModified</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">etag</span><span class="o">,</span> <span class="n">Instant</span> <span class="n">lastModified</span><span class="o">);</span>
    
    <span class="c1">// URL conversion
</span><span class="c1"></span>    <span class="n">String</span> <span class="nf">transformUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">);</span>    
   
    <span class="c1">// URL Conversion Mapping
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addUrlTransformer</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">);</span> 

    <span class="c1">// Note this method, the method name is: change, this is a method to modify the properties of ServerWebExchange, the return is a Builder instance, Builder is the internal class of ServerWebExchange
</span><span class="c1"></span>    <span class="k">default</span> <span class="n">Builder</span> <span class="nf">mutate</span><span class="o">()</span> <span class="o">{</span>
	     <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultServerWebExchangeBuilder</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">interface</span> <span class="nc">Builder</span> <span class="o">{</span>      
         
        <span class="c1">// Override ServerHttpRequest
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">request</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">ServerHttpRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">requestBuilderConsumer</span><span class="o">);</span>
        <span class="n">Builder</span> <span class="nf">request</span><span class="o">(</span><span class="n">ServerHttpRequest</span> <span class="n">request</span><span class="o">);</span>
        
        <span class="c1">// Override ServerHttpResponse
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">response</span><span class="o">(</span><span class="n">ServerHttpResponse</span> <span class="n">response</span><span class="o">);</span>
        
        <span class="c1">// Override the currently requested authenticated user
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">principal</span><span class="o">(</span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Principal</span><span class="o">&gt;</span> <span class="n">principalMono</span><span class="o">);</span>
    
        <span class="c1">// Building a new ServerWebExchange instance
</span><span class="c1"></span>        <span class="n">ServerWebExchange</span> <span class="nf">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>Noting the <code>ServerWebExchange#mutate()</code> method, the <code>ServerWebExchange</code> instance can be understood as an immutable instance, and if we want to modify it, we need to generate a new instance by the <code>mutate()</code> method, such as this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="c1">// Here you can modify the ServerHttpRequest instance
</span><span class="c1"></span>        <span class="n">ServerHttpRequest</span> <span class="n">newRequest</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
        <span class="c1">// Here you can modify the ServerHttpResponse instance
</span><span class="c1"></span>        <span class="n">ServerHttpResponse</span> <span class="n">newResponse</span> <span class="o">=</span> <span class="o">...</span>
        <span class="c1">// Building a new ServerWebExchange instance
</span><span class="c1"></span>        <span class="n">ServerWebExchange</span> <span class="n">newExchange</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">newRequest</span><span class="o">).</span><span class="na">response</span><span class="o">(</span><span class="n">newResponse</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">newExchange</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="serverhttprequest-interface">ServerHttpRequest interface</h3>
<p>The <code>ServerHttpRequest</code> instance is used to host the request related properties and request body, the underlying <code>Spring Cloud Gateway</code> uses <code>Netty</code> to handle the network request, by tracing the source code, you can learn from the <code>ReactorHttpHandlerAdapter</code> that the specific implementation of the ServerHttpRequest instance held in the <code>Spring Cloud Gateway</code> is ReactorServerHttpRequest. The specific implementation of the <code>ServerHttpRequest</code> instance held in the <code>ServerWebExchange</code> instance is <code>ReactorServerHttpRequest</code>. The reason for listing the relationship between these instances is that it is easier to sort out some implicit issues, such as</p>
<p>The initialization of the internal property <code>headers</code> in the parent class <code>AbstractServerHttpRequest</code> of <code>ReactorServerHttpRequest</code> encapsulates the requested <code>HTTP headers</code> as a read-only instance of.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">AbstractServerHttpRequest</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">contextPath</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="n">RequestPath</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">contextPath</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">headers</span> <span class="o">=</span> <span class="n">HttpHeaders</span><span class="o">.</span><span class="na">readOnlyHttpHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// HttpHeaders类中的readOnlyHttpHeaders方法，其中ReadOnlyHttpHeaders屏蔽了所有修改请求头的方法，直接抛出UnsupportedOperationException
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">HttpHeaders</span> <span class="nf">readOnlyHttpHeaders</span><span class="o">(</span><span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">headers</span><span class="o">,</span> <span class="s">&#34;HttpHeaders must not be null&#34;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">headers</span> <span class="k">instanceof</span> <span class="n">ReadOnlyHttpHeaders</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">headers</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ReadOnlyHttpHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>So you can&rsquo;t get the request header <code>HttpHeaders</code> instance directly from the <code>ServerHttpRequest</code> instance and modify it.</p>
<p>The <code>ServerHttpRequest</code> interface is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HttpMessage</span> <span class="o">{</span>
    
    <span class="c1">// Get the request headers, the current implementation returns an instance of ReadOnlyHttpHeaders, read-only
</span><span class="c1"></span>    <span class="n">HttpHeaders</span> <span class="nf">getHeaders</span><span class="o">();</span>
<span class="o">}</span>    

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ReactiveHttpInputMessage</span> <span class="kd">extends</span> <span class="n">HttpMessage</span> <span class="o">{</span>
    
    <span class="c1">// Return the Flux wrapper for the request body
</span><span class="c1"></span>    <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HttpRequest</span> <span class="kd">extends</span> <span class="n">HttpMessage</span> <span class="o">{</span>

    <span class="c1">// Return HTTP request method, resolve to HttpMethod instance
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="k">default</span> <span class="n">HttpMethod</span> <span class="nf">getMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">getMethodValue</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="c1">// Returns the HTTP request method, string
</span><span class="c1"></span>    <span class="n">String</span> <span class="nf">getMethodValue</span><span class="o">();</span>    
    
    <span class="c1">// Requested URI
</span><span class="c1"></span>    <span class="n">URI</span> <span class="nf">getURI</span><span class="o">();</span>
<span class="o">}</span>    

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerHttpRequest</span> <span class="kd">extends</span> <span class="n">HttpRequest</span><span class="o">,</span> <span class="n">ReactiveHttpInputMessage</span> <span class="o">{</span>
    
    <span class="c1">// Unique identification of the connection or for logging purposes
</span><span class="c1"></span>    <span class="n">String</span> <span class="nf">getId</span><span class="o">();</span>   
    
    <span class="c1">// Get the request path, encapsulated as RequestPath object
</span><span class="c1"></span>    <span class="n">RequestPath</span> <span class="nf">getPath</span><span class="o">();</span>
    
    <span class="c1">// Returns query parameters, which are read-only MultiValueMap instances
</span><span class="c1"></span>    <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getQueryParams</span><span class="o">();</span>

    <span class="c1">// Returns a collection of cookies, which is a read-only MultiValueMap instance
</span><span class="c1"></span>    <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">HttpCookie</span><span class="o">&gt;</span> <span class="nf">getCookies</span><span class="o">();</span>  
    
    <span class="c1">// Remote server address information
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="k">default</span> <span class="n">InetSocketAddress</span> <span class="nf">getRemoteAddress</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Information about SSL session implementation
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="k">default</span> <span class="n">SslInfo</span> <span class="nf">getSslInfo</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>  
    
    <span class="c1">// Modifies the requested method, returning a builder instance Builder, which is an internal class
</span><span class="c1"></span>    <span class="k">default</span> <span class="n">ServerHttpRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">mutate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultServerHttpRequestBuilder</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> 

    <span class="kd">interface</span> <span class="nc">Builder</span> <span class="o">{</span>

        <span class="c1">// Override request method
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">method</span><span class="o">(</span><span class="n">HttpMethod</span> <span class="n">httpMethod</span><span class="o">);</span>
		 
        <span class="c1">// Override the request&#39;s URI, request path or context, all three of which have a constraining relationship with each other, as described in the API comments
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">uri</span><span class="o">(</span><span class="n">URI</span> <span class="n">uri</span><span class="o">);</span>
        <span class="n">Builder</span> <span class="nf">path</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">);</span>
        <span class="n">Builder</span> <span class="nf">contextPath</span><span class="o">(</span><span class="n">String</span> <span class="n">contextPath</span><span class="o">);</span>

        <span class="c1">// Override request header
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">header</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">);</span>
        <span class="n">Builder</span> <span class="nf">headers</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">HttpHeaders</span><span class="o">&gt;</span> <span class="n">headersConsumer</span><span class="o">);</span>
        
        <span class="c1">// Override SslInfo
</span><span class="c1"></span>        <span class="n">Builder</span> <span class="nf">sslInfo</span><span class="o">(</span><span class="n">SslInfo</span> <span class="n">sslInfo</span><span class="o">);</span>
        
        <span class="c1">// Build a new ServerHttpRequest instance
</span><span class="c1"></span>        <span class="n">ServerHttpRequest</span> <span class="nf">build</span><span class="o">();</span>
    <span class="o">}</span>         
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>If you want to modify the <code>ServerHttpRequest</code> instance, then you need to do this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
<span class="n">ServerHttpRequest</span> <span class="n">newRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">headers</span><span class="o">(</span><span class="s">&#34;key&#34;</span><span class="o">,</span><span class="s">&#34;value&#34;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&#34;/myPath&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>The most noteworthy thing here is: <code>ServerHttpRequest</code> or <code>HttpMessage</code> interface provides a method to get the request headers <code>HttpHeaders getHeaders();</code> returns a read-only instance, specifically of type <code>ReadOnlyHttpHeaders</code>, mentioned here more than once I wrote this blog post using <code>Spring Cloud Gateway</code> version <code>Greenwich.SR1</code>.</p>
<h3 id="serverhttpresponse-interface">ServerHttpResponse interface</h3>
<p>The <code>ServerHttpResponse</code> instance is used to carry the response-related properties and response body, the underlying <code>Spring Cloud Gateway</code> uses <code>Netty</code> to handle network requests, by tracing the source code, you can learn from the <code>ReactorHttpHandlerAdapter</code> that the specific implementation of the <code>ServerHttpResponse</code> instance held in the <code>Spring Cloud Gateway</code> is <code>ReactorServerHttpResponse</code>. <code>ServerWebExchange</code> instance held in the <code>ServerHttpResponse</code> instance of the specific implementation is <code>ReactorServerHttpResponse</code>. The reason for listing the relationships between these instances is that it is easier to sort out some of the implicit issues, such as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// Parent class of ReactorServerHttpResponse
</span><span class="c1"></span><span class="kd">public</span> <span class="nf">AbstractServerHttpResponse</span><span class="o">(</span><span class="n">DataBufferFactory</span> <span class="n">dataBufferFactory</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">dataBufferFactory</span><span class="o">,</span> <span class="s">&#34;DataBufferFactory must not be null&#34;</span><span class="o">);</span>
	<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">headers</span><span class="o">,</span> <span class="s">&#34;HttpHeaders must not be null&#34;</span><span class="o">);</span>
	<span class="k">this</span><span class="o">.</span><span class="na">dataBufferFactory</span> <span class="o">=</span> <span class="n">dataBufferFactory</span><span class="o">;</span>
	<span class="k">this</span><span class="o">.</span><span class="na">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">;</span>
	<span class="k">this</span><span class="o">.</span><span class="na">cookies</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ReactorServerHttpResponse</span><span class="o">(</span><span class="n">HttpServerResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">DataBufferFactory</span> <span class="n">bufferFactory</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">super</span><span class="o">(</span><span class="n">bufferFactory</span><span class="o">,</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyHeadersAdapter</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">responseHeaders</span><span class="o">())));</span>
	<span class="n">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">&#34;HttpServerResponse must not be null&#34;</span><span class="o">);</span>
	<span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It is known that <code>ReactorServerHttpResponse</code> constructor to initialize the instance, the storage response <code>Header</code> is <code>HttpHeaders</code> instance, that is, the response <code>Header</code> can be directly modified.</p>
<p><code>ServerHttpResponse</code> interface is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HttpMessage</span> <span class="o">{</span>
    
    <span class="c1">// Get the response Header, the current implementation returns an instance of HttpHeaders, which can be modified directly
</span><span class="c1"></span>    <span class="n">HttpHeaders</span> <span class="nf">getHeaders</span><span class="o">();</span>
<span class="o">}</span>  

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ReactiveHttpOutputMessage</span> <span class="kd">extends</span> <span class="n">HttpMessage</span> <span class="o">{</span>
    
    <span class="c1">// Get DataBufferFactory instance for wrapping or generating data buffer DataBuffer instance (create response body)
</span><span class="c1"></span>    <span class="n">DataBufferFactory</span> <span class="nf">bufferFactory</span><span class="o">();</span>

    <span class="c1">// Register an action that will be called back before the HttpOutputMessage is submitted
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">beforeCommit</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">);</span>

    <span class="c1">// Determine if the HttpOutputMessage has been submitted
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">isCommitted</span><span class="o">();</span>
    
    <span class="c1">// Write the message body to the HTTP protocol layer
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">writeWith</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">);</span>

    <span class="c1">// Write the message body to the HTTP protocol layer and flush the buffer
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">writeAndFlushWith</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;&gt;</span> <span class="n">body</span><span class="o">);</span>
    
    <span class="c1">// Indicates that the message processing has ended, generally this method is called automatically at the end of the message processing, multiple calls will not produce side effects
</span><span class="c1"></span>    <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">setComplete</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerHttpResponse</span> <span class="kd">extends</span> <span class="n">ReactiveHttpOutputMessage</span> <span class="o">{</span>
    
    <span class="c1">// Set the response status code
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="nf">setStatusCode</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">HttpStatus</span> <span class="n">status</span><span class="o">);</span>
    
    <span class="c1">// Get the response status code
</span><span class="c1"></span>    <span class="nd">@Nullable</span>
    <span class="n">HttpStatus</span> <span class="nf">getStatusCode</span><span class="o">();</span>
    
    <span class="c1">// Get response cookie, encapsulated as MultiValueMap instance, can be modified
</span><span class="c1"></span>    <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ResponseCookie</span><span class="o">&gt;</span> <span class="nf">getCookies</span><span class="o">();</span>  
    
    <span class="c1">// Adding response cookies
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">addCookie</span><span class="o">(</span><span class="n">ResponseCookie</span> <span class="n">cookie</span><span class="o">);</span>  
<span class="o">}</span>    
</code></pre></td></tr></table>
</div>
</div><p>Here you can see that all the properties are mutable except for the response body which is harder to modify.</p>
<h3 id="serverwebexchangeutils-and-context-properties">ServerWebExchangeUtils and Context Properties</h3>
<p><code>ServerWebExchangeUtils</code> holds a lot of static public string <code>KEY</code> values inside (the actual values of these string KEYs are <code>org.springframework.cloud.gateway.support.ServerWebExchangeUtils</code>. + any static public KEY below), these string KEY values are generally used for <code>ServerWebExchange</code> attributes (Attribute, see <code>ServerWebExchange#getAttributes()</code> method above) KEY, these attribute values have a special meaning, in the use of filters If the timing is appropriate, you can directly take out the use of the following analysis one by one.</p>
<ul>
<li>
<p><code>PRESERVE_HOST_HEADER_ATTRIBUTE</code> : whether to save the Host attribute, the value is a boolean type, the write location is <code>PreserveHostHeaderGatewayFilterFactory</code>, the location used is <code>NettyRoutingFilter</code> , the effect is that if set to true, the Host property in the HTTP request header will be written to the underlying Reactor-Netty&rsquo;s request Header property.</p>
</li>
<li>
<p><code>CLIENT_RESPONSE_ATTR</code> : Holds the underlying Reactor-Netty response object of type <code>reactor.netty.http.client.HttpClientResponse</code>.</p>
</li>
<li>
<p><code>CLIENT_RESPONSE_CONN_ATTR</code> : Holds the underlying Reactor-Netty connection object, of type <code>reactor.netty.Connection</code>.</p>
</li>
<li>
<p><code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code> : After <code>PathRoutePredicateFactory</code> finishes parsing the path parameters, it stores the parsed placeholder KEY-PathPath mapping in the <code>ServerWebExchange</code> property, KEY is <code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>.</p>
</li>
<li>
<p><code>CLIENT_RESPONSE_HEADER_NAMES</code> : Holds the set of names of the underlying Reactor-Netty&rsquo;s response Header.</p>
</li>
<li>
<p><code>GATEWAY_ROUTE_ATTR</code> : Holds the specific route matched in <code>RoutePredicateHandlerMapping</code> ( <code>org.springframework.cloud.gateway.route.Route</code> ) instance, through which the route instance to know which downstream service the current request will be routed to.</p>
</li>
<li>
<p><code>GATEWAY_REQUEST_URL_ATTR</code> : ( <code>java.net.URI</code> type instance), this instance represents the real URI that needs to be requested to the downstream service after direct request or load balancing processing.</p>
</li>
<li>
<p><code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code> : (instance of type <code>java.net.URI</code>), this instance represents the original request URI that needs to be saved when the request URI is rewritten.</p>
</li>
<li>
<p><code>GATEWAY_HANDLER_MAPPER_ATTR</code>: Short name of the type of the specific instance of <code>HandlerMapping</code> currently in use (usually the string &ldquo;RoutePredicateHandlerMapping&rdquo;).</p>
</li>
<li>
<p><code>GATEWAY_SCHEME_PREFIX_ATTR</code> : Determines that the schemeSpecificPart attribute, if present in the target route URI, holds the scheme of the URI in which the route URI will be reconstructed, see <code>RouteToRequestUrlFilter</code>.</p>
</li>
<li>
<p><code>GATEWAY_PREDICATE_ROUTE_ATTR</code>: Used to hold the ID of the specific route matched in <code>RoutePredicateHandlerMapping</code> ( <code>org.springframework.cloud.gateway.route</code>. ) instance&rsquo;s ID.</p>
</li>
<li>
<p><code>WEIGHT_ATTR</code> : experimental function (not recommended for official use in this version yet) to store group weight related properties, see <code>WeightCalculatorWebFilter</code>.</p>
</li>
<li>
<p><code>ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR</code> : Holds the value of the ContentType in the response Header.</p>
</li>
<li>
<p><code>HYSTRIX_EXECUTION_EXCEPTION_ATTR</code> : An instance of <code>Throwable</code>, which holds the exception instance when Hystrix executes an exception, see <code>HystrixGatewayFilterFactory</code> .</p>
</li>
<li>
<p><code>GATEWAY_ALREADY_ROUTED_ATTR</code> : Boolean value to determine if routing has been performed, see <code>NettyRoutingFilter</code> .</p>
</li>
<li>
<p><code>GATEWAY_ALREADY_PREFIXED_ATTR</code> : Boolean to determine if a prefix has been added to the request path, see <code>PrefixPathGatewayFilterFactory</code> .</p>
</li>
</ul>
<p>The contextual properties provided by <code>ServerWebExchangeUtils</code> are used for the secure transfer and use of some important internal instances or identity properties when the <code>ServerWebExchange</code> component of <code>Spring Cloud Gateway</code> is processing requests and responses, there may be some risk in using them as no No one can be sure whether the original attributes <code>KEY</code> or <code>VALUE</code> will change after a version upgrade, so if you have assessed the risk or avoided it, you can use them without fear. For example, when we do request and response logging (similar to <code>Nginx</code>&rsquo;s <code>Access Log</code>), we can rely on <code>GATEWAY_ROUTE_ATTR</code>, because we want to print information about the destination of the route. As a simple example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessLogFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">();</span>
        <span class="n">HttpMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>
        <span class="c1">// Get the destination URI of the route
</span><span class="c1"></span>        <span class="n">URI</span> <span class="n">targetUri</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ServerWebExchangeUtils</span><span class="o">.</span><span class="na">GATEWAY_REQUEST_URL_ATTR</span><span class="o">);</span>
        <span class="n">InetSocketAddress</span> <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">build</span><span class="o">()).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="n">HttpStatus</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;request path:{},client remote IP address:{},request method:{},target URI:{},response code:{}&#34;</span><span class="o">,</span>
                    <span class="n">path</span><span class="o">,</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">targetUri</span><span class="o">,</span> <span class="n">statusCode</span><span class="o">);</span>
        <span class="o">}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="modify-request-body">Modify request body</h2>
<p>Modifying the request body is a relatively common requirement. For example, when we implement a gateway using <code>Spring Cloud Gateway</code>, we have to implement a feature: parse the JWT stored in the request header, extract the userId from it, and write it to the request body. Let&rsquo;s simplify this scenario by assuming that we store the <code>userId</code> explicitly in the <code>accessToken</code> in the request header and the request body is a JSON structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;serialNumber&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
    <span class="nt">&#34;payload&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="c1">// ... Here is the payload, which holds the specific data
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We need to extract the accessToken, which is the userId, and insert it into the request body JSON as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;userId&#34;</span><span class="p">:</span> <span class="s2">&#34;userId&#34;</span><span class="p">,</span>
    <span class="nt">&#34;serialNumber&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
    <span class="nt">&#34;payload&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="c1">// ... Here is the payload, which holds the specific data
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here, to simplify the design, the global filter <code>GlobalFilter</code> is used to implement the actual need to consider in conjunction with specific scenarios.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyRequestBodyGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DataBufferFactory</span> <span class="n">dataBufferFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NettyDataBufferFactory</span><span class="o">(</span><span class="n">ByteBufAllocator</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="s">&#34;accessToken&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">accessToken</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;accessToken&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// Create a new ServerHttpRequest decorator, overriding the methods that need to be decorated
</span><span class="c1"></span>        <span class="n">ServerHttpRequestDecorator</span> <span class="n">decorator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpRequestDecorator</span><span class="o">(</span><span class="n">request</span><span class="o">)</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
                <span class="n">InputStreamHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputStreamHolder</span><span class="o">();</span>
                <span class="n">body</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="n">holder</span><span class="o">.</span><span class="na">inputStream</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">asInputStream</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">holder</span><span class="o">.</span><span class="na">inputStream</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">// Parsing JSON nodes
</span><span class="c1"></span>                        <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">inputStream</span><span class="o">);</span>
                        <span class="n">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">jsonNode</span> <span class="k">instanceof</span> <span class="n">ObjectNode</span><span class="o">,</span> <span class="s">&#34;JSON format exceptions&#34;</span><span class="o">);</span>
                        <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">jsonNode</span><span class="o">;</span>
                        <span class="c1">// The outermost JSON node writes a new attribute
</span><span class="c1"></span>                        <span class="n">objectNode</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;userId&#34;</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">);</span>
                        <span class="n">DataBuffer</span> <span class="n">dataBuffer</span> <span class="o">=</span> <span class="n">dataBufferFactory</span><span class="o">.</span><span class="na">allocateBuffer</span><span class="o">();</span>
                        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">objectNode</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;The final JSON data is:{}&#34;</span><span class="o">,</span> <span class="n">json</span><span class="o">);</span>
                        <span class="n">dataBuffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">json</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                        <span class="k">return</span> <span class="n">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">dataBuffer</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="c1">// Regenerate a new ServerWebExchange using the modified ServerHttpRequestDecorator
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">decorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">InputStreamHolder</span> <span class="o">{</span>

        <span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>To test.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">// HTTP
POST /order/json HTTP/1.1
Host: localhost:9090
Content-Type: application/json
accessToken: 10086
Accept: */*
Cache-Control: no-cache
Host: localhost:9090
accept-encoding: gzip, deflate
content-length: 94
Connection: keep-alive
cache-control: no-cache

{
    &#34;serialNumber&#34;: &#34;1&#34;,
    &#34;payload&#34;: {
        &#34;name&#34;: &#34;doge&#34;
    }
}

// Log output
The final JSON data is:{&#34;serialNumber&#34;:&#34;1&#34;,&#34;payload&#34;:{&#34;name&#34;:&#34;doge&#34;},&#34;userId&#34;:&#34;10086&#34;}
</code></pre></td></tr></table>
</div>
</div><p>The most important thing is the use of <code>ServerHttpRequest</code> decorator <code>ServerHttpRequestDecorator</code>, mainly covering the methods corresponding to the request body data buffer can be, as for how to handle other logic need to consider themselves, here is just a simple demonstration. The general code logic is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
<span class="n">ServerHttpRequestDecorator</span> <span class="n">requestDecorator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpRequestDecorator</span><span class="o">(</span><span class="n">request</span><span class="o">)</span> <span class="o">{</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
         <span class="c1">// Get the Flux that carries the original request body
</span><span class="c1"></span>         <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
         <span class="c1">// Here the new Flux that carries the request body is generated in a custom way
</span><span class="c1"></span>         <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">newBody</span> <span class="o">=</span> <span class="o">...</span>
         <span class="k">return</span> <span class="n">newBody</span><span class="o">;</span>
     <span class="o">}</span>            
<span class="o">}</span>
<span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">requestDecorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>    
</code></pre></td></tr></table>
</div>
</div><h2 id="modify-response-body">Modify response body</h2>
<p>The requirement of modifying the response body is also relatively common, and the specific approach is similar to modifying the request body. For example, we want to achieve the following function: the third-party service request passes through the gateway, the original message is ciphertext, we need to decrypt the ciphertext at the gateway, and then route the decrypted plaintext to the downstream service, the downstream service processes the plaintext successfully, and needs to encrypt the plaintext into ciphertext at the gateway before returning to the third-party service. Now we simplify the whole process by using AES encryption algorithm and unifying the password as the string &ldquo;throwable&rdquo;, assuming that the request and response messages are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// Request ciphertext
{
    &#34;serialNumber&#34;: &#34;&#34;,
    &#34;payload&#34; : &#34;Encrypted request message load&#34;
}

// Request plaintext (as a hint only)s
{
    &#34;serialNumber&#34;: &#34;&#34;,
    &#34;payload&#34; : &#34;{\&#34;name:\&#34;:\&#34;doge\&#34;}&#34;
}

// Response ciphertext
{
    &#34;code&#34;: 200,
    &#34;message&#34;:&#34;ok&#34;,
    &#34;payload&#34; : &#34;Encrypted response message load&#34;
}

// Responding to plain text (as a hint only)
{
    &#34;code&#34;: 200,
    &#34;message&#34;:&#34;ok&#34;,
    &#34;payload&#34; : &#34;{\&#34;name:\&#34;:\&#34;doge\&#34;,\&#34;age\&#34;:26}&#34;
}
</code></pre></td></tr></table>
</div>
</div><p>To facilitate some encryption/decryption or encoding/decoding implementations, the <code>commons-codec</code> class library of <code>Apache</code> needs to be introduced.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>commons-codec<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-codec<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.12<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>A global filter is defined here specifically to handle encryption and decryption, and it is actually best to combine this with a real scenario to decide if a global filter is appropriate, here is just an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// AES encryption and decryption tools class
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">enum</span> <span class="n">AesUtils</span> <span class="o">{</span>

    <span class="c1">// Single instance
</span><span class="c1"></span>    <span class="n">X</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">&#34;throwable&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">KEY_ALGORITHM</span> <span class="o">=</span> <span class="s">&#34;AES&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SECURE_RANDOM_ALGORITHM</span> <span class="o">=</span> <span class="s">&#34;SHA1PRNG&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_CIPHER_ALGORITHM</span> <span class="o">=</span> <span class="s">&#34;AES/ECB/PKCS5Padding&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">encrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">DEFAULT_CIPHER_ALGORITHM</span><span class="o">);</span>
            <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">Cipher</span><span class="o">.</span><span class="na">ENCRYPT_MODE</span><span class="o">,</span> <span class="n">provideSecretKey</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">Hex</span><span class="o">.</span><span class="na">encodeHexString</span><span class="o">(</span><span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">decrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">DEFAULT_CIPHER_ALGORITHM</span><span class="o">);</span>
            <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">provideSecretKey</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">Hex</span><span class="o">.</span><span class="na">decodeHex</span><span class="o">(</span><span class="n">content</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">SecretKey</span> <span class="nf">provideSecretKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">KeyGenerator</span> <span class="n">keyGen</span> <span class="o">=</span> <span class="n">KeyGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">KEY_ALGORITHM</span><span class="o">);</span>
            <span class="n">SecureRandom</span> <span class="n">secureRandom</span> <span class="o">=</span> <span class="n">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">SECURE_RANDOM_ALGORITHM</span><span class="o">);</span>
            <span class="n">secureRandom</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="n">PASSWORD</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
            <span class="n">keyGen</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">128</span><span class="o">,</span> <span class="n">secureRandom</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="n">keyGen</span><span class="o">.</span><span class="na">generateKey</span><span class="o">().</span><span class="na">getEncoded</span><span class="o">(),</span> <span class="n">KEY_ALGORITHM</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// EncryptionGlobalFilter
</span><span class="c1"></span><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncryptionGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span><span class="o">,</span> <span class="n">Ordered</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
        <span class="n">DataBufferFactory</span> <span class="n">bufferFactory</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">bufferFactory</span><span class="o">();</span>
        <span class="n">ServerHttpRequestDecorator</span> <span class="n">requestDecorator</span> <span class="o">=</span> <span class="n">processRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">bufferFactory</span><span class="o">);</span>
        <span class="n">ServerHttpResponseDecorator</span> <span class="n">responseDecorator</span> <span class="o">=</span> <span class="n">processResponse</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">bufferFactory</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">requestDecorator</span><span class="o">).</span><span class="na">response</span><span class="o">(</span><span class="n">responseDecorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ServerHttpRequestDecorator</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">ServerHttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">DataBufferFactory</span> <span class="n">bufferFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="n">DataBufferHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataBufferHolder</span><span class="o">();</span>
        <span class="n">body</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">dataBuffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">dataBuffer</span><span class="o">.</span><span class="na">readableByteCount</span><span class="o">();</span>
            <span class="n">holder</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
            <span class="n">dataBuffer</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
            <span class="n">DataBufferUtils</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">dataBuffer</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
            <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">readNode</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
            <span class="n">JsonNode</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">payloadText</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">asText</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">decrypt</span><span class="o">(</span><span class="n">payloadText</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Modify request body payload,before:{},after:{}&#34;</span><span class="o">,</span> <span class="n">payloadText</span><span class="o">,</span> <span class="n">requestBody</span><span class="o">);</span>
            <span class="n">rewritePayloadNode</span><span class="o">(</span><span class="n">requestBody</span><span class="o">,</span> <span class="n">jsonNode</span><span class="o">);</span>
            <span class="n">DataBuffer</span> <span class="n">data</span> <span class="o">=</span> <span class="n">bufferFactory</span><span class="o">.</span><span class="na">allocateBuffer</span><span class="o">();</span>
            <span class="n">data</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
            <span class="n">holder</span><span class="o">.</span><span class="na">dataBuffer</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
        <span class="o">});</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">());</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">CONTENT_LENGTH</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ServerHttpRequestDecorator</span><span class="o">(</span><span class="n">request</span><span class="o">)</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">HttpHeaders</span> <span class="nf">getHeaders</span><span class="o">()</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">headers</span><span class="o">.</span><span class="na">setContentLength</span><span class="o">(</span><span class="n">contentLength</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">headers</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">TRANSFER_ENCODING</span><span class="o">,</span> <span class="s">&#34;chunked&#34;</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">headers</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">dataBuffer</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ServerHttpResponseDecorator</span> <span class="nf">processResponse</span><span class="o">(</span><span class="n">ServerHttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">DataBufferFactory</span> <span class="n">bufferFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ServerHttpResponseDecorator</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="o">{</span>

            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">writeWith</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="k">instanceof</span> <span class="n">Flux</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Flux</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="o">(</span><span class="n">Flux</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;)</span> <span class="n">body</span><span class="o">;</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">writeWith</span><span class="o">(</span><span class="n">flux</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="n">CharBuffer</span> <span class="n">charBuffer</span> <span class="o">=</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">asByteBuffer</span><span class="o">());</span>
                        <span class="n">DataBufferUtils</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">readNode</span><span class="o">(</span><span class="n">charBuffer</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                        <span class="n">JsonNode</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">);</span>
                        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                        <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Modify the response body payload, before modification:{},after modification:{}&#34;</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>
                        <span class="n">setPayloadTextNode</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">jsonNode</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">bufferFactory</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                    <span class="o">}));</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">writeWith</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">rewritePayloadNode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">JsonNode</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">JsonNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
            <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">root</span><span class="o">;</span>
            <span class="n">objectNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setPayloadTextNode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">JsonNode</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">root</span><span class="o">;</span>
            <span class="n">objectNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TextNode</span><span class="o">(</span><span class="n">text</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JsonNode</span> <span class="nf">readNode</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DataBufferHolder</span> <span class="o">{</span>

        <span class="n">DataBuffer</span> <span class="n">dataBuffer</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>  
</code></pre></td></tr></table>
</div>
</div><p>Prepare a ciphertext first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
<span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;serialNumber&#34;</span><span class="o">,</span> <span class="s">&#34;请求流水号&#34;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="s">&#34;{\&#34;name\&#34;: \&#34;doge\&#34;}&#34;</span><span class="o">;</span>
<span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">content</span><span class="o">));</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">().</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">json</span><span class="o">));</span>

<span class="c1">// Output
</span><span class="c1"></span><span class="o">{</span><span class="s">&#34;serialNumber&#34;</span><span class="o">:</span><span class="s">&#34;请求流水号&#34;</span><span class="o">,</span><span class="s">&#34;payload&#34;</span><span class="o">:</span><span class="s">&#34;144e3dc734743f5709f1adf857bca473da683246fd612f86ac70edeb5f2d2729&#34;</span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Simulation request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">POST /order/json HTTP/1.1
Host: localhost:9090
accessToken: 10086
Content-Type: application/json
User-Agent: PostmanRuntime/7.13.0
Accept: */*
Cache-Control: no-cache
Postman-Token: bda07fc3-ea1a-478c-b4d7-754fe6f37200,634734d9-feed-4fc9-ba20-7618bd986e1c
Host: localhost:9090
cookie: customCookieName=customCookieValue
accept-encoding: gzip, deflate
content-length: 104
Connection: keep-alive
cache-control: no-cache

{
    &#34;serialNumber&#34;: &#34;请求流水号&#34;,
    &#34;payload&#34;: &#34;FE49xzR0P1cJ8a34V7ykc9poMkb9YS+GrHDt618tJyk=&#34;
}

// Response Results
{
    &#34;serialNumber&#34;: &#34;请求流水号&#34;,
    &#34;payload&#34;: &#34;oo/K1igg2t/S8EExkBVGWOfI1gAh5pBpZ0wyjNPW6e8=&#34;   # &lt;--- After decryption：{&#34;name&#34;:&#34;doge&#34;,&#34;age&#34;:26}
}
</code></pre></td></tr></table>
</div>
</div><p>Problems encountered.</p>
<ol>
<li><code>Ordered</code> interface must be implemented to return an order value less than -1. This is because the order value of <code>NettyWriteResponseFilter</code> is -1. We need to override the logic of returning the response body, and the custom <code>GlobalFilter</code> must be executed first than the NettyWriteResponseFilter.</li>
<li>After each restart of the gateway, the first request always fails to read a valid Body from the original <code>ServerHttpRequest</code>, and the exact phenomenon is that the <code>NettyRoutingFilter</code> call to <code>ServerHttpRequest#getBody()</code> gets an empty object, resulting in an empty pointer; strangely enough, it can be called normally from the second request onwards. I lowered the version of <code>Spring Cloud Gateway</code> to <code>Finchley.SR3</code> and the version of <code>Spring Boot</code> to <code>2.0.8.RELEASE</code>, the problem no longer occurs, and it is initially determined that it is a compatibility issue or a bug caused by the <code>Spring Cloud Gateway</code> version upgrade. BUG.</li>
</ol>
<p>The most important thing is the use of <code>ServerHttpResponse</code> decorator <code>ServerHttpResponseDecorator</code>, mainly covering the part of the response body data buffer written, as to how to deal with other logic needs to consider themselves, here is just a simple demonstration. The general code logic is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">ServerHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
<span class="n">ServerHttpResponseDecorator</span> <span class="n">responseDecorator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpResponseDecorator</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">writeWith</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="k">instanceof</span> <span class="n">Flux</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Flux</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="o">(</span><span class="n">Flux</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;)</span> <span class="n">body</span><span class="o">;</span>
                    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">writeWith</span><span class="o">(</span><span class="n">flux</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="c1">// buffer is the buffer of the original response data
</span><span class="c1"></span>                        <span class="c1">// Just return the buffer with the new response data after the following processing
</span><span class="c1"></span>                        <span class="k">return</span> <span class="n">bufferFactory</span><span class="o">.</span><span class="na">wrap</span><span class="o">(...);</span>
                    <span class="o">}));</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">writeWith</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
<span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">response</span><span class="o">(</span><span class="n">responseDecorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>    
</code></pre></td></tr></table>
</div>
</div><h2 id="problems-with-oversized-request-or-response-body-messages">Problems with oversized request or response body messages</h2>
<p>Some enthusiastic users have told me that if the request message is too large or the response message is too large, the methods of modifying the request and response messages in the previous two sections will cause problems, so here is an attempt to reproduce the specific problems encountered. First, try to lengthen the request message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">json</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
<span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;serialNumber&#34;</span><span class="o">,</span> <span class="s">&#34;请求流水号&#34;</span><span class="o">);</span>
<span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;doge&#34;</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;{\&#34;name\&#34;: \&#34;%s\&#34;}&#34;</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="n">json</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">content</span><span class="o">));</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">().</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">json</span><span class="o">));</span>

<span class="c1">// The requested JSON message is as follows.
</span><span class="c1"></span><span class="o">{</span>
    <span class="s">&#34;serialNumber&#34;</span><span class="o">:</span> <span class="s">&#34;请求流水号&#34;</span><span class="o">,</span>
    <span class="s">&#34;payload&#34;</span><span class="o">:</span> <span class="s">&#34;0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=&#34;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Initiating a request with the request message above does present a problem</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/07/08/d3bc9f692c634f44948fb8d2c13c19cf.png" alt=" "></p>
<p>The main issues are.</p>
<ol>
<li>
<p>After the request body packet data is subscribed to the <code>Flux&lt;DataBuffer&gt;</code> instance, the length of the byte array read is truncated. The length of the string in the original request message provided should be greater than 1000, and the conversion to a byte array should definitely be greater than 1000, but the above example only reads a byte array of length 673.</p>
</li>
<li>
<p>If the byte array is truncated, then the deserialization using Jackson indicates that the EOF identifier of the string is not read, causing the deserialization to fail.</p>
</li>
</ol>
<p>Since we have encountered the problem, we will try to solve it. First step to locate what is the cause, intuition tells me: to turn on the DEBUG log to observe, if there is no clue may have to trace the source code.</p>
<p>After opening the DEBUG log level to make a request, found some suspicious log information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58012] READ COMPLETE
2019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] INACTIVE
2019-05-19 11:16:15.660 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ: 1024B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 50 4f 53 54 20 2f 6f 72 64 65 72 2f 6a 73 6f 6e |POST /order/json|
|00000010| 20 48 54 54 50 2f 31 2e 31 0d 0a 61 63 63 65 73 | HTTP/1.1..acces|
|00000020| 73 54 6f 6b 65 6e 3a 20 31 30 30 38 36 0d 0a 43 |sToken: 10086..C|
|00000030| 6f 6e 74 65 6e 74 2d 54 79 70 65 3a 20 61 70 70 |ontent-Type: app|
|00000040| 6c 69 63 61 74 69 6f 6e 2f 6a 73 6f 6e 0d 0a 55 |lication/json..U|
|00000050| 73 65 72 2d 41 67 65 6e 74 3a 20 50 6f 73 74 6d |ser-Agent: Postm|
|00000060| 61 6e 52 75 6e 74 69 6d 65 2f 37 2e 31 33 2e 30 |anRuntime/7.13.0|
|00000070| 0d 0a 41 63 63 65 70 74 3a 20 2a 2f 2a 0d 0a 43 |..Accept: */*..C|
|00000080| 61 63 68 65 2d 43 6f 6e 74 72 6f 6c 3a 20 6e 6f |ache-Control: no|
|00000090| 2d 63 61 63 68 65 0d 0a 50 6f 73 74 6d 61 6e 2d |-cache..Postman-|
|000000a0| 54 6f 6b 65 6e 3a 20 31 31 32 30 38 64 35 39 2d |Token: 11208d59-|
|000000b0| 65 61 34 61 2d 34 62 39 63 2d 61 30 33 39 2d 30 |ea4a-4b9c-a039-0|
|000000c0| 30 65 36 64 38 61 30 65 33 65 66 0d 0a 48 6f 73 |0e6d8a0e3ef..Hos|
|000000d0| 74 3a 20 6c 6f 63 61 6c 68 6f 73 74 3a 39 30 39 |t: localhost:909|
|000000e0| 30 0d 0a 63 6f 6f 6b 69 65 3a 20 63 75 73 74 6f |0..cookie: custo|
|000000f0| 6d 43 6f 6f 6b 69 65 4e 61 6d 65 3d 63 75 73 74 |mCookieName=cust|
|00000100| 6f 6d 43 6f 6f 6b 69 65 56 61 6c 75 65 0d 0a 61 |omCookieValue..a|
|00000110| 63 63 65 70 74 2d 65 6e 63 6f 64 69 6e 67 3a 20 |ccept-encoding: |
|00000120| 67 7a 69 70 2c 20 64 65 66 6c 61 74 65 0d 0a 63 |gzip, deflate..c|
|00000130| 6f 6e 74 65 6e 74 2d 6c 65 6e 67 74 68 3a 20 35 |ontent-length: 5|
|00000140| 34 31 36 0d 0a 43 6f 6e 6e 65 63 74 69 6f 6e 3a |416..Connection:|
|00000150| 20 6b 65 65 70 2d 61 6c 69 76 65 0d 0a 0d 0a 7b | keep-alive....{|
|00000160| 0a 20 20 20 20 22 73 65 72 69 61 6c 4e 75 6d 62 |.    &#34;serialNumb|
|00000170| 65 72 22 3a 20 22 e8 af b7 e6 b1 82 e6 b5 81 e6 |er&#34;: &#34;..........|
|00000180| b0 b4 e5 8f b7 22 2c 0a 20 20 20 20 22 70 61 79 |.....&#34;,.    &#34;pay|
|00000190| 6c 6f 61 64 22 3a 20 22 30 44 63 66 32 70 6c 46 |load&#34;: &#34;0Dcf2plF|
|000001a0| 70 45 53 70 72 4b 6a 6b 64 71 4e 48 4d 38 6a 6a |pESprKjkdqNHM8jj|
|000001b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|000001c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|000001d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|000001e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|000001f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000200| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000210| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|00000220| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|00000230| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000240| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000250| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|00000260| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|00000270| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000280| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000290| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|000002a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|000002b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|000002c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|000002d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|000002e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|000002f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000300| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000310| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|00000320| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|00000330| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000340| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000350| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|00000360| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|00000370| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|00000380| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|00000390| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|000003a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|000003b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
|000003c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5|
|000003d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3|
|000003e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj|
|000003f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|
+--------+-------------------------------------------------+----------------+
2019-05-19 11:16:15.662 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] UNREGISTERED
2019-05-19 11:16:15.665 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServerOperations - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] Increasing pending responses, now 1
2019-05-19 11:16:15.671 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ COMPLETE
</code></pre></td></tr></table>
</div>
</div><p>Note the keyword <code>READ: 1024B</code>, here should be the underlying <code>Reactor-Netty</code> read the maximum length of the datagram limit, the printed datagram is just <code>1024B</code> size, this should be the root cause of the request body is truncated; this problem will not only appear in the request body to obtain, but also in the response body to write . Since this is a common problem, there must be a corresponding Issue on the project Github, find a longer interaction <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/581">gateway request size limit 1024B because netty default limit 1024,how to solve it?#581</a>, from the answer, the official recommendation is to use <code>ModifyRequestBodyGatewayFilterFactory</code> and <code>ModifyResponseBodyGatewayFilterFactory</code> to complete the corresponding function. Here you can try to borrow the implementation of <code>ModifyRequestBodyGatewayFilterFactory</code> to modify the previous code, because the logic of the code is longer and more complex, the filter for decrypting the request body is split into a new class <code>RequestEncryptionGlobalFilter</code>, the filter for encrypting the response body filter is split into <code>ResponseDecryptionGlobalFilter</code>.</p>
<p>The code for RequestEncryptionGlobalFilter is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestEncryptionGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span><span class="o">,</span> <span class="n">Ordered</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">HttpMessageReader</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">messageReaders</span> <span class="o">=</span> <span class="n">HandlerStrategies</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">().</span><span class="na">messageReaders</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">processRequest</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerRequest</span> <span class="n">serverRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultServerRequest</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">messageReaders</span><span class="o">);</span>
        <span class="n">DataBufferFactory</span> <span class="n">bufferFactory</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">bufferFactory</span><span class="o">();</span>
        <span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">rawBody</span> <span class="o">=</span> <span class="n">serverRequest</span><span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">);</span>
        <span class="n">BodyInserter</span><span class="o">&lt;</span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">ReactiveHttpOutputMessage</span><span class="o">&gt;</span> <span class="n">bodyInserter</span> <span class="o">=</span> <span class="n">BodyInserters</span><span class="o">.</span><span class="na">fromPublisher</span><span class="o">(</span><span class="n">rawBody</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">HttpHeaders</span> <span class="n">tempHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">tempHeaders</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">());</span>
        <span class="n">tempHeaders</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">CONTENT_LENGTH</span><span class="o">);</span>
        <span class="n">CachedBodyOutputMessage</span> <span class="n">outputMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachedBodyOutputMessage</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">tempHeaders</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bodyInserter</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">outputMessage</span><span class="o">,</span> <span class="k">new</span> <span class="n">BodyInserterContext</span><span class="o">()).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">defer</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">outputMessage</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
            <span class="n">DataBufferHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataBufferHolder</span><span class="o">();</span>
            <span class="n">body</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">dataBuffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">dataBuffer</span><span class="o">.</span><span class="na">readableByteCount</span><span class="o">();</span>
                <span class="n">holder</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
                <span class="n">dataBuffer</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
                <span class="n">DataBufferUtils</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">dataBuffer</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
                <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">readNode</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
                <span class="n">JsonNode</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">payloadText</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">asText</span><span class="o">();</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">decrypt</span><span class="o">(</span><span class="n">payloadText</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Modify request body payload,before:{},after:{}&#34;</span><span class="o">,</span> <span class="n">payloadText</span><span class="o">,</span> <span class="n">requestBody</span><span class="o">);</span>
                <span class="n">rewritePayloadNode</span><span class="o">(</span><span class="n">requestBody</span><span class="o">,</span> <span class="n">jsonNode</span><span class="o">);</span>
                <span class="n">DataBuffer</span> <span class="n">data</span> <span class="o">=</span> <span class="n">bufferFactory</span><span class="o">.</span><span class="na">allocateBuffer</span><span class="o">();</span>
                <span class="n">data</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                <span class="n">holder</span><span class="o">.</span><span class="na">dataBuffer</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
            <span class="o">});</span>
            <span class="n">ServerHttpRequestDecorator</span> <span class="n">requestDecorator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpRequestDecorator</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">())</span> <span class="o">{</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">HttpHeaders</span> <span class="nf">getHeaders</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">tempHeaders</span><span class="o">.</span><span class="na">getContentLength</span><span class="o">();</span>
                    <span class="n">HttpHeaders</span> <span class="n">httpHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
                    <span class="n">httpHeaders</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="kd">super</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">());</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">httpHeaders</span><span class="o">.</span><span class="na">setContentLength</span><span class="o">(</span><span class="n">contentLength</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">httpHeaders</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">TRANSFER_ENCODING</span><span class="o">,</span> <span class="s">&#34;chunked&#34;</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">httpHeaders</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">Flux</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">dataBuffer</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">requestDecorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">rewritePayloadNode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">JsonNode</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">JsonNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
            <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">root</span><span class="o">;</span>
            <span class="n">objectNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setPayloadTextNode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">JsonNode</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">root</span><span class="o">;</span>
            <span class="n">objectNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TextNode</span><span class="o">(</span><span class="n">text</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JsonNode</span> <span class="nf">readNode</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DataBufferHolder</span> <span class="o">{</span>

        <span class="n">DataBuffer</span> <span class="n">dataBuffer</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The code of <code>ResponseDecryptionGlobalFilter</code> is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResponseDecryptionGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span><span class="o">,</span> <span class="n">Ordered</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NettyWriteResponseFilter</span><span class="o">.</span><span class="na">WRITE_RESPONSE_FILTER_ORDER</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">processResponse</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">processResponse</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerHttpResponseDecorator</span> <span class="n">responseDecorator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerHttpResponseDecorator</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">())</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">writeWith</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">originalResponseContentType</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR</span><span class="o">);</span>
                <span class="n">HttpHeaders</span> <span class="n">httpHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
                <span class="n">httpHeaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">,</span> <span class="n">originalResponseContentType</span><span class="o">);</span>
                <span class="n">ResponseAdapter</span> <span class="n">responseAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResponseAdapter</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">httpHeaders</span><span class="o">);</span>
                <span class="n">DefaultClientResponse</span> <span class="n">clientResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultClientResponse</span><span class="o">(</span><span class="n">responseAdapter</span><span class="o">,</span> <span class="n">ExchangeStrategies</span><span class="o">.</span><span class="na">withDefaults</span><span class="o">());</span>
                <span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">rawBody</span> <span class="o">=</span> <span class="n">clientResponse</span><span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">);</span>
                <span class="n">BodyInserter</span><span class="o">&lt;</span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">ReactiveHttpOutputMessage</span><span class="o">&gt;</span> <span class="n">bodyInserter</span> <span class="o">=</span> <span class="n">BodyInserters</span><span class="o">.</span><span class="na">fromPublisher</span><span class="o">(</span><span class="n">rawBody</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">CachedBodyOutputMessage</span> <span class="n">outputMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachedBodyOutputMessage</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">());</span>
                <span class="k">return</span> <span class="n">bodyInserter</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">outputMessage</span><span class="o">,</span> <span class="k">new</span> <span class="n">BodyInserterContext</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">defer</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">messageBody</span> <span class="o">=</span> <span class="n">outputMessage</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
                            <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">messageBody</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                <span class="n">CharBuffer</span> <span class="n">charBuffer</span> <span class="o">=</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">asByteBuffer</span><span class="o">());</span>
                                <span class="n">DataBufferUtils</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                                <span class="n">JsonNode</span> <span class="n">jsonNode</span> <span class="o">=</span> <span class="n">readNode</span><span class="o">(</span><span class="n">charBuffer</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                                <span class="n">JsonNode</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">jsonNode</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">);</span>
                                <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                                <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">AesUtils</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
                                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;修改响应体payload,修改前:{},修改后:{}&#34;</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>
                                <span class="n">setPayloadTextNode</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">jsonNode</span><span class="o">);</span>
                                <span class="k">return</span> <span class="n">getDelegate</span><span class="o">().</span><span class="na">bufferFactory</span><span class="o">().</span><span class="na">wrap</span><span class="o">(</span><span class="n">jsonNode</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                            <span class="o">});</span>
                            <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">getDelegate</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">();</span>
                            <span class="k">if</span> <span class="o">(!</span><span class="n">headers</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">TRANSFER_ENCODING</span><span class="o">))</span> <span class="o">{</span>
                                <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="na">doOnNext</span><span class="o">(</span><span class="n">data</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="o">.</span><span class="na">setContentLength</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">readableByteCount</span><span class="o">()));</span>
                            <span class="o">}</span>
                            <span class="k">return</span> <span class="n">getDelegate</span><span class="o">().</span><span class="na">writeWith</span><span class="o">(</span><span class="n">flux</span><span class="o">);</span>
                        <span class="o">}));</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">response</span><span class="o">(</span><span class="n">responseDecorator</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setPayloadTextNode</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">JsonNode</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ObjectNode</span> <span class="n">objectNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">ObjectNode</span><span class="o">)</span> <span class="n">root</span><span class="o">;</span>
            <span class="n">objectNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;payload&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TextNode</span><span class="o">(</span><span class="n">text</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">JsonNode</span> <span class="nf">readNode</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">readTree</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ResponseAdapter</span> <span class="kd">implements</span> <span class="n">ClientHttpResponse</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">flux</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">;</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
        <span class="kd">private</span> <span class="nf">ResponseAdapter</span><span class="o">(</span><span class="n">Publisher</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="n">body</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="k">instanceof</span> <span class="n">Flux</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="o">(</span><span class="n">Flux</span><span class="o">)</span> <span class="n">body</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="o">((</span><span class="n">Mono</span><span class="o">)</span> <span class="n">body</span><span class="o">).</span><span class="na">flux</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Flux</span><span class="o">&lt;</span><span class="n">DataBuffer</span><span class="o">&gt;</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">flux</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">HttpHeaders</span> <span class="nf">getHeaders</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">headers</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">HttpStatus</span> <span class="nf">getStatusCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getRawStatusCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ResponseCookie</span><span class="o">&gt;</span> <span class="nf">getCookies</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Simulation request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">POST /order/json HTTP/1.1
Host: localhost:9090
accessToken: 10086
Content-Type: application/json
User-Agent: PostmanRuntime/7.13.0
Accept: */*
Cache-Control: no-cache
Postman-Token: 3a830202-f3d1-450e-839f-ae8f3b88bced,b229feb1-7c8b-4d25-a039-09345f3fe8f0
Host: localhost:9090
cookie: customCookieName=customCookieValue
accept-encoding: gzip, deflate
content-length: 5416
Connection: keep-alive
cache-control: no-cache

{
    &#34;serialNumber&#34;: &#34;请求流水号&#34;,
    &#34;payload&#34;: &#34;0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=&#34;
}

// response
{&#34;serialNumber&#34;:&#34;请求流水号&#34;,&#34;userId&#34;:null,&#34;payload&#34;:&#34;7S2VqLu4J6LdW0As50JgZ0eFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+Dm8rTVHylECORYnLNgnfWx0ENJ9a6E+abYhyFJ9zSIda&#34;}
</code></pre></td></tr></table>
</div>
</div><p>completely solved the previous request or response message truncation problem, I found a lot of blog posts are (copy) change the code logic when reading <code>DataBuffer</code> instance, in fact, that logic is not relevant, you can try to use <code>BufferedReader</code> based on line reading and then use <code>StringBuilder</code> bearer, or as in this article directly read as <code>byte</code> arrays and so on, because the underlying reason is the underlying <code>Reactor-Netty</code> data block read size limit to get the <code>DataBuffer</code> instance inside the data is incomplete, the solution is to refer to the <code>Spring Cloud Gateway</code> itself to provide the basic class library for transformation (temporarily not found a portal to adjust the configuration of <code>Reactor-Netty</code>), and it is not very difficult.</p>
<h2 id="summary">Summary</h2>
<p>I just came across a requirement to do the encryption and decryption of the gateway including the request and response body modifications, so here by the way, I combed through some of the <code>Spring Cloud Gateway</code> content involved in this area, stepped on the pits and filled them in by the way. The next step is to try to modify the available components to achieve custom logic, including <code>Hystrix</code>, <code>Eureka</code> and <code>Ribbon</code> based load balancing, flow limiting, etc.</p>
<hr>
<p>Reference <code>https://www.throwx.cn/2019/05/18/spring-cloud-gateway-modify-request-response/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring-cloud/">spring-cloud</a>
          <a href="/tags/spring-cloud-gateway/">spring-cloud-gateway</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-07/spring-cloud-gateway-custom-exception-handling/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Spring Cloud Gateway Custom Exception Handling</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-07/golang-context-source-code-analysis/">
            <span class="next-text nav-default">Golang Context Source Code Analysis</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
