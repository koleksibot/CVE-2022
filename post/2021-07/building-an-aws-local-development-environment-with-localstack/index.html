<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Building an AWS Local Development Environment with Localstack - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I believe there are many people who have used AWS for their projects or are learning AWS. We know that with cloud services like AWS, it&amp;rsquo;s not very easy to connect to the cloud when developing locally, not to mention that the staging/production environment will have security considerations. So when we create a project, how do we build its local development environment to facilitate our local development and debugging? That&amp;rsquo;s right!" /><meta name="keywords" content="AWS,Localstack" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-07/building-an-aws-local-development-environment-with-localstack/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Building an AWS Local Development Environment with Localstack" />
<meta property="og:description" content="I believe there are many people who have used AWS for their projects or are learning AWS. We know that with cloud services like AWS, it&rsquo;s not very easy to connect to the cloud when developing locally, not to mention that the staging/production environment will have security considerations. So when we create a project, how do we build its local development environment to facilitate our local development and debugging? That&rsquo;s right!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-07/building-an-aws-local-development-environment-with-localstack/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-02T17:49:08+08:00" />
<meta property="article:modified_time" content="2021-07-02T17:49:08+08:00" />

<meta itemprop="name" content="Building an AWS Local Development Environment with Localstack">
<meta itemprop="description" content="I believe there are many people who have used AWS for their projects or are learning AWS. We know that with cloud services like AWS, it&rsquo;s not very easy to connect to the cloud when developing locally, not to mention that the staging/production environment will have security considerations. So when we create a project, how do we build its local development environment to facilitate our local development and debugging? That&rsquo;s right!"><meta itemprop="datePublished" content="2021-07-02T17:49:08+08:00" />
<meta itemprop="dateModified" content="2021-07-02T17:49:08+08:00" />
<meta itemprop="wordCount" content="1621">
<meta itemprop="keywords" content="aws," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building an AWS Local Development Environment with Localstack"/>
<meta name="twitter:description" content="I believe there are many people who have used AWS for their projects or are learning AWS. We know that with cloud services like AWS, it&rsquo;s not very easy to connect to the cloud when developing locally, not to mention that the staging/production environment will have security considerations. So when we create a project, how do we build its local development environment to facilitate our local development and debugging? That&rsquo;s right!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Building an AWS Local Development Environment with Localstack</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-07-02 17:49:08 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/tools/"> tools </a>
            </div>
          <span class="more-meta"> 1621 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#how-is-it-used">How is it used?</a>
          <ul>
            <li><a href="#create-an-sns-service-with-localstack">Create an SNS service with LocalStack</a></li>
            <li><a href="#start-multiple-services">Start multiple services</a></li>
            <li><a href="#about-the-use-of-lambda-in-localstack">About the use of Lambda in LocalStack</a></li>
          </ul>
        </li>
        <li><a href="#faq">FAQ</a>
          <ul>
            <li><a href="#why-do-i-always-get-some-clients-credentials-error-when-i-use-sns-kms">Why do I always get some client&rsquo;s credentials error when I use SNS, KMS?</a></li>
            <li><a href="#why-did-the-message-to-the-sns-succeed-but-did-not-trigger-lambda">Why did the message to the SNS succeed but did not trigger Lambda?</a></li>
            <li><a href="#this-example-code">This example code?</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I believe there are many people who have used AWS for their projects or are learning AWS. We know that with cloud services like AWS, it&rsquo;s not very easy to connect to the cloud when developing locally, not to mention that the staging/production environment will have security considerations. So when we create a project, how do we build its local development environment to facilitate our local development and debugging? That&rsquo;s right! Use localstack!</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/07/02/18a13b12374b4a7da9999e7364d52884.png" alt=" "></p>
<p><a href="https://github.com/localstack/localstack">LocalStack - A fully functional local AWS cloud stack</a></p>
<blockquote>
<p>LocalStack provides an easy-to-use test/mocking framework for developing Cloud applications.</p>
<p>Currently, the focus is primarily on supporting the AWS cloud stack.</p>
</blockquote>
<h2 id="how-is-it-used">How is it used?</h2>
<h3 id="create-an-sns-service-with-localstack">Create an SNS service with LocalStack</h3>
<p>Imagine we have a SpringBoot service that provides an interface to send an email to a user when the user submits a record, which we would normally do asynchronously by saving the database and sending the email. If we use AWS, we can call the SNS service after saving the database, publish an Event and wait for the downstream mail service to subscribe to the corresponding topic and then consume it.</p>
<p>So how do we create it? In the docker-compose.yml file, add localstack, SERVICES and specify the sns as follows</p>
<h4 id="docker-composeyml">docker-compose.yml</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">localstack</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">localstack/localstack:0.12.1</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">app_net</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;4566:4566&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">SERVICES=sns</span><span class="w">
</span><span class="w">      </span>- <span class="l">DEFAULT_REGION=ap-southeast-2</span><span class="w">
</span><span class="w">      </span>- <span class="l">DEBUG=1</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">./auto/create-localstack-topic:/docker-entrypoint-initaws.d/create-localstack-topic.sh</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="create-localstack-topicsh">create-localstack-topic.sh</h4>
<p>In addition, you can see that we have a script in the volume, which is the script to create the SNS. In fact, this command is aws cli, which can be found on its official website, we just need to replace aws with awslocal</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nv">REGION</span><span class="o">=</span><span class="si">${</span><span class="nv">DEFAULT_REGION</span><span class="k">:-</span><span class="nv">ap</span><span class="p">-southeast-2</span><span class="si">}</span>
<span class="nv">TOPIC_NAME</span><span class="o">=</span>demo-events-topic

awslocal sns create-topic --name<span class="o">=</span><span class="si">${</span><span class="nv">TOPIC_NAME</span><span class="si">}</span> --region <span class="s2">&#34;</span><span class="si">${</span><span class="nv">REGION</span><span class="si">}</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="startup-log">Startup Log</h4>
<p>When docker-compose up localstack is started, the SNS service is created in that container for us to use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">sns_1            | Waiting for all LocalStack services to be ready
sns_1            | 2020-12-27 07:02:36,554 CRIT Supervisor is running as root.  Privileges were not dropped because no user is specified in the config file.  If you intend to run as root, you can set user=root in the config file to avoid this message.
sns_1            | 2020-12-27 07:02:36,559 INFO supervisord started with pid 15
sns_1            | 2020-12-27 07:02:37,566 INFO spawned: &#39;dashboard&#39; with pid 21
sns_1            | 2020-12-27 07:02:37,571 INFO spawned: &#39;infra&#39; with pid 22
sns_1            | 2020-12-27 07:02:37,577 INFO success: dashboard entered RUNNING state, process has stayed up for &gt; than 0 seconds (startsecs)
sns_1            | 2020-12-27 07:02:37,577 INFO exited: dashboard (exit status 0; expected)
sns_1            | (. .venv/bin/activate; exec bin/localstack start --host)
sns_1            | 2020-12-27 07:02:38,591 INFO success: infra entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
sns_1            | LocalStack version: 0.12.1
sns_1            | Starting local dev environment. CTRL-C to quit.
sns_1            | 2020-12-27T07:02:39:DEBUG:bootstrap.py: Loading plugins - scope &#34;services&#34;, module &#34;localstack&#34;: &lt;function register_localstack_plugins at 0x7f963f120f70&gt;
sns_1            | Waiting for all LocalStack services to be ready
sns_1            | 2020-12-27T07:02:43:INFO:localstack.utils.analytics.profiler: Execution of &#34;load_plugin_from_path&#34; took 4333.9550495147705ms
sns_1            | 2020-12-27T07:02:43:INFO:localstack.utils.analytics.profiler: Execution of &#34;load_plugins&#34; took 4334.24186706543ms
sns_1            | Starting edge router (https port 4566)...
sns_1            | Starting mock SNS service on http port 4566 ...
sns_1            | 2020-12-27T07:02:45:INFO:localstack.utils.analytics.profiler: Execution of &#34;prepare_environment&#34; took 2061.4540576934814ms
sns_1            | 2020-12-27T07:02:45:INFO:localstack.multiserver: Starting multi API server process on port 59903
sns_1            | [2020-12-27 07:02:45 +0000] [23] [INFO] Running on https://0.0.0.0:4566 (CTRL + C to quit)
sns_1            | 2020-12-27T07:02:45:INFO:hypercorn.error: Running on https://0.0.0.0:4566 (CTRL + C to quit)
sns_1            | [2020-12-27 07:02:45 +0000] [23] [INFO] Running on http://0.0.0.0:59903 (CTRL + C to quit)
sns_1            | 2020-12-27T07:02:45:INFO:hypercorn.error: Running on http://0.0.0.0:59903 (CTRL + C to quit)
sns_1            | 2020-12-27 07:02:45,824:API:  * Running on http://0.0.0.0:57589/ (Press CTRL+C to quit)
sns_1            | Waiting for all LocalStack services to be ready
sns_1            | Ready.
sns_1            | 2020-12-27T07:02:50:INFO:localstack.utils.analytics.profiler: Execution of &#34;start_api_services&#34; took 5102.221965789795ms
sns_1            | /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initaws.d/create-localstack-topic.sh
sns_1            | {
sns_1            |     &#34;TopicArn&#34;: &#34;arn:aws:sns:ap-southeast-2:000000000000:demo-events-topic&#34;
sns_1            | }
</code></pre></td></tr></table>
</div>
</div><h4 id="calling">Calling</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">aws --endpoint-url<span class="o">=</span>http://localhost:4566 sns publish --topic-arn arn:aws:sns:ap-southeast-2:000000000000:demo-events-topic --region ap-southeast-2 --message <span class="s2">&#34;Hello SNS&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that you need to override the endpoint-url when calling services in localstack locally with the aws command, otherwise the credentials will be used to call the services in the real environment.</p>
<h4 id="notes-for-use-in-springboot">Notes for use in SpringBoot</h4>
<p>For use in SpringBoot or other codebases (such as node), you can create different SNSClients for different environments, taking care to override the endpoint for local environments.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@Profile</span><span class="o">({</span><span class="s">&#34;local&#34;</span><span class="o">,</span> <span class="s">&#34;docker&#34;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LocalSnsClientConfiguration</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${aws.sns.endpoint}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">awsSnsEndpoint</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">SnsClient</span> <span class="nf">snsClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">var</span> <span class="n">clientBuilder</span> <span class="o">=</span> <span class="n">SnsClient</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">Strings</span><span class="o">.</span><span class="na">isNullOrEmpty</span><span class="o">(</span><span class="n">awsSnsEndpoint</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clientBuilder</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">awsSnsEndpoint</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">clientBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="start-multiple-services">Start multiple services</h3>
<p>The above is just an example of starting an SNS service. In practice, we will use multiple services in combination. For example, there will be an SQS service that subscribes to an SNS topic and then triggers a lambda to perform some tasks, so how can we implement these services locally to subscribe and trigger each other? In fact, you only need to start multiple services in a localstack and then execute some scripts to establish the relationship between them (the specific commands are the same as aws cli), as follows.</p>
<h4 id="docker-composeyml-1">docker-compose.yml</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">localstack</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">localstack/localstack:0.12.1</span><span class="w">
</span><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">localstack</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">app_net</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;4566:4566&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">SERVICES=sns,sqs,kms,cloudwatch,lambda</span><span class="w">
</span><span class="w">      </span>- <span class="l">DEFAULT_REGION=ap-southeast-2</span><span class="w">
</span><span class="w">      </span>- <span class="l">LAMBDA_EXECUTOR=docker-reuse</span><span class="w">
</span><span class="w">      </span>- <span class="l">LAMBDA_REMOTE_DOCKER=false</span><span class="w">
</span><span class="w">      </span>- <span class="l">LAMBDA_DOCKER_NETWORK=host</span><span class="w">
</span><span class="w">      </span>- <span class="l">DEBUG=1</span><span class="w">
</span><span class="w">      </span>- <span class="l">HOST_TMP_FOLDER=${TMPDIR}</span><span class="w">
</span><span class="w">      </span>- <span class="l">DOCKER_HOST=unix:///var/run/docker.sock</span><span class="w">
</span><span class="w">      </span>- <span class="l">LOCAL_CODE_PATH=${PWD}</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">${TMPDIR:-/tmp/localstack}:/tmp/localstack</span><span class="w">
</span><span class="w">      </span>- <span class="l">/var/run/docker.sock:/var/run/docker.sock</span><span class="w">
</span><span class="w">      </span>- <span class="l">./auto/create-localstack:/docker-entrypoint-initaws.d/create-localstack.sh</span><span class="w">
</span><span class="w">      </span>- <span class="l">./kms/kms_seed.yaml:/init/seed.yaml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">app_net</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="kms_seedyaml">kms_seed.yaml</h4>
<p>I have started sns,sqs,kms,cloudwatch,lambda here. It is worth mentioning that in addition to overriding the endpoint-url for local access to sqs, sns, kms, etc., you need to specify a seed.yml to encrypt and decrypt it for local use with kms.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">Keys</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">Symmetric</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Aes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">Metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">KeyId</span><span class="p">:</span><span class="w"> </span><span class="l">832ac356-3c82-4c4d-a3dc-7489da152197</span><span class="w">
</span><span class="w">        </span><span class="nt">BackingKeys</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">2bdaead27fe7da2de47945d34cd6d79e36494e73802f3cd3869f1d2cb0b5d74c</span><span class="w">
</span><span class="w"></span><span class="nt">Aliases</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">AliasName</span><span class="p">:</span><span class="w"> </span><span class="l">alias/testing</span><span class="w">
</span><span class="w">    </span><span class="nt">TargetKeyId</span><span class="p">:</span><span class="w"> </span><span class="l">832ac356-3c82-4c4d-a3dc-7489da152197</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="create-script-create-localstacksh">Create script create-localstack.sh</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nv">QUEUE_NAME</span><span class="o">=</span>demo-queue
<span class="nv">TOPIC_NAME</span><span class="o">=</span>demo-topic
<span class="nv">FUNCTION_NAME</span><span class="o">=</span>demo-function
<span class="nv">APP_ENV</span><span class="o">=</span>dev

awslocal sns create-topic --name<span class="o">=</span><span class="si">${</span><span class="nv">TOPIC_NAME</span><span class="si">}</span>
awslocal sqs create-queue --queue-name<span class="o">=</span><span class="si">${</span><span class="nv">QUEUE_NAME</span><span class="si">}</span>
awslocal sns subscribe <span class="se">\
</span><span class="se"></span>    --topic-arn arn:aws:sns:ap-southeast-2:000000000000:<span class="si">${</span><span class="nv">TOPIC_NAME</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    --protocol sqs <span class="se">\
</span><span class="se"></span>    --notification-endpoint http://localhost:4566/000000000000/<span class="si">${</span><span class="nv">QUEUE_NAME</span><span class="si">}</span>

awslocal lambda create-function <span class="se">\
</span><span class="se"></span>    --code <span class="nv">S3Bucket</span><span class="o">=</span><span class="s2">&#34;__local__&#34;</span>,S3Key<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">LOCAL_CODE_PATH</span><span class="si">}</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>    --function-name <span class="si">${</span><span class="nv">FUNCTION_NAME</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    --runtime nodejs12.x <span class="se">\
</span><span class="se"></span>    --timeout <span class="m">5</span> <span class="se">\
</span><span class="se"></span>    --handler dist/index.handler <span class="se">\
</span><span class="se"></span>    --role dev <span class="se">\
</span><span class="se"></span>    --environment <span class="s2">&#34;{\&#34;Variables\&#34;:{\&#34;APP_ENV\&#34;:\&#34;</span><span class="si">${</span><span class="nv">APP_ENV</span><span class="si">}</span><span class="s2">\&#34;}}&#34;</span>

awslocal lambda create-event-source-mapping <span class="se">\
</span><span class="se"></span>    --event-source-arn arn:aws:sqs:ap-southeast-2:000000000000:<span class="si">${</span><span class="nv">QUEUE_NAME</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    --function-name <span class="si">${</span><span class="nv">FUNCTION_NAME</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    --enabled
</code></pre></td></tr></table>
</div>
</div><h4 id="local-start">Local Start</h4>
<p>execution  <code>docker-compose up localstack</code></p>
<p>Now send an SNS message from the command line to trigger our Lambda execution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">aws --endpoint-url<span class="o">=</span>http://localhost:4566 sns publish --topic-arn arn:aws:sns:ap-southeast-2:000000000000:demo-topic --region ap-southeast-2 --message <span class="s2">&#34;Hello SNS - SQS - Lambda&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Write a handler() method to Lambda&rsquo;s index.ts.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="kr">require</span><span class="p">(</span><span class="s1">&#39;./overwriteAwsLocalEndpoint&#39;</span><span class="p">);</span> <span class="c1">//overwrite aws local endpoint,Please keep it here.
</span><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">SQSEvent</span><span class="p">,</span> <span class="nx">SQSHandler</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;aws-lambda&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">handler</span>: <span class="kt">SQSHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">SQSEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Print the message body of the SQS.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">localstack    | &gt; START RequestId: ce5ae5ff-054d-16e0-dc62-71161118d3bd Version: $LATEST
localstack    | &gt; 2020-12-27T09:32:56.373Z	ce5ae5ff-054d-16e0-dc62-71161118d3bd	INFO	[{&#34;body&#34;:&#34;{\&#34;Type\&#34;: \&#34;Notification\&#34;, \&#34;MessageId\&#34;: \&#34;04c12e03-66d0-474a-a60a-f0b3c2451456\&#34;, \&#34;Token\&#34;: null, \&#34;TopicArn\&#34;: \&#34;arn:aws:sns:ap-southeast-2:000000000000:demo-topic\&#34;, \&#34;Message\&#34;: \&#34;Hello SNS - SQS - Lambda\&#34;, \&#34;SubscribeURL\&#34;: null, \&#34;Timestamp\&#34;: \&#34;2020-12-27T09:32:52.202Z\&#34;, \&#34;SignatureVersion\&#34;: \&#34;1\&#34;, \&#34;Signature\&#34;: \&#34;EXAMPLEpH+..\&#34;, \&#34;SigningCertURL\&#34;: \&#34;https://sns.us-east-1.amazonaws.com/SimpleNotificationService-0000000000000000000000.pem\&#34;}&#34;,&#34;receiptHandle&#34;:&#34;exexifyylldwuznxlicibcanaqvcplpaeoztcdlltkzbsuvwiifvlyixrxwuzrmumlmkggofmiencdxilzoaluyreszdppsbycpxcowwvmeiieeplulkitfztfxzkjazucucauhuobpvlzdcnjdcmygqvbrouxkxoggcfryzqtibyquhikawczuif&#34;,&#34;md5OfBody&#34;:&#34;d96df71c445e9282ed4c2fefbf4c8ca1&#34;,&#34;eventSourceARN&#34;:&#34;arn:aws:sqs:ap-southeast-2:000000000000:demo-queue&#34;,&#34;eventSource&#34;:&#34;aws:sqs&#34;,&#34;awsRegion&#34;:&#34;ap-southeast-2&#34;,&#34;messageId&#34;:&#34;a59f7c57-651b-54f6-70bd-a2933fa57099&#34;,&#34;attributes&#34;:{&#34;SenderId&#34;:&#34;AIDAIT2UOQQY3AUEKVGXU&#34;,&#34;SentTimestamp&#34;:&#34;1609061572241&#34;,&#34;ApproximateReceiveCount&#34;:&#34;1&#34;,&#34;ApproximateFirstReceiveTimestamp&#34;:&#34;1609061572312&#34;},&#34;messageAttributes&#34;:{},&#34;md5OfMessageAttributes&#34;:null,&#34;sqs&#34;:true}]
localstack    | &gt; END RequestId: ce5ae5ff-054d-16e0-dc62-71161118d3bd
localstack    | &gt; REPORT RequestId: ce5ae5ff-054d-16e0-dc62-71161118d3bd	Init Duration: 3381.65 ms	Duration: 13.13 ms	Billed Duration: 100 ms	Memory Size: 1536 MB	Max Memory Used: 55 MB
</code></pre></td></tr></table>
</div>
</div><h3 id="about-the-use-of-lambda-in-localstack">About the use of Lambda in LocalStack</h3>
<p>Creating a Lambda runtime environment locally is one of the more troublesome services in my opinion, and the following is the <a href="https://github.com/localstack/localstack#configurations">official configuration</a> for Lambda creation</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">STEPFUNCTIONS_LAMBDA_ENDPOINT: URL to use as the Lambda service endpoint in Step Functions. By default this is the LocalStack Lambda endpoint. Use default to select the original AWS Lambda endpoint.

LAMBDA_EXECUTOR: Method to use for executing Lambda functions. Possible values are:

	- local: run Lambda functions in a temporary directory on the local machine
	- docker: run each function invocation in a separate Docker container
	- docker-reuse: create one Docker container per function and reuse it across invocations
	For docker and docker-reuse, if LocalStack itself is started inside Docker, then the docker command needs to be available inside the container (usually requires to run the container in privileged mode). Default is docker, fallback to local if Docker is not available.

LAMBDA_REMOTE_DOCKER: determines whether Lambda code is copied or mounted into containers. Possible values are:

	- true (default): your Lambda function definitions will be passed to the container by copying the zip file (potentially slower). It allows for remote execution, where the host and the client are not on the same machine.
	- false: your Lambda function definitions will be passed to the container by mounting a volume (potentially faster). This requires to have the Docker client and the Docker host on the same machine.

LAMBDA_DOCKER_NETWORK: Optional Docker network for the container running your lambda function.

LAMBDA_DOCKER_DNS: Optional DNS server for the container running your lambda function.

LAMBDA_CONTAINER_REGISTRY: Use an alternative docker registry to pull lambda execution containers (default: lambci/lambda).

LAMBDA_REMOVE_CONTAINERS: Whether to remove containers after Lambdas finished executing (default: true).
</code></pre></td></tr></table>
</div>
</div><h2 id="faq">FAQ</h2>
<h3 id="why-do-i-always-get-some-clients-credentials-error-when-i-use-sns-kms">Why do I always get some client&rsquo;s credentials error when I use SNS, KMS?</h3>
<p>Because the endpoint-url required for the local environment is not overridden, refer to the explanation in this article</p>
<h3 id="why-did-the-message-to-the-sns-succeed-but-did-not-trigger-lambda">Why did the message to the SNS succeed but did not trigger Lambda?</h3>
<p>qing check your creation script to make sure that your SQS is subscribed to the corresponding topic of the SNS and that the SQS has a Mapping that can trigger Lambda</p>
<h3 id="this-example-code">This example code?</h3>
<p><a href="https://github.com/Fatezhang/aws-localstack-demo">Fatezhang/aws-localstack-demo</a></p>
<hr>
<p>Reference <code>http://zhangjiaheng.cn/blog/20201227/%E4%BD%BF%E7%94%A8localstack-%E6%90%AD%E5%BB%BA-AWS-%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/aws/">aws</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-07/go-channel-vs-java-blockingqueue/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go Channel vs Java BlockingQueue</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-07/getting-started-with-mockoon/">
            <span class="next-text nav-default">Getting Started With Mockoon</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
