<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Spring Cloud Gateway - Downgrading with Hystrix using Custom Filters - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Prerequisites In microservices architecture, if the downstream dependencies do not do request degradation processing, the downstream abnormal dependencies are not isolated, and it is likely that one or two services or as small as one or two interface abnormalities will lead to the unavailability of all upstream services and even affect the whole business line. Request degradation processing is still relatively mainstream is Netfilx produced Hystrix. Hystrix works on the" /><meta name="keywords" content="spring-cloud-gateway,hystrix,spring-cloud" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-downgrading-with-hystrix-using-custom-filters/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Spring Cloud Gateway - Downgrading with Hystrix using Custom Filters" />
<meta property="og:description" content="Prerequisites In microservices architecture, if the downstream dependencies do not do request degradation processing, the downstream abnormal dependencies are not isolated, and it is likely that one or two services or as small as one or two interface abnormalities will lead to the unavailability of all upstream services and even affect the whole business line. Request degradation processing is still relatively mainstream is Netfilx produced Hystrix. Hystrix works on the" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-07/spring-cloud-gateway-downgrading-with-hystrix-using-custom-filters/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-07-01T12:06:22+08:00" />
<meta property="article:modified_time" content="2021-07-01T12:06:22+08:00" />

<meta itemprop="name" content="Spring Cloud Gateway - Downgrading with Hystrix using Custom Filters">
<meta itemprop="description" content="Prerequisites In microservices architecture, if the downstream dependencies do not do request degradation processing, the downstream abnormal dependencies are not isolated, and it is likely that one or two services or as small as one or two interface abnormalities will lead to the unavailability of all upstream services and even affect the whole business line. Request degradation processing is still relatively mainstream is Netfilx produced Hystrix. Hystrix works on the"><meta itemprop="datePublished" content="2021-07-01T12:06:22+08:00" />
<meta itemprop="dateModified" content="2021-07-01T12:06:22+08:00" />
<meta itemprop="wordCount" content="1906">
<meta itemprop="keywords" content="spring-cloud,spring-cloud-gateway," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spring Cloud Gateway - Downgrading with Hystrix using Custom Filters"/>
<meta name="twitter:description" content="Prerequisites In microservices architecture, if the downstream dependencies do not do request degradation processing, the downstream abnormal dependencies are not isolated, and it is likely that one or two services or as small as one or two interface abnormalities will lead to the unavailability of all upstream services and even affect the whole business line. Request degradation processing is still relatively mainstream is Netfilx produced Hystrix. Hystrix works on the"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Spring Cloud Gateway - Downgrading with Hystrix using Custom Filters</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-07-01 12:06:22 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/microservices/"> microservices </a>
            </div>
          <span class="more-meta"> 1906 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#prerequisites">Prerequisites</a></li>
        <li><a href="#use-the-built-in-hystrix-filter">Use the built-in Hystrix filter</a></li>
        <li><a href="#custom-filters-with-hystrix">Custom Filters with Hystrix</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/07/01/657029505bd0489f9b1bea11b26d7fac.png" alt=" "></p>
<h2 id="prerequisites">Prerequisites</h2>
<p>In microservices architecture, if the downstream dependencies do not do request degradation processing, the downstream abnormal dependencies are not isolated, and it is likely that one or two services or as small as one or two interface abnormalities will lead to the unavailability of all upstream services and even affect the whole business line.</p>
<p>Request degradation processing is still relatively mainstream is <code>Netfilx</code> produced <code>Hystrix</code>.</p>
<p>Hystrix works on the following principles.</p>
<ul>
<li>Isolating requests based on thread pools or semaphores, once the downstream service fails to respond within the specified configured timeout will enter a pre-defined or default degraded implementation.</li>
<li>The status of each request is recorded, and the rate of processing failure within a sliding window exceeds a set threshold to trigger the fuse (Circle Breaker) to open, and all requests go directly to the preset or default degradation logic after the fuse is opened.</li>
<li>After the fuse is opened and the time since the fuse was opened or the last trial request release exceeds the set value, the fuse device enters the half-open state and allows the release of a trial request.</li>
<li>After the request success rate increases, the fuse is determined to be closed based on statistical data and all requests are released normally.</li>
</ul>
<p>Instead of going into the details of Hystrix, we will move on to how to use Hystrix in Spring Cloud Gateway, mainly including the built-in Hystrix filters and custom filters combined with Hystrix to achieve the functionality we want. In addition to introducing the spring-cloud-starter-gateway dependency, you also need to introduce spring-cloud-starter-netflix-hystrix.</p>
<p>Instead of going into the details of <code>Hystrix</code>, we will move on to how to use <code>Hystrix</code> in Spring Cloud Gateway, mainly including the built-in Hystrix filters and custom filters combined with <code>Hystrix</code> to achieve the functionality we want. In addition to introducing the <code>spring-cloud-starter-gateway</code> dependency, you also need to introduce <code>spring-cloud-starter-netflix-hystrix</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>    
</code></pre></td></tr></table>
</div>
</div><h2 id="use-the-built-in-hystrix-filter">Use the built-in Hystrix filter</h2>
<p>The built-in <code>Hystrix</code> filter is the <code>HystrixGatewayFilterFactory</code>, which supports the following configurations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="c1">// If the following Setter is configured as null, name will be used as the HystrixCommandKey of the Hystrix
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// Setter property of Hystrix, mainly used to configure the KEY and other properties of the command
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Setter</span> <span class="n">setter</span><span class="o">;</span>
    <span class="c1">// The target URI for degradation must start with forward, and the URI will match the controller method applied to the gateway
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">;</span>

	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Config</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="kd">public</span> <span class="n">Config</span> <span class="nf">setFallbackUri</span><span class="o">(</span><span class="n">String</span> <span class="n">fallbackUri</span><span class="o">)</span> <span class="o">{</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">fallbackUri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">setFallbackUri</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">fallbackUri</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>

    <span class="kd">public</span> <span class="n">URI</span> <span class="nf">getFallbackUri</span><span class="o">()</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">fallbackUri</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">// Note that for this method, the configured fallbackUri should start with forward as the schema, otherwise it will throw an exception
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFallbackUri</span><span class="o">(</span><span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fallbackUri</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">&#34;forward&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">fallbackUri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Hystrix Filter currently only supports &#39;forward&#39; URIs, found &#34;</span> <span class="o">+</span> <span class="n">fallbackUri</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fallbackUri</span> <span class="o">=</span> <span class="n">fallbackUri</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Config</span> <span class="nf">setSetter</span><span class="o">(</span><span class="n">Setter</span> <span class="n">setter</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">setter</span> <span class="o">=</span> <span class="n">setter</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition,</p>
<p>(1) the global <code>Hystrix</code> configuration will also take effect for <code>HystrixGatewayFilterFactory</code>;</p>
<p>(2) <code>HystrixGatewayFilterFactory</code> can be used as default-filters for all routing configurations as under-the-hood filters and function as such.</p>
<p>For point (1), if we configure the following in <code>application.yaml</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">// The execution timeout is 1 second and will take effect for the HystrixGatewayFilterFactory bound to the following route order_route</span><span class="w">
</span><span class="w"></span><span class="nt">hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">order_route</span><span class="w">
</span><span class="w">        </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:9091</span><span class="w">
</span><span class="w">        </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">Path=/order/**</span><span class="w">
</span><span class="w">        </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Hystrix</span><span class="w">
</span><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">HystrixCommand</span><span class="w">
</span><span class="w">            </span><span class="nt">fallbackUri</span><span class="p">:</span><span class="w"> </span><span class="l">forward:/fallback</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The configured <code>hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds</code> will take effect on the <code> HystrixGatewayFilterFactory</code> bound to the route <code>order_route</code>.</p>
<p>For point (2), we can configure <code>HystrixGatewayFilterFactory</code> as the default filter, so that all routes will be associated with this filter, but it is recommended not to do so unless necessary: <code>HystrixGatewayFilterFactory</code> is the default filter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">order_route</span><span class="w">
</span><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:9091</span><span class="w">
</span><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">Path=/order/**</span><span class="w">
</span><span class="w">      </span><span class="nt">default-filters</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Hystrix</span><span class="w">
</span><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">HystrixCommand</span><span class="w">
</span><span class="w">            </span><span class="nt">fallbackUri</span><span class="p">:</span><span class="w"> </span><span class="l">forward:/fallback</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>When I was testing, I found that the <code>Setter</code> mentioned above could not be configured, presumably because the <code>Setter</code> object of <code>Hystrix</code> is multi-packaged and there is no way to set the property for the time being. Next we have to add a controller method to the gateway service for handling redirected <code>/fallback</code> requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FallbackController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/fallback&#34;</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="nf">fallback</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;path&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;method&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethodValue</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">().</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Controller method entries are handled by the internal components of <code>Spring Cloud Gateway</code> and can call back some useful types such as <code>ServerWebExchange</code> instances, specific exception instances and so on.</p>
<h2 id="custom-filters-with-hystrix">Custom Filters with Hystrix</h2>
<p><code>HystrixGatewayFilterFactory</code> should meet business needs in most cases, but here also do a customization of a filter that integrates <code>Hystrix</code> and implements the following functionality.</p>
<ul>
<li>Creates a new instance of the Hystrix command to be invoked based on each request URL.</li>
<li>Each URL can specify a unique thread pool configuration, or use the default if not specified.</li>
<li>A separate Hystrix timeout can be configured for each URL.</li>
</ul>
<p>This means that each different external request URL is isolated by Hystrix using a thread pool. Of course, such a filter only makes sense if the number of different URLs for external requests is limited, otherwise there is a risk of creating too many thread pools causing system performance degradation, which is counterproductive. The modification is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomHystrixFilter</span> <span class="kd">extends</span> <span class="n">AbstractGatewayFilterFactory</span><span class="o">&lt;</span><span class="n">CustomHystrixFilter</span><span class="o">.</span><span class="na">Config</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FORWARD_KEY</span> <span class="o">=</span> <span class="s">&#34;forward&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&#34;CustomHystrix&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TIMEOUT_MS</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">DispatcherHandler</span><span class="o">&gt;</span> <span class="n">dispatcherHandlerProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">DispatcherHandler</span> <span class="n">dispatcherHandler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">processConfig</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CustomHystrixFilter</span><span class="o">(</span><span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">DispatcherHandler</span><span class="o">&gt;</span> <span class="n">dispatcherHandlerProvider</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dispatcherHandlerProvider</span> <span class="o">=</span> <span class="n">dispatcherHandlerProvider</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">DispatcherHandler</span> <span class="nf">getDispatcherHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dispatcherHandler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dispatcherHandler</span> <span class="o">=</span> <span class="n">dispatcherHandlerProvider</span><span class="o">.</span><span class="na">getIfAvailable</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">dispatcherHandler</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">shortcutFieldOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">NAME_KEY</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">GatewayFilter</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">processConfig</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">().</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">TIMEOUT_MS</span><span class="o">);</span>
            <span class="n">CustomHystrixCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomHystrixCommand</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getFallbackUri</span><span class="o">(),</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">chain</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">Subscription</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">toObservable</span><span class="o">().</span><span class="na">subscribe</span><span class="o">(</span><span class="n">s</span><span class="o">::</span><span class="n">success</span><span class="o">,</span> <span class="n">s</span><span class="o">::</span><span class="n">error</span><span class="o">,</span> <span class="n">s</span><span class="o">::</span><span class="n">success</span><span class="o">);</span>
                <span class="n">s</span><span class="o">.</span><span class="na">onCancel</span><span class="o">(</span><span class="n">sub</span><span class="o">::</span><span class="n">unsubscribe</span><span class="o">);</span>
            <span class="o">}).</span><span class="na">onErrorResume</span><span class="o">((</span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">,</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;)</span> <span class="n">throwable</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="k">instanceof</span> <span class="n">HystrixRuntimeException</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">HystrixRuntimeException</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">HystrixRuntimeException</span><span class="o">)</span> <span class="n">throwable</span><span class="o">;</span>
                    <span class="n">HystrixRuntimeException</span><span class="o">.</span><span class="na">FailureType</span> <span class="n">failureType</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getFailureType</span><span class="o">();</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">failureType</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="n">TIMEOUT</span><span class="o">:</span>
                            <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="n">TimeoutException</span><span class="o">());</span>
                        <span class="k">case</span> <span class="n">COMMAND_EXCEPTION</span><span class="o">:</span> <span class="o">{</span>
                            <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">ResponseStatusException</span> <span class="o">||</span> <span class="n">AnnotatedElementUtils</span>
                                    <span class="o">.</span><span class="na">findMergedAnnotation</span><span class="o">(</span><span class="n">cause</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">ResponseStatus</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">throwable</span><span class="o">);</span>
            <span class="o">}).</span><span class="na">then</span><span class="o">();</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * YAML parsing does not support &#39;/&#39; in MAP&#39;s KEY, so here you can only use &#39;-&#39; instead
</span><span class="cm">     *
</span><span class="cm">     * @param config config
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processConfig</span><span class="o">(</span><span class="n">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">processConfig</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processConfig</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">timeout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
                <span class="n">config</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">,</span> <span class="s">&#34;/&#34;</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">timeout</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
                <span class="o">});</span>
                <span class="n">config</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">name</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">NAME</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CustomHystrixCommand</span> <span class="kd">extends</span> <span class="n">HystrixObservableCommand</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CustomHystrixCommand</span><span class="o">(</span><span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">,</span>
                                    <span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span>
                                    <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">,</span>
                                    <span class="kt">int</span> <span class="n">timeout</span><span class="o">,</span>
                                    <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">Setter</span><span class="o">.</span><span class="na">withGroupKey</span><span class="o">(</span><span class="n">HystrixCommandGroupKey</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">asKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">andCommandKey</span><span class="o">(</span><span class="n">HystrixCommandKey</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">asKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">andCommandPropertiesDefaults</span><span class="o">(</span><span class="n">HystrixCommandProperties</span><span class="o">.</span><span class="na">Setter</span><span class="o">().</span><span class="na">withExecutionTimeoutInMilliseconds</span><span class="o">(</span><span class="n">timeout</span><span class="o">)));</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fallbackUri</span> <span class="o">=</span> <span class="n">fallbackUri</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">exchange</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">construct</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">RxReactiveStreams</span><span class="o">.</span><span class="na">toObservable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">resumeWithFallback</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">fallbackUri</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">resumeWithFallback</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getURI</span><span class="o">();</span>
            <span class="kt">boolean</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">containsEncodedParts</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
            <span class="n">URI</span> <span class="n">requestUrl</span> <span class="o">=</span> <span class="n">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUri</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">host</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">fallbackUri</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">encoded</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">toUri</span><span class="o">();</span>
            <span class="n">exchange</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">GATEWAY_REQUEST_URL_ATTR</span><span class="o">,</span> <span class="n">requestUrl</span><span class="o">);</span>
            <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">mutate</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="n">requestUrl</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="n">ServerWebExchange</span> <span class="n">mutated</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">mutate</span><span class="o">().</span><span class="na">request</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">RxReactiveStreams</span><span class="o">.</span><span class="na">toObservable</span><span class="o">(</span><span class="n">getDispatcherHandler</span><span class="o">().</span><span class="na">handle</span><span class="o">(</span><span class="n">mutated</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">;</span>
        <span class="cm">/**
</span><span class="cm">         * url -&gt; timeout ms
</span><span class="cm">         */</span>
        <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">timeout</span><span class="o">;</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Config</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">URI</span> <span class="nf">getFallbackUri</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">fallbackUri</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Config</span> <span class="nf">setFallbackUri</span><span class="o">(</span><span class="n">URI</span> <span class="n">fallbackUri</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fallbackUri</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FORWARD_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">fallbackUri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Hystrix Filter currently only supports &#39;forward&#39; URIs, found &#34;</span> <span class="o">+</span> <span class="n">fallbackUri</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fallbackUri</span> <span class="o">=</span> <span class="n">fallbackUri</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">getTimeout</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">timeout</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Config</span> <span class="nf">setTimeout</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In fact, most of the code is similar to the built-in Hystrix filter, only the command transformation function part and the configuration loading processing part have been changed. The configuration file is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">hystrix_route</span><span class="w">
</span><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:9091</span><span class="w">
</span><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">Host=localhost:9090</span><span class="w">
</span><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CustomHystrix</span><span class="w">
</span><span class="w">              </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">CustomHystrix</span><span class="w">
</span><span class="w">                </span><span class="nt">fallbackUri</span><span class="p">:</span><span class="w"> </span><span class="l">forward:/fallback</span><span class="w">
</span><span class="w">                </span><span class="nt">timeout</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="c"># 这里暂时用-分隔URL，因为/不支持</span><span class="w">
</span><span class="w">                  </span><span class="nt">order-remote</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">route-server</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9090</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The gateway adds a <code>/fallback</code> processing controller as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FallbackController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/fallback&#34;</span><span class="o">)</span>
    <span class="nd">@ResponseStatus</span>
    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="nf">fallback</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
        <span class="n">ServerHttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;path&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">pathWithinApplication</span><span class="o">().</span><span class="na">value</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;method&#34;</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethodValue</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">().</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Intentional downstream service interruption points.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">curl http://localhost:9090/order/remote

response ：
{
    &#34;path&#34;: &#34;/fallback&#34;,
    &#34;method&#34;: &#34;GET&#34;,
    &#34;message&#34;: null   # &lt;== Here the message is null because it is a timeout exception
}
</code></pre></td></tr></table>
</div>
</div><p>Just in line with the expected results.</p>
<h2 id="summary">Summary</h2>
<p>This article is just to <code>Hystrix</code> and filter application to provide a usable example and problem solving ideas, specific how to use or need for real scenarios.</p>
<hr>
<p>Reference <code>https://www.throwx.cn/2019/05/25/spring-cloud-gateway-hystrix/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring-cloud/">spring-cloud</a>
          <a href="/tags/spring-cloud-gateway/">spring-cloud-gateway</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-07/notes-on-the-use-of-feign-and-restful-design-specifications/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Notes on the Use of Feign and Restful Design Specifications</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-07/introduction-to-spring-cloud-stream/">
            <span class="next-text nav-default">Introduction to Spring Cloud Stream</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
