<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Java to introduce new object types to solve memory utilization problems - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="What new features and improvements are coming to Java in 2022 is something I&amp;rsquo;m sure many Java developers would like to know. Combine that with some recent sharing from Java language architect Brian Goetz (Brian Goetz). Here are some blurbs.
Valhalla Brian Goetz published a piece late last year called State of Valhalla, which Very informative, it mentions that back in 2014 the Java project team started a project called Valhalla, which will bring more flexible, flat data types to the JVM platform." /><meta name="keywords" content="java, Valhalla" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/java-valhalla/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Java to introduce new object types to solve memory utilization problems" />
<meta property="og:description" content="What new features and improvements are coming to Java in 2022 is something I&rsquo;m sure many Java developers would like to know. Combine that with some recent sharing from Java language architect Brian Goetz (Brian Goetz). Here are some blurbs.
Valhalla Brian Goetz published a piece late last year called State of Valhalla, which Very informative, it mentions that back in 2014 the Java project team started a project called Valhalla, which will bring more flexible, flat data types to the JVM platform." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/java-valhalla/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-19T13:07:46+08:00" />
<meta property="article:modified_time" content="2022-01-19T13:07:46+08:00" />

<meta itemprop="name" content="Java to introduce new object types to solve memory utilization problems">
<meta itemprop="description" content="What new features and improvements are coming to Java in 2022 is something I&rsquo;m sure many Java developers would like to know. Combine that with some recent sharing from Java language architect Brian Goetz (Brian Goetz). Here are some blurbs.
Valhalla Brian Goetz published a piece late last year called State of Valhalla, which Very informative, it mentions that back in 2014 the Java project team started a project called Valhalla, which will bring more flexible, flat data types to the JVM platform."><meta itemprop="datePublished" content="2022-01-19T13:07:46+08:00" />
<meta itemprop="dateModified" content="2022-01-19T13:07:46+08:00" />
<meta itemprop="wordCount" content="1062">
<meta itemprop="keywords" content="java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java to introduce new object types to solve memory utilization problems"/>
<meta name="twitter:description" content="What new features and improvements are coming to Java in 2022 is something I&rsquo;m sure many Java developers would like to know. Combine that with some recent sharing from Java language architect Brian Goetz (Brian Goetz). Here are some blurbs.
Valhalla Brian Goetz published a piece late last year called State of Valhalla, which Very informative, it mentions that back in 2014 the Java project team started a project called Valhalla, which will bring more flexible, flat data types to the JVM platform."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Java to introduce new object types to solve memory utilization problems</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-19 13:07:46 </span>
        <div class="post-category">
            <a href="/categories/news/"> news </a>
            </div>
          <span class="more-meta"> 1062 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#valhalla">Valhalla</a>
          <ul>
            <li><a href="#deficiencies-of-the-java-type-system">Deficiencies of the Java type system</a></li>
            <li><a href="#object-headers">Object headers</a></li>
            <li><a href="#value-class">Value Class</a></li>
          </ul>
        </li>
        <li><a href="#this-is-not-the-whole-story">This is not the whole story</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>What new features and improvements are coming to Java in 2022 is something I&rsquo;m sure many Java developers would like to know. Combine that with some recent sharing from Java language architect <strong>Brian Goetz</strong> (<strong>Brian Goetz</strong>). Here are some blurbs.</p>
<h2 id="valhalla">Valhalla</h2>
<p>Brian Goetz published a piece late last year called <a href="https://mail.openjdk.java.net/pipermail/valhalla-spec-experts/2021-December/001747.html">State of Valhalla</a>, which Very informative, it mentions that back in 2014 the Java project team started a project called <strong>Valhalla</strong>, which will bring more flexible, flat data types to the <strong>JVM</strong> platform. In 2021 there will be further moves to bring <strong>value objects</strong>, <strong>primitive classes</strong> and <strong>specialized generics</strong> to the <strong>JVM</strong> platform. Let&rsquo;s start today by talking about what <strong>value objects</strong> are.</p>
<p>We know what a &ldquo;value&rdquo; is and what an &ldquo;object&rdquo; is, but what is a &ldquo;value object&rdquo;? Not only are you confused, I&rsquo;m confused too, so let&rsquo;s look at it together.</p>
<h3 id="deficiencies-of-the-java-type-system">Deficiencies of the Java type system</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/8b8a3027a73143f8a6cd79eff637d015.png" alt="java"></p>
<p>The Java type system consists of 10 built-in types that cannot directly express complex data structures such as strings, 3D coordinates, spatial vectors etc., but developers can use these 10 types to model business entities and the Java type system is very useful.</p>
<p>However, Java types are still &lsquo;flawed&rsquo; in that two objects of the same class contain exactly the same properties, but they are not addressed in memory in the same way.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/8dd7d0821622431c89f94e96e51e10cd.png" alt="java"></p>
<blockquote>
<p>So in a sense they have their own identifier.</p>
</blockquote>
<p>But not for primitive types. If one variable of type <code>int</code> has value <code>7</code> and another also has value <code>7</code>, does it make sense to distinguish between them? Is this <code>7</code> or that <code>7</code>? Obviously, it is meaningless.</p>
<p>Let us take another realistic example. Two red dresses of the same size and material are certainly two different dresses, but they are certainly of one material and one colour, and no fool would think that they are two colours. The size here can certainly be described by the primitive types in Java, but the material and colour cannot (although the colour can be represented in hexadecimal), and here the size, material and colour should all be considered primitives.</p>
<blockquote>
<p>This pain point led to the creation of the <strong>Valhalla</strong> project.</p>
</blockquote>
<h3 id="object-headers">Object headers</h3>
<p>In order to understand what the <strong>Value Object / Class</strong> and <strong>Primitive Object / Class</strong> concepts introduced by <strong>Valhalla</strong> can bring to the table, we need to look at how the <strong>JVM</strong> keeps objects in memory.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/5ac122d0dd0745d4b11392fc0baa57d7.png" alt="java object"></p>
<p>The object header is very important for the object of the class, determining which thread can access the object, the rubbish collector tag, the object hash; and more importantly the object&rsquo;s type pointer, which enables dynamic access to the object&rsquo;s class at runtime and details from its class to that object, such as inheritance polymorphism and reflection.</p>
<p>But there are two sides to everything, the size of the memory footprint of a Java object depends on the sum of the information it contains, the object header needs at least 16 bytes on 64-bit systems and at least 8 bytes on 32-bit systems (of course the JVM can set how the object header is stored via a configuration item). Many objects don&rsquo;t need to be multi-threaded and don&rsquo;t need any object identification, like the <strong>color of the dress</strong> mentioned above, only the <strong>value of the color</strong> is something we care about. This redundant memory footprint makes Java a criticism.</p>
<h3 id="value-class">Value Class</h3>
<p>For many objects, the equivalence of the values of their properties is what we care about, other class information is of little use, and classes written only to hold values and operate on them represent a very large proportion of all classes. The <strong>Valhalla</strong> project has introduced a new class type for such scenarios: <strong>Value Class</strong>. It is still only a <strong>JEP</strong> draft, but it is already taking shape.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">value</span> <span class="kd">class</span> <span class="nc">Substring</span> <span class="kd">implements</span> <span class="n">CharSequence</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">str</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">start</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">Substring</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">,</span> <span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkBounds</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">str</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">length</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">char</span> <span class="nf">charAt</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkBounds</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">length</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Substring</span> <span class="nf">subSequence</span><span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">,</span> <span class="kt">int</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkBounds</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">length</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Substring</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">s</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">str</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">checkBounds</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">||</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">end</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IndexOutOfBoundsException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Value Class</strong> is similar to our common classes, but it may (and is still under discussion here) have some of the following properties.</p>
<ul>
<li>A value object is an object without an identity; normally we check the identity with the <code>==</code> operator, which may no longer be distinct from <code>equals()</code> here.</li>
<li>The value class itself and all its fields are <code>final</code> by default.</li>
<li>The class does not directly or indirectly implement <code>java.lang.IdentityObject</code> (a new superclass with an identity class). This means that the superclass is either a stateless abstract class, or <code>Object</code> is a stateless abstract class.</li>
<li>Value classes are implicit implementations of <code>java.lang.ValueObject</code>.</li>
<li>There is no constructor <code>super</code> function to call the constructor. Instances will be created without executing any superclass initialization code.</li>
<li>Cannot use the <code>synchronized</code> keyword in the value class.</li>
<li>(Possibly) The class does not declare a <code>finalize()</code> method.</li>
<li>(Possibly) The constructor does not use <code>this</code> to set the fields in the body of the constructor, or possibly after all fields have been explicitly memory allocated.</li>
</ul>
<p>Other operations should not differ much from normal classes, but note that some of the original classes in the JDK standard library need to be handled for compatibility if they are identified as <strong>Value Class</strong>.</p>
<blockquote>
<p><strong>value</strong> to be a reserved word or a keyword?</p>
</blockquote>
<h2 id="this-is-not-the-whole-story">This is not the whole story</h2>
<p><strong>Value Class</strong> neuters the Java class object header in favour of reducing Java&rsquo;s memory consumption, but that&rsquo;s not all that <strong>Valhalla</strong> plans to do. I actually had a hard time writing this part, which is too far ahead of its time, and it took me several days to conceive it. Understanding the design of a programming language from a scenario is good for improving yourself from the ground up.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">java</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/deep-link-deferred-deeplink/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">App Deep Linking and Delayed Deep Linking</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/go-string-bytes/">
            <span class="next-text nav-default">string and []byte conversion problem in golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
