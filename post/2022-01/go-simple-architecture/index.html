<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang Simple Architecture in Action - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Since golang does not have a uniform coding pattern like java, we, like the rest of the team, used some of the theory presented in the article Go Package Oriented Design and Architecture Layering and then combined it with our previous project experience to define the packge. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ├── cmd/" /><meta name="keywords" content="golang, Simple Architecture" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/go-simple-architecture/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Golang Simple Architecture in Action" />
<meta property="og:description" content="Since golang does not have a uniform coding pattern like java, we, like the rest of the team, used some of the theory presented in the article Go Package Oriented Design and Architecture Layering and then combined it with our previous project experience to define the packge. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ├── cmd/" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/go-simple-architecture/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-21T09:16:30+08:00" />
<meta property="article:modified_time" content="2022-01-21T09:16:30+08:00" />

<meta itemprop="name" content="Golang Simple Architecture in Action">
<meta itemprop="description" content="Since golang does not have a uniform coding pattern like java, we, like the rest of the team, used some of the theory presented in the article Go Package Oriented Design and Architecture Layering and then combined it with our previous project experience to define the packge. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ├── cmd/"><meta itemprop="datePublished" content="2022-01-21T09:16:30+08:00" />
<meta itemprop="dateModified" content="2022-01-21T09:16:30+08:00" />
<meta itemprop="wordCount" content="2810">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang Simple Architecture in Action"/>
<meta name="twitter:description" content="Since golang does not have a uniform coding pattern like java, we, like the rest of the team, used some of the theory presented in the article Go Package Oriented Design and Architecture Layering and then combined it with our previous project experience to define the packge. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ├── cmd/"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang Simple Architecture in Action</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-21 09:16:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2810 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#the-clean-architecture">The Clean Architecture</a>
          <ul>
            <li><a href="#models">models</a></li>
            <li><a href="#repo">repo</a></li>
            <li><a href="#service">service</a></li>
            <li><a href="#api">api</a></li>
          </ul>
        </li>
        <li><a href="#interface-oriented-programming">Interface-oriented programming</a></li>
        <li><a href="#dependency-injection-di">Dependency Injection DI</a></li>
        <li><a href="#testing">Testing</a>
          <ul>
            <li><a href="#repo-layer-testing">repo layer testing</a></li>
            <li><a href="#service-layer-testing">service layer testing</a></li>
            <li><a href="#api-layer-testing">api layer testing</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Since golang does not have a uniform coding pattern like java, we, like the rest of the team, used some of the theory presented in the article <a href="https://github.com/danceyoung/paper-code/blob/master/package-oriented-design/packageorienteddesign.md">Go Package Oriented Design and Architecture Layering</a> and then combined it with our previous project experience to define the packge.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">├── cmd/
│   └── main.go //启动函数
├── etc
│   └── dev_conf.yaml              // 配置文件 
├── global
│   └── global.go //全局变量引用，如数据库、kafka等
├── internal/
│       └── service/
│           └── xxx_service.go //业务逻辑处理类
│           └── xxx_service_test.go 
│       └── model/
│           └── xxx_info.go//结构体
│       └── api/
│           └── xxx_api.go//路由对应的接口实现
│       └── router/
│           └── router.go//路由
│       └── pkg/
│           └── datetool//时间工具类
│           └── jsontool//json 工具类
</code></pre></td></tr></table>
</div>
</div><p>In fact, this division above is only a simple division of functions into packages, there are still many problems in the process of project practice. For example.</p>
<p>For the function implementation do I pass it through the parameters of a function or through the variables of a structure?</p>
<p>Is it safe to use a reference to a database global variable? Is there excessive coupling?</p>
<p>Almost all of the code implementation is implementation dependent rather than interface dependent, so does switching from MySQL to MongDB require all the implementation changes?</p>
<p>So now as we work with more and more code, the code feels more and more chaotic with all the init, function, struct and global variables.</p>
<p>Each module is not independent, it seems to be divided into modules according to logic, but there is no clear relationship between the upper and lower levels, each module may have configuration reading, external service calls, protocol conversion, etc..</p>
<p>Over time, the calls between the different package functions of the service slowly evolve into a mesh structure, and the flow of data and logic becomes more and more complex to sort out, making it difficult to figure out the flow of data without looking at the code calls.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/eef65e598d0644658231dc55eb9835a7.png" alt="sobyte"></p>
<p>But as it says in Refactoring: first make the code work - if it doesn&rsquo;t work, it can&rsquo;t produce value; then try to make it better - by refactoring the code so that we ourselves and others understand it better and can keep modifying it as needed.</p>
<p>So I think it&rsquo;s time for some self-change.</p>
<h2 id="the-clean-architecture">The Clean Architecture</h2>
<p>The Clean Architecture sets out a number of requirements for our projects.</p>
<ul>
<li>Independence from the framework. The architecture is not dependent on the existence of certain feature-rich software libraries. This allows you to use these frameworks as tools, rather than cramming your system into their limited constraints.</li>
<li>Testable. Business rules can be tested without a UI, database, web server or any other external elements.</li>
<li>Independent of the user interface. the UI can be easily changed without having to alter the rest of the system. For example, a Web UI can be replaced with a console UI without changing the business rules.</li>
<li>Database independent. You can swap out Oracle or SQL Server for Mongo, BigTable, CouchDB or something else. Your business rules are not bound by the database.</li>
<li>Independence from any external bodies. In fact, your business rules don&rsquo;t know anything about the outside world at all.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/3e189acb48a6499ebc22635f76205752.png" alt="sobyte"></p>
<p>The concentric circles in the diagram above represent a variety of different areas of software. Generally speaking, the deeper you go the higher the level of software you have. The outer circles are the tactical implementation mechanisms and the inner circles are the strategic core strategy.</p>
<p>For our projects, code dependencies should be outward to inward, one-way single-level dependencies that contain code names, or functions of classes, variables or any other named software entities.</p>
<p>For a clean architecture there are four layers.</p>
<ul>
<li>Entities: Entities</li>
<li>Usecase: expresses the application business rules, corresponding to the application layer, which encapsulates and implements all the use cases of the system.</li>
<li>Interface Adapters: the software in this layer is basically adapters that are used to convert the data in use cases and entities into data for use in external systems such as databases or the Web.</li>
<li>Framework &amp; Driver: the outermost circle is usually made up of frameworks and tools such as Database, Web Framework, etc.</li>
</ul>
<p>For my project, then, it is also divided into four layers.</p>
<ul>
<li>models</li>
<li>repo</li>
<li>service</li>
<li>api</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/920425eb1f1e4c4b8f0d82843aa07e89.png" alt="sobyte"></p>
<h3 id="models">models</h3>
<p>Encapsulates various entity class objects, those that interact with the database, those that interact with the UI, etc. Any entity class should be placed here. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;time&#34;</span>

<span class="kd">type</span> <span class="nx">Article</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>        <span class="kt">int64</span>     <span class="s">`json:&#34;id&#34;`</span>
    <span class="nx">Title</span>     <span class="kt">string</span>    <span class="s">`json:&#34;title&#34;`</span>
    <span class="nx">Content</span>   <span class="kt">string</span>    <span class="s">`json:&#34;content&#34;`</span>
    <span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;updated_at&#34;`</span>
    <span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span> <span class="s">`json:&#34;created_at&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="repo">repo</h3>
<p>This is where the database operation classes are stored, the database CRUD is all here. It is important to note that this does not contain any business logic code, as many people like to put business logic here as well.</p>
<p>If you are using ORM, then this is where you would put the code for ORM operations; if you are using microservices, then this is where you would put the code for other service requests.</p>
<h3 id="service">service</h3>
<p>This is the business logic layer, where all the business process code should be placed. This layer will determine what code is requested from the repo layer, whether to manipulate the database or to call other services; all business data calculations should also be placed here; the input accepted here should be that passed in by the controller.</p>
<h3 id="api">api</h3>
<p>This is the code that receives external requests, e.g. gin&rsquo;s corresponding handler, gRPC, other REST API framework access layers, etc.</p>
<h2 id="interface-oriented-programming">Interface-oriented programming</h2>
<p>Except for the models layer, layers should interact with each other via interfaces, not implementations. If you want to call the repo layer with a service, then you should call the repo&rsquo;s interface. Then when modifying the underlying implementation our base class in the upper layer does not need to be changed, we just need to replace the underlying implementation.</p>
<p>For example, if we want to look up all the articles, we can provide this interface in the repo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">repo</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/models&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="c1">// IArticleRepo represent the article&#39;s repository contract
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">IArticleRepo</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">createdDate</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">num</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">res</span> <span class="p">[]</span><span class="nx">models</span><span class="p">.</span><span class="nx">Article</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The implementation class of this interface can be changed according to the requirements, for example when we want mysql to be used as a stored query, then we just need to provide a base class like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">mysqlArticleRepository</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">DB</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">}</span>

<span class="c1">// NewMysqlArticleRepository will create an object that represent the article.Repository interface
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewMysqlArticleRepository</span><span class="p">(</span><span class="nx">DB</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="nx">IArticleRepo</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">mysqlArticleRepository</span><span class="p">{</span><span class="nx">DB</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">mysqlArticleRepository</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">createdDate</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span>
    <span class="nx">num</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">res</span> <span class="p">[]</span><span class="nx">models</span><span class="p">.</span><span class="nx">Article</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">Article</span><span class="p">{}).</span>
        <span class="nf">Select</span><span class="p">(</span><span class="s">&#34;id,title,content, updated_at, created_at&#34;</span><span class="p">).</span>
        <span class="nf">Where</span><span class="p">(</span><span class="s">&#34;created_at &gt; ?&#34;</span><span class="p">,</span> <span class="nx">createdDate</span><span class="p">).</span><span class="nf">Limit</span><span class="p">(</span><span class="nx">num</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">res</span><span class="p">).</span><span class="nx">Error</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If we want to switch to MongoDB to implement our storage, we can simply define a structure to implement the IArticleRepo interface.</p>
<p>Then we can inject the corresponding repo implementation into the service level implementation as we need it, without changing the service level implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">articleService</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">articleRepo</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">IArticleRepo</span>
<span class="p">}</span>

<span class="c1">// NewArticleService will create new an articleUsecase object representation of domain.ArticleUsecase interface
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewArticleService</span><span class="p">(</span><span class="nx">a</span> <span class="nx">repo</span><span class="p">.</span><span class="nx">IArticleRepo</span><span class="p">)</span> <span class="nx">IArticleService</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">articleService</span><span class="p">{</span>
        <span class="nx">articleRepo</span><span class="p">:</span> <span class="nx">a</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Fetch
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">articleService</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">createdDate</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">num</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">res</span> <span class="p">[]</span><span class="nx">models</span><span class="p">.</span><span class="nx">Article</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">num</span> <span class="p">=</span> <span class="mi">10</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">articleRepo</span><span class="p">.</span><span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">createdDate</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="dependency-injection-di">Dependency Injection DI</h2>
<p>Dependency injection, or DI for short, used to be common in java projects, but many people in go say it&rsquo;s not needed, but I think it&rsquo;s still necessary in large software development, otherwise it can only be passed through global variables or method parameters.</p>
<p>As for what DI is, it is simply a dependent module that is injected into (i.e. passed as an argument to) a module when it is created. For a more in-depth understanding of what DI is, here are some more recommendations <a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency injection</a> and <a href="https://martinfowler.com/articles/injection.html">Inversion of Control Containers and the Dependency Injection pattern</a>.</p>
<p>There are two main inconveniences if you don&rsquo;t use DI. One is that modifications to the underlying classes require modifications to the upper classes, and in large software development processes there are many base classes, so a single link can easily require dozens of files to be modified.</p>
<p>Because of the use of dependency injection, it is inevitable that a large number of new will be written during the initialisation process, for example, in our project we need this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;my-clean-rchitecture/api&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/api/handlers&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/app&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/repo&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/service&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> 
    <span class="c1">// 初始化db
</span><span class="c1"></span>    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">InitDB</span><span class="p">()</span> 
    <span class="c1">//初始化 repo
</span><span class="c1"></span>    <span class="nx">repository</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">NewMysqlArticleRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
    <span class="c1">//初始化service
</span><span class="c1"></span>    <span class="nx">articleService</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">NewArticleService</span><span class="p">(</span><span class="nx">repository</span><span class="p">)</span>
    <span class="c1">//初始化api
</span><span class="c1"></span>    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">NewArticleHandler</span><span class="p">(</span><span class="nx">articleService</span><span class="p">)</span>
    <span class="c1">//初始化router
</span><span class="c1"></span>    <span class="nx">router</span> <span class="o">:=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
    <span class="c1">//初始化gin
</span><span class="c1"></span>    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewGinEngine</span><span class="p">()</span>
    <span class="c1">//初始化server
</span><span class="c1"></span>    <span class="nx">server</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">engine</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span>
    <span class="c1">//启动
</span><span class="c1"></span>    <span class="nx">server</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>So for such a piece of code, is there any way we don&rsquo;t have to write it ourselves? Here we can use the power of frameworks to generate our injection code.</p>
<p>In go DI tools are not as convenient as in java, and the main technical frameworks are: wire, dig, fx, etc. Since wire uses code generation for injection, the performance is higher and it is a DI framework introduced by google, so we use wire for injection here.</p>
<p>The requirements for wire are simple, create a new wire.go file (the name of the file is optional) and create our initialisation functions. For example, if we want to create and initialise a server object, we can do so.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//+build wireinject
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/google/wire&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/api&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/api/handlers&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/app&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/repo&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/service&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">InitServer</span><span class="p">()</span> <span class="o">*</span><span class="nx">app</span><span class="p">.</span><span class="nx">Server</span> <span class="p">{</span>
    <span class="nx">wire</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">InitDB</span><span class="p">,</span>
        <span class="nx">repo</span><span class="p">.</span><span class="nx">NewMysqlArticleRepository</span><span class="p">,</span>
        <span class="nx">service</span><span class="p">.</span><span class="nx">NewArticleService</span><span class="p">,</span>
        <span class="nx">handlers</span><span class="p">.</span><span class="nx">NewArticleHandler</span><span class="p">,</span>
        <span class="nx">api</span><span class="p">.</span><span class="nx">NewRouter</span><span class="p">,</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">,</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">NewGinEngine</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">app</span><span class="p">.</span><span class="nx">Server</span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that the annotation in the first line: +build wireinject, indicates that this is an injector.</p>
<p>In the function, we call <code>wire.Build()</code> to pass in the constructor for the type on which the Server is created. Executing the wire command after writing the wire.go file will automatically generate a wire_gen.go file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by Wire. DO NOT EDIT.
</span><span class="c1"></span>
<span class="c1">//go:generate go run github.com/google/wire/cmd/wire
</span><span class="c1">//+build !wireinject
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;my-clean-rchitecture/api&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/api/handlers&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/app&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/repo&#34;</span>
    <span class="s">&#34;my-clean-rchitecture/service&#34;</span>
<span class="p">)</span>

<span class="c1">// Injectors from wire.go:
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">InitServer</span><span class="p">()</span> <span class="o">*</span><span class="nx">app</span><span class="p">.</span><span class="nx">Server</span> <span class="p">{</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewGinEngine</span><span class="p">()</span>
    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">InitDB</span><span class="p">()</span>
    <span class="nx">iArticleRepo</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">NewMysqlArticleRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
    <span class="nx">iArticleService</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">NewArticleService</span><span class="p">(</span><span class="nx">iArticleRepo</span><span class="p">)</span>
    <span class="nx">articleHandler</span> <span class="o">:=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">NewArticleHandler</span><span class="p">(</span><span class="nx">iArticleService</span><span class="p">)</span>
    <span class="nx">router</span> <span class="o">:=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">(</span><span class="nx">articleHandler</span><span class="p">)</span>
    <span class="nx">server</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">engine</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">server</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that wire automatically generates the InitServer method for us, which initialises all the base classes in turn. After that, we can just call this InitServer in our main function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">server</span> <span class="o">:=</span> <span class="nf">InitServer</span><span class="p">()</span>
    <span class="nx">server</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="testing">Testing</h2>
<p>Having defined what each layer should do above, we should be able to test each layer individually, even if another layer does not exist.</p>
<ul>
<li>models layer: for this layer it&rsquo;s very simple, as it doesn&rsquo;t depend on any other code, so it can be tested directly with go&rsquo;s single test framework.</li>
<li>repo layer: for this layer, since we use a mysql database, we need to mock mysql so that we can test it even without connecting to mysql.</li>
<li>service layer: since the service layer depends on the repo layer, and since they are related through an interface, I use github.com/golang/mock/gomock to mock the repo layer.</li>
<li>The api layer: this layer depends on the service layer and is related through an interface, so you can also use gomock to mock the service layer. However, this is a little trickier because we are using gin for the access layer, so we need to simulate sending requests in a single test.</li>
</ul>
<p>As we are mocking through <code>github.com/golang/mock/gomock</code>, we need to perform a bit of code generation and put the generated mock code into the mock package as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">mockgen -destination .<span class="se">\m</span>ock<span class="se">\r</span>epo_mock.go -source .<span class="se">\r</span>epo<span class="se">\r</span>epo.go -package mock

mockgen -destination .<span class="se">\m</span>ock<span class="se">\s</span>ervice_mock.go -source .<span class="se">\s</span>ervice<span class="se">\s</span>ervice.go -package mock
</code></pre></td></tr></table>
</div>
</div><p>These two commands will automatically generate the mock function for me through the interface.</p>
<h3 id="repo-layer-testing">repo layer testing</h3>
<p>In the project, since we are using gorm as our orm library, we need to use <code>github.com/DATA-DOG/go-sqlmock</code> in conjunction with gorm to do the mock.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">getSqlMock</span><span class="p">()</span> <span class="p">(</span><span class="nx">mock</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nx">Sqlmock</span><span class="p">,</span> <span class="nx">gormDB</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//创建sqlmock
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="kd">var</span> <span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span>
    <span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nx">QueryMatcherEqual</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//结合gorm、sqlmock
</span><span class="c1"></span>    <span class="nx">gormDB</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">mysql</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">mysql</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
        <span class="nx">SkipInitializeWithVersion</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">Conn</span><span class="p">:</span>                      <span class="nx">db</span><span class="p">,</span>
    <span class="p">}),</span> <span class="o">&amp;</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
    <span class="k">if</span> <span class="kc">nil</span> <span class="o">!=</span> <span class="nx">err</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Init DB with sqlmock failed, err %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Test_mysqlArticleRepository_Fetch</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">createAt</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="nx">updateAt</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="c1">//id,title,content, updated_at, created_at
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">articles</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">models</span><span class="p">.</span><span class="nx">Article</span><span class="p">{</span>
        <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;test1&#34;</span><span class="p">,</span> <span class="s">&#34;content&#34;</span><span class="p">,</span> <span class="nx">updateAt</span><span class="p">,</span> <span class="nx">createAt</span><span class="p">},</span>
        <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;test2&#34;</span><span class="p">,</span> <span class="s">&#34;content2&#34;</span><span class="p">,</span> <span class="nx">updateAt</span><span class="p">,</span> <span class="nx">createAt</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="nx">limit</span> <span class="o">:=</span> <span class="mi">2</span>
    <span class="nx">mock</span><span class="p">,</span> <span class="nx">db</span> <span class="o">:=</span> <span class="nf">getSqlMock</span><span class="p">()</span>

    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT id,title,content, updated_at, created_at FROM `articles` WHERE created_at &gt; ? LIMIT 2&#34;</span><span class="p">).</span>
        <span class="nf">WithArgs</span><span class="p">(</span><span class="nx">createAt</span><span class="p">).</span>
        <span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;content&#34;</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span><span class="p">,</span> <span class="s">&#34;created_at&#34;</span><span class="p">}).</span>
            <span class="nf">AddRow</span><span class="p">(</span><span class="nx">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Content</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">UpdatedAt</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">CreatedAt</span><span class="p">).</span>
            <span class="nf">AddRow</span><span class="p">(</span><span class="nx">articles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Content</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">UpdatedAt</span><span class="p">,</span> <span class="nx">articles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">CreatedAt</span><span class="p">))</span>

    <span class="nx">repository</span> <span class="o">:=</span> <span class="nf">NewMysqlArticleRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
    <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repository</span><span class="p">.</span><span class="nf">Fetch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">createAt</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nf">Nil</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">articles</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="service-layer-testing">service layer testing</h3>
<p>The main thing here is to use our gomock-generated code to mock the repo layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Test_articleService_Fetch</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">ctl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
    <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="nx">mockRepo</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">NewMockIArticleRepo</span><span class="p">(</span><span class="nx">ctl</span><span class="p">)</span>

    <span class="nx">gomock</span><span class="p">.</span><span class="nf">InOrder</span><span class="p">(</span>
        <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span><span class="nf">Fetch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">now</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nx">service</span> <span class="o">:=</span> <span class="nf">NewArticleService</span><span class="p">(</span><span class="nx">mockRepo</span><span class="p">)</span>

    <span class="nx">fetch</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">Fetch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">now</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">fetch</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="api-layer-testing">api layer testing</h3>
<p>For this layer, we not only mock the service layer, but also send httptest to simulate the request being sent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestArticleHandler_FetchArticle</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">ctl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">ctl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
    <span class="nx">createAt</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">&#34;2006-01-02&#34;</span><span class="p">,</span> <span class="s">&#34;2021-12-26&#34;</span><span class="p">)</span>
    <span class="nx">mockService</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">NewMockIArticleService</span><span class="p">(</span><span class="nx">ctl</span><span class="p">)</span>

    <span class="nx">gomock</span><span class="p">.</span><span class="nf">InOrder</span><span class="p">(</span>
        <span class="nx">mockService</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span><span class="nf">Fetch</span><span class="p">(</span><span class="nx">gomock</span><span class="p">.</span><span class="nf">Any</span><span class="p">(),</span> <span class="nx">createAt</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nf">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nx">article</span> <span class="o">:=</span> <span class="nf">NewArticleHandler</span><span class="p">(</span><span class="nx">mockService</span><span class="p">)</span>

    <span class="nx">gin</span><span class="p">.</span><span class="nf">SetMode</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nx">TestMode</span><span class="p">)</span>

    <span class="c1">// Setup your router, just like you did in your main function, and
</span><span class="c1"></span>    <span class="c1">// register your routes
</span><span class="c1"></span>    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/articles&#34;</span><span class="p">,</span> <span class="nx">article</span><span class="p">.</span><span class="nx">FetchArticle</span><span class="p">)</span>

    <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span><span class="p">,</span> <span class="s">&#34;/articles?num=10&amp;create_date=2021-12-26&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Couldn&#39;t create request: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">w</span> <span class="o">:=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">()</span>
    <span class="c1">// Perform the request
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

    <span class="c1">// Check to see if the response was what you expected
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Code</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Expected to get status %d but instead got %d\n&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Code</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>The above is a little summary of the problems I found in the golang project, and I don&rsquo;t care if it&rsquo;s right, it&rsquo;s a solution to some of our current problems. However, the project will always need to be refactored, so if there are problems next time, we can change them next time.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/go-source-code-panic-and-recover/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Exploring what are the pitfalls of panic &amp; recover in Go source code?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/vue-3-as-new-default/">
            <span class="next-text nav-default">Evan You announces: Vue 3 will be the new default version</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
