<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Using Failpoint to inject faults in Go - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="When I was looking at the TiDB source code recently, I found it very interesting that failpoint is used for fault injection. It uses code generation and code AST tree parsing and replacement to implement failpoint, I will also try to parse it to learn how to parse the AST tree to generate code. I will also try to parse it and learn how to parse the AST tree to" /><meta name="keywords" content="golang, Failpoint" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/go-failpoint/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Using Failpoint to inject faults in Go" />
<meta property="og:description" content="When I was looking at the TiDB source code recently, I found it very interesting that failpoint is used for fault injection. It uses code generation and code AST tree parsing and replacement to implement failpoint, I will also try to parse it to learn how to parse the AST tree to generate code. I will also try to parse it and learn how to parse the AST tree to" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/go-failpoint/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-21T14:04:36+08:00" />
<meta property="article:modified_time" content="2022-01-21T14:04:36+08:00" />

<meta itemprop="name" content="Using Failpoint to inject faults in Go">
<meta itemprop="description" content="When I was looking at the TiDB source code recently, I found it very interesting that failpoint is used for fault injection. It uses code generation and code AST tree parsing and replacement to implement failpoint, I will also try to parse it to learn how to parse the AST tree to generate code. I will also try to parse it and learn how to parse the AST tree to"><meta itemprop="datePublished" content="2022-01-21T14:04:36+08:00" />
<meta itemprop="dateModified" content="2022-01-21T14:04:36+08:00" />
<meta itemprop="wordCount" content="3793">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Failpoint to inject faults in Go"/>
<meta name="twitter:description" content="When I was looking at the TiDB source code recently, I found it very interesting that failpoint is used for fault injection. It uses code generation and code AST tree parsing and replacement to implement failpoint, I will also try to parse it to learn how to parse the AST tree to generate code. I will also try to parse it and learn how to parse the AST tree to"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Using Failpoint to inject faults in Go</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-21 14:04:36 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3793 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preface">Preface</a></li>
        <li><a href="#use">Use</a></li>
        <li><a href="#principle-of-implementation">Principle of implementation</a>
          <ul>
            <li><a href="#code-injection">Code injection</a></li>
            <li><a href="#failpoint-execution">failpoint execution</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>When I was looking at the TiDB source code recently, I found it very interesting that failpoint is used for fault injection. It uses code generation and code AST tree parsing and replacement to implement failpoint, I will also try to parse it to learn how to parse the AST tree to generate code.</p>
<p>I will also try to parse it and learn how to parse the AST tree to generate code. So this article will mainly look at the use of failpoint in detail and how it is implemented.</p>
<h2 id="preface">Preface</h2>
<p>failpoint is a tool for injecting errors during testing, it is a Golang implementation of FreeBSD <a href="http://www.freebsd.org/cgi/man.cgi?query=fail">Failpoints</a>. Usually we have various test scenarios to improve the stability of our system, but some scenarios are very difficult to simulate, e.g. random delays in a service or unavailability of a service in microservices; simulating scenarios of unstable player networks, dropped frames, excessive latency, etc. in game development.</p>
<p>So in order to test for these problems easily, failpoint was developed, which greatly simplifies our testing process and helps us to simulate various errors in various scenarios so that we can debug code bugs.</p>
<p>The main advantages for failpoint are.</p>
<ul>
<li>there should not be any additional overhead in the failpoint related code.</li>
<li>it must not interfere with the normal functional logic and must not intrude into the functional code in any way.</li>
<li>failpoint code must be easy to read, easy to write and able to introduce compiler detection.</li>
<li>the final generated code must be readable</li>
<li>the line numbers of the functional logic code must not change in the generated code (to facilitate debugging)</li>
</ul>
<h2 id="use">Use</h2>
<p>First we need to build using the source code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">git</span> <span class="nx">clone</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/pingcap/failpoint.git
</span><span class="c1"></span><span class="nx">cd</span> <span class="nx">failpoint</span>
<span class="nx">make</span>
<span class="nx">ls</span> <span class="nx">bin</span><span class="o">/</span><span class="nx">failpoint</span><span class="o">-</span><span class="nx">ctl</span>
</code></pre></td></tr></table>
</div>
</div><p>Translate the binary <code>failpoint-ctl</code> for code conversion.</p>
<p>The failpoint can then be used inside the code to inject faults.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;github.com/pingcap/failpoint&#34;</span>
<span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Inject</span><span class="p">(</span><span class="s">&#34;testValue&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="p">&lt;</span><span class="mi">100</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">{</span>
        <span class="nf">test</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can see this when we go to the Inject method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Inject</span><span class="p">(</span><span class="nx">fpname</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fpbody</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>When failpoint is not enabled, it is just an empty implementation and does not have any impact on the performance of our business logic. When our service code is compiled and built, this piece of code is optimized inline, which is the zero cost fault injection principle implemented by failpoint.</p>
<p>Here we convert all the above test functions into usable fault injection code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ failpoint/bin/failpoint-ctl <span class="nb">enable</span> .
</code></pre></td></tr></table>
</div>
</div><p>Call the compiled <code>failpoint-ctl</code> to rewrite the current code for conversion.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/pingcap/failpoint&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">_err_</span> <span class="o">:=</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nf">_curpkg_</span><span class="p">(</span><span class="s">&#34;testValue&#34;</span><span class="p">));</span> <span class="nx">_err_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nf">test</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Below we perform the injection on the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nv">GO_FAILPOINTS</span><span class="o">=</span><span class="s1">&#39;main/testValue=2*return(&#34;abc&#34;)&#39;</span> go run main.go binding__failpoint_binding__.go 
abc
abc
</code></pre></td></tr></table>
</div>
</div><p>In the above example 2 means that the injection will only be performed twice, and the argument in <code>return(&quot;abc&quot;)</code> corresponds to the v variable obtained in the injection function.</p>
<p>In addition to this we can set the probability of it taking effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">GO_FAILPOINTS</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">main</span><span class="o">/</span><span class="nx">testValue</span><span class="p">=</span><span class="mi">5</span><span class="o">%</span><span class="k">return</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">)</span><span class="err">&#39;</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span> <span class="nx">binding__failpoint_binding__</span><span class="p">.</span><span class="k">go</span> 
<span class="nx">abc</span>
<span class="nx">abc</span>
<span class="nx">abc</span>
<span class="nx">abc</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>5%</code> in the above use case means that only 5% of the validity returns abc.</p>
<p>In addition to the simple example above, it can be used to generate more complex scenarios.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/pingcap/failpoint&#34;</span>
    <span class="s">&#34;math/rand&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">&#34;outer&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Label</span><span class="p">(</span><span class="s">&#34;inner&#34;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Break</span><span class="p">()</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">7</span><span class="p">:</span>
                <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Continue</span><span class="p">(</span><span class="s">&#34;outer&#34;</span><span class="p">)</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">9</span><span class="p">:</span>
                <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Fallthrough</span><span class="p">()</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">10</span><span class="p">:</span>
                <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Goto</span><span class="p">(</span><span class="s">&#34;outer&#34;</span><span class="p">)</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Inject</span><span class="p">(</span><span class="s">&#34;failpoint-name&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">val</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;unit-test&#34;</span><span class="p">,</span> <span class="nx">val</span><span class="p">.(</span><span class="kt">int</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">j</span><span class="o">/</span><span class="mi">11</span> <span class="p">{</span>
                        <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Break</span><span class="p">(</span><span class="s">&#34;inner&#34;</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Goto</span><span class="p">(</span><span class="s">&#34;outer&#34;</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this example, <code>failpoint.Break</code>, <code>failpoint.Goto</code>, <code>failpoint.Continue</code> and <code>failpoint.Label</code> are used to implement the code jumps and the final generated code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
<span class="nx">outer</span><span class="p">:</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">inner</span><span class="p">:</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">+</span> <span class="nx">i</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">continue</span> <span class="nx">outer</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">9</span><span class="p">:</span>
                <span class="k">fallthrough</span>
            <span class="k">case</span> <span class="nx">j</span> <span class="o">/</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">goto</span> <span class="nx">outer</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="k">if</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_err_</span> <span class="o">:=</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nf">_curpkg_</span><span class="p">(</span><span class="s">&#34;failpoint-name&#34;</span><span class="p">));</span> <span class="nx">_err_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;unit-test&#34;</span><span class="p">,</span> <span class="nx">val</span><span class="p">.(</span><span class="kt">int</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">j</span><span class="o">/</span><span class="mi">11</span> <span class="p">{</span>
                        <span class="k">break</span> <span class="nx">inner</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">goto</span> <span class="nx">outer</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that our failpoint code above is translated into the jump keyword in Go.</p>
<p>After testing, we can finally revert the code by disable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">failpoint</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">failpoint</span><span class="o">-</span><span class="nx">ctl</span> <span class="nx">disable</span> <span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><p>Additional usage can be found in the official documentation at</p>
<p><a href="https://github.com/pingcap/failpoint">https://github.com/pingcap/failpoint</a></p>
<h2 id="principle-of-implementation">Principle of implementation</h2>
<h3 id="code-injection">Code injection</h3>
<h4 id="for-an-example">for an example</h4>
<p>When using failpoint we build our failure track using a series of Marker functions that it provides.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Inject</span><span class="p">(</span><span class="nx">fpname</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fpblock</span> <span class="kd">func</span><span class="p">(</span><span class="nx">val</span> <span class="nx">Value</span><span class="p">))</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">InjectContext</span><span class="p">(</span><span class="nx">fpname</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">fpblock</span> <span class="kd">func</span><span class="p">(</span><span class="nx">val</span> <span class="nx">Value</span><span class="p">))</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Break</span><span class="p">(</span><span class="nx">label</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Goto</span><span class="p">(</span><span class="nx">label</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Continue</span><span class="p">(</span><span class="nx">label</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Fallthrough</span><span class="p">()</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Return</span><span class="p">(</span><span class="nx">results</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{}</span>
<span class="kd">func</span> <span class="nf">Label</span><span class="p">(</span><span class="nx">label</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is then converted by <code>failpoint-ctl</code> to build an AST replacing marker stmt, which is converted to the final injector code as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/pingcap/failpoint&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Inject</span><span class="p">(</span><span class="s">&#34;testPanic&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">val</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nx">Value</span><span class="p">){</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nf">test</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After conversion</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;github.com/pingcap/failpoint&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_err_</span> <span class="o">:=</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nf">_curpkg_</span><span class="p">(</span><span class="s">&#34;testPanic&#34;</span><span class="p">));</span> <span class="nx">_err_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nf">test</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>failpoint-ctl</code> conversion generates a <code>binding__failpoint_binding__.go</code> file with a <code>_curpkg_</code> function to get the current package name, in addition to replacing the code content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;reflect&#34;</span>

<span class="kd">type</span> <span class="nx">__failpointBindingType</span> <span class="kd">struct</span> <span class="p">{</span><span class="nx">pkgpath</span> <span class="kt">string</span><span class="p">}</span>
<span class="kd">var</span> <span class="nx">__failpointBindingCache</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">__failpointBindingType</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">__failpointBindingCache</span><span class="p">.</span><span class="nx">pkgpath</span> <span class="p">=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">__failpointBindingType</span><span class="p">{}).</span><span class="nf">PkgPath</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">_curpkg_</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span>  <span class="nx">__failpointBindingCache</span><span class="p">.</span><span class="nx">pkgpath</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">name</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="getting-the-code-ast-tree">Getting the code AST tree</h4>
<p>When we call <code>failpoint-ctl</code> for code conversion, we rewrite the code using Rewriter, a tool structure that detects Marker functions and rewrites them by traversing the code AST tree.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Rewriter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">rewriteDir</span>    <span class="kt">string</span> <span class="c1">// 重写路径
</span><span class="c1"></span>    <span class="nx">currentPath</span>   <span class="kt">string</span> <span class="c1">// 文件路径
</span><span class="c1"></span>    <span class="nx">currentFile</span>   <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">File</span> <span class="c1">// 文件 AST 树
</span><span class="c1"></span>    <span class="nx">currsetFset</span>   <span class="o">*</span><span class="nx">token</span><span class="p">.</span><span class="nx">FileSet</span> <span class="c1">// FileSet
</span><span class="c1"></span>    <span class="nx">failpointName</span> <span class="kt">string</span> <span class="c1">// import 中 failpoint 的导入重命名
</span><span class="c1"></span>    <span class="nx">rewritten</span>     <span class="kt">bool</span> <span class="c1">// 是否重写完毕
</span><span class="c1"></span>
    <span class="nx">output</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span> <span class="c1">// 重定向输出
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The execution of <code>failpoint-ctl</code> will call the RewriteFile method for code rewriting.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rewriter</span><span class="p">)</span> <span class="nf">RewriteFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s %v\n%s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">currentPath</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">debug</span><span class="p">.</span><span class="nf">Stack</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="nx">fset</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nf">NewFileSet</span><span class="p">()</span>
    <span class="c1">// 获取go文件AST树
</span><span class="c1"></span>    <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parser</span><span class="p">.</span><span class="nf">ParseFile</span><span class="p">(</span><span class="nx">fset</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ParseComments</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">Decls</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="c1">// 文件路径
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nx">currentPath</span> <span class="p">=</span> <span class="nx">path</span>
    <span class="c1">// 文件AST树
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nx">currentFile</span> <span class="p">=</span> <span class="nx">file</span>
    <span class="c1">// 文件 FileSet
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nx">currsetFset</span> <span class="p">=</span> <span class="nx">fset</span>
    <span class="c1">// 标记是否重写完毕
</span><span class="c1"></span>    <span class="nx">r</span><span class="p">.</span><span class="nx">rewritten</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="c1">// 获取 failpoint import 包
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">failpointImport</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">ImportSpec</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">imp</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">file</span><span class="p">.</span><span class="nx">Imports</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Trim</span><span class="p">(</span><span class="nx">imp</span><span class="p">.</span><span class="nx">Path</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="s">&#34;`\&#34;&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">packagePath</span> <span class="p">{</span>
            <span class="nx">failpointImport</span> <span class="p">=</span> <span class="nx">imp</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">failpointImport</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;import path should be check before rewrite&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">failpointImport</span><span class="p">.</span><span class="nx">Name</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">failpointName</span> <span class="p">=</span> <span class="nx">failpointImport</span><span class="p">.</span><span class="nx">Name</span><span class="p">.</span><span class="nx">Name</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">failpointName</span> <span class="p">=</span> <span class="nx">packageName</span>
    <span class="p">}</span>
    <span class="c1">// 遍历文件中的顶级声明：如type、函数、import、全局常量等
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">decl</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">file</span><span class="p">.</span><span class="nx">Decls</span> <span class="p">{</span>
        <span class="nx">fn</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">decl</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">FuncDecl</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="c1">// 遍历函数声明节点，将failpoint相关函数进行替换
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">rewriteFuncDecl</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">rewritten</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">output</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Node</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">fset</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 生成 binding__failpoint_binding__ 代码
</span><span class="c1"></span>    <span class="nx">found</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">isBindingFileExists</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// binding__failpoint_binding__.go文件不存在，那么重新生成一个
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeBindingFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">Name</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 将原文件改名，如：将main.go改名为main.go__failpoint_stash__
</span><span class="c1"></span>    <span class="c1">// 用来做作为还原使用
</span><span class="c1"></span>    <span class="nx">targetPath</span> <span class="o">:=</span> <span class="nx">path</span> <span class="o">+</span> <span class="nx">failpointStashFileSuffix</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Rename</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">newFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">ModePerm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">newFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="c1">//将构造好的ast树重新生成代码文件
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Node</span><span class="p">(</span><span class="nx">newFile</span><span class="p">,</span> <span class="nx">fset</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This method first calls the Go-provided <code>parser.ParseFile</code> method to get the AST tree of the file, which uses a tree structure to represent the syntactic structure of the source code, with each node of the tree representing a structure in the source code. The AST tree is then traversed through the top declaration <code>Decls</code> slice, which is equivalent to traversing down from the top of the tree, a depth-first traversal.</p>
<p>After the traversal is complete, the entire file is rewritten by checking the <code>binding__failpoint_binding__</code> file and calling <code>format.Node</code> after the source file has been backed up.</p>
<h4 id="code-ast-tree-traversal-to-get-rewriter-perform-node-replacement">Code AST tree traversal to get Rewriter Perform node replacement</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rewriter</span><span class="p">)</span> <span class="nf">rewriteStmts</span><span class="p">(</span><span class="nx">stmts</span> <span class="p">[]</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Stmt</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// 遍历函数体节点
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">block</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">stmts</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">block</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">DeclStmt</span><span class="p">:</span>
            <span class="o">...</span> 
        <span class="c1">// 包含单独的表达式语句
</span><span class="c1"></span>        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">ExprStmt</span><span class="p">:</span>
            <span class="nx">call</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">X</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">CallExpr</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="k">switch</span> <span class="nx">expr</span> <span class="o">:=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Fun</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 函数定义
</span><span class="c1"></span>            <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">FuncLit</span><span class="p">:</span>
                <span class="c1">// 递归遍历函数
</span><span class="c1"></span>                <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">rewriteFuncLit</span><span class="p">(</span><span class="nx">expr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">err</span>
                <span class="p">}</span>
            <span class="c1">// 选择结构,类似于a.b的结构
</span><span class="c1"></span>            <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">SelectorExpr</span><span class="p">:</span>
                <span class="c1">// 获取函数调用的包名
</span><span class="c1"></span>                <span class="nx">packageName</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">X</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Ident</span><span class="p">)</span>
                <span class="c1">// 包名是否等于 failpoint 包名
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">packageName</span><span class="p">.</span><span class="nx">Name</span> <span class="o">!=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">failpointName</span> <span class="p">{</span>
                    <span class="k">break</span>
                <span class="p">}</span>
                <span class="c1">// 通过 Marker 名获取 failpoint 的 Rewriter
</span><span class="c1"></span>                <span class="nx">exprRewriter</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">exprRewriters</span><span class="p">[</span><span class="nx">expr</span><span class="p">.</span><span class="nx">Sel</span><span class="p">.</span><span class="nx">Name</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
                    <span class="k">break</span>
                <span class="p">}</span>
                <span class="c1">// 对函数进行重写
</span><span class="c1"></span>                <span class="nx">rewritten</span><span class="p">,</span> <span class="nx">stmt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">exprRewriter</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">call</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">err</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">!</span><span class="nx">rewritten</span> <span class="p">{</span>
                    <span class="k">continue</span>
                <span class="p">}</span>
                <span class="c1">// 获取重新生成好的if节点
</span><span class="c1"></span>                <span class="k">if</span> <span class="nx">ifStmt</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stmt</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">IfStmt</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
                    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">rewriteIfStmt</span><span class="p">(</span><span class="nx">ifStmt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">err</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="c1">// 节点替换为重新生成好的if节点
</span><span class="c1"></span>                <span class="nx">stmts</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">stmt</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">rewritten</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="p">}</span>

        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">AssignStmt</span><span class="p">:</span>
            <span class="o">...</span> 
        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">GoStmt</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">DeferStmt</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="k">case</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">ReturnStmt</span><span class="p">:</span> 
        <span class="o">...</span> 
        <span class="k">default</span><span class="p">:</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;unsupported statement: %T in %s\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here all functions are traversed in turn until the failpoint Marker declaration is found, and then the corresponding Rewriter is retrieved in exprRewriters by Marker name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">exprRewriters</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">exprRewriter</span><span class="p">{</span>
    <span class="s">&#34;Inject&#34;</span><span class="p">:</span>        <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteInject</span><span class="p">,</span>
    <span class="s">&#34;InjectContext&#34;</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteInjectContext</span><span class="p">,</span>
    <span class="s">&#34;Break&#34;</span><span class="p">:</span>         <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteBreak</span><span class="p">,</span>
    <span class="s">&#34;Continue&#34;</span><span class="p">:</span>      <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteContinue</span><span class="p">,</span>
    <span class="s">&#34;Label&#34;</span><span class="p">:</span>         <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteLabel</span><span class="p">,</span>
    <span class="s">&#34;Goto&#34;</span><span class="p">:</span>          <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteGoto</span><span class="p">,</span>
    <span class="s">&#34;Fallthrough&#34;</span><span class="p">:</span>   <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteFallthrough</span><span class="p">,</span>
    <span class="s">&#34;Return&#34;</span><span class="p">:</span>        <span class="p">(</span><span class="o">*</span><span class="nx">Rewriter</span><span class="p">).</span><span class="nx">rewriteReturn</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="rewriter-rewrites">Rewriter Rewrites</h4>
<p>Our example above uses <code>failpoint.Inject</code>, so it is explained here using rewriteInject.</p>
<p>This method will eventually convert:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Inject</span><span class="p">(</span><span class="s">&#34;testPanic&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">val</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nx">Value</span><span class="p">){</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>to:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="k">if</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_err_</span> <span class="o">:=</span> <span class="nx">failpoint</span><span class="p">.</span><span class="nf">Eval</span><span class="p">(</span><span class="nf">_curpkg_</span><span class="p">(</span><span class="s">&#34;testPanic&#34;</span><span class="p">));</span> <span class="nx">_err_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s how the AST tree is constructed</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rewriter</span><span class="p">)</span> <span class="nf">rewriteInject</span><span class="p">(</span><span class="nx">call</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">CallExpr</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="nx">ast</span><span class="p">.</span><span class="nx">Stmt</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//判断函数failpoint.Inject调用是否合法
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: expect 2 arguments but got %v in %s&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">),</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
    <span class="p">}</span> 
    <span class="c1">// 获取第一个参数 “testPanic”
</span><span class="c1"></span>    <span class="nx">fpname</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">].(</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: first argument expect a valid expression in %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="c1">// 获取第二个参数 func(val failpoint.Value){}
</span><span class="c1"></span>    <span class="nx">ident</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">].(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Ident</span><span class="p">)</span>
    <span class="c1">// 判断第二个参数是否为空
</span><span class="c1"></span>    <span class="nx">isNilFunc</span> <span class="o">:=</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">ident</span><span class="p">.</span><span class="nx">Name</span> <span class="o">==</span> <span class="s">&#34;nil&#34;</span>

    <span class="c1">// 校验第二个参数是函数的情况，因为第二个函数参数可以为空
</span><span class="c1"></span>    <span class="c1">// failpoint.Inject(&#34;failpoint-name&#34;, func(){...})
</span><span class="c1"></span>    <span class="c1">// failpoint.Inject(&#34;failpoint-name&#34;, func(val failpoint.Value){...})
</span><span class="c1"></span>    <span class="nx">fpbody</span><span class="p">,</span> <span class="nx">isFuncLit</span> <span class="o">:=</span> <span class="nx">call</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">].(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">FuncLit</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">isNilFunc</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">isFuncLit</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: second argument expect closure in %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="c1">// 第二个参数是函数的情况
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">isFuncLit</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpbody</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: closure signature illegal in %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpbody</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpbody</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">List</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Names</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: closure signature illegal in %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//构建替换函数：_curpkg_(&#34;testPanic&#34;)
</span><span class="c1"></span>    <span class="nx">fpnameExtendCall</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">CallExpr</span><span class="p">{</span>
        <span class="nx">Fun</span><span class="p">:</span>  <span class="nx">ast</span><span class="p">.</span><span class="nf">NewIdent</span><span class="p">(</span><span class="nx">extendPkgName</span><span class="p">),</span>
        <span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Expr</span><span class="p">{</span><span class="nx">fpname</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="c1">//构建函数 failpoint.Eval
</span><span class="c1"></span>    <span class="nx">checkCall</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">CallExpr</span><span class="p">{</span>
        <span class="nx">Fun</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">SelectorExpr</span><span class="p">{</span>
            <span class="nx">X</span><span class="p">:</span>   <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Ident</span><span class="p">{</span><span class="nx">NamePos</span><span class="p">:</span> <span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">(),</span> <span class="nx">Name</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">failpointName</span><span class="p">},</span>
            <span class="nx">Sel</span><span class="p">:</span> <span class="nx">ast</span><span class="p">.</span><span class="nf">NewIdent</span><span class="p">(</span><span class="nx">evalFunction</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Expr</span><span class="p">{</span><span class="nx">fpnameExtendCall</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">isNilFunc</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpbody</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">ExprStmt</span><span class="p">{</span><span class="nx">X</span><span class="p">:</span> <span class="nx">checkCall</span><span class="p">},</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="c1">// 构建if代码块
</span><span class="c1"></span>    <span class="nx">ifBody</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">BlockStmt</span><span class="p">{</span>
        <span class="nx">Lbrace</span><span class="p">:</span> <span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">(),</span>
        <span class="nx">List</span><span class="p">:</span>   <span class="nx">fpbody</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">List</span><span class="p">,</span>
        <span class="nx">Rbrace</span><span class="p">:</span> <span class="nx">call</span><span class="p">.</span><span class="nf">End</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1">// 校验failpoint中的闭包函数是否是包含参数的
</span><span class="c1"></span>    <span class="c1">// func(val failpoint.Value) {...}
</span><span class="c1"></span>    <span class="c1">// func() {...}
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">argName</span> <span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Ident</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpbody</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">arg</span> <span class="o">:=</span> <span class="nx">fpbody</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">List</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">selector</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Type</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">SelectorExpr</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">Sel</span><span class="p">.</span><span class="nx">Name</span> <span class="o">!=</span> <span class="s">&#34;Value&#34;</span> <span class="o">||</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">X</span><span class="p">.(</span><span class="o">*</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Ident</span><span class="p">).</span><span class="nx">Name</span> <span class="o">!=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">failpointName</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failpoint.Inject: invalid signature in %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">pos</span><span class="p">(</span><span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">()))</span>
        <span class="p">}</span>
        <span class="nx">argName</span> <span class="p">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">Names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">argName</span> <span class="p">=</span> <span class="nx">ast</span><span class="p">.</span><span class="nf">NewIdent</span><span class="p">(</span><span class="s">&#34;_&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 构建 failpoint.Eval 的返回值
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ast</span><span class="p">.</span><span class="nf">NewIdent</span><span class="p">(</span><span class="s">&#34;_err_&#34;</span><span class="p">)</span>
    <span class="nx">init</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">AssignStmt</span><span class="p">{</span>
        <span class="nx">Lhs</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Expr</span><span class="p">{</span><span class="nx">argName</span><span class="p">,</span> <span class="nx">err</span><span class="p">},</span>
        <span class="nx">Rhs</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ast</span><span class="p">.</span><span class="nx">Expr</span><span class="p">{</span><span class="nx">checkCall</span><span class="p">},</span>
        <span class="nx">Tok</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">DEFINE</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1">// 构建 if 的判断条件，也就是 _err_ == nil
</span><span class="c1"></span>    <span class="nx">cond</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">BinaryExpr</span><span class="p">{</span>
        <span class="nx">X</span><span class="p">:</span>  <span class="nx">err</span><span class="p">,</span>
        <span class="nx">Op</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">EQL</span><span class="p">,</span>
        <span class="nx">Y</span><span class="p">:</span>  <span class="nx">ast</span><span class="p">.</span><span class="nf">NewIdent</span><span class="p">(</span><span class="s">&#34;nil&#34;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="c1">// 构建完整 if 代码块
</span><span class="c1"></span>    <span class="nx">stmt</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ast</span><span class="p">.</span><span class="nx">IfStmt</span><span class="p">{</span>
        <span class="nx">If</span><span class="p">:</span>   <span class="nx">call</span><span class="p">.</span><span class="nf">Pos</span><span class="p">(),</span>
        <span class="nx">Init</span><span class="p">:</span> <span class="nx">init</span><span class="p">,</span>
        <span class="nx">Cond</span><span class="p">:</span> <span class="nx">cond</span><span class="p">,</span>
        <span class="nx">Body</span><span class="p">:</span> <span class="nx">ifBody</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">stmt</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The comments above should be very detailed, so you can follow the comments to see the code.</p>
<h3 id="failpoint-execution">failpoint execution</h3>
<h4 id="building-a-failure-scenario">Building a failure scenario</h4>
<p>Let&rsquo;s say we have a 5% chance of this failure being triggered, then we could do this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">GO_FAILPOINTS</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">main</span><span class="o">/</span><span class="nx">testValue</span><span class="p">=</span><span class="mi">5</span><span class="o">%</span><span class="k">return</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">)</span><span class="err">&#39;</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span> <span class="nx">binding__failpoint_binding__</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><p>The contents of the GO_FAILPOINTS variable declared above will be read at initialisation time and the corresponding mechanism will be registered and fault controlled at execution time according to the registered mechanism.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">failpoints</span><span class="p">.</span><span class="nx">reg</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Failpoint</span><span class="p">)</span>
    <span class="c1">// 获取 GO_FAILPOINTS 变量
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">s</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;GO_FAILPOINTS&#34;</span><span class="p">);</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span> 
        <span class="c1">// 多个值使用；进行分割
</span><span class="c1"></span>        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fp</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&#34;;&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fpTerms</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">fp</span><span class="p">,</span> <span class="s">&#34;=&#34;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fpTerms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;bad failpoint %q\n&#34;</span><span class="p">,</span> <span class="nx">fp</span><span class="p">)</span>
                <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="c1">// 注册注入方案
</span><span class="c1"></span>            <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Enable</span><span class="p">(</span><span class="nx">fpTerms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">fpTerms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;bad failpoint %s\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">s</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;GO_FAILPOINTS_HTTP&#34;</span><span class="p">);</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Enable will finally be called in the Enable method of the Failpoints structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Failpoints</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">mu</span>  <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>  <span class="c1">//并发控制
</span><span class="c1"></span>    <span class="nx">reg</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Failpoint</span> <span class="c1">//故障方案表
</span><span class="c1"></span><span class="p">}</span>

<span class="nx">Failpoint</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">mu</span>       <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>  <span class="c1">//并发控制
</span><span class="c1"></span>    <span class="nx">t</span>        <span class="o">*</span><span class="nx">terms</span>
    <span class="nx">waitChan</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="c1">// 用来做暂停
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Enable will parse <code>main/testValue=5%return(&quot;abc&quot;)</code> into the reg map as a key-value, and the value will be parsed into the Failpoint structure.</p>
<p>The fault control scheme in the Failpoint structure is mainly stored in the term structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">term</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">desc</span> <span class="kt">string</span> <span class="c1">//方案描述，这里是 5%return(&#34;abc&#34;)
</span><span class="c1"></span>
    <span class="nx">mods</span> <span class="nx">mod</span> <span class="c1">// 方案类型，是故障概率控制还是故障次数控制，这里是 5%
</span><span class="c1"></span>    <span class="nx">act</span>  <span class="nx">actFunc</span> <span class="c1">// 故障行为，这里是 return
</span><span class="c1"></span>    <span class="nx">val</span>  <span class="kd">interface</span><span class="p">{}</span> <span class="c1">// 注入故障的值，这里是 abc
</span><span class="c1"></span>
    <span class="nx">parent</span> <span class="o">*</span><span class="nx">terms</span>
    <span class="nx">fp</span>     <span class="o">*</span><span class="nx">Failpoint</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We have used return above to enforce the fault, in addition to 6 others.</p>
<ul>
<li>off: Take no action (does not trigger failpoint code)</li>
<li>return: Trigger failpoint with specified argument</li>
<li>sleep: Sleep the specified number of milliseconds</li>
<li>panic: Panic</li>
<li>break: Execute gdb and break into debugger</li>
<li>print: Print failpoint path for inject variable</li>
<li>pause: Pause will pause until the failpoint is disabled</li>
</ul>
<p>The hierarchy of the entire Filpoint is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/7bf2304cb58845af9a119bbbb77f3bcb.png" alt="sobyte"></p>
<p>Here we look at Enable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">fp</span> <span class="o">*</span><span class="nx">Failpoint</span><span class="p">)</span> <span class="nf">Enable</span><span class="p">(</span><span class="nx">inTerms</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newTerms</span><span class="p">(</span><span class="nx">inTerms</span><span class="p">,</span> <span class="nx">fp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">t</span> <span class="p">=</span> <span class="nx">t</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">waitChan</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
    <span class="nx">fp</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Enable is mainly a call to newTerms to build the terms structure</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newTerms</span><span class="p">(</span><span class="nx">desc</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fp</span> <span class="o">*</span><span class="nx">Failpoint</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">terms</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 解析传入的策略
</span><span class="c1"></span>    <span class="nx">chain</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">desc</span><span class="p">,</span> <span class="nx">fp</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">terms</span><span class="p">{</span><span class="nx">chain</span><span class="p">:</span> <span class="nx">chain</span><span class="p">,</span> <span class="nx">desc</span><span class="p">:</span> <span class="nx">desc</span><span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">chain</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">parent</span> <span class="p">=</span> <span class="nx">t</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Parse the incoming policy by parse and construct terms to return.</p>
<h4 id="fault-execution">fault execution</h4>
<p>Eval` is executed when we run the fault code, and then determines whether the fault function will be executed based on whether err is returned.</p>
<p>The Eval function will call the Eval method of the Failpoints.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">fps</span> <span class="o">*</span><span class="nx">Failpoints</span><span class="p">)</span> <span class="nf">Eval</span><span class="p">(</span><span class="nx">failpath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Value</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fps</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
    <span class="c1">// 获取注册的 Failpoint
</span><span class="c1"></span>    <span class="nx">fp</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">fps</span><span class="p">.</span><span class="nx">reg</span><span class="p">[</span><span class="nx">failpath</span><span class="p">]</span>
    <span class="nx">fps</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">ErrNotExist</span><span class="p">,</span> <span class="s">&#34;error on %s&#34;</span><span class="p">,</span> <span class="nx">failpath</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 执行方案判断
</span><span class="c1"></span>    <span class="nx">val</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fp</span><span class="p">.</span><span class="nf">Eval</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;error on %s&#34;</span><span class="p">,</span> <span class="nx">failpath</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The reg map called in the Eval method is the scheme registered in the init function we mentioned above, and its Eval method will be called when the Failpoint is retrieved</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/8b2b1532b5cc4dd7aafc3d86a2ecbb01.png" alt="sobyte"></p>
<p>The Eval method calls the eval method of terms to iterate through the <code>chain []*term</code> field, get the scheme set in it and call the allow method to check if it passes, then call the do method to perform the corresponding action.</p>
<h2 id="summary">Summary</h2>
<p>In the above introduction we first learned how to use Failpoint to serve our code, and then how Failpoint can be used to implement fault injection by way of code injection. This included Go&rsquo;s AST tree traversal modifications, as well as code generation, and also provided an idea of how we can provide some additional functionality in our own code when writing it in this way.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/endless-restart/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How does endless achieve a non-stop restart of Go programs?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/go-ycsb/">
            <span class="next-text nav-default">Exploring Go-YCSB for database benchmarking</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
