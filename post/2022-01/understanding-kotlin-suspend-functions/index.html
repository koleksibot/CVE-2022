<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Understanding Kotlin Suspend Functions - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="suspend is a callback Understanding suspend doesn&amp;rsquo;t really require getting hung up on what the magic &amp;ldquo;hang&amp;rdquo; means or how threads are switched. In fact, behind suspend is a very familiar callback. Suppose postItem consists of three asynchronous subtasks with dependencies: requestToken, createPost and processPost, all of which are callback-based APIs. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ä¸‰ä¸ª" /><meta name="keywords" content="kotlin , Suspend Functions" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/understanding-kotlin-suspend-functions/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Understanding Kotlin Suspend Functions" />
<meta property="og:description" content="suspend is a callback Understanding suspend doesn&rsquo;t really require getting hung up on what the magic &ldquo;hang&rdquo; means or how threads are switched. In fact, behind suspend is a very familiar callback. Suppose postItem consists of three asynchronous subtasks with dependencies: requestToken, createPost and processPost, all of which are callback-based APIs. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ä¸‰ä¸ª" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/understanding-kotlin-suspend-functions/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-15T13:18:00+08:00" />
<meta property="article:modified_time" content="2022-01-15T13:18:00+08:00" />

<meta itemprop="name" content="Understanding Kotlin Suspend Functions">
<meta itemprop="description" content="suspend is a callback Understanding suspend doesn&rsquo;t really require getting hung up on what the magic &ldquo;hang&rdquo; means or how threads are switched. In fact, behind suspend is a very familiar callback. Suppose postItem consists of three asynchronous subtasks with dependencies: requestToken, createPost and processPost, all of which are callback-based APIs. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ä¸‰ä¸ª"><meta itemprop="datePublished" content="2022-01-15T13:18:00+08:00" />
<meta itemprop="dateModified" content="2022-01-15T13:18:00+08:00" />
<meta itemprop="wordCount" content="3139">
<meta itemprop="keywords" content="kotlin," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Understanding Kotlin Suspend Functions"/>
<meta name="twitter:description" content="suspend is a callback Understanding suspend doesn&rsquo;t really require getting hung up on what the magic &ldquo;hang&rdquo; means or how threads are switched. In fact, behind suspend is a very familiar callback. Suppose postItem consists of three asynchronous subtasks with dependencies: requestToken, createPost and processPost, all of which are callback-based APIs. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ä¸‰ä¸ª"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Understanding Kotlin Suspend Functions</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-15 13:18:00 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3139 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#suspend-is-a-callback"><code>suspend</code> is a callback</a></li>
        <li><a href="#principle-of-suspend">Principle of <code>suspend</code></a></li>
        <li><a href="#using-the-suspend-function-without-caring-about-thread-switching">Using the <code>suspend</code> function without caring about thread switching</a></li>
        <li><a href="#its-not-just-io-that-can-be-suspend">It&rsquo;s not just IO that can be <code>suspend</code></a>
          <ul>
            <li><a href="#android-view-api">Android View API</a></li>
            <li><a href="#functional-exception-handling">Functional exception handling</a></li>
            <li><a href="#deep-recursion">Deep recursion</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="suspend-is-a-callback"><code>suspend</code> is a callback</h2>
<p>Understanding <code>suspend</code> doesn&rsquo;t really require getting hung up on what the magic &ldquo;hang&rdquo; means or how threads are switched. In fact, behind <code>suspend</code> is a very familiar callback.</p>
<p>Suppose <code>postItem</code> consists of three asynchronous subtasks with dependencies: <code>requestToken</code>, <code>createPost</code> and <code>processPost</code>, all of which are callback-based APIs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// ä¸‰ä¸ªåŸºäºå›è°ƒçš„ API
</span><span class="c1"></span><span class="k">fun</span> <span class="nf">requestToken</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Unit</span><span class="p">)</span>
<span class="k">fun</span> <span class="nf">createPost</span><span class="p">(</span>
  <span class="n">token</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
  <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span>
  <span class="n">block</span><span class="p">:</span> <span class="p">(</span><span class="n">Post</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Unit</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">fun</span> <span class="nf">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span>

<span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">requestToken</span> <span class="p">{</span> <span class="n">token</span> <span class="o">-&gt;</span>
    <span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span> <span class="n">post</span> <span class="o">-&gt;</span>
      <span class="n">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see callback-based APIs can easily cause a lot of indentation. APIs such as Promise (Future) and RxJava, which is popular in the Android community, eliminate the problem of nesting to some extent by chaining calls. For example, if the above example is implemented in RxJava.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="nf">requestToken</span><span class="p">():</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span>
<span class="k">fun</span> <span class="nf">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;</span>
<span class="k">fun</span> <span class="nf">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span>

<span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">=</span> <span class="n">requestToken</span><span class="p">()</span>
  <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">createPost</span><span class="p">(</span><span class="k">it</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">processPost</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, RxJava requires users to master a lot of operators, and writing complex logic can be cumbersome, making you feel &ldquo;trapped&rdquo; in the call chain.</p>
<p>Kotlin&rsquo;s <code>suspend</code> keyword can help us to eliminate callbacks and write asynchronously in a synchronous way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">requestToken</span><span class="p">():</span> <span class="n">String</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span> <span class="n">Post</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">requestToken</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">post</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
  <span class="err">ğŸ¹</span> <span class="n">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="principle-of-suspend">Principle of <code>suspend</code></h2>
<p>Since the <code>createPost</code> methods are actually time-consuming IO asynchronous operations that need to wait until the return value is available before executing the logic that follows, but we don&rsquo;t want to block the current thread (usually the main thread), we must eventually implement some kind of message passing mechanism that allows the background thread to pass the result to the main thread after doing the time-consuming operation.</p>
<p>Assuming we have the three callback-based APIs mentioned above, implementing <code>suspend</code> would wrap the logic behind each pendant starting point ğŸ¹ in a lambda at compile time, and then call the callback API, resulting in nested-like code. Kotlin and many other languages use a generative state machine for better performance.</p>
<p>Specifically, the compiler sees the <code>suspend</code> keyword and removes the <code>suspend</code> and adds an extra <code>Continuation</code> argument to the function. This <code>Continuation</code> represents a callback.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">public</span> <span class="k">interface</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">val</span> <span class="py">context</span><span class="p">:</span> <span class="n">CoroutineContext</span>

  <span class="c1">// ç”¨æ¥å›è°ƒçš„æ–¹æ³•
</span><span class="c1"></span>  <span class="k">public</span> <span class="k">fun</span> <span class="nf">resumeWith</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Kotlin compiler generates a <code>Continuation</code> implementation class for each suspend block, which is a state machine in which the state corresponding to each pending start point holds the context (i.e., dependent local variables) needed to continue execution next, similar to the following pseudo-code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">requestToken</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">post</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
  <span class="err">ğŸ¹</span> <span class="n">processPost</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ç¼–è¯‘å™¨å˜æ¢åçš„ä¼ªä»£ç 
</span><span class="c1">// 1.è„±æ‰äº† suspend å…³é”®å­—
</span><span class="c1">// 2.å¢åŠ äº†ä¸€ä¸ª Continuation å¯¹è±¡
</span><span class="c1"></span><span class="k">fun</span> <span class="nf">postItem</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span> <span class="n">cont</span><span class="p">:</span> <span class="n">Continuation</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// åˆ¤æ–­ä¼ å…¥çš„æ˜¯å¦æ˜¯ postItem çš„ `ContiuationImpl`
</span><span class="c1"></span>  <span class="c1">// * false: åˆå§‹åŒ–ä¸€ä¸ªå¯¹åº”æœ¬æ¬¡è°ƒç”¨ postItem çš„çŠ¶æ€æœº
</span><span class="c1"></span>  <span class="c1">// * true: å¯¹åº” postItem å†…å…¶ä»– suspend å‡½æ•°å›è°ƒå›æ¥æƒ…å†µ
</span><span class="c1"></span>  <span class="c1">// å…¶ä¸­ ThisSM æŒ‡çš„ object: ContinuationImpl è¿™ä¸ªåŒ¿åç±»
</span><span class="c1"></span>  <span class="k">val</span> <span class="py">sm</span> <span class="p">=</span> <span class="p">(</span><span class="n">cont</span> <span class="k">as</span><span class="p">?</span> <span class="n">ThisSM</span><span class="p">)</span> <span class="o">?:</span> <span class="k">object</span><span class="p">:</span> <span class="n">ContinuationImpl</span> <span class="p">{</span>

    <span class="c1">// å®é™…æºç ä¸­ override çš„æ˜¯
</span><span class="c1"></span>    <span class="c1">// kotlin.coroutine.jvm.internal.BaseContinuationImpl
</span><span class="c1"></span>    <span class="c1">// çš„ invokeSuspend æ–¹æ³•
</span><span class="c1"></span>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">resume</span><span class="p">(</span><span class="o">..</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// é€šè¿‡ ContinuationImpl.resume
</span><span class="c1"></span>      <span class="c1">// é‡æ–°å›è°ƒå›è¿™ä¸ªæ–¹æ³•
</span><span class="c1"></span>      <span class="n">postItem</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">switch</span> <span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="m">0</span><span class="p">:</span>
      <span class="c1">// æ•è·åç»­æ­¥éª¤éœ€è¦çš„å±€éƒ¨å˜é‡
</span><span class="c1"></span>      <span class="n">sm</span><span class="p">.</span><span class="n">item</span> <span class="p">=</span> <span class="n">item</span>
      <span class="c1">// è®¾ç½®ä¸‹ä¸€æ­¥çš„ label
</span><span class="c1"></span>      <span class="n">sm</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="m">1</span>

      <span class="c1">// å½“ requestToken é‡Œçš„è€—æ—¶æ“ä½œå®Œæˆåä¼šæ›´æ–°çŠ¶æ€æœº
</span><span class="c1"></span>      <span class="c1">// å¹¶é€šè¿‡ sm.resume å†æ¬¡è°ƒç”¨è¿™ä¸ª postItem å‡½æ•°
</span><span class="c1"></span>      <span class="c1">// ã€Œæˆ‘ä»¬åœ¨å‰é¢æä¾›äº† sm.resume çš„å®ç°ï¼Œå³å†æ¬¡è°ƒç”¨ postItemã€
</span><span class="c1"></span>      <span class="n">requestToken</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
    <span class="n">case</span> <span class="m">1</span><span class="p">:</span>
      <span class="k">val</span> <span class="py">item</span> <span class="p">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">item</span>
      <span class="c1">// å‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœ
</span><span class="c1"></span>      <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">result</span> <span class="k">as</span> <span class="n">Token</span>
      <span class="n">sm</span><span class="p">.</span><span class="n">label</span> <span class="p">=</span> <span class="m">2</span>
      <span class="n">createPost</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
    <span class="n">case</span> <span class="m">2</span><span class="p">:</span>
      <span class="n">procesPost</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The compiler compiles <code>suspend</code> into a method with a continuation argument called a CPS (Continuation-Passing-Style) transformation.</p>
<h2 id="using-the-suspend-function-without-caring-about-thread-switching">Using the <code>suspend</code> function without caring about thread switching</h2>
<p><code>suspend</code> provides a <strong>Convention</strong> that calls to this function will not block the currently calling thread. This is very useful for UI programming, because the main thread of the UI needs to constantly respond to various requests for graphics and user actions, so if there are time-consuming operations on the main thread, other requests will not be responded to in time, causing UI lag.</p>
<p>The Android community&rsquo;s popular network request library Retrofit and the official database ORM Room already support Coroutine by providing the <code>suspend</code> API, and Android officials also use Kotlin extended properties to provide components with lifecycle such as <code>Activity</code> with the <code>suspend</code> API. CoroutineScope, where the context specifies the use of <code>Dispatchers.Main</code>, i.e. Coroutines started by <code>lifecycleScope</code> will be dispatched to the main thread. So we can call the <code>suspend</code> function and update the UI directly after we get the result without any thread switching action. Such a <code>suspend</code> function is called <a href="https://developer.android.com/kotlin/coroutines#use-coroutines-for-main-safety">&ldquo;main safe&rdquo;</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">posts</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">retrofit</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">PostService</span><span class="p">&gt;().</span><span class="n">fetchPosts</span><span class="p">();</span>
  <span class="c1">// ç”±äºåœ¨ä¸»çº¿ç¨‹ï¼Œå¯ä»¥æ‹¿ç€ posts æ›´æ–° UI
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is much better than the callback and RxJava APIs. These asynchronous APIs ultimately rely on callbacks, but the callback has to come back to the caller to figure out which thread it is in, depending on how the function is implemented. With the <code>suspend</code> convention of not blocking the current thread, the caller doesn&rsquo;t really need to care which thread the function is executed in internally.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">Main</span><span class="p">)</span> <span class="p">{</span>
  <span class="err">ğŸ¹</span> <span class="n">foo</span><span class="p">()}</span>
</code></pre></td></tr></table>
</div>
</div><p>For example, in the block above, we specify that this Coroutine block is scheduled to execute in the main thread, and it calls a <code>suspend foo</code> method from somewhere. Inside this method may be a time-consuming CPU calculation, or it may be a time-consuming IO request, but I don&rsquo;t really need to care what&rsquo;s going on in there and which thread it&rsquo;s running in when I write this Coroutine block. Similarly, when reading this Coroutine block, it is clear that the code in front of us will be executed in the main thread, and that the code inside <code>suspend foo</code> is a potentially time-consuming operation, and the exact thread in which it is executed is an implementation detail of the function that is &ldquo;transparent&rdquo; to the logic of the current code.</p>
<p>But only if the <code>suspend</code> function is implemented correctly, so that it does not block the current thread. Simply adding the <code>suspend</code> keyword to a function does not magically make the function non-blocking, for example, suppose the implementation inside <code>suspend foo</code> looks like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// ğŸ˜–
</span><span class="c1"></span><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">=</span> <span class="n">BigInteger</span><span class="p">.</span><span class="n">probablePrime</span><span class="p">(</span><span class="m">4096</span><span class="p">,</span> <span class="n">Random</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><p>The internal implementation of the <code>suspend</code> function here is a time-consuming CPU operation, which can similarly be thought of as a period of particularly complex code. The problem is that the implementation of the <code>foo</code> function does not follow the semantics of <code>suspend</code> and is wrong. The correct approach is to modify the <code>foo</code> function</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">findBigPrime</span><span class="p">():</span> <span class="n">BigInteger</span> <span class="p">=</span>
  <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">)</span> <span class="p">{</span>    <span class="n">BigInteger</span><span class="p">.</span><span class="n">probablePrime</span><span class="p">(</span><span class="m">4096</span><span class="p">,</span> <span class="n">Random</span><span class="p">())</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>With <code>withContext</code> we move the time-consuming operation from the current main thread to a default background thread pool. So it is said that even with Coroutine, you still end up &ldquo;blocking&rdquo; a thread, &ldquo;all code is inherently blocking&rdquo;. This understanding helps us to realize that threads are ultimately needed on Android / JVM as a vehicle to execute Coroutine, but ignores the distinction between blocking and non-blocking IO. CPU execution threads, and the above <code>BigInteger.probablePrime</code> is a time-consuming CPU calculation that can only wait for the CPU to compute the result, but IO does not necessarily have to block the CPU.</p>
<p>There is a practical difference between blocking and non-blocking IO. For example, while Retrofit supports the <code>suspend</code> function (which actually wraps the callback-based API <code>enqueue</code>), the underlying dependency on OkHttp uses a blocking method, and the final execution of the request is dispatched to the thread pool. The <a href="https://ktor.io/docs/clients-index.html">Ktor&rsquo;s HTTP client</a> supports non-blocking IO. Try to use these two clients to make requests concurrently and you can feel the difference.</p>
<p>Of course, the client does not have as many &ldquo;high concurrency&rdquo; scenarios as the server, and does not need to initiate a large number of requests at the same time, so using a thread pool with a blocking API is usually enough. The Spring Framework provides WebFlux in addition to the traditional Servlet-based WebMvc, which provides a non-blocking Spring WebFlux natively provides a reactive programming model (similar to RxJava) with Reactive Streams to support non-blocking APIs. suspend function directly in the controller.</p>
<p>With Coroutine as the official recommended asynchronous solution for Android, common asynchronous scenarios such as network requests and databases already have libraries that support Coroutine, so it is conceivable that in the future, newcomers to Android development will not really need to know the details of thread switching, and will only need to call the encapsulated <code>suspend</code> function directly in the main thread.</p>
<h2 id="its-not-just-io-that-can-be-suspend">It&rsquo;s not just IO that can be <code>suspend</code></h2>
<p><code>suspend</code> is not exactly a thread switch per se, but asynchronous IO in Android ultimately relies on multithreading, and asynchronous IO is the main application scenario for Coroutine. Coroutine&rsquo;s <code>suspend</code> does the same thing, but with the introduction of keywords and compiler support, we can write asynchronous logic in sequential, top-to-bottom code. Not only does this improve code readability, but it also makes it easy to write complex logic using familiar constructs such as conditionals, loops, and try catches.</p>
<p>Looking at Coroutine and <code>suspend</code> as purely thread switching tools has significant limitations. Since <code>suspend</code> is a callback and also provides a way to wrap the callback API, callback-based APIs can be transformed by wrapping them with <code>suspend</code> functions.</p>
<h3 id="android-view-api">Android View API</h3>
<p><a href="https://medium.com/androiddevelopers/suspending-over-views-19de9ebd7020">Suspending over views</a> This article describes an example of wrapping Android view-related APIs with Coroutine. examples, such as the following extension function that waits for the end of <code>Animator</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">Animator</span><span class="p">.</span><span class="n">awaitEnd</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* å®ç°è§åæ–‡ */</span><span class="p">}</span>

<span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="n">ObjectAnimator</span><span class="p">.</span><span class="n">ofFloat</span><span class="p">(</span><span class="n">imageView</span><span class="p">,</span> <span class="n">View</span><span class="p">.</span><span class="n">ALPHA</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">).</span><span class="n">run</span> <span class="p">{</span>
    <span class="n">start</span><span class="p">();</span> <span class="err">ğŸ¹</span> <span class="n">awaitEnd</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="n">ObjectAnimator</span><span class="p">.</span><span class="n">ofFloat</span><span class="p">(</span><span class="n">imageView</span><span class="p">,</span> <span class="n">View</span><span class="p">.</span><span class="n">TRANSLATION_Y</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">100f</span><span class="p">).</span><span class="n">run</span> <span class="p">{</span>
    <span class="n">start</span><span class="p">();</span> <span class="err">ğŸ¹</span> <span class="n">awaitEnd</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="n">ObjectAnimator</span><span class="p">.</span><span class="n">ofFloat</span><span class="p">(</span><span class="n">imageView</span><span class="p">,</span> <span class="n">View</span><span class="p">.</span><span class="n">TRANSLATION_X</span><span class="p">,</span> <span class="p">-</span><span class="m">100f</span><span class="p">,</span> <span class="m">0f</span><span class="p">).</span><span class="n">run</span> <span class="p">{</span>
    <span class="n">start</span><span class="p">();</span> <span class="err">ğŸ¹</span> <span class="n">awaitEnd</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using traditional callback-based APIs to express such complex sequential code results in a lot of nesting and a significant decrease in code readability. By wrapping it in a <code>suspend</code> function, we can write the code in top-down order in Coroutine, and at the same time facilitate the use of various conditions, loops and other logic control constructs to improve the expressiveness of the code.</p>
<p>The <code>Animator.awaitEnd</code> wraps the <code>AnimatorListenerAdapter</code> asynchronous callback interface, and the Kotlin Coroutine library provides the <code>suspendCoroutine</code> and <code>suspendCancellableCoroutine</code> functions (note that both of these functions are themselves <code>suspend</code>). We can get the <code>Continuation</code> instance that corresponds to the current <code>hang</code> in the lambda we pass in. Calling the <code>resume</code> series of methods on this instance in the appropriate callback will bridge the <code>suspend</code> function with the callback-based API</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">Animator</span><span class="p">.</span><span class="n">awaitEnd</span><span class="p">()</span> <span class="p">=</span> 
<span class="err">ğŸ¹</span> <span class="n">suspendCancellableCoroutine</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">cont</span> <span class="o">-&gt;</span>
    <span class="c1">// å¦‚æœæ‰§è¡Œè¿™ä¸ª suspend å‡½æ•°çš„Coroutineè¢«å–æ¶ˆçš„è¯ï¼ŒåŒæ—¶å–æ¶ˆè¿™ä¸ª Animatorã€‚
</span><span class="c1"></span>    <span class="c1">// æ³¨æ„è¿™ä¸ª `awaitEnd` æ˜¯å®šä¹‰åœ¨ `Animator` ä¸Šçš„æ‰©å±•å‡½æ•°ï¼Œ
</span><span class="c1"></span>    <span class="c1">// å› æ­¤å¯ä»¥ç›´æ¥è°ƒç”¨ `Animator` ä¸Šçš„æ–¹æ³•ã€‚
</span><span class="c1"></span>    <span class="n">cont</span><span class="p">.</span><span class="n">invokeOnCancellation</span> <span class="p">{</span> <span class="n">cancel</span><span class="p">()</span> <span class="p">}</span>

    <span class="n">addListener</span><span class="p">(</span><span class="k">object</span> <span class="err">: </span><span class="nc">AnimatorListenerAdapter</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// æ ‡è®° Animator è¢«å–æ¶ˆè¿˜æ˜¯æ­£å¸¸ç»“æŸ
</span><span class="c1"></span>      <span class="k">private</span> <span class="k">var</span> <span class="py">endedSuccessfully</span> <span class="p">=</span> <span class="k">true</span>
      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAnimationCancel</span><span class="p">(</span><span class="n">animation</span><span class="p">:</span> <span class="n">Animator</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Animator has been cancelled, so flip the success flag
</span><span class="c1"></span>        <span class="n">endedSuccessfully</span> <span class="p">=</span> <span class="k">false</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAnimationEnd</span><span class="p">(</span><span class="n">animation</span><span class="p">:</span> <span class="n">Animator</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">animation</span><span class="p">.</span><span class="n">removeListener</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

        <span class="c1">// å¦‚æœCoroutineä»åœ¨æ‰§è¡Œä¸­
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// å¹¶ä¸” Animator æœªè¢«å–æ¶ˆ
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">endedSuccessfully</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">cont</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// å¦åˆ™å–æ¶ˆCoroutine
</span><span class="c1"></span>            <span class="n">cont</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/LouisCAD/Splitties">Splitties</a> is a very authentic Kotlin Android helper library that provides a <code>suspend AlertDialog.showAndAwait</code> method. The following example code opens a dialog box and waits for the user to confirm that they want to delete it. This is an asynchronous operation, so it &ldquo;hangs&rdquo; the Coroutine and returns a boolean value when the user has finished selecting it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">shouldWeReallyDeleteFromTrash</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> 
  <span class="n">alertDialog</span><span class="p">(</span>
    <span class="n">message</span> <span class="p">=</span> <span class="n">txt</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">dialog_msg_confirm_delete_from_trash</span><span class="p">)</span>
  <span class="p">).</span><span class="err">ğŸ¹</span> <span class="n">showAndAwait</span><span class="p">(</span>    <span class="n">okValue</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
    <span class="n">cancelValue</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
    <span class="n">dismissValue</span> <span class="p">=</span> <span class="k">false</span>
  <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Here <code>AlertDialog.showAndAwait</code> wraps the <code>DialogInterface.OnClickListener</code> interface using <code>suspendCancellableCoroutine</code>.</p>
<p>Note that these examples above only involve the main thread and do not involve thread switching.</p>
<h3 id="functional-exception-handling">Functional exception handling</h3>
<p>Going a step further, the <code>suspend</code> function is not even necessarily limited to asynchronous scenarios.</p>
<p>The Kotlin Coroutine code we normally use is implemented in two packages, the standard Kotlin library <code>kotlin-stdlib</code> and the Coroutine library <code>kotlinx.coroutines</code>. The standard library provides <code>Continuation</code> and other infrastructure related to CPS transformations, and <code>kotlinx.coroutines</code> provides a concrete implementation of Coroutine. So we can actually use the CPS transformation infrastructure in the standard library to write other interesting things.</p>
<p>Î›rrow (also written as Arrow) is a functional programming library for Kotlin that provides the <code>Either</code> data type for exception handling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">sealed</span> <span class="k">class</span> <span class="nc">Either</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">&gt;</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">Left</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">A</span><span class="p">):</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">Nothing</span><span class="p">&gt;()</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">Right</span><span class="p">(</span><span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">B</span><span class="p">):</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">,</span> <span class="n">B</span><span class="p">&gt;()</span>
</code></pre></td></tr></table>
</div>
</div><p>The value of <code>Either</code> can be both <code>Left</code> and <code>Right</code>. It is customary to use <code>Right</code> to indicate a normal return value (think of it as right, which also means correct in English) and <code>Left</code> to indicate an exception.</p>
<p>Assuming three interdependent subtasks <code>takeFoodFromRefriderator</code>, <code>getKnife</code> and <code>lunch</code>, note that the example here is not an asynchronous IO but an exception</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// å®šä¹‰å¯èƒ½çš„å¼‚å¸¸
</span><span class="c1"></span><span class="k">sealed</span> <span class="k">class</span> <span class="nc">CookingException</span> <span class="p">{</span>
  <span class="k">object</span> <span class="nc">LettuceIsRotten</span> <span class="p">:</span> <span class="n">CookingException</span><span class="p">()</span>
  <span class="k">object</span> <span class="nc">KnifeNeedsSharpening</span> <span class="p">:</span> <span class="n">CookingException</span><span class="p">()</span>
  <span class="k">data</span> <span class="k">class</span> <span class="nc">InsufficientAmount</span><span class="p">(</span><span class="k">val</span> <span class="py">quantityInGrams</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">:</span> <span class="n">CookingException</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">object</span> <span class="nc">Lettuce</span><span class="p">;</span> <span class="k">object</span> <span class="nc">Knife</span><span class="p">;</span> <span class="k">object</span> <span class="nc">Salad</span>

<span class="c1">// ä¸‰ä¸ªå­ä»»åŠ¡éƒ½æ˜¯è¿”å›çš„ Either ç±»å‹
</span><span class="c1"></span><span class="k">fun</span> <span class="nf">takeFoodFromRefrigerator</span><span class="p">():</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">LettuceIsRotten</span><span class="p">,</span> <span class="n">Lettuce</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Lettuce</span><span class="p">.</span><span class="n">right</span><span class="p">()</span>
<span class="k">fun</span> <span class="nf">getKnife</span><span class="p">():</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">KnifeNeedsSharpening</span><span class="p">,</span> <span class="n">Knife</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Knife</span><span class="p">.</span><span class="n">right</span><span class="p">()</span>
<span class="k">fun</span> <span class="nf">lunch</span><span class="p">(</span><span class="n">knife</span><span class="p">:</span> <span class="n">Knife</span><span class="p">,</span> <span class="n">food</span><span class="p">:</span> <span class="n">Lettuce</span><span class="p">):</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">InsufficientAmount</span><span class="p">,</span> <span class="n">Salad</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">InsufficientAmount</span><span class="p">(</span><span class="m">5</span><span class="p">).</span><span class="n">left</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>We can use <code>Either.flatMap</code> to combine the three tasks together.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="nf">getSalad</span><span class="p">():</span> <span class="n">Either</span><span class="p">&lt;</span><span class="n">CookingException</span><span class="p">,</span> <span class="n">Salad</span><span class="p">&gt;</span> <span class="p">=</span>
  <span class="n">takeFoodFromRefrigerator</span><span class="p">()</span>
    <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">lettuce</span> <span class="o">-&gt;</span>
      <span class="n">getKnife</span><span class="p">()</span>
        <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">knife</span> <span class="o">-&gt;</span>
          <span class="k">val</span> <span class="py">salad</span> <span class="p">=</span> <span class="n">lunch</span><span class="p">(</span><span class="n">knife</span><span class="p">,</span> <span class="n">lettuce</span><span class="p">)</span>
          <span class="n">salad</span>
        <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Does it look similar to the nested callbacks of IO? We can also eliminate the callbacks with the CPS transformation of <code>suspend</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getSalad</span><span class="p">()</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">either</span><span class="p">&lt;</span><span class="n">CookingException</span><span class="p">,</span> <span class="n">Salad</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">lettuce</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">takeFoodFromRefrigerator</span><span class="p">().</span><span class="n">bind</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">knife</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">getKnife</span><span class="p">().</span><span class="n">bind</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">salad</span> <span class="p">=</span> <span class="err">ğŸ¹</span> <span class="n">lunch</span><span class="p">(</span><span class="n">knife</span><span class="p">,</span> <span class="n">lettuce</span><span class="p">).</span><span class="n">bind</span><span class="p">()</span>
  <span class="n">salad</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="deep-recursion">Deep recursion</h3>
<p>Recursion applied to recursive data structures can often result in clean and elegant code. For example, the following algorithm for calculating the height of a tree.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="k">val</span> <span class="py">left</span><span class="p">:</span> <span class="n">Tree</span><span class="p">?,</span> <span class="k">val</span> <span class="py">right</span><span class="p">:</span> <span class="n">Tree</span><span class="p">?)</span>

<span class="k">fun</span> <span class="nf">depth</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">?):</span> <span class="n">Int</span> <span class="p">=</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="m">0</span> <span class="k">else</span> <span class="n">maxOf</span><span class="p">(</span>
    <span class="n">depth</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">left</span><span class="p">),</span>    <span class="n">depth</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>  <span class="p">)</span> <span class="p">+</span> <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>However, if the recursion is too deep beyond the limit, the runtime will throw a <code>StackOverflowException</code>. So we need to make use of the more spacious heap memory. Usually we can maintain a stack data structure explicitly.</p>
<p>There is an experimental <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-deep-recursive-function/"><code>DeepRecursiveFunction</code></a> helper class in the Kotlin standard library that helps us write code that maintains the &ldquo;general shape&rdquo; of the recursive algorithm, but keeps the intermediate state in heap memory. The mechanism implemented there is the CPS transformation of <code>suspend</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">val</span> <span class="py">depth</span> <span class="p">=</span> <span class="n">DeepRecursiveFunction</span><span class="p">&lt;</span><span class="n">Tree</span><span class="p">?,</span> <span class="n">Int</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">tree</span> <span class="o">-&gt;</span>
  <span class="c1">// è¿™é‡Œæ˜¯ä¸€ä¸ª suspend çš„ Î»
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">tree</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="m">0</span> <span class="k">else</span> <span class="n">maxOf</span><span class="p">(</span>
    <span class="err">ğŸ¹</span> <span class="n">callRecursive</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">left</span><span class="p">),</span>    <span class="err">ğŸ¹</span> <span class="n">callRecursive</span><span class="p">(</span><span class="n">tree</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>  <span class="p">)</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}</span>

<span class="k">val</span> <span class="py">deepTree</span> <span class="p">=</span> <span class="n">generateSequence</span><span class="p">(</span><span class="n">Tree</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">))</span> <span class="p">{</span> <span class="n">prev</span> <span class="o">-&gt;</span>
  <span class="n">Tree</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
<span class="p">}.</span><span class="n">take</span><span class="p">(</span><span class="m">100</span><span class="n">_000</span><span class="p">).</span><span class="n">last</span><span class="p">()</span>

<span class="c1">// DeepRecursiveFunction é‡è½½äº† invoke æ“ä½œç¬¦
</span><span class="c1">// å¯ä»¥æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è¯­æ³•
</span><span class="c1"></span><span class="n">println</span><span class="p">(</span><span class="n">depth</span><span class="p">(</span><span class="n">deepTree</span><span class="p">))</span> <span class="c1">// 100_000
</span></code></pre></td></tr></table>
</div>
</div><p><code>DeepRecursiveFunction</code> is connected to a <code>suspend</code> block, where the receiver is <code>DeepRecursiveScope</code>, which can be analogous to <code>CoroutineScope</code>. Inside this block, note that we cannot call <code>depth</code> directly recursively as in the original algorithm (because it still depends on the space-limited function call stack). The <code>DeepRecursiveScope</code> provides a <code>suspend callRecursive</code> method. Here, we use the state machine obtained by the CPS transformation to preserve the intermediate results of the recursive function call stack. Since the <code>Continuation</code> object is stored in heap memory at runtime, it bypasses the space constraints of the function call stack. (So Kotlin&rsquo;s Coroutine is a so-called &ldquo;stackless coroutine&rdquo;.</p>
<p>For details, see <a href="https://elizarov.medium.com/deep-recursion-with-coroutines-7c53e15993e3">Deep recursion with coroutines</a>. <a href="https://youtrack.jetbrains.com/issue/KT-31741">KT-31741</a> has some discussions on standard library design and implementation as well as performance aspects.</p>
<p>As you can see from these different examples of Android UI, functional programming, and general programming, <code>suspend</code> can be seen as syntactic sugar for callbacks, and is not essentially related to IO or thread switching. In retrospect, the keyword <code>suspend</code> is often called <code>async</code> in other languages, while Kotlin is called <code>suspend</code>, perhaps suggesting that the unique design of the Kotlin Coroutine is not limited to asynchrony, but has a wider range of applications.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kotlin/">kotlin</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/white-house-open-source-software-safer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The White House held the &#34;open source security&#34; summit, Apache / Google / Microsoft / Apple and other participants</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/kotlin-coroutine-context-scope/">
            <span class="next-text nav-default">Talking about the Context and Scope of Kotlin Coroutine</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
