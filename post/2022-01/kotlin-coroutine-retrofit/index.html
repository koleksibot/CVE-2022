<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kotlin Coroutine and Retrofit - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Retrofit 2.6.0 supports defining interfaces with Kotlin suspend functions. This article describes how to create the most comfortable coroutine experience by customizing the Retrofit Call Adapter and Converter. Call Adapter: custom request execution logic, including thread switching, etc. Converter: Customize the deserialization logic, how to convert the bytes obtained from the request into objects. Spoiler for the final result. 1 2 3 4 5 6 7 8 9 10 11" /><meta name="keywords" content="kotlin, retrofit, Coroutine" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/kotlin-coroutine-retrofit/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kotlin Coroutine and Retrofit" />
<meta property="og:description" content="Retrofit 2.6.0 supports defining interfaces with Kotlin suspend functions. This article describes how to create the most comfortable coroutine experience by customizing the Retrofit Call Adapter and Converter. Call Adapter: custom request execution logic, including thread switching, etc. Converter: Customize the deserialization logic, how to convert the bytes obtained from the request into objects. Spoiler for the final result. 1 2 3 4 5 6 7 8 9 10 11" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/kotlin-coroutine-retrofit/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-15T12:11:09+08:00" />
<meta property="article:modified_time" content="2022-01-15T12:11:09+08:00" />

<meta itemprop="name" content="Kotlin Coroutine and Retrofit">
<meta itemprop="description" content="Retrofit 2.6.0 supports defining interfaces with Kotlin suspend functions. This article describes how to create the most comfortable coroutine experience by customizing the Retrofit Call Adapter and Converter. Call Adapter: custom request execution logic, including thread switching, etc. Converter: Customize the deserialization logic, how to convert the bytes obtained from the request into objects. Spoiler for the final result. 1 2 3 4 5 6 7 8 9 10 11"><meta itemprop="datePublished" content="2022-01-15T12:11:09+08:00" />
<meta itemprop="dateModified" content="2022-01-15T12:11:09+08:00" />
<meta itemprop="wordCount" content="4028">
<meta itemprop="keywords" content="kotlin,retrofit," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kotlin Coroutine and Retrofit"/>
<meta name="twitter:description" content="Retrofit 2.6.0 supports defining interfaces with Kotlin suspend functions. This article describes how to create the most comfortable coroutine experience by customizing the Retrofit Call Adapter and Converter. Call Adapter: custom request execution logic, including thread switching, etc. Converter: Customize the deserialization logic, how to convert the bytes obtained from the request into objects. Spoiler for the final result. 1 2 3 4 5 6 7 8 9 10 11"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kotlin Coroutine and Retrofit</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-15 12:11:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4028 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#retrofit-interface-design">Retrofit interface design</a>
          <ul>
            <li><a href="#get-rid-of-the-envelope">Get rid of the &ldquo;envelope&rdquo;</a></li>
            <li><a href="#exception-handling">Exception handling</a></li>
            <li><a href="#designing-apiresponse-types">Designing ApiResponse types</a></li>
            <li><a href="#add-some-null-safe-syntactic-sugar">Add some null-safe syntactic sugar</a></li>
            <li><a href="#borrow-from-swifts-guard-keyword">Borrow from Swift&rsquo;s <code>guard</code> keyword</a></li>
          </ul>
        </li>
        <li><a href="#implementation-retrofit-call-adapter">Implementation: Retrofit Call Adapter</a></li>
        <li><a href="#implementation-retrofit-converter">Implementation: Retrofit Converter</a>
          <ul>
            <li><a href="#json-deserialization-library-selection">JSON deserialization library selection</a></li>
            <li><a href="#moshi-implementation">Moshi Implementation</a></li>
          </ul>
        </li>
        <li><a href="#one-more-thing-using-result-as-a-return-value">One More Thing: Using Result as a Return Value</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Retrofit 2.6.0 supports defining interfaces with Kotlin suspend functions. This article describes how to create the most comfortable coroutine experience by customizing the Retrofit Call Adapter and Converter.</p>
<ul>
<li>Call Adapter: custom request execution logic, including thread switching, etc.</li>
<li>Converter: Customize the deserialization logic, how to convert the bytes obtained from the request into objects.</li>
</ul>
<p>Spoiler for the final result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="c1">// Retrofit 接口定义
</span><span class="c1">// 简洁起见，后文省略外面这个 UserApi
</span><span class="c1"></span><span class="k">interface</span> <span class="nc">UserApi</span> <span class="p">{</span>
  <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> 
    <span class="n">ApiResponse</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="c1">// 调用示例 1：
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">getOrNull</span><span class="p">()</span>
    <span class="c1">// 主线程更新 UI
</span><span class="c1"></span>    <span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">binding</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 调用示例 2：
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">guardOk</span> <span class="p">{</span> <span class="k">return</span><span class="nd">@launch</span> <span class="p">}</span>
  <span class="c1">// 拿到非 null 的 User 继续后面的业务逻辑
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// 还没有结束，文章最后会介绍一个进一步简化的方案 ;-)
</span></code></pre></td></tr></table>
</div>
</div><p>This solution was inspired by Jake Wharton&rsquo;s <a href="https://jakewharton.com/making-retrofit-work-for-you/"><em>Making Retrofit Work for You</em></a> talk. Jake is also the maintainer of Retrofit. In his talk, he recommends taking advantage of the custom deserialization and request execution APIs that Retrofit provides to adapt <em>adapt</em> your own business logic and interfaces.</p>
<h2 id="background">Background</h2>
<p>Suppose our interface returns JSON data like this, with an <code>errcode</code> field returning <code>0</code> on a successful request, and a <code>data</code> field holding the data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Peter Parker&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The exception <code>errcode</code> is not <code>0</code> and the <code>msg</code> field returns the error message displayed to the user.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;无权访问&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="retrofit-interface-design">Retrofit interface design</h2>
<p>Let&rsquo;s set aside the implementation for a moment and explore how to design Retrofit&rsquo;s interface to make it more comfortable for callers to use Coroutine.</p>
<h3 id="get-rid-of-the-envelope">Get rid of the &ldquo;envelope&rdquo;</h3>
<p>A comfortable envelope should make it as easy as possible for the caller, the simpler the better. You can see that the data that&rsquo;s really useful to the business is inside <code>data</code>, with an &ldquo;envelope&rdquo; on the outside. In most cases we just need to take the normal data and continue with the subsequent business logic. It would be very redundant to have to manually check <code>errcode == 0</code> every time we call it. One of the simplest designs is to simply return the envelope-removed data type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span>
  <span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">)</span> <span class="n">id</span><span class="p">:</span> <span class="n">Int</span>
<span class="p">):</span> <span class="n">User</span>

<span class="k">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="c1">// 在主线程开启协程并更新 UI
</span><span class="c1">// 🚨 危险：请求异常会让应用崩溃
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;().</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="n">binding</span><span class="p">.</span><span class="n">userNameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="exception-handling">Exception handling</h3>
<p>The design of returning the data type inside the envelope directly works in theory: it&rsquo;s nice to call it normally, and if an exception occurs you can get specific exception information with try catch. However, by the design of the Kotlin Coroutine, we should call the wrapped suspend function directly in the main thread. If the function throws an exception, it will be thrown in the main thread, causing the application to crash. This is also evident from the function signature: once the <code>User</code> data type is not returned properly, the runtime can only throw an exception. The caller then has to do a try catch, which is very cumbersome to write. What&rsquo;s worse is that people can forget about try catch altogether, and are likely to write the wrong</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// - Kotlin 标准库的 runCatching，比 try catch 写起来舒服一点点
</span><span class="c1">// - 🚨 错误的 try catch，无法捕获 launch 协程块的异常
</span><span class="c1"></span><span class="n">runCatching</span> <span class="p">{</span>
  <span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">retrofit</span>
      <span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;()</span>
      <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="n">binding</span><span class="p">.</span><span class="n">userNameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Watch out! The try catch in the above example was written incorrectly. If an exception is thrown inside the Coroutine block, it will still crash, because the wrong try catch is made on the Coroutine builder <code>launch</code>. The Coroutine builder returns immediately after opening the Coroutine block in the CoroutineScope, and the Coroutine inside the builder is executed concurrently with the code around <code>launch</code>. The exception logic inside the Coroutine block cannot be caught by the try catch outside of <code>launch</code>. The correct way to write try catch is inside the Coroutine block.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">runCatching</span> <span class="p">{</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserService</span><span class="p">&gt;().</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">.</span><span class="n">onFailure</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="k">it</span> <span class="k">is</span> <span class="n">CancellationException</span><span class="p">)</span> <span class="k">throw</span> <span class="k">it</span> <span class="p">}</span>
    <span class="p">.</span><span class="n">getOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="k">return</span><span class="nd">@launch</span>
  <span class="n">binding</span><span class="p">.</span><span class="n">userNameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition, the try catch suspend function needs to be careful to re-throw <code>CancellationException</code>, otherwise the Coroutine block may not be cancelled in time. See <a href="https://blog.yujinyan.me/posts/jcip-notes-interruption-cancellation/#comparison-with">JCIP Notes - Interruption and Cancellation</a> for details. -kotlin-coroutines).</p>
<blockquote>
<p>💡 A good wrapper design should <strong>make the right way to write the simplest</strong> , <strong>the simplest way to write by default is the right way to write</strong>.</p>
</blockquote>
<p>To avoid the hassle and potential mistakes of try catch concurrent exceptions, I recommend catching all exceptions in the suspend function internal wrapper and reflecting the exceptions in the function signature.</p>
<p>One option is to return the type nullable. This would take advantage of Kotlin&rsquo;s null-safe operator <code>?</code>, <code>? :</code> and <code>!</code>:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span>
  <span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">)</span> <span class="n">id</span><span class="p">:</span> <span class="n">Int</span>
<span class="p">):</span> <span class="n">User</span><span class="p">?</span>

<span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">binding</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This seems to be a rather authentic and elegant design, and is recommended. But with nullable we can&rsquo;t tell the caller what type of exception has occurred. The only possibilities for the caller are success <code>! = null</code> or failure <code>== null</code>. But this distinction is sufficient in many cases.</p>
<p>In addition, exceptions should <strong>be handled in a consistent place in the project</strong>, for example by showing the user a hint when <code>errcode ! = 0</code>, report network request exceptions, etc. Doing ad hoc (ad hoc) exception handling everywhere in the business call interface is not robust enough: people can forget to do exception handling at all, or handle it very roughly. Also, exception handling code can create a lot of redundancy and make it hard to see the normal code logic.</p>
<p>Retrofit&rsquo;s Call Adapter can help us embed custom logic in Retrofit&rsquo;s execution logic to achieve the goal of uniformly catching and handling all exceptions. A reference implementation will be given later.</p>
<blockquote>
<p><strong>As a rule of thumb, you should not be catching exceptions in general Kotlin code. That’s a code smell.</strong> Exceptions should be handled by some top-level framework code of your application to alert developers of the bugs in the code and to restart your application or its affected operation.</p>
<p>&ndash; Roman Elizarov, Project Lead for Kotlin</p>
</blockquote>
<p><strong>As a rule, do not catch exceptions in Kotlin business logic code.</strong> Exceptions should be handled consistently in the top-level infrastructure code of the application: for example, by escalating or retrying the steps that went wrong.</p>
<h3 id="designing-apiresponse-types">Designing ApiResponse types</h3>
<p>In order for the caller to get the exception information, it is inevitable to stuff the return value inside a shell that reflects the success/failure result. But instead of deserializing the return format as is, we do some encapsulation. For example, in the normal case of a request, the <code>msg</code> field is of no use and can be omitted. The result of the request can be divided into roughly three cases.</p>
<ul>
<li>Normal response: we can get the data needed by the subsequent business logic from the <code>data</code> field.</li>
<li>Business logic exception: the interface request is successful, but the backend returns data telling us that the business logic is abnormal and we need to display the exception information in the UI.</li>
<li>Other technical exceptions: network request errors, deserialization errors, etc., which we may need to escalate depending on the situation.</li>
</ul>
<p>Implemented into the code, it can be represented by Kotlin Sealed Class.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">sealed</span> <span class="k">class</span> <span class="nc">ApiResponse</span> <span class="p">{</span>
  <span class="c1">// 正常响应情况调用方不需要 errcode, msg
</span><span class="c1"></span>  <span class="k">data</span> <span class="k">class</span> <span class="nc">Ok</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span>
  <span class="p">)</span>
  
  <span class="k">data</span> <span class="k">class</span> <span class="nc">BizError</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="k">val</span> <span class="py">errcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">msg</span><span class="p">:</span> <span class="n">String</span>
  <span class="p">):</span> <span class="n">ApiResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
  
  <span class="k">data</span> <span class="k">class</span> <span class="nc">OtherError</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="k">val</span> <span class="py">throwable</span><span class="p">:</span> <span class="n">Throwable</span>
  <span class="p">):</span> <span class="n">ApiResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">}</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">)</span> <span class="n">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span>
  <span class="p">:</span> <span class="n">ApiResponse</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>

<span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;().</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  
  <span class="c1">// 可以使用 when 对 ApiResponse 的类型进行区分
</span><span class="c1"></span>  <span class="c1">// 作为表达式使用的时候可以利用 when
</span><span class="c1"></span>  <span class="c1">// 穷尽枚举的特性
</span><span class="c1"></span>  <span class="k">when</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">Ok</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="cm">/**/</span><span class="p">}</span>
    <span class="k">is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">BizError</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="cm">/**/</span><span class="p">}</span>
    <span class="k">is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">OtherError</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="cm">/**/</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="add-some-null-safe-syntactic-sugar">Add some null-safe syntactic sugar</h3>
<p>It is much safer for us to reflect exceptions in the type system rather than throwing them. But the vast majority of scenarios callers don&rsquo;t need, and shouldn&rsquo;t have to do, such detailed exception handling. So we add a pair of extensions that allow the caller to use the syntactic sugar of Kotlin nullable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">ApiResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">getOrNull</span><span class="p">():</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="k">when</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">is</span> <span class="n">Ok</span> <span class="o">-&gt;</span> <span class="k">data</span>
  <span class="k">is</span> <span class="n">BizError</span><span class="p">,</span> <span class="k">is</span> <span class="n">OtherError</span> <span class="o">-&gt;</span> <span class="k">null</span>
<span class="p">}</span>
<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">ApiResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">getOrThrow</span><span class="p">():</span> <span class="n">T</span> <span class="p">=</span> <span class="k">when</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">is</span> <span class="n">Ok</span> <span class="o">-&gt;</span> <span class="k">data</span>
  <span class="k">is</span> <span class="n">BizError</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">BizException</span><span class="p">(</span><span class="n">errcode</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
  <span class="k">is</span> <span class="n">OtherError</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">throwable</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">BizException</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">errcode</span><span class="p">:</span> <span class="n">Int</span>
  <span class="k">override</span> <span class="k">val</span> <span class="py">msg</span><span class="p">:</span> <span class="n">String</span>
<span class="p">):</span> <span class="n">RuntimeException</span><span class="p">()</span>

<span class="c1">// 调用方
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">getOrNull</span><span class="p">()</span>
    <span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">binding</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The naming of the functions refers to the Kotlin standard library conventions like <code>get</code> <code>getOrNull</code> , <code>first</code> <code>firstOrNull</code> : the first class throws an exception, the second returns the nullable type. Considering that client-side exception throwing is very dangerous, we name <code>get</code> <code>getOrThrow</code> to emphasize it in the method name. (Actually, you can also consider a version without the exception throwing, which nobody in the project probably uses.)</p>
<h3 id="borrow-from-swifts-guard-keyword">Borrow from Swift&rsquo;s <code>guard</code> keyword</h3>
<p><code>getOrNull</code> is often used followed by a <code>? let</code> only handles success cases: if the request is successful, use this data <code>it</code> to update the UI, otherwise nothing happens. If the failure case requires some action, you can use if / else or when to determine the type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;().</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="k">is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">Ok</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="k">data</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// 更新 UI 展示异常状态
</span><span class="c1"></span>  <span class="n">pageState</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">PageState</span><span class="p">.</span><span class="n">Error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If &hellip; else if too much nesting will make the code less readable, use the early exit style, we first deal with the failure case and exit the current block, so that the successful case all the way down, more simple and clear</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">val</span> <span class="nx">response</span> <span class="p">=</span> <span class="nx">retrofit</span><span class="p">.</span><span class="nx">create</span><span class="p">&lt;</span><span class="nx">UserApi</span><span class="p">&gt;.</span><span class="nf">getUser</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="p">!</span><span class="nx">is</span> <span class="nx">ApiResponse</span><span class="p">.</span><span class="nx">Ok</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">pageState</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">PageState</span><span class="p">.</span><span class="nx">Error</span>
  <span class="k">return</span>
<span class="p">}</span>

<span class="nx">val</span> <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
<span class="c1">// ...
</span><span class="c1">// 拿到非 null 的 User 继续后面的业务逻辑
</span></code></pre></td></tr></table>
</div>
</div><p>But some people think that the early exit style is not robust enough, because there is a risk of forgetting to write an early exit return, causing logical errors.</p>
<p>Swift loves early exit so much that it added the keyword <code>guard</code>. guard is like if, but with an extra layer of assurance: the compiler makes sure that the else block returns or throws and exits the current block, making early exit just as robust as if &hellip; else.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="n">guard</span> <span class="n">let</span> <span class="n">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">pageState</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">PageState</span><span class="p">.</span><span class="n">Error</span>
  <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// ...
</span><span class="c1">// 拿到非 null 的 User 继续后面的业务逻辑
</span></code></pre></td></tr></table>
</div>
</div><p>In Kotlin, we can achieve a similar effect with the inline extensions. The key is that the block returns <code>Nothing</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">ApiResponse</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">guardOk</span><span class="p">(</span>
  <span class="n">block</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Nothing</span>
<span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">!is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">Ok</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="n">block</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="k">data</span>
<span class="p">}</span>

<span class="k">val</span> <span class="py">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;</span>
  <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">.</span><span class="n">guardOk</span> <span class="p">{</span>
    <span class="n">pageState</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">PageState</span><span class="p">.</span><span class="n">Error</span>
    <span class="k">return</span><span class="nd">@launch</span>
  <span class="p">}</span>

<span class="c1">// ...
</span><span class="c1">// 拿到非 null 的 User 继续后面的业务逻辑
</span></code></pre></td></tr></table>
</div>
</div><h2 id="implementation-retrofit-call-adapter">Implementation: Retrofit Call Adapter</h2>
<p>In order for Retrofit to catch all exceptions, we write a <code>CatchingCallAdapterFactory</code> that inherits from Retrofit&rsquo;s <code>CallAdapter.Factory</code>. This <code>CatchingCallAdapterFactory</code> exposes an <code>ErrorHandler</code> for configuring the global exception handling logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">val</span> <span class="py">retrofit</span> <span class="p">=</span> <span class="n">Retrofit</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
  <span class="p">.</span><span class="n">baseUrl</span><span class="p">(</span><span class="cm">/**/</span><span class="p">)</span>
  <span class="p">.</span><span class="n">addCallAdapterFactory</span><span class="p">(</span><span class="n">CatchingCallAdapterFactory</span><span class="p">(</span>
    <span class="k">object</span><span class="p">:</span> <span class="n">CatchingCallAdapterFactory</span><span class="p">.</span><span class="n">ErrorHandler</span> <span class="p">{</span>
      <span class="c1">// 如果是业务逻辑异常给用户展示错误信息
</span><span class="c1"></span>      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBizError</span><span class="p">(</span><span class="n">errcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">toast</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$errcode</span><span class="s2"> - </span><span class="si">$msg</span><span class="s2">&#34;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// 如果是其他异常进行上报
</span><span class="c1"></span>      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onOtherError</span><span class="p">(</span><span class="n">throwable</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">report</span><span class="p">(</span><span class="n">throwable</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>  
  <span class="p">))</span>
  <span class="c1">//...
</span></code></pre></td></tr></table>
</div>
</div><p><code>CatchingCallAdapterFactory</code> Reference implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">class</span> <span class="nc">CatchingCallAdapterFactory</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">defaultErrorHandler</span><span class="p">:</span> <span class="n">ErrorHandler</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">CallAdapter</span><span class="p">.</span><span class="n">Factory</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// 用于配置全局的异常处理逻辑
</span><span class="c1"></span>  <span class="k">interface</span> <span class="nc">ErrorHandler</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">onBizError</span><span class="p">(</span><span class="n">errcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onOtherError</span><span class="p">(</span><span class="n">throwable</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span>
    <span class="n">returnType</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> 
    <span class="n">annotations</span><span class="p">:</span> <span class="n">Array</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">Annotation</span><span class="p">&gt;,</span> 
    <span class="n">retrofit</span><span class="p">:</span> <span class="n">Retrofit</span>
  <span class="p">):</span> <span class="n">CallAdapter</span><span class="p">&lt;*,</span> <span class="p">*&gt;?</span> <span class="p">{</span>
    <span class="c1">// suspend 函数在 Retrofit 中的返回值其实是 `Call`
</span><span class="c1"></span>    <span class="c1">// 例如：Call&lt;ApiResponse&lt;User&gt;&gt;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">getRawType</span><span class="p">(</span><span class="n">returnType</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Call</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>
    <span class="n">check</span><span class="p">(</span><span class="n">returnType</span> <span class="k">is</span> <span class="n">ParameterizedType</span><span class="p">)</span>

    <span class="c1">// 取 Call 里边一层泛型参数
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">innerType</span><span class="p">:</span> <span class="n">Type</span> <span class="p">=</span> <span class="n">getParameterUpperBound</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">returnType</span><span class="p">)</span>
    <span class="c1">// 如果不是 ApiResponse 则不由本 CallAdapter.Factory 处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">getRawType</span><span class="p">(</span><span class="n">innerType</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ApiResponse</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">javava</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>
    
    <span class="c1">// 获取后续代理
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="n">CallAdapter</span><span class="p">&lt;*,</span> <span class="p">*&gt;</span> <span class="p">=</span> <span class="n">retrofit</span>
      <span class="p">.</span><span class="n">nextCallAdapter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">returnType</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CatchingCallAdapter</span><span class="p">(</span>
      <span class="n">innerType</span><span class="p">,</span> 
      <span class="n">retrofit</span><span class="p">,</span> 
      <span class="k">delegate</span><span class="p">,</span> 
      <span class="n">defaultErrorHandler</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">CatchingCallAdapter</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">dataType</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">retrofit</span><span class="p">:</span> <span class="n">Retrofit</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="n">CallAdapter</span><span class="p">&lt;*,</span> <span class="p">*&gt;,</span>
    <span class="k">val</span> <span class="py">errorHandler</span><span class="p">:</span> <span class="n">ErrorHandler</span><span class="p">?</span>
  <span class="p">)</span> <span class="p">:</span> <span class="n">CallAdapter</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">,</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">responseType</span><span class="p">():</span> <span class="n">Type</span> 
        <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">responseType</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">adapt</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;):</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span> 
        <span class="p">=</span> <span class="n">CatchingCall</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">dataType</span> <span class="k">as</span> <span class="n">ParameterizedType</span><span class="p">,</span> <span class="n">errorHandler</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">CatchingCall</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">delegate</span><span class="p">:</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;,</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">wrapperType</span><span class="p">:</span> <span class="n">ParameterizedType</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">errorHandler</span><span class="p">:</span> <span class="n">ErrorHandler</span><span class="p">?</span>
  <span class="p">)</span> <span class="p">:</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span> <span class="p">{</span>
  
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">enqueue</span><span class="p">(</span>
      <span class="c1">// suspend 其实是 callback
</span><span class="c1"></span>      <span class="c1">// suspend 的返回值通过这个 callback 传递
</span><span class="c1"></span>      <span class="n">callback</span><span class="p">:</span> <span class="n">Callback</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="n">Unit</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">enqueue</span><span class="p">(</span><span class="k">object</span> <span class="err">: </span><span class="nc">Callback</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span> <span class="p">{</span>
      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onResponse</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="c1">// 无论请求响应成功还是失败都回调 Response.success
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">()</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="k">is</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">BizError</span><span class="p">&lt;*&gt;)</span> <span class="p">{</span>
            <span class="n">errorHandler</span><span class="o">?.</span><span class="n">onBizError</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">errcode</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="n">msg</span><span class="p">)</span>
          <span class="p">}</span>
          <span class="n">callback</span><span class="p">.</span><span class="n">onResponse</span><span class="p">(</span><span class="k">this</span><span class="nd">@CatchingCall</span><span class="p">,</span> <span class="n">Response</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">val</span> <span class="py">throwable</span> <span class="p">=</span> <span class="n">HttpException</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">code</span><span class="p">(),</span> <span class="n">response</span><span class="p">)</span>
          <span class="n">errorHandler</span><span class="o">?.</span><span class="n">onOtherError</span><span class="p">(</span><span class="n">throwable</span><span class="p">)</span>
          <span class="n">callback</span><span class="p">.</span><span class="n">onResponse</span><span class="p">(</span>
            <span class="k">this</span><span class="nd">@CatchingCall</span><span class="p">,</span>
            <span class="n">Response</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">ApiResponse</span><span class="p">.</span><span class="n">OtherError</span><span class="p">(</span><span class="n">throwable</span><span class="p">))</span>
          <span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errorHandler</span><span class="o">?.</span><span class="n">onOtherError</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">.</span><span class="n">onResponse</span><span class="p">(</span>
          <span class="k">this</span><span class="nd">@CatchingCall</span><span class="p">,</span>
          <span class="n">Response</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">ApiResponse</span><span class="p">.</span><span class="n">OtherError</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;(</span><span class="n">t</span><span class="p">))</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">clone</span><span class="p">():</span> <span class="n">Call</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span> <span class="p">=</span> 
      <span class="n">CatchingCall</span><span class="p">(</span><span class="k">delegate</span><span class="p">,</span> <span class="n">wrapperType</span><span class="p">,</span> <span class="n">errorHandler</span><span class="p">)</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;</span> <span class="p">=</span> 
      <span class="k">throw</span> <span class="n">UnsupportedOperationException</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">isExecuted</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">isExecuted</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">cancel</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">isCanceled</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">isCanceled</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">request</span><span class="p">():</span> <span class="n">Request</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">timeout</span><span class="p">():</span> <span class="n">Timeout</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">.</span><span class="n">timeout</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="implementation-retrofit-converter">Implementation: Retrofit Converter</h2>
<p>For different cases of <code>ApiResponse</code>, we need to configure custom JSON deserialization parsing logic. Retrofit can be adapted to different deserialization libraries by injecting custom type converters (not necessarily just JSON data formats, but also XML, Protocol Buffers, etc.) via <code>addConverterFactory</code>.</p>
<h3 id="json-deserialization-library-selection">JSON deserialization library selection</h3>
<p>Currently, the Kotlin project recommends using Moshi, which has much better support for Kotlin than Gson. For example, the following example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span>
  <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span>
<span class="p">)</span>

<span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">gson</span><span class="p">.</span><span class="n">fromJson</span><span class="p">(</span><span class="s2">&#34;{}&#34;</span><span class="p">,</span> <span class="n">User</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1">// User(name=null)
</span><span class="c1"></span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">length</span> <span class="err">💣</span><span class="c1">// NullPointerException!
</span></code></pre></td></tr></table>
</div>
</div><p>Gson creates a <code>User</code> type object through reflection, but Gson does not distinguish between Kotlin nullable/non-nullable types and directly returns an object with null properties, causing us to throw a null pointer exception when we subsequently use this &ldquo;broken&rdquo; object. Our <code>CatchingCallAdapter</code> is supposed to catch all exceptions, including deserialization, but Gson&rsquo;s behavior escapes our exception catching logic and intrudes into the business logic code.</p>
<p>Moshi does not have this problem and throws a uniform <code>JsonDataException</code> when it gets data that it cannot parse. OtherError<code>when caught by</code>CatchingCallAdapter`.</p>
<p>The advantages of Moshi over Gson can be found at the following link.</p>
<ul>
<li><a href="https://github.com/uber-archive/shared-docs/blob/master/Moshi.md">Uber Shared Doc</a></li>
<li><a href="https://www.reddit.com/r/androiddev/comments/684flw/why_use_moshi_over_gson/">Reddit: Why use Moshi over Gson</a></li>
<li><a href="https://www.reddit.com/r/Kotlin/comments/exmp2s/json_to_kotlin_data_class/">Reddit: JSON to Kotlin data class</a></li>
</ul>
<blockquote>
<p>Please don’t use Gson. 2 out of 3 maintainers agree: it’s deprecated. Use Moshi, Jackson, or kotlinx.serialization which all understand Kotlin’s nullability. Gson does not and will do dumb things, and it won’t be fixed. Please abandon it.</p>
<p>&ndash; Signed, a Gson maintainer.</p>
</blockquote>
<p>The above quote is from Jake Wharton. Moshi is recommended as a priority for new projects, and migration is risky for projects already using Gson, so caution is advised.</p>
<p>With Moshi, there are currently several options.</p>
<ol>
<li>use reflection like Gson, but with an indirect dependency on the 2.5 MiB size <code>kotlin-reflect</code> .</li>
<li>use annotation processors to generate <code>JsonAdapter</code> for all classes marked <code>@JsonClass(generateAdapter = true)</code>.</li>
<li>same as 2 code generation, but instead of annotation processors, use <a href="https://github.com/google/ksp">Kotlin Symbol Processing</a>.</li>
<li>similar to 1, but using kotlinx-metadata, which is more lightweight than kotlin-reflect.</li>
</ol>
<p>3 and 4 are in the <a href="https://github.com/ZacSweers/MoshiX">MoshiX</a> project and seem to be slightly experimental; also note that code generation has the benefit of higher performance, but the generated code is not small and requires explicitly configuring the appropriate <code>JsonAdapter</code> for all the classes that need to be deserialized, which is a bit invasive for existing projects.</p>
<p><a href="https://github.com/Kotlin/kotlinx.serialization">kotlinx.serialization</a> is the official Kotlin serialization/deserialization scheme, and is also an annotated markup, code generation scheme. However, code generation is integrated into the compiler (similar to <a href="https://developer.android.com/kotlin/parcelize?hl=zh-cn"><code>@Parcelize</code></a> and KSP), and the development experience is probably better, with richer Kotlin feature support, and should be the preferred choice on Kotlin solution. However, streaming parsing is not supported at the moment, <a href="https://github.com/Kotlin/kotlinx.serialization/issues/204">see this issue</a>.</p>
<p>On balance, it seems that we can use Moshi for now, and search for replacement annotations for migration when kotlinx.serialization is mature.</p>
<h3 id="moshi-implementation">Moshi Implementation</h3>
<p>Here is the reference implementation of Moshi&rsquo;s custom parsing <code>ApiResponse</code>, Gson is much the same</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">class</span> <span class="nc">MoshiApiResponseTypeAdapterFactory</span> <span class="p">:</span> <span class="n">JsonAdapter</span><span class="p">.</span><span class="n">Factory</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span>
    <span class="n">type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> 
    <span class="n">annotations</span><span class="p">:</span> <span class="n">MutableSet</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">Annotation</span><span class="p">&gt;,</span> 
    <span class="n">moshi</span><span class="p">:</span> <span class="n">Moshi</span>
  <span class="p">):</span> <span class="n">JsonAdapter</span><span class="p">&lt;*&gt;?</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">rawType</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">rawType</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rawType</span> <span class="o">!=</span> <span class="n">ApiResponse</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="k">return</span> <span class="k">null</span>

    <span class="c1">// 获取 ApiResponse 的泛型参数，比如 User
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">dataType</span><span class="p">:</span> <span class="n">Type</span> <span class="p">=</span> <span class="p">(</span><span class="n">type</span> <span class="k">as</span><span class="p">?</span> <span class="n">ParameterizedType</span><span class="p">)</span>
      <span class="o">?.</span><span class="n">actualTypeArguments</span><span class="o">?.</span><span class="n">firstOrNull</span><span class="p">()</span> 
      <span class="o">?:</span> <span class="k">return</span> <span class="k">null</span>
        
    <span class="c1">// 获取 User 的 JsonAdapter
</span><span class="c1"></span>    <span class="k">val</span> <span class="py">dataTypeAdapter</span> <span class="p">=</span> <span class="n">moshi</span><span class="p">.</span><span class="n">nextAdapter</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">&gt;(</span>
      <span class="k">this</span><span class="p">,</span> <span class="n">dataType</span><span class="p">,</span> <span class="n">annotations</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ApiResponseTypeAdapter</span><span class="p">(</span><span class="n">rawType</span><span class="p">,</span> <span class="n">dataTypeAdapter</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">ApiResponseTypeAdapter</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">outerType</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">dataTypeAdapter</span><span class="p">:</span> <span class="n">JsonAdapter</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
  <span class="p">)</span> <span class="p">:</span> <span class="n">JsonAdapter</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">reader</span><span class="p">:</span> <span class="n">JsonReader</span><span class="p">):</span> <span class="n">T</span><span class="p">?</span> <span class="p">{</span>
      <span class="n">reader</span><span class="p">.</span><span class="n">beginObject</span><span class="p">()</span>

      <span class="k">var</span> <span class="py">errcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
      <span class="k">var</span> <span class="py">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
      <span class="k">var</span> <span class="py">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

      <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">when</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">nextName</span><span class="p">())</span> <span class="p">{</span>
          <span class="s2">&#34;errcode&#34;</span> <span class="o">-&gt;</span> <span class="n">errcode</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">nextString</span><span class="p">().</span><span class="n">toIntOrNull</span><span class="p">()</span>
          <span class="s2">&#34;msg&#34;</span> <span class="o">-&gt;</span> <span class="n">msg</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">nextString</span><span class="p">()</span>
          <span class="s2">&#34;data&#34;</span> <span class="o">-&gt;</span> <span class="k">data</span> <span class="p">=</span> <span class="n">dataTypeAdapter</span><span class="p">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
          <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">reader</span><span class="p">.</span><span class="n">skipValue</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="n">reader</span><span class="p">.</span><span class="n">endObject</span><span class="p">()</span>
      
      <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="n">ApiResponse</span><span class="p">.</span><span class="n">BizError</span><span class="p">(</span>
          <span class="n">errcode</span> <span class="o">?:</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> 
          <span class="n">msg</span> <span class="o">?:</span> <span class="s2">&#34;N/A&#34;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">T</span>
      <span class="k">else</span> <span class="n">ApiResponse</span><span class="p">.</span><span class="n">Ok</span><span class="p">(</span>
        <span class="n">errcode</span> <span class="p">=</span> <span class="n">errcode</span><span class="p">,</span> 
        <span class="k">data</span> <span class="p">=</span> <span class="k">data</span>
      <span class="p">)</span> <span class="k">as</span> <span class="n">T</span><span class="p">?</span>
    <span class="p">}</span>

    <span class="c1">// 不需要序列化的逻辑
</span><span class="c1"></span>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">toJson</span><span class="p">(</span><span class="n">writer</span><span class="p">:</span> <span class="n">JsonWriter</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">?):</span> <span class="n">Unit</span> 
      <span class="p">=</span> <span class="n">TODO</span><span class="p">(</span><span class="s2">&#34;Not yet implemented&#34;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">private</span> <span class="k">val</span> <span class="py">moshi</span> <span class="p">=</span> <span class="n">Moshi</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
  <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">MoshiApiResponseTypeAdapterFactory</span><span class="p">())</span>
  <span class="p">.</span><span class="n">build</span><span class="p">()</span>

<span class="k">val</span> <span class="py">retrofit</span> <span class="p">=</span> <span class="n">Retrofit</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
  <span class="p">.</span><span class="n">baseUrl</span><span class="p">(</span><span class="cm">/**/</span><span class="p">)</span>
  <span class="p">.</span><span class="n">addCallAdapterFactory</span><span class="p">(</span><span class="n">CatchingCallAdapterFactory</span><span class="p">(</span>
    <span class="k">object</span><span class="p">:</span> <span class="n">CatchingCallAdapterFactory</span><span class="p">.</span><span class="n">ErrorHandler</span> <span class="p">{</span>
      <span class="c1">// 如果是业务逻辑异常给用户展示错误信息
</span><span class="c1"></span>      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBizError</span><span class="p">(</span><span class="n">errcode</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">toast</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$errcode</span><span class="s2"> - </span><span class="si">$msg</span><span class="s2">&#34;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// 如果是其他异常进行上报
</span><span class="c1"></span>      <span class="k">override</span> <span class="k">fun</span> <span class="nf">onOtherError</span><span class="p">(</span><span class="n">throwable</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">report</span><span class="p">(</span><span class="n">throwable</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>  
  <span class="p">.</span><span class="n">addConverterFactory</span><span class="p">(</span>
    <span class="n">MoshiConverterFactory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">moshi</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="c1">// 配置 OkHttp，API 鉴权等逻辑在这里配置
</span><span class="c1"></span>  <span class="p">.</span><span class="n">client</span><span class="p">(</span><span class="cm">/**/</span><span class="p">)</span>
  <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="one-more-thing-using-result-as-a-return-value">One More Thing: Using Result as a Return Value</h2>
<p>The example at the beginning of the article uses the <code>runCatching</code> method provided by the Kotlin standard library for try catch. The return value of the <code>runCatching</code> method is <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-result/">Result</a>, which provides a number of useful methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>

<span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">onFailure</span> <span class="p">{</span><span class="cm">/**/</span><span class="p">}</span>
    <span class="p">.</span><span class="n">onSuccess</span> <span class="p">{</span><span class="cm">/**/</span><span class="p">}</span>

  <span class="n">result</span><span class="p">.</span><span class="n">isSuccess</span>
  <span class="n">result</span><span class="p">.</span><span class="n">isFailure</span>

  <span class="k">val</span> <span class="py">exception</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">?</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">exceptionOrNull</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">user1</span><span class="p">:</span> <span class="n">User</span><span class="p">?</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">getOrNull</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">user2</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">getOrThrow</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Previously, Kotlin did not allow Result to be the return value of a function. This restriction has been removed in Kotlin 1.5. This allows us to consider using Result as the return type of a Retrofit interface method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// 需要 Kotlin 1.5
</span><span class="c1"></span><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>With Result, the caller gets the exception information, but cannot distinguish <code>BizError</code> from <code>OtherError</code> at the outermost level. In practice, however, few callers need to make this distinction, and it seems like a good tradeoff to make this rarely used case a bit of a pain.</p>
<p>Even more promising is Kotlin&rsquo;s <a href="https://github.com/Kotlin/KEEP/pull/244">plan to make the null-safe operator also available to Result</a>, so we can write it like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="c1">// 需要 Kotlin 1.5，以及尚未发布的特性
</span><span class="c1"></span>
<span class="c1">// 调用示例 1：
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">binding</span><span class="p">.</span><span class="n">nameLabel</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="k">it</span><span class="p">.</span><span class="n">name</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 调用示例 2：
</span><span class="c1"></span><span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">user</span><span class="p">:</span> <span class="n">User</span> <span class="p">=</span> <span class="n">retrofit</span><span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">UserApi</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="o">?.</span><span class="n">run</span> <span class="p">{</span> <span class="k">return</span><span class="nd">@launch</span> <span class="p">}</span>
  <span class="c1">// 拿到非 null 的 User 继续后面的业务逻辑
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Thanks to the null-safe operator that works directly on the Result type, we don&rsquo;t need to define extensions to convert to nullable types, and the calls are more streamlined.</p>
<p>The Call Adapter for the suspend function and the Result return value can be referenced or used directly from this library: <a href="https://github.com/yujinyan/retrofit-suspend-result-adapter">yujinyan/retrofit-suspend-result-adapter</a>.</p>
<p>If the interface in your project is wrapped in an &ldquo;envelope&rdquo; like the example in this article, you can write a Converter using your own deserialization library. <a href="https://github.com/yujinyan/retrofit-suspend-result-adapter/blob/master/src/test/kotlin/me/yujinyan/retrofit/CustomConverterTest.kt">this test case</a> provides a reference implementation of Moshi.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kotlin/">kotlin</a>
          <a href="/tags/retrofit/">retrofit</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/kotlin-flow-introduction/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Getting Started with Kotlin Flow</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/golang-json/">
            <span class="next-text nav-default">Marshal serialization of numeric types such as int64 safely in Go</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
