<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Introduction, installation and use of the secrets management tool Vault - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Vault is a secrets management, encryption-as-a-service and privilege management tool from hashicorp. Its features are briefly described as follows. secrets management: support for saving various custom information, automatic generation of various types of keys, vault automatically generated keys can also be automatically rotated (rotate) authentication: support access to major cloud vendors&#39; account systems (such as the Aliyun RAM sub-account system) or LDAP, etc. for authentication, without creating additional account systems." /><meta name="keywords" content="vault" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/expirence-of-vault/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Introduction, installation and use of the secrets management tool Vault" />
<meta property="og:description" content="Vault is a secrets management, encryption-as-a-service and privilege management tool from hashicorp. Its features are briefly described as follows. secrets management: support for saving various custom information, automatic generation of various types of keys, vault automatically generated keys can also be automatically rotated (rotate) authentication: support access to major cloud vendors&#39; account systems (such as the Aliyun RAM sub-account system) or LDAP, etc. for authentication, without creating additional account systems." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/expirence-of-vault/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-08T15:22:39+08:00" />
<meta property="article:modified_time" content="2022-01-08T15:22:39+08:00" />

<meta itemprop="name" content="Introduction, installation and use of the secrets management tool Vault">
<meta itemprop="description" content="Vault is a secrets management, encryption-as-a-service and privilege management tool from hashicorp. Its features are briefly described as follows. secrets management: support for saving various custom information, automatic generation of various types of keys, vault automatically generated keys can also be automatically rotated (rotate) authentication: support access to major cloud vendors&#39; account systems (such as the Aliyun RAM sub-account system) or LDAP, etc. for authentication, without creating additional account systems."><meta itemprop="datePublished" content="2022-01-08T15:22:39+08:00" />
<meta itemprop="dateModified" content="2022-01-08T15:22:39+08:00" />
<meta itemprop="wordCount" content="5774">
<meta itemprop="keywords" content="vault," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Introduction, installation and use of the secrets management tool Vault"/>
<meta name="twitter:description" content="Vault is a secrets management, encryption-as-a-service and privilege management tool from hashicorp. Its features are briefly described as follows. secrets management: support for saving various custom information, automatic generation of various types of keys, vault automatically generated keys can also be automatically rotated (rotate) authentication: support access to major cloud vendors&#39; account systems (such as the Aliyun RAM sub-account system) or LDAP, etc. for authentication, without creating additional account systems."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Introduction, installation and use of the secrets management tool Vault</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-08 15:22:39 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 5774 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#i-vault-basic-concepts">I. Vault Basic Concepts</a>
          <ul>
            <li><a href="#1-data-storage-and-encryption-decryption">1. Data Storage and Encryption Decryption</a></li>
            <li><a href="#2-authentication-system-and-permission-system">2. Authentication system and permission system</a></li>
            <li><a href="#3-secret-engine">3. Secret Engine</a></li>
          </ul>
        </li>
        <li><a href="#ii-deploying-vault">II. Deploying Vault</a>
          <ul>
            <li><a href="#0-how-do-i-choose-a-storage-backend">0. How do I choose a storage backend?</a></li>
            <li><a href="#1-docker-compose-deployment-non-ha">1. docker-compose deployment (non-HA)</a></li>
            <li><a href="#2-deploy-a-highly-available-vault-via-helm">2. Deploy a highly available vault via helm</a></li>
            <li><a href="#3-initialize-and-unseal-vault">3. initialize and unseal vault</a></li>
            <li><a href="#4-initialize-and-set-auto-unseal">4. Initialize and set auto unseal</a></li>
          </ul>
        </li>
        <li><a href="#iii-vaults-own-configuration-management">III. Vault&rsquo;s own configuration management</a>
          <ul>
            <li><a href="#1-automated-vault-configuration-using-pulumi">1. Automated vault configuration using pulumi</a></li>
          </ul>
        </li>
        <li><a href="#iv-injecting-secrets-in-kubernetes-using-vault">IV. Injecting secrets in Kubernetes using vault</a>
          <ul>
            <li><a href="#1-deploy-and-configure-the-vault-agent">1. Deploy and configure the vault agent</a></li>
            <li><a href="#2-associate-the-k8s-rbac-permissions-system-with-the-vault">2. Associate the k8s rbac permissions system with the vault</a></li>
            <li><a href="#3-deploy-pod">3. Deploy Pod</a></li>
            <li><a href="#4-vault-agent-configuration">4. vault agent configuration</a></li>
            <li><a href="#5-expanding-other-ways-to-use-vault-in-kubernetes">5. Expanding: Other ways to use vault in kubernetes</a></li>
          </ul>
        </li>
        <li><a href="#v-automatic-rotation-of-aws-iam-credentials-using-vault">V. Automatic rotation of AWS IAM Credentials using vault</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://github.com/hashicorp/vault">Vault</a> is a secrets management, encryption-as-a-service and privilege management tool from hashicorp. Its features are briefly described as follows.</p>
<ol>
<li>secrets management: support for saving various custom information, automatic generation of various types of keys, vault automatically generated keys can also be automatically rotated (rotate)</li>
<li>authentication: support access to major cloud vendors' account systems (such as the Aliyun RAM sub-account system) or LDAP, etc. for authentication, without creating additional account systems.</li>
<li>permissions management: policy, you can set very detailed ACL permissions.</li>
<li>key engine: it also supports taking over the account system of major cloud vendors (such as AliCloud RAM subaccount system) to achieve automatic rotation of API Key.</li>
<li>Support access to kubernetes rbac permissions system, and configure permissions for each Pod individually through serviceaccount+role.</li>
</ol>
<ul>
<li>Support for injecting secrets into pods via sidecar/init-container or synchronizing vault data to k8s secrets via k8s operator</li>
</ul>
<p>Before using Vault, we were using <a href="https://github.com/ctripcorp/apollo">Apollo</a>, a Ctrip open source, as a distributed configuration center for microservices.</p>
<p>Apollo is very popular in China. It is powerful, supports configuration inheritance, and also provides HTTP API for automation. The disadvantage is that permission management and secrets management are weak, and it does not support information encryption, which is not suitable for direct storage of sensitive information. So we have switched to Vault.</p>
<p>At present, our local CI/CD streamline and microservice system on the cloud are using Vault to do secrets management.</p>
<h2 id="i-vault-basic-concepts">I. Vault Basic Concepts</h2>
<p>Let&rsquo;s start with a diagram of the Vault architecture.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/08/946eca5e765e429fb89943da28e4a2f9.png" alt="image"></p>
<p>As you can see, almost all Vault components are collectively called &ldquo;Barrier&rdquo;, and the Vault can be simply divided into three parts: Storage Backend, Barrier and HTTP/S API.</p>
<p>In analogy to a bank vault, the Barrier is the &ldquo;steel&rdquo; and &ldquo;concrete&rdquo; surrounding the Vault, through which all data flows between the Storage Backend and the client.</p>
<p>&ldquo;The Barrier ensures that only encrypted data is written to the Storage Backend, and that encrypted data is verified and decrypted as it is read out through the Barrier.</p>
<p>Much like the door to a bank vault, the Barrier must be unsealed before the data in the Storage Backend can be decrypted.</p>
<h3 id="1-data-storage-and-encryption-decryption">1. Data Storage and Encryption Decryption</h3>
<p>Storage Backend: The Vault does not store data itself, so it needs to be configured with a &ldquo;Storage Backend&rdquo;. The &ldquo;Storage Backend&rdquo; is not trusted and is only used to store encrypted data.</p>
<p>Initialization: Vault needs to be initialized when it is first started, this step generates an Encryption Key which is used to encrypt the data.</p>
<p>Unseal: After the Vault is started, it will enter the &ldquo;Sealed&rdquo; state because it does not know the &ldquo;Encryption Key&rdquo;.</p>
<p>The &ldquo;encryption key&rdquo; is protected by the &ldquo;master key&rdquo; and we must provide the &ldquo;master key&rdquo; to complete the Unseal operation.</p>
<p>By default, Vault uses the <a href="https://medium.com/taipei-ethereum-meetup/%E7%A7%81%E9%91%B0%E5%88%86%E5%89%B2-shamirs-secret-sharing-7a70c8abf664">Shamir key sharing algorithm</a> to split the &ldquo;master key&rdquo; into five &ldquo;Key Shares&rdquo;, and any three of these &ldquo;Key Shares&rdquo; must be provided to reconstruct the &ldquo;master key&rdquo; for Unseal.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/08/e893caa13056419faa0dc137664d91b7.png" alt="image"></p>
<blockquote>
<p>The number of &ldquo;Key Shares&rdquo; and the minimum number of key shares needed to rebuild the &ldquo;master key&rdquo; can be adjusted. The Shamir key sharing algorithm can also be turned off, so that the master key will be used directly in Unseal.</p>
</blockquote>
<h3 id="2-authentication-system-and-permission-system">2. Authentication system and permission system</h3>
<p>After unblocking is complete, Vault is ready to start processing requests.</p>
<p>The entire processing of HTTP requests is managed by the vault core, which forces ACL checks and ensures audit logging is completed.</p>
<p>When a client first connects to the vault, it needs to complete authentication. vault&rsquo;s &ldquo;auth methods&rdquo; module has a number of authentication methods to choose from.</p>
<ul>
<li>User-friendly authentication methods, suitable for administrators: username/password, cloud provider, ldap
<ul>
<li>When creating a user, you need to bind policy for the user and give appropriate permissions.</li>
</ul>
</li>
<li>Application-friendly methods for applications: public/private keys, tokens, kubernetes, jwt</li>
</ul>
<p>Authentication requests flow through Core and into auth methods, which determine whether the request is valid and return a list of &ldquo;policies&rdquo;.</p>
<p>ACL Policies are managed and stored by the policy store, and ACL checks are performed by the core. The default behavior of ACLs is deny, which means that an action will be denied unless the Policy is explicitly configured to allow it.</p>
<p>After the authentication is done by auth methods and the returned &ldquo;associated policies&rdquo; are OK, the &ldquo;token store&rdquo; will generate and manage a new token which will be returned to the client for subsequent requests.</p>
<p>Similar to cookies on web sites, tokens have a lease or expiration date, which enhances security.</p>
<p>The token is associated with policy policies that are used to verify the permissions of the request.</p>
<p>If the secret engine returns a secret (automatically generated by the vault), Core registers it with the expiration manager and appends a lease ID to it. lease IDs are used by the client to renew (renew) or revoke (revoke). The lease ID is used by the client to update (renew) or revoke (revoke) the secret it has received.</p>
<p>If the client allows the lease to expire, the expiration manager will automatically revoke the secret.</p>
<p>Core is responsible for processing requests and response logs from the audit broker, sending requests to all configured audit devices.</p>
<h3 id="3-secret-engine">3. Secret Engine</h3>
<p>Secret Engines are components that store, generate or encrypt data and are very flexible.</p>
<p>Some Secret Engines simply store and read data, such as kv, which can be thought of as an encrypted Redis. Others connect to other services and generate dynamic credentials on demand.</p>
<p>There are also Secret Engines that provide &ldquo;encryption as a service&rdquo; capabilities, such as transit, certificate management, etc.</p>
<p>Examples of commonly used engines.</p>
<ul>
<li>AliCloud Secrets Engine: dynamically generates AliCloud Access Token based on RAM policy, or AliCloud STS credentials based on RAM role
<ul>
<li>Access Token is automatically updated (Renew), while STS credentials are used temporarily and expire after expiration.</li>
</ul>
</li>
<li>kv: Key-value store, which can be used to store some static configurations. It can replace the Apollo configuration center in Ctrip to some extent.</li>
<li>Transit Secrets Engine: Provides encryption-as-a-service function, it is only responsible for encryption and decryption, not storage. The main application scenario is to help apps encrypt and decrypt data, but the data is still stored in MySQL and other databases.</li>
</ul>
<h2 id="ii-deploying-vault">II. Deploying Vault</h2>
<p>The official recommendation is to deploy vault <a href="https://www.vaultproject.io/docs/platform/k8s/helm/run">via Helm</a>.</p>
<ol>
<li>deploy and run vault using helm/docker.</li>
<li>Initialize/unblock vault: vault security measures, each reboot must be unblocked (can be set to automatically unblock).</li>
</ol>
<h3 id="0-how-do-i-choose-a-storage-backend">0. How do I choose a storage backend?</h3>
<p>First, we definitely need HA, or at least retain the ability to upgrade to HA, so it is not recommended to choose a backend that does not support HA.</p>
<p>The exact choice varies depending on the team&rsquo;s experience, and people tend to prefer to use a backend they are familiar with and know well, or go with a cloud service.</p>
<p>For example, if we are familiar with MySQL/PostgreSQL, and we don&rsquo;t need to think too much about maintenance when using a database provided by a cloud service, and MySQL as a common protocol is not kidnapped by cloud vendors, then we tend to use MySQL/PostgreSQL.</p>
<p>And if you are locally self-built, then you may prefer to use Etcd/Consul/Raft for backend storage.</p>
<h3 id="1-docker-compose-deployment-non-ha">1. docker-compose deployment (non-HA)</h3>
<blockquote>
<p>Recommended for local development test environments, or other environments that do not require high availability.</p>
</blockquote>
<p>The <code>docker-compose.yml</code> example is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.3&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 文档：https://hub.docker.com/_/vault</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">vault:1.6.0</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># rootless 容器，内部不能使用标准端口 443</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;443:8200&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 审计日志存储目录，默认不写审计日志，启用 `file` audit backend 时必须提供一个此文件夹下的路径</span><span class="w">
</span><span class="w">      </span>- <span class="l">./logs:/vault/logs</span><span class="w">
</span><span class="w">      </span><span class="c"># 当使用 file data storage 插件时，数据被存储在这里。默认不往这写任何数据。</span><span class="w">
</span><span class="w">      </span>- <span class="l">./file:/vault/file</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置目录，vault 默认 `/valut/config/` 中所有以 .hcl/.json 结尾的文件</span><span class="w">
</span><span class="w">      </span><span class="c"># config.hcl 文件内容，参考 cutom-vaules.yaml</span><span class="w">
</span><span class="w">      </span>- <span class="l">./config.hcl:/vault/config/config.hcl</span><span class="w">
</span><span class="w">      </span><span class="c"># TLS 证书</span><span class="w">
</span><span class="w">      </span>- <span class="l">./certs:/certs</span><span class="w">
</span><span class="w">    </span><span class="c"># vault 需要锁定内存以防止敏感值信息被交换(swapped)到磁盘中</span><span class="w">
</span><span class="w">    </span><span class="c"># 为此需要添加如下能力</span><span class="w">
</span><span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">IPC_LOCK</span><span class="w">
</span><span class="w">    </span><span class="c"># 必须手动设置 entrypoint，否则 vault 将以 development 模式运行</span><span class="w">
</span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">vault server -config /vault/config/config.hcl</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>config.hcl</code> reads as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ui</span> <span class="o">=</span> <span class="nb">true</span>

// 使用文件做数据存储（单节点）
storage <span class="s2">&#34;file&#34;</span> <span class="o">{</span>
  <span class="nv">path</span>    <span class="o">=</span> <span class="s2">&#34;/vault/file&#34;</span>
<span class="o">}</span>

listener <span class="s2">&#34;tcp&#34;</span> <span class="o">{</span>
  <span class="nv">address</span> <span class="o">=</span> <span class="s2">&#34;[::]:8200&#34;</span>

  <span class="nv">tls_disable</span> <span class="o">=</span> <span class="nb">false</span>
  <span class="nv">tls_cert_file</span> <span class="o">=</span> <span class="s2">&#34;/certs/server.crt&#34;</span>
  <span class="nv">tls_key_file</span>  <span class="o">=</span> <span class="s2">&#34;/certs/server.key&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Save the two configurations as above in the same non-folder and provide the TLS certificate <code>server.crt</code> and the private key <code>server.key</code> in <code>. /certs</code> with the TLS certificate <code>server.crt</code> and the private key <code>server.key</code>.</p>
<p>Then <code>docker-compose up -d</code> will start running a vault instance.</p>
<h3 id="2-deploy-a-highly-available-vault-via-helm">2. Deploy a highly available vault via helm</h3>
<blockquote>
<p>Recommended for production environments</p>
</blockquote>
<p>Deploy via helm.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 添加 valut 仓库</span><span class="w">
</span><span class="w"></span><span class="l">helm repo add hashicorp https://helm.releases.hashicorp.com</span><span class="w">
</span><span class="w"></span><span class="c"># 查看 vault 版本号</span><span class="w">
</span><span class="w"></span><span class="l">helm search repo hashicorp/vault -l | head</span><span class="w">
</span><span class="w"></span><span class="c"># 下载某个版本号的 vault</span><span class="w">
</span><span class="w"></span><span class="l">helm pull hashicorp/vault --version  0.11.0 --untar</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Refer to the downloaded <code>. /vault/values.yaml</code> to write <code>custom-values.yaml</code> and deploy a HA vault with <code>mysql</code> as the backend storage:</p>
<blockquote>
<p>The configuration is extensive, but mostly copied directly from <code>./vault/values.yaml</code>, with very few changes. Most of the configuration items can be ignored when testing the vault.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># enabled is the master enabled switch. Setting this to true or false</span><span class="w">
</span><span class="w">  </span><span class="c"># will enable or disable all the components within this chart by default.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># TLS for end-to-end encrypted transport</span><span class="w">
</span><span class="w">  </span><span class="nt">tlsDisable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">injector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># True if you want to enable vault agent injection.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If true, will enable a node exporter metrics endpoint at /metrics.</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Mount Path of the Vault Kubernetes Auth Method.</span><span class="w">
</span><span class="w">  </span><span class="nt">authPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;auth/kubernetes&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># secretName is the name of the secret that has the TLS certificate and</span><span class="w">
</span><span class="w">    </span><span class="c"># private key to serve the injector webhook. If this is null, then the</span><span class="w">
</span><span class="w">    </span><span class="c"># injector will default to its automatic management mode that will assign</span><span class="w">
</span><span class="w">    </span><span class="c"># a service account to the injector to generate its own certificates.</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># caBundle is a base64-encoded PEM-encoded certificate bundle for the</span><span class="w">
</span><span class="w">    </span><span class="c"># CA that signed the TLS certificate that the webhook serves. This must</span><span class="w">
</span><span class="w">    </span><span class="c"># be set if secretName is non-null.</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># certName and keyName are the names of the files within the secret for</span><span class="w">
</span><span class="w">    </span><span class="c"># the TLS cert and private key, respectively. These have reasonable</span><span class="w">
</span><span class="w">    </span><span class="c"># defaults but can be customized if necessary.</span><span class="w">
</span><span class="w">    </span><span class="nt">certName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.crt</span><span class="w">
</span><span class="w">    </span><span class="nt">keyName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.key</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># Resource requests, limits, etc. for the server cluster placement. This</span><span class="w">
</span><span class="w">  </span><span class="c"># should map directly to the value of the resources field for a PodSpec.</span><span class="w">
</span><span class="w">  </span><span class="c"># By default no direct resource request is made.</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Enables a headless service to be used by the Vault Statefulset</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># Port on which Vault server is listening</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span><span class="w">    </span><span class="c"># Target port to which the service should be mapped to</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># This configures the Vault Statefulset to create a PVC for audit</span><span class="w">
</span><span class="w">  </span><span class="c"># logs.  Once Vault is deployed, initialized and unseal, Vault must</span><span class="w">
</span><span class="w">  </span><span class="c"># be configured to use this for audit logs.  This will be mounted to</span><span class="w">
</span><span class="w">  </span><span class="c"># /vault/audit</span><span class="w">
</span><span class="w">  </span><span class="c"># See https://www.vaultproject.io/docs/audit/index.html to know more</span><span class="w">
</span><span class="w">  </span><span class="nt">auditStorage</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Run Vault in &#34;HA&#34; mode. There are no storage requirements unless audit log</span><span class="w">
</span><span class="w">  </span><span class="c"># persistence is required.  In HA mode Vault will configure itself to use Consul</span><span class="w">
</span><span class="w">  </span><span class="c"># for its storage backend.  The default configuration provided will work the Consul</span><span class="w">
</span><span class="w">  </span><span class="c"># Helm project by default.  It is possible to manually configure Vault to use a</span><span class="w">
</span><span class="w">  </span><span class="c"># different HA backend.</span><span class="w">
</span><span class="w">  </span><span class="nt">ha</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># Set the api_addr configuration for Vault HA</span><span class="w">
</span><span class="w">    </span><span class="c"># See https://www.vaultproject.io/docs/configuration#api_addr</span><span class="w">
</span><span class="w">    </span><span class="c"># If set to null, this will be set to the Pod IP Address</span><span class="w">
</span><span class="w">    </span><span class="nt">apiAddr</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># config is a raw string of default configuration when using a Stateful</span><span class="w">
</span><span class="w">    </span><span class="c"># deployment. Default is to use a Consul for its HA storage backend.</span><span class="w">
</span><span class="w">    </span><span class="c"># This should be HCL.</span><span class="w">
</span><span class="w">    
</span><span class="w">    </span><span class="c"># Note: Configuration files are stored in ConfigMaps so sensitive data </span><span class="w">
</span><span class="w">    </span><span class="c"># such as passwords should be either mounted through extraSecretEnvironmentVars</span><span class="w">
</span><span class="w">    </span><span class="c"># or through a Kube secret.  For more information see: </span><span class="w">
</span><span class="w">    </span><span class="c"># https://www.vaultproject.io/docs/platform/k8s/helm/run#protecting-sensitive-vault-configurations</span><span class="w">
</span><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      ui = true
</span><span class="sd">
</span><span class="sd">      listener &#34;tcp&#34; {
</span><span class="sd">        address = &#34;[::]:8200&#34;
</span><span class="sd">        cluster_address = &#34;[::]:8201&#34;
</span><span class="sd">
</span><span class="sd">        # 注意，这个值要和 helm 的参数 global.tlsDisable 一致
</span><span class="sd">        tls_disable = false
</span><span class="sd">        tls_cert_file = &#34;/etc/certs/vault.crt&#34;
</span><span class="sd">        tls_key_file  = &#34;/etc/certs/vault.key&#34;
</span><span class="sd">      }
</span><span class="sd">
</span><span class="sd">      # storage &#34;postgresql&#34; {
</span><span class="sd">      #   connection_url = &#34;postgres://username:password@&lt;host&gt;:5432/vault?sslmode=disable&#34;
</span><span class="sd">      #   ha_enabled = true
</span><span class="sd">      # }
</span><span class="sd">
</span><span class="sd">      service_registration &#34;kubernetes&#34; {}
</span><span class="sd">
</span><span class="sd">      # Example configuration for using auto-unseal, using AWS KMS. 
</span><span class="sd">      # the cluster must have a service account that is authorized to access AWS KMS, throught an IAM Role.
</span><span class="sd">      # seal &#34;awskms&#34; {
</span><span class="sd">      #   region     = &#34;us-east-1&#34;
</span><span class="sd">      #   kms_key_id = &#34;&lt;some-key-id&gt;&#34;
</span><span class="sd">      #   默认情况下插件会使用 awskms 的公网 enpoint，但是也可以使用如下参数，改用自行创建的 vpc 内网 endpoint
</span><span class="sd">      #   endpoint   = &#34;https://&lt;vpc-endpoint-id&gt;.kms.us-east-1.vpce.amazonaws.com&#34;
</span><span class="sd">      # }      </span><span class="w">      
</span><span class="w">
</span><span class="w">  </span><span class="c"># Definition of the serviceAccount used to run Vault.</span><span class="w">
</span><span class="w">  </span><span class="c"># These options are also used when using an external Vault server to validate</span><span class="w">
</span><span class="w">  </span><span class="c"># Kubernetes tokens.</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;vault&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 如果要使用 auto unseal 的话，这个填写拥有 awskms 权限的 AWS IAM Role</span><span class="w">
</span><span class="w">      </span><span class="nt">eks.amazonaws.com/role-arn</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;role-arn&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Vault UI</span><span class="w">
</span><span class="w"></span><span class="nt">ui</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">publishNotReadyAddresses</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceType</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span><span class="w">  </span><span class="nt">activeVaultPodOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">externalPort</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Now deploy vautl using the custom <code>custom-values.yaml</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl create namespace vault
<span class="c1"># 安装/升级 valut</span>
helm upgrade --install vault ./vault --namespace vault -f custom-values.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="3-initialize-and-unseal-vault">3. initialize and unseal vault</h3>
<blockquote>
<p>Official documentation: <a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-raft-deployment-guide?in=vault/kubernetes#install-vault">Initialize and unseal Vault - Vault on Kubernetes Deployment Guide</a></p>
</blockquote>
<p>Deploying a vault via helm deploys a three-copy StatefulSet by default, but all three copies will be in a NotReady state (as will the docker deployment). Next, you need to manually initialize and unblock the vault in order to <code>Ready</code> :</p>
<ul>
<li>Step 1: Select any one of the three copies and run the vault initialization command: <code>kubectl exec -ti vault-0 -- vault operator init</code>
<ul>
<li>The initialization operation will return 5 unseal keys, and an Initial Root Token, which is very sensitive and important, and must be saved to a safe place!</li>
</ul>
</li>
<li>Step 2: On each copy, use any three unseal keys for the unseal operation.
<ul>
<li>There are three copies in total, which means you have to unseal 3*3 times to complete the complete unsealing of the vault!</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 每个实例都需要解封三次！</span>
<span class="c1">## Unseal the first vault server until it reaches the key threshold</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 1</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 2</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 3</span>
</code></pre></td></tr></table>
</div>
</div><p>This completes the deployment, but be aware that the **vault instance needs to be unblocked again after each restart! That is, re-do the second step! **</p>
<h3 id="4-initialize-and-set-auto-unseal">4. Initialize and set auto unseal</h3>
<p>Without setting auto unseal, vault has to unseal all vault instances manually every time it restarts, which is really troublesome.</p>
<p>To simplify this process, you can consider configuring auto unseal to allow vault unblocking automatically.</p>
<p>There are currently two ways to do this.</p>
<ul>
<li>Use the key repository provided by cloud services such as AliCloud/AWS/Azure to manage the encryption key
<ul>
<li>AWS: <a href="https://www.vaultproject.io/docs/configuration/seal/awskms">awskms Seal</a>
<ul>
<li>If it is a k8s cluster, the ServiceAccount used by vault needs to have permission to use AWS KMS, which replaces the access_key/secret_key attributes in config.hcl</li>
</ul>
</li>
<li>AliCloud: <a href="https://www.vaultproject.io/docs/configuration/seal/alicloudkms">alicloudkms Seal</a></li>
</ul>
</li>
<li>If you don&rsquo;t want to use cloud services, then consider <a href="https://learn.hashicorp.com/tutorials/vault/autounseal-transit">autounseal-transit</a>, which uses the transit engine provided by another vault instance to This approach uses the transit engine provided by another vault instance to implement auto-unseal.</li>
<li>Simple and brutal: write a crontab or add a timed task to the CI platform to execute the unseal command to achieve auto-unseal. But this is not very secure.</li>
</ul>
<p>Take awskms as an example, first create aws IAM policy with the following content:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;Sid&#34;</span><span class="p">:</span> <span class="s2">&#34;VaultKMSUnseal&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&#34;kms:Decrypt&#34;</span><span class="p">,</span>
                <span class="s2">&#34;kms:Encrypt&#34;</span><span class="p">,</span>
                <span class="s2">&#34;kms:DescribeKey&#34;</span>
            <span class="p">],</span>
            <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then create an IAM Role to bind the above policy, and create an IAM Role for the vault&rsquo;s k8s serviceaccount to bind to this policy.</p>
<p>This way the serviceaccount used by the vault will have access to awskms itself and will not need to access awskms via access_key/secret_key.</p>
<p>For more information on how to bind IAM roles to k8s serviceaccounts, see the official documentation: <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">IAM roles for EKS service accounts</a></p>
<p>When you are done, modify the helm configuration provided earlier, deploy it, and finally initialize it with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 初始化命令和普通模式并无不同</span>
kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator init
<span class="c1"># 会打印出一个 root token，以及五个 Recovery Key（而不是 Unseal Key）</span>
<span class="c1"># Recover Key 不再用于解封，但是重新生成 root token 等操作仍然会需要用到它.</span>
</code></pre></td></tr></table>
</div>
</div><p>Then it&rsquo;s done, you can try to delete the vault pod, the new pod should be automatically unblocked.</p>
<h2 id="iii-vaults-own-configuration-management">III. Vault&rsquo;s own configuration management</h2>
<p>Vault itself is a complex secrets tool that provides <strong>Web UI</strong> and <strong>CLI</strong> for manually managing and viewing the contents of Vault.</p>
<p>But as a DevOps, we of course prefer an automated approach, and there are two options:</p>
<ul>
<li>Use the sdk for vault: python-<a href="https://github.com/hvac/hvac">hvac</a></li>
<li>Use <a href="https://github.com/hashicorp/terraform-provider-vault">terraform-provider-vault</a> or <a href="https://github.com/pulumi/">pulumi-vault</a> pulumi-vault) to automate the management of vault configurations.</li>
</ul>
<p>While the Web UI is suitable for manual work, sdk/ <code>terraform-provider-vault</code> is suitable for automating the management of the vault.</p>
<p>Our test environment uses <code>pulumi-vault</code> to automate the configuration of the vault policy and kubernetes role, and then automate the injection of all secrets for testing.</p>
<h3 id="1-automated-vault-configuration-using-pulumi">1. Automated vault configuration using pulumi</h3>
<p>The advantage of using pulumi to manage the vault configuration is great because the sensitive information of the resources on the cloud (database account passwords, resource IDs, RAM subaccounts) are created by pulumi.</p>
<p>Combined with the use of pulumi_valut, the sensitive information is automatically generated and immediately saved to the vault, making it fully automated.</p>
<p>Subsequent microservices can then read sensitive information directly from the vault through kubernetes authentication.</p>
<p>Or it can be written to a local vault for backup, so that administrators can log in and view the sensitive information when needed.</p>
<h4 id="11-token-generation">1.1 Token generation</h4>
<p>pulumi_vault itself is quite simple, declarative configuration, just use it directly.</p>
<p>However, it must require <code>VAULT_TOKEN</code> as authentication credentials (in practice, userpass/approle cannot be used directly, it will report <code>no vault token found</code>), and pulumi will also generate a temporary child token, which will be used for subsequent operations.</p>
<p>The root token should be blocked and should not be enabled except for emergencies.</p>
<p>So how should I generate a token with limited privileges for the vault to use? My approach is to create a userpass account and give it limited privileges via policy. Then manually (or automatically) login to get the token, and then provide the token to pulumi_vault.</p>
<p>The catch is that you have to give the userpass account the permission to create a child token.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">path &#34;local/*&#34; {
  capabilities = [&#34;read&#34;, &#34;list&#34;]
}

// 允许创建 child token
path &#34;auth/token/create&#34; {
  capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]
}
</code></pre></td></tr></table>
</div>
</div><p>Without this permission, pulumi_vault will keep reporting errors.</p>
<p>Then you have to give it the permissions it needs to &ldquo;automate the configuration&rdquo;, such as creating/updating policy/secrets/kubernetes automatically, as shown in the following example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># To list policies - Step 3</span>
path <span class="s2">&#34;sys/policy&#34;</span>
<span class="o">{</span>
  <span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;read&#34;</span><span class="o">]</span>
<span class="o">}</span>

<span class="c1"># Create and manage ACL policies broadly across Vault</span>
path <span class="s2">&#34;sys/policy/*&#34;</span>
<span class="o">{</span>
  <span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;read&#34;</span>, <span class="s2">&#34;update&#34;</span>, <span class="s2">&#34;delete&#34;</span>, <span class="s2">&#34;list&#34;</span>, <span class="s2">&#34;sudo&#34;</span><span class="o">]</span>
<span class="o">}</span>

<span class="c1"># List, create, update, and delete key/value secrets</span>
path <span class="s2">&#34;secret/*&#34;</span>
<span class="o">{</span>
  <span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;read&#34;</span>, <span class="s2">&#34;update&#34;</span>, <span class="s2">&#34;delete&#34;</span>, <span class="s2">&#34;list&#34;</span>, <span class="s2">&#34;sudo&#34;</span><span class="o">]</span>
<span class="o">}</span>

path <span class="s2">&#34;auth/kubernetes/role/*&#34;</span>
<span class="o">{</span>
  <span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;read&#34;</span>, <span class="s2">&#34;update&#34;</span>, <span class="s2">&#34;list&#34;</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="iv-injecting-secrets-in-kubernetes-using-vault">IV. Injecting secrets in Kubernetes using vault</h2>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/08/00458fc86244457f83a072573c7c09bf.png" alt="image"></p>
<p>As mentioned earlier, vault supports assigning permissions to each Pod individually through Kubernetes' ServiceAccount.</p>
<p>There are two ways for applications to read the configuration in vault.</p>
<ul>
<li>With Vault Sidecar, secrets are automatically injected into the Pod as a file, such as <code>/vault/secrets/config.json</code>.
<ul>
<li>The vault sidecar updates the configuration every 15 seconds in resident mode, and applications can use <code>watchdog</code> to monitor changes to the secrets file in real time.</li>
</ul>
</li>
<li>The application itself uses the SDK to access the vault api directly to get secrets</li>
</ul>
<p>Both of these methods can be used to authenticate and assign permissions with the Kubernetes ServiceAccount.</p>
<p>The following is an example of how to inject secrets into a Pod as a file in Sidecar mode.</p>
<h3 id="1-deploy-and-configure-the-vault-agent">1. Deploy and configure the vault agent</h3>
<p>First enable Kubernetes authentication for Vault:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 配置身份认证需要在 vault pod 中执行，启动 vault-0 的交互式会话</span>
kubectl <span class="nb">exec</span> -n vault -it vault-0 -- /bin/sh
<span class="nb">export</span> <span class="nv">VAULT_TOKEN</span><span class="o">=</span><span class="s1">&#39;&lt;your-root-token&gt;&#39;</span>
<span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">&#39;http://localhost:8200&#39;</span>
 
<span class="c1"># 启用 Kubernetes 身份验证</span>
vault auth <span class="nb">enable</span> kubernetes

<span class="c1"># kube-apiserver API 配置，vault 需要通过 kube-apiserver 完成对 serviceAccount 的身份验证</span>
vault write auth/kubernetes/config <span class="se">\
</span><span class="se"></span>    <span class="nv">token_reviewer_jwt</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class="k">)</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">kubernetes_host</span><span class="o">=</span><span class="s2">&#34;https://</span><span class="nv">$KUBERNETES_PORT_443_TCP_ADDR</span><span class="s2">:443&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">kubernetes_ca_cert</span><span class="o">=</span>@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</code></pre></td></tr></table>
</div>
</div><h4 id="11-using-valut-instances-external-to-the-cluster">1.1 Using valut instances external to the cluster</h4>
<blockquote>
<p>If you do not have this requirement, please skip this section.</p>
</blockquote>
<blockquote>
<p>See [Install the Vault Helm chart configured to address an external Vault](<a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-external-">https://learn.hashicorp.com/tutorials/vault/kubernetes-external-</a> vault?in=vault/kubernetes#install-the-vault-helm-chart-configured-to-address-an-external-vault)</p>
</blockquote>
<p>kubernetes can also be integrated with external vault instances, with only the vault-agent deployed in the cluster.</p>
<p>This is suitable for multiple kubernetes clusters and other APPs that share a single vault instance, such as our local development and testing clusters, which all share the same vault instance to facilitate unified management of application secrets.</p>
<p>First, use helm chart to deploy the vault-agent to access the external vault instance. The <code>custom-values.yaml</code> example used is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># enabled is the master enabled switch. Setting this to true or false</span><span class="w">
</span><span class="w">  </span><span class="c"># will enable or disable all the components within this chart by default.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># TLS for end-to-end encrypted transport</span><span class="w">
</span><span class="w">  </span><span class="nt">tlsDisable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">injector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># True if you want to enable vault agent injection.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If multiple replicas are specified, by default a leader-elector side-car</span><span class="w">
</span><span class="w">  </span><span class="c"># will be created so that only one injector attempts to create TLS certificates.</span><span class="w">
</span><span class="w">  </span><span class="nt">leaderElector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gcr.io/google_containers/leader-elector&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.4&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If true, will enable a node exporter metrics endpoint at /metrics.</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># External vault server address for the injector to use. Setting this will</span><span class="w">
</span><span class="w">  </span><span class="c"># disable deployment of a  vault server along with the injector.</span><span class="w">
</span><span class="w">  </span><span class="c"># TODO 这里的 https ca.crt 要怎么设置？mTLS 又该如何配置？</span><span class="w">
</span><span class="w">  </span><span class="nt">externalVaultAddr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://&lt;external-vault-url&gt;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Mount Path of the Vault Kubernetes Auth Method.</span><span class="w">
</span><span class="w">  </span><span class="nt">authPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;auth/kubernetes&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># secretName is the name of the secret that has the TLS certificate and</span><span class="w">
</span><span class="w">    </span><span class="c"># private key to serve the injector webhook. If this is null, then the</span><span class="w">
</span><span class="w">    </span><span class="c"># injector will default to its automatic management mode that will assign</span><span class="w">
</span><span class="w">    </span><span class="c"># a service account to the injector to generate its own certificates.</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># caBundle is a base64-encoded PEM-encoded certificate bundle for the</span><span class="w">
</span><span class="w">    </span><span class="c"># CA that signed the TLS certificate that the webhook serves. This must</span><span class="w">
</span><span class="w">    </span><span class="c"># be set if secretName is non-null.</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># certName and keyName are the names of the files within the secret for</span><span class="w">
</span><span class="w">    </span><span class="c"># the TLS cert and private key, respectively. These have reasonable</span><span class="w">
</span><span class="w">    </span><span class="c"># defaults but can be customized if necessary.</span><span class="w">
</span><span class="w">    </span><span class="nt">certName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.crt</span><span class="w">
</span><span class="w">    </span><span class="nt">keyName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.key</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Now on the vault instance side, enable kubernetes authentication, and within the vault instance, execute the following command.</p>
<blockquote>
<p>Obviously there is no kubectl or kubeconfig inside the vault instance, so for simplicity, the following vault commands can also be done via the Web UI.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">VAULT_TOKEN</span><span class="o">=</span><span class="s1">&#39;&lt;your-root-token&gt;&#39;</span>
<span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">&#39;http://localhost:8200&#39;</span>
 
<span class="c1"># 启用 Kubernetes 身份验证</span>
vault auth <span class="nb">enable</span> kubernetes
 
<span class="c1"># kube-apiserver API 配置，vault 需要通过 kube-apiserver 完成对 serviceAccount 的身份验证</span>
<span class="c1"># TOKEN_REVIEW_JWT: 就是我们前面创建的 secret `vault-auth`</span>
<span class="nv">TOKEN_REVIEW_JWT</span><span class="o">=</span><span class="k">$(</span>kubectl -n vault get secret vault-auth -o go-template<span class="o">=</span><span class="s1">&#39;{{ .data.token }}&#39;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
<span class="c1"># kube-apiserver 的 ca 证书</span>
<span class="nv">KUBE_CA_CERT</span><span class="o">=</span><span class="k">$(</span>kubectl -n vault config view --raw --minify --flatten -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[].cluster.certificate-authority-data}&#39;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
<span class="c1"># kube-apiserver 的 url</span>
<span class="nv">KUBE_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl config view --raw --minify --flatten -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[].cluster.server}&#39;</span><span class="k">)</span>

vault write auth/kubernetes/config <span class="se">\
</span><span class="se"></span>        <span class="nv">token_reviewer_jwt</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$TOKEN_REVIEW_JWT</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>        <span class="nv">kubernetes_host</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$KUBE_HOST</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>        <span class="nv">kubernetes_ca_cert</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$KUBE_CA_CERT</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>This completes the integration of kubernetes with the external vault!</p>
<h3 id="2-associate-the-k8s-rbac-permissions-system-with-the-vault">2. Associate the k8s rbac permissions system with the vault</h3>
<p>Next things to do.</p>
<ul>
<li>Define which resources each role (microservice) can access through the vault policy.</li>
<li>Generate a role for each microservice, and bind the corresponding vault policy and kubernetes serviceaccount to the role.
<ul>
<li>The role is a property of the vault&rsquo;s kubernetes plugin itself, it has nothing to do with the kubernetes role.</li>
</ul>
</li>
<li>Create a ServiceAccount and use this to deploy microservices using this ServiceAccount</li>
</ul>
<p>The first and second steps can be automated through the vault api. The third step can be done during deployment via kubectl.</p>
<p>For convenience, it is recommended to use the same name as the microservice for all three configurations, vault policy / role / k8s serviceaccount.</p>
<blockquote>
<p>In the above configuration, the role acts as a primer, associating the k8s serviceaccount and vault policy configurations.</p>
</blockquote>
<p>For example, create a vault policy named <code>my-app-policy</code> with the content:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 允许读取数据</span><span class="w">
</span><span class="w"></span><span class="l">path &#34;my-app/data/*&#34; {</span><span class="w">
</span><span class="w">   </span><span class="l">capabilities = [&#34;read&#34;, &#34;list&#34;]</span><span class="w">
</span><span class="w"></span>}<span class="w">
</span><span class="w"></span><span class="l">// 允许列出 myapp 中的所有数据(kv v2)</span><span class="w">
</span><span class="w"></span><span class="l">path &#34;myapp/metadata/*&#34; {</span><span class="w">
</span><span class="w">    </span><span class="l">capabilities = [&#34;read&#34;, &#34;list&#34;]</span><span class="w">
</span><span class="w"></span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Then, in the vault kuberntes plugin configuration, create role <code>my-app-role</code> with the following configuration:</p>
<ul>
<li>Associate the serviceaccount <code>my-app-account</code> in the k8s default namespace and create the serviceaccount.</li>
<li>Associate the vault token policy, which is the <code>my-app-policy</code> created earlier.</li>
<li>Set the token period (validity)</li>
</ul>
<p>After this, each microservice will be able to read all the information in <code>my-app</code> from the vault via serviceaccount.</p>
<h3 id="3-deploy-pod">3. Deploy Pod</h3>
<blockquote>
<p>Reference: <a href="https://www.vaultproject.io/docs/platform/k8s/injector">https://www.vaultproject.io/docs/platform/k8s/injector</a></p>
</blockquote>
<p>The next step is to inject the configuration into the microservice container, which requires the use of Agent Sidecar Injector. vault automates the injection and dynamic update of the configuration via sidecar.</p>
<p>Specifically, a bunch of Agent Sidecar Injector annotations are added to the Pod, or if there are more configurations, they can be saved using configmap and referenced in the annotations.</p>
<p>Note that vault-inject-agent has two modes of operation.</p>
<ul>
<li>init mode: Initialize only once before the Pod starts, and exit after running (Completed)</li>
<li>resident mode: the container does not exit, continuously monitors the vault for configuration updates and maintains synchronization between Pod configuration and vualt configuration.</li>
</ul>
<p>Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-init-first</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">  </span><span class="c"># 是否使用 initContainer 提前初始化配置文件</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-inject</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/secret-volume-path</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/role</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my-app-role&#34;</span><span class="w">  </span><span class="c"># vault kubernetes 插件的 role 名称</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-inject-template-config.json</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">                    </span><span class="w">                    </span><span class="c"># 渲染模板的语法在后面介绍</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-limits-cpu</span><span class="p">:</span><span class="w"> </span><span class="l">250m</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-requests-cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">        </span><span class="c"># 包含 vault 配置的 configmap，可以做更精细的控制</span><span class="w">
</span><span class="w">        </span><span class="c"># vault.hashicorp.com/agent-configmap: my-app-vault-config</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.svc.local/xx/my-app:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="c"># 此处省略若干配置...</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-account</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Common errors.</p>
<ul>
<li>vault-agent(sidecar) error: <code>namespace not authorized</code>
<ul>
<li>The role in <code>auth/kubernetes/config</code> is not bound to the Pod namespace.</li>
</ul>
</li>
<li>vault-agent(sidecar) error: `permission denied
<ul>
<li>Check the logs of the <code>vault</code> instance, there should be a corresponding error log, most likely <code>auth/kubernetes/config</code> is not paired, vault cannot verify the kube-apiserver tls certificate, or the kubernetes token used does not have permission.</li>
</ul>
</li>
<li>vault-agent(sidecar) error: <code>service account not authorized</code>.
<ul>
<li>The role in <code>auth/kubernetes/config</code> is not bound to the serviceAccount used by the Pod.</li>
</ul>
</li>
</ul>
<h3 id="4-vault-agent-configuration">4. vault agent configuration</h3>
<p>For the vault-agent configuration, the following should be noted.</p>
<ul>
<li>If you use configmap to provide the full <code>config.hcl</code> configuration, note that <code>agent-init</code></li>
</ul>
<p>vautl-agent template description.</p>
<p>The most popular configuration file format is json/yaml, so take json as an example, for each microservice&rsquo;s kv data, consider saving all its personalized configuration under <code>&lt;engine-name&gt;/&lt;service-name&gt;/</code>, and then inject the configuration using the following template.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-tpl" data-lang="tpl"><span class="cp">{</span>
    <span class="cp">{{</span> <span class="na">range</span> <span class="na">secrets</span> <span class="s2">&#34;&lt;engine-name&gt;/metadata/&lt;service-name&gt;/&#34;</span> <span class="cp">}}</span>
        <span class="s2">&#34;{{ printf &#34;</span><span class="o">%</span><span class="na">s</span><span class="s2">&#34; . }}&#34;</span><span class="o">:</span> 
        <span class="cp">{{</span> <span class="na">with</span> <span class="na">secret</span> <span class="o">(</span><span class="na">printf</span> <span class="s2">&#34;&lt;engine-name&gt;/&lt;service-name&gt;/%s&#34;</span> <span class="o">.)</span> <span class="cp">}}</span>
        <span class="cp">{{</span> <span class="o">.</span><span class="na">Data</span><span class="o">.</span><span class="na">data</span> <span class="o">|</span> <span class="na">toJSONPretty</span> <span class="cp">}}</span><span class="o">,</span>
        <span class="cp">{{</span> <span class="na">end</span> <span class="cp">}}</span>
    <span class="cp">{{</span> <span class="na">end</span> <span class="cp">}}</span>
<span class="cp">}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>See: <a href="https://github.com/hashicorp/consul-template#secret">https://github.com/hashicorp/consul-template#secret</a> for template syntax details</p>
</blockquote>
<blockquote>
<p>Note: For v2 kv secrets, the list interface has changed, so when traversing v2 kv secrets, you must write <code>range secrets &quot;&lt;engine-name&gt;/metadata/&lt;service-name&gt;/&quot;</code>, i.e. insert <code>metadata</code> in between, and read/list permissions for <code>&lt;engine-name&gt;/metadata/&lt;service-name&gt;/</code> must be open in the policy! The official documentation doesn&rsquo;t mention this at all, I figured this out by debugging with wireshark packet grabbing and comparing with the official <a href="https://www.vaultproject.io/api-docs/secret/kv/kv-v2">KV Secrets Engine - Version 2 (API)</a>.</p>
</blockquote>
<p>The generated content will be in json format, but there is an incompatibility: the last secrets has a comma <code>,</code> at the end of the rendered effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;secret-a&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;a&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
  <span class="nt">&#34;c&#34;</span><span class="p">:</span> <span class="s2">&#34;d&#34;</span>
<span class="p">},</span>
    <span class="nt">&#34;secret-b&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;v&#34;</span><span class="p">:</span> <span class="s2">&#34;g&#34;</span><span class="p">,</span>
  <span class="nt">&#34;r&#34;</span><span class="p">:</span> <span class="s2">&#34;c&#34;</span>
<span class="p">},</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Because of the trailing comma, parsing it directly using the json standard library will report an error. So how do I parse it? I found the solution on the almighty stackoverflow: <strong>yaml is fully compatible with json syntax and supports trailing comma!</strong></p>
<p>Take python for example, <code>yaml.safe_load()</code> will parse the json generated by vault perfectly.</p>
<h3 id="5-expanding-other-ways-to-use-vault-in-kubernetes">5. Expanding: Other ways to use vault in kubernetes</h3>
<p>In addition to using the official sidecar schema for secrets injection, the community has provided some other options, which can be found at</p>
<ul>
<li><a href="https://github.com/hashicorp/vault-csi-provider">hashicorp/vault-csi-provider</a>: the official Beta project that mounts vault secrets as data volumes via the Secrets Store CSI driver mount the vault secrets as a data volume in the pod</li>
<li><a href="https://github.com/external-secrets/kubernetes-external-secrets">kubernetes-external-secrets</a>: provides CRD definitions to synchronize secret from vault to kubernetes secrets</li>
</ul>
<p>The official sidecar/init-container model is still the most recommended.</p>
<h2 id="v-automatic-rotation-of-aws-iam-credentials-using-vault">V. Automatic rotation of AWS IAM Credentials using vault</h2>
<p>To be continued.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vault/">vault</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/qemu-kvm-usage/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">QEMU-KVM Virtualization Environment Construction and Use</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/expirence-of-argo-workflow/">
            <span class="next-text nav-default">Installation, usage and personal experience with Argo Workflows, the cloud-native pipeline</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
