<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Why there are no more global variables in Lua 5.3 - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I&amp;rsquo;ve been using Lua 5.1 in the past, and I don&amp;rsquo;t know much about _ENV in Lua 5.3. Recently, I used Lua 5.3 in a new project, so I looked into it. This article summarizes the meaning of the environment and global variables in Lua 5.3, _ENV and their usage.
Types of Lua variables Lua variables can be classified as local, upvalue and global variables. Anyone who has used Lua a lot should be familiar with it, as an example:" /><meta name="keywords" content="lua" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/lua53-environment/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Why there are no more global variables in Lua 5.3" />
<meta property="og:description" content="I&rsquo;ve been using Lua 5.1 in the past, and I don&rsquo;t know much about _ENV in Lua 5.3. Recently, I used Lua 5.3 in a new project, so I looked into it. This article summarizes the meaning of the environment and global variables in Lua 5.3, _ENV and their usage.
Types of Lua variables Lua variables can be classified as local, upvalue and global variables. Anyone who has used Lua a lot should be familiar with it, as an example:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/lua53-environment/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-04T12:26:51+08:00" />
<meta property="article:modified_time" content="2022-01-04T12:26:51+08:00" />

<meta itemprop="name" content="Why there are no more global variables in Lua 5.3">
<meta itemprop="description" content="I&rsquo;ve been using Lua 5.1 in the past, and I don&rsquo;t know much about _ENV in Lua 5.3. Recently, I used Lua 5.3 in a new project, so I looked into it. This article summarizes the meaning of the environment and global variables in Lua 5.3, _ENV and their usage.
Types of Lua variables Lua variables can be classified as local, upvalue and global variables. Anyone who has used Lua a lot should be familiar with it, as an example:"><meta itemprop="datePublished" content="2022-01-04T12:26:51+08:00" />
<meta itemprop="dateModified" content="2022-01-04T12:26:51+08:00" />
<meta itemprop="wordCount" content="1726">
<meta itemprop="keywords" content="lua," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Why there are no more global variables in Lua 5.3"/>
<meta name="twitter:description" content="I&rsquo;ve been using Lua 5.1 in the past, and I don&rsquo;t know much about _ENV in Lua 5.3. Recently, I used Lua 5.3 in a new project, so I looked into it. This article summarizes the meaning of the environment and global variables in Lua 5.3, _ENV and their usage.
Types of Lua variables Lua variables can be classified as local, upvalue and global variables. Anyone who has used Lua a lot should be familiar with it, as an example:"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Why there are no more global variables in Lua 5.3</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-04 12:26:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1726 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#types-of-lua-variables">Types of Lua variables</a></li>
        <li><a href="#local-variables-and-up-values">Local variables and up values</a></li>
        <li><a href="#global-variables">Global variables</a></li>
        <li><a href="#_g-what-about-me">_G: What about me?</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I&rsquo;ve been using Lua 5.1 in the past, and I don&rsquo;t know much about <code>_ENV</code> in Lua 5.3. Recently, I used Lua 5.3 in a new project, so I looked into it. This article summarizes the meaning of the environment and global variables in Lua 5.3, <code>_ENV</code> and their usage.</p>
<h2 id="types-of-lua-variables">Types of Lua variables</h2>
<p>Lua variables can be classified as local, upvalue and global variables. Anyone who has used Lua a lot should be familiar with it, as an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">up</span> <span class="o">=</span> <span class="s2">&#34;str&#34;</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">print</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>For the function <code>foo</code>, <code>a</code> and <code>b</code> are local variables, <code>up</code> is an upper value, and <code>print</code> is a global variable.</p>
<h2 id="local-variables-and-up-values">Local variables and up values</h2>
<p>What a variable is is determined at compile time: from the current function upwards, variables that can be found in the current function are local variables, those found in higher-level functions are up values, and those that cannot be found are global variables. Here is Lua&rsquo;s code for finding variables:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm">  Find variable with given name &#39;n&#39;. If it is an upvalue, add this
</span><span class="cm">  upvalue into all intermediate functions.
</span><span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">singlevaraux</span> <span class="p">(</span><span class="n">FuncState</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span> <span class="n">TString</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">expdesc</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="cm">/* no more levels? */</span>
    <span class="n">init_exp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VVOID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* default is global */</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">searchvar</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>  <span class="cm">/* look up locals at current level */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* found? */</span>
      <span class="n">init_exp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VLOCAL</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>  <span class="cm">/* variable is local */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>
        <span class="n">markupval</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>  <span class="cm">/* local will be used as an upval */</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* not found as local at current level; try upvalues */</span>
      <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">searchupvalue</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>  <span class="cm">/* try existing upvalues */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* not found? */</span>
        <span class="n">singlevaraux</span><span class="p">(</span><span class="n">fs</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* try upper levels */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">==</span> <span class="n">VVOID</span><span class="p">)</span>  <span class="cm">/* not found? */</span>
          <span class="k">return</span><span class="p">;</span>  <span class="cm">/* it is a global */</span>
        <span class="cm">/* else was LOCAL or UPVAL */</span>
        <span class="n">idx</span>  <span class="o">=</span> <span class="n">newupvalue</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>  <span class="cm">/* will be a new upvalue */</span>
      <span class="p">}</span>
      <span class="n">init_exp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VUPVAL</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>  <span class="cm">/* new or old upvalue */</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This code is located in <code>lparser.c</code> , which is part of the Lua compiler. The comments that come with it are very detailed. First line 9 looks in the local variables of the current function, if it finds one, it sets it to a local variable and stores its index (the first local variable), otherwise it tries to find the upper value. Each upper value found is stored at compile time, including the index of each upper value, its name, whether it is on the stack (i.e., whether it is a local variable of a higher-level function), etc. When searching for an upper value, first line 16 looks for it among the existing upper values, and if it finds it, line 24 sets it to an upper value and returns it; otherwise, line 18 recursively calls <code>singlevaraux</code> to the upper function. If it is found, there are two results: one is that it is a local variable of the higher-level function, which tells us how many local variables it is (the local variable index); the other is that it is the upper value of the higher-level function, which tells us how many upper values it is (the upper value index). This index is then stored at line 22, and identifies whether it is a local variable (on the stack) or an upper value (not on the stack) of the higher-level function. Finally, if the recursion runs to line 7, which means that all functions nested in the current function do not find this variable, it is considered a global variable and is returned directly at line 20.</p>
<p>At runtime, for local variables, the value of the variable is obtained directly from the index; for upper values, if it is on the stack, the value of the variable is obtained from the local variable of the higher-level function by indexing, otherwise the value of the variable is obtained from the upper value of the higher-level function by indexing. In other words, Lua numbers local variables and upper values at compile time, and gets the variable by number at runtime, without caring about the variable name. (So stop saying that shorter variable names are more efficient)</p>
<h2 id="global-variables">Global variables</h2>
<p>So what does Lua do with global variables that cannot be found in local variables and upper values? This is where it gets really interesting. Let&rsquo;s look at the caller of <code>singlevaraux</code>, <code>singlevar</code> . Lua calls it for every variable it encounters when compiling:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">singlevar</span> <span class="p">(</span><span class="n">LexState</span> <span class="o">*</span><span class="n">ls</span><span class="p">,</span> <span class="n">expdesc</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">TString</span> <span class="o">*</span><span class="n">varname</span> <span class="o">=</span> <span class="n">str_checkname</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>
  <span class="n">FuncState</span> <span class="o">*</span><span class="n">fs</span> <span class="o">=</span> <span class="n">ls</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">;</span>
  <span class="n">singlevaraux</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">==</span> <span class="n">VVOID</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* global name? */</span>
    <span class="n">expdesc</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">singlevaraux</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ls</span><span class="o">-&gt;</span><span class="n">envn</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* get environment variable */</span>
    <span class="n">lua_assert</span><span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">!=</span> <span class="n">VVOID</span><span class="p">);</span>  <span class="cm">/* this one must exist */</span>
    <span class="n">codestring</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">varname</span><span class="p">);</span>  <span class="cm">/* key is variable name */</span>
    <span class="n">luaK_indexed</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>  <span class="cm">/* env[varname] */</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>First <code>singlevar</code> calls <code>singlevaraux</code> to find the variable, and if it doesn&rsquo;t find it, it starts processing the global variable on line 6. Here it first calls <code>singlevaraux</code> and passes in <code>ls-&gt;envn</code> . A quick look at the code shows that the value of <code>ls-&gt;envn</code> is <code>&quot;_ENV&quot;</code>, which means it is looking for a variable named <code>_ENV</code>. Then on line 9 it stores the variable name as a string in the constants section, and on line 10 it generates a table lookup instruction that looks for the value of the variable <code>_ENV</code> whose key is the variable name.</p>
<p>This means that for each global variable <code>var</code>, Lua treats it as <code>_ENV.var</code>. So where does this <code>_ENV</code> variable come from if we don&rsquo;t define it manually? We can find out where it is set:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* lparser.c */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mainfunc</span> <span class="p">(</span><span class="n">LexState</span> <span class="o">*</span><span class="n">ls</span><span class="p">,</span> <span class="n">FuncState</span> <span class="o">*</span><span class="n">fs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">BlockCnt</span> <span class="n">bl</span><span class="p">;</span>
  <span class="n">expdesc</span> <span class="n">v</span><span class="p">;</span>
  <span class="n">open_func</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bl</span><span class="p">);</span>
  <span class="n">fs</span><span class="o">-&gt;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">is_vararg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* main function is always declared vararg */</span>
  <span class="n">init_exp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="n">VLOCAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* create and... */</span>
  <span class="n">newupvalue</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">ls</span><span class="o">-&gt;</span><span class="n">envn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>  <span class="cm">/* ...set environment upvalue */</span>
  <span class="n">luaX_next</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>  <span class="cm">/* read first token */</span>
  <span class="n">statlist</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>  <span class="cm">/* parse main body */</span>
  <span class="n">check</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">TK_EOS</span><span class="p">);</span>
  <span class="n">close_func</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* lapi.c */</span>
<span class="n">LUA_API</span> <span class="kt">int</span> <span class="nf">lua_load</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_Reader</span> <span class="n">reader</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chunkname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ZIO</span> <span class="n">z</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
  <span class="n">lua_lock</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunkname</span><span class="p">)</span> <span class="n">chunkname</span> <span class="o">=</span> <span class="s">&#34;?&#34;</span><span class="p">;</span>
  <span class="n">luaZ_init</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">luaD_protectedparser</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="n">chunkname</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">LUA_OK</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* no errors? */</span>
    <span class="n">LClosure</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">clLvalue</span><span class="p">(</span><span class="n">L</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* get newly created function */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">nupvalues</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* does it have an upvalue? */</span>
      <span class="cm">/* get global table from registry */</span>
      <span class="n">Table</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">hvalue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">G</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l_registry</span><span class="p">);</span>
      <span class="k">const</span> <span class="n">TValue</span> <span class="o">*</span><span class="n">gt</span> <span class="o">=</span> <span class="n">luaH_getint</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LUA_RIDX_GLOBALS</span><span class="p">);</span>
      <span class="cm">/* set global table as 1st upvalue of &#39;f&#39; (may be LUA_ENV) */</span>
      <span class="n">setobj</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">upvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">,</span> <span class="n">gt</span><span class="p">);</span>
      <span class="n">luaC_upvalbarrier</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">upvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">lua_unlock</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When calling methods like <code>load</code>, <code>loadfile</code> or <code>dofile</code>, it calls <code>lua_load</code>, which loads the code and compiles it. First call <code>luaD_protectedparser</code> on line 23 to compile the code, which will call <code>mainfunc</code> to compile the main function (or chunk). Notice that on line 8, it sets an upper value variable named <code>_ENV</code> to the main function. Then on line 31, it sets the global table to the first and only upper value of the main function, namely <code>_ENV</code>. This global table is created when the Lua virtual machine is initialized and contains various standard library functions.</p>
<p>This means that when we access a global variable, we are actually accessing the key value in the upper value <code>_ENV</code>; since nested functions inherit the upper value from their parent functions, this makes all functions access the same <code>_ENV</code> variable, which looks like they share the same global variable. The following code is an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">foo</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">(</span><span class="kr">function</span><span class="p">()</span>
      <span class="n">b</span> <span class="o">=</span> <span class="s2">&#34;str&#34;</span>
    <span class="kr">end</span><span class="p">)()</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="kr">function</span> <span class="nf">bar</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">_ENV</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">3.14</span>
    <span class="p">(</span><span class="kr">function</span><span class="p">()</span>
      <span class="n">d</span> <span class="o">=</span> <span class="s2">&#34;str&#34;</span>
    <span class="kr">end</span><span class="p">)()</span>
<span class="kr">end</span>

<span class="n">foo</span><span class="p">()</span>
<span class="n">bar</span><span class="p">()</span>

<span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="c1">-- 1 str nil nil</span>
</code></pre></td></tr></table>
</div>
</div><p>For the <code>foo</code> function, what it actually does on line 2 is <code>_ENV.a = 1</code>. Here <code>_ENV</code> inherits from the upper value of the main function, so it prints <code>a</code> as 1 at the end. The same is true for <code>b</code>. But for the function <code>bar</code>, when it reaches lines 10 and 12, it actually sets the key value for the local variable it defined in line 9, so it doesn&rsquo;t print it at the end.</p>
<h2 id="_g-what-about-me">_G: What about me?</h2>
<p>Since a global variable in Lua 5.3 is actually a key in <code>_ENV</code>, what is <code>_G</code>? In fact, <code>_G</code> is a key in <code>_ENV</code> whose value points to <code>_ENV</code> itself. That is, there is <code>_ENV._G = _ENV</code> . This is done purely for compatibility with the old way of writing <code>_G</code>, which has lost its meaning. It doesn&rsquo;t matter if you execute <code>_G = nil</code>, as long as you don&rsquo;t access <code>_G</code> manually, it won&rsquo;t have any effect.</p>
<p>BTW, LuaJIT users used to write <code>local _G = _G</code> in the file header and explicitly specify <code>_G.var</code> when using global variables, because it&rsquo;s faster. In Lua 5.3, this doesn&rsquo;t make any sense. And it&rsquo;s even slower if you forget to add <code>local _G = _G</code> to the file header, because it&rsquo;s like <code>_ENV._G.var</code> with an extra table lookup.</p>
<h2 id="summary">Summary</h2>
<p>Lua 5.3 defines a non-local, non-supervalued variable <code>var</code> as <code>_ENV.var</code>; and sets an initial supernumerary <code>_ENV</code> for the main function that is equivalent to a table. Nothing else is done to achieve the effect of a global variable. So we can say that the global variables in Lua 5.3 are really just syntactic sugar. This is a beautiful, clean design. Lua is a language that implements Less is batter than more; its source code is a treasure trove for everyone to learn from.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/lua/">lua</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/dht-and-p2p/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Distributed Hash Table (DHT) and P2P technologies</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/gzip-and-deflate/">
            <span class="next-text nav-default">Gzip format and DEFLATE compression algorithm</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
