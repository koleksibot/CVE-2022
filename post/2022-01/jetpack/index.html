<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Shortcomings of the Jetpack-LiveData component and strategies for dealing with them - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Preface In order to solve the problem of confusing architecture design that has existed since Android-App development, Google has launched the Jetpack-MVVM series of solutions. As the core of the whole solution - LiveData, with its lifecycle security, memory security and other advantages, and even gradually replace EventBus, RxJava as the trend of Android side state distribution components. The mall app team has encountered some difficulties in the process of" /><meta name="keywords" content="android, Jetpack" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/jetpack/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Shortcomings of the Jetpack-LiveData component and strategies for dealing with them" />
<meta property="og:description" content="Preface In order to solve the problem of confusing architecture design that has existed since Android-App development, Google has launched the Jetpack-MVVM series of solutions. As the core of the whole solution - LiveData, with its lifecycle security, memory security and other advantages, and even gradually replace EventBus, RxJava as the trend of Android side state distribution components. The mall app team has encountered some difficulties in the process of" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/jetpack/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-19T15:55:46+08:00" />
<meta property="article:modified_time" content="2022-01-19T15:55:46+08:00" />

<meta itemprop="name" content="Shortcomings of the Jetpack-LiveData component and strategies for dealing with them">
<meta itemprop="description" content="Preface In order to solve the problem of confusing architecture design that has existed since Android-App development, Google has launched the Jetpack-MVVM series of solutions. As the core of the whole solution - LiveData, with its lifecycle security, memory security and other advantages, and even gradually replace EventBus, RxJava as the trend of Android side state distribution components. The mall app team has encountered some difficulties in the process of"><meta itemprop="datePublished" content="2022-01-19T15:55:46+08:00" />
<meta itemprop="dateModified" content="2022-01-19T15:55:46+08:00" />
<meta itemprop="wordCount" content="3544">
<meta itemprop="keywords" content="android," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Shortcomings of the Jetpack-LiveData component and strategies for dealing with them"/>
<meta name="twitter:description" content="Preface In order to solve the problem of confusing architecture design that has existed since Android-App development, Google has launched the Jetpack-MVVM series of solutions. As the core of the whole solution - LiveData, with its lifecycle security, memory security and other advantages, and even gradually replace EventBus, RxJava as the trend of Android side state distribution components. The mall app team has encountered some difficulties in the process of"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Shortcomings of the Jetpack-LiveData component and strategies for dealing with them</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-19 15:55:46 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3544 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preface">Preface</a></li>
        <li><a href="#how-many-callbacks-can-the-observer-actually-receive">How many callbacks can the Observer actually receive</a>
          <ul>
            <li><a href="#why-do-we-receive-at-most-2-notifications">Why do we receive at most 2 notifications</a></li>
            <li><a href="#strange-compilation-optimizations">Strange compilation optimizations</a></li>
            <li><a href="#does-kotlins-lambda-writing-style-have-pitfalls">Does Kotlin&rsquo;s lambda writing style have pitfalls?</a></li>
            <li><a href="#why-livedata-receives-messages-before-observe">Why LiveData receives messages before Observe</a></li>
            <li><a href="#analyze-the-source-code-to-find-the-reason">Analyze the source code to find the reason</a></li>
            <li><a href="#be-careful-with-activityviewmodels">Be careful with ActivityViewModels</a></li>
            <li><a href="#solution-one-introducing-an-intermediate-layer">Solution One: Introducing an Intermediate Layer</a></li>
            <li><a href="#solution-2-hook-livedatas-observe-method">Solution 2: Hook LiveData&rsquo;s observe method</a></li>
            <li><a href="#solution-3-use-kotlin-flow">Solution 3: Use Kotlin-Flow</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="preface">Preface</h2>
<p>In order to solve the problem of confusing architecture design that has existed since Android-App development, Google has launched the Jetpack-MVVM series of solutions. As the core of the whole solution - LiveData, with its lifecycle security, memory security and other advantages, and even gradually replace EventBus, RxJava as the trend of Android side state distribution components.</p>
<p>The mall app team has encountered some difficulties in the process of using LiveData in depth, especially in the use of LiveData observers encountered a lot of pitfalls, we put these experiences here to do a summary and share.</p>
<h2 id="how-many-callbacks-can-the-observer-actually-receive">How many callbacks can the Observer actually receive</h2>
<h3 id="why-do-we-receive-at-most-2-notifications">Why do we receive at most 2 notifications</h3>
<p>This is a typical case, when debugging a message bus scenario, we usually print some log logs at the receiver of the message to help us locate the problem, however the log printing can sometimes bring some confusion to our problem location, you can see the following example.</p>
<p>We start by defining a minimalist ViewModel:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestViewModel</span> <span class="kd">extends</span> <span class="n">ViewModel</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentName</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getCurrentName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">currentName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">currentName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then look at our activity code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaTestLiveDataActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="n">TestViewModel</span> <span class="n">model</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="n">String</span> <span class="n">test</span><span class="o">=</span><span class="s">&#34;12345&#34;</span><span class="o">;</span>
 
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_java_test_live_data</span><span class="o">);</span>
        <span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewModelProvider</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">TestViewModel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">test3</span><span class="o">();</span>       
        <span class="n">model</span><span class="o">.</span><span class="na">getCurrentName</span><span class="o">().</span><span class="na">setValue</span><span class="o">(</span><span class="s">&#34;3&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">getCurrentName</span><span class="o">().</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">Observer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ttt&#34;</span><span class="o">,</span> <span class="s">&#34;s:&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Can you think of what the result of this program run would be? We create a Livedata and then Observe this Livedata 10 times, each time new a different Observer object, and it looks like we have made 10 Observer bindings to a data source. When we modify this data source, we should have 10 notifications. Run it and see the result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">2021-11-21 15:20:07.662 27500-27500/com.smart.myapplication V/ttt: s:3
2021-11-21 15:20:07.662 27500-27500/com.smart.myapplication V/ttt: s:3
</code></pre></td></tr></table>
</div>
</div><p>Strange, why do I only get 2 callback notifications when I&rsquo;ve obviously registered 10 observers? Try a different way of writing it?</p>
<p>Let&rsquo;s add a part to the Log code like printing the hashCode and look at the result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:217112568
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:144514257
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:72557366
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:233087543
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:22021028
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:84260109
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:94780610
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:240593619
2021-11-21 15:22:59.377 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:207336976
2021-11-21 15:22:59.378 27912-27912/com.smart.myapplication V/ttt: s:3  hashCode:82154761
</code></pre></td></tr></table>
</div>
</div><p>This time the result is normal, in fact for many message bus debugging there are similar problems.</p>
<p>In fact, for the Log system, if he determines that the timestamp is the same, and the content of the Log behind it is also the same, then he will not print the content repeatedly. It is important to pay attention to this detail here, otherwise in many cases, it will affect our judgement of the problem. If we go back to the code where we did not add the hashCode, we will understand it if we look more closely: only the Log prints two items, but the notification is received 10 times, so why print two items? Because your timestamp is the same and the subsequent content is the same.</p>
<h3 id="strange-compilation-optimizations">Strange compilation optimizations</h3>
<p>It doesn&rsquo;t end here, look at the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/7a53e39e2a6249ce9c1aa240ab48d534.png" alt="sobyte"></p>
<p>The above code will be greyed out in android studio, I believe many people with code cleanliness will know why, this is the lambda of Java8, ide automatically gives us a hint to let us optimize the writing method, and a mouse click will automatically optimize it, very convenient.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/1dceb877460a4bf0b83b3eac423176ea.png" alt="sobyte"></p>
<p>The grey is gone, the code is cleaner, try running it</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">2021-11-21 15:31:50.386 29136-29136/com.smart.myapplication V/ttt: s:3
</code></pre></td></tr></table>
</div>
</div><p>Strange, why is there only one log this time? Is it still the Log logging system? I&rsquo;ll try adding a timestamp then</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/9f5e2f0ebb534ff792deff3e5c5844f1.png" alt="sobyte"></p>
<p>Look again at the execution results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">2021-11-21 15:34:33.559 29509-29509/com.smart.myapplication V/ttt: s:3 time:1637480073559
</code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ve added the observer 10 times in the for loop here. Is the lambda causing the problem? Well, let&rsquo;s type out the number of Observers and see what&rsquo;s wrong. Look at the source code, as shown below: our observers are actually stored inside this map, we can find out the reason by taking out the size of this map.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/e1cce2c0c8054a6d89126eb5c6974af3.png" alt="sobyte"></p>
<p>Reflect to read this size, note that the LiveData we normally use is MutableLiveData and this value is in the LiveData, so it is getSuperclass().</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">hook</span><span class="o">(</span><span class="n">LiveData</span> <span class="n">liveData</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
       <span class="n">Field</span> <span class="n">map</span> <span class="o">=</span> <span class="n">liveData</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mObservers&#34;</span><span class="o">);</span>
       <span class="n">map</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
       <span class="n">SafeIterableMap</span> <span class="n">safeIterableMap</span> <span class="o">=</span> <span class="o">(</span><span class="n">SafeIterableMap</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">liveData</span><span class="o">);</span>
       <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ttt&#34;</span><span class="o">,</span> <span class="s">&#34;safeIterableMap size:&#34;</span> <span class="o">+</span> <span class="n">safeIterableMap</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
   <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Look again at the execution results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">2021-11-21 15:40:37.010 30043-30043/com.smart.myapplication V/ttt: safeIterableMap size:1
2021-11-21 15:40:37.013 30043-30043/com.smart.myapplication V/ttt: s:3 time:1637480437013
</code></pre></td></tr></table>
</div>
</div><p>Sure enough, the map size here is 1, not 10, so I must have received only 1 notification. So the question is, I&rsquo;ve obviously added 10 observers to the for loop, why did I change to lambda and have 1 observer? Let&rsquo;s decompile (using jadx to decompile our debug app directly) and see.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">getCurrentName</span><span class="o">().</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">$$Lambda$JavaTestLiveDataActivity$zcrCJYfWItRTy4AC_xWfANwZkzE</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">public</span> <span class="kd">final</span> <span class="cm">/* synthetic */</span> <span class="kd">class</span> <span class="nc">$$Lambda$JavaTestLiveDataActivity$zcrCJYfWItRTy4AC_xWfANwZkzE</span> <span class="kd">implements</span> <span class="n">Observer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="cm">/* synthetic */</span> <span class="n">$$Lambda$JavaTestLiveDataActivity$zcrCJYfWItRTy4AC_xWfANwZkzE</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">$$Lambda$JavaTestLiveDataActivity$zcrCJYfWItRTy4AC_xWfANwZkzE</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="cm">/* synthetic */</span> <span class="n">$$Lambda$JavaTestLiveDataActivity$zcrCJYfWItRTy4AC_xWfANwZkzE</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ttt&#34;</span><span class="o">,</span> <span class="s">&#34;s:&#34;</span> <span class="o">+</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">obj</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It is clear to see that the compiler has been clever in the compilation process because of the use of Java8 lambda, so the compiler automatically helps us to optimise Chengdu to add the same static observer, not 10, which explains why the map size is 1. We can remove the lambda again and see if the decompilation works.</p>
<p>One last question: does this lambda optimisation work regardless of the scenario? Let&rsquo;s try a different way of writing</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">String</span> <span class="n">outer</span> <span class="o">=</span> <span class="s">&#34;123456&#34;</span><span class="o">;</span>
 
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
   <span class="n">model</span><span class="o">.</span><span class="na">getCurrentName</span><span class="o">().</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ttt&#34;</span><span class="o">,</span> <span class="s">&#34;s:&#34;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">outer</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that although we also use lambda in this way, we have introduced external variables, which are different from the previous lambda, and look at the result of decompiling this way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">getCurrentName</span><span class="o">().</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">Observer</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">JavaTestLiveDataActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">lambda$test33$0$JavaTestLiveDataActivity</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s reassuring to see the new keyword, and this way of writing gets around the Java8 lambda compilation optimizations.</p>
<h3 id="does-kotlins-lambda-writing-style-have-pitfalls">Does Kotlin&rsquo;s lambda writing style have pitfalls?</h3>
<p>Considering that most people use Kotlin nowadays, let&rsquo;s try to see if Kotlin&rsquo;s lambda writing style has the same pitfalls as Java8&rsquo;s lambda.</p>
<p>Take a look at the way lambda is written in Kotlin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="nf">test2</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">val</span> <span class="py">liveData</span> <span class="p">=</span> <span class="n">MutableLiveData</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">0.</span><span class="p">.</span><span class="m">9</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">liveData</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
              <span class="p">{</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span> <span class="s2">&#34;t:</span><span class="si">$t</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">})</span>
      <span class="p">}</span>
      <span class="n">liveData</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="m">3</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Look again at the results of the decompilation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">MutableLiveData</span> <span class="n">liveData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableLiveData</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">i</span><span class="o">++;</span>
            <span class="n">liveData</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">$$Lambda$KotlinTest$6ZY8yysFE1G_4okj2E0STUBMfmc</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">9</span><span class="o">);</span>
        <span class="n">liveData</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
    <span class="o">}</span>
 
<span class="kd">public</span> <span class="kd">final</span> <span class="cm">/* synthetic */</span> <span class="kd">class</span> <span class="nc">$$Lambda$KotlinTest$6ZY8yysFE1G_4okj2E0STUBMfmc</span> <span class="kd">implements</span> <span class="n">Observer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="cm">/* synthetic */</span> <span class="n">$$Lambda$KotlinTest$6ZY8yysFE1G_4okj2E0STUBMfmc</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">$$Lambda$KotlinTest$6ZY8yysFE1G_4okj2E0STUBMfmc</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="cm">/* synthetic */</span> <span class="n">$$Lambda$KotlinTest$6ZY8yysFE1G_4okj2E0STUBMfmc</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">KotlinTest</span><span class="o">.</span><span class="na">m1490test2$lambda3</span><span class="o">((</span><span class="n">Integer</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It seems that Kotlin&rsquo;s lambda compilation is just as aggressive as Java8&rsquo;s lambda compilation, in that it takes the for loop and optimises it to an object by default. Likewise, let&rsquo;s see if there&rsquo;s any more &ldquo;negative optimisation&rdquo; by having the lambda access external variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">val</span> <span class="n">test</span><span class="o">=</span><span class="s">&#34;12345&#34;</span>
<span class="n">fun</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">liveData</span> <span class="o">=</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">Int</span><span class="o">&gt;()</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="n">in</span> <span class="n">0</span><span class="o">..</span><span class="na">9</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">liveData</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
            <span class="o">{</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&#34;ttt&#34;</span><span class="o">,</span> <span class="s">&#34;t:$t $test&#34;</span><span class="o">)</span> <span class="o">})</span>
    <span class="o">}</span>
    <span class="n">liveData</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">3</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>See the result of the decompilation</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">MutableLiveData</span> <span class="n">liveData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableLiveData</span><span class="o">();</span>
       <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
       <span class="k">do</span> <span class="o">{</span>
           <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
           <span class="n">i</span><span class="o">++;</span>
           <span class="n">liveData</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">Observer</span><span class="o">()</span> <span class="o">{</span>
               <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">onChanged</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">KotlinTest</span><span class="o">.</span><span class="na">m1490test2$lambda3</span><span class="o">(</span><span class="n">KotlinTest</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
               <span class="o">}</span>
           <span class="o">});</span>
       <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">9</span><span class="o">);</span>
       <span class="n">liveData</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
   <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Everything is working fine. Finally, let&rsquo;s look at the non-lambda writing of ordinary Kotlin. Is it the same as the non-lambda writing of Java?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="nf">test1</span><span class="p">()</span> <span class="p">{</span>
       <span class="k">val</span> <span class="py">liveData</span> <span class="p">=</span> <span class="n">MutableLiveData</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">0.</span><span class="p">.</span><span class="m">9</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">liveData</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">object</span> <span class="err">: </span><span class="nc">Observer</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">{</span>
               <span class="k">override</span> <span class="k">fun</span> <span class="nf">onChanged</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Int</span><span class="p">?)</span> <span class="p">{</span>
                   <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span> <span class="s2">&#34;t:</span><span class="si">$t</span><span class="s2">&#34;</span><span class="p">)</span>
               <span class="p">}</span>
           <span class="p">})</span>
       <span class="p">}</span>
       <span class="n">liveData</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="m">3</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>See the result of the decompilation</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">test11</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">MutableLiveData</span> <span class="n">liveData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableLiveData</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">i</span><span class="o">++;</span>
            <span class="n">liveData</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">KotlinTest$test11$1</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">9</span><span class="o">);</span>
        <span class="n">liveData</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Everything is fine, and here we can draw a conclusion.</p>
<blockquote>
<p>For scenarios where a lambda is used in the middle of a for loop, when no external variables or functions are used in your lambda, then either the Java8 compiler or the Kotlin compiler will by default optimize it for you to use the same lambda.</p>
<p>The compiler&rsquo;s starting point is a good one, and newing different objects in a for loop will of course lead to some degree of performance degradation (after all, what&rsquo;s new ends up in gc), but such optimizations may often not meet our expectations, and may even cause us to misjudge in certain scenarios, so be careful when using them.</p>
</blockquote>
<h3 id="why-livedata-receives-messages-before-observe">Why LiveData receives messages before Observe</h3>
<h3 id="analyze-the-source-code-to-find-the-reason">Analyze the source code to find the reason</h3>
<p>Let&rsquo;s look at an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-kt" data-lang="kt"><span class="k">fun</span> <span class="nf">test1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">liveData</span> <span class="p">=</span> <span class="n">MutableLiveData</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span><span class="s2">&#34;set live data value&#34;</span><span class="p">)</span>
        <span class="n">liveData</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="m">3</span>
        <span class="n">Thread</span><span class="p">{</span>
            <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span><span class="s2">&#34;wait start&#34;</span><span class="p">)</span>
            <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">3000</span><span class="p">)</span>
            <span class="n">runOnUiThread</span> <span class="p">{</span>
                <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span><span class="s2">&#34;wait end start observe&#34;</span><span class="p">)</span>
                <span class="n">liveData</span><span class="p">.</span><span class="n">observe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
                    <span class="p">{</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="s2">&#34;ttt&#34;</span><span class="p">,</span> <span class="s2">&#34;t:</span><span class="si">$t</span><span class="s2">&#34;</span><span class="p">)</span> <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}.</span><span class="n">start</span><span class="p">()</span>
 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>What this code means is that I update a livedata to a value of 3, and then 3s later I livedata register an observer. Note here that I updated the livedata value first and then registered the observer some time later, so in theory I should not have received the livedata message at this point. Because you sent the message first and I observed it later. But the result of the program execution is :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2021-11-21 16:27:22.306 32275-32275/com.smart.myapplication V/ttt: set live data value
2021-11-21 16:27:22.306 32275-32388/com.smart.myapplication V/ttt: wait start
2021-11-21 16:27:25.311 32275-32275/com.smart.myapplication V/ttt: wait end start observe
2021-11-21 16:27:25.313 32275-32275/com.smart.myapplication V/ttt: t:3
</code></pre></td></tr></table>
</div>
</div><p>This one is just plain weird and doesn&rsquo;t fit the design of a message bus framework that we commonly see. Let&rsquo;s take a look at the source code to see what&rsquo;s really going on.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/e492826c3eed4cfd8b207c4e627728d8.png" alt="sobyte"></p>
<p>Each time we observe we create a wrapper, see what this wrapper does.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/23cc41dbb1f846a0923274e5d54c72bd.png" alt="sobyte"></p>
<p>Note that this wrapper has an onStateChanged method, which is the core of the whole event distribution, so let&rsquo;s remember this entry for now. Going back to our previous observe method, the last line is a call to the addObserver method, let&rsquo;s see what is done in this method.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/363ce77341184a94a979cc73d42adf6a.png" alt="sobyte"></p>
<p>Eventually the flow will go to this dispatchEvent method and continue to follow.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/b1d31c58909442939924bd87e79c4aab.png" alt="sobyte"></p>
<p>The mLifeCycleObserver is in fact the LifecycleBoundObserver object we created in the observe method at the beginning, which is the variable of the wrapper. The onStateChanged method will eventually go through a series of calls to the considerNotify method as shown in the diagram below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/8dc3849029cb4ec59766958bdbfec923.png" alt="sobyte"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/726a3c1b1828422ca7485afcb0ca79f7.png" alt="sobyte"></p>
<p>And the whole considerNotify method has only one effect.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/2e789d8a4fdc4b4f841adb1a7f42aac2.png" alt="sobyte"></p>
<p>If the value of mLastVersion is &lt; mVersion, then the onchaged method of the observer will be triggered, which means that it will call back to our observer method.</p>
<p>Let&rsquo;s see how these two values change. First look at this mVersion.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/eb2943d607b04618ba3ea761e2bf5281.png" alt="sobyte"></p>
<p>You can see that this value defaults to start_version, which is -1, but it is added by 1 each time the value is set.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/62a3be9c38bd42aa8be08187fa2a35f6.png" alt="sobyte"></p>
<p>The initial value of mLastVersion in our observer is -1.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/54293196f858452e951b8bf000923219.png" alt="sobyte"></p>
<p>To conclude.</p>
<ul>
<li>The initial value of Livedata&rsquo;s mVersion is -1.</li>
<li>After one setValue, her value becomes 0.</li>
<li>An ObserverWrapper is created each time you observe.</li>
<li>The Wrapper has a mLastVersion inside which is -1. Observe function calls will eventually go through a series of processes to the considerNotify method.</li>
<li>0 is obviously greater than the observer&rsquo;s mLastVersion-1, so the observer&rsquo;s listener function will definitely be triggered at this point.</li>
</ul>
<h3 id="be-careful-with-activityviewmodels">Be careful with ActivityViewModels</h3>
<p>This feature of Livedata can have disastrous consequences in certain scenarios, for example, in a single Activity with multiple Fragments, it is very inconvenient to synchronize the Activity-Fragment without the Jetpack-mvvm component, but with the Jetpack-mvvm component, it is very easy to implement this mechanism. But with the Jetpack-mvvm component, it is very easy to implement this mechanism. Here is an example from the website.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">SharedViewModel</span> <span class="o">:</span> <span class="n">ViewModel</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">selected</span> <span class="o">=</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;()</span>
 
    <span class="n">fun</span> <span class="nf">select</span><span class="o">(</span><span class="n">item</span><span class="o">:</span> <span class="n">Item</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">selected</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">item</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">MasterFragment</span> <span class="o">:</span> <span class="n">Fragment</span><span class="o">()</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="n">lateinit</span> <span class="n">var</span> <span class="n">itemSelector</span><span class="o">:</span> <span class="n">Selector</span>
 
   
    <span class="kd">private</span> <span class="n">val</span> <span class="n">model</span><span class="o">:</span> <span class="n">SharedViewModel</span> <span class="n">by</span> <span class="nf">activityViewModels</span><span class="o">()</span>
 
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">:</span> <span class="n">View</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">)</span>
        <span class="n">itemSelector</span><span class="o">.</span><span class="na">setOnClickListener</span> <span class="o">{</span> <span class="n">item</span> <span class="o">-&gt;</span>
            <span class="c1">// Update the UI
</span><span class="c1"></span>        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">DetailFragment</span> <span class="o">:</span> <span class="n">Fragment</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">val</span> <span class="n">model</span><span class="o">:</span> <span class="n">SharedViewModel</span> <span class="n">by</span> <span class="nf">activityViewModels</span><span class="o">()</span>
 
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">:</span> <span class="n">View</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">)</span>
        <span class="n">model</span><span class="o">.</span><span class="na">selected</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">viewLifecycleOwner</span><span class="o">,</span> <span class="n">Observer</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="o">{</span> <span class="n">item</span> <span class="o">-&gt;</span>
            <span class="c1">// Update the UI
</span><span class="c1"></span>        <span class="o">})</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Just make the set of ActivityViewModel shared between the 2 fragments. It&rsquo;s easy to use, but in some scenarios it can lead to some serious problems. Let&rsquo;s take a look at this scenario, we have an activity that shows the ListFragment by default, after clicking on the ListFragment we will jump to the DetailFragment.</p>
<p>Take a look at the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ListViewModel</span> <span class="o">:</span> <span class="n">ViewModel</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">val</span> <span class="n">_navigateToDetails</span> <span class="o">=</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;()</span>
 
    <span class="n">val</span> <span class="n">navigateToDetails</span> <span class="o">:</span> <span class="n">LiveData</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span>
        <span class="nf">get</span><span class="o">()</span> <span class="o">=</span> <span class="n">_navigateToDetails</span>
 
    <span class="n">fun</span> <span class="nf">userClicksOnButton</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">_navigateToDetails</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>A further look at the core ListFragment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ListFragment</span> <span class="o">:</span> <span class="n">Fragment</span><span class="o">()</span> <span class="o">{</span>
     
    <span class="kd">private</span> <span class="n">val</span> <span class="n">model</span><span class="o">:</span> <span class="n">ListViewModel</span> <span class="n">by</span> <span class="nf">activityViewModels</span><span class="o">()</span>
 
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">)</span>
         
    <span class="o">}</span>
 
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">:</span> <span class="n">View</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">)</span>
        <span class="n">model</span><span class="o">.</span><span class="na">navigateToDetails</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">viewLifecycleOwner</span><span class="o">,</span> <span class="o">{</span> <span class="n">t</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">parentFragmentManager</span><span class="o">.</span><span class="na">commit</span> <span class="o">{</span>
                    <span class="n">replace</span><span class="o">&lt;</span><span class="n">DetailFragment</span><span class="o">&gt;(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_container_view</span><span class="o">)</span>
                    <span class="n">addToBackStack</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">})</span>
    <span class="o">}</span>
 
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">onCreateView</span><span class="o">(</span>
        <span class="n">inflater</span><span class="o">:</span> <span class="n">LayoutInflater</span><span class="o">,</span> <span class="n">container</span><span class="o">:</span> <span class="n">ViewGroup</span><span class="o">?,</span>
        <span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?</span>
    <span class="o">):</span> <span class="n">View</span><span class="o">?</span> <span class="o">{</span>
        <span class="c1">// Inflate the layout for this fragment
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">fragment_list</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="kc">false</span><span class="o">).</span><span class="na">apply</span> <span class="o">{</span>
            <span class="n">findViewById</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">to_detail</span><span class="o">).</span><span class="na">setOnClickListener</span> <span class="o">{</span>
                <span class="n">model</span><span class="o">.</span><span class="na">userClicksOnButton</span><span class="o">()</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that our implementation mechanism is to click the button after we call the viewModel&rsquo;s userClicksOnButton method to navigateToDetails this livedata value to true, and then listen to this LiveData value, if it is true, then jump to Detail this details fragment.</p>
<p>This process at first glance is no problem, after clicking can indeed jump to the DetailFragment, but when we clicked the return button in the DetailFragment page, the theory will return to the ListFragment, but the actual implementation results are back to the ListFragment immediately after jumping to the DetailFragment.</p>
<p>Why is this? When you press the return button, the onViewCreated of the ListFragment will be executed again, and this time you observe, the value before Livedata is true, so it will trigger the process of jumping to DetailFragment again. The result is that your page never goes back to the list page.</p>
<h3 id="solution-one-introducing-an-intermediate-layer">Solution One: Introducing an Intermediate Layer</h3>
<p>As the old saying goes, all problems in computing can be solved by introducing an intermediate layer. Here too, we can try the idea of &ldquo;a message is only consumed once&rdquo; to solve the above problem. For example, if we wrap the LiveData values in a layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ListViewModel</span> <span class="o">:</span> <span class="n">ViewModel</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">val</span> <span class="n">_navigateToDetails</span> <span class="o">=</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;&gt;()</span>
 
    <span class="n">val</span> <span class="n">navigateToDetails</span> <span class="o">:</span> <span class="n">LiveData</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;&gt;</span>
        <span class="nf">get</span><span class="o">()</span> <span class="o">=</span> <span class="n">_navigateToDetails</span>
 
 
    <span class="n">fun</span> <span class="nf">userClicksOnButton</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">_navigateToDetails</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">Event</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
 
 
<span class="n">open</span> <span class="kd">class</span> <span class="nc">Event</span><span class="o">&lt;</span><span class="n">out</span> <span class="n">T</span><span class="o">&gt;(</span><span class="kd">private</span> <span class="n">val</span> <span class="n">content</span><span class="o">:</span> <span class="n">T</span><span class="o">)</span> <span class="o">{</span>
 
    <span class="n">var</span> <span class="n">hasBeenHandled</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="kd">private</span> <span class="n">set</span> <span class="c1">// 只允许外部读 不允许外部写这个值
</span><span class="c1"></span> 
    <span class="cm">/**
</span><span class="cm">     * 通过这个函数取的value 只能被消费一次
</span><span class="cm">     */</span>
    <span class="n">fun</span> <span class="nf">getContentIfNotHandled</span><span class="o">():</span> <span class="n">T</span><span class="o">?</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="o">(</span><span class="n">hasBeenHandled</span><span class="o">)</span> <span class="o">{</span>
            <span class="kc">null</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">hasBeenHandled</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="n">content</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="cm">/**
</span><span class="cm">     * 如果想消费之前的value 那就直接调用这个方法即可
</span><span class="cm">     */</span>
    <span class="n">fun</span> <span class="nf">peekContent</span><span class="o">():</span> <span class="n">T</span> <span class="o">=</span> <span class="n">content</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This way we can just call the method getContentIfNotHandled() when we do the listening.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">model</span><span class="o">.</span><span class="na">navigateToDetails</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">viewLifecycleOwner</span><span class="o">,</span> <span class="o">{</span> <span class="n">t</span> <span class="o">-&gt;</span>
           <span class="n">t</span><span class="o">.</span><span class="na">getContentIfNotHandled</span><span class="o">()?.</span><span class="na">let</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">it</span><span class="o">){</span>
                   <span class="n">parentFragmentManager</span><span class="o">.</span><span class="na">commit</span> <span class="o">{</span>
                       <span class="n">replace</span><span class="o">&lt;</span><span class="n">DetailFragment</span><span class="o">&gt;(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_container_view</span><span class="o">)</span>
                       <span class="n">addToBackStack</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">)</span>
                   <span class="o">}</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="solution-2-hook-livedatas-observe-method">Solution 2: Hook LiveData&rsquo;s observe method</h3>
<p>We have analyzed the previous article, each time observe, mLastVersion value is less than the value of mVersion is the root of the problem, then we use reflection, each time the observer will be set to the value of mLastVersion and version equal to it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">SmartLiveData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="n">override</span> <span class="n">fun</span> <span class="nf">observe</span><span class="o">(</span><span class="n">owner</span><span class="o">:</span> <span class="n">LifecycleOwner</span><span class="o">,</span> <span class="n">observer</span><span class="o">:</span> <span class="n">Observer</span><span class="o">&lt;</span><span class="n">in</span> <span class="n">T</span><span class="o">&gt;)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">observe</span><span class="o">(</span><span class="n">owner</span><span class="o">,</span> <span class="n">observer</span><span class="o">)</span>
        <span class="c1">//get livedata version
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">livedataVersion</span> <span class="o">=</span> <span class="n">javaClass</span><span class="o">.</span><span class="na">superclass</span><span class="o">.</span><span class="na">superclass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mVersion&#34;</span><span class="o">)</span>
        <span class="n">livedataVersion</span><span class="o">.</span><span class="na">isAccessible</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="c1">// 获取livedata version的值
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">livedataVerionValue</span> <span class="o">=</span> <span class="n">livedataVersion</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="c1">// 取 mObservers Filed
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">mObserversFiled</span> <span class="o">=</span> <span class="n">javaClass</span><span class="o">.</span><span class="na">superclass</span><span class="o">.</span><span class="na">superclass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mObservers&#34;</span><span class="o">)</span>
        <span class="n">mObserversFiled</span><span class="o">.</span><span class="na">isAccessible</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="c1">// 取 mObservers 对象
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">objectObservers</span> <span class="o">=</span> <span class="n">mObserversFiled</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="c1">// 取 mObservers 对象 所属的class SafeIterableMap
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">objectObserversClass</span> <span class="o">=</span> <span class="n">objectObservers</span><span class="o">.</span><span class="na">javaClass</span>
        <span class="n">val</span> <span class="n">methodGet</span> <span class="o">=</span> <span class="n">objectObserversClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;get&#34;</span><span class="o">,</span> <span class="n">Any</span><span class="o">::</span><span class="n">class</span><span class="o">.</span><span class="na">java</span><span class="o">)</span>
        <span class="n">methodGet</span><span class="o">.</span><span class="na">isAccessible</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="c1">//LifecycleBoundObserver
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">objectWrapper</span> <span class="o">=</span> <span class="o">(</span><span class="n">methodGet</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">objectObservers</span><span class="o">,</span> <span class="n">observer</span><span class="o">)</span> <span class="n">as</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;*,</span> <span class="o">*&gt;).</span><span class="na">value</span>
        <span class="c1">//ObserverWrapper
</span><span class="c1"></span>        <span class="n">val</span> <span class="n">mLastVersionField</span> <span class="o">=</span> <span class="n">objectWrapper</span><span class="o">!!.</span><span class="na">javaClass</span><span class="o">.</span><span class="na">superclass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mLastVersion&#34;</span><span class="o">)</span>
        <span class="n">mLastVersionField</span><span class="o">.</span><span class="na">isAccessible</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="c1">//将 mVersion的值 赋值给 mLastVersion 使其相等
</span><span class="c1"></span>        <span class="n">mLastVersionField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">objectWrapper</span><span class="o">,</span> <span class="n">livedataVerionValue</span><span class="o">)</span>
 
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="solution-3-use-kotlin-flow">Solution 3: Use Kotlin-Flow</h3>
<p>If you&rsquo;re still using Kotlin, the solution to this problem is much simpler, and even the process is made more manageable. At this year&rsquo;s Google I/O conference, Yigit made it clear in the Jetpack AMA that Livedata exists to take care of Java users and will continue to be maintained in the short term (what that means is something you can taste for yourself), and that Flow, the replacement for Livedata, will become mainstream in the future (after all, Kotlin is becoming mainstream now). If you use Flow, the above scenario can be solved.</p>
<p>Rewrite the viewModel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ListViewModel</span> <span class="o">:</span> <span class="n">ViewModel</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">_navigateToDetails</span> <span class="o">=</span> <span class="n">MutableSharedFlow</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;()</span>
    <span class="n">fun</span> <span class="nf">userClicksOnButton</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">viewModelScope</span><span class="o">.</span><span class="na">launch</span> <span class="o">{</span>
            <span class="n">_navigateToDetails</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>then just rewrite the way it listens.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">override</span> <span class="n">fun</span> <span class="nf">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">:</span> <span class="n">View</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">:</span> <span class="n">Bundle</span><span class="o">?)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onViewCreated</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">)</span>
        <span class="n">lifecycleScope</span><span class="o">.</span><span class="na">launch</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">_navigateToDetails</span><span class="o">.</span><span class="na">collect</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">parentFragmentManager</span><span class="o">.</span><span class="na">commit</span> <span class="o">{</span>
                        <span class="n">replace</span><span class="o">&lt;</span><span class="n">DetailFragment</span><span class="o">&gt;(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">fragment_container_view</span><span class="o">)</span>
                        <span class="n">addToBackStack</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">)</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We focus on the constructor for SharedFlow, a heat flow.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/19/1063e25e15d84ac6a0a970776c38873f.png" alt="sobyte"></p>
<p>The default value is 0. So our code above will not receive the previous message. Here you can try changing this replay to 1 to reproduce the previous Livedata problem. The only drawback is that Flow does not support Java, only Kotlin.</p>
<h2 id="summary">Summary</h2>
<p>On the whole, even with Kotlin Flow, LiveData is still an indispensable part of the current Android client architecture components, after all, its lifecycle safety and memory safety are too fragrant, which can effectively reduce the burden of our usual business development, and when using him we just need to pay attention to 3 aspects to avoid the pitfalls.</p>
<ul>
<li>Be careful with the lambda smart hints given by Android Studio</li>
<li>Pay more attention to whether you really need Observe to register the message before listening</li>
<li>Be careful when using ActivityViewModel between Activity and Fragment.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/android/">android</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/igor-quit-from-f5/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Igor Sysoev, father of NGINX, departs from F5</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/k8s-hpa-prometheus/">
            <span class="next-text nav-default">Kubernetes HPA Controlled Elastic Scaling based on Prometheus Custom Metrics</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
