<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Analysis of the Go language HTTP standard library - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article looks at how the Go language HTTP standard library is implemented. The HTTP-based service standard model consists of two ends, a client (&amp;lsquo;Client&amp;rsquo;) and a server (&amp;lsquo;Server&amp;rsquo;). HTTP requests are sent from the client, and the server receives the request, processes it and returns the response to the client. So the job of the HTTP server is to accept requests from the client and return a response to" /><meta name="keywords" content="golang, http" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/go-http/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Analysis of the Go language HTTP standard library" />
<meta property="og:description" content="This article looks at how the Go language HTTP standard library is implemented. The HTTP-based service standard model consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, and the server receives the request, processes it and returns the response to the client. So the job of the HTTP server is to accept requests from the client and return a response to" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/go-http/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-21T15:48:53+08:00" />
<meta property="article:modified_time" content="2022-01-21T15:48:53+08:00" />

<meta itemprop="name" content="Analysis of the Go language HTTP standard library">
<meta itemprop="description" content="This article looks at how the Go language HTTP standard library is implemented. The HTTP-based service standard model consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, and the server receives the request, processes it and returns the response to the client. So the job of the HTTP server is to accept requests from the client and return a response to"><meta itemprop="datePublished" content="2022-01-21T15:48:53+08:00" />
<meta itemprop="dateModified" content="2022-01-21T15:48:53+08:00" />
<meta itemprop="wordCount" content="3960">
<meta itemprop="keywords" content="golang,http," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Analysis of the Go language HTTP standard library"/>
<meta name="twitter:description" content="This article looks at how the Go language HTTP standard library is implemented. The HTTP-based service standard model consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, and the server receives the request, processes it and returns the response to the client. So the job of the HTTP server is to accept requests from the client and return a response to"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Analysis of the Go language HTTP standard library</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-21 15:48:53 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3960 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#http-client">HTTP client</a>
          <ul>
            <li><a href="#client-struct">Client struct</a></li>
            <li><a href="#initialising-the-request">Initialising the request</a></li>
            <li><a href="#preparing-an-http-request">Preparing an http request</a></li>
            <li><a href="#getting-a-connection-getconn">Getting a connection getConn</a></li>
            <li><a href="#waiting-for-a-response">Waiting for a response</a></li>
          </ul>
        </li>
        <li><a href="#http-server">http server</a>
          <ul>
            <li><a href="#registering-processors">Registering processors</a></li>
            <li><a href="#listening">Listening</a></li>
            <li><a href="#handling-requests">Handling requests</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article looks at how the Go language HTTP standard library is implemented.</p>
<p>The HTTP-based service standard model consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, and the server receives the request, processes it and returns the response to the client. So the job of the HTTP server is to accept requests from the client and return a response to the client.</p>
<p>A typical HTTP service should look like the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/f5e78752b5e14b1aa9477f3ca3d7d0d6.png" alt="HTTP service"></p>
<h2 id="http-client">HTTP client</h2>
<p>A simple example of how you can initiate a request for data in Go is directly through the Get method of the HTTP package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;http://httpbin.org/get?name=luozhiyun&amp;age=27&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s go through this example.</p>
<p>The Get method of HTTP will call the Get method of DefaultClient, which is an empty instance of Client, so it will end up calling the Get method of Client.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/6875dca2ce044e8f862447b5fabbb80d.png" alt="sobyte"></p>
<h3 id="client-struct">Client struct</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span> 
    <span class="nx">Transport</span> <span class="nx">RoundTripper</span> 
    <span class="nx">CheckRedirect</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">via</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span> 
    <span class="nx">Jar</span> <span class="nx">CookieJar</span> 
    <span class="nx">Timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Client structure consists of a total of four fields.</p>
<p><strong>Transport</strong> : indicates the HTTP transaction, which is used to process the client&rsquo;s request connection and wait for the server&rsquo;s response.</p>
<p><strong>CheckRedirect</strong>: used to specify the policy for handling redirects.</p>
<p><strong>Jar</strong>: used to manage and store cookies in requests.</p>
<p><strong>Timeout</strong> : specifies a maximum timeout for client requests that includes the connection, any redirects and the time to read the corresponding time; <strong>Timeout</strong> : specifies a maximum timeout for client requests that includes the connection, any redirects and the time to read the corresponding time.</p>
<h3 id="initialising-the-request">Initialising the request</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 根据方法名、URL 和请求体构建请求
</span><span class="c1"></span>    <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// 执行请求
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>To initiate a request we first need to construct a complete request header, request body, and request parameters based on the request type. Only then is the request executed based on the complete structure of the request.</p>
<h4 id="newrequest-initialises-the-request">NewRequest initialises the request</h4>
<p>NewRequest is called on the NewRequestWithContext function. This function returns a Request structure based on the request, which contains all the information for an HTTP request.</p>
<p><strong>Request</strong></p>
<p>The Request structure has a number of fields, I&rsquo;ll list a few familiar ones here.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/141b5a1ad60b447baf23735666cd7745.png" alt="sobyte"></p>
<p><strong>NewRequestWithContext</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewRequestWithContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">url</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">body</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// parse url
</span><span class="c1"></span>    <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">urlpkg</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">rc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">body</span><span class="p">.(</span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadCloser</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">body</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rc</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
    <span class="p">}</span> 
    <span class="nx">u</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="nf">removeEmptyPort</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Host</span><span class="p">)</span>
    <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span>
        <span class="nx">ctx</span><span class="p">:</span>        <span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">Method</span><span class="p">:</span>     <span class="nx">method</span><span class="p">,</span>
        <span class="nx">URL</span><span class="p">:</span>        <span class="nx">u</span><span class="p">,</span>
        <span class="nx">Proto</span><span class="p">:</span>      <span class="s">&#34;HTTP/1.1&#34;</span><span class="p">,</span>
        <span class="nx">ProtoMajor</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">ProtoMinor</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">Header</span><span class="p">:</span>     <span class="nb">make</span><span class="p">(</span><span class="nx">Header</span><span class="p">),</span>
        <span class="nx">Body</span><span class="p">:</span>       <span class="nx">rc</span><span class="p">,</span>
        <span class="nx">Host</span><span class="p">:</span>       <span class="nx">u</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
    <span class="p">}</span> 
    <span class="o">...</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The NewRequestWithContext function wraps the request into a Request structure and returns it.</p>
<h3 id="preparing-an-http-request">Preparing an http request</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/8fb44a3b74414c4d99037cd99f83a3cd.png" alt="sobyte"></p>
<p>As shown above, the Client calls the Do method to process the send request and finally calls the send function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">send</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">didTimeout</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resp</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">transport</span><span class="p">(),</span> <span class="nx">deadline</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">didTimeout</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="transport">Transport</h4>
<p>The send method of the Client will call the transport method to obtain the DefaultTransport instance before calling the send function for further processing, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">DefaultTransport</span> <span class="nx">RoundTripper</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Transport</span><span class="p">{</span>
    <span class="c1">// 定义 HTTP 代理策略
</span><span class="c1"></span>    <span class="nx">Proxy</span><span class="p">:</span> <span class="nx">ProxyFromEnvironment</span><span class="p">,</span>
    <span class="nx">DialContext</span><span class="p">:</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">{</span>
        <span class="nx">Timeout</span><span class="p">:</span>   <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
        <span class="nx">KeepAlive</span><span class="p">:</span> <span class="mi">30</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
        <span class="nx">DualStack</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">}).</span><span class="nx">DialContext</span><span class="p">,</span>
    <span class="nx">ForceAttemptHTTP2</span><span class="p">:</span>     <span class="kc">true</span><span class="p">,</span>
    <span class="c1">// 最大空闲连接数
</span><span class="c1"></span>    <span class="nx">MaxIdleConns</span><span class="p">:</span>          <span class="mi">100</span><span class="p">,</span>
    <span class="c1">// 空闲连接超时时间
</span><span class="c1"></span>    <span class="nx">IdleConnTimeout</span><span class="p">:</span>       <span class="mi">90</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="c1">// TLS 握手超时时间
</span><span class="c1"></span>    <span class="nx">TLSHandshakeTimeout</span><span class="p">:</span>   <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="nx">ExpectContinueTimeout</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/bd43885ddb834581a3dc73eaf0ff5707.png" alt="sobyte"></p>
<p>Transport implements the RoundTripper interface, a structure that sends http requests and waits for responses.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">RoundTripper</span> <span class="kd">interface</span> <span class="p">{</span> 
    <span class="nf">RoundTrip</span><span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can also see from the RoundTripper interface that the RoundTrip method defined by this interface will specifically process the request and respond with a Response once it has been processed.</p>
<p>Going back to our Client&rsquo;s send method above, it calls the send function, the main logic of which is left to Transport&rsquo;s RoundTrip method.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/a70c880b0cea46f6b3d8310cdcf8be24.png" alt="sobyte"></p>
<p>RoundTrip will call into the roundTrip method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">nextProtoOnce</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">onceSetNextProtoDefaults</span><span class="p">)</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
    <span class="nx">trace</span> <span class="o">:=</span> <span class="nx">httptrace</span><span class="p">.</span><span class="nf">ContextClientTrace</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> 
    <span class="o">...</span>  
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
        <span class="k">default</span><span class="p">:</span>
        <span class="p">}</span>

        <span class="c1">// 封装请求
</span><span class="c1"></span>        <span class="nx">treq</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">transportRequest</span><span class="p">{</span><span class="nx">Request</span><span class="p">:</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">trace</span><span class="p">:</span> <span class="nx">trace</span><span class="p">,</span> <span class="nx">cancelKey</span><span class="p">:</span> <span class="nx">cancelKey</span><span class="p">}</span> 
        <span class="nx">cm</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">connectMethodForRequest</span><span class="p">(</span><span class="nx">treq</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span> 
        <span class="c1">// 获取连接
</span><span class="c1"></span>        <span class="nx">pconn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">getConn</span><span class="p">(</span><span class="nx">treq</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">cancelKey</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="nx">req</span><span class="p">.</span><span class="nf">closeBody</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">// 等待响应结果
</span><span class="c1"></span>        <span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
        <span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// HTTP/2 path.
</span><span class="c1"></span>            <span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">cancelKey</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// not cancelable with CancelRequest
</span><span class="c1"></span>            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">roundTrip</span><span class="p">(</span><span class="nx">treq</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">resp</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">origReq</span>
            <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
        <span class="p">}</span> 
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The roundTrip method will do two things.</p>
<ol>
<li>call the getConn method of Transport to obtain the connection.</li>
<li>after the connection is obtained, call the roundTrip method of persistConn to wait for the result of the request response.</li>
</ol>
<h3 id="getting-a-connection-getconn">Getting a connection getConn</h3>
<p>getConn has two phases.</p>
<ol>
<li>calling queueForIdleConn to get a free connection.</li>
<li>calling queueForDial to wait for a new connection to be created.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/e2a7bb4f269a453bbf7b176ac39536c4.png" alt="sobyte"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">getConn</span><span class="p">(</span><span class="nx">treq</span> <span class="o">*</span><span class="nx">transportRequest</span><span class="p">,</span> <span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span> <span class="o">:=</span> <span class="nx">treq</span><span class="p">.</span><span class="nx">Request</span>
    <span class="nx">trace</span> <span class="o">:=</span> <span class="nx">treq</span><span class="p">.</span><span class="nx">trace</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">trace</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">GetConn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">trace</span><span class="p">.</span><span class="nf">GetConn</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">())</span>
    <span class="p">}</span>   
    <span class="c1">// 将请求封装成 wantConn 结构体
</span><span class="c1"></span>    <span class="nx">w</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">wantConn</span><span class="p">{</span>
        <span class="nx">cm</span><span class="p">:</span>         <span class="nx">cm</span><span class="p">,</span>
        <span class="nx">key</span><span class="p">:</span>        <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">(),</span>
        <span class="nx">ctx</span><span class="p">:</span>        <span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">ready</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">beforeDial</span><span class="p">:</span> <span class="nx">testHookPrePendingDial</span><span class="p">,</span>
        <span class="nx">afterDial</span><span class="p">:</span>  <span class="nx">testHookPostPendingDial</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">w</span><span class="p">.</span><span class="nf">cancel</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="c1">// 获取空闲连接
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">delivered</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">queueForIdleConn</span><span class="p">(</span><span class="nx">w</span><span class="p">);</span> <span class="nx">delivered</span> <span class="p">{</span>
        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">pc</span>
        <span class="o">...</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">treq</span><span class="p">.</span><span class="nx">cancelKey</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="c1">// 创建连接
</span><span class="c1"></span>    <span class="nx">t</span><span class="p">.</span><span class="nf">queueForDial</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>

    <span class="k">select</span> <span class="p">{</span>
    <span class="c1">// 获取到连接后进入该分支
</span><span class="c1"></span>    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">ready</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">err</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="get-idle-connection-queueforidleconn">Get idle connection queueForIdleConn</h4>
<p>Idle connection successfully obtained.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/eb11cc40071a4ea7afe905fb54580e76.png" alt="sobyte"></p>
<p>Successfully fetching a connection consists of the following steps.</p>
<ol>
<li>go to the <strong>free connection dictionary</strong> to see if there is a list of free connections based on the address of the current request.</li>
<li>if the list of free connections can be fetched, fetch the last connection in the list.</li>
<li>return.</li>
</ol>
<p>If no free connection is available.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/3d2999e8714d46b2a343d04ca4adc8da.png" alt="sobyte"></p>
<p>When a free connection is not available: 1.</p>
<ol>
<li>check the <strong>free connection dictionary</strong> for a list of free connections based on the address of the current request.</li>
<li>if no connection exists for the request, then add the wantConn to the <strong>waiting for a free connection dictionary</strong>.</li>
</ol>
<p>The above diagram should give you a good idea of how this step will work, but here is a brief analysis of the code to make the logic clearer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">queueForIdleConn</span><span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">wantConn</span><span class="p">)</span> <span class="p">(</span><span class="nx">delivered</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">DisableKeepAlives</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span> 
    <span class="nx">t</span><span class="p">.</span><span class="nx">closeIdle</span> <span class="p">=</span> <span class="kc">false</span>

    <span class="k">if</span> <span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> 
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="c1">// 计算空闲连接超时时间
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">oldTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">IdleConnTimeout</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">oldTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="o">-</span><span class="nx">t</span><span class="p">.</span><span class="nx">IdleConnTimeout</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// Look for most recently-used idle connection.
</span><span class="c1"></span>    <span class="c1">// 找到key相同的 connection 列表
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">stop</span> <span class="o">:=</span> <span class="kc">false</span>
        <span class="nx">delivered</span> <span class="o">:=</span> <span class="kc">false</span>
        <span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">stop</span> <span class="p">{</span>
            <span class="c1">// 找到connection列表最后一个
</span><span class="c1"></span>            <span class="nx">pconn</span> <span class="o">:=</span> <span class="nx">list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="c1">// 检查这个 connection 是不是等待太久了
</span><span class="c1"></span>            <span class="nx">tooOld</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">oldTime</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">idleAt</span><span class="p">.</span><span class="nf">Round</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">Before</span><span class="p">(</span><span class="nx">oldTime</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">tooOld</span> <span class="p">{</span> 
                <span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">closeConnIfStillIdle</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="c1">// 该 connection 被标记为 broken 或 闲置太久 continue
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">isBroken</span><span class="p">()</span> <span class="o">||</span> <span class="nx">tooOld</span> <span class="p">{</span> 
                <span class="nx">list</span> <span class="p">=</span> <span class="nx">list</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="c1">// 尝试将该 connection 写入到 w 中
</span><span class="c1"></span>            <span class="nx">delivered</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">tryDeliver</span><span class="p">(</span><span class="nx">pconn</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">delivered</span> <span class="p">{</span>
                <span class="c1">// 操作成功，需要将 connection 从空闲列表中移除
</span><span class="c1"></span>                <span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> 
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
                    <span class="nx">t</span><span class="p">.</span><span class="nx">idleLRU</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nx">pconn</span><span class="p">)</span>
                    <span class="nx">list</span> <span class="p">=</span> <span class="nx">list</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">stop</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">list</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 如果该 key 对应的空闲列表不存在，那么将该key从字典中移除
</span><span class="c1"></span>            <span class="nb">delete</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">idleConn</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">stop</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">delivered</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="c1">// 如果找不到空闲的 connection
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnWait</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnWait</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="nx">wantConnQueue</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="c1">// 将该 wantConn 加入到 等待获取空闲 connection 字典中
</span><span class="c1"></span>    <span class="nx">q</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnWait</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> 
    <span class="nx">q</span><span class="p">.</span><span class="nf">cleanFront</span><span class="p">()</span>
    <span class="nx">q</span><span class="p">.</span><span class="nf">pushBack</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">idleConnWait</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">q</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The comments above are clear enough, so I won&rsquo;t explain them here.</p>
<h4 id="establishing-a-connection-queuefordial">Establishing a connection queueForDial</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/2fb258f736c84af2901ec9c8da51fc99.png" alt="sobyte"></p>
<p>After a free connection is not obtained, an attempt is made to establish a connection, as can be seen from the diagram above, in the following steps.</p>
<ol>
<li>the queueForDial method is called with a check to see if MaxConnsPerHost is not set or has reached its limit.
<ol>
<li>if the check does not pass then the current request is put into the connsPerHostWait waiting dictionary;</li>
</ol>
</li>
<li>if the check passes then the dialConnFor method is called asynchronously to create the connection.</li>
<li>the dialConnFor method first calls the dialConn method to create a TCP connection, then starts two asynchronous threads to process the read and write data, and then calls tryDeliver to bind the connection to wantConn.</li>
</ol>
<p>The following code analysis is performed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">queueForDial</span><span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">wantConn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">beforeDial</span><span class="p">()</span>
    <span class="c1">// 小于零说明无限制，异步建立连接
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">MaxConnsPerHost</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">go</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dialConnFor</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="c1">// 每个 host 建立的连接数没达到上限，异步建立连接
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHost</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">MaxConnsPerHost</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHost</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHost</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHost</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">go</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dialConnFor</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">//每个 host 建立的连接数已达到上限，需要进入等待队列
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostWait</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostWait</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">connectMethodKey</span><span class="p">]</span><span class="nx">wantConnQueue</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">q</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostWait</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">q</span><span class="p">.</span><span class="nf">cleanFront</span><span class="p">()</span>
    <span class="nx">q</span><span class="p">.</span><span class="nf">pushBack</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">connsPerHostWait</span><span class="p">[</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">q</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the parameters are checked, if the maximum number of connections is limited to zero, or if the maximum number of connections per host is not reached, then the connections are established asynchronously.</p>
<p><strong>dialConnFor</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">dialConnFor</span><span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">wantConn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">w</span><span class="p">.</span><span class="nf">afterDial</span><span class="p">()</span>
    <span class="c1">// 建立连接
</span><span class="c1"></span>    <span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dialConn</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">cm</span><span class="p">)</span>
    <span class="c1">// 连接绑定 wantConn
</span><span class="c1"></span>    <span class="nx">delivered</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">tryDeliver</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="c1">// 建立连接成功，但是绑定 wantConn 失败
</span><span class="c1"></span>    <span class="c1">// 那么将该连接放置到空闲连接字典或调用 等待获取空闲 connection 字典 中的元素执行
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(!</span><span class="nx">delivered</span> <span class="o">||</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">t</span><span class="p">.</span><span class="nf">putOrCloseIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">decConnsPerHost</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>dialConnFor will call dialConn to create a TCP connection, and then call the tryDeliver method to bind to wantConn after creation.</p>
<p><strong>dialConn</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">dialConn</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">cm</span> <span class="nx">connectMethod</span><span class="p">)</span> <span class="p">(</span><span class="nx">pconn</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建连接结构体
</span><span class="c1"></span>    <span class="nx">pconn</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">persistConn</span><span class="p">{</span>
        <span class="nx">t</span><span class="p">:</span>             <span class="nx">t</span><span class="p">,</span>
        <span class="nx">cacheKey</span><span class="p">:</span>      <span class="nx">cm</span><span class="p">.</span><span class="nf">key</span><span class="p">(),</span>
        <span class="nx">reqch</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">requestAndChan</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">writech</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">writeRequest</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">closech</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
        <span class="nx">writeErrCh</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">writeLoopDone</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">scheme</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;https&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasCustomTLSDialer</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 建立 tcp 连接
</span><span class="c1"></span>        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">dial</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">addr</span><span class="p">())</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">wrapErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="nx">conn</span> 
    <span class="p">}</span> 
    <span class="o">...</span>

    <span class="k">if</span> <span class="nx">s</span> <span class="o">:=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">tlsState</span><span class="p">;</span> <span class="nx">s</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">NegotiatedProtocolIsMutual</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">NegotiatedProtocol</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TLSNextProto</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">NegotiatedProtocol</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">alt</span> <span class="o">:=</span> <span class="nf">next</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">targetAddr</span><span class="p">,</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">conn</span><span class="p">.(</span><span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Conn</span><span class="p">))</span>
            <span class="k">if</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">alt</span><span class="p">.(</span><span class="nx">http2erringRoundTripper</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
                <span class="c1">// pconn.conn was closed by next (http2configureTransport.upgradeFn).
</span><span class="c1"></span>                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">err</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="o">&amp;</span><span class="nx">persistConn</span><span class="p">{</span><span class="nx">t</span><span class="p">:</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">cacheKey</span><span class="p">:</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">alt</span><span class="p">:</span> <span class="nx">alt</span><span class="p">},</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">pconn</span><span class="p">.</span><span class="nx">br</span> <span class="p">=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReaderSize</span><span class="p">(</span><span class="nx">pconn</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">readBufferSize</span><span class="p">())</span>
    <span class="nx">pconn</span><span class="p">.</span><span class="nx">bw</span> <span class="p">=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriterSize</span><span class="p">(</span><span class="nx">persistConnWriter</span><span class="p">{</span><span class="nx">pconn</span><span class="p">},</span> <span class="nx">t</span><span class="p">.</span><span class="nf">writeBufferSize</span><span class="p">())</span>
    <span class="c1">//为每个连接异步处理读写数据
</span><span class="c1"></span>    <span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">readLoop</span><span class="p">()</span>
    <span class="k">go</span> <span class="nx">pconn</span><span class="p">.</span><span class="nf">writeLoop</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">pconn</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The connection configuration is set up differently depending on the schema, and I have shown above the process of creating our usual HTTP connections. For HTTP it will create a tcp connection, then asynchronously process the read and write data for the connection, and finally return the created connection.</p>
<h3 id="waiting-for-a-response">Waiting for a response</h3>
<p>This section is a little more complicated, but really interesting.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/b4ecf2e198fe4314ab3858229026b3c5.png" alt="sobyte"></p>
<p>When a connection is created two channels are initialised: writech for writing the request data and reqch for reading the response data. When we created the connection above, we also mentioned that two asynchronous loops, readLoop and writeLoop, are created for the connection to handle the read and write data.</p>
<p>After the connection is fetched, the connection&rsquo;s roundTrip method is called, which first writes the request data to the writech pipe, and the writeLoop receives the data and processes the request.</p>
<p>Then roundTrip writes the requestAndChan structure to the reqch pipe, and then roundTrip loops through. readLoop reads the response data and then encapsulates it in a responseAndError structure via the pipe stored in the requestAndChan structure. This allows the roundTrip to receive the response data, end the loop and return.</p>
<p><strong>roundTrip</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">transportRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="nx">writeErrCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// 将请求数据写入到 writech 管道中
</span><span class="c1"></span>    <span class="nx">pc</span><span class="p">.</span><span class="nx">writech</span> <span class="o">&lt;-</span> <span class="nx">writeRequest</span><span class="p">{</span><span class="nx">req</span><span class="p">,</span> <span class="nx">writeErrCh</span><span class="p">,</span> <span class="nx">continueCh</span><span class="p">}</span>

    <span class="c1">// 用于接收响应的管道
</span><span class="c1"></span>    <span class="nx">resc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">responseAndError</span><span class="p">)</span>
    <span class="c1">// 将用于接收响应的管道封装成 requestAndChan 写入到 reqch 管道中
</span><span class="c1"></span>    <span class="nx">pc</span><span class="p">.</span><span class="nx">reqch</span> <span class="o">&lt;-</span> <span class="nx">requestAndChan</span><span class="p">{</span>
        <span class="nx">req</span><span class="p">:</span>        <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
        <span class="nx">cancelKey</span><span class="p">:</span>  <span class="nx">req</span><span class="p">.</span><span class="nx">cancelKey</span><span class="p">,</span>
        <span class="nx">ch</span><span class="p">:</span>         <span class="nx">resc</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">testHookWaitResLoop</span><span class="p">()</span>
        <span class="k">select</span> <span class="p">{</span> 
        <span class="c1">// 接收到响应数据
</span><span class="c1"></span>        <span class="k">case</span> <span class="nx">re</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">resc</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">res</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;internal error: exactly one of res or err should be set; nil=%v&#34;</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">debugRoundTrip</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;resc recv: %p, %T/%#v&#34;</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">mapRoundTripError</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">startBytesWritten</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="c1">// 返回响应数据
</span><span class="c1"></span>            <span class="k">return</span> <span class="nx">re</span><span class="p">.</span><span class="nx">res</span><span class="p">,</span> <span class="kc">nil</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the writeRequest is wrapped as the data to send the request, the pipe to receive the response is wrapped as requestAndChan and written to the reqch pipe, and then the loop waits to receive the response.</p>
<p>The writeLoop then does the request data writeRequest.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">writeLoop</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">writeLoopDone</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">wr</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">writech</span><span class="p">:</span>
            <span class="nx">startBytesWritten</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">nwrite</span>
            <span class="c1">// 向 TCP 连接中写入数据，并发送至目标服务器
</span><span class="c1"></span>            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">pc</span><span class="p">.</span><span class="nx">bw</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nx">isProxy</span><span class="p">,</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">extra</span><span class="p">,</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">waitForContinue</span><span class="p">(</span><span class="nx">wr</span><span class="p">.</span><span class="nx">continueCh</span><span class="p">))</span>
            <span class="o">...</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">closech</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the data fetched from the writech pipeline is written to the TCP connection and sent to the target server.</p>
<p><strong>readLoop</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">persistConn</span><span class="p">)</span> <span class="nf">readLoop</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">closeErr</span> <span class="o">:=</span> <span class="nx">errReadLoopExiting</span> <span class="c1">// default value, if not changed below
</span><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="nx">closeErr</span><span class="p">)</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">removeIdleConn</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="o">...</span> 
    <span class="nx">alive</span> <span class="o">:=</span> <span class="kc">true</span>
    <span class="k">for</span> <span class="nx">alive</span> <span class="p">{</span>
        <span class="nx">pc</span><span class="p">.</span><span class="nx">readLimit</span> <span class="p">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">maxHeaderResponseSize</span><span class="p">()</span>
        <span class="c1">// 获取 roundTrip 发送的结构体
</span><span class="c1"></span>        <span class="nx">rc</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">pc</span><span class="p">.</span><span class="nx">reqch</span>
        <span class="nx">trace</span> <span class="o">:=</span> <span class="nx">httptrace</span><span class="p">.</span><span class="nf">ContextClientTrace</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>

        <span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// 读取数据
</span><span class="c1"></span>            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">readResponse</span><span class="p">(</span><span class="nx">rc</span><span class="p">,</span> <span class="nx">trace</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">transportReadFromServerError</span><span class="p">{</span><span class="nx">err</span><span class="p">}</span>
            <span class="nx">closeErr</span> <span class="p">=</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="o">...</span>  
        <span class="c1">// 将响应数据写回到管道中
</span><span class="c1"></span>        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">responseAndError</span><span class="p">{</span><span class="nx">res</span><span class="p">:</span> <span class="nx">resp</span><span class="p">}:</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rc</span><span class="p">.</span><span class="nx">callerGone</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the corresponding request response data is read from the TCP connection and written back through the pipeline passed in by the roundTrip, which then accepts the data and returns the fetched response data.</p>
<h2 id="http-server">http server</h2>
<p>I&rsquo;ll continue with a simple example to start with.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">HelloHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello World&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">HelloHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ll start with a diagram to give a brief overview of the implementation.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/c70d32adffa345b8b9ce793a0c29fa00.png" alt="sobyte"></p>
<p>In fact, we can see some general steps from the method names in the above example.</p>
<ol>
<li>registering the processor to a hash table, which can be matched by key-value routing.</li>
<li>after registration, a loop is opened to listen, and a Goroutine is created every time a connection is listened to.</li>
<li>inside the created Goroutine, it waits in a loop to receive the request data, then matches the corresponding processor in the processor routing table according to the request address, and hands the request to the processor for processing.</li>
</ol>
<h3 id="registering-processors">Registering processors</h3>
<p>The processor is registered as shown in the example above, by calling the HandleFunc function.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/eb182e60c0934b93a05e1afcdaf1ec80.png" alt="sobyte"></p>
<p>The HandleFunc function is called all the way to the Handle method of ServeMux.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="nx">e</span> <span class="o">:=</span> <span class="nx">muxEntry</span><span class="p">{</span><span class="nx">h</span><span class="p">:</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">:</span> <span class="nx">pattern</span><span class="p">}</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">pattern</span><span class="p">]</span> <span class="p">=</span> <span class="nx">e</span>
    <span class="k">if</span> <span class="nx">pattern</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">es</span> <span class="p">=</span> <span class="nf">appendSorted</span><span class="p">(</span><span class="nx">mux</span><span class="p">.</span><span class="nx">es</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">hosts</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Handle stores <code>muxEntry</code> objects, which encapsulate the pattern and handler, based on the route as the key of the hash table, and adds the corresponding <code>muxEntry</code> object to <code>[]muxEntry</code> if the route expression ends in <code>'/'</code>.</p>
<p>The hash table is used for exact matching of routes, <code>[]muxEntry</code> for partial matching.</p>
<h3 id="listening">Listening</h3>
<p>Listening is done by calling the ListenAndServe function, which calls the server&rsquo;s ListenAndServe method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ListenAndServe</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">shuttingDown</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ErrServerClosed</span>
    <span class="p">}</span>
    <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Addr</span>
    <span class="k">if</span> <span class="nx">addr</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="nx">addr</span> <span class="p">=</span> <span class="s">&#34;:http&#34;</span>
    <span class="p">}</span>
    <span class="c1">// 监听端口
</span><span class="c1"></span>    <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// 循环接收监听到的网络请求
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Serve</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> 
    <span class="o">...</span>
    <span class="nx">baseCtx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>  
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">baseCtx</span><span class="p">,</span> <span class="nx">ServerContextKey</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 接收 listener 过来的网络连接
</span><span class="c1"></span>        <span class="nx">rw</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
        <span class="o">...</span> 
        <span class="nx">tempDelay</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">newConn</span><span class="p">(</span><span class="nx">rw</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">,</span> <span class="nx">StateNew</span><span class="p">)</span> 
        <span class="c1">// 创建协程处理连接
</span><span class="c1"></span>        <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serve</span><span class="p">(</span><span class="nx">connCtx</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Serve method uses a loop to receive network connections and then creates a thread to handle them. Inevitably, there is a problem that if the concurrency is high, too many concurrent threads may be created at once, resulting in an overwhelming situation.</p>
<h3 id="handling-requests">Handling requests</h3>
<p>Requests are handled by creating a goroutine for each connection to handle the corresponding request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">remoteAddr</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
    <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">LocalAddrContextKey</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">())</span> 
    <span class="o">...</span> 
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancelCtx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">cancelCtx</span> <span class="p">=</span> <span class="nx">cancelCtx</span>
    <span class="k">defer</span> <span class="nf">cancelCtx</span><span class="p">()</span> 
    <span class="nx">c</span><span class="p">.</span><span class="nx">r</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">connReader</span><span class="p">{</span><span class="nx">conn</span><span class="p">:</span> <span class="nx">c</span><span class="p">}</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">bufr</span> <span class="p">=</span> <span class="nf">newBufioReader</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">bufw</span> <span class="p">=</span> <span class="nf">newBufioWriterSize</span><span class="p">(</span><span class="nx">checkConnErrorWriter</span><span class="p">{</span><span class="nx">c</span><span class="p">},</span> <span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span>  
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 读取请求
</span><span class="c1"></span>        <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">readRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> 
        <span class="o">...</span> 
        <span class="c1">// 根据请求路由调用处理器处理请求
</span><span class="c1"></span>        <span class="nx">serverHandler</span><span class="p">{</span><span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">}.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">cancelCtx</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nf">hijacked</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">finishRequest</span><span class="p">()</span> 
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once a connection is established, all requests within that connection are processed in this concurrent thread until the connection is closed. Inside the for loop readRequest is called recursively to read requests for processing.</p>
<p>Request processing is done by calling ServeHTTP.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">serverHandler</span> <span class="kd">struct</span> <span class="p">{</span>
   <span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sh</span> <span class="nx">serverHandler</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">sh</span><span class="p">.</span><span class="nx">srv</span><span class="p">.</span><span class="nx">Handler</span>
    <span class="k">if</span> <span class="nx">handler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="p">=</span> <span class="nx">DefaultServeMux</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RequestURI</span> <span class="o">==</span> <span class="s">&#34;*&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&#34;OPTIONS&#34;</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="p">=</span> <span class="nx">globalOptionsHandler</span><span class="p">{}</span>
    <span class="p">}</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The serverHandler is actually the Server wrapped in a layer. The <code>sh.srv.Handler</code> parameter here is actually an instance of ServeMux passed in, so the ServeHTTP method of ServeMux will be called at the end.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/944ea2fae8064de5ac81d3d07b1c2924.png" alt="sobyte"></p>
<p>The match method will eventually be called through the handler to perform the route matching.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nf">match</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pattern</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">es</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pattern</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This method first uses an exact match, if the match is successful then it returns directly; if the match is unsuccessful then it matches the closest registered parent route to the current route stored in <code>[]muxEntry</code>, otherwise it continues to match the next parent route until the root route <code>/</code>. Finally the corresponding processor will be called for processing.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/http/">http</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/curl-json/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">cURL will natively support JSON</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/fasthttp-server/">
            <span class="next-text nav-default">Fasthttp: a Go framework ten times faster than net/http (server part)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
