<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Fasthttp: a Go framework ten times faster than net/http (server part) - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I found a Go framework that claims to be ten times faster than net/http - Fasthttp. Let&amp;rsquo;s take a look at what great design it has to offer and let&amp;rsquo;s dig in. A typical HTTP service should look like this: The standard model of a service built on HTTP consists of two ends, a client (&amp;lsquo;Client&amp;rsquo;) and a server (&amp;lsquo;Server&amp;rsquo;). HTTP requests are sent from the client, the server receives" /><meta name="keywords" content="fasthttp" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/fasthttp-server/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Fasthttp: a Go framework ten times faster than net/http (server part)" />
<meta property="og:description" content="I found a Go framework that claims to be ten times faster than net/http - Fasthttp. Let&rsquo;s take a look at what great design it has to offer and let&rsquo;s dig in. A typical HTTP service should look like this: The standard model of a service built on HTTP consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, the server receives" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/fasthttp-server/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-21T15:27:25+08:00" />
<meta property="article:modified_time" content="2022-01-21T15:27:25+08:00" />

<meta itemprop="name" content="Fasthttp: a Go framework ten times faster than net/http (server part)">
<meta itemprop="description" content="I found a Go framework that claims to be ten times faster than net/http - Fasthttp. Let&rsquo;s take a look at what great design it has to offer and let&rsquo;s dig in. A typical HTTP service should look like this: The standard model of a service built on HTTP consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, the server receives"><meta itemprop="datePublished" content="2022-01-21T15:27:25+08:00" />
<meta itemprop="dateModified" content="2022-01-21T15:27:25+08:00" />
<meta itemprop="wordCount" content="1883">
<meta itemprop="keywords" content="fasthttp," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fasthttp: a Go framework ten times faster than net/http (server part)"/>
<meta name="twitter:description" content="I found a Go framework that claims to be ten times faster than net/http - Fasthttp. Let&rsquo;s take a look at what great design it has to offer and let&rsquo;s dig in. A typical HTTP service should look like this: The standard model of a service built on HTTP consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, the server receives"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Fasthttp: a Go framework ten times faster than net/http (server part)</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-21 15:27:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1883 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#implementation-principles">Implementation principles</a>
          <ul>
            <li><a href="#nethttp-versus-fasthttp-implementation">net/http versus fasthttp implementation</a></li>
            <li><a href="#summary">Summary</a></li>
          </ul>
        </li>
        <li><a href="#source-code-analysis">Source code analysis</a>
          <ul>
            <li><a href="#worker-pool">worker Pool</a></li>
            <li><a href="#getting-a-connection">Getting a connection</a></li>
            <li><a href="#handling-connections">Handling connections</a></li>
          </ul>
        </li>
        <li><a href="#summary-1">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I found a Go framework that claims to be ten times faster than net/http - <a href="https://github.com/valyala/fasthttp">Fasthttp</a>. Let&rsquo;s take a look at what great design it has to offer and let&rsquo;s dig in.</p>
<p>A typical HTTP service should look like this:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/2907c40315b2497baef5c4e7c152d316.png" alt="HTTP service"></p>
<p>The standard model of a service built on HTTP consists of two ends, a client (&lsquo;Client&rsquo;) and a server (&lsquo;Server&rsquo;). HTTP requests are sent from the client, the server receives the request, processes it and returns the response to the client. So the job of the http server is to accept the request from the client and return the response to the client.</p>
<p>In this article we will talk about the Server side of the implementation.</p>
<h2 id="implementation-principles">Implementation principles</h2>
<h3 id="nethttp-versus-fasthttp-implementation">net/http versus fasthttp implementation</h3>
<p>As we discussed in <code>net/http</code>, the processing flow is roughly as follows:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/a4aab2d217574bbab74f2969ef599695.png" alt="net/http"></p>
<ol>
<li>registering the processor into a hash table, which can be matched by key-value routing.</li>
<li>after registration, a loop is opened to listen, and a Goroutine is created every time a connection is listened to.</li>
<li>the created Goroutine will wait in a loop to receive the request data, then match the processor with the request address in the processor routing table and pass the request to the processor for processing.</li>
</ol>
<p>This is fine when the number of connections is small, but when the number of connections is very large, creating a Goroutine for each connection puts a strain on the system. This creates a bottleneck in <code>net/http</code> when dealing with high concurrency.</p>
<p>Let&rsquo;s look at how fasthttp does this again.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/5ccba0235acc43e0a96af96b580a26a3.png" alt="sobyte"></p>
<ol>
<li>initiating a listen.</li>
<li>listen to the port in a loop to get a connection.</li>
<li>first fetch the workerChan from the ready queue when it gets a connection, and then fetch it from the object pool if it doesn&rsquo;t.</li>
<li>pass the listened connection into the workerChan&rsquo;s channel;</li>
<li>the workerChan has a Goroutine that loops through the data in the channel, and when it gets it, it processes the request and returns it.</li>
</ol>
<p>As mentioned above, a workerChan is actually a connection handler object with a channel to pass connections to; each workerChan has a Goroutine in the background that loops through the connections in the channel and processes them. If the maximum number of simultaneous connections is not set, the default is <code>256 * 1024</code>. This allows the service to be available to the public at the same time, even at high concurrency.</p>
<p>In addition, the implementation uses sync.Pool to reuse a large number of objects and reduce memory allocation, e.g.</p>
<p>workerChanPool, ctxPool, readerPool, writerPool and many more than 30 sync.Pools.</p>
<p>In addition to reusing objects, fasthttp also slices, reducing the need to recreate slices with <code>s = s[:0]</code> and <code>s = append(s[:0], b...)</code>.</p>
<p>fasthttp also tries to avoid the memory allocation and copy consumption of <code>[]byte</code> to string conversions in a number of ways, since there is a lot of dealing with strings.</p>
<h3 id="summary">Summary</h3>
<p>In summary, we&rsquo;ve outlined the performance-enhancing points of fasthttp.</p>
<ol>
<li>controlling the number of simultaneous processes in an asynchronous Goroutine, with a default maximum of <code>256 * 1024</code>.</li>
<li>use sync.Pool to reuse a large number of objects and slices to reduce memory allocation.</li>
<li>avoiding the memory allocation and copy consumption associated with <code>[]byte</code> to string conversions as much as possible.</li>
</ol>
<h2 id="source-code-analysis">Source code analysis</h2>
<p>Let&rsquo;s start with a simple example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> 
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fasthttp</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8088&#34;</span><span class="p">,</span> <span class="nx">requestHandler</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error in ListenAndServe: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">requestHandler</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fasthttp</span><span class="p">.</span><span class="nx">RequestCtx</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;Hello, world!\n\n&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Our call to the ListenAndServe function will start the service listening and waiting for the task to be processed.</p>
<p>The ListenAndServe function actually calls the Server&rsquo;s ListenAndServe method, so here we look at the fields of the Server structure</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/d700a0552aa9469f92f684393794d9df.png" alt="sobyte"></p>
<p>The above diagram briefly lists some common fields of the Server structure, including: request processor, service name, request read timeout, request write timeout, maximum number of requests per connection, etc. In addition there are many other parameters that control some of the parameters on the server side in various dimensions.</p>
<p>The Server&rsquo;s ListenAndServe method will fetch the TCP listener and then call the Serve method to perform the logical processing on the server side.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/13286405b16d46a4af80e04636f59202.png" alt="sobyte"></p>
<p>The Server method does several things.</p>
<ol>
<li>initializes and starts the worker pool.</li>
<li>receives a request for a Connection.</li>
<li>pass the Connection to the worker Pool for processing.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="c1">// 初始化 worker Pool
</span><span class="c1"></span>    <span class="nx">wp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">workerPool</span><span class="p">{</span>
        <span class="nx">WorkerFunc</span><span class="p">:</span>      <span class="nx">s</span><span class="p">.</span><span class="nx">serveConn</span><span class="p">,</span>
        <span class="nx">MaxWorkersCount</span><span class="p">:</span> <span class="nx">maxWorkersCount</span><span class="p">,</span>
        <span class="nx">LogAllErrors</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">LogAllErrors</span><span class="p">,</span>
        <span class="nx">Logger</span><span class="p">:</span>          <span class="nx">s</span><span class="p">.</span><span class="nf">logger</span><span class="p">(),</span>
        <span class="nx">connState</span><span class="p">:</span>       <span class="nx">s</span><span class="p">.</span><span class="nx">setState</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1">// 启动 worker Pool
</span><span class="c1"></span>    <span class="nx">wp</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span> 
    <span class="c1">// 循环处理 connection
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 获取 connection
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">acceptConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">ln</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">lastPerIPErrorTime</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">wp</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">s</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">StateNew</span><span class="p">)</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">open</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">// 处理 connection
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">wp</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 进入if 说明已到并发极限
</span><span class="c1"></span>            <span class="o">...</span>
        <span class="p">}</span>
        <span class="nx">c</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="worker-pool">worker Pool</h3>
<p>The worker Pool is used to handle all requests for Connections, so here&rsquo;s a little look at the fields in the workerPool structure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/afa5bcbbaa2f4b97bcd3011c132f8d7e.png" alt="sobyte"></p>
<ul>
<li>WorkerFunc: used to match the handler corresponding to the request and execute it.</li>
<li>MaxWorkersCount: the maximum number of requests to be processed simultaneously.</li>
<li>ready: the idle workerChan.</li>
<li>workerChanPool: a pool of workerChan objects, of type sync.Pool.</li>
<li>workersCount: the number of requests currently being processed.</li>
</ul>
<p>Let&rsquo;s look at the Start method of the workerPool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="o">*</span><span class="nx">workerPool</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">stopCh</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;BUG: workerPool already started&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">wp</span><span class="p">.</span><span class="nx">stopCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
    <span class="nx">stopCh</span> <span class="o">:=</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">stopCh</span>
    <span class="c1">// 设置 worker Pool 的创建函数
</span><span class="c1"></span>    <span class="nx">wp</span><span class="p">.</span><span class="nx">workerChanPool</span><span class="p">.</span><span class="nx">New</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">workerChan</span><span class="p">{</span>
            <span class="nx">ch</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">workerChanCap</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">scratch</span> <span class="p">[]</span><span class="o">*</span><span class="nx">workerChan</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="c1">// 没隔一段时间会清理空闲超时的 workerChan
</span><span class="c1"></span>            <span class="nx">wp</span><span class="p">.</span><span class="nf">clean</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">scratch</span><span class="p">)</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopCh</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="c1">// 默认是 10 s
</span><span class="c1"></span>                <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nf">getMaxIdleWorkerDuration</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Start method mainly:</p>
<ol>
<li>set the workerChanPool creation function.</li>
<li>start a Goroutine that regularly cleans up the free workerChan stored in ready in the workerPool, by default every 10s.</li>
</ol>
<h3 id="getting-a-connection">Getting a connection</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">acceptConn</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">ln</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">lastPerIPErrorTime</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ln</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;BUG: net.Listener returned non-nil conn and non-nil error&#34;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;BUG: net.Listener returned (nil, nil)&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 校验每个ip对应的连接数
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MaxConnsPerIP</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nx">pic</span> <span class="o">:=</span> <span class="nf">wrapPerIPConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">pic</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="o">*</span><span class="nx">lastPerIPErrorTime</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="p">{</span>
                    <span class="nx">s</span><span class="p">.</span><span class="nf">logger</span><span class="p">().</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;The number of connections from %s exceeds MaxConnsPerIP=%d&#34;</span><span class="p">,</span>
                        <span class="nf">getConnIP4</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MaxConnsPerIP</span><span class="p">)</span>
                    <span class="o">*</span><span class="nx">lastPerIPErrorTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="nx">c</span> <span class="p">=</span> <span class="nx">pic</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There&rsquo;s not much to say about getting a connection, the TCPListener&rsquo;s accept method is called just like the <code>net/http</code> library to get a TCP Connection.</p>
<h3 id="handling-connections">Handling connections</h3>
<p>The first part of processing a connection is to get the workerChan, which contains two fields: lastUseTime and channel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">workerChan</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">lastUseTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
    <span class="nx">ch</span>          <span class="kd">chan</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>lastUseTime identifies the time when it was last used.</li>
<li>ch is used to pass the Connection.</li>
</ul>
<p>Once the Connection is obtained, it is passed into the workerChan&rsquo;s channel, and each corresponding workerChan has an asynchronous Goroutine that handles the Connection inside the channel.</p>
<h4 id="get-workerchan">Get workerChan</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="o">*</span><span class="nx">workerPool</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">c</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="c1">// 获取 workerChan 
</span><span class="c1"></span>    <span class="nx">ch</span> <span class="o">:=</span> <span class="nx">wp</span><span class="p">.</span><span class="nf">getCh</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">ch</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="c1">// 将 Connection 放入到 channel 中
</span><span class="c1"></span>    <span class="nx">ch</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">c</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The Serve method essentially gets the workerChan via the getCh method and passes the current Connection into the workerChan&rsquo;s channel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="o">*</span><span class="nx">workerPool</span><span class="p">)</span> <span class="nf">getCh</span><span class="p">()</span> <span class="o">*</span><span class="nx">workerChan</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ch</span> <span class="o">*</span><span class="nx">workerChan</span>
    <span class="nx">createWorker</span> <span class="o">:=</span> <span class="kc">false</span>

    <span class="nx">wp</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="c1">// 尝试从空闲队列里获取 workerChan
</span><span class="c1"></span>    <span class="nx">ready</span> <span class="o">:=</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">ready</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ready</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">workersCount</span> <span class="p">&lt;</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">MaxWorkersCount</span> <span class="p">{</span>
            <span class="nx">createWorker</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="nx">wp</span><span class="p">.</span><span class="nx">workersCount</span><span class="o">++</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ch</span> <span class="p">=</span> <span class="nx">ready</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span>
        <span class="nx">ready</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="nx">wp</span><span class="p">.</span><span class="nx">ready</span> <span class="p">=</span> <span class="nx">ready</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">wp</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
    <span class="c1">// 获取不到则从对象池中获取
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">ch</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">createWorker</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="nx">vch</span> <span class="o">:=</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">workerChanPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
        <span class="nx">ch</span> <span class="p">=</span> <span class="nx">vch</span><span class="p">.(</span><span class="o">*</span><span class="nx">workerChan</span><span class="p">)</span>
        <span class="c1">// 为新的 workerChan 开启 goroutine
</span><span class="c1"></span>        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 处理 channel 中的数据
</span><span class="c1"></span>            <span class="nx">wp</span><span class="p">.</span><span class="nf">workerFunc</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
            <span class="c1">// 处理完之后重新放回到对象池中
</span><span class="c1"></span>            <span class="nx">wp</span><span class="p">.</span><span class="nx">workerChanPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">vch</span><span class="p">)</span>
        <span class="p">}()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The getCh method first fetches a workerChan from the ready free queue, or from the object pool if it is not available, and the new workerChan from the object pool starts the Goroutine to process the data in the channel.</p>
<h4 id="handling-connections-1">Handling connections</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="o">*</span><span class="nx">workerPool</span><span class="p">)</span> <span class="nf">workerFunc</span><span class="p">(</span><span class="nx">ch</span> <span class="o">*</span><span class="nx">workerChan</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>

    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="c1">// 消费 channel 中的数据
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">c</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">ch</span><span class="p">.</span><span class="nx">ch</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
        <span class="c1">// 读取请求数据并响应返回
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">wp</span><span class="p">.</span><span class="nf">WorkerFunc</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">errHijacked</span> <span class="p">{</span>
            <span class="o">...</span>
        <span class="p">}</span> 
        <span class="nx">c</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="c1">// 将当前的 workerChan 放入的 ready 队列中
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">wp</span><span class="p">.</span><span class="nf">release</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">wp</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="nx">wp</span><span class="p">.</span><span class="nx">workersCount</span><span class="o">--</span>
    <span class="nx">wp</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This loop iterates over the Connection in the channel where the workerChan was fetched and then executes the WorkerFunc function to process the request, after which the current workerChan is put back into the ready queue for reuse.</p>
<p>Note that this loop will jump out of the loop when the Connection is nil, which is the nil that the workerPool will pass to the channel when it checks that the workerChan has been idle for too long by calling the clean method asynchronously.</p>
<p>The workerFunc function set here is the Server&rsquo;s serveConn method, which will get the parameters of the request, then call the corresponding handler to process the request according to the request, and return the response.</p>
<h2 id="summary-1">Summary</h2>
<p>We have analyzed the implementation principle of fasthttp here, through the principle we can know the difference between fasthttp and <code>net/http</code> in terms of implementation, so we can roughly conclude the reason why fasthttp is fast, and then from its implementation details we can know how it is implemented to reduce memory allocation and thus improve performance.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/fasthttp/">fasthttp</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/go-http/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Analysis of the Go language HTTP standard library</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/endless-restart/">
            <span class="next-text nav-default">How does endless achieve a non-stop restart of Go programs?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
