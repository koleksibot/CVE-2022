<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Some new features in browsers and JavaScript - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="CookieStore API Currently, browsers can store cookie/sessionStorage/localStorage/IndexedDB, all of which expose a very developer friendly API, except for cookies. Think back to how we normally manipulate cookies. For example, if you want to retrieve a cookie, you have to parse it manually to get the value of a cookie because document.cookie returns a string that is the union of all cookies. If you want to add a cookie, then you" /><meta name="keywords" content="browser, javascript, New Features" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/new-features-of-browser-and-js/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Some new features in browsers and JavaScript" />
<meta property="og:description" content="CookieStore API Currently, browsers can store cookie/sessionStorage/localStorage/IndexedDB, all of which expose a very developer friendly API, except for cookies. Think back to how we normally manipulate cookies. For example, if you want to retrieve a cookie, you have to parse it manually to get the value of a cookie because document.cookie returns a string that is the union of all cookies. If you want to add a cookie, then you" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/new-features-of-browser-and-js/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-17T09:56:15+08:00" />
<meta property="article:modified_time" content="2022-01-17T09:56:15+08:00" />

<meta itemprop="name" content="Some new features in browsers and JavaScript">
<meta itemprop="description" content="CookieStore API Currently, browsers can store cookie/sessionStorage/localStorage/IndexedDB, all of which expose a very developer friendly API, except for cookies. Think back to how we normally manipulate cookies. For example, if you want to retrieve a cookie, you have to parse it manually to get the value of a cookie because document.cookie returns a string that is the union of all cookies. If you want to add a cookie, then you"><meta itemprop="datePublished" content="2022-01-17T09:56:15+08:00" />
<meta itemprop="dateModified" content="2022-01-17T09:56:15+08:00" />
<meta itemprop="wordCount" content="4827">
<meta itemprop="keywords" content="browser,javascript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Some new features in browsers and JavaScript"/>
<meta name="twitter:description" content="CookieStore API Currently, browsers can store cookie/sessionStorage/localStorage/IndexedDB, all of which expose a very developer friendly API, except for cookies. Think back to how we normally manipulate cookies. For example, if you want to retrieve a cookie, you have to parse it manually to get the value of a cookie because document.cookie returns a string that is the union of all cookies. If you want to add a cookie, then you"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Some new features in browsers and JavaScript</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-17 09:56:15 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 4827 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#cookiestore-api">CookieStore API</a>
          <ul>
            <li><a href="#compatibility-and-reference">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#media-session-api">Media Session API</a>
          <ul>
            <li><a href="#compatibility-and-reference-1">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#shape-detection-api">Shape Detection API</a>
          <ul>
            <li><a href="#compatibility-and-reference-2">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#top-level-await">Top-level await</a>
          <ul>
            <li><a href="#conditional-introduction-of-modules">Conditional introduction of modules</a></li>
            <li><a href="#dependency-fallback">Dependency fallback</a></li>
            <li><a href="#resource-initialization">Resource initialization</a></li>
            <li><a href="#compatibility-and-reference-3">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#bigint">BigInt</a>
          <ul>
            <li><a href="#compatibility-and-reference-4">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#number-separators">Number separators</a>
          <ul>
            <li><a href="#compatibility-and-references">Compatibility and references</a></li>
          </ul>
        </li>
        <li><a href="#new-syntax-for-css-colour-methods">New syntax for CSS colour methods</a>
          <ul>
            <li><a href="#compatibility-and-references-1">Compatibility and references</a></li>
          </ul>
        </li>
        <li><a href="#aspect-ratio">aspect-ratio</a>
          <ul>
            <li><a href="#compatibility-and-reference-5">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#gap">gap</a>
          <ul>
            <li><a href="#compatibility-and-reference-6">Compatibility and reference</a></li>
          </ul>
        </li>
        <li><a href="#css-math-functions">CSS math functions</a>
          <ul>
            <li><a href="#compatibility-and-reference-7">Compatibility and reference</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="cookiestore-api">CookieStore API</h2>
<p>Currently, browsers can store <code>cookie</code>/<code>sessionStorage</code>/<code>localStorage</code>/<code>IndexedDB</code>, all of which expose a very developer friendly API, except for cookies. Think back to how we normally manipulate cookies. For example, if you want to retrieve a cookie, you have to parse it manually to get the value of a cookie because <code>document.cookie</code> returns a string that is the union of all cookies.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/ed95a046261b47f482f2d001c0c6857d.png" alt="image"></p>
<p>If you want to add a cookie, then you need to convert the cookie to a string and assign it to <code>document.cookie</code> as below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/e1d0c008a6454b4ba8cf7752d429d2aa.png" alt="image"></p>
<p>Isn&rsquo;t it strange that <code>document.cookie</code> is a collection of all cookies, but adding a cookie is a direct assignment to <code>document.cookie</code>? Another oddity is that sometimes adding a cookie doesn&rsquo;t work at all, but the browser doesn&rsquo;t give any error messages, so you have to use <code>getCookie</code> after <code>setCookie</code> to see if it works.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">setCookie</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">getCookie</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;success to setCookie&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fail to setCookie&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, deleting a cookie is even stranger, as we cannot just delete it, but let it expire.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/0c52a9a0d6c9477dabc194326b81cb9c.png" alt="image"></p>
<p>A new CookieStore API has been introduced based on the above issues.</p>
<p>First, a <code>cookieStore</code> object is added to the window, and then <code>get/set/delete</code> methods are mounted on the <code>cookieStore</code> object for the <code>get/add/delete</code> operations of a single cookie. Note that <code>get/set/delete</code> all return a <code>Promise</code>, so exceptions need to be handled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/** 获取一个 cookie */</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// 根据 name 获取
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
  <span class="c1">// 获取根据条件获取
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span>
    <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;xxx&#39;</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cookie</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;name is a emtpy cookie&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
    <span class="cm">/**
</span><span class="cm">     * cookie 包含以下字段
</span><span class="cm">     * { domain, expires, name, path, sameSite, secure, value }
</span><span class="cm">     * 如果某些字段未设置则为 null
</span><span class="cm">     */</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do with error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/** 添加一个 cookie, 修改一个 cookie 跟之前一样通过覆盖实现 */</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="cm">/**
</span><span class="cm">   * 可配置的字段如下
</span><span class="cm">   * { domain, expires, name, path, sameSite, secure, value }
</span><span class="cm">   */</span>
  <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
    <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
    <span class="nx">expires</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="c1">// 一天后过期
</span><span class="c1"></span>  <span class="p">});</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do with error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/** 删除一个 cookie */</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do with error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The cookieStore also provides the <code>getAll</code> method, which is used to obtain a list of cookies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">try</span> <span class="p">{</span>
  <span class="c1">// 根据 name 获取, 因为 cookie 可以存在同名的 cookie
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cookieList</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
  <span class="c1">// 或者根据条件获取
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cookieList</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">getAll</span><span class="p">({</span>
    <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;xxx&#39;</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="c1">// 如果没有条件, 则返回所有 cookie
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">cookieList</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">getAll</span><span class="p">();</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do with error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Previously, the only way to listen for cookie changes was to check for them at regular intervals using a timer, but <code>cookieStore</code> provides the ability to listen for cookie changes directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">addEventlistener</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span>
    <span class="nx">changed</span><span class="p">,</span> <span class="c1">// 发生变化的 cookie 数组
</span><span class="c1"></span>    <span class="nx">deleted</span><span class="p">,</span> <span class="c1">// 删除的 cookie 数组
</span><span class="c1"></span>  <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">;</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="compatibility-and-reference">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=cookieStore">Can I use</a></li>
<li><a href="https://medium.com/nmc-techblog/introducing-the-async-cookie-store-api-89cbecf401f">Introducing: The Async Cookie Store API</a></li>
<li><a href="https://wicg.github.io/cookie-store">Cookie Store API</a></li>
</ul>
<h2 id="media-session-api">Media Session API</h2>
<p>If you want to control <code>audio</code>/<code>video</code> on a page, you can only do so by using the browser&rsquo;s own control component or by implementing your own control component, and you will not be able to control <code>audio</code>/<code>video</code> when the page is unclickable (e.g. switching to another tab or minimizing the browser window).</p>
<p>The <code>Media Session API</code> exposes control of the page <code>audio</code>/<code>video</code>, enabling the system media centre to control the page <code>audio</code>/<code>video</code>, including basic information about the media being played (title/author/cover) and actions (play/pause/fast forward/fast rewind/next media/previous media).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">JpegInsomnia</span> <span class="nx">from</span> <span class="s2">&#34;./static/insomnia_flight.jpeg&#34;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">audio</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;audio&#34;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="s2">&#34;mediaSession&#34;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// eslint-disable-next-line
</span><span class="c1"></span>  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MediaMetadata</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;失眠飞行&#34;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s2">&#34;接个吻，开一枪,沈以诚,薛明媛&#34;</span><span class="p">,</span>
    <span class="nx">artwork</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">src</span><span class="o">:</span> <span class="nx">JpegInsomnia</span><span class="p">,</span> <span class="nx">sizes</span><span class="o">:</span> <span class="s2">&#34;512x512&#34;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;image/jpeg&#34;</span> <span class="p">}]</span>
  <span class="p">});</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;play&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">audio</span><span class="p">.</span><span class="nx">play</span><span class="p">());</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;pause&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">audio</span><span class="p">.</span><span class="nx">pause</span><span class="p">());</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;seekbackward&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;快退&#34;</span><span class="p">));</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;seekforward&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;快进&#34;</span><span class="p">));</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;previoustrack&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;上一首&#34;</span><span class="p">)</span>
  <span class="p">);</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaSession</span><span class="p">.</span><span class="nx">setActionHandler</span><span class="p">(</span><span class="s2">&#34;nexttrack&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;下一首&#34;</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;Your browser do not support mediaSession&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://codesandbox.io/s/mediasession-888j0?from-embed">Open SandBox</a></p>
<p>The above example implements a basic <code>MediaSession</code>. The basic information is instantiated by the global object <code>MediaMetadata</code>, where <code>artwork</code> can be set to multiple values, and the browser automatically selects the best size for the scene, which is then assigned to <code>navigator.mediaSession.metadata</code>. Media control is set via the <code>navigator.mediaSession.setActionHandler</code> method, with <code>play</code>/<code>pause</code>/<code>seekbackward</code>/<code>seekforward</code>/<code>previoustrack</code>/<code>nexttrack</code> corresponding to <code>play</code>/<code>pause</code>/<code>nexttrack</code> respectively. play<code>/</code>pause<code>/</code>seekbackward<code>/</code>seekforward<code>/</code>previoustrack<code>/</code>nexttrack` operations. Once the media has been played, the browser maps the basic information and actions to the system and provides the corresponding action menus in the system.</p>
<p>Under Windows 10, for example, the Media Control Panel appears near the volume control.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/1036042c7e45469bbb15f412160eadc0.png" alt="image"></p>
<p>On Android, the Media Control Panel will appear in the status bar.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/35319e1b99f34f479c6d3811881a7165.png" alt="image"></p>
<p>The Media Control Panel also appears in the header of some browsers.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/0d688879fdf04afd85dd2f0f977927ab.png" alt="image"></p>
<h3 id="compatibility-and-reference-1">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=mediaSession">Can I use </a></li>
<li><a href="https://developer.mozilla.org/docs/Web/API/Media_Session_API">Media Session API</a></li>
<li><a href="https://w3c.github.io/mediasession/#the-mediasession-interface">Media Session Standard</a></li>
</ul>
<h2 id="shape-detection-api">Shape Detection API</h2>
<p>QR codes are everywhere nowadays, but recognising them on the web is not an easy task, either by uploading them to the backend for parsing or by using complex <a href="https://github.com/cozmo/jsQR">JS libraries</a>. The new <code>BarcodeDetector</code> feature provides a user-friendly API to recognize QR codes locally without the backend.</p>
<p>To use <code>BarcodeDetector</code> you first need to instantiate it, and then pass the image data to the <code>detect</code> method of the instance, which is an asynchronous operation, so the return value is a <code>Promise</code>. Also, a single image may contain multiple QR codes, so the result is an array.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/* global BarcodeDetector */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&#34;BarcodeDetector&#34;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;Your browser do not support BarcodeDetector.&#34;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">loadImage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">);</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">img</span><span class="p">);</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`Can not load image from &#39;</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">&#39;.`</span><span class="p">));</span>
    <span class="p">});</span>

  <span class="kr">const</span> <span class="nx">localDetectButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#local-detect&#34;</span><span class="p">);</span>
  <span class="nx">localDetectButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">localDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">localDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别中...&#34;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">barcodeDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BarcodeDetector</span><span class="p">();</span>
      <span class="kr">const</span> <span class="nx">barcodes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">barcodeDetector</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#local-img&#34;</span><span class="p">)</span>
      <span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;识别结果:&#34;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">barcodes</span><span class="p">);</span>
      <span class="nx">alert</span><span class="p">(</span><span class="sb">`识别结果: </span><span class="si">${</span><span class="nx">barcodes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rawValue</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">localDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">localDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别左侧二维码&#34;</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="kr">const</span> <span class="nx">uploadInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#upload&#34;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">uploadDetectButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#upload-detect&#34;</span><span class="p">);</span>

  <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">uploadInput</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别中...&#34;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">image</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loadImage</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">barcodeDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BarcodeDetector</span><span class="p">();</span>
      <span class="kr">const</span> <span class="nx">barcodes</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">barcodeDetector</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;识别结果:&#34;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">barcodes</span><span class="p">);</span>
      <span class="nx">alert</span><span class="p">(</span><span class="sb">`识别结果: </span><span class="si">${</span><span class="nx">barcodes</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rawValue</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&#34;, &#34;</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别二维码&#34;</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p><a href="https://codesandbox.io/s/barcodedetector-h2ngg?from-embed">Open SandBox</a></p>
<p><code>BarcodeDetector</code> not only recognises 2D codes, but also supports various barcode formats, including <code>aztec</code> / <code>code_128</code> / <code>code_39</code> / <code>code_93</code> / <code>codabar</code> / <code>data_matrix</code> / <code>ean_13</code> / <code>ean_8</code> / <code>itf</code> / <code>pdf417</code> / <code>qr_code</code> / <code>upc_a</code> / <code>upc_e</code> . <code>BarcodeDetector</code> recognises all barcode formats by default, if you only want to recognise certain formats, you can specify this when instantiating:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">detector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BarcodeDetector</span><span class="p">({</span>
  <span class="nx">formats</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;qr_code&#39;</span><span class="p">,</span> <span class="s1">&#39;codabar&#39;</span><span class="p">],</span> <span class="c1">// 只识别图片中的 qr_code 和 codebar
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>BarcodeDetector</code> is part of the <code>Shape Detection API</code>, in addition to the <code>TextDetector</code> and the <code>FaceDetector</code>, which correspond to text recognition and face recognition respectively, the following is an example of text recognition</p>
<blockquote>
<p><code>TextDetector</code> is not yet stable, so it may not be able to recognize text on canvas, and uploaded images may not be recognized accurately.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/* global fabric, TextDetector */</span>
<span class="kr">import</span> <span class="s2">&#34;./index.scss&#34;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&#34;TextDetector&#34;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;Your browser do not support TextDetector.&#34;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">loadImage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">);</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">img</span><span class="p">);</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`Can not load image from &#39;</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">&#39;.`</span><span class="p">));</span>
    <span class="p">});</span>

  <span class="kr">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">fabric</span><span class="p">.</span><span class="nx">Canvas</span><span class="p">(</span><span class="s2">&#34;canvas&#34;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">isDrawingMode</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">width</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="nx">height</span><span class="o">:</span> <span class="mi">250</span>
  <span class="p">});</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">freeDrawingBrush</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">canvasDetectButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#canvas-detect&#34;</span><span class="p">);</span>

  <span class="nb">document</span>
    <span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#clear&#34;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">clear</span><span class="p">());</span>
  <span class="nx">canvasDetectButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">canvasDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">canvasDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别中...&#34;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">dataUrl</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">({</span> <span class="nx">format</span><span class="o">:</span> <span class="s2">&#34;png&#34;</span> <span class="p">});</span>
      <span class="kr">const</span> <span class="nx">image</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loadImage</span><span class="p">(</span><span class="nx">dataUrl</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">texts</span> <span class="o">=</span> <span class="kr">await</span> <span class="k">new</span> <span class="nx">TextDetector</span><span class="p">().</span><span class="nx">detect</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;识别结果:&#34;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">texts</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">canvasDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">canvasDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别文本&#34;</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="kr">const</span> <span class="nx">uploadDetectButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#upload-detect&#34;</span><span class="p">);</span>
  <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">uploadFile</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;#upload&#34;</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">uploadFile</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别中...&#34;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">uploadFile</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">image</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loadImage</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">texts</span> <span class="o">=</span> <span class="kr">await</span> <span class="k">new</span> <span class="nx">TextDetector</span><span class="p">().</span><span class="nx">detect</span><span class="p">(</span><span class="nx">image</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;识别结果:&#34;</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">texts</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">uploadDetectButton</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&#34;识别文本&#34;</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p><a href="https://codesandbox.io/s/textdetector-3ilx8?from-embed">Open SandBox</a></p>
<h3 id="compatibility-and-reference-2">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=barcodedetector">Can I use</a></li>
<li><a href="https://wicg.github.io/shape-detection-api">Accelerated Shape Detection in Images</a></li>
<li><a href="https://web.dev/shape-detection">The Shape Detection API: a picture is worth a thousand words, faces, and barcodes</a></li>
</ul>
<h2 id="top-level-await">Top-level await</h2>
<p>Previously the <code>await</code> keyword was only allowed inside the <code>async function</code>, <code>top-level await</code> allows us to use the <code>await</code> keyword directly outside the <code>async function</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// module-a.js
</span><span class="c1"></span><span class="p">(</span><span class="kr">async</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">axios</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;https://registry.npm.taobao.org/react&#39;</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// react
</span><span class="c1"></span><span class="p">})();</span>
</code></pre></td></tr></table>
</div>
</div><p>Use the script above <code>top-level await</code> to directly remove the <code>async function</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// module-a.js
</span><span class="c1"></span><span class="kr">const</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">axios</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;https://registry.npm.taobao.org/react&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// react
</span></code></pre></td></tr></table>
</div>
</div><p>If a module uses <code>top-level await</code> , then other modules that refer to it will wait for it to <code>resolve</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// a.js
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kr">const</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">axios</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;https://registry.npm.taobao.org/react&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

<span class="c1">// b.js
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">name</span> <span class="nx">from</span> <span class="s1">&#39;./a.js&#39;</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// react
</span></code></pre></td></tr></table>
</div>
</div><p>In the above code, the output order is <code>1 2 react</code>, which means that the b module will wait for the a module to <code>resolve</code> before it continues to execute. Similarly, when the a module <code>reject</code>, the b module will not work properly. For the b module to work properly, an error handler needs to be added to the a module.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// a.js
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;default name&#39;</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">axios</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;https://registry.npm.taobao.org/react&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do with error
</span><span class="c1"></span><span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">name</span><span class="p">;</span>

<span class="c1">// b.js
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">name</span> <span class="nx">from</span> <span class="s1">&#39;./a.js&#39;</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// 没有发生错误输出 react, 发生错误输出 default name
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>top-level await</code> is ideal for certain scenarios.</p>
<h3 id="conditional-introduction-of-modules">Conditional introduction of modules</h3>
<p>We know that <code>static import</code> does not allow for conditional import, for example the following code is not legal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">import</span> <span class="nx">a</span> <span class="nx">from</span> <span class="s1">&#39;a.js&#39;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="kr">import</span> <span class="nx">a</span> <span class="nx">from</span> <span class="s1">&#39;a_development.js&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Conditional static imports can be simulated by using <code>top-level await</code> in conjunction with <code>dynamic import</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">a</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;a.js&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;a_development.js&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="dependency-fallback">Dependency fallback</h3>
<p>When we introduce a static module, if the module fails to load, then all other modules that reference it will not work properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">$</span> <span class="nx">from</span> <span class="s1">&#39;https://cdn.example.com/jquery.js&#39;</span><span class="p">;</span>

<span class="c1">// 如果 https://cdn.example.com/jquery.js 加载失败, 那么下面的代码都无法正常工作
</span><span class="c1">// do with $
</span></code></pre></td></tr></table>
</div>
</div><p>Dependency fallback can be achieved with <code>top-level await</code> and <code>dynamic import</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// jquery_wrapper.js
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">$</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nx">$</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;https://cdn_a.example_a.com/jquery.js&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span> <span class="o">=</span> <span class="kr">await</span> <span class="kr">import</span><span class="p">(</span><span class="s1">&#39;https://cdn_b.example_b.com/jquery.js&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">$</span><span class="p">;</span>

<span class="c1">// example.js
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">$</span> <span class="nx">from</span> <span class="s1">&#39;path_to/jquery_wrapper.js&#39;</span><span class="p">;</span>

<span class="c1">// do with $
</span></code></pre></td></tr></table>
</div>
</div><h3 id="resource-initialization">Resource initialization</h3>
<p>Previously, when a resource needed to be initialized asynchronously, it was usually written in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// ws.js
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">ws</span><span class="p">;</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">getWs</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getUrl</span><span class="p">();</span>
    <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Websocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ws</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">sendMessage</span><span class="o">:</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getWs</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note that the above code is only an example, there is a lot of error handling required in practice</p>
</blockquote>
<p>In the above code, the synchronous <code>sendMessage</code> method is forced to become asynchronous by the asynchronous <code>getWs</code> method, which can be avoided by using <code>top-level await</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getUrl</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Websocket</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">ws</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="compatibility-and-reference-3">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=top-level%20await">Can I use</a></li>
<li><a href="https://github.com/tc39/proposal-top-level-await">tc39/proposal-top-level-await</a></li>
</ul>
<h2 id="bigint">BigInt</h2>
<p>In JavaScript, the range of integers is <code>[Number.MIN_SAFE_INTEGER, Number.MAX_SAFE_INTEGER]</code>, which is from the 53rd power of minus 2 minus 1 to the 53rd power of 2 minus 1, outside of which precision is not guaranteed, for example:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/36b28228afc3483ca4af031a262eefce.png" alt="image"></p>
<p>If you want to accurately represent integers beyond SAFE_INTEGER, it is common to convert them to strings and then implement various string operations (I&rsquo;m sure many of you have done the algorithm for adding strings of numbers, e.g. <code>'123' + '789' = '912'</code>).</p>
<p><code>BigInt</code> can represent an arbitrarily large integer, even if it is outside the range of <code>SAFE_INTEGER</code>, to ensure precision. A <code>BigInt</code> can be declared by adding <code>n</code> to the number or by using the <code>BigInt</code> method:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">123</span><span class="nx">n</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="s1">&#39;123&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>The above <code>a</code> / <code>b</code> / <code>c</code> all represent <code>123n</code> . <code>BigInt</code> supports the <code>+</code> / <code>-</code> / <code>*</code> / <code>/</code> / <code>**</code> / <code>%</code> operators, but cannot be mixed with other types:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">2</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 3n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 1n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">3</span><span class="nx">n</span> <span class="o">*</span> <span class="mi">3</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 9n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="mi">4</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 2n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">e</span> <span class="o">=</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">**</span> <span class="mi">2</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 4n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="mi">5</span><span class="nx">n</span> <span class="o">%</span> <span class="mi">3</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 2n
</span><span class="c1"></span>
<span class="cm">/** 除数不能为 0n */</span>
<span class="kr">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// Uncaught RangeError: Division by zero
</span><span class="c1"></span>
<span class="cm">/** 不能与其他类型运算 */</span>
<span class="kr">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Uncaught TypeError: Cannot mix BigInt and other types
</span><span class="c1"></span>
<span class="cm">/** 运算结果将会忽略小数 */</span>
<span class="kr">const</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">3</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// 1n
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// -1n
</span></code></pre></td></tr></table>
</div>
</div><p><code>BigInt</code> can be converted to number, and if <code>BigInt</code> exceeds the range of <code>SAFE_INTER</code>, then the converted number will lose precision:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_SAFE_INTEGER</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">a</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span> <span class="c1">// c 不能保证准确
</span></code></pre></td></tr></table>
</div>
</div><p><code>BigInt</code> also supports comparison operations, and can be compared with number:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/** 与 number 不严格相等 */</span>
<span class="mi">1</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// true
</span><span class="c1"></span><span class="mi">1</span><span class="nx">n</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// false
</span><span class="c1"></span>
<span class="mi">2</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// true
</span><span class="c1"></span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span> <span class="c1">// true
</span><span class="c1"></span><span class="mi">2</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// true
</span></code></pre></td></tr></table>
</div>
</div><p><code>BigInt</code> also has some limitations, firstly it does not support calling methods on <code>Math</code> objects, and secondly it does not support <code>JSON.stringify</code>, so if you want to serialize it, you can implement the <code>toJSON</code> method of <code>BigInt</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">BigInt</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// BigInt toString 不会带上 n, 例如 2n.toString() === &#39;2&#39;
</span><span class="c1"></span>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">value</span><span class="o">:</span> <span class="mi">2</span><span class="nx">n</span> <span class="p">});</span> <span class="c1">// { &#34;value&#34;: &#34;2&#34; }
</span></code></pre></td></tr></table>
</div>
</div><p>Note that <code>BigInt</code> is a normal method like <code>Symbol</code>, not a constructor, so it cannot be instantiated by <code>new</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// Uncaught TypeError: BigInt is not a constructor
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>JavaScript has 7 data types <code>undefined</code> / <code>null</code> / <code>boolean</code> / <code>number</code> / <code>string</code> / <code>symbol</code> / <code>object</code> , <code>BigInt</code> is the 8th data type, the value of <code>typeof 1n</code> is <code>bigint</code> , and is a basic type.</p>
</blockquote>
<h3 id="compatibility-and-reference-4">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=bigint">Can I use</a></li>
<li><a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/BigInt">BigInt - JavaScript | MDN</a></li>
</ul>
<h2 id="number-separators">Number separators</h2>
<p>Often, if a number is unusually large, we add separators to the display to make it more readable:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/17/b5aff64f0dc4418999507c428d53087f.png" alt="image"></p>
<blockquote>
<p>is now usually a thousand-digit separator, supposedly derived from the English thousond/million/billion/trillion/&hellip;, with a proper noun for each additional 3 digits (<a href="https://en.wikipedia.org/wiki/Namesoflarge_numbers)">https://en.wikipedia.org/wiki/Namesoflarge_numbers)</a>. For me it&rsquo;s more of a ten-thousand separator, probably because I got used to it in primary school maths.</p>
</blockquote>
<p>But at JavaScript level, we can only concatenate numbers no matter how big they are, e.g. <code>1032467823482.32134324</code>, which requires careful counting to get the exact value.</p>
<p>Now, the <code>Numeric separators</code> feature allows the insertion of <code>_</code> separators between numeric literals to make them more readable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">123_456</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mf">123.345</span><span class="nx">_789</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>_</code> The separator can appear in the integer part, or in the decimal part. In addition to decimal, separators can also appear in other decimal systems</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b101</span><span class="nx">_101</span><span class="p">;</span> <span class="c1">// 二进制
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mo">0o765</span><span class="nx">_432</span><span class="p">;</span> <span class="c1">// 八进制
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="mh">0xfed</span><span class="nx">_dba_987</span><span class="p">;</span> <span class="c1">// 十六进制
</span></code></pre></td></tr></table>
</div>
</div><p>The above code adds separators every 3 digits, however, it is important to note that separators can only be added between numbers, not at the beginning/end of numbers/binary symbols/decimal points/scientific notation, and not two separators in a row, as the following separator positions are wrong.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">_123</span><span class="p">;</span> <span class="c1">// 开头, 这其实是一个合法的变量名
</span><span class="c1"></span><span class="mi">123_</span><span class="p">;</span> <span class="c1">// 结尾
</span><span class="c1"></span>
<span class="cm">/** 进制标志 */</span>
<span class="mi">0_</span><span class="nx">b101</span><span class="p">;</span> <span class="c1">// 进制中间
</span><span class="c1"></span><span class="mi">0</span><span class="nx">x_fd9</span><span class="p">;</span> <span class="c1">// 进制后面
</span><span class="c1"></span>
<span class="cm">/** 科学计数法 */</span>
<span class="mf">1.23</span><span class="nx">_e14</span><span class="p">;</span> <span class="c1">// 科学计数法前面
</span><span class="c1"></span><span class="mf">1.23</span><span class="nx">e_14</span><span class="p">;</span> <span class="c1">// 科学计数法后面
</span><span class="c1"></span>
<span class="mi">123__456</span><span class="p">;</span> <span class="c1">// 连续两个分隔符
</span></code></pre></td></tr></table>
</div>
</div><p>The number separator is only there to improve readability and has no real meaning; numbers with a separator are converted to strings without the separator. Similarly, strings with <code>_</code> are not converted to numbers correctly</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="mi">123_456</span><span class="p">.</span><span class="mi">123_456</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span> <span class="c1">// 123456.123456
</span><span class="c1"></span><span class="nb">Number</span><span class="p">(</span><span class="s1">&#39;123_456.123_456&#39;</span><span class="p">);</span> <span class="c1">// NaN
</span><span class="c1"></span><span class="nb">Number</span><span class="p">.</span><span class="nb">parseInt</span><span class="p">(</span><span class="s1">&#39;123_456&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">// 123
</span><span class="c1"></span><span class="nb">Number</span><span class="p">.</span><span class="nb">parseFloat</span><span class="p">(</span><span class="s1">&#39;123_456.123_456&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">// 123
</span></code></pre></td></tr></table>
</div>
</div><p>In addition, the number separator also applies to the <code>BigInt</code> mentioned above.</p>
<h3 id="compatibility-and-references">Compatibility and references</h3>
<ul>
<li><a href="https://caniuse.com/?search=Numeric%20separators">Can I use</a></li>
<li><a href="https://tc39.es/proposal-numeric-separator/">Numeric separators</a></li>
<li><a href="https://2ality.com/2018/02/numeric-separators.html">ECMAScript feature: numeric separators</a></li>
</ul>
<h2 id="new-syntax-for-css-colour-methods">New syntax for CSS colour methods</h2>
<p>There are 4 <code>colour methods</code> in CSS, <code>rgb</code> / <code>rgba</code> / <code>hsl</code> / <code>hsla</code> . Previously, the arguments to each method were separated by a <code>comma</code>, but now the new syntax for <code>rgb</code> / <code>hsl</code> allows the <code>comma</code> to be omitted and the arguments to be separated by a <code>space</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">color</span><span class="o">:</span> <span class="nx">rgb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="cm">/* 等同于 */</span>
<span class="nx">color</span><span class="o">:</span> <span class="nx">rgb</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">);</span>

<span class="nx">color</span><span class="o">:</span> <span class="nx">hsl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">%</span><span class="p">,</span> <span class="mi">3</span><span class="o">%</span><span class="p">);</span>
<span class="cm">/* 等同于 */</span>
<span class="nx">color</span><span class="o">:</span> <span class="nx">hsl</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="o">%</span> <span class="mi">3</span><span class="o">%</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>While omitting the comma, <code>rgb</code> / <code>hsl</code> both support the 4th parameter, indicating transparency, thereby replacing <code>rgba</code> and <code>hsla</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">color</span><span class="o">:</span> <span class="nx">rgba</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">);</span>
<span class="cm">/* 等同于 */</span>
<span class="nx">color</span><span class="o">:</span> <span class="nx">rgb</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="o">/</span> <span class="mf">0.4</span><span class="p">);</span>

<span class="nx">color</span><span class="o">:</span> <span class="nx">hsla</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">%</span><span class="p">,</span> <span class="mi">3</span><span class="o">%</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">);</span>
<span class="cm">/* 等同于 */</span>
<span class="nx">color</span><span class="o">:</span> <span class="nx">hsl</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="o">%</span> <span class="mi">3</span><span class="o">%</span> <span class="err">/ 0.4);</span>
</code></pre></td></tr></table>
</div>
</div><p>Where, the spaces on either side of <code>/</code> are optional.</p>
<h3 id="compatibility-and-references-1">Compatibility and references</h3>
<ul>
<li><a href="https://caniuse.com/mdn-css_types_color_space_separated_functional_notation">Can I use</a></li>
<li><a href="https://css-tricks.com/no-comma-color-functions-in-css">No-Comma Color Functions in CSS</a></li>
</ul>
<h2 id="aspect-ratio">aspect-ratio</h2>
<p>If you want to achieve a rectangle with a specified ratio, you usually use <code>padding</code>, which takes advantage of the fact that the percentage is calculated based on the width of the parent element, but the real content often needs to be placed in an additional child element and absolute positioning needs to be set:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="c">&lt;!-- 4 / 1 的矩形 --&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">.</span><span class="nc">container</span> <span class="p">{</span>
    <span class="k">padding-bottom</span><span class="p">:</span> <span class="mi">25</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="kc">pink</span><span class="p">;</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">.</span><span class="nc">content</span> <span class="p">{</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="k">height</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;container&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;content&#34;</span><span class="p">&gt;</span>内容内容内容<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>aspect-ratio</code> property allows us to set the aspect ratio of an element directly. The example above using <code>aspect-ratio</code> would look like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">.</span><span class="nc">content</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="kc">pink</span><span class="p">;</span>
    <span class="n">aspect-ratio</span><span class="p">:</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;content&#34;</span><span class="p">&gt;</span>内容内容内容<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="compatibility-and-reference-5">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=aspect-ratio">Can I use</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/aspect-ratio">aspect-ratio - CSS | MDN</a></li>
</ul>
<h2 id="gap">gap</h2>
<p>The <code>grid-gap</code> property can be used to set row-to-row and column-to-column gaps in the <code>grid</code> layout, but now the <code>gap</code> property can be used directly instead of <code>grid-gap</code>, and the <code>gap</code> property adds support for <code>flex</code> and <code>column-count</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Gap</span> <span class="nx">Property</span><span class="o">&lt;</span><span class="err">/title&gt;</span>
    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">&#34;UTF-8&#34;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="err">/head&gt;</span>

  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
      <span class="p">.</span><span class="nx">flex</span><span class="o">-</span><span class="nx">container</span> <span class="p">{</span>
        <span class="nx">background</span><span class="o">:</span> <span class="nx">pink</span><span class="p">;</span>
        <span class="nx">width</span><span class="o">:</span> <span class="mi">300</span><span class="nx">px</span><span class="p">;</span>
        <span class="nx">display</span><span class="o">:</span> <span class="nx">flex</span><span class="p">;</span>
        <span class="nx">flex</span><span class="o">-</span><span class="nx">wrap</span><span class="o">:</span> <span class="nx">wrap</span><span class="p">;</span>
        <span class="nx">gap</span><span class="o">:</span> <span class="mi">20</span><span class="nx">px</span> <span class="mi">10</span><span class="nx">px</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="nx">flex</span><span class="o">-</span><span class="nx">item</span> <span class="p">{</span>
        <span class="nx">background</span><span class="o">:</span> <span class="nx">green</span><span class="p">;</span>
        <span class="nx">width</span><span class="o">:</span> <span class="mi">145</span><span class="nx">px</span><span class="p">;</span>
        <span class="nx">height</span><span class="o">:</span> <span class="mi">20</span><span class="nx">px</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="o">&lt;</span><span class="err">/style&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-container&#34;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;flex-item&#34;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>

    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
      <span class="p">.</span><span class="nx">multi</span><span class="o">-</span><span class="nx">column</span><span class="o">-</span><span class="nx">container</span> <span class="p">{</span>
        <span class="nx">column</span><span class="o">-</span><span class="nx">count</span><span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
        <span class="nx">gap</span><span class="o">:</span> <span class="mi">30</span><span class="nx">px</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="o">&lt;</span><span class="err">/style&gt;</span>
    <span class="o">&lt;</span><span class="nx">p</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;multi-column-container&#34;</span><span class="o">&gt;</span>
      <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">,</span><span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span> <span class="nx">这是一段内容</span><span class="p">,</span>
      <span class="nx">这是一段内容</span><span class="p">.</span>
    <span class="o">&lt;</span><span class="err">/p&gt;</span>
  <span class="o">&lt;</span><span class="err">/body&gt;</span>
<span class="o">&lt;</span><span class="err">/html&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://codesandbox.io/s/gap-qbvxy?from-embed">Open SandBox</a></p>
<h3 id="compatibility-and-reference-6">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=gap">Can I use</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/gap">gap - CSS | MDN</a></li>
</ul>
<h2 id="css-math-functions">CSS math functions</h2>
<p>The <code>calc</code> method can be used to perform mathematical calculations in CSS, and now there are three new methods <code>min</code> / <code>max</code> / <code>clamp</code> .</p>
<p>The <code>min</code> method takes one or more values and returns the smallest of them, e.g. <code>width: min(1vw, 4rem, 80px);</code> , if the width of <code>viewport</code> is equal to <code>800px</code> , then <code>1vw === 8px</code> , <code>4rem === 64px</code> , so the result is <code>width: 1vw;</code> .</p>
<p>The <code>max</code> method takes one or more values and returns the maximum of them, in the example above, the result is <code>width: 80px;</code> .</p>
<p>The <code>clamp</code> method takes 3 values <code>clamp(MIN, VAL, MAX)</code> , from left to right they are min/preferred/max values, if the preferred value is less than the min value then the min value is returned, if it is greater than the max value then the max value is returned, if the preferred value is between the min and max values then the preferred value is returned, the logic can be expressed in JS like this</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">clamp</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 小于最小值的话返回最小值
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">&lt;</span> <span class="nx">min</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">min</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 大于最大值的话返回最大值
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">&gt;</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">max</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 介于最小值和最大值, 返回首选值
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>That is, <code>clamp</code> limits the range of values of <code>VAL</code>, e.g. <code>width: clamp(1rem, 10vw, 2rem);</code> where the width of <code>viewport</code> is equal to <code>800px</code>, the result is <code>width: 2rem;</code> , because <code>(10vw = 80px) &gt; (2rem = 32px)</code> .</p>
<p>Interestingly, <code>min</code> / <code>max</code> / <code>clamp</code> can also be nested with other methods, such as <code>clamp(1rem, calc(10vw - 5px), min(2rem, 20vw))</code> , so <code>clamp</code> can be written as <code>max(MIN, min(VAL, MAX))</code> or <code>min(MAX, max (VAL, MIN))</code> .</p>
<h3 id="compatibility-and-reference-7">Compatibility and reference</h3>
<ul>
<li><a href="https://caniuse.com/?search=CSS%20math%20functions">Can I use </a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/min()">min() - CSS | MDN</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/max()">max() - CSS | MDN</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/clamp()">clamp() - CSS | MDN</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/browser/">browser</a>
          <a href="/tags/javascript/">javascript</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/use-callback-misunderstanding/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Myths about useCallback</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/a-different-way-of-understanding-this-in-javascript/">
            <span class="next-text nav-default">Explaining &#34;this&#34; in JavaScript from a new perspective</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
