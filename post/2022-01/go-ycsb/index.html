<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Exploring Go-YCSB for database benchmarking - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Recently we have been doing a technical selection of databases and inevitably we need to do a benchmark test of the databases so that we can compare the performance of different databases across the board. Cloud Serving Benchmark (YCSB) is a tool developed by Yahoo for basic testing of cloud services. Redis, etc. As a go developer, we used the Go YCSB developed by pingcap for benchmarking purposes. Installation First" /><meta name="keywords" content="golang, YCSB, benchmarking" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/go-ycsb/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Exploring Go-YCSB for database benchmarking" />
<meta property="og:description" content="Recently we have been doing a technical selection of databases and inevitably we need to do a benchmark test of the databases so that we can compare the performance of different databases across the board. Cloud Serving Benchmark (YCSB) is a tool developed by Yahoo for basic testing of cloud services. Redis, etc. As a go developer, we used the Go YCSB developed by pingcap for benchmarking purposes. Installation First" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/go-ycsb/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-21T13:12:54+08:00" />
<meta property="article:modified_time" content="2022-01-21T13:12:54+08:00" />

<meta itemprop="name" content="Exploring Go-YCSB for database benchmarking">
<meta itemprop="description" content="Recently we have been doing a technical selection of databases and inevitably we need to do a benchmark test of the databases so that we can compare the performance of different databases across the board. Cloud Serving Benchmark (YCSB) is a tool developed by Yahoo for basic testing of cloud services. Redis, etc. As a go developer, we used the Go YCSB developed by pingcap for benchmarking purposes. Installation First"><meta itemprop="datePublished" content="2022-01-21T13:12:54+08:00" />
<meta itemprop="dateModified" content="2022-01-21T13:12:54+08:00" />
<meta itemprop="wordCount" content="3987">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploring Go-YCSB for database benchmarking"/>
<meta name="twitter:description" content="Recently we have been doing a technical selection of databases and inevitably we need to do a benchmark test of the databases so that we can compare the performance of different databases across the board. Cloud Serving Benchmark (YCSB) is a tool developed by Yahoo for basic testing of cloud services. Redis, etc. As a go developer, we used the Go YCSB developed by pingcap for benchmarking purposes. Installation First"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Exploring Go-YCSB for database benchmarking</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-21 13:12:54 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3987 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#testing">Testing</a></li>
        <li><a href="#code-implementation-analysis">Code Implementation Analysis</a>
          <ul>
            <li><a href="#defining-the-db">Defining the DB</a></li>
            <li><a href="#global-parameter-initialisation">Global parameter initialisation</a></li>
            <li><a href="#running-tests">Running tests</a></li>
            <li><a href="#data-statistics">Data statistics</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently we have been doing a technical selection of databases and inevitably we need to do a benchmark test of the databases so that we can compare the performance of different databases across the board.</p>
<p>Cloud Serving Benchmark (YCSB) is a tool developed by Yahoo for basic testing of cloud services. Redis, etc.</p>
<p>As a go developer, we used the Go YCSB developed by pingcap for benchmarking purposes.</p>
<h2 id="installation">Installation</h2>
<p>First make sure your local Go version is not lower than 1.16, then download and compile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/pingcap/go-ycsb.git
<span class="nb">cd</span> go-ycsb
make
</code></pre></td></tr></table>
</div>
</div><p>In the bin folder is our compiled program go-ycsb.</p>
<p>Let&rsquo;s start by looking at the workloads folder, which contains various workload templates that can be customised based on the workload templates. The default 6 test scenarios are as follows.</p>
<ul>
<li>workloada: Read/write balanced, 50%/50%, Reads/Writes</li>
<li>workloadb: read more/write less, 95%/5%, Reads/Writes</li>
<li>workloadc: read-only, 100%, Reads</li>
<li>workloadd: read recent write record type, 95%/5%, Reads/insert</li>
<li>workloade: scan interval type, 95%/5%, scan/insert</li>
<li>workloadf: read/write in record balanced, 50%/50%, Reads/insert</li>
<li>workload_template: parameter list template.</li>
</ul>
<p>So we can test the system in multiple dimensions according to different workloads, which include the following operations</p>
<ul>
<li>Insert: inserts a new record</li>
<li>Update: update one or all fields of a record</li>
<li>Read: reads one or all fields of a record</li>
<li>Scan: randomly scans random rows in sequence starting with a key</li>
</ul>
<p>When testing, we also need to simulate the test according to different business scenarios, which can be controlled by requestdistribution.</p>
<ul>
<li>uniform: random selection of a record.</li>
<li>sequential: selects records sequentially.</li>
<li>zipfian: selects records according to the zipfian distribution. Roughly, this means the 80/20 principle, which is often referred to on the Internet, i.e. 20% of the keys will take up 80% of the accesses.</li>
<li>latest: similar to Zipfian, but tends to access significantly more new data than old data.</li>
<li>hotspot: hotspot distribution of accesses.</li>
<li>exponential: exponentially distributed accesses.</li>
</ul>
<p>Here we look at what parameters can be filled in the workload.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># 目前只实现了这一种
workload=core

# 总记录数
recordcount=1000000

# 测试阶段被操作的记录数，如果设置了 threadcount，那么每个线程操作的记录数=operationcount/threadcount
operationcount=3000000

# 线程数
threadcount=500 

# 如果一个表里面已经有记录数了，那么load的数据的时候从这个记录数开始
insertstart=0

# 一行数据的字段数
fieldcount=10

# 每个字段大小
fieldlength=100

# 是否应该读取所有字段
readallfields=true

# 是否应该更新所有字段
writeallfields=false

# 字段长度分布
fieldlengthdistribution=constant
#fieldlengthdistribution=uniform
#fieldlengthdistribution=zipfian

# 读操作概率
readproportion=0.95 
# 更新操作概率
updateproportion=0.05

# 插入操作概率
insertproportion=0 

# 先读后写操作同一条记录概率
readmodifywriteproportion=0

# 范围操作的概率
scanproportion=0

# 范围操作，最大的可操作的记录数
maxscanlength=1000

# 用来选择扫描时访问的记录数量分布情况
scanlengthdistribution=uniform
#scanlengthdistribution=zipfian

# 记录应按顺序插入还是伪随机插入
insertorder=hashed
#insertorder=ordered

# 以什么方式模拟测试
requestdistribution=zipfian
#requestdistribution=uniform
#requestdistribution=latest

# 下面这两种方式时针对requestdistribution为hotspot的时候
# 构成热点集的数据项的百分比
hotspotdatafraction=0.2

# 访问热点集的数据操作百分比
hotspotopnfraction=0.8

# 操作数据的表名
table=usertable

# 延迟测量结果展现形式，暂时没实现
measurementtype=histogram
</code></pre></td></tr></table>
</div>
</div><h2 id="testing">Testing</h2>
<p>For example, we now want to test the performance of redis by first writing a workload.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">recordcount=1000000
operationcount=1000000
workload=core 
readallfields=true 
readmodifywriteproportion=1 
requestdistribution=uniform 
redis.addr=127.0.0.1:6379 
threadcount=50
</code></pre></td></tr></table>
</div>
</div><p>The above workload means that 1 million rows of data are inserted into the library when it is loaded, and the amount of data manipulated is also 1 million, but there are 50 threads, i.e. each thread actually manipulates 20,000 rows of records.</p>
<p>The test uses readmodifywriteproportion, which reads before it writes, and operates on the records in a uniform, or random, way.</p>
<p>First load the data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">./bin/go-ycsb load redis  -P workloads/workloada
</code></pre></td></tr></table>
</div>
</div><p>Then run the test.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">./bin/go-ycsb run redis  -P workloads/workloada
</code></pre></td></tr></table>
</div>
</div><p>Results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">READ_MODIFY_WRITE - Takes<span class="o">(</span>s<span class="o">)</span>: 18.8, Count: 499312, OPS: 26539.8, Avg<span class="o">(</span>us<span class="o">)</span>: 1388, Min<span class="o">(</span>us<span class="o">)</span>: 107, Max<span class="o">(</span>us<span class="o">)</span>: 42760, 99th<span class="o">(</span>us<span class="o">)</span>: 3000, 99.9th<span class="o">(</span>us<span class="o">)</span>: 7000, 99.99th<span class="o">(</span>us<span class="o">)</span>: <span class="m">26000</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Takes(s) : indicates the total time taken for the test.</li>
<li>Count : the number of operation records.</li>
<li>OPS: Operates Per Second, generally the number of operations, not very different from qps.</li>
<li>Avg, Min, Max: average, minimum, maximum time taken for single record operations.</li>
<li>99th, 99.9th, 99.99th: P99, P99.9, P99.99 time delay.</li>
</ul>
<h2 id="code-implementation-analysis">Code Implementation Analysis</h2>
<p>For me, of course, it is important to look at the code and learn how others have written it to help us in our work.</p>
<p>For the Go YCSB, it has a few components.</p>
<ul>
<li>workload: loads the initialization configuration file and creates a thread to execute the test.</li>
<li>client: encapsulates the workload, configuration parameters, DB, etc. and is used to run the tests.</li>
<li>db: configures a bunch of databases that can be executed by the client, executing specific read and write databases.</li>
<li>measurement: a statistics module that counts the number of executions, latency, etc.</li>
</ul>
<p>Let&rsquo;s take a look at redis as an example of what to do if you want to test your own Database.</p>
<h3 id="defining-the-db">Defining the DB</h3>
<p>In Go YCSB, all the DBs are placed under the db directory.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/b9bfadf02b934e15be3e0d1012a9810b.png" alt="sobyte"></p>
<p>So, we can create our own db under this folder and construct a struct that implements the DB interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">DB</span> <span class="kd">interface</span> <span class="p">{</span> 
    <span class="nf">ToSqlDB</span><span class="p">()</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span> 
    <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> 
    <span class="nf">InitThread</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">threadID</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">threadCount</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> 
    <span class="nf">CleanupThread</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> 
    <span class="nf">Read</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> 
    <span class="nf">Scan</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">startKey</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">fields</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> 
    <span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">values</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> 
    <span class="nf">Insert</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">values</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> 
    <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Inside, specific DB operations are defined.</p>
<p>Then a factory needs to be defined to create this DB struct, implementing the DBCreator interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">DBCreator</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Create</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">properties</span><span class="p">.</span><span class="nx">Properties</span><span class="p">)</span> <span class="p">(</span><span class="nx">DB</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then an init function needs to be defined to register the DBCreator when it is started.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ycsb</span><span class="p">.</span><span class="nf">RegisterDBCreator</span><span class="p">(</span><span class="s">&#34;redis&#34;</span><span class="p">,</span> <span class="nx">redisCreator</span><span class="p">{})</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dbCreators</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">DBCreator</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nf">RegisterDBCreator</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">creator</span> <span class="nx">DBCreator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">dbCreators</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;duplicate register database %s&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nx">dbCreators</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">=</span> <span class="nx">creator</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>RegisterDBCreator is called at initialization time to get the DB registered by the init method. In this way Go YCSB implements the customisation of the DB.</p>
<h3 id="global-parameter-initialisation">Global parameter initialisation</h3>
<p>First Go YCSB uses cobra at runtime to execute two different methods depending on whether load or run is passed in.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">runLoadCommandFunc</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">runClientCommandFunc</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">runTransCommandFunc</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">runClientCommandFunc</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This is where the runClientCommandFunc function will be called.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">runClientCommandFunc</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">doTransactions</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dbName</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">// 初始化全局参数
</span><span class="c1"></span>    <span class="nf">initialGlobal</span><span class="p">(</span><span class="nx">dbName</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">doTransFlag</span> <span class="o">:=</span> <span class="s">&#34;true&#34;</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">doTransactions</span> <span class="p">{</span>
            <span class="nx">doTransFlag</span> <span class="p">=</span> <span class="s">&#34;false&#34;</span>
        <span class="p">}</span>
        <span class="nx">globalProps</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">DoTransactions</span><span class="p">,</span> <span class="nx">doTransFlag</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">Changed</span><span class="p">(</span><span class="s">&#34;threads&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We set the threadArg via command line.
</span><span class="c1"></span>            <span class="nx">globalProps</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">ThreadCount</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">threadsArg</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">Changed</span><span class="p">(</span><span class="s">&#34;target&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">globalProps</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">targetArg</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">Changed</span><span class="p">(</span><span class="s">&#34;interval&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">globalProps</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">LogInterval</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">reportInterval</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;***************** properties *****************&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">globalProps</span><span class="p">.</span><span class="nf">Map</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\&#34;%s\&#34;=\&#34;%s\&#34;\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;**********************************************&#34;</span><span class="p">)</span>
    <span class="c1">// 初始化 client
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">globalProps</span><span class="p">,</span> <span class="nx">globalWorkload</span><span class="p">,</span> <span class="nx">globalDB</span><span class="p">)</span>
    <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="c1">// 运行测试
</span><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">globalContext</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Run finished, takes %s\n&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">))</span>
    <span class="c1">// 测试结果输出
</span><span class="c1"></span>    <span class="nx">measurement</span><span class="p">.</span><span class="nf">Output</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The initialisation of the parameters is mainly done inside initialGlobal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">initialGlobal</span><span class="p">(</span><span class="nx">dbName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">onProperties</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="c1">//初始化 measurement
</span><span class="c1"></span>    <span class="nx">measurement</span><span class="p">.</span><span class="nf">InitMeasure</span><span class="p">(</span><span class="nx">globalProps</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">tableName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">tableName</span> <span class="p">=</span> <span class="nx">globalProps</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">TableName</span><span class="p">,</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">TableNameDefault</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 获取 WorkloadCreator
</span><span class="c1"></span>    <span class="nx">workloadName</span> <span class="o">:=</span> <span class="nx">globalProps</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">Workload</span><span class="p">,</span> <span class="s">&#34;core&#34;</span><span class="p">)</span>
    <span class="nx">workloadCreator</span> <span class="o">:=</span> <span class="nx">ycsb</span><span class="p">.</span><span class="nf">GetWorkloadCreator</span><span class="p">(</span><span class="nx">workloadName</span><span class="p">)</span>
    <span class="c1">//创建Workload
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
    <span class="k">if</span> <span class="nx">globalWorkload</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">workloadCreator</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">globalProps</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">util</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;create workload %s failed %v&#34;</span><span class="p">,</span> <span class="nx">workloadName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 获取要被测试的 db
</span><span class="c1"></span>    <span class="nx">dbCreator</span> <span class="o">:=</span> <span class="nx">ycsb</span><span class="p">.</span><span class="nf">GetDBCreator</span><span class="p">(</span><span class="nx">dbName</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">dbCreator</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">util</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;%s is not registered&#34;</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 创建 db 
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">globalDB</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">dbCreator</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">globalProps</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">util</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;create db %s failed %v&#34;</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">globalDB</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">DbWrapper</span><span class="p">{</span><span class="nx">globalDB</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The main thing here is to create the Workload and DB, which will initialise a lot of information in the configuration file.</p>
<h3 id="running-tests">Running tests</h3>
<p>The runClientCommandFunc calls the client&rsquo;s Run method to execute the test.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="nx">threadCount</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">GetInt</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">ThreadCount</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">threadCount</span><span class="p">)</span>
    <span class="nx">measureCtx</span><span class="p">,</span> <span class="nx">measureCancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="nx">measureCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">measureCh</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
        <span class="p">}()</span> 
        <span class="c1">// 这里很有意思，因为有时候我们做数据库是需要初始化数据到缓存里面的
</span><span class="c1"></span>        <span class="c1">// 所以开始的一段时间我们不能计入测试统计中，这里有隔预热时间，可以通过 warmuptime 配置 
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">GetBool</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">DoTransactions</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dur</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">GetInt64</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">WarmUpTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">dur</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 预热完毕
</span><span class="c1"></span>        <span class="nx">measurement</span><span class="p">.</span><span class="nf">EnableWarmUp</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>

        <span class="nx">dur</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">GetInt64</span><span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">LogInterval</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">dur</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="k">defer</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="c1">// 在运行的时候每隔 10 秒输出一次统计信息
</span><span class="c1"></span>            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
                <span class="nx">measurement</span><span class="p">.</span><span class="nf">Output</span><span class="p">()</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">measureCtx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="c1">// 做一些初始化的工作，如mysql需要创建表
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">db</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Initialize workload fail: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">// 根据 threadCount 创建多个线程操作数据库
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">threadCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">threadId</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
            <span class="c1">// 初始化 worker
</span><span class="c1"></span>            <span class="nx">w</span> <span class="o">:=</span> <span class="nf">newWorker</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">threadId</span><span class="p">,</span> <span class="nx">threadCount</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workload</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">db</span><span class="p">)</span>
            <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">InitThread</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">threadId</span><span class="p">,</span> <span class="nx">threadCount</span><span class="p">)</span>
            <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">InitThread</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">threadId</span><span class="p">,</span> <span class="nx">threadCount</span><span class="p">)</span>
            <span class="c1">// 开始跑测试
</span><span class="c1"></span>            <span class="nx">w</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
            <span class="c1">// 跑完测试做清理工作
</span><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">CleanupThread</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">CleanupThread</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
        <span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// 等待测试跑完
</span><span class="c1"></span>    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span> 
    <span class="nf">measureCancel</span><span class="p">()</span>
    <span class="o">&lt;-</span><span class="nx">measureCh</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The first part is to create a thread which will control whether to start the test statistics and then output the statistics every 10 seconds; the second part is to create a thread based on the set threadcount and run the worker to run the test.</p>
<p>The second part is to create a thread according to the set threadcount and run the worker to run the test; the newWorker will set the totalOpCount according to the operationcount to indicate the total number of executions required, and use <code>totalOpCount / int64(threadCount)</code> to set the opCount to indicate the number of records for a single thread operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">worker</span><span class="p">)</span> <span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span> 
    <span class="c1">// 将线程操作分散开来，这样它们就不会同时击中DB了。
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">targetOpsPerMs</span> <span class="p">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">targetOpsPerMs</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Int63n</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">targetOpsTickNs</span><span class="p">)))</span>
    <span class="p">}</span>

    <span class="nx">startTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="c1">// 循环直到操作数达到 opsDone
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">w</span><span class="p">.</span><span class="nx">opCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">w</span><span class="p">.</span><span class="nx">opsDone</span> <span class="p">&lt;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">opCount</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
        <span class="nx">opsCount</span> <span class="o">:=</span> <span class="mi">1</span>
        <span class="c1">// 这里是执行基准测试
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">doTransactions</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">doBatch</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">DoBatchTransaction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">batchSize</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workDB</span><span class="p">)</span>
                <span class="nx">opsCount</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">batchSize</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">DoTransaction</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workDB</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="c1">//  这里是执行 load 数据
</span><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">doBatch</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">DoBatchInsert</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">batchSize</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workDB</span><span class="p">)</span>
                <span class="nx">opsCount</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">batchSize</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workload</span><span class="p">.</span><span class="nf">DoInsert</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">workDB</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 预热完了会进行操作次数的统计
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">measurement</span><span class="p">.</span><span class="nf">IsWarmUpFinished</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">w</span><span class="p">.</span><span class="nx">opsDone</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">opsCount</span><span class="p">)</span>
            <span class="nx">w</span><span class="p">.</span><span class="nf">throttle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">startTime</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">default</span><span class="p">:</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The execution of the benchmark test is left to the DoTransaction method of the workload to determine the execution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">core</span><span class="p">)</span> <span class="nf">DoTransaction</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">db</span> <span class="nx">ycsb</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">state</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">stateKey</span><span class="p">).(</span><span class="o">*</span><span class="nx">coreState</span><span class="p">)</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">r</span>
    <span class="c1">// 根据会根据不同的测试场景，进入到不同的测试分支
</span><span class="c1"></span>    <span class="c1">// Next 方法会根据设置的 readproportion、updateproportion、 scanproportion等概率来获取相应操作类型
</span><span class="c1"></span>    <span class="nx">operation</span> <span class="o">:=</span> <span class="nf">operationType</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">operationChooser</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">r</span><span class="p">))</span>
    <span class="k">switch</span> <span class="nx">operation</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">read</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doTransactionRead</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">update</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doTransactionUpdate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">insert</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doTransactionInsert</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">scan</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doTransactionScan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doTransactionReadModifyWrite</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here the Next method of the operationChooser is called to determine which instruction to execute, the probability of execution being set in the configuration file.</p>
<p>The algorithm is very simple: at initialisation the operationChooser will add the values of the parameters readproportion, updateproportion and scanproportion to the values of the operationChooser in the form of an array, and then check which range the random number falls in by randomising a fractional number from 0 to 1.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/21/9146781c6aa740beb8f261ab6b45949e.png" alt="sobyte"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Discrete</span><span class="p">)</span> <span class="nf">Next</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Rand</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">:=</span> <span class="nb">float64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">d</span><span class="p">.</span><span class="nx">values</span> <span class="p">{</span>
        <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Weight</span>
    <span class="p">}</span>
    <span class="c1">// 随机一个 0~1的小数
</span><span class="c1"></span>    <span class="nx">val</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Float64</span><span class="p">()</span> 
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">d</span><span class="p">.</span><span class="nx">values</span> <span class="p">{</span>
        <span class="nx">pw</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Weight</span> <span class="o">/</span> <span class="nx">sum</span>
        <span class="k">if</span> <span class="nx">val</span> <span class="p">&lt;</span> <span class="nx">pw</span> <span class="p">{</span>
            <span class="nx">d</span><span class="p">.</span><span class="nf">SetLastValue</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Value</span>
        <span class="p">}</span> 
        <span class="nx">val</span> <span class="o">-=</span> <span class="nx">pw</span>
    <span class="p">}</span> 
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;oops, should not get here.&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The implementation of the code is to add up all the values as described above to get sum, and then calculate whether each value accounts for a random value.</p>
<p>Finally, let&rsquo;s look at how doTransactionRead works.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">core</span><span class="p">)</span> <span class="nf">doTransactionRead</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">db</span> <span class="nx">ycsb</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">state</span> <span class="o">*</span><span class="nx">coreState</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">r</span>
    <span class="c1">// 根据我们设置的 requestdistribution 获取一个 key 值
</span><span class="c1"></span>    <span class="nx">keyNum</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">nextKeyNum</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="nx">keyName</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">buildKeyName</span><span class="p">(</span><span class="nx">keyNum</span><span class="p">)</span>

    <span class="c1">//被读取的字段
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">fields</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">readAllFields</span> <span class="p">{</span>
        <span class="c1">// 如果不是读取所有字段，那么根据fieldChooser字段选择器选择一个字段执行
</span><span class="c1"></span>        <span class="nx">fieldName</span> <span class="o">:=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">fieldNames</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">fieldChooser</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">r</span><span class="p">)]</span>
        <span class="nx">fields</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">fields</span><span class="p">,</span> <span class="nx">fieldName</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fields</span> <span class="p">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">fieldNames</span>
    <span class="p">}</span>
    <span class="c1">//调用 db 的read方法
</span><span class="c1"></span>    <span class="nx">values</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">//校验数据完整性
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataIntegrity</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nf">verifyRow</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we first call nextKeyNum to get the key value, which will be obtained according to certain rules based on the requestdistribution parameter we set. Then, after checking which fields need to be read, the Read method of the DbWrapper is called to read the data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="nx">DbWrapper</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 进行测试数据统计
</span><span class="c1"></span>        <span class="nf">measure</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="s">&#34;READ&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">table</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The DbWrapper wraps a layer and uses the defer method to call measure for statistics.</p>
<p>However, the problem I have here is that when reading the data, it is also parsed according to the fields passed in, which also loses some performance, I don&rsquo;t know if this makes sense, like the Read method of redis.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">redis</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">table</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fields</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fields</span><span class="p">))</span>

    <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">table</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">).</span><span class="nf">Result</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="c1">// 反序列化
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">res</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span> 
    <span class="c1">// TODO: filter by fields 
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="data-statistics">Data statistics</h3>
<p>The measure method is called after each operation and the test data is counted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">measure</span><span class="p">(</span><span class="nx">start</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">op</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 计算耗时
</span><span class="c1"></span>    <span class="nx">lan</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">measurement</span><span class="p">.</span><span class="nf">Measure</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s_ERROR&#34;</span><span class="p">,</span> <span class="nx">op</span><span class="p">),</span> <span class="nx">lan</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">measurement</span><span class="p">.</span><span class="nf">Measure</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="nx">lan</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Statistics need to be manipulated in a thread-safe manner as there are multiple threads operating simultaneously.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">histogram</span><span class="p">)</span> <span class="nf">Measure</span><span class="p">(</span><span class="nx">latency</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 这里是 us 微秒
</span><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">latency</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="p">)</span>

    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// 这里转为毫秒ms
</span><span class="c1"></span>    <span class="nx">bound</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="nx">h</span><span class="p">.</span><span class="nx">boundInterval</span><span class="p">)</span>
    <span class="c1">// boundCounts 是一个并发map，用来统计每个时间段（单位：ms）中有多少次操作
</span><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">boundCounts</span><span class="p">.</span><span class="nf">Upsert</span><span class="p">(</span><span class="nx">bound</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ok</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">existedValue</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">newValue</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">existedValue</span> <span class="o">+</span> <span class="nx">newValue</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">newValue</span>
    <span class="p">})</span>
    <span class="c1">// 设置最小时延
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">oldMin</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;=</span> <span class="nx">oldMin</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">min</span><span class="p">,</span> <span class="nx">oldMin</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 设置最大时延
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">oldMax</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="nx">oldMax</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span> <span class="nx">oldMax</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>counting the number of operations per time period (in ms) is done using boundCounts, which is Go YCSB&rsquo;s own implementation of ConcurrentMap for thread safety, to count the number of operations per unit of time.</p>
<p>The maximum and minimum delays are manipulated by CAS, also for thread safety.</p>
<p>After the count, getInfo is called to calculate the elapsed time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">histogram</span><span class="p">)</span> <span class="nf">getInfo</span><span class="p">()</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
    <span class="nx">min</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span>
    <span class="nx">max</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span>
    <span class="nx">sum</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">sum</span><span class="p">)</span>
    <span class="nx">count</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>

    <span class="nx">bounds</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">boundCounts</span><span class="p">.</span><span class="nf">Keys</span><span class="p">()</span>
    <span class="nx">sort</span><span class="p">.</span><span class="nf">Ints</span><span class="p">(</span><span class="nx">bounds</span><span class="p">)</span>

    <span class="nx">avg</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">sum</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">count</span><span class="p">))</span>
    <span class="nx">per99</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="nx">per999</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="nx">per9999</span> <span class="o">:=</span> <span class="mi">0</span>

    <span class="nx">opCount</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">// 计算 P99，P99.9，P99.99
</span><span class="c1"></span>    <span class="c1">// 这里实际上是统计一个占比
</span><span class="c1"></span>    <span class="c1">// bound 里面会保存每毫秒有多少次操作
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">bound</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bounds</span> <span class="p">{</span>
        <span class="nx">boundCount</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">boundCounts</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">bound</span><span class="p">)</span>
        <span class="nx">opCount</span> <span class="o">+=</span> <span class="nx">boundCount</span>
        <span class="nx">per</span> <span class="o">:=</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">opCount</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span>
        <span class="c1">// 这里是 99% 的操作是落在哪个时间区间内
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">per99</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">per</span> <span class="o">&gt;=</span> <span class="mf">0.99</span> <span class="p">{</span>
            <span class="nx">per99</span> <span class="p">=</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">per999</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">per</span> <span class="o">&gt;=</span> <span class="mf">0.999</span> <span class="p">{</span>
            <span class="nx">per999</span> <span class="p">=</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">per9999</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">per</span> <span class="o">&gt;=</span> <span class="mf">0.9999</span> <span class="p">{</span>
            <span class="nx">per9999</span> <span class="p">=</span> <span class="p">(</span><span class="nx">bound</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 计算整个测试耗时
</span><span class="c1"></span>    <span class="nx">elapsed</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">startTime</span><span class="p">).</span><span class="nf">Seconds</span><span class="p">()</span>
    <span class="c1">// 计算单位耗时内操作次数 
</span><span class="c1"></span>    <span class="nx">qps</span> <span class="o">:=</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="o">/</span> <span class="nx">elapsed</span>
    <span class="nx">res</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">ELAPSED</span><span class="p">]</span> <span class="p">=</span> <span class="nx">elapsed</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">COUNT</span><span class="p">]</span> <span class="p">=</span> <span class="nx">count</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">QPS</span><span class="p">]</span> <span class="p">=</span> <span class="nx">qps</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">AVG</span><span class="p">]</span> <span class="p">=</span> <span class="nx">avg</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">MIN</span><span class="p">]</span> <span class="p">=</span> <span class="nx">min</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">MAX</span><span class="p">]</span> <span class="p">=</span> <span class="nx">max</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">PER99TH</span><span class="p">]</span> <span class="p">=</span> <span class="nx">per99</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">PER999TH</span><span class="p">]</span> <span class="p">=</span> <span class="nx">per999</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">PER9999TH</span><span class="p">]</span> <span class="p">=</span> <span class="nx">per9999</span>

    <span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The per99, per999, per9999 here are actually only milliseconds in precision and are designed to do histogram export (and then the author has been at this project for 3 years and hasn&rsquo;t added this feature yet).</p>
<h2 id="summary">Summary</h2>
<p>The above analysis shows that Go YCSB is very well designed and can be extended with very little code; the configuration is also quite flexible, providing different test environments for different requestdistributions, and the read and write probabilities can be adjusted at will in the tests to ensure that the online environment can be simulated as much as possible.</p>
<p>But it also has a lot of shortcomings, on the one hand, the documentation is very inadequate, basically just write a few parameters configuration; on the other hand is a lot of features are not implemented, online testing will often appear ERROR, go to the code to see the results are not implemented. Three years ago, the author said in his blog that he wanted to implement the test result export function, but the result has not been implemented yet. I have sent an email to the author at <a href="mailto:tl@pingcap.com">tl@pingcap.com</a> and am waiting for a reply.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/go-failpoint/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Using Failpoint to inject faults in Go</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/go-source-code-panic-and-recover/">
            <span class="next-text nav-default">Exploring what are the pitfalls of panic &amp; recover in Go source code?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
