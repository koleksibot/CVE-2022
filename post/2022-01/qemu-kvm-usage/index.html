<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>QEMU-KVM Virtualization Environment Construction and Use - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="QEMU/KVM Virtualization QEMU/KVM is currently the most popular virtualization technology. It is based on the kvm module provided by the Linux kernel, with a streamlined structure, low performance loss, and is open source and free (compared to the paid vmware), so it has become the preferred virtualization solution for most enterprises. The current virtualization solutions of major cloud vendors are basically using KVM technology for new server instances. Even AWS," /><meta name="keywords" content="qemu, kvm" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/qemu-kvm-usage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="QEMU-KVM Virtualization Environment Construction and Use" />
<meta property="og:description" content="QEMU/KVM Virtualization QEMU/KVM is currently the most popular virtualization technology. It is based on the kvm module provided by the Linux kernel, with a streamlined structure, low performance loss, and is open source and free (compared to the paid vmware), so it has become the preferred virtualization solution for most enterprises. The current virtualization solutions of major cloud vendors are basically using KVM technology for new server instances. Even AWS," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/qemu-kvm-usage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-08T15:47:13+08:00" />
<meta property="article:modified_time" content="2022-01-08T15:47:13+08:00" />

<meta itemprop="name" content="QEMU-KVM Virtualization Environment Construction and Use">
<meta itemprop="description" content="QEMU/KVM Virtualization QEMU/KVM is currently the most popular virtualization technology. It is based on the kvm module provided by the Linux kernel, with a streamlined structure, low performance loss, and is open source and free (compared to the paid vmware), so it has become the preferred virtualization solution for most enterprises. The current virtualization solutions of major cloud vendors are basically using KVM technology for new server instances. Even AWS,"><meta itemprop="datePublished" content="2022-01-08T15:47:13+08:00" />
<meta itemprop="dateModified" content="2022-01-08T15:47:13+08:00" />
<meta itemprop="wordCount" content="2329">
<meta itemprop="keywords" content="qemu,kvm," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="QEMU-KVM Virtualization Environment Construction and Use"/>
<meta name="twitter:description" content="QEMU/KVM Virtualization QEMU/KVM is currently the most popular virtualization technology. It is based on the kvm module provided by the Linux kernel, with a streamlined structure, low performance loss, and is open source and free (compared to the paid vmware), so it has become the preferred virtualization solution for most enterprises. The current virtualization solutions of major cloud vendors are basically using KVM technology for new server instances. Even AWS,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">QEMU-KVM Virtualization Environment Construction and Use</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-08 15:47:13 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2329 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#qemukvm-virtualization">QEMU/KVM Virtualization</a></li>
        <li><a href="#i-installing-queukvm">I. Installing QUEU/KVM</a>
          <ul>
            <li><a href="#1-libguestfs---virtual-machine-disk-image-processing-tool">1. libguestfs - Virtual Machine Disk Image Processing Tool</a></li>
            <li><a href="#2-start-qemukvm">2. Start QEMU/KVM</a></li>
            <li><a href="#3-enable-non-root-users-to-use-kvm-properly">3. Enable non-root users to use kvm properly</a></li>
            <li><a href="#3-enabling-nested-virtualization">3. Enabling nested virtualization</a></li>
          </ul>
        </li>
        <li><a href="#ii-virtual-machine-disk-image-management">II. Virtual machine disk image management</a>
          <ul>
            <li><a href="#1-importing-vmware-images">1. Importing vmware images</a></li>
            <li><a href="#2-import-img-image">2. import img image</a></li>
          </ul>
        </li>
        <li><a href="#iii-virtual-machine-management">III. Virtual Machine Management</a>
          <ul>
            <li><a href="#0-setting-the-default-uri">0. Setting the default URI</a></li>
            <li><a href="#1-virtual-machine-network">1. Virtual Machine Network</a></li>
            <li><a href="#2-create-the-virtual-machine---virt-intall">2. Create the virtual machine - virt-intall</a></li>
            <li><a href="#3-virtual-machine-management---virsh">3. virtual machine management - virsh</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="qemukvm-virtualization">QEMU/KVM Virtualization</h2>
<p>QEMU/KVM is currently the most popular virtualization technology. It is based on the kvm module provided by the Linux kernel, with a streamlined structure, low performance loss, and is open source and free (compared to the paid vmware), so it has become the preferred virtualization solution for most enterprises.</p>
<p>The current virtualization solutions of major cloud vendors are basically using KVM technology for new server instances. Even AWS, which started first and has been using Xen heavily, has switched to Nitro virtualization technology based on KVM customization since EC2 C5.</p>
<p>However, KVM, as an enterprise-class underlying virtualization technology, is not deeply optimized for desktop use, so if you want to use it as desktop virtualization software and replace VirtualBox/VMware, it is somewhat difficult.</p>
<p>This article is a summary document of my personal learning about KVM, with the goal of using KVM as desktop virtualization software.</p>
<h2 id="i-installing-queukvm">I. Installing QUEU/KVM</h2>
<p>The QEMU/KVM environment requires the installation of a number of components, each of which has its own role to play.</p>
<ul>
<li>qemu: emulates various types of input and output devices (network cards, disks, USB ports, etc.)
<ul>
<li>qemu uses kvm at the bottom to emulate CPU and RAM, which is much faster than software emulation.</li>
</ul>
</li>
<li>libvirt: provides simple and unified tools and APIs for managing virtual machines, shielding the underlying complex structure. (supports qemu-kvm/virtualbox/vmware)</li>
<li>ovmf: Enables UEFI support for virtual machines</li>
<li>virt-manager: GUI interface for managing virtual machines (can manage remote kvm hosts).</li>
<li>virt-viewer: Interact directly with the virtual machine through the GUI interface (can manage remote kvm hosts).</li>
<li>dnsmasq vde2 bridge-utils openbsd-netcat: Network-related component that provides virtual networking features such as Ethernet virtualization, network bridging, and NAT networking.
<ul>
<li>dnsmasq provides DHCP and DNS resolution for NAT virtual networks.</li>
<li>vde2: Ethernet virtualization</li>
<li>bridge-utils: As the name implies, provides network bridging related tools.</li>
<li>openbsd-netcat: The Swiss Army knife of TCP/IP.</li>
</ul>
</li>
</ul>
<p>Installation commands.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># archlinux/manjaro</span>
sudo pacman -S qemu virt-manager virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat

<span class="c1"># ubuntu,参考了官方文档，但未测试</span>
sudo apt install qemu-kvm libvirt-daemon-system virt-manager virt-viewer virtinst bridge-utils

<span class="c1"># centos,参考了官方文档，但未测试</span>
sudo yum groupinstall <span class="s2">&#34;Virtualization Host&#34;</span>
sudo yum install virt-manager virt-viewer virt-install

<span class="c1"># opensuse</span>
<span class="c1"># see: https://doc.opensuse.org/documentation/leap/virtualization/html/book-virt/cha-vt-installation.html</span>
sudo yast2 virtualization
<span class="c1"># enter to terminal ui, select kvm + kvm tools, and then install it.</span>
</code></pre></td></tr></table>
</div>
</div><p>Once the installation is complete, you can&rsquo;t use it directly yet, you need to do some extra work. Please continue to the next step.</p>
<h3 id="1-libguestfs---virtual-machine-disk-image-processing-tool">1. libguestfs - Virtual Machine Disk Image Processing Tool</h3>
<p><a href="https://libguestfs.org/">libguestfs</a> is a virtual machine disk image processing tool that can be used to directly modify/view/virtual machine images, convert image formats, etc.</p>
<p>It provides the following list of commands.</p>
<ul>
<li><code>virt-df centos.img</code> : View hard disk usage</li>
<li><code>virt-ls centos.img /</code> : List directory files</li>
<li><code>virt-copy-out -d domain /etc/passwd /tmp</code> : Perform file copy in virtual image</li>
<li><code>virt-list-filesystems /file/xx.img</code> : View file system information</li>
<li><code>virt-list-partitions /file/xx.img</code> : View partition information</li>
<li><code>guestmount -a /file/xx.qcow2(raw/qcow2 are supported) -m /dev/VolGroup/lv_root --rw /mnt</code> : Mount the partition directly to the host</li>
<li><code>guestfish</code> : Interactive shell that runs all the above commands.</li>
<li><code>virt-v2v</code> : Convert virtual machines of other formats (e.g. ova) into kvm virtual machines.</li>
<li><code>virt-p2v</code> : Converts a physical machine into a virtual machine.</li>
</ul>
<p>The above commands may be used during the learning process, it never hurts to install them in advance. The installation commands are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># opensuse</span>
sudo zypper install libguestfs

<span class="c1"># archlinux/manjaro，目前缺少 virt-v2v/virt-p2v 组件</span>
sudo pacman -S libguestfs

<span class="c1"># ubuntu</span>
sudo apt install libguestfs-tools

<span class="c1"># centos</span>
sudo yum install libguestfs-tools
</code></pre></td></tr></table>
</div>
</div><h3 id="2-start-qemukvm">2. Start QEMU/KVM</h3>
<p>Start the libvirtd backend service via systemd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo systemctl <span class="nb">enable</span> libvirtd.service
sudo systemctl start libvirtd.service
</code></pre></td></tr></table>
</div>
</div><h3 id="3-enable-non-root-users-to-use-kvm-properly">3. Enable non-root users to use kvm properly</h3>
<p>Once qumu/kvm is installed, by default you need root privileges to use it properly. To make it easier to use, first edit the file <code>/etc/libvirt/libvirtd.conf</code> :</p>
<ul>
<li><code>unix_sock_group = &quot;libvirt&quot;</code> to uncomment this line so that the <code>libvirt</code> user group can use unix sockets.</li>
<li><code>unix_sock_rw_perms = &quot;0770&quot;</code> , uncomment this line so that users can read and write unix sockets.</li>
</ul>
<p>Then create a new libvirt user group and add the current user to it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">newgrp libvirt
sudo usermod -aG libvirt <span class="nv">$USER</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally, restart the libvirtd service and it should work fine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo systemctl restart libvirtd.service
</code></pre></td></tr></table>
</div>
</div><h3 id="3-enabling-nested-virtualization">3. Enabling nested virtualization</h3>
<p>If you need to <strong>run a virtual machine</strong> within a virtual machine (e.g. to test secure container technologies such as katacontainers within a virtual machine), then you need to enable the kernel module kvm_intel to implement nested virtualization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 临时启用 kvm_intel 嵌套虚拟化</span>
sudo modprobe -r kvm_intel
sudo modprobe kvm_intel <span class="nv">nested</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># 修改配置，永久启用嵌套虚拟化</span>
<span class="nb">echo</span> <span class="s2">&#34;options kvm-intel nested=1&#34;</span> <span class="p">|</span> sudo tee /etc/modprobe.d/kvm-intel.conf
</code></pre></td></tr></table>
</div>
</div><p>Verify that nested virtualization is enabled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ cat /sys/module/kvm_intel/parameters/nested 
Y
</code></pre></td></tr></table>
</div>
</div><p>Now you should be able to find the virt-manager icon on your system and go inside to use it. The usage of virt-manager is similar to that of virtualbox/vmware workstation, so I won&rsquo;t go into details here, you should be able to figure it out yourself.</p>
<blockquote>
<p>The following is an advanced section that introduces how to manage virtual machine disks and KVM through the command line. If you are still new to kvm, we recommend that you first familiarize yourself with virt-manager through the graphical interface before reading on.</p>
</blockquote>
<h2 id="ii-virtual-machine-disk-image-management">II. Virtual machine disk image management</h2>
<p>This requires the use of two tools.</p>
<ul>
<li>libguestfs: virtual machine disk image management tool, which has been introduced earlier</li>
<li>qemu-img: qemu&rsquo;s disk image management tool, used to create disks, expand and shrink disks, generate disk snapshots, view disk information, convert disk formats, etc.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 创建磁盘</span>
qemu-img create -f qcow2 -o <span class="nv">cluster_size</span><span class="o">=</span>128K virt_disk.qcow2 20G

<span class="c1"># 扩容磁盘</span>
qemu-img resize ubuntu-server-cloudimg-amd64.img 30G

<span class="c1"># 查看磁盘信息</span>
qemu-img info ubuntu-server-cloudimg-amd64.img

<span class="c1"># 转换磁盘格式</span>
qemu-img convert -f raw -O qcow2 vm01.img vm01.qcow2  <span class="c1"># raw =&gt; qcow2</span>
qemu-img convert -f qcow2 -O raw vm01.qcow2 vm01.img  <span class="c1"># qcow2 =&gt; raw</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1-importing-vmware-images">1. Importing vmware images</h3>
<p>Import the kvm directly from the vmware ova file, this way the image should work directly (the NIC needs to be reconfigured).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">virt-v2v -i ova centos7-test01.ova -o <span class="nb">local</span> -os /vmhost/centos7-01  -of qcow2
</code></pre></td></tr></table>
</div>
</div><p>You can also extract the vmdk disk image from ova, convert the vmware vmdk file to qcow2 format, and then import it into kvm (the NIC needs to be reconfigured):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 转换映像格式</span>
qemu-img convert -p -f vmdk -O qcow2 centos7-test01-disk1.vmdk centos7-test01.qcow2
<span class="c1"># 查看转换后的映像信息</span>
qemu-img info centos7-test01.qcow2
</code></pre></td></tr></table>
</div>
</div><p>The qcow2 image obtained by directly converting the vmdk file will report errors such as &ldquo;disk cannot be mounted&rdquo;. According to the <a href="https://pve.proxmox.com/pve-docs/chapter-qm.html#_importing_virtual_machines_and_disk_images">Importing Virtual Machines and disk images - ProxmoxVE Docs</a>, you need to download and install the MergeIDE.zip component from the Internet, and you need to change the hard disk type to IDE before starting the virtual machine in order to solve this problem.</p>
<h3 id="2-import-img-image">2. import img image</h3>
<p>The img image file, the so-called raw format image, also known as bare image, has faster IO speed than qcow2, but is large and does not support advanced features such as snapshots. If you do not pursue IO performance, it is recommended to convert it to qcow2 and then use it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">qemu-img convert -f raw -O qcow2 vm01.img vm01.qcow2
</code></pre></td></tr></table>
</div>
</div><h2 id="iii-virtual-machine-management">III. Virtual Machine Management</h2>
<p>Virtual machine management can be done using the command line tool <code>virsh</code> / <code>virt-install</code> or the GUI tool <code>virt-manager</code> .</p>
<p>The GUI is very foolproof, so I won&rsquo;t introduce it here, but mainly the command line tool <code>virsh</code> / <code>virt-install</code>.</p>
<p>First, let&rsquo;s introduce a few concepts in libvirt.</p>
<ul>
<li>Domain: Refers to an instance of the operating system running on the virtual machine - a virtual machine, or the configuration used to start the virtual machine.</li>
<li>Guest OS: The virtual operating system running in the domain.</li>
</ul>
<p>In most cases, you can interpret the <code>domain</code> involved in the following commands as a virtual machine.</p>
<h3 id="0-setting-the-default-uri">0. Setting the default URI</h3>
<p><code>virsh</code> / <code>virt-install</code> / <code>virt-viewer</code> and a series of libvirt commands, sudo virsh net-list -all will use <code>qemu:///session</code> as URI to connect to QEMU/KVM by default, only only the root account will use <code>qemu:///system</code> by default .</p>
<p>On the other hand, the GUI tool <code>virt-manager</code> will also use <code>qemu:///system</code> to connect to QEMU/KVM by default (same as the root account)</p>
<p><code>qemu:///system</code> is the global qemu environment for the system, while the <code>qemu:///session</code> environment is isolated by user. Also <code>qemu:///session</code> does not have a default <code>network</code>, which can cause problems when creating virtual machines.</p>
<p>Therefore, you need to change the default URI to <code>qemu:///system</code> or you will definitely get screwed:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">echo</span> <span class="s1">&#39;export LIBVIRT_DEFAULT_URI=&#34;qemu:///system&#34;&#39;</span> &gt;&gt; ~/.bashrc
</code></pre></td></tr></table>
</div>
</div><h3 id="1-virtual-machine-network">1. Virtual Machine Network</h3>
<p>After the installation of qemu-kvm is complete, a <code>default</code> network is created by default in the <code>qemu:///system</code> environment, while <code>qemu:///session</code> does not provide a default network and needs to be created manually.</p>
<p>We usually use the <code>qemu:///system</code> environment just fine, you can use the following method to view and start the default network so that it will be available when you create the virtual machine later.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 列出所有虚拟机网络</span>
$ sudo virsh net-list --all
 Name      State      Autostart   Persistent
----------------------------------------------
 default   inactive   no          yes

<span class="c1"># 启动默认网络</span>
$ virsh net-start default
Network default started

<span class="c1"># 将 default 网络设为自启动</span>
$ virsh net-autostart --network default
Network default marked as autostarted

<span class="c1"># 再次检查网络状况，已经是 active 了</span>
$ sudo virsh net-list --all
 Name      State    Autostart   Persistent
--------------------------------------------
 default   active   yes         yes
</code></pre></td></tr></table>
</div>
</div><p>You can also create a new VM network, which requires writing the xml configuration for the network manually, and then creating it with <code>virsh net-define --file my-network.xml</code>, which I won&rsquo;t go into detail about here because I won&rsquo;t use it for a while&hellip;</p>
<h3 id="2-create-the-virtual-machine---virt-intall">2. Create the virtual machine - virt-intall</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 使用 iso 镜像创建全新的 proxmox 虚拟机，自动创建一个 60G 的磁盘。</span>
virt-install --virt-type kvm <span class="se">\
</span><span class="se"></span>--name pve-1 <span class="se">\
</span><span class="se"></span>--vcpus <span class="m">4</span> --memory <span class="m">8096</span> <span class="se">\
</span><span class="se"></span>--disk <span class="nv">size</span><span class="o">=</span><span class="m">60</span> <span class="se">\
</span><span class="se"></span>--network <span class="nv">network</span><span class="o">=</span>default,model<span class="o">=</span>virtio <span class="se">\
</span><span class="se"></span>--os-type linux <span class="se">\
</span><span class="se"></span>--os-variant generic <span class="se">\
</span><span class="se"></span>--graphics vnc <span class="se">\
</span><span class="se"></span>--cdrom proxmox-ve_6.3-1.iso

<span class="c1"># 使用已存在的 opensuse cloud 磁盘创建虚拟机</span>
virt-install --virt-type kvm <span class="se">\
</span><span class="se"></span>  --name opensuse15-2 <span class="se">\
</span><span class="se"></span>  --vcpus <span class="m">2</span> --memory <span class="m">2048</span> <span class="se">\
</span><span class="se"></span>  --disk opensuse15.2-openstack.qcow2,device<span class="o">=</span>disk,bus<span class="o">=</span>virtio <span class="se">\
</span><span class="se"></span>  --disk seed.iso,device<span class="o">=</span>cdrom <span class="se">\
</span><span class="se"></span>  --os-type linux <span class="se">\
</span><span class="se"></span>  --os-variant opensuse15.2 <span class="se">\
</span><span class="se"></span>  --network <span class="nv">network</span><span class="o">=</span>default,model<span class="o">=</span>virtio <span class="se">\
</span><span class="se"></span>  --graphics vnc <span class="se">\
</span><span class="se"></span>  --import
</code></pre></td></tr></table>
</div>
</div><p>The <code>-os-variant</code> is used to set the OS-related optimization configuration, which is set by the official documentation <strong>highly recommended</strong>, and its optional parameters can be viewed via <code>osinfo-query os</code>.</p>
<h3 id="3-virtual-machine-management---virsh">3. virtual machine management - virsh</h3>
<p>Once the virtual machine has been created, you can use virsh to manage the virtual machine.</p>
<p>To view the list of virtual machines.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看正在运行的虚拟机</span>
virsh list

<span class="c1"># 查看所有虚拟机，包括 inactive 的虚拟机</span>
virsh list --all
</code></pre></td></tr></table>
</div>
</div><p>Use <code>virt-viewer</code> to log in to the virtual machine terminal using the vnc protocol.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 使用虚拟机 ID 连接</span>
virt-viewer <span class="m">8</span>
<span class="c1"># 使用虚拟机名称连接，并且等待虚拟机启动</span>
virt-viewer --wait opensuse15
</code></pre></td></tr></table>
</div>
</div><p>Starting, shutting down, suspending (hibernating), restarting the virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">virsh start opensuse15
virsh suuspend opensuse15
virsh resume opensuse15
virsh reboot opensuse15
<span class="c1"># 优雅关机</span>
virsh shutdown opensuse15
<span class="c1"># 强制关机</span>
virsh destroy opensuse15

<span class="c1"># 启用自动开机</span>
virsh autostart opensuse15
<span class="c1"># 禁用自动开机</span>
virsh autostart --disable opensuse15
</code></pre></td></tr></table>
</div>
</div><p>Virtual machine snapshot management.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 列出一个虚拟机的所有快照</span><span class="w">
</span><span class="w"></span><span class="l">virsh snapshot-list --domain opensuse15</span><span class="w">
</span><span class="w"></span><span class="c"># 给某个虚拟机生成一个新快照</span><span class="w">
</span><span class="w"></span><span class="l">virsh snapshot-create &lt;domain&gt;</span><span class="w">
</span><span class="w"></span><span class="c"># 使用快照将虚拟机还原</span><span class="w">
</span><span class="w"></span><span class="l">virsh snapshot-restore &lt;domain&gt; &lt;snapshotname&gt;</span><span class="w">
</span><span class="w"></span><span class="c"># 删除快照</span><span class="w">
</span><span class="w"></span><span class="l">virsh snapshot-delete &lt;domain&gt; &lt;snapshotname&gt;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Deleting a virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">virsh undefine opensuse15
</code></pre></td></tr></table>
</div>
</div><p>Migration of virtual machines.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 使用默认参数进行离线迁移，将已关机的服务器迁移到另一个 qemu 实例</span>
virsh migrate <span class="m">37</span> qemu+ssh://tux@jupiter.example.com/system
<span class="c1"># 还支持在线实时迁移，待续</span>
</code></pre></td></tr></table>
</div>
</div><p>cpu/memory modifications.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 改成 4 核</span>
virsh setvcpus opensuse15 <span class="m">4</span>
<span class="c1"># 改成 4G</span>
virsh setmem opensuse15 <span class="m">4096</span>
</code></pre></td></tr></table>
</div>
</div><p>Virtual machine monitoring.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 待续</span>
</code></pre></td></tr></table>
</div>
</div><p>Modify disks, networks and other devices.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 添加新设备</span>
virsh attach-device
virsh attach-disk
virsh attach-interface
<span class="c1"># 删除设备</span>
virsh detach-disk
virsh detach-device
virsh detach-interface
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/qemu/">qemu</a>
          <a href="/tags/kvm/">kvm</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/xquic/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Ali&#39;s own standardized protocol library XQUIC officially open source!</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/expirence-of-vault/">
            <span class="next-text nav-default">Introduction, installation and use of the secrets management tool Vault</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
