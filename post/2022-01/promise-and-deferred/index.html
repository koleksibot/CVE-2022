<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Promise and Deferred - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="1. Introduction In this article I want to discuss Promise in JavaScript and Deferred in Python Twisted (Deferred is also available in jQuery, and the idea is the same). They&amp;rsquo;re interesting, and a bit complicated. They played an important role in web programming before concurrency was widely used. Before that, let&amp;rsquo;s take a look at some basic concepts.
2. Starting with the request Requests and responses When we do network programming, we always use request and response ." /><meta name="keywords" content="javascript, Promise, Deferred" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/promise-and-deferred/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Promise and Deferred" />
<meta property="og:description" content="1. Introduction In this article I want to discuss Promise in JavaScript and Deferred in Python Twisted (Deferred is also available in jQuery, and the idea is the same). They&rsquo;re interesting, and a bit complicated. They played an important role in web programming before concurrency was widely used. Before that, let&rsquo;s take a look at some basic concepts.
2. Starting with the request Requests and responses When we do network programming, we always use request and response ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/promise-and-deferred/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-04T13:02:56+08:00" />
<meta property="article:modified_time" content="2022-01-04T13:02:56+08:00" />

<meta itemprop="name" content="Promise and Deferred">
<meta itemprop="description" content="1. Introduction In this article I want to discuss Promise in JavaScript and Deferred in Python Twisted (Deferred is also available in jQuery, and the idea is the same). They&rsquo;re interesting, and a bit complicated. They played an important role in web programming before concurrency was widely used. Before that, let&rsquo;s take a look at some basic concepts.
2. Starting with the request Requests and responses When we do network programming, we always use request and response ."><meta itemprop="datePublished" content="2022-01-04T13:02:56+08:00" />
<meta itemprop="dateModified" content="2022-01-04T13:02:56+08:00" />
<meta itemprop="wordCount" content="2194">
<meta itemprop="keywords" content="javascript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Promise and Deferred"/>
<meta name="twitter:description" content="1. Introduction In this article I want to discuss Promise in JavaScript and Deferred in Python Twisted (Deferred is also available in jQuery, and the idea is the same). They&rsquo;re interesting, and a bit complicated. They played an important role in web programming before concurrency was widely used. Before that, let&rsquo;s take a look at some basic concepts.
2. Starting with the request Requests and responses When we do network programming, we always use request and response ."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Promise and Deferred</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-04 13:02:56 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2194 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction">1. Introduction</a></li>
        <li><a href="#2-starting-with-the-request">2. Starting with the request</a>
          <ul>
            <li><a href="#requests-and-responses">Requests and responses</a></li>
            <li><a href="#sessions">Sessions</a></li>
          </ul>
        </li>
        <li><a href="#3-introducing-the-problem">3. Introducing the problem</a></li>
        <li><a href="#4-promise">4. Promise</a>
          <ul>
            <li><a href="#basic-usage">Basic usage</a></li>
            <li><a href="#using-promise">Using Promise</a></li>
            <li><a href="#exception-handling">Exception handling</a></li>
          </ul>
        </li>
        <li><a href="#5-deferred">5. Deferred</a>
          <ul>
            <li><a href="#basic-usage-1">Basic usage</a></li>
            <li><a href="#using-deferred">Using Deferred</a></li>
          </ul>
        </li>
        <li><a href="#6-summary">6. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-introduction">1. Introduction</h2>
<p>In this article I want to discuss Promise in JavaScript and Deferred in Python Twisted (Deferred is also available in jQuery, and the idea is the same). They&rsquo;re interesting, and a bit complicated. They played an important role in web programming before concurrency was widely used. Before that, let&rsquo;s take a look at some basic concepts.</p>
<h2 id="2-starting-with-the-request">2. Starting with the request</h2>
<h3 id="requests-and-responses">Requests and responses</h3>
<p>When we do network programming, we always use <strong>request</strong> and <strong>response</strong> . For example, if process A needs to pass some data to process B, we can say that process A sent a request to process B. Sometimes a request is sent and we don&rsquo;t care about the rest; but more often, we care about the result of the processing of the data by the target process, and we want to process the result further. In this case, we can ask the target process to send a request to the source process and pass the result to the source process after it has received the sent data and processed it accordingly. We call this behavior a response.</p>
<h3 id="sessions">Sessions</h3>
<p>It is not enough to have a request and a response. Consider the following scenario:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/04/be3dd734442f4e4594d02876689bcb32.png" alt="image"></p>
<p>Since the process of sending the request and the process of processing the response are located in two different methods, the context generated by the process of sending the request is not available when processing the response.</p>
<p>To solve this problem, we propose the concept of <strong>session</strong>. We believe that each request must correspond to a response, and a session id is used to uniquely identify a conversation, and the session id is passed between the request and the response. If some context is used in processing the response, it can be stored with the session id as the primary key, and the required context is retrieved by the session id during response processing. during response processing.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/04/16c128f80c774548a18865b7f46483a8.png" alt="image"></p>
<p>I wrote a simple example below, where the <code>send</code> method sends data to the remote process, the two arguments are the remote process handle and the data; when the process receives the data it calls back the <code>on_receive_message</code> method, the two arguments are the sender process handle and the data; <code>request_handler</code> is the request handler function, all request_handler` is the request handler function, which will be called for all requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">session_id</span> <span class="o">=</span> <span class="nx">generate_session_id</span><span class="p">();</span>
    <span class="nx">session_map</span><span class="p">[</span><span class="nx">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
    <span class="nx">send</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">session_id</span><span class="p">,</span> <span class="nx">data</span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">on_receive_message</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;request&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="nx">send</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">session_id</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">response</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">session_map</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">];</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">delete</span> <span class="nx">session_map</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>send_request</code> function takes three parameters: the remote process handle, the request data and the callback function. Each call to <code>send_request</code> generates a session id, and stores the callback function with the session id as the primary key. When a response is received, the session id is used to find the callback function, and the callback function is called. This completes a session.</p>
<p>In this example, we use the js feature of using the callback function as the context. The real context, the <code>ctx</code> variable, is stored implicitly as the upper value of the callback function.</p>
<h2 id="3-introducing-the-problem">3. Introducing the problem</h2>
<p>With a session, we can easily send requests and responses. For example, we can send a request and receive a response like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">dosth</span><span class="p">();</span>
<span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">calc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>The target process can then receive the request and return the response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">deal_with</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, there are often some inconveniences in using callback functions in this way. What if you need to send a request to another process in the request handler and get the return value and then respond?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">dosth</span><span class="p">();</span>
    <span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="s1">&#39;ask_for_response&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">calc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="c1">// Cannot return `res` as a response.
</span><span class="c1"></span>    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We cannot return <code>res</code> to <code>on_receive_message</code> as the return value of <code>request_handler</code>, and we cannot pass the response of the request. To solve this problem, we can make some changes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">on_receive_message</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;request&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">request_handler</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">send</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">session_id</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">response</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">dosth</span><span class="p">();</span>
    <span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="s1">&#39;ask_for_response&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">calc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Instead of passing the response by the return value, a callback function is now passed with an additional parameter, and the response is passed by calling the callback function. This solves the problem.</p>
<p>However, this is still not very convenient, especially when multiple calls are involved, and the callback function needs to be passed through the parameters. Also, in many cases, a remote call may not always succeed, and we want to be able to handle exceptions when errors occur. So in addition to callbacks, it is common to pass in a function called an exception callback to specifically handle exceptions. If both callbacks and exception callbacks are passed in layers, this makes the code difficult to maintain and the methods containing the remote calls difficult to encapsulate into a common library.</p>
<h2 id="4-promise">4. Promise</h2>
<p>To solve this paradox, js introduced the concept of Promise. A &ldquo;promise&rdquo; is a promise that some action will be performed in the future. The biggest change is that it moves the passing of callback functions from parameters to return values. A Promise object means an unfinished job that is promised to be completed in the future, and expects a callback function. When the work is completed at some point in the future, the callback function is called. This approach solves the problem described above perfectly.</p>
<h3 id="basic-usage">Basic usage</h3>
<p>Let&rsquo;s look at the basic usage:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">eb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
            <span class="nx">cb</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">eb</span><span class="p">(</span><span class="s1">&#39;what the hell&#39;</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;result:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>Constructs a Promise object using a function. This function takes two arguments: a callback and an exception callback. We say that a Promise object means an unfinished job, so the callback function is called when the job completes, and the exception callback function is called when the job fails. After constructing a Promise object, call <code>Promise.prototype.then</code> to set the callback function and call <code>Promise.prototype.catch</code> to set the exception callback function.</p>
<p>We can call the <code>then</code> method of a Promise object multiple times to set multiple callbacks. These callbacks form a chain of callbacks, and the return value of the previous function becomes the argument of the next function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 1
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 2
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">res</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 4
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>These callback functions can also return Promise objects, forming nested Promise calls:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 1
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 2
</span><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">res</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 4
</span><span class="c1"></span><span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>The idea is the same, think of a Promise object as an unfinished task, and pass the result of the task when it completes by calling a callback function.</p>
<h3 id="using-promise">Using Promise</h3>
<p>The above example uses Promise in this way:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">session_id</span> <span class="o">=</span> <span class="nx">generate_session_id</span><span class="p">();</span>
    <span class="cm">/*construct a promise object, which means an unfinished job*/</span>
    <span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">session_map</span><span class="p">[</span><span class="nx">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="nx">send</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">session_id</span><span class="p">,</span> <span class="nx">data</span><span class="p">});</span>
    <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">on_receive_message</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;request&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">send</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">session_id</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">response</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">session_map</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">];</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span> <span class="c1">// call `callback` function, fulfill the promise
</span><span class="c1"></span>        <span class="k">delete</span> <span class="nx">session_map</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">session_id</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">request_handler</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">dosth</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">send_request</span><span class="p">(</span><span class="nx">remote_process_handle</span><span class="p">,</span> <span class="s1">&#39;ask_for_response&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">calc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>where <code>Promise.resolve</code> automatically determines if an object is a Promise object, and if it is, it waits for it to be ready before calling it back, or if it is not, it calls it back directly.</p>
<p>As you can see, there is no need to pass the callback function in the argument, but instead the caller returns the Promise object and sets the callback function from it after receiving the Promise object. Even if there are multiple calls, you only need to return the Promise object one after another. This solves this problem perfectly.</p>
<h3 id="exception-handling">Exception handling</h3>
<p>Another powerful feature of Promise is exception handling. As mentioned above, in addition to calling <code>Promise.prototype.then</code> to set the callback function, you can also call <code>Promise.prototype.catch</code> to set the exception callback. Both callbacks and exception callbacks form a callback chain. When an exception occurs, the exception callback will be executed instead; and if the exception callback is fault tolerant, the callback will be executed instead.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/01/04/cf0c4c1b0cbe461a887070294a88fd1b.png" alt="image"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">cb</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 1
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">throw</span> <span class="s1">&#39;cannot be odd&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error occurred:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="c1">// throw err;
</span><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="c1">// 0
</span><span class="c1"></span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error occurred again:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Promise.prototype.then</code> supports both callbacks and exception callbacks, as shown above, the first argument is a callback and the second argument is an exception callback. If you uncomment <code>throw err</code>, it will print <code>error occurred again: cannot be odd</code> at the end.</p>
<h2 id="5-deferred">5. Deferred</h2>
<p>I was first introduced to Deferred using Python&rsquo;s twisted library. Deferred is actually available in jQuery, and they are practically the same. The essence and core idea of Deferred is the same as Promise, but with a different presentation.</p>
<h3 id="basic-usage-1">Basic usage</h3>
<p>Again, let&rsquo;s start with a simple example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="k">def</span> <span class="nf">then</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;result:&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">catch</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;error:&#34;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

<span class="n">defer</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
<span class="n">defer</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">then</span><span class="p">)</span> \
     <span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">catch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_timer</span><span class="p">():</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">defer</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">defer</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;what the hell&#39;</span><span class="p">))</span>

<span class="n">Timer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_timer</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that Deferred and Promise are quite similar. <code>Deferred.addCallback</code> is equivalent to <code>Promise.prototype.then</code> and <code>Deferred.addErrback</code> is equivalent to <code>Promise.prototype.catch</code> . The big difference is that instead of using a function constructor, Deferred calls <code>Deferred.callback</code> or <code>Deferred.errback</code> directly to tell it that its work has completed or failed.</p>
<p>Deferred&rsquo;s callback chain and nested Deferred are the same as Promise, so here&rsquo;s an example of the same:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="c1"># 1</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="c1"># 2</span>
    <span class="n">defer</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
    <span class="n">defer</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">res</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">baz</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="c1"># 4</span>

<span class="n">defer</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
<span class="n">defer</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span> \
     <span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span> \
     <span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">baz</span><span class="p">)</span>

<span class="n">defer</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="using-deferred">Using Deferred</h3>
<p>As an example, here I have used Deferred to implement <code>send_request</code> and <code>on_receive_message</code> above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">remote_process_handle</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
    <span class="n">defer</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span> <span class="c1"># construct a deferred object, which means an unfinished job</span>
    <span class="n">session_map</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">defer</span>
    <span class="n">send</span><span class="p">(</span><span class="n">remote_process_handle</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">on_receive_message</span><span class="p">(</span><span class="n">remote_process_handle</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">request_handler</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="n">send</span><span class="p">(</span><span class="n">remote_process_handle</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">}))</span>

        <span class="n">Deferred</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span>
        <span class="n">defer</span> <span class="o">=</span> <span class="n">session_map</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]]</span>
        <span class="n">defer</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="c1"># call `callback` function, finish the job</span>
        <span class="k">del</span> <span class="n">session_map</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">request_handler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">dosth</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">calc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">send_request</span><span class="p">(</span><span class="n">remote_process_handle</span><span class="p">,</span> <span class="s1">&#39;ask_for_response&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Deferred&rsquo;s exception handling is basically the same as Promise, so I won&rsquo;t go into it here. See the documentation for details.</p>
<h2 id="6-summary">6. Summary</h2>
<p>I first came across Deferred when I was using Python twisted. At the time, I was using Python2, and there was no concurrency. It&rsquo;s not as convenient as a concurrent process, but it solves the problem of repeated callbacks in server programming and improves maintainability of the code. Later, I came across Promise when I was using js, and found that they were similar. Of course, as technology evolves, these will slowly be replaced by concurrent processes. However, it is worth learning from their clever design ideas.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/javascript/">javascript</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/pass-fd-over-domain-socket/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Passing file descriptors between processes via UNIX domain sockets </span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/dht-and-p2p/">
            <span class="next-text nav-default">Distributed Hash Table (DHT) and P2P technologies</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
