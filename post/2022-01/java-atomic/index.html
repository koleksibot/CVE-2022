<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Atomic atomic classes and their underlying principles CAS - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Introduction Atomic means that an operation is uninterruptible. Even when multiple threads are executing together, once an operation is started, it is not interrupted by other threads. So: atomic classes are classes that have the characteristics of atomic/atomic operations. The atomic classes of the concurrency package JUC(java.util.concurrent) are all in java.util.concurrent.atomic. Example Run the following code. 1 2 3 4 5 6 7 8 9 10 11 12 13 14" /><meta name="keywords" content="java, Atomic, CAS" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-01/java-atomic/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Atomic atomic classes and their underlying principles CAS" />
<meta property="og:description" content="Introduction Atomic means that an operation is uninterruptible. Even when multiple threads are executing together, once an operation is started, it is not interrupted by other threads. So: atomic classes are classes that have the characteristics of atomic/atomic operations. The atomic classes of the concurrency package JUC(java.util.concurrent) are all in java.util.concurrent.atomic. Example Run the following code. 1 2 3 4 5 6 7 8 9 10 11 12 13 14" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-01/java-atomic/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-25T11:35:14+08:00" />
<meta property="article:modified_time" content="2022-01-25T11:35:14+08:00" />

<meta itemprop="name" content="Atomic atomic classes and their underlying principles CAS">
<meta itemprop="description" content="Introduction Atomic means that an operation is uninterruptible. Even when multiple threads are executing together, once an operation is started, it is not interrupted by other threads. So: atomic classes are classes that have the characteristics of atomic/atomic operations. The atomic classes of the concurrency package JUC(java.util.concurrent) are all in java.util.concurrent.atomic. Example Run the following code. 1 2 3 4 5 6 7 8 9 10 11 12 13 14"><meta itemprop="datePublished" content="2022-01-25T11:35:14+08:00" />
<meta itemprop="dateModified" content="2022-01-25T11:35:14+08:00" />
<meta itemprop="wordCount" content="8750">
<meta itemprop="keywords" content="java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Atomic atomic classes and their underlying principles CAS"/>
<meta name="twitter:description" content="Introduction Atomic means that an operation is uninterruptible. Even when multiple threads are executing together, once an operation is started, it is not interrupted by other threads. So: atomic classes are classes that have the characteristics of atomic/atomic operations. The atomic classes of the concurrency package JUC(java.util.concurrent) are all in java.util.concurrent.atomic. Example Run the following code. 1 2 3 4 5 6 7 8 9 10 11 12 13 14"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Atomic atomic classes and their underlying principles CAS</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-25 11:35:14 </span>
        <div class="post-category">
            <a href="/categories/news/"> news </a>
            </div>
          <span class="more-meta"> 8750 words </span>
          <span class="more-meta"> 18 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#example">Example</a></li>
        <li><a href="#classification">Classification</a>
          <ul>
            <li><a href="#common-methods">Common methods</a></li>
            <li><a href="#atomic-classes-of-basic-types-take-atomicinteger-as-an-example">Atomic classes of basic types (take <code>AtomicInteger</code> as an example)</a></li>
            <li><a href="#atomic-classes-for-array-types-as-atomicintegerarray-for-example">Atomic classes for array types (as <code>AtomicIntegerArray</code> for example)</a></li>
            <li><a href="#reference-type-atomic-class">Reference type atomic class</a></li>
            <li><a href="#property-modifiers-for-objects">Property Modifiers for Objects</a></li>
          </ul>
        </li>
        <li><a href="#the-underlying-principles">The underlying principles</a>
          <ul>
            <li><a href="#cas">CAS</a></li>
            <li><a href="#problem-solving-for-aba">Problem solving for ABA</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="introduction">Introduction</h2>
<p><code>Atomic</code> means that an operation is uninterruptible. Even when multiple threads are executing together, once an operation is started, it is not interrupted by other threads.</p>
<p>So: <strong>atomic classes</strong> are classes that have the characteristics of atomic/atomic operations.</p>
<p>The atomic classes of the concurrency package <code>JUC(java.util.concurrent)</code> are all in <code>java.util.concurrent.atomic</code>.</p>
<h2 id="example">Example</h2>
<p>Run the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">1000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">date</span><span class="o">.</span><span class="na">volatileNumAdd</span><span class="o">();</span>
                    <span class="n">date</span><span class="o">.</span><span class="na">atomicNumAdd</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">},</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">activeCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 让出当前线程，给其他线程执行
</span><span class="c1"></span>            <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;over! volatile:\t&#34;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="na">volatileNum</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;over! atomic:\t&#34;</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="na">atomicNum</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Date</span> <span class="o">{</span>
    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">volatileNum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="n">AtomicInteger</span> <span class="n">atomicNum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">volatileNumAdd</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">volatileNum</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">atomicNumAdd</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">atomicNum</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The results are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">main     over! volatileNum :    7111
main     over! atomicNum :      10000
</code></pre></td></tr></table>
</div>
</div><h2 id="classification">Classification</h2>
<ul>
<li><strong>Basic types</strong> : update basic types using atomic
<ul>
<li><code>AtomicInteger</code> : Atomic class for integers</li>
<li><code>AtomicLong</code> : Long integer atomic class</li>
<li><code>AtomicBoolean</code> : the boolean atomic class</li>
</ul>
</li>
<li><strong>Array type</strong> : updates an element in an array using atomic methods
<ul>
<li><code>AtomicIntegerArray</code> : the atomic class for integer arrays</li>
<li><code>AtomicLongArray</code> : Atomic class for long integer arrays</li>
<li><code>AtomicReferenceArray</code> : the atomic class for reference type arrays</li>
</ul>
</li>
<li><strong>Reference types</strong> : for wrapping objects
<ul>
<li><code>AtomicReference</code> : atomic class for reference types</li>
<li><code>AtomicMarkableReference</code> : Atomic update of reference types with markers. This class associates a <code>boolean</code> marker with a reference</li>
<li><code>AtomicStampedReference</code> : Atomic update of reference types with version numbers. This class associates integer values with references and can be used to resolve atomic updates to data and version numbers of data, and can solve the <code>ABA</code> problem that can occur when using <code>CAS</code> for atomic updates</li>
</ul>
</li>
<li><strong>Property modification types for objects</strong>
<ul>
<li><code>AtomicIntegerFieldUpdater</code> : updater for atomic updates of integer fields</li>
<li><code>AtomicLongFieldUpdater</code> : updater for atomic updates of long integer fields</li>
<li><code>AtomicReferenceFieldUpdater</code> : Atomic update of fields in reference types</li>
</ul>
</li>
</ul>
<h3 id="common-methods">Common methods</h3>
<h3 id="atomic-classes-of-basic-types-take-atomicinteger-as-an-example">Atomic classes of basic types (take <code>AtomicInteger</code> as an example)</h3>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 无参构造：默认值为0
</span><span class="c1"></span>        <span class="c1">// AtomicInteger atomic = new AtomicInteger();
</span><span class="c1"></span>        <span class="c1">// 有参构造：初始化传入初始值，
</span><span class="c1"></span>        <span class="n">AtomicInteger</span> <span class="n">atomic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;获取当前值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n设置值&#34;</span><span class="o">);</span>
        <span class="n">atomic</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值，并设置新值&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值，并增加值&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n增加值，并获取结果&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="n">2</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值，并自增&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值，并自减&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n自增后，获取当前值，相当于 ++i&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n自减后，获取当前值，相当于 --i&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">decrementAndGet</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n比较并修改值&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果1：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">8</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果2：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">8</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n转换&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomic</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomic</span><span class="o">.</span><span class="na">longValue</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomic</span><span class="o">.</span><span class="na">floatValue</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomic</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The output is as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">获取当前值：1
设置值
新值：5
获取当前值，并设置新值
原始：5
新值：2
获取当前值，并增加值
原始：2
新值：4
增加值，并获取结果
新值：6
获取当前值，并自增
原始：6
新值：7
获取当前值，并自减
原始：7
新值：6
自增后，获取当前值，相当于 ++i
新值：7
自减后，获取当前值，相当于 --i
新值：6
比较并修改值
原始：6
修改结果1：true     值：8
修改结果2：false    值：8
转换
8
8
8.0
8.0
</code></pre></td></tr></table>
</div>
</div><h3 id="atomic-classes-for-array-types-as-atomicintegerarray-for-example">Atomic classes for array types (as <code>AtomicIntegerArray</code> for example)</h3>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">public</span> <span class="nx">class</span> <span class="nx">AtomicIntegerArrayTest</span> <span class="p">{</span>
    <span class="err">@</span><span class="nx">Test</span>
    <span class="nx">void</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 有参构造：指定数组长度，数组内初始值为0
</span><span class="c1"></span>        <span class="c1">// AtomicIntegerArray atomic = new AtomicIntegerArray(10);
</span><span class="c1"></span>        <span class="c1">// 有参构造：传入数组
</span><span class="c1"></span>        <span class="nx">AtomicIntegerArray</span> <span class="nx">atomic</span> <span class="p">=</span> <span class="nx">new</span> <span class="nf">AtomicIntegerArray</span><span class="p">(</span><span class="nx">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">});</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;数组的长度为：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">length</span><span class="p">());</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n获取指定位置的值&#34;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">length</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n更新指定位置值&#34;</span><span class="p">);</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n获取指定位置当前值，并设置新值&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t原始：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">getAndSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n获取指定位置当前值，并增加值&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t原始：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">getAndAdd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n指定位置增加值，并获取结果&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">addAndGet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n获取指定位置当前值，并自增&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t原始：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">getAndIncrement</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n获取指定位置当前值，并自减&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t原始：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">getAndDecrement</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n指定位置自增后，获取当前值，相当于 ++i&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">incrementAndGet</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n指定位置自减后，获取当前值，相当于 --i&#34;</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t新值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">decrementAndGet</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;\n指定位置比较并修改值&#34;</span><span class="p">);</span>
        <span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t原始：&#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t修改结果1：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">compareAndSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nb">println</span><span class="p">(</span><span class="s">&#34;位置：&#34;</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">+</span> <span class="s">&#34;\t修改结果2：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">compareAndSet</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">数组的长度为</span><span class="err">：</span><span class="n">5</span>
<span class="n">获取指定位置的值</span>
<span class="n">0</span>    <span class="n">1</span>
<span class="n">1</span>    <span class="n">2</span>
<span class="n">2</span>    <span class="n">3</span>
<span class="n">3</span>    <span class="n">4</span>
<span class="n">4</span>    <span class="n">5</span>
<span class="n">更新指定位置值</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">2</span>
<span class="n">获取指定位置当前值</span><span class="err">，</span><span class="n">并设置新值</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">原始</span><span class="err">：</span><span class="n">2</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">2</span>
<span class="n">获取指定位置当前值</span><span class="err">，</span><span class="n">并增加值</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">原始</span><span class="err">：</span><span class="n">2</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">4</span>
<span class="n">指定位置增加值</span><span class="err">，</span><span class="n">并获取结果</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">6</span>
<span class="n">获取指定位置当前值</span><span class="err">，</span><span class="n">并自增</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">原始</span><span class="err">：</span><span class="n">6</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">7</span>
<span class="n">获取指定位置当前值</span><span class="err">，</span><span class="n">并自减</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">原始</span><span class="err">：</span><span class="n">7</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">6</span>
<span class="n">指定位置自增后</span><span class="err">，</span><span class="n">获取当前值</span><span class="err">，</span><span class="n">相当于</span> <span class="o">++</span><span class="n">i</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">7</span>
<span class="n">指定位置自减后</span><span class="err">，</span><span class="n">获取当前值</span><span class="err">，</span><span class="n">相当于</span> <span class="o">--</span><span class="n">i</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">新值</span><span class="err">：</span><span class="n">6</span>
<span class="n">指定位置比较并修改值</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">原始</span><span class="err">：</span><span class="n">6</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">修改结果1</span><span class="err">：</span><span class="kc">true</span>     <span class="n">值</span><span class="err">：</span><span class="n">8</span>
<span class="n">位置</span><span class="err">：</span><span class="n">0</span>    <span class="n">修改结果2</span><span class="err">：</span><span class="kc">false</span>    <span class="n">值</span><span class="err">：</span><span class="n">8</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="reference-type-atomic-class">Reference type atomic class</h3>
<p>The reference type is used to modify objects, examples of objects are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">@</span><span class="nx">Getter</span>
<span class="err">@</span><span class="nx">Setter</span>
<span class="err">@</span><span class="nx">NoArgsConstructor</span>
<span class="err">@</span><span class="nx">AllArgsConstructor</span>
<span class="err">@</span><span class="nx">ToString</span>
<span class="nx">public</span> <span class="nx">class</span> <span class="nx">Person</span> <span class="p">{</span>
    <span class="nx">private</span> <span class="nx">String</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">private</span> <span class="nx">Integer</span> <span class="nx">age</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="atomicreference"><code>AtomicReference</code></h4>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicReferenceTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 无参构造：默认null
</span><span class="c1"></span>        <span class="c1">// AtomicReference&lt;Person&gt; atomic = new AtomicReference&lt;&gt;();
</span><span class="c1"></span>        <span class="c1">// 有参构造：传入初始对象
</span><span class="c1"></span>        <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">atomic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;张三&#34;</span><span class="o">,</span> <span class="n">25</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;获取当前值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n设置值&#34;</span><span class="o">);</span>
        <span class="n">atomic</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;李四&#34;</span><span class="o">,</span> <span class="n">30</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值，并设置新值&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;王五&#34;</span><span class="o">,</span> <span class="n">35</span><span class="o">)));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n比较并修改值&#34;</span><span class="o">);</span>
        <span class="n">Person</span> <span class="n">oldP</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">Person</span> <span class="n">newP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;赵六&#34;</span><span class="o">,</span> <span class="n">40</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原始：&#34;</span> <span class="o">+</span> <span class="n">oldP</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果1：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果2：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\t值：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">获取当前值：Person(name=张三, age=25)
设置值
新值：Person(name=李四, age=30)
获取当前值，并设置新值
原始：Person(name=李四, age=30)
新值：Person(name=王五, age=35)
比较并修改值
原始：Person(name=王五, age=35)
修改结果1：true     值：Person(name=赵六, age=40)
修改结果2：false    值：Person(name=赵六, age=40)
</code></pre></td></tr></table>
</div>
</div><h4 id="atomicmarkablereference"><code>AtomicMarkableReference</code></h4>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicMarkableReferenceTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 有参构造：初始化对象和标记
</span><span class="c1"></span>        <span class="n">AtomicMarkableReference</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">atomic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicMarkableReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;张三&#34;</span><span class="o">,</span> <span class="n">18</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;取值：&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值并同时将标记存储在boolean类型的数组中（数组长度至少为1）&#34;</span><span class="o">);</span>
        <span class="kt">boolean</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arr</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;标记：&#34;</span> <span class="o">+</span> <span class="n">arr</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n设置值和标记&#34;</span><span class="o">);</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;李四&#34;</span><span class="o">,</span> <span class="n">30</span><span class="o">);</span>
        <span class="n">atomic</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n当对象相同时，单独修改标记&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">attemptMark</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n比较并修改值&#34;</span><span class="o">);</span>
        <span class="n">Person</span> <span class="n">oldP</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">();</span>
        <span class="kt">boolean</span> <span class="n">oldF</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">();</span>
        <span class="n">Person</span> <span class="n">newP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;王五&#34;</span><span class="o">,</span> <span class="n">45</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">newF</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果1：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">,</span> <span class="n">oldF</span><span class="o">,</span> <span class="n">newF</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果2：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">,</span> <span class="n">oldF</span><span class="o">,</span> <span class="n">newF</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;标记：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">isMarked</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">取值：
对象：Person(name=张三, age=18)
标记：false
获取当前值并同时将标记存储在boolean类型的数组中（数组长度至少为1）
对象：Person(name=张三, age=18)
标记：false
设置值和标记
新对象：Person(name=李四, age=30)
新标记：true
当对象相同时，单独修改标记
原标记：true
修改结果：true
新标记：false
比较并修改值
修改结果1：true
对象：Person(name=王五, age=45)
标记：false
修改结果2：false
对象：Person(name=王五, age=45)
标记：false
</code></pre></td></tr></table>
</div>
</div><h4 id="atomicstampedreference"><code>AtomicStampedReference</code></h4>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicStampedReferenceTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 有参构造：初始化对象和标记
</span><span class="c1"></span>        <span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">atomic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;张三&#34;</span><span class="o">,</span> <span class="n">18</span><span class="o">),</span> <span class="n">1</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;取值：&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n获取当前值并同时将标记存储在boolean类型的数组中（数组长度至少为1）&#34;</span><span class="o">);</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arr</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;版本：&#34;</span> <span class="o">+</span> <span class="n">arr</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n设置值和版本&#34;</span><span class="o">);</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;李四&#34;</span><span class="o">,</span> <span class="n">30</span><span class="o">);</span>
        <span class="n">atomic</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">2</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n当对象相同时，单独修改版本&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;原版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">attemptStamp</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">3</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;新版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n比较并修改值&#34;</span><span class="o">);</span>
        <span class="n">Person</span> <span class="n">oldP</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">oldV</span> <span class="o">=</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
        <span class="n">Person</span> <span class="n">newP</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;王五&#34;</span><span class="o">,</span> <span class="n">45</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">newV</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果1：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">,</span> <span class="n">oldV</span><span class="o">,</span> <span class="n">newV</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;修改结果2：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldP</span><span class="o">,</span> <span class="n">newP</span><span class="o">,</span> <span class="n">oldV</span><span class="o">,</span> <span class="n">newV</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;对象：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;版本：&#34;</span> <span class="o">+</span> <span class="n">atomic</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">取值：
对象：Person(name=张三, age=18)
版本：1
获取当前值并同时将标记存储在boolean类型的数组中（数组长度至少为1）
对象：Person(name=张三, age=18)
版本：1
设置值和版本
新对象：Person(name=李四, age=30)
新版本：2
当对象相同时，单独修改版本
原版本：2
修改结果：true
新版本：3
比较并修改值
修改结果1：true
对象：Person(name=王五, age=45)
版本：4
修改结果2：false
对象：Person(name=王五, age=45)
版本：4
</code></pre></td></tr></table>
</div>
</div><h3 id="property-modifiers-for-objects">Property Modifiers for Objects</h3>
<p>If you need to update a field in a class atomically, you need to use the object&rsquo;s property modifier atomic class.</p>
<p>Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicFieldUpdaterTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 整形字段的更新器
</span><span class="c1"></span>        <span class="c1">// 使用静态方法创建更新器，第一个参数为对象类型，第二个参数为要更新的字段名称，该字段必须修饰为 public volatile
</span><span class="c1"></span>        <span class="n">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="n">User1</span><span class="o">&gt;</span> <span class="n">integerUpdater</span> <span class="o">=</span> <span class="n">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">User1</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;age&#34;</span><span class="o">);</span>
        <span class="n">User1</span> <span class="n">user1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User1</span><span class="o">(</span><span class="s">&#34;Java&#34;</span><span class="o">,</span> <span class="n">22</span><span class="o">);</span>
        <span class="c1">// 获取当前对象被管理字段的值并原子自增
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">integerUpdater</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">user1</span><span class="o">));</span>
        <span class="c1">// 获取当前对象被管理字段的值
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">integerUpdater</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">user1</span><span class="o">));</span>
        <span class="c1">// 引用类型字段的更新器
</span><span class="c1"></span>        <span class="c1">// 使用静态方法创建更新器，第一个参数为对象类型，第二个参数为要更新的字段类型，第三个参数为要更新的字段名称，该字段必须修饰为 public volatile
</span><span class="c1"></span>        <span class="n">AtomicReferenceFieldUpdater</span><span class="o">&lt;</span><span class="n">User2</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">referenceUpdater</span> <span class="o">=</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">User2</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;age&#34;</span><span class="o">);</span>
        <span class="n">User2</span> <span class="n">user2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User2</span><span class="o">(</span><span class="s">&#34;Jerry&#34;</span><span class="o">,</span> <span class="n">18</span><span class="o">);</span>
        <span class="c1">// 获取当前对象被管理字段的值并设置新值
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">referenceUpdater</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="n">user2</span><span class="o">,</span> <span class="n">20</span><span class="o">));</span>
        <span class="c1">// 获取当前对象被管理字段的值
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">referenceUpdater</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">user2</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">class</span> <span class="nc">User1</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">class</span> <span class="nc">User2</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">22
23
18
20
</code></pre></td></tr></table>
</div>
</div><h2 id="the-underlying-principles">The underlying principles</h2>
<p><code>AtomicInteger</code> part of the underlying source code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicInteger</span> <span class="kd">extends</span> <span class="n">Number</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
    <span class="c1">// setup to use Unsafe.compareAndSwapInt for updates
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">valueOffset</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">valueOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                <span class="o">(</span><span class="n">AtomicInteger</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * Creates a new AtomicInteger with the given initial value.
</span><span class="cm">     *
</span><span class="cm">     * @param initialValue the initial value
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">AtomicInteger</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">initialValue</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * Atomically increments by one the current value.
</span><span class="cm">     *
</span><span class="cm">     * @return the previous value
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li><code>Unsafe</code>: is the core class of <code>CAS</code>. Since the <code>Java</code> methods do not have direct access to the underlying system and need to be accessed through the native <code>(native)</code> methods, <code>Unsafe</code> is equivalent to a backdoor, based on which
class allows direct manipulation of memory-specific data. The <code>Unsafe</code> class is present in the <code>sun.misc</code> package and its internal method operations can manipulate memory directly as if it were a pointer to <code>C</code>, since the execution of <code>CAS</code> operations in <code>Java</code> depends on the methods of the <code>Unsafe</code> class. Note that all the methods in the <code>Unsafe</code> class are <code>native</code>-modified. This means that the methods in the <code>Unsaf</code> class call directly on the underlying OS resources to perform the corresponding task.</li>
<li><code>valueOffset</code>: indicates the offset address of the variable&rsquo;s value in memory, since <code>Unsafe</code> retrieves data based on the memory offset address.</li>
<li><code>value</code>: The variable is modified with <code>volatile</code> to ensure memory visibility between multiple threads.</li>
<li><code>getAndIncrement()</code> : <code>AtomicInteger.getAndIncrement()</code> passes in three values to <code>Unsafe.getAndAddInt()</code>
<ol>
<li><code>this</code>: the current object</li>
<li><code>valueOffset</code> : the memory address of the current object</li>
<li><code>1</code> : the value to be added</li>
</ol>
</li>
</ol>
<p><code>Unsafe.getAndAddInt(Object var1, long var2, int var4)</code> Source Code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAddInt</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="kt">long</span> <span class="n">var2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">var5</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">var5</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getIntVolatile</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">while</span><span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="n">var2</span><span class="o">,</span> <span class="n">var5</span><span class="o">,</span> <span class="n">var5</span> <span class="o">+</span> <span class="n">var4</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">var5</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>first <code>this.getIntVolatile(var1, var2)</code> gets the snapshot value <code>var5</code> of the current object <code>var1</code> at memory address <code>var2</code></li>
<li>Assuming that some time has passed since the snapshot value was obtained</li>
<li>then <code>this.compareAndSwapInt(var1, var2, var5, var5 + var4)</code> gets the real value of the current object <code>var1</code> at memory address <code>var2</code> and compares it to the snapshot value <code>var5</code>
<ol>
<li>same: means that the true value of the object has not changed during this time, then update to the desired value <code>var5 + var4</code> and return <code>true</code>, reverse to <code>false</code> and jump out of the current loop, finally return the original value <code>var5</code></li>
<li>different: means that the true value of the object has changed in the meantime, then return <code>false</code>, reverse to <code>true</code> and enter the loop again to retrieve the value and compare it again until it finishes</li>
</ol>
</li>
</ol>
<p>Another example: suppose two threads, thread A and thread B, perform the <code>getAndAddInt</code> operation at the same time</p>
<ol>
<li>the original value of <code>value</code> inside <code>AtomicInteger</code> is 3, i.e. the <code>value</code> of <code>AtomicInteger</code> in main memory is 3. According to the JMM model, thread A and thread B each hold a copy of <code>value</code> with value 3 in their respective working memory.</li>
<li>Thread A gets the <code>value</code> value 3 via <code>getIntVolatile(var1, var2)</code>, at which point thread A is hung.</li>
<li>Thread B gets the <code>value</code> value 3 via <code>getIntVolatile(var1, var2)</code>, just as Thread B is not hung and executes the <code>compareAndSwapInt</code> method to compare memory values to 3 as well, successfully modifying the memory value to 4.</li>
<li>At this point Thread A resumes, executes the <code>compareAndSwapInt</code> method and finds that its value of 3 does not match the value of 4 in main memory, which means that the value has already been modified by other threads, so Thread A fails this modification and has to read it again and start over.</li>
<li>Thread A retrieves the <code>value</code> value, which is always visible to thread A because the variable <code>value</code> is modified by <code>volatile</code>, and thread A continues to execute <code>compareAndSwapInt</code> to compare and replace it until it succeeds.</li>
</ol>
<h3 id="cas">CAS</h3>
<blockquote>
<p>Principle</p>
</blockquote>
<p>The full name of <code>CAS</code> is <code>Compare-And-Swap</code>, and it is a <code>CPU</code> concurrent language. Its function is to determine whether the value at a location in memory is the expected value, and if so, to change it to the new value, which is done atomically.</p>
<p>The <code>CAS</code> concurrency primitive is represented in the <code>JAVA</code> language by methods in the <code>sun.misc.Unsafe</code> class. By calling the <code>CAS</code> method in the <code>UnSafe</code> class, the <code>JVM</code> will implement the <code>CAS</code> assembly instruction for us. This is a completely hardware-dependent function through which atomic operations are implemented. Again, since <code>CAS</code> is a system primitive, which is an operating system terminology, it consists of a number of instructions that perform a certain function, and the execution of the primitive must be continuous and not interrupted during the execution, i.e. <code>CAS</code> is a <code>CPU</code> atomic instruction and does not cause the so-called data inconsistency problem.</p>
<p>The <code>compareAndSwapInt</code> in the <code>Unsafe</code> class is a native method, the implementation of which is located in <code>unsafe.cpp</code>. The following is part of the source code and is available at: <a href="http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/tip/src/share/vm/prims/unsafe.cpp">http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/tip/src/share/vm/prims/unsafe.cpp</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">UNSAFE_ENTRY</span><span class="p">(</span><span class="n">jboolean</span><span class="p">,</span> <span class="n">Unsafe_CompareAndSwapInt</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">unsafe</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">offset</span><span class="p">,</span> <span class="n">jint</span> <span class="n">e</span><span class="p">,</span> <span class="n">jint</span> <span class="n">x</span><span class="p">))</span>
  <span class="n">UnsafeWrapper</span><span class="p">(</span><span class="s">&#34;Unsafe_CompareAndSwapInt&#34;</span><span class="p">);</span>
  <span class="n">oop</span> <span class="n">p</span> <span class="o">=</span> <span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
  <span class="n">jint</span><span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">jint</span> <span class="o">*</span><span class="p">)</span> <span class="n">index_oop_from_field_offset_long</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">jint</span><span class="p">)(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="o">==</span> <span class="n">e</span><span class="p">;</span>
<span class="n">UNSAFE_END</span>
</code></pre></td></tr></table>
</div>
</div><p>First get the address of the variable <code>value</code> in memory. This is then compared and replaced by <code>Atomic::cmpxchg</code>, where the argument <code>x</code> is the value to be updated and the argument <code>e</code> is the original memory value.</p>
<blockquote>
<p>Disadvantages</p>
</blockquote>
<ol>
<li>long loop time overhead: there is a <code>do while</code> in the source code, and if <code>CAS</code> keeps failing, it will impose a large overhead on <code>CPU</code></li>
<li>only one shared variable can be guaranteed atomic operation: when operating on multiple shared variables, atomicity is not guaranteed</li>
<li>ABA problems can occur</li>
</ol>
<h3 id="problem-solving-for-aba">Problem solving for ABA</h3>
<blockquote>
<p>Generation of the ABA problem</p>
</blockquote>
<p>An important prerequisite for the implementation of the <code>CAS</code> algorithm is the need to take data out of memory at one point in time and compare and replace it at the current point in time, then at this time difference class will result in a change in the data. Let&rsquo;s say thread A, thread B takes V1 out of memory, then thread B does something to change the value to V2 and then does something to change the value back to V1, at which point thread A does a CAS operation and finds that V1 is still in memory, and then thread A succeeds. Although Thread A&rsquo;s CAS operation succeeds, it does not mean that the process is problem-free.</p>
<blockquote>
<p>Solution to the ABA problem</p>
</blockquote>
<p>Simply use the atomic class <code>AtomicStampedReference</code> with version control</p>
<blockquote>
<p>Code</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ABATest</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 普通的对象引用原子类，不能解决ABA问题
</span><span class="cm">     */</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">atomicReference</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">atomicReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="n">100</span><span class="o">);</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">);</span>
            <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// 暂停一会t2线程，保证上面的t1线程完成了一次ABA操作
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">2019</span><span class="o">));</span>
        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 等待线程结束
</span><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">activeCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 让出当前线程，给其他线程执行
</span><span class="c1"></span>            <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * 带版本控制的对象引用原子类，可以解决ABA的问题
</span><span class="cm">     */</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">atomicStampedReference</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">atomicStampedReference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="n">100</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// 获取初始版本
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t第1次版本号：&#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
            <span class="c1">// 暂停一会t1线程，保证t2线程获取到了初始版本号
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">101</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="o">++</span><span class="n">stamp</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t第2次版本号：&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
            <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">101</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="o">++</span><span class="n">stamp</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t第3次版本号：&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
        <span class="o">},</span> <span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// 获取初始版本
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t第1次版本号：&#34;</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
            <span class="c1">// 暂停一会t2线程，保证上面的t3线程完成了一次ABA操作
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">2019</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="o">++</span><span class="n">stamp</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t修改成功否：&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">},</span> <span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 等待线程结束
</span><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">activeCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 让出当前线程，给其他线程执行
</span><span class="c1"></span>            <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;当前最新实际版本号：&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t当前实际最新值：&#34;</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Outout.</p>
<p>The atomic class <code>AtomicReference</code> without version control has an <code>ABA</code> problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">true
2019
</code></pre></td></tr></table>
</div>
</div><p>The atomic class <code>AtomicStampedReference</code>, which carries version control, can solve the <code>ABA</code> problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">t1    第1次版本号：1
t2    第1次版本号：1
t1    第2次版本号：2
t1    第3次版本号：3
t2    修改成功否：false
当前最新实际版本号：3    当前实际最新值：100
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">java</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-01/go-waitgroup-memory-alignment/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Thinking about memory alignment by WaitGroup in Go</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-01/go-memory-allocation/">
            <span class="next-text nav-default">Explaining the Golang memory allocation implementation from source code</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
