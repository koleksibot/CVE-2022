<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Switching from Nginx to Caddy  - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In the past few days, I switched the company&amp;rsquo;s test environment Nginx to Caddy, and there is still a little problem in the actual switching process, but I feel good so far, so I will record some details here. Why switch Most of the time we use a domain name for our production environment, and to ensure isolation we use another domain name for our test environment (test environment buy" /><meta name="keywords" content="nginx, caddy" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-08/switching-rrom-nginx-too-caddy/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Switching from Nginx to Caddy " />
<meta property="og:description" content="In the past few days, I switched the company&rsquo;s test environment Nginx to Caddy, and there is still a little problem in the actual switching process, but I feel good so far, so I will record some details here. Why switch Most of the time we use a domain name for our production environment, and to ensure isolation we use another domain name for our test environment (test environment buy" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-08/switching-rrom-nginx-too-caddy/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-25T17:06:00+08:00" />
<meta property="article:modified_time" content="2021-08-25T17:06:00+08:00" />

<meta itemprop="name" content="Switching from Nginx to Caddy ">
<meta itemprop="description" content="In the past few days, I switched the company&rsquo;s test environment Nginx to Caddy, and there is still a little problem in the actual switching process, but I feel good so far, so I will record some details here. Why switch Most of the time we use a domain name for our production environment, and to ensure isolation we use another domain name for our test environment (test environment buy"><meta itemprop="datePublished" content="2021-08-25T17:06:00+08:00" />
<meta itemprop="dateModified" content="2021-08-25T17:06:00+08:00" />
<meta itemprop="wordCount" content="1913">
<meta itemprop="keywords" content="nginx,caddy," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Switching from Nginx to Caddy "/>
<meta name="twitter:description" content="In the past few days, I switched the company&rsquo;s test environment Nginx to Caddy, and there is still a little problem in the actual switching process, but I feel good so far, so I will record some details here. Why switch Most of the time we use a domain name for our production environment, and to ensure isolation we use another domain name for our test environment (test environment buy"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Switching from Nginx to Caddy </h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-25 17:06:00 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1913 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#why-switch">Why switch</a></li>
        <li><a href="#details-involved-in-switching">Details involved in switching</a>
          <ul>
            <li><a href="#rule-matching">Rule Matching</a></li>
            <li><a href="#rule-rewriting">Rule Rewriting</a></li>
            <li><a href="#websocket-proxy">WebSocket Proxy</a></li>
            <li><a href="#url-encoding">URL encoding</a></li>
            <li><a href="#forced-http">Forced HTTP</a></li>
            <li><a href="#proxy-https">Proxy HTTPS</a></li>
            <li><a href="#custom-certificates">Custom Certificates</a></li>
            <li><a href="#log-printing">Log Printing</a></li>
            <li><a href="#tls-versions-are-not-supported">TLS versions are not supported</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the past few days, I switched the company&rsquo;s test environment Nginx to Caddy, and there is still a little problem in the actual switching process, but I feel good so far, so I will record some details here.</p>
<h2 id="why-switch">Why switch</h2>
<p>Most of the time we use a domain name for our production environment, and to ensure isolation we use another domain name for our test environment (test environment buy <code>*.link</code> domain name, which can be filed in China and is also very cheap); however, we are not too willing to pay for the test domain name to buy a certificate, so we have been using ACME.</p>
<p>As we all know, the certificate of this thing needs to be renewed once every 3 months, scripted renewal and then nginx reload is sometimes not very reliable, in short, the scripted operation is still a bit risky in a complicated internal environment, so we finally decided to use Caddy once and for all.</p>
<h2 id="details-involved-in-switching">Details involved in switching</h2>
<h3 id="rule-matching">Rule Matching</h3>
<p>In one site we used Nginx to determine the User-Agent to handle whether the visit was mobile or desktop, and to be honest I hate this kind of stuff:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">map</span> <span class="nv">$http_user_agent</span> <span class="nv">$is_desktop</span> <span class="p">{</span>
    <span class="kn">default</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kn">~*linux.*android|windows\s+(?:ce|phone)</span> <span class="mi">0</span><span class="p">;</span> <span class="c1"># exceptions to the rule
</span><span class="c1"></span>    <span class="kn">~*spider|crawl|slurp|bot</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># bots
</span><span class="c1"></span>    <span class="kn">~*windows|linux|os\s+x\s*[\d\._]+|solaris|bsd</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># OSes
</span><span class="c1"></span><span class="p">}</span>

<span class="k">map</span> <span class="nv">$is_desktop</span> <span class="nv">$is_mobile</span> <span class="p">{</span>
    <span class="kn">1</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kn">0</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="c1"># reverse proxy
</span><span class="c1"></span>    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">if</span> <span class="s">(</span><span class="nv">$is_mobile</span><span class="s">)</span> <span class="p">{</span>
            <span class="kn">rewrite</span> <span class="s">^</span> <span class="s">https://</span><span class="nv">$host/h5</span> <span class="s">redirect</span><span class="p">;</span>
            <span class="kn">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
        <span class="kn">include</span> <span class="s">conf.d/common/proxy.conf</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>At first, I found out that Caddy also supports maps by looking up the Caddy documentation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">map {host}             {my_placeholder}  {magic_number} {
	example.com        &#34;some value&#34;      3
	foo.example.com    &#34;another value&#34;
	(.*)\.example.com  &#34;${1} subdomain&#34;  5

	~.*\.net$          -                 7
	~.*\.xyz$          -                 15

	default            &#34;unknown domain&#34;  42
}
</code></pre></td></tr></table>
</div>
</div><p>In the actual configuration found that this problem only requires a custom rule matcher to determine whether it is mobile or not:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">@mobile {
    header_regexp User-Agent (?i)linux.*android|windows\s+(?:ce|phone)
    not path_regexp ^.+\.(?:css|cur|js|jpe?g|gif|htc|ico|png|html|xml|otf|ttf|eot|woff|woff2|svg)$
    not path /web/*
}
rewrite @mobile /h5/{path}?{query}
</code></pre></td></tr></table>
</div>
</div><p>When writing subsequent matching rules, we found that Caddy&rsquo;s matching rules are indeed very powerful, and you can find basically From request headers to request methods, protocols, request paths, from standard matching to wildcard and regular matching, and even support code-based <a href="https://github.com/google/cel-spec">CEL (Common Expression Language)</a> expressions. matching; multiple matches can also be custom named as business-related matchers</p>
<h3 id="rule-rewriting">Rule Rewriting</h3>
<p>In Nginx, the rewrite directive has multiple behaviors, such as rewriting URLs implicitly or returning redirect codes such as 301 and 307; however, in Caddy, these two behaviors are divided into two directives:</p>
<ul>
<li>rewrite: internal rewrite, internal replacement of URL, parameters, etc., browser address will remain unchanged</li>
<li>redir: redirect, return HTTP status code for client to redirect to new page by itself</li>
</ul>
<h4 id="rewrite">rewrite</h4>
<p>The implicit rewrite command for addresses has the following syntax rules:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">rewrite [&lt;matcher&gt;] &lt;to&gt;
</code></pre></td></tr></table>
</div>
</div><p>The matcher is the global standard matcher definition, you can use the built-in one, or you can combine the built-in matcher into a custom matcher, which is much more powerful than Nginx; there are three cases in <code>to</code>:</p>
<ul>
<li>
<p><strong>Replace only PATH: <code>rewrite /abc /bcd</code> :</strong></p>
<p>In this case, rewrite determines the matching path based on the &ldquo;matcher&rdquo; and then completely replaces it with the last path; <strong>the last path can be referenced to the original path using the <code>{path}</code> placeholder.</strong></p>
</li>
<li>
<p><strong>Replace only request parameters: <code>rewrite /api ?a=b</code> :</strong></p>
<p>In this case, Caddy uses <code>?</code> as a separator, so if <code>?</code> is followed by something it means that the request parameter is replaced with a later request parameter; <strong>the last request parameter can be referenced to the original request parameter by <code>{query}</code>.</strong></p>
</li>
<li>
<p><strong>replace all: <code>rewrite /abc /bcd?{query}&amp;custom=1</code> :</strong></p>
<p>In this case, Caddy replaces both the request path and the request parameters according to the &ldquo;matcher&rdquo; match, and of course both placeholders are available.</p>
<p><strong>Note: <code>rewrite</code> only does rewrites, it does not break the request chain, which means that the final result is determined by the subsequent request matches.</strong></p>
</li>
</ul>
<h4 id="redir">redir</h4>
<p>redir is used to declare an explicit redirect to the client, i.e. to return a specific redirect status code, with the following syntax:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">redir [&lt;matcher&gt;] &lt;to&gt; [&lt;code&gt;]
</code></pre></td></tr></table>
</div>
</div><p>The matchers are the same; <strong><code>&lt;to&gt;</code> This parameter is returned as the Location header, where you can use placeholders to refer to the original variables:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">redir * https://example.com{uri}
</code></pre></td></tr></table>
</div>
</div><p>The <code>code</code> section is divided into four cases:</p>
<ul>
<li>a custom status code for <code>3xx</code></li>
<li><code>temporary</code> : returns a 302 temporary redirect</li>
<li><code>permanent</code> : returns a 301 permanent redirect</li>
<li><code>html</code> : redirects using the HTML document method</li>
</ul>
<p>For example, to permanently redirect all requests to a new site:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">redir https://example.com{uri} permanent
</code></pre></td></tr></table>
</div>
</div><p>The HTML approach here is more difficult to understand, and it originates from a specification as follows:</p>
<blockquote>
<p>The redirection mechanism in the HTTP protocol is the preferred way to create redirection maps, but sometimes web developers have no control over the server or cannot configure it. For these application-specific scenarios, web developers can add an element to the carefully crafted HTML page&rsquo;s</p>
<p>section and set the value of its http-equiv attribute to refresh. When the page is displayed, the browser will detect the element and jump to the specified page.</p>
</blockquote>
<p>If the <code>html</code> redirect method is used in the source code, Caddy will return an HTML page for the browser to refresh itself if the above method is used:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">body</span> <span class="nx">string</span>
<span class="k">switch</span> <span class="nx">code</span> <span class="p">{</span>
<span class="k">case</span> <span class="s2">&#34;permanent&#34;</span><span class="o">:</span>
	<span class="nx">code</span> <span class="o">=</span> <span class="s2">&#34;301&#34;</span>
<span class="k">case</span> <span class="s2">&#34;temporary&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="o">:</span>
	<span class="nx">code</span> <span class="o">=</span> <span class="s2">&#34;302&#34;</span>
<span class="k">case</span> <span class="s2">&#34;html&#34;</span><span class="o">:</span>
	<span class="c1">// Script tag comes first since that will better imitate a redirect in the browser&#39;s
</span><span class="c1"></span>	<span class="c1">// history, but the meta tag is a fallback for most non-JS clients.
</span><span class="c1"></span>	<span class="kr">const</span> <span class="nx">metaRedir</span> <span class="o">=</span> <span class="sb">`&lt;!DOCTYPE html&gt;
</span><span class="sb">&lt;html&gt;
</span><span class="sb">&lt;head&gt;
</span><span class="sb">	&lt;title&gt;Redirecting...&lt;/title&gt;
</span><span class="sb">	&lt;script&gt;window.location.replace(&#34;%s&#34;);&lt;/script&gt;
</span><span class="sb">	&lt;meta http-equiv=&#34;refresh&#34; content=&#34;0; URL=&#39;%s&#39;&#34;&gt;
</span><span class="sb">&lt;/head&gt;
</span><span class="sb">&lt;body&gt;Redirecting to &lt;a href=&#34;%s&#34;&gt;%s&lt;/a&gt;...&lt;/body&gt;
</span><span class="sb">&lt;/html&gt;
</span><span class="sb">`</span>
	<span class="nx">safeTo</span> <span class="o">:=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">EscapeString</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
	<span class="nx">body</span> <span class="o">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">metaRedir</span><span class="p">,</span> <span class="nx">safeTo</span><span class="p">,</span> <span class="nx">safeTo</span><span class="p">,</span> <span class="nx">safeTo</span><span class="p">,</span> <span class="nx">safeTo</span><span class="p">)</span>
	<span class="nx">code</span> <span class="o">=</span> <span class="s2">&#34;302&#34;</span>
<span class="k">default</span><span class="o">:</span>
	<span class="nx">codeInt</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">nil</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">Errf</span><span class="p">(</span><span class="s2">&#34;Not a supported redir code type or not valid integer: &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">codeInt</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="o">||</span> <span class="nx">codeInt</span> <span class="o">&gt;</span> <span class="mi">399</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">nil</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">Errf</span><span class="p">(</span><span class="s2">&#34;Redir code not in the 3xx range: &#39;%v&#39;&#34;</span><span class="p">,</span> <span class="nx">codeInt</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="uri">uri</h4>
<p>The <code>uri</code> directive is a special directive that is similar to <code>rewrite</code>, except that it is more convenient for rewriting URIs, and has the following syntax:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">uri [&lt;matcher&gt;] strip_prefix|strip_suffix|replace|path_regexp \
	&lt;target&gt; \
	[&lt;replacement&gt; [&lt;limit&gt;]]
</code></pre></td></tr></table>
</div>
</div><p>The second parameter in the syntax is a verb that defines how to replace the URI:</p>
<ul>
<li><code>strip_prefix</code> : removes the prefix from the path</li>
<li><code>strip_suffix</code> : Remove suffixes from paths</li>
<li><code>replace</code> : perform subreplacements throughout the URI path (e.g. <code>/a/b/c/d</code> is replaced with <code>/a/1/2/d</code>)</li>
<li><code>path_regexp</code> : perform regular replacement in paths</li>
</ul>
<p>Here are some examples:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># Remove the &#34;/api/v1&#34; prefix
uri strip_prefix /api/v1

# Removing the &#34;.html&#34; suffix
uri strip_suffix .html

# Subpath replacement &#34;/v1&#34; =&gt; &#34;/v2&#34;
uri replace /v1/ /v2/

# Regular replacement &#34;/api/version&#34; =&gt; &#34;/api&#34;
uri path_regexp /api/v\d /api
</code></pre></td></tr></table>
</div>
</div><p>where <code>replace</code> can be followed by a number at the end, representing how many times to find the replacement from the URI, the default is <code>-1</code> that is, replace all.</p>
<h3 id="websocket-proxy">WebSocket Proxy</h3>
<p>In the Nginx configuration, if you want to proxy WebSocket links, we need to add the following settings:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;upgrade&#34;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>But in Caddy it&rsquo;s much simpler&hellip; so simple that we don&rsquo;t have to do anything, it&rsquo;s automatically supported:</p>
<blockquote>
<p>Websocket proxying “just works” in v2; there is no need to “enable” websockets like in v1.</p>
</blockquote>
<h3 id="url-encoding">URL encoding</h3>
<p>When using a path matcher, URLs are decoded by default, e.g. :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># Chinese has been decoded, you need to write the decoded string directly to match the
redir /2016/03/22/Java-内存之直接内存 https://mritd.com/2016/03/22/java-memory-direct-memory permanent
</code></pre></td></tr></table>
</div>
</div><p><strong>As for the reverse proxy <code>reverse_proxy</code>, I haven&rsquo;t encountered the encoding when passing it out yet, so I need to test it</strong></p>
<h3 id="forced-http">Forced HTTP</h3>
<p>Some sites may be HTTP by default, and we don&rsquo;t expect to access them by HTTPS; however, Caddy will apply for ACME certificate for the site by default, and we can&rsquo;t access them if we can&rsquo;t apply for the certificate; in this case, we just need to write the HTTP protocol on the site address forcibly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">http://example.com {
    reverse_proxy ...
}
</code></pre></td></tr></table>
</div>
</div><h3 id="proxy-https">Proxy HTTPS</h3>
<p>If you want to proxy HTTPS service, you only need to fill in the HTTPS address in <code>reverse_proxy</code>; <strong>but unlike Nginx, Caddy&rsquo;s TLS checksum is on by default, so if the backend HTTPS certificate is expired, it may cause Caddy to return a 502 error;</strong> this can be turned off by using <code>transport</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">reg.example.com {
    handle {
        request_body {
            max_size 1G
        }
        reverse_proxy {
            to https://172.16.11.40:443
            transport http {
                # SNI
                tls_server_name reg.example.link
                # Turn off back-end TLS authentication
                tls_insecure_skip_verify
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="custom-certificates">Custom Certificates</h3>
<p>If you already have your own certificate and do not expect Caddy to apply it automatically, just add the certificate after the <code>tls</code> command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">reg.example.com {
    handle {
        ...
    }
    
    # Using custom certificates
    tls cert.pem key.pem
}
</code></pre></td></tr></table>
</div>
</div><h3 id="log-printing">Log Printing</h3>
<p>Caddy&rsquo;s logging system is completely different from Nginx, Caddy logs are divided by Namespace, <strong>by default only the request log of the current site can be printed in the site configuration, if you need to print the upstream address of the reverse proxy, for example, you need to configure it in the global logging configuration.</strong> If you know go, you can take a look at <a href="https://github.com/uber-go/zap">uber-go/zap</a> logging framework; here is a sample of printing request logs and upstream logs separately by file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="c1"># Global options
</span><span class="c1"></span><span class="k">{</span>
    <span class="c1"># Print the reverse proxy upstream information log (upstream is a random name for this location)
</span><span class="c1"></span>    <span class="s">log</span> <span class="s">upstream</span> <span class="p">{</span>
        <span class="kn">level</span> <span class="s">DEBUG</span>
        <span class="s">format</span> <span class="s">json</span> <span class="p">{</span>
            <span class="kn">time_format</span> <span class="s">&#34;iso8601&#34;</span>
        <span class="err">}</span>
        <span class="s">output</span> <span class="s">file</span> <span class="s">/data/logs/upstream.log</span> <span class="p">{</span>
            <span class="kn">roll_size</span> <span class="s">100mb</span>
            <span class="s">roll_keep</span> <span class="mi">3</span>
            <span class="s">roll_keep_for</span> <span class="s">7d</span>
        <span class="err">}</span>
        <span class="c1"># Namespace needs to be specified in order to print
</span><span class="c1"></span>        <span class="s">include</span> <span class="s">&#34;http.handlers.reverse_proxy&#34;</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="s">example.com</span> <span class="p">{</span>
    <span class="c1"># Print site request log
</span><span class="c1"></span>    <span class="kn">log</span> <span class="p">{</span>
        <span class="kn">format</span> <span class="s">json</span> <span class="p">{</span>
            <span class="kn">time_format</span> <span class="s">&#34;iso8601&#34;</span>
        <span class="err">}</span>
        <span class="s">output</span> <span class="s">file</span> <span class="s">&#34;/data/logs/example.com.log&#34;</span> <span class="p">{</span>
            <span class="kn">roll_size</span> <span class="s">100mb</span>
            <span class="s">roll_keep</span> <span class="mi">3</span>
            <span class="s">roll_keep_for</span> <span class="s">7d</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="tls-versions-are-not-supported">TLS versions are not supported</h3>
<p>Unfortunately we have a TLS 1.1 compatible service and when switching to Caddy TLS 1.1 is no longer supported, currently Caddy has a minimum TLS 1.2 and a maximum TLS 1.3 compatibility:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">protocols &lt;min&gt; [&lt;max&gt;]
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>protocols specifies the minimum and maximum protocol versions. Default min: tls1.2. Default max: tls1.3</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>To sum up: the matcher is comfortable, the configuration behavior is clear, the configuration reference is written in 10,000 lines less, and the rest of the pitfalls continue to be stepped on.</p>
<hr>
<p>Reference <code>https://mritd.com/2021/08/20/switching-rrom-nginx-too-caddy/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nginx/">nginx</a>
          <a href="/tags/caddy/">caddy</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-08/microsoft-no-longer-allow-chromebook-install-android-office/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Microsoft no longer allows Chrome OS users to install the Android version of Office</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-08/hackers-steal-600-million/">
            <span class="next-text nav-default">Hacker &#34;had too much fun&#34; and stole $600 million and returned it, and was hired as a consultant instead of being held accountable!</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
