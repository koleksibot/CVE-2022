<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>SSH Certificate Login Tutorial - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="SSH is a server login tool that provides password login and key login. However, there is a third method of SSH login, and that is the certificate login. In many cases, it is the more logical and secure method of login, and this article describes that method of login. Disadvantages of non-certificate login Password login and key login, both have their disadvantages. Password login requires entering the server password, which" /><meta name="keywords" content="ssh,certificate" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-08/ssh-certificate/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="SSH Certificate Login Tutorial" />
<meta property="og:description" content="SSH is a server login tool that provides password login and key login. However, there is a third method of SSH login, and that is the certificate login. In many cases, it is the more logical and secure method of login, and this article describes that method of login. Disadvantages of non-certificate login Password login and key login, both have their disadvantages. Password login requires entering the server password, which" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-08/ssh-certificate/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-16T17:00:34+08:00" />
<meta property="article:modified_time" content="2021-08-16T17:00:34+08:00" />

<meta itemprop="name" content="SSH Certificate Login Tutorial">
<meta itemprop="description" content="SSH is a server login tool that provides password login and key login. However, there is a third method of SSH login, and that is the certificate login. In many cases, it is the more logical and secure method of login, and this article describes that method of login. Disadvantages of non-certificate login Password login and key login, both have their disadvantages. Password login requires entering the server password, which"><meta itemprop="datePublished" content="2021-08-16T17:00:34+08:00" />
<meta itemprop="dateModified" content="2021-08-16T17:00:34+08:00" />
<meta itemprop="wordCount" content="2236">
<meta itemprop="keywords" content="ssh,certificate," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SSH Certificate Login Tutorial"/>
<meta name="twitter:description" content="SSH is a server login tool that provides password login and key login. However, there is a third method of SSH login, and that is the certificate login. In many cases, it is the more logical and secure method of login, and this article describes that method of login. Disadvantages of non-certificate login Password login and key login, both have their disadvantages. Password login requires entering the server password, which"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">SSH Certificate Login Tutorial</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-16 17:00:34 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2236 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#disadvantages-of-non-certificate-login">Disadvantages of non-certificate login</a></li>
        <li><a href="#what-is-the-certificate-login">What is the certificate login?</a></li>
        <li><a href="#flow-of-certificate-login">Flow of certificate login</a></li>
        <li><a href="#generate-the-key-for-the-ca">Generate the key for the CA</a></li>
        <li><a href="#ca-issues-server-certificates">CA issues server certificates</a></li>
        <li><a href="#ca-issues-user-certificates">CA issues user certificates</a></li>
        <li><a href="#server-installation-certificate">Server Installation Certificate</a></li>
        <li><a href="#server-installation-ca-public-key">Server Installation CA Public Key</a></li>
        <li><a href="#client-installation-certificate">Client installation certificate</a></li>
        <li><a href="#client-installation-of-ca-public-key">Client installation of CA public key</a></li>
        <li><a href="#certificate-of-revocation">Certificate of Revocation</a></li>
        <li><a href="#reference-links">Reference Links</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>SSH is a server login tool that provides password login and key login.</p>
<p>However, there is a third method of SSH login, and that is the certificate login. In many cases, it is the more logical and secure method of login, and this article describes that method of login.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/16/0e68cc007c4e450398e4faa747e5d551.png" alt=" "></p>
<h2 id="disadvantages-of-non-certificate-login">Disadvantages of non-certificate login</h2>
<p>Password login and key login, both have their disadvantages.</p>
<p>Password login requires entering the server password, which is very cumbersome and insecure, with the risk of brute force cracking.</p>
<p>Key login requires the server to save the user&rsquo;s public key, and also requires the user to save the fingerprint of the server&rsquo;s public key. This is inconvenient for large organizations with multiple users and multiple servers, and if an employee leaves, his public key needs to be removed from each server.</p>
<h2 id="what-is-the-certificate-login">What is the certificate login?</h2>
<p>Certificate login is designed to solve the above drawbacks. It introduces a Certificate1 authority (CA), which issues server certificates to trusted servers and user certificates to trusted users.</p>
<p>When logging in, users and servers do not need to know each other&rsquo;s public keys in advance, but only need to exchange their respective certificates and verify whether they are trusted.</p>
<p>There are two main advantages of certificate login: (1) Users and servers do not need to exchange public keys, which is easier to manage and has better scalability. (2) The certificate can set the expiration time, while the public key has no expiration time. For different situations, certificates with very short expiration dates can be set to further improve security.</p>
<h2 id="flow-of-certificate-login">Flow of certificate login</h2>
<p>Before SSH certificate login, if there is no certificate yet, you need to generate a certificate. The specific methods are: (1) both the user and the server send their public keys to the CA; (2) the CA uses the server public key to generate the server certificate and send it to the server; (3) the CA uses the user public key to generate the user certificate and send it to the user.</p>
<p>Once the certificate is available, the user can log in to the server. The whole process is handled automatically by SSH and is not perceived by the user.</p>
<p>In the first step, SSH automatically sends the user certificate to the server when the user logs in.</p>
<p>In the second step, the server checks whether the user certificate is valid and whether it is issued by a trusted CA.</p>
<p>In the third step, SSH automatically sends the server certificate to the user.</p>
<p>In the fourth step, the user checks whether the server certificate is valid and whether it is issued by a trusted CA.</p>
<p>Step 5, both parties establish a connection and the server allows the user to log in.</p>
<h2 id="generate-the-key-for-the-ca">Generate the key for the CA</h2>
<p>The prerequisite for certificate login is that there must be a CA, which is essentially a pair of keys, no different from other keys, and the CA uses this pair of keys to issue the certificate.</p>
<p>Although CA can issue user certificate and server certificate with the same pair of password, it is better to issue them separately with different keys for security and flexibility. Therefore, the CA needs at least two pairs of keys, one for issuing user certificates, assumed to be called <code>user_ca</code>, and the other for issuing server certificates, assumed to be called <code>host_ca</code>.</p>
<p>Use the following command to generate <code>user_ca</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Generate the key for the CA to issue the user certificate</span>
$ ssh-keygen -t rsa -b <span class="m">4096</span> -f ~/.ssh/user_ca -C user_ca
</code></pre></td></tr></table>
</div>
</div><p>The above command will generate a pair of keys in the <code>~/.ssh</code> directory: <code>user_ca</code> (private key) and <code>user_ca.pub</code> (public key).</p>
<p>The meaning of each parameter of this command is as follows.</p>
<ul>
<li><code>-t rsa</code> : Specify the key algorithm RSA.</li>
<li><code>-b 4096</code> : Specify the number of bits of the key is 4096 bits. For low security requirements, this value can be smaller, but should not be less than 1024.</li>
<li><code>-f ~/.ssh/user_ca</code> : Specify the location and filename of the generated key.</li>
<li><code>-C user_ca</code> : Specify the identification string of the key, which is equivalent to a comment and can be set at will.</li>
</ul>
<p>Use the following command to generate <code>host_ca</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Generate the key for the CA to issue the server certificate</span>
$ ssh-keygen -t rsa -b <span class="m">4096</span> -f host_ca -C host_ca
</code></pre></td></tr></table>
</div>
</div><p>The above command will generate a pair of keys in the <code>~/.ssh</code> directory: <code>host_ca</code> (private key) and <code>host_ca.pub</code> (public key).</p>
<p>Now, the <code>~/.ssh</code> directory should have at least four keys.</p>
<ul>
<li><code>~/.ssh/user_ca</code></li>
<li><code>~/.ssh/user_ca.pub</code></li>
<li><code>~/.ssh/host_ca</code></li>
<li><code>~/.ssh/host_ca.pub</code></li>
</ul>
<h2 id="ca-issues-server-certificates">CA issues server certificates</h2>
<p>After you have a CA, you can issue a server certificate.</p>
<p>To issue a certificate, you need the server&rsquo;s public key in addition to the CA&rsquo;s key. Generally, the key <code>/etc/ssh/ssh_host_rsa_key</code> is already generated when the SSH server (usually <code>sshd</code>) is installed. If not, you can use the following command to generate it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ sudo ssh-keygen -f /etc/ssh/ssh_host_rsa_key -b <span class="m">4096</span> -t rsa
</code></pre></td></tr></table>
</div>
</div><p>The above command will generate <code>ssh_host_rsa_key</code> (private key) and <code>ssh_host_rsa_key.pub</code> (public key) in <code>/etc/ssh</code> directory. Then, you need to copy or upload the server public key <code>ssh_host_rsa_key.pub</code>, to the server where the CA is located.</p>
<p>Once uploaded, the CA can use the key <code>host_ca</code> to issue the server certificate for the server public key <code>ssh_host_rsa_key.pub</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ssh-keygen -s host_ca -I host.example.com -h -n host.example.com -V +52w ssh_host_rsa_key.pub
</code></pre></td></tr></table>
</div>
</div><p>The above command generates the server certificate <code>ssh_host_rsa_key-cert.pub</code> (the server public key name plus the suffix <code>-cert</code>). The meaning of each parameter of this command is as follows.</p>
<ul>
<li><code>-s</code> : Specify the key for the CA to issue the certificate.</li>
<li><code>-I</code> : The identity string, which can be set arbitrarily and is equivalent to a comment to distinguish the certificate, and can be used to revoke the certificate in the future.</li>
<li><code>-h</code> : Specify that the certificate is a server certificate, not a user certificate.</li>
<li><code>-n host.example.com</code> : Specify the domain name of the server, indicating that the certificate is valid only for that domain. If there is more than one domain name, use comma to separate them. When a user logs in to this domain server, SSH uses this value of the certificate to distinguish which certificate should be used to issue to the user and to prove the trustworthiness of the server.</li>
<li><code>-V +52w</code> : Specify the validity of the certificate, in this case 52 weeks (one year). By default, the certificate is valid forever. It is recommended to use this parameter to specify the validity period, and it is better to have a shorter validity period, up to 52 weeks.</li>
<li><code>ssh_host_rsa_key.pub</code>: the server public key.</li>
</ul>
<p>After generating the certificate, you can use the following command to view the details of the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ssh-keygen -L -f ssh_host_rsa_key-cert.pub
</code></pre></td></tr></table>
</div>
</div><p>Finally, set permissions for the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ chmod <span class="m">600</span> ssh_host_rsa_key-cert.pub
</code></pre></td></tr></table>
</div>
</div><h2 id="ca-issues-user-certificates">CA issues user certificates</h2>
<p>Next, the CA is used to issue the user certificate. This requires the user&rsquo;s public key, and if it is not available, the client can generate a pair of keys with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ssh-keygen -f ~/.ssh/user_key -b <span class="m">4096</span> -t rsa
</code></pre></td></tr></table>
</div>
</div><p>The above command will generate <code>user_key</code> (private key) and <code>user_key.pub</code> (public key) in the <code>~/.ssh</code> directory.</p>
<p>Then, upload or copy the user&rsquo;s public key, <code>user_key.pub</code>, to the CA server. Next, you can use the CA&rsquo;s key <code>user_ca</code> to issue a user certificate for the user&rsquo;s public key <code>user_key.pub</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ssh-keygen -s user_ca -I user@example.com -n user -V +1d user_key.pub
</code></pre></td></tr></table>
</div>
</div><p>The above command generates the user certificate <code>user_key-cert.pub</code> (the name of the user&rsquo;s public key plus the suffix <code>-cert</code>). The meaning of each parameter of this command is as follows.</p>
<ul>
<li><code>-s</code> : Specify the key used by the CA to issue the certificate.</li>
<li><code>-I</code> : The identity string, which can be set as a comment to distinguish the certificate, and can be used to revoke the certificate in the future.</li>
<li><code>-n user</code> : Specify the user name, indicating that the certificate is valid only for that user name. If there are multiple user names, use comma to separate them. When a user logs in to the server with this user name, SSH uses this value to distinguish which certificate should be used to prove their identity and issued to the server.</li>
<li><code>-V +1d</code> : Specify the validity of the certificate, in this case 1 day, to force the user to apply for a certificate once a day to improve security. By default, the certificate is valid forever.</li>
<li><code>-user_key.pub</code> : The user&rsquo;s public key.</li>
</ul>
<p>After generating the certificate, you can use the following command to view the details of the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ssh-keygen -L -f user_key-cert.pub
</code></pre></td></tr></table>
</div>
</div><p>Finally, set permissions for the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ chmod <span class="m">600</span> user_key-cert.pub
</code></pre></td></tr></table>
</div>
</div><h2 id="server-installation-certificate">Server Installation Certificate</h2>
<p>After the CA generates the server certificate <code>ssh_host_rsa_key-cert.pub</code>, you need to send the certificate back to the server, you can use the following <code>scp</code> command to copy the certificate over.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ scp ~/.ssh/ssh_host_rsa_key-cert.pub root@host.example.com:/etc/ssh/
</code></pre></td></tr></table>
</div>
</div><p>Then, add the following line to the server configuration file <code>/etc/ssh/sshd_config</code> .</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">HostCertificate /etc/ssh/ssh_host_rsa_key-cert.pub
</code></pre></td></tr></table>
</div>
</div><p>上面的代码告诉 sshd 服务器证书是哪个文件。</p>
<p>重新启动 sshd。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ sudo systemctl restart sshd
<span class="c1"># or</span>
$ sudo service sshd restart
</code></pre></td></tr></table>
</div>
</div><h2 id="server-installation-ca-public-key">Server Installation CA Public Key</h2>
<p>In order for the server to trust the user certificate, you must copy the public key <code>user_ca.pub</code> , which is used by the CA to issue the user certificate, to the server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ scp ~/.ssh/user_ca.pub root@host.example.com:/etc/ssh/
</code></pre></td></tr></table>
</div>
</div><p>The above command copies the public key <code>user_ca.pub</code>, which is used by the CA to issue user certificates, to the <code>/etc/ssh</code> directory of the SSH server.</p>
<p>Then, add the following line to the server configuration file <code>/etc/ssh/sshd_config</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">TrustedUserCAKeys /etc/ssh/user_ca.pub
</code></pre></td></tr></table>
</div>
</div><p>The above approach is to add <code>user_ca.pub</code> to <code>/etc/ssh/sshd_config</code>, which will have the global effect that all accounts on the server will trust all user certificates issued by <code>user_ca</code>.</p>
<p>Another approach is to add <code>user_ca.pub</code> to the <code>~/.ssh/authorized_keys</code> file of an account on the server and only have that account trust user certificates issued by <code>user_ca</code>. To do this, open <code>~/.ssh/authorized_keys</code>, add a line starting with <code>@cert-authority principals=&quot;...&quot; </code> and then add the contents of <code>user_ca.pub</code>, which looks like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">@cert-authority principals=&#34;user&#34; ssh-rsa AAAAB3Nz...XNRM1EX2gQ==
</code></pre></td></tr></table>
</div>
</div><p>In the above code, <code>principals=&quot;user&quot;</code> specifies the name of the server account to which the user is logged in, which is usually the account where the <code>authorized_keys</code> file is located.</p>
<p>Restart sshd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">
$ sudo systemctl restart sshd
<span class="c1"># or</span>
$ sudo service sshd restart
</code></pre></td></tr></table>
</div>
</div><p>At this point, the SSH server has been configured to trust the certificate issued by <code>user_ca</code>.</p>
<h2 id="client-installation-certificate">Client installation certificate</h2>
<p>Installing the user certificate on the client side is simple, just copy the user certificate <code>user_key-cert.pub</code> from the CA to the client and save it in the same directory as the user key <code>user_key</code>.</p>
<h2 id="client-installation-of-ca-public-key">Client installation of CA public key</h2>
<p>In order for the client to trust the server certificate, the public key <code>host_ca.pub</code> that the CA issues the server certificate with must be added to the client&rsquo;s <code>/etc/ssh/ssh_known_hosts</code> file (global level) or <code>~/.ssh/known_hosts</code> file (user level).</p>
<p>To do this, open the <code>ssh_known_hosts</code> or <code>known_hosts</code> file, append a line starting with <code>@cert-authority *.example.com</code>, and paste the contents of the <code>host_ca.pub</code> file (i.e., the public key) after it, which looks something like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">@cert-authority *.example.com ssh-rsa AAAAB3Nz...XNRM1EX2gQ==
</code></pre></td></tr></table>
</div>
</div><p>In the above code, <code>*.example.com</code> is a pattern match for the domain name, which means that as long as the server matches the pattern domain name and the CA issuing the server certificate matches the public key given later, it can be trusted. If there is no domain restriction, you can write <code>*</code> here. If there is more than one domain name pattern, you can use a comma to separate them; if the server does not have a domain name, you can use the host name (e.g. <code>host1,host2,host3</code>) or IP address (e.g. <code>11.12.13.14,21.22.23.24</code>).</p>
<p>Then, you can use the certificate to log in to the remote server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ssh -i ~/.ssh/user_key user@host.example.com
</code></pre></td></tr></table>
</div>
</div><p>The <code>-i</code> parameter of the above command is used to specify the user&rsquo;s key. If the certificate is in the same directory as the key, the certificate will be used automatically when connecting to the server.</p>
<h2 id="certificate-of-revocation">Certificate of Revocation</h2>
<p>The operation of revoking a certificate is divided into two types: revocation of user certificate and revocation of server certificate.</p>
<p>To revoke a server certificate, the user needs to modify or delete the line corresponding to the <code>@cert-authority</code> command in the <code>known_hosts</code> file.</p>
<p>For user certificate revocation, you need to create a new <code>/etc/ssh/revoked_keys</code> file in the server, and then add a line to the configuration file <code>sshd_config</code> with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">RevokedKeys /etc/ssh/revoked_keys
</code></pre></td></tr></table>
</div>
</div><p>The <code>revoked_keys</code> file holds the public keys of users that are no longer trusted and is generated by the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">$ ssh-keygen -kf /etc/ssh/revoked_keys -z 1 ~/.ssh/user1_key.pub
</code></pre></td></tr></table>
</div>
</div><p>In the above command, the <code>-z</code> parameter is used to specify which line of the <code>revoked_keys</code> file the user&rsquo;s public key is stored in, in this case it is stored in line 1.</p>
<p>If you need to revoke other user public keys later, you can use the following command to save them on line 2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ ssh-keygen -ukf /etc/ssh/revoked_keys -z <span class="m">2</span> ~/.ssh/user2_key.pub
</code></pre></td></tr></table>
</div>
</div><h2 id="reference-links">Reference Links</h2>
<ul>
<li><a href="https://smallstep.com/blog/ssh-emergency-access/">SSH Emergency Access</a>, Carl Tashian</li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/sec-using_openssh_certificate_authentication">Using OpenSSH Certificate Authentication</a>, Red Hat Enterprise Linux Deployment Guide</li>
<li><a href="https://gravitational.com/blog/how-to-ssh-properly/">How to SSH Properly</a>, Gus Luxton</li>
</ul>
<hr>
<p>Reference <code>https://www.ruanyifeng.com/blog/2020/07/ssh-certificate.html</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ssh/">ssh</a>
          <a href="/tags/certificate/">certificate</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-08/local-https-solution/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Local https quick solution - mkcert</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-08/git-cherry-pick/">
            <span class="next-text nav-default">git cherry-pick tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
