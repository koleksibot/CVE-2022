<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Asm and Emscripten Tutorials - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Web technology has advanced by leaps and bounds, but there is one area that has been impossible to break through &amp;mdash;- games.
The performance requirements for games are so high that some large games struggle to run even on a PC, let alone in the sandbox model of a browser! However, despite the difficulties, many developers have never given up and want to make browsers run 3D games.
In 2012, Alon Zakai, an engineer at Mozilla, was working on the LLVM compiler and had the idea that many 3D games are written in C/C&#43;&#43;, so if we could compile C/C&#43;&#43; into JavaScript code, they would run in the browser." /><meta name="keywords" content="asm.js,emscripten" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-08/asm-and-emscripten-tutorials/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Asm and Emscripten Tutorials" />
<meta property="og:description" content="Web technology has advanced by leaps and bounds, but there is one area that has been impossible to break through &mdash;- games.
The performance requirements for games are so high that some large games struggle to run even on a PC, let alone in the sandbox model of a browser! However, despite the difficulties, many developers have never given up and want to make browsers run 3D games.
In 2012, Alon Zakai, an engineer at Mozilla, was working on the LLVM compiler and had the idea that many 3D games are written in C/C&#43;&#43;, so if we could compile C/C&#43;&#43; into JavaScript code, they would run in the browser." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-08/asm-and-emscripten-tutorials/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-12T10:18:12+08:00" />
<meta property="article:modified_time" content="2021-08-12T10:18:12+08:00" />

<meta itemprop="name" content="Asm and Emscripten Tutorials">
<meta itemprop="description" content="Web technology has advanced by leaps and bounds, but there is one area that has been impossible to break through &mdash;- games.
The performance requirements for games are so high that some large games struggle to run even on a PC, let alone in the sandbox model of a browser! However, despite the difficulties, many developers have never given up and want to make browsers run 3D games.
In 2012, Alon Zakai, an engineer at Mozilla, was working on the LLVM compiler and had the idea that many 3D games are written in C/C&#43;&#43;, so if we could compile C/C&#43;&#43; into JavaScript code, they would run in the browser."><meta itemprop="datePublished" content="2021-08-12T10:18:12+08:00" />
<meta itemprop="dateModified" content="2021-08-12T10:18:12+08:00" />
<meta itemprop="wordCount" content="2537">
<meta itemprop="keywords" content="asmjs,emscripten," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Asm and Emscripten Tutorials"/>
<meta name="twitter:description" content="Web technology has advanced by leaps and bounds, but there is one area that has been impossible to break through &mdash;- games.
The performance requirements for games are so high that some large games struggle to run even on a PC, let alone in the sandbox model of a browser! However, despite the difficulties, many developers have never given up and want to make browsers run 3D games.
In 2012, Alon Zakai, an engineer at Mozilla, was working on the LLVM compiler and had the idea that many 3D games are written in C/C&#43;&#43;, so if we could compile C/C&#43;&#43; into JavaScript code, they would run in the browser."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Asm and Emscripten Tutorials</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-08-12 10:18:12 </span>
        <div class="post-category">
            <a href="/categories/web/"> web </a>
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/tools/"> tools </a>
            </div>
          <span class="more-meta"> 2537 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction-to-asmjs">Introduction to asm.js</a>
          <ul>
            <li><a href="#principle">Principle</a></li>
            <li><a href="#static-type-variables">Static type variables</a></li>
            <li><a href="#garbage-collection-mechanism">Garbage collection mechanism</a></li>
            <li><a href="#similarities-and-differences-between-asmjs-and-webassembly">Similarities and differences between asm.js and WebAssembly</a></li>
          </ul>
        </li>
        <li><a href="#emscripten-compiler">Emscripten Compiler</a>
          <ul>
            <li><a href="#emscripten-introduc">Emscripten Introduc</a></li>
            <li><a href="#installation-of-emscripten">Installation of Emscripten</a></li>
            <li><a href="#hello-world">Hello World</a></li>
          </ul>
        </li>
        <li><a href="#emscripten-syntax">Emscripten syntax</a>
          <ul>
            <li><a href="#cc-calling-javascript">C/C++ Calling JavaScript</a></li>
            <li><a href="#communication-between-cc-and-javascript">Communication between C/C++ and JavaScript</a></li>
            <li><a href="#em_asm-macro-series">EM_ASM Macro Series</a></li>
            <li><a href="#javascript-calls-c--c-code">JavaScript calls C / C++ code</a></li>
            <li><a href="#c-function-output-as-a-javascript-module">C function output as a JavaScript module</a></li>
            <li><a href="#node-calls-c-functions">Node calls C functions</a></li>
          </ul>
        </li>
        <li><a href="#use">Use</a></li>
        <li><a href="#reference-links">Reference Links</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Web technology has advanced by leaps and bounds, but there is one area that has been impossible to break through &mdash;- games.</p>
<p>The performance requirements for games are so high that some large games struggle to run even on a PC, let alone in the sandbox model of a browser! However, despite the difficulties, many developers have never given up and want to make browsers run 3D games.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/910303c24ce74140b8f2ea7afa7f6227.png" alt=" "></p>
<p>In 2012, <a href="https://github.com/kripken">Alon Zakai</a>, an engineer at Mozilla, was working on the LLVM compiler and had the idea that many 3D games are written in C/C++, so if we could compile C/C++ into JavaScript code, they would run in the browser. As we all know, the basic syntax of JavaScript is highly similar to C language.</p>
<p>So, he started working on how to achieve this goal and made a compiler project called <a href="https://github.com/kripken/emscripten">Emscripten</a>, which compiles C/C++ code into JS code, but not just any JS, but a variant of JavaScript called asm.js.</p>
<p>In this article, we will introduce the basic usage of <a href="http://asmjs.org/">asm.js</a> and Emscripten, and describe how to convert C / C++ to JS.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/13440dec6a614b2d95a6b5d895df7428.png" alt=" "></p>
<h2 id="introduction-to-asmjs">Introduction to asm.js</h2>
<h3 id="principle">Principle</h3>
<p>There are two biggest difficulties with compiling C / C++ to JS.</p>
<ul>
<li>C / C++ is a statically typed language, while JS is a dynamically typed language.</li>
<li>C / C++ is manual memory management, while JS relies on garbage collection mechanisms.</li>
</ul>
<p><strong>asm.js is designed to solve these two problems: its variables are always statically typed and it does away with the garbage collection mechanism</strong>. Other than these two points, it is not different from JavaScript, i.e. asm.js is a strict subset of JavaScript and can only use part of the latter&rsquo;s syntax.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/8002776d6c75421c9eb94bcb9ad38a87.png" alt=" "></p>
<p>Once the JavaScript engine finds out that it is running asm.js, it knows that it is optimized code and can skip the syntax analysis step and go straight to assembly language. In addition, the browser calls WebGL to execute asm.js through the GPU, meaning that asm.js has a different execution engine than a normal JavaScript script. These are the reasons why asm.js runs faster. It is claimed that asm.js runs in the browser at about 50% of the speed of native code.</p>
<p>The two main syntactic features of asm.js are described below in turn.</p>
<h3 id="static-type-variables">Static type variables</h3>
<p>asm.js provides only two <a href="http://asmjs.org/spec/latest/#value-types">data types</a>.</p>
<ul>
<li>32-bit signed integer</li>
<li>64-bit Signed Floating Point</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/48bbd691a5994da49c3ad9017a03080f.png" alt=" "></p>
<p>Other data types, such as strings, booleans or objects, are not provided by asm.js at all. They are stored in memory as numeric values and called via <a href="https://es6.ruanyifeng.com/#docs/arraybuffer">TypedArray</a>.</p>
<p>If the type of a variable is to be determined at runtime, asm.js requires that the type be declared beforehand and not changed, thus saving time in type determination.</p>
<p>The type declaration in asm.js is written in a fixed way, with <code>Variable | 0</code> for integers and <code>+Variable</code> for floating point numbers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// x is a 32-bit integer
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="o">+</span><span class="nx">a</span><span class="p">;</span>  <span class="c1">// y is a 64-bit floating point number
</span></code></pre></td></tr></table>
</div>
</div><p>In the above code, the variable <code>x</code> is declared as an integer and <code>y</code> is declared as a floating point number. An engine that supports asm.js will know that <code>x</code> is an integer when it sees <code>x = a | 0</code>, and will use the asm.js mechanism to handle it. If the engine doesn&rsquo;t support asm.js, it doesn&rsquo;t matter, the code will still work and you&rsquo;ll get the same result.</p>
<p>Look at the following example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// Writing Method 1
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="nx">first</span><span class="p">;</span>

<span class="c1">// Writing Method 2
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">first</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">second</span> <span class="o">=</span> <span class="nx">first</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, write 1 is normal JavaScript, the variable <code>second</code> only knows the type at runtime, which is slow, write 2 is asm.js, <code>second</code> is known to be an integer at declaration time, which is faster.</p>
<p>The arguments and return values of the function, both have to specify the type in this way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js">
<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, in addition to the arguments <code>x</code> and <code>y</code>, the return value of the function also needs to have its type declared.</p>
<h3 id="garbage-collection-mechanism">Garbage collection mechanism</h3>
<p>asm.js has no garbage collection mechanism and all memory operations are controlled by the programmer. asm.js reads and writes memory directly through TypedArray.</p>
<p>Here is an example of reading and writing memory directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">32768</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HEAP8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">compiledCode</span><span class="p">(</span><span class="nx">ptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">HEAP</span><span class="p">[</span><span class="nx">ptr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">HEAP</span><span class="p">[</span><span class="nx">ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>
<span class="p">}</span>  
</code></pre></td></tr></table>
</div>
</div><p>If a pointer is involved, it is handled the same way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++">
<span class="n">size_t</span> <span class="nf">strlen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">curr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">curr</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">curr</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above code is compiled into asm.js, which looks like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">strlen</span><span class="p">(</span><span class="nx">ptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ptr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">curr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">curr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">MEM8</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span><span class="o">|</span><span class="mi">0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">curr</span> <span class="o">=</span> <span class="p">(</span><span class="nx">curr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">curr</span> <span class="o">-</span> <span class="nx">ptr</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="similarities-and-differences-between-asmjs-and-webassembly">Similarities and differences between asm.js and WebAssembly</h3>
<p>If you&rsquo;re familiar with JS, you may know that there is a technology called WebAssembly that also converts C/C++ into code that can be run by JS engines. So what&rsquo;s the difference between it and asm.js?</p>
<p>The answer is that they basically do the same thing, but the code that comes out is different: asm.js is text and WebAssembly is binary bytecode, so it runs faster and is smaller. In the long run, the future of WebAssembly is brighter.</p>
<p>However, this does not mean that asm.js is definitely out, because it has two advantages: first, it is text, human readable and more intuitive; second, all browsers support asm.js and there are no compatibility issues.</p>
<h2 id="emscripten-compiler">Emscripten Compiler</h2>
<h3 id="emscripten-introduc">Emscripten Introduc</h3>
<p>Although asm.js can be written by hand, it is never the target language of the compiler and has to be generated by compilation. Currently, the main tool for generating asm.js is <a href="http://emscripten.org/">Emscripten</a>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/fe203485234147c09b47b3b578dbd75c.png" alt=" "></p>
<p>The underlying layer of Emscripten is the LLVM compiler, and in theory any language that can generate LLVM IR (Intermediate Representation) can be compiled to generate asm.js. In practice, however, Emscripten is almost exclusively used to compile C/C++ code to generate asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">C/C++ ⇒ LLVM ==&gt; LLVM IR ⇒ Emscripten ⇒ asm.js
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/08/12/ea9ea0005b3d4d588ae964137a6163b2.png" alt=" "></p>
<h3 id="installation-of-emscripten">Installation of Emscripten</h3>
<p>The installation of Emscripten can be done according to the <a href="https://kripken.github.io/emscripten-site/docs/getting_started/downloads.html">official documentation</a>. As there are many dependencies and it is a bit tricky to install, I found a more convenient way is to install the SDK.</p>
<p>You can follow the <a href="https://github.com/kripken/emscripten/issues/5443#issuecomment-320981440">steps</a> below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ git clone https://github.com/juj/emsdk.git
$ <span class="nb">cd</span> emsdk
$ ./emsdk install --build<span class="o">=</span>Release sdk-incoming-64bit binaryen-master-64bit
$ ./emsdk activate --build<span class="o">=</span>Release sdk-incoming-64bit binaryen-master-64bit
$ <span class="nb">source</span> ./emsdk_env.sh
</code></pre></td></tr></table>
</div>
</div><p>Note that the last line is very important. Every time you re-login or create a new shell window, you have to execute this line once <code>source . /emsdk_env.sh</code>.</p>
<h3 id="hello-world">Hello World</h3>
<p>First, create the simplest C++ program, <code>hello.cc</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hello World!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, turn this program into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc hello.cc
$ node a.out.js
Hello World!
</code></pre></td></tr></table>
</div>
</div><p>In the above code, the <code>emcc</code> command is used to compile the source code, which generates <code>a.out.js</code> by default. Executing <code>a.out.js</code> with Node will output Hello World on the command line.</p>
<p>Note that asm.js automatically executes the <code>main</code> function by default.</p>
<p><code>emcc</code> is the compile command for Emscripten. Its usage is very simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Generate a.out.js</span>
$ emcc hello.c

<span class="c1"># Generate hello.js</span>
$ emcc hello.c -o hello.js

<span class="c1"># Generate hello.html and hello.js</span>
$ emcc hello.c -o hello.html
</code></pre></td></tr></table>
</div>
</div><h2 id="emscripten-syntax">Emscripten syntax</h2>
<h3 id="cc-calling-javascript">C/C++ Calling JavaScript</h3>
<p>Emscripten allows C / C++ code to call JavaScript directly.</p>
<p>Create a new file <code>example1.cc</code> and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;emscripten.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">EM_ASM</span><span class="p">({</span> <span class="n">alert</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span><span class="err">&#39;</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>EM_ASM</code> is a macro that will call the embedded JavaScript code. Note that the JavaScript code should be written inside curly brackets.</p>
<p>Then, compile this program into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc example1.cc -o example1.html
</code></pre></td></tr></table>
</div>
</div><p>When the browser opens <code>example1.html</code>, the dialog box <code>Hello World!</code> will pop up.</p>
<h3 id="communication-between-cc-and-javascript">Communication between C/C++ and JavaScript</h3>
<p>Emscripten allows C / C++ code to communicate with JavaScript.</p>
<p>Create a new file <code>example2.cc</code> and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++">
<span class="cp">#include</span> <span class="cpf">&lt;emscripten.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">val1</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">EM_ASM_INT</span><span class="p">({</span> <span class="k">return</span> <span class="err">$</span><span class="mi">0</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="p">},</span> <span class="n">val1</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;val2 == &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">val2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, <code>EM_ASM_INT</code> means that the JavaScript code returns an integer, and its parameter <code>$0</code> means the first parameter, <code>$1</code> means the second parameter, and so on. The other arguments to <code>EM_ASM_INT</code> are passed into the JavaScript expression in that order.</p>
<p>Then, the program is compiled into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc example2.cc -o example2.html
</code></pre></td></tr></table>
</div>
</div><p>The browser will open the web page <code>example2.html</code> and display <code>val2 == 42</code>.</p>
<h3 id="em_asm-macro-series">EM_ASM Macro Series</h3>
<p>Emscripten provides the following macros.</p>
<ul>
<li><code>EM_ASM</code>: Calls JS code with no parameters and no return value.</li>
<li><code>EMASMARGS</code>: Calls JS code, which can have any number of arguments, but no return value.</li>
<li><code>EMASMINT</code>: Calls JS code that can have any number of arguments and returns an integer.</li>
<li><code>EMASMDOUBLE</code>: JS code that can be called with any number of arguments and returns a double-precision floating-point number.</li>
<li><code>EMASMINT_V</code>: JS code called with no arguments, returns an integer.</li>
<li><code>EMASMDOUBLE_V</code>: Calls the JS code with no arguments and returns a double-precision floating-point number.</li>
</ul>
<p>The following is an example of <code>EM_ASM_ARGS</code>. Create a new file <code>example3.cc</code> and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;emscripten.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">Alert</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EM_ASM_ARGS</span><span class="p">({</span>
    <span class="n">var</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Pointer_stringify</span><span class="p">(</span><span class="err">$</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">alert</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">},</span> <span class="n">msg</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Alert</span><span class="p">(</span><span class="s">&#34;Hello from C++!&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, we pass a string into the JS code. Since there is no return value, <code>EM_ASM_ARGS</code> is used. Also, as we all know, in C / C++, a string is an array of characters, so the <code>Pointer_stringify()</code> method is called to convert the array of characters to a JS string.</p>
<p>Next, turn this program into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc example3.cc -o example3.html
</code></pre></td></tr></table>
</div>
</div><p>The browser will open <code>example3.html</code> and a dialog box will pop up &ldquo;Hello from C++!&rdquo;. .</p>
<h3 id="javascript-calls-c--c-code">JavaScript calls C / C++ code</h3>
<p>JS code can also call C / C++ code. Create a new file <code>example4.cc</code> and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js">
<span class="err">#</span><span class="nx">include</span> <span class="o">&lt;</span><span class="nx">emscripten</span><span class="p">.</span><span class="nx">h</span><span class="o">&gt;</span>

<span class="nx">extern</span> <span class="s2">&#34;C&#34;</span> <span class="p">{</span>
  <span class="kr">double</span> <span class="nx">SquareVal</span><span class="p">(</span><span class="kr">double</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">val</span> <span class="o">*</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">int</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">EM_ASM</span><span class="p">({</span>
    <span class="nx">SquareVal</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">cwrap</span><span class="p">(</span><span class="s1">&#39;SquareVal&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mf">12.5</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Computing: &#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nx">SquareVal</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, <code>EM_ASM</code> executes JS code with a C function <code>SquareVal</code>. This function must be defined in the <code>extern &quot;C&quot;</code> block, and the JS code must also introduce it with the <code>Module.cwrap()</code> method.</p>
<p><code>Module.cwrap()</code> takes three arguments with the following meanings.</p>
<ul>
<li>The name of the C function in quotation marks.</li>
<li>The type of the return value of the C function. If there is no return value, the type can be written as <code>null</code>.</li>
<li>An array of function argument types.</li>
</ul>
<p>In addition to <code>Module.cwrap()</code>, there is also a <code>Module.call()</code> method that can call C functions within JS code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">ccall</span><span class="p">(</span><span class="s1">&#39;int_sqrt&#39;</span><span class="p">,</span> <span class="c1">// C Name of the function
</span><span class="c1"></span>  <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="c1">// Type of return value
</span><span class="c1"></span>  <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="c1">// Arrays of parameter types
</span><span class="c1"></span>  <span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="c1">// Parameter array
</span><span class="c1"></span><span class="p">);</span> 
</code></pre></td></tr></table>
</div>
</div><p>Returning to the previous example, now compile <code>example4.cc</code> into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$  emcc -s <span class="nv">EXPORTED_FUNCTIONS</span><span class="o">=</span><span class="s2">&#34;[&#39;_SquareVal&#39;, &#39;_main&#39;]&#34;</span> example4.cc -o example4.html
</code></pre></td></tr></table>
</div>
</div><p>Note that the compile command gives an array of output function names with the <code>-s EXPORTED_FUNCTIONS</code> argument, and the function names are preceded by underscores. This example only outputs two C functions, so it should be written as <code>['_SquareVal', '_main']</code>.</p>
<p>If you open <code>example4.html</code> in your browser, you will see a popup dialog box with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Computing: 12.5 * 12.5 = 156.25 
</code></pre></td></tr></table>
</div>
</div><h3 id="c-function-output-as-a-javascript-module">C function output as a JavaScript module</h3>
<p>The other case is to export C functions for the JavaScript scripts inside the web page to call. Create a new file example5.cc and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">SquareVal</span><span class="p">(</span><span class="kt">double</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="n">val</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, <code>SquareVal</code> is a C function that is placed inside the <code>extern &quot;C&quot;</code> code block for external output.</p>
<p>Then, compile this function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc -s <span class="nv">EXPORTED_FUNCTIONS</span><span class="o">=</span><span class="s2">&#34;[&#39;_SquareVal&#39;]&#34;</span> example5.cc -o example5.js
</code></pre></td></tr></table>
</div>
</div><p>In the above code, the <code>-s EXPORTED_FUNCTIONS</code> parameter tells the compiler the name of the function that needs to be exported inside the code. The function name should be preceded by an underscore.</p>
<p>Next, write a web page that loads the <code>example5.js</code> you just generated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html">
<span class="cp">&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML//EN&#34;&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Test File<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;example5.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="nx">SquareVal</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">cwrap</span><span class="p">(</span><span class="s1">&#39;SquareVal&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]);</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;result == &#34;</span> <span class="o">+</span> <span class="nx">SquareVal</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>If you open this page in your browser, you will see <code>result == 100</code>.</p>
<h3 id="node-calls-c-functions">Node calls C functions</h3>
<p>If the execution environment is not a browser, but a Node, then it is easier to call C functions. Create a new file <code>example6.c</code> and write the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;emscripten.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">sayHi</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hi!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">daysInWeek</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, compile this script into asm.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ emcc -s <span class="nv">EXPORTED_FUNCTIONS</span><span class="o">=</span><span class="s2">&#34;[&#39;_sayHi&#39;, &#39;_daysInWeek&#39;]&#34;</span> example6.c -o example6.js
</code></pre></td></tr></table>
</div>
</div><p>Next, write a Node script test.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">em_module</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./api_example.js&#39;</span><span class="p">);</span>

<span class="nx">em_module</span><span class="p">.</span><span class="nx">_sayHi</span><span class="p">();</span>
<span class="nx">em_module</span><span class="p">.</span><span class="nx">ccall</span><span class="p">(</span><span class="s2">&#34;sayHi&#34;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">em_module</span><span class="p">.</span><span class="nx">_daysInWeek</span><span class="p">());</span>
</code></pre></td></tr></table>
</div>
</div><p>In the above code, the Node script calls the C function in two ways, one is to call <code>em_module._sayHi()</code> using the underscore function name and the other is to call <code>em_module.call(&quot;sayHi&quot;)</code> using the <code>ccall</code> method.</p>
<p>Run this script and you will see the output on the command line.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">
$ node test.js
Hi!
Hi!
7
</code></pre></td></tr></table>
</div>
</div><h2 id="use">Use</h2>
<p>asm.js allows browsers to run not only <a href="https://kripken.github.io/boon/boon.html">3D games</a>, but also various [server software](<a href="https://github.com/dherman/asm.js/wiki/Projects-">https://github.com/dherman/asm.js/wiki/Projects-</a> using-asm.js), such as <a href="https://github.com/kripken/lua.vm.js">Lua</a>, <a href="https://github.com/xxuejie/webruby">Ruby</a> and <a href="https://github.com">SQLite</a> /kripken/sql.js). This means that for many tools and algorithms, you can use ready-made code and not have to write it all over again.</p>
<p>Also, since asm.js runs faster, some computationally intensive operations (like computing Hash) can be implemented in C / C++ and then call them in JS.</p>
<p>For a real transcoding example, take a look at the compilation of <a href="https://github.com/kripken/zee.js">gzlib</a> and refer to its <a href="https://github.com/kripken/zee.js/blob/master/Makefile">Makefile</a> for how to write.</p>
<h2 id="reference-links">Reference Links</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Asm.js">asm.js</a>, by Wikipedia</li>
<li><a href="https://kripken.github.io/loc_emscripten_talk/cppcon.html#/">Emscripten &amp; asm.js: C++&rsquo;s role in the modern web</a>, by Alon Zakai</li>
<li><a href="https://kripken.github.io/emscripten-site/docs/getting_started/Tutorial.html">Emscripten Tutorial</a>, by Emscripten</li>
<li><a href="https://johnresig.com/blog/asmjs-javascript-compile-target/">Asm.js: The JavaScript Compile Target</a>, by John Resig</li>
<li><a href="http://devosoft.org/an-introduction-to-web-development-with-emscripten/">An Introduction to Web Development with Emscripten</a>, by Charles Ofria</li>
<li><a href="https://kripken.github.io/emscripten-site/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html">Interacting with code</a>, by Emscripten</li>
<li><a href="https://pspdfkit.com/blog/2017/webassembly-a-new-hope/">WebAssembly: A New Hope</a>, by Philipp Spiess and James Swift</li>
<li><a href="https://www.sitepoint.com/understanding-asm-js/">Understanding asm.js</a>, by Afshin Mehrabani</li>
</ul>
<hr>
<p>Reference <code>https://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/asmjs/">asmjs</a>
          <a href="/tags/emscripten/">emscripten</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-08/expressvpn-open-source-lightway-protocol/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">ExpressVPN announces open source Lightway protocol, big changes coming to VPN market?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-08/android-12-beta-4-released/">
            <span class="next-text nav-default">Android 12 Beta 4 released, has reached platform stability</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
