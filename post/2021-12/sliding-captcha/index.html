<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deep learning to recognize sliding CAPTCHA - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this section, we will learn how to use deep learning to recognize sliding CAPTCHA.
1. Preparation We mainly focus on completing the process of using the deep learning model to identify the CAPTCHA gap this time, so we will not focus on explaining the algorithm of the deep learning model, and also because the whole model implementation is more complex, this section will not write the code from scratch, but we tend to download the code in advance for hands-on practice." /><meta name="keywords" content="Sliding captcha, Deep learning" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/sliding-captcha/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Deep learning to recognize sliding CAPTCHA" />
<meta property="og:description" content="In this section, we will learn how to use deep learning to recognize sliding CAPTCHA.
1. Preparation We mainly focus on completing the process of using the deep learning model to identify the CAPTCHA gap this time, so we will not focus on explaining the algorithm of the deep learning model, and also because the whole model implementation is more complex, this section will not write the code from scratch, but we tend to download the code in advance for hands-on practice." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/sliding-captcha/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-31T11:59:34+08:00" />
<meta property="article:modified_time" content="2021-12-31T11:59:34+08:00" />

<meta itemprop="name" content="Deep learning to recognize sliding CAPTCHA">
<meta itemprop="description" content="In this section, we will learn how to use deep learning to recognize sliding CAPTCHA.
1. Preparation We mainly focus on completing the process of using the deep learning model to identify the CAPTCHA gap this time, so we will not focus on explaining the algorithm of the deep learning model, and also because the whole model implementation is more complex, this section will not write the code from scratch, but we tend to download the code in advance for hands-on practice."><meta itemprop="datePublished" content="2021-12-31T11:59:34+08:00" />
<meta itemprop="dateModified" content="2021-12-31T11:59:34+08:00" />
<meta itemprop="wordCount" content="2519">
<meta itemprop="keywords" content="captcha," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deep learning to recognize sliding CAPTCHA"/>
<meta name="twitter:description" content="In this section, we will learn how to use deep learning to recognize sliding CAPTCHA.
1. Preparation We mainly focus on completing the process of using the deep learning model to identify the CAPTCHA gap this time, so we will not focus on explaining the algorithm of the deep learning model, and also because the whole model implementation is more complex, this section will not write the code from scratch, but we tend to download the code in advance for hands-on practice."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deep learning to recognize sliding CAPTCHA</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-31 11:59:34 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2519 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-preparation">1. Preparation</a></li>
        <li><a href="#2-target-detection">2. Target detection</a></li>
        <li><a href="#3-data-preparation">3. Data Preparation</a></li>
        <li><a href="#4-training">4. Training</a></li>
        <li><a href="#5-testing">5. Testing</a></li>
        <li><a href="#6-summary">6. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In this section, we will learn how to use deep learning to recognize sliding CAPTCHA.</p>
<h2 id="1-preparation">1. Preparation</h2>
<p>We mainly focus on completing the process of using the deep learning model to identify the CAPTCHA gap this time, so we will not focus on explaining the algorithm of the deep learning model, and also because the whole model implementation is more complex, this section will not write the code from scratch, but we tend to download the code in advance for hands-on practice.</p>
<p>So at the end, please download the code in advance, the repository address is: <a href="https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2</a>, and use Git to clone it down to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2.git
</code></pre></td></tr></table>
</div>
</div><p>After running, a DeepLearningImageCaptcha2 folder will appear locally, which proves that the cloning was successful.</p>
<p>Once the cloning is complete, switch to the DeepLearningImageCaptcha2 folder and install the necessary dependencies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">pip3 install -r requirements.txt
</code></pre></td></tr></table>
</div>
</div><p>After running the project, all the dependencies needed to run the project will be installed.</p>
<p>Once all the above preparations are done, let&rsquo;s start the formal learning of this section.</p>
<h2 id="2-target-detection">2. Target detection</h2>
<p>This problem of identifying sliding CAPTCHA gaps can actually be attributed to the target detection problem. What does target detection mean? Here is a brief introduction.</p>
<p>Target detection, as the name implies, is to find out what we want to find. For example, given a picture of a &ldquo;dog&rdquo;, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/b19e8d3c3b714f369bc31fb9c5ec61fa.png" alt="image"></p>
<p>We want to know where the dog is and where its tongue is, and when we find them, we frame them out, which is target detection.</p>
<p>After processing by the target detection algorithm, we expect to get an image that looks like this</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/0df1af6c4a8e4ba9b0016f2ec2d09bd2.png" alt="image"></p>
<p>You can see that the dog and its tongue are framed out, which completes a good target detection.</p>
<p>Now the more popular target detection algorithms are R-CNN, Fast R-CNN, Faster R-CNN, SSD, YOLO, etc., interested in understanding, of course, do not know much about the goal to be accomplished in this section also has no impact.</p>
<p>The current algorithm for target detection has two main methods, one-stage and two-stage, called One stage and Two stage in English, briefly described as follows.</p>
<ul>
<li>Two Stage: The algorithm first generates a series of candidate boxes for the location of the target, and then performs sample classification on the results of these box selections, that is, first find out where, and then separate out what it is, as the saying goes, &ldquo;look twice&rdquo;, this algorithm has R-CNN, Fast R-CNN, Faster R-CNN, etc. These algorithms are relatively complex in architecture, but have advantages in accuracy.</li>
<li>One Stage: Without generating candidate frames, the problem of target localization and classification is directly transformed into a regression problem, which is commonly called &ldquo;one look&rdquo;. These algorithms have YOLO and SSD, which are not as accurate as Two stage, but have relatively simple architecture and faster detection speed.</li>
</ul>
<p>So this time we choose One Stage&rsquo;s representative target detection algorithm YOLO to implement the sliding CAPTCHA gap recognition.</p>
<p>YOLO, the full name of the algorithm is You Only Look Once, which is the name of the algorithm by taking their initials.</p>
<p>The latest version of the YOLO algorithm is the V5 version, the more widely used is the V3 version, here the specific process of the algorithm we do not introduce, interested parties can search the relevant information to understand the next, in addition, you can also understand the differences and improvements of the YOLO V1-V3 version, here are a few reference links.</p>
<ul>
<li>YOLO V3 paper: <a href="https://pjreddie.com/media/files/papers/YOLOv3.pdf">https://pjreddie.com/media/files/papers/YOLOv3.pdf</a></li>
<li>YOLO V3 Introduction: <a href="https://zhuanlan.zhihu.com/p/34997279">https://zhuanlan.zhihu.com/p/34997279</a></li>
<li>YOLO V1-V3 comparison introduction: <a href="https://www.cnblogs.com/makefile/p/yolov3.html">https://www.cnblogs.com/makefile/p/yolov3.html</a></li>
</ul>
<h2 id="3-data-preparation">3. Data Preparation</h2>
<p>As introduced in the previous section, to train the deep learning model, we also need to prepare the training data, which is also divided into two parts: one is the CAPTCHA image, and the other is the data annotation, i.e., the location of the gap. But what is different from the previous section is that this time the annotation is no longer just the CAPTCHA text, because this time we need to represent the location of the gap, the gap corresponds to a rectangular box, to represent a rectangular box, at least four data, such as the horizontal and vertical coordinates x, y of the upper left corner point, the width and height w, h of the rectangle, so the annotation data becomes four numbers.</p>
<p>So, next we need to prepare some captcha images and the corresponding four-digit labeling, such as the following sliding captcha.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/6a6e51df3e614ca1b13daac1d1808460.png" alt="image"></p>
<p>Okay, so let&rsquo;s complete these two steps, the first step is to collect the CAPTCHA image, and the second step is to mark the location of the gap and convert it to the four digits we want.</p>
<p>Here our example website is <code>https://captcha1.scrape.center/</code>, after opening it click the login button and a sliding CAPTCHA will pop up, as shown in the picture.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/22f52fb12416426882959f36f41dfd32.png" alt="image"></p>
<p>All we need to do is save the image of the sliding CAPTCHA separately, which is this area.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/998db1e11f9f412bbab6c905be192a40.png" alt="image"></p>
<p>How to do it? Manual screenshots are not reliable, time-consuming, and do not accurately locate the boundaries, resulting in large and small saved images. To solve this problem, we can simply write a script to automate the crop and save, which is the collect.py file in the repository, with the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support</span> <span class="kn">import</span> <span class="n">expected_conditions</span> <span class="k">as</span> <span class="n">EC</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">WebDriverException</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="n">COUNT</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">COUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">()</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">browser</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://captcha1.scrape.center/&#39;</span><span class="p">)</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">element_to_be_clickable</span><span class="p">(</span>
            <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;.el-button&#39;</span><span class="p">)))</span>
        <span class="n">button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="n">captcha</span> <span class="o">=</span> <span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
            <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;.geetest_slicebg.geetest_absolute&#39;</span><span class="p">)))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">captcha</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data/captcha/images/captcha_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">WebDriverException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;webdriver error occurred </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we first define a loop with COUNT cycles, each cycle starts a browser using Selenium, then opens the target website, simulates clicking the login button to trigger the CAPTCHA popup, then intercepts the node corresponding to the CAPTCHA and saves it with the screenshot method.</p>
<p>We run it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">python3</span> <span class="n">collect</span><span class="o">.</span><span class="n">py</span>
</code></pre></td></tr></table>
</div>
</div><p>After running it, we can get a lot of captcha images in the <code>data/captcha/images/</code> directory, as shown in the following example.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/f0f81b274aa24f02a381cd56b532bcec.png" alt="image"></p>
<p>After obtaining the CAPTCHA image, we need to annotate the data. The recommended tool is labelImg, available on GitHub at <a href="https://github.com/tzutalin/labelImg">https://github.com/tzutalin/labelImg</a>, and can be installed using pip3.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">pip3 install labelImg
</code></pre></td></tr></table>
</div>
</div><p>Once the installation is complete you can run it directly from the command line at</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">labelImg
</code></pre></td></tr></table>
</div>
</div><p>This successfully launches labelImg.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/8a4f378a8aef42eba539f6c4a1eec5b9.png" alt="image"></p>
<p>Click <code>Open Dir</code> to open the <code>data/captcha/images/</code> directory, then click <code>Create RectBox</code> in the lower left corner to create a label box, we can select the rectangular box where the gap is located, after the box is selected labelImg will prompt to save a name, we will name it target, and then click OK, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/63640f04107041b0b1834cfa43f3a067.png" alt="image"></p>
<p>At this point we can see that it saves an xml file with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;annotation&gt;</span>
	<span class="nt">&lt;folder&gt;</span>images<span class="nt">&lt;/folder&gt;</span>
	<span class="nt">&lt;filename&gt;</span>captcha_0.png<span class="nt">&lt;/filename&gt;</span>
	<span class="nt">&lt;path&gt;</span>data/captcha/images/captcha_0.png<span class="nt">&lt;/path&gt;</span>
	<span class="nt">&lt;source&gt;</span>
		<span class="nt">&lt;database&gt;</span>Unknown<span class="nt">&lt;/database&gt;</span>
	<span class="nt">&lt;/source&gt;</span>
	<span class="nt">&lt;size&gt;</span>
		<span class="nt">&lt;width&gt;</span>520<span class="nt">&lt;/width&gt;</span>
		<span class="nt">&lt;height&gt;</span>320<span class="nt">&lt;/height&gt;</span>
		<span class="nt">&lt;depth&gt;</span>3<span class="nt">&lt;/depth&gt;</span>
	<span class="nt">&lt;/size&gt;</span>
	<span class="nt">&lt;segmented&gt;</span>0<span class="nt">&lt;/segmented&gt;</span>
	<span class="nt">&lt;object&gt;</span>
		<span class="nt">&lt;name&gt;</span>target<span class="nt">&lt;/name&gt;</span>
		<span class="nt">&lt;pose&gt;</span>Unspecified<span class="nt">&lt;/pose&gt;</span>
		<span class="nt">&lt;truncated&gt;</span>0<span class="nt">&lt;/truncated&gt;</span>
		<span class="nt">&lt;difficult&gt;</span>0<span class="nt">&lt;/difficult&gt;</span>
		<span class="nt">&lt;bndbox&gt;</span>
			<span class="nt">&lt;xmin&gt;</span>321<span class="nt">&lt;/xmin&gt;</span>
			<span class="nt">&lt;ymin&gt;</span>87<span class="nt">&lt;/ymin&gt;</span>
			<span class="nt">&lt;xmax&gt;</span>407<span class="nt">&lt;/xmax&gt;</span>
			<span class="nt">&lt;ymax&gt;</span>167<span class="nt">&lt;/ymax&gt;</span>
		<span class="nt">&lt;/bndbox&gt;</span>
	<span class="nt">&lt;/object&gt;</span>
<span class="nt">&lt;/annotation&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>We can see that there are three nodes in the size node, namely width, height and depth, which represent the width, height and number of channels of the original CAPTCHA image respectively. In addition, the bndbox node under the object node contains the location of the annotation gap. By observation and comparison, we can know that xmin and ymin refer to the coordinates of the upper left corner, and xmax and ymax refer to the coordinates of the lower right corner.</p>
<p>We can simply process the data in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">xmltodict</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">parse_xml</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">xml_str</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_str</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">annoatation</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;annotation&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">annoatation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">annoatation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
    <span class="n">bndbox</span> <span class="o">=</span> <span class="n">annoatation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span>
    <span class="n">box_xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">))</span>
    <span class="n">box_xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">))</span>
    <span class="n">box_ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">))</span>
    <span class="n">box_ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">))</span>
    <span class="n">box_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_xmax</span> <span class="o">-</span> <span class="n">box_xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
    <span class="n">box_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">box_ymax</span> <span class="o">-</span> <span class="n">box_ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
    <span class="k">return</span> <span class="n">box_xmin</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">box_ymin</span> <span class="o">/</span> <span class="n">height</span><span class="p">,</span> <span class="n">box_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">,</span> <span class="n">box_height</span> <span class="o">/</span> <span class="n">height</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we define a parse_xml method, which first reads the xml file, then uses the xmltodict library to convert the XML string to JSON, then reads out the width and height of the CAPTCHA, the location of the gap, and finally returns the desired data format &ndash; the coordinates of the top left corner of the gap and the relative width and height values, in the form of a tuple.</p>
<p>After all the annotation is done, calling this method on each xml file will generate the desired annotation result.</p>
<p>Here, I&rsquo;ve processed the corresponding annotation results and can use them directly from data/captcha/labels, as shown here.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/81fcccbfa50947388a17b2ad7cdfa270.png" alt="image"></p>
<p>Each txt file corresponds to the annotated results of a CAPTCHA map, which looks like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="m">0</span> 0.6153846153846154 0.275 0.16596774 0.24170968
</code></pre></td></tr></table>
</div>
</div><p>The first 0 represents the index of the annotation target, and since we only need to detect one gap, the index is 0. For example, the 5th bit 0.24 is multiplied by the height of CAPTCHA 320, the result is about 77, that is, the height of the gap is about 77 pixels.</p>
<p>Well, the data preparation phase is finished.</p>
<h2 id="4-training">4. Training</h2>
<p>For better training results, we also need to download some pre-trained models. Pre-training means there is already a base model trained in advance, we can directly use the weight file inside the model trained in advance, we don&rsquo;t need to start training from scratch, we just need to fine-tune based on the previous model, so that we can save training time and have better results.</p>
<p>YOLOV3 training to load the pre-training model to have good training results, pre-training model download command is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">bash prepare.sh
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: On Windows, please use a Bash command line tool such as Git Bash to run this command.</p>
</blockquote>
<p>Execute this script to download some weights for the YOLO V3 model, including yolov3 and weights and darknet weights, which we need to use to initialize the YOLO V3 model before training.</p>
<p>Next, we can start the training by executing the following script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">bash train.sh
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: On Windows, please also use a Bash command line tool such as Git Bash to run this command.</p>
</blockquote>
<p>It is also recommended to use the GPU for training, and during training we can use TensorBoard to see the changes in loss and mAP by running TensorBoard.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">tensorboard --logdir<span class="o">=</span><span class="s1">&#39;logs&#39;</span> --port<span class="o">=</span><span class="m">6006</span> --host 0.0.0.0

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: Please make sure that you have installed all the dependencies of this project, including TensorBoard, and you can use the tensorboard command once it is installed successfully.</p>
</blockquote>
<p>After running this command, you can observe the change of loss during training at <code>http://localhost:6006</code>.</p>
<p>The change in loss_1 is similar to the following.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/f1a6bd8e67714ce4a713d4ff98b42558.png" alt="image"></p>
<p>The val_mAP change is similar to the following.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/197dec31c6d046cea8247d29a7d9f7e2.png" alt="image"></p>
<p>You can see that the loss drops from very high initially to very low, and the accuracy gradually approaches 100%.</p>
<p>Here are some outputs from the command line during the training process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">---- [Epoch 99/100, Batch 27/29] ----
+------------+--------------+--------------+--------------+
| Metrics    | YOLO Layer 0 | YOLO Layer 1 | YOLO Layer 2 |
+------------+--------------+--------------+--------------+
| grid_size  | 14           | 28           | 56           |
| loss       | 0.028268     | 0.046053     | 0.043745     |
| x          | 0.002108     | 0.005267     | 0.008111     |
| y          | 0.004561     | 0.002016     | 0.009047     |
| w          | 0.001284     | 0.004618     | 0.000207     |
| h          | 0.000594     | 0.000528     | 0.000946     |
| conf       | 0.019700     | 0.033624     | 0.025432     |
| cls        | 0.000022     | 0.000001     | 0.000002     |
| cls_acc    | 100.00%      | 100.00%      | 100.00%      |
| recall50   | 1.000000     | 1.000000     | 1.000000     |
| recall75   | 1.000000     | 1.000000     | 1.000000     |
| precision  | 1.000000     | 0.800000     | 0.666667     |
| conf_obj   | 0.994271     | 0.999249     | 0.997762     |
| conf_noobj | 0.000126     | 0.000158     | 0.000140     |
+------------+--------------+--------------+--------------+
Total loss 0.11806630343198776
</code></pre></td></tr></table>
</div>
</div><p>The changes of each metric during the training process are shown here, such as loss, recall, precision, and confidence, which represent the loss (the smaller the better), recall (the proportion of recognized results to those that should be recognized, the higher the better), precision (the percentage of recognized results that are correct, the higher the better), and confidence (the probability that the model is sure to recognize the right result, the higher the better), respectively, and can be used as a reference.</p>
<h2 id="5-testing">5. Testing</h2>
<p>After training, the pth file is generated in the checkpoints folder, which is a collection of model files, the same as best_model.pkl in the previous section, but with a slightly different representation.</p>
<p>To run the test, we can first put some captcha images in the test folder <code>data/captcha/test</code>.</p>
<p>The sample captcha is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/a3e31349d8e8462a85aee5f51c4e2129.png" alt="image"></p>
<p>To run the test, execute the following script.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">bash detect.sh
</code></pre></td></tr></table>
</div>
</div><p>The script reads all the images from the test folder and outputs the processed results to the <code>data/captcha/result</code> folder, and the console outputs the results of some CAPTCHA recognition.</p>
<p>It also generates annotated results in <code>data/captcha/result</code>, like the following.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/72bf248f8dc94ca983227ccfb419a0ab.png" alt="image"></p>
<p>As you can see, the gaps are then accurately identified.</p>
<p>In fact, detect.sh is executing the detect.py file and there is a key output in the code as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">bbox</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x1</span> <span class="o">+</span> <span class="n">box_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">box_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">box_w</span><span class="p">,</span> <span class="n">box_h</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&#34;none&#34;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bbox&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">box_w</span><span class="p">,</span> <span class="n">box_h</span><span class="p">),</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Here, bbox refers to the final notch outline position, while x1 refers to the leftmost outline of the leftmost offset of the whole CAPTCHA, i.e. offset.</p>
<p>With the target slider position, we can perform some simulated sliding operations to pass the CAPTCHA detection.</p>
<h2 id="6-summary">6. Summary</h2>
<p>This section introduces the overall process of training a deep learning model to identify sliding CAPTCHA gaps, and finally we have successfully implemented the model training process and obtained a deep learning model file.</p>
<p>Using this model, we can input a sliding CAPTCHA, and the model will predict the location of the gap in it, including the offset, width, etc. Finally, we can draw the corresponding location with the information of the gap.</p>
<p>As in the previous section, what is introduced in this section can be further optimized as follows.</p>
<ul>
<li>The prediction process of the current model is executed through the command line, but it may not be very convenient in actual use. Consider exposing the prediction process to the API server, such as docking Flask, Django, FastAPI, etc. to implement the prediction process as an interface that supports POST requests, and the interface can receive a CAPTCHA image and return the text information of the CAPTCHA, which will make the model more convenient and easy to use.</li>
</ul>
<p>The code in this section: <a href="https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/captcha/">captcha</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/ios-jailbreak-check/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Code to determine if IOS is jailbroken</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/learn-about-http-multipart-form-data/">
            <span class="next-text nav-default">Understanding multipart/form-data in HTTP protocol</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
