<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Building a Kubernetes cluster with WSL2 on Windows - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article we&amp;rsquo;ll cover how to build a Kubernetes cluster using WSL2 and KinD under Windows 10. Over the past few years, Kubernetes has become the de facto standard in container orchestration. While there are now a variety of Kubernetes distributions and installers to deploy Kubernetes environments, we still need to deploy and run Kubernetes clusters locally, especially for developers, except in cloud or bare-metal environments. However, Kubernetes was" /><meta name="keywords" content="K8s, Deploy, Wsl2" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/deploy-k8s-on-win-use-wsl2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Building a Kubernetes cluster with WSL2 on Windows" />
<meta property="og:description" content="In this article we&rsquo;ll cover how to build a Kubernetes cluster using WSL2 and KinD under Windows 10. Over the past few years, Kubernetes has become the de facto standard in container orchestration. While there are now a variety of Kubernetes distributions and installers to deploy Kubernetes environments, we still need to deploy and run Kubernetes clusters locally, especially for developers, except in cloud or bare-metal environments. However, Kubernetes was" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/deploy-k8s-on-win-use-wsl2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-12T17:54:23+08:00" />
<meta property="article:modified_time" content="2021-12-12T17:54:23+08:00" />

<meta itemprop="name" content="Building a Kubernetes cluster with WSL2 on Windows">
<meta itemprop="description" content="In this article we&rsquo;ll cover how to build a Kubernetes cluster using WSL2 and KinD under Windows 10. Over the past few years, Kubernetes has become the de facto standard in container orchestration. While there are now a variety of Kubernetes distributions and installers to deploy Kubernetes environments, we still need to deploy and run Kubernetes clusters locally, especially for developers, except in cloud or bare-metal environments. However, Kubernetes was"><meta itemprop="datePublished" content="2021-12-12T17:54:23+08:00" />
<meta itemprop="dateModified" content="2021-12-12T17:54:23+08:00" />
<meta itemprop="wordCount" content="1924">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building a Kubernetes cluster with WSL2 on Windows"/>
<meta name="twitter:description" content="In this article we&rsquo;ll cover how to build a Kubernetes cluster using WSL2 and KinD under Windows 10. Over the past few years, Kubernetes has become the de facto standard in container orchestration. While there are now a variety of Kubernetes distributions and installers to deploy Kubernetes environments, we still need to deploy and run Kubernetes clusters locally, especially for developers, except in cloud or bare-metal environments. However, Kubernetes was"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Building a Kubernetes cluster with WSL2 on Windows</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-12 17:54:23 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1924 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install-wsl2">Install WSL2</a></li>
        <li><a href="#environment-preparation">Environment preparation</a>
          <ul>
            <li><a href="#operating-system-version">Operating system version</a></li>
            <li><a href="#enabling-the-virtual-machine-platform-optional-component"><strong>Enabling the &ldquo;Virtual Machine Platform&rdquo; optional component</strong></a></li>
            <li><a href="#setting-wsl2-as-the-default-version"><strong>Setting WSL2 as the default version</strong></a></li>
          </ul>
        </li>
        <li><a href="#install-and-configure-the-linux-distribution"><strong>Install and configure the Linux distribution</strong></a>
          <ul>
            <li><a href="#configuring-linux">Configuring Linux</a></li>
            <li><a href="#configuring-systemd">Configuring Systemd</a></li>
          </ul>
        </li>
        <li><a href="#install-docker">Install Docker</a></li>
        <li><a href="#install-kubernetes">Install Kubernetes</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In this article we&rsquo;ll cover how to build a Kubernetes cluster using WSL2 and KinD under Windows 10. Over the past few years, Kubernetes has become the de facto standard in container orchestration. While there are now a variety of Kubernetes distributions and installers to deploy Kubernetes environments, we still need to deploy and run Kubernetes clusters locally, especially for developers, except in cloud or bare-metal environments.</p>
<p>However, Kubernetes was originally designed to be deployed and used in a Linux environment, but there are still many users who usually work with Windows operating systems. This tool is equivalent to a Linux subsystem running under Windows, which makes the environment boundary between Windows and Linux become less obvious, especially after the launch of WSL2 version, it has the ability to run Docker in WSL2, so now we can almost seamlessly run Kubernetes on WSL2. so now we can run Kubernetes on WSL2 almost seamlessly.</p>
<p>Here&rsquo;s a brief overview of how to install and configure WSL2 and Kubernetes clusters under Windows 10.</p>
<h2 id="install-wsl2">Install WSL2</h2>
<p>First we need to enable the &ldquo;Windows Subsystem for Linux&rdquo; feature before we can install the Linux distribution on Windows. Open PowerShell as administrator and run the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
</code></pre></td></tr></table>
</div>
</div><p>If we only install WSL1, we can restart the computer after executing the above command and install the corresponding Linux distribution, but if we need to install WSL2, we need to do the following additional actions.</p>
<h2 id="environment-preparation">Environment preparation</h2>
<h3 id="operating-system-version">Operating system version</h3>
<p>To update to WSL2, you first need to meet the following conditions.</p>
<ul>
<li>Windows 10 operating system (<a href="ms-settings:windowsupdate">updated to version 2004</a> of <strong>internal version 19041</strong> or later)</li>
<li>Check your Windows version by pressing Windows logo + R, then type <strong>winver</strong> and select &ldquo;OK&rdquo;. (or type the command <code>ver</code> at the Windows command prompt). If the internal version is lower than 19041, please <a href="ms-settings:windowsupdate">update to the latest Windows version</a>.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/1a97e99c29114d4da64cb41497ef108d.png" alt=""></p>
<blockquote>
<p>To upgrade Windows, you can use the official Update Assistant, which is very convenient: <a href="https://www.microsoft.com/zh-cn/software-download/windows10">https://www.microsoft.com/zh-cn/software-download/windows10</a></p>
</blockquote>
<h3 id="enabling-the-virtual-machine-platform-optional-component"><strong>Enabling the &ldquo;Virtual Machine Platform&rdquo; optional component</strong></h3>
<p>Before installing WSL 2, you must also enable the &ldquo;Virtual Machine Platform&rdquo; optional feature. Open PowerShell as an administrator and run the command shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre></td></tr></table>
</div>
</div><p><strong>Reboot</strong> the computer to complete the WSL installation and update to WSL2.</p>
<blockquote>
<p>There is also a prerequisite to enable virtualization at the hardware level, which can be enabled via BIOS access.</p>
</blockquote>
<h3 id="setting-wsl2-as-the-default-version"><strong>Setting WSL2 as the default version</strong></h3>
<p>When installing a new Linux distribution, run the following command in Powershell to set WSL 2 as the default version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">wsl --set-default-version <span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="install-and-configure-the-linux-distribution"><strong>Install and configure the Linux distribution</strong></h2>
<ol>
<li>Open <a href="https://aka.ms/wslstore">Microsoft Store</a>, search for Terminal, and install Windows Terminal for later interaction with the WSL subsystem.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/5525cca11fe945e6bfdf3ded4eabc4e4.png" alt=""></p>
<ol start="2">
<li>Search for Ubuntu and select Install.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/c63fc1f4ca5548108fa9cb9ba0342300.png" alt=""></p>
<p>After the installation is complete, the first time you open Ubuntu, a console window will open and you will wait a few minutes to configure it.</p>
<p>Then we can use Windows Terminal to operate the Ubuntu system. Select the Ubuntu distribution in Windows Terminal to jump to the Ubuntu terminal and log in with the username and password we configured above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/ca311271e4ae482983cdc97c3eef50e5.png" alt=""></p>
<p>Since by default we don&rsquo;t know the password for the root user, we can use the passwd command to set a new password for the root user if we want to use it.</p>
<h3 id="configuring-linux">Configuring Linux</h3>
<p>Then you can replace the Ubuntu repositories with Aliyun repositories:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@k8s:~# cp /etc/apt/sources.list /etc/apt/sources.list.bak
root@k8s:~# <span class="nb">echo</span> <span class="s2">&#34;deb http://mirrors.aliyun.com/ubuntu/ focal main restricted
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal universe
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-updates universe
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal multiverse
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-updates multiverse
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-security universe
</span><span class="s2">deb http://mirrors.aliyun.com/ubuntu/ focal-security multiverse&#34;</span> &gt; /etc/apt/sources.list
root@k8s:~#
</code></pre></td></tr></table>
</div>
</div><p>Then simply execute the update at</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@k8s:~# apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</code></pre></td></tr></table>
</div>
</div><p>In addition, we can configure the terminal, for example by replacing it with zsh.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 安装 zsh</span>
root@k8s:~# apt-get install zsh
</code></pre></td></tr></table>
</div>
</div><p><code>oh-my-zsh</code> can be used to quickly configure <code>zsh</code>, go to <a href="https://ohmyz.sh/">official website</a> or <a href="https://github.com/ohmyzsh/ohmyzsh">Github</a> to learn about its basic usage and its rich theme usage, and install it by simply executing the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@k8s:~# sh -c <span class="s2">&#34;</span><span class="k">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span class="k">)</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Install the <code>zsh-syntax-higlighting</code> syntax highlighting plugin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@k8s:~# git clone https://github.com/zsh-users/zsh-syntax-highlighting.git
<span class="c1"># 移动到 plugins 文件夹中</span>
root@k8s:~# mv zsh-syntax-highlighting <span class="nv">$ZSH_CUSTOM</span>/plugins
<span class="c1"># 配置环境变量</span>
root@k8s:~# <span class="nb">cd</span> ~
root@k8s:~# vim .zshrc
<span class="c1">#在 plugins 一列中添加 zsh-syntax-highlighting，如下</span>
<span class="nv">plugins</span><span class="o">=(</span>git sh-syntax-highlighting<span class="o">)</span>
<span class="c1"># 在文件最后添加</span>
root@k8s:~# <span class="nb">source</span> <span class="nv">$ZSH_CUSTOM</span>/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
<span class="c1"># 配置生效</span>
root@k8s:~# <span class="nb">source</span> ~/.zshrc
</code></pre></td></tr></table>
</div>
</div><p>After the configuration is complete, the final result of Terminal is shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/037ff154d3da4677a750d64d7f345aea.png" alt=""></p>
<h3 id="configuring-systemd">Configuring Systemd</h3>
<p>Since systemd cannot be used in WSL by default, many applications cannot be started, but some gods have solved this problem.
We can find the way to start SystemD under the link <a href="https://forum.snapcraft.io/t/running-snaps-on-wsl2-insiders-only-for-now/13033">https://forum.snapcraft.io/t/running-snaps-on-wsl2-insiders-only-for-now/13033</a>.</p>
<p>First install the Systemd-related dependencies at</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">apt install -yqq fontconfig daemonize
</code></pre></td></tr></table>
</div>
</div><p>Then create a script file as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Create the starting script for SystemD</span>
vi /etc/profile.d/00-wsl2-systemd.sh
<span class="nv">SYSTEMD_PID</span><span class="o">=</span><span class="k">$(</span>ps -ef <span class="p">|</span> grep <span class="s1">&#39;/lib/systemd/systemd --system-unit=basic.target$&#39;</span> <span class="p">|</span> grep -v unshare <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$SYSTEMD_PID</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   sudo /usr/bin/daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit<span class="o">=</span>basic.target
   <span class="nv">SYSTEMD_PID</span><span class="o">=</span><span class="k">$(</span>ps -ef <span class="p">|</span> grep <span class="s1">&#39;/lib/systemd/systemd --system-unit=basic.target$&#39;</span> <span class="p">|</span> grep -v unshare <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$SYSTEMD_PID</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$SYSTEMD_PID</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">exec</span> sudo /usr/bin/nsenter -t <span class="nv">$SYSTEMD_PID</span> -a su - <span class="nv">$LOGNAME</span>
<span class="k">fi</span>
</code></pre></td></tr></table>
</div>
</div><p>The above script is placed in the /etc/profile.d directory, so to make the script work, we need to exit the current session and re-enter it.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/db66acd9106e4785b28847ea7da1441f.png" alt=""></p>
<p>Here we are done with the installation and configuration of WSL2.</p>
<h2 id="install-docker">Install Docker</h2>
<p>Now we can install Docker directly in WSL, the same way we usually do in Linux. However, Docker has also developed a desktop manager that can use the <code>Docker</code> daemon in <code>WSL2</code>, open the [Docker Desktop WSL2 backend](<a href="https://docs.docker.com/docker-for-windows/wsl-tech-">https://docs.docker.com/docker-for-windows/wsl-tech-</a> preview/) page, download the latest Docker Desktop for Windows program, install it, and open it with the following settings</p>
<p>Enable the <code>Use the WSL 2 based engine</code> checkbox</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/da2e52eeb7e749218ddd466a248dba33.png" alt=""></p>
<p>At this time, the docker command is still not found in WSL.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/4d835858840f40ad8fb83fcd5f0e9f9e.png" alt=""></p>
<p>We also need to set in Resources which WSL2 distribution we want to access Docker from, as shown below using Ubuntu-20.04.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/3583ce71b90447e98c93ea4afed83e35.png" alt=""></p>
<p>Then remember to restart Docker for Windows, and once the restart is complete we can use the docker command from within WSL:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/1d11068027a54b8ab73570d4bee7748b.png" alt=""></p>
<p>The basic configuration of Docker and WSL2 is done here, so let&rsquo;s install the Kubernetes cluster.</p>
<h2 id="install-kubernetes">Install Kubernetes</h2>
<p>There are many mature solutions for installing Kubernetes clusters, and there are minikube, microk8s, etc. to build them locally. We choose to use KinD here: a simple way to run Kubernetes in a container. Here we will install the instructions from the official KinD website (<a href="https://kind.sigs.k8s.io/docs/user/quick-start/">https://kind.sigs.k8s.io/docs/user/quick-start/</a>) to do so.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 下载 KinD 二进制文件</span>
curl -Lo ./kind https://github.com/kubernetes-sigs/kind/releases/download/v0.8.1/kind-<span class="k">$(</span>uname<span class="k">)</span>-amd64
<span class="c1"># 标记为可执行文件</span>
chmod +x ./kind
<span class="c1"># 移动到 PATH 目录下去</span>
mv ./kind /usr/local/bin/
<span class="c1"># TODO，记得提前下载安装 kubectl 二进制文件</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/44bbf7b084814021a06b1df14bf14c22.png" alt=""></p>
<p>Once KinD is acquired, we can create the Kubernetes cluster</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 检查是否设置了 KUBECONFIG 环境变量</span>
<span class="nb">echo</span> <span class="nv">$KUBECONFIG</span>
<span class="c1"># 检查是否存在 .kube 目录，不需要手动创建</span>
ls <span class="nv">$HOME</span>/.kube
<span class="c1"># 使用 kind 命令创建一个名为 wslk8s 的集群</span>
kind create cluster --name wslk8s
<span class="c1"># 创建后检查 .kube 目录</span>
ls <span class="nv">$HOME</span>/.kube
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/79f4445a1e4b4415a601335693206b81.png" alt=""></p>
<p>The cluster is now successfully created, and we can also open the above <code>Kubernetes master</code> address in a Windows browser at</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/f3f35826a8cc401a8f4e997be41439c3.png" alt=""></p>
<p>This is where Docker Desktop for Windows combined with the WSL2 backend really shines, with much better performance than the previous Docker default approach.</p>
<p>At this point we have successfully created a single-node Kubernetes cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 检查节点</span>
kubectl get nodes
<span class="c1"># 获取所有 namespace 下面的资源对象</span>
kubectl get all --all-namespaces
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/9e73793257b74e14af44472034ec4c74.png" alt=""></p>
<p>For most users, running a one-node cluster locally is sufficient, but if only one node is needed, we can use minikube. we can also use KinD to create a multi-node cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 删除现在的集群</span>
kind delete cluster --name wslk8s
<span class="c1"># 创建一个3节点集群的配置文件</span>
cat <span class="s">&lt;&lt; EOF &gt; kind-3nodes.yaml
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">nodes:
</span><span class="s">  - role: control-plane
</span><span class="s">  - role: worker
</span><span class="s">  - role: worker
</span><span class="s">EOF</span>
<span class="c1"># 使用配置文件创建新的集群</span>
kind create cluster --name wslkindmultinodes --config ./kind-3nodes.yaml
<span class="c1"># 获取集群节点</span>
kubectl get nodes
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/6904aad067e7470cb48594f2b8957934.png" alt=""></p>
<p>You can see that we have 3 Kubernetes nodes running successfully here with v1.18.2, and they are all running in Docker containers, which we can view with the docker ps command, similar to Kubernetes running in Docker containers, hence the name KinD.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/c3571ba533394ad5aad4236c07fcc952.png" alt=""></p>
<p>Now we can also go through the resource objects of the entire cluster: the</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/2d046aeaa3924fcd81d174555aeac8c4.png" alt=""></p>
<p>Of course we can also deploy applications in a cluster, for example by installing a Kubernetes Dashboard at</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 在集群中安装 Dashboard</span>
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.1/aio/deploy/recommended.yaml
<span class="c1"># 获取 dashboard 的资源对象</span>
kubectl get all -n kubernetes-dashboard
</code></pre></td></tr></table>
</div>
</div><p>After successful installation, we can create a temporary proxy using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl proxy
</code></pre></td></tr></table>
</div>
</div><p>Then in a Windows browser we can access the Dashboard service at the following address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/9ff3b27d8c7148dda429ebaec42edd86.png" alt=""></p>
<p>We then use the officially recommended RBAC method to create a Token for login, reopen a WSL2 terminal, and execute the command shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 创建一个新的 ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="l">kubectl apply -f - &lt;&lt;EOF</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span><span class="w"></span><span class="c"># 将上面的 SA 绑定到系统的 cluster-admin 这个集群角色上</span><span class="w">
</span><span class="w"></span><span class="l">kubectl apply -f - &lt;&lt;EOF</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>We can then use the ServiceAccount created above to obtain the Token information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl -n kubernetes-dashboard describe secret <span class="k">$(</span>kubectl -n kubernetes-dashboard get secret <span class="p">|</span> grep admin-user <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="c1"># 拷贝上面命令获取到的 Token 数据 </span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/e9766b9250a24ec3ab9b4937a5c74805.png" alt=""></p>
<p>Copy the token data obtained above to the Dashboard login page to log in.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/12/34fe17df923142e48751595a97970c7b.png" alt=""></p>
<p>Here we have finished building a Kubernetes cluster using WSL2 + KinD on Windows, which is very convenient for local development and testing. Of course, there are still some minor problems with WSL2, such as not being able to access the services in WSL2 over the LAN, but there are some solutions, but they are not elegant, and the IP of WSL2 will change after each reboot, so it is sometimes very inconvenient, but overall WSL2 is still very good.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/use-loki-monitor-alert/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Log monitoring and alerting with Loki</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/k8s-in-k8s/">
            <span class="next-text nav-default">Running Kubernetes in Kubernetes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
