<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Customizing the Kubernetes Scheduler - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="kube-scheduler is one of the core components of kubernetes, mainly responsible for the scheduling function of the entire cluster resources, according to specific scheduling algorithms and policies, Pods will be scheduled to the optimal working nodes, so as to make more reasonable and full use of the cluster resources, which is also a very important reason why we choose to use kubernetes This is a very important reason why we" /><meta name="keywords" content="k8s, Custom, Scheduler" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/custom-k8s-scheduler/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Customizing the Kubernetes Scheduler" />
<meta property="og:description" content="kube-scheduler is one of the core components of kubernetes, mainly responsible for the scheduling function of the entire cluster resources, according to specific scheduling algorithms and policies, Pods will be scheduled to the optimal working nodes, so as to make more reasonable and full use of the cluster resources, which is also a very important reason why we choose to use kubernetes This is a very important reason why we" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/custom-k8s-scheduler/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-21T17:09:26+08:00" />
<meta property="article:modified_time" content="2021-12-21T17:09:26+08:00" />

<meta itemprop="name" content="Customizing the Kubernetes Scheduler">
<meta itemprop="description" content="kube-scheduler is one of the core components of kubernetes, mainly responsible for the scheduling function of the entire cluster resources, according to specific scheduling algorithms and policies, Pods will be scheduled to the optimal working nodes, so as to make more reasonable and full use of the cluster resources, which is also a very important reason why we choose to use kubernetes This is a very important reason why we"><meta itemprop="datePublished" content="2021-12-21T17:09:26+08:00" />
<meta itemprop="dateModified" content="2021-12-21T17:09:26+08:00" />
<meta itemprop="wordCount" content="6449">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Customizing the Kubernetes Scheduler"/>
<meta name="twitter:description" content="kube-scheduler is one of the core components of kubernetes, mainly responsible for the scheduling function of the entire cluster resources, according to specific scheduling algorithms and policies, Pods will be scheduled to the optimal working nodes, so as to make more reasonable and full use of the cluster resources, which is also a very important reason why we choose to use kubernetes This is a very important reason why we"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Customizing the Kubernetes Scheduler</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-21 17:09:26 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 6449 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#scheduling-process">Scheduling Process</a></li>
        <li><a href="#customizing-the-scheduler">Customizing the Scheduler</a>
          <ul>
            <li><a href="#scheduler-extensions">Scheduler Extensions</a></li>
            <li><a href="#scheduling-framework">Scheduling Framework</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><code>kube-scheduler</code> is one of the core components of kubernetes, mainly responsible for the scheduling function of the entire cluster resources, according to specific scheduling algorithms and policies, Pods will be scheduled to the optimal working nodes, so as to make more reasonable and full use of the cluster resources, which is also a very important reason why we choose to use kubernetes This is a very important reason why we chose to use kubernetes. If a new technology doesn&rsquo;t help companies save money and provide efficiency, I believe it&rsquo;s hard to move forward.</p>
<h2 id="scheduling-process">Scheduling Process</h2>
<p>By default, the default scheduler provided by <code>kube-scheduler</code> meets most of our requirements, and the examples we&rsquo;ve talked to earlier have largely used the default policy to ensure that our Pods can be assigned to nodes with sufficient resources to run. However, in a real online project, we may know our application better than kubernetes, for example, we want a Pod to run on only a few nodes, or these nodes can only be used to run certain types of applications, which requires our scheduler to be controllable.</p>
<p>The main purpose of <code>kube-scheduler</code> is to schedule Pods to the appropriate Node node based on a specific scheduling algorithm and scheduling policy. It is a standalone binary that listens to the API Server all the time after startup, gets Pods with empty <code>PodSpec.NodeName</code>, and creates a binding for each Pod.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/21/4a3d0cba4ed3412f8576e06e4967874c.png" alt="image"></p>
<p>This process may seem relatively simple to us, but in a real production environment, there are many issues to consider.</p>
<ul>
<li>How to ensure the fairness of all node scheduling? It is important to know that not all nodes have the same resource allocation.</li>
<li>How to ensure that each node can be allocated resources?</li>
<li>How can the cluster resources be used efficiently?</li>
<li>How can the cluster resources be maximized?</li>
<li>How to ensure the performance and efficiency of Pod scheduling?</li>
<li>Can users customize their own scheduling policies according to their actual needs?</li>
</ul>
<p>Considering the various complexities in real-world environments, the kubernetes scheduler is implemented in a plug-in form, which allows users to customize or develop the scheduler as a plug-in and integrate it with kubernetes.</p>
<p>The source code of the kubernetes scheduler is located in <code>kubernetes/pkg/scheduler</code>, and the general code directory structure is as follows: (the directory structure may not be the same for different versions)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">kubernetes/pkg/scheduler
-- scheduler.go         //调度相关的具体实现
|-- algorithm
|   |-- predicates      //节点筛选策略
|   |-- priorities      //节点打分策略
|-- algorithmprovider
|   |-- defaults         //定义默认的调度器
</code></pre></td></tr></table>
</div>
</div><p>The core program that creates and runs the Scheduler is in <code>pkg/scheduler/scheduler.go</code> and the entry program for <code>kube-scheduler</code> is in <code>cmd/kube-scheduler/scheduler.go</code>.</p>
<h2 id="customizing-the-scheduler">Customizing the Scheduler</h2>
<p>Generally speaking, we have 4 ways to extend the Kubernetes scheduler.</p>
<ul>
<li>One way is to directly clone the official kube-scheduler source code, modify the code directly where appropriate, and then recompile and run the modified program. This method is of course the least recommended and impractical, as it requires a lot of extra effort to keep up with the upstream scheduler changes.</li>
<li>The default scheduler and our custom scheduler can be overridden by the Pod&rsquo;s <code>spec.schedulerName</code>. The default default scheduler is used by default, but it is also troublesome when multiple schedulers coexist, for example, when multiple schedulers schedule For example, when multiple schedulers schedule Pods to the same node, you may encounter some problems because it is likely that both schedulers will schedule both Pods to the same node at the same time, but it is likely that one of the Pods will actually run out of resources. It is not easy to maintain a high quality custom scheduler because we need a comprehensive knowledge of the default scheduler, the overall Kubernetes architecture, and the various relationships or limitations of the various Kubernetes API objects.</li>
<li>The third approach is the <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/scheduler_extender.md">scheduler extender</a>, which is currently a viable solution that is compatible with the upstream scheduler. The so-called scheduler extension is actually a configurable Webhook that contains <code>filter</code> and <code>priority</code> endpoints corresponding to the two main phases of the scheduling cycle (filtering and scoring).</li>
<li>The fourth approach is through the Scheduling Framework. The pluggable architecture of the Scheduling Framework was introduced in Kubernetes v1.15, making the task of customizing the scheduler much easier. The Scheduling Framework adds a set of plug-in APIs to the existing scheduler, which keeps the &ldquo;core&rdquo; of the scheduler simple and easy to maintain while making most of the scheduling functionality available in the form of plug-ins, and the above <code>scheduler extensions</code> have been deprecated in our current v1.16 release. So the scheduling framework is the core way to customize the scheduler in the future.</li>
</ul>
<p>Here we can briefly describe the implementation of the latter two approaches.</p>
<h3 id="scheduler-extensions">Scheduler Extensions</h3>
<p>Before we get into the scheduler extensions, let&rsquo;s take a look at how the Kubernetes scheduler works:</p>
<ol>
<li>the default scheduler is started with the specified parameters (we built the cluster with kubeadm and the startup configuration file is located at <code>/etc/kubernetes/manifests/kube-schdueler.yaml</code>)</li>
<li>watch apiserver and put the Pods with empty <code>spec.nodeName</code> into the scheduler&rsquo;s internal scheduling queue</li>
<li>Pop out a Pod from the scheduling queue and start a standard scheduling cycle</li>
<li>Retrieve the &ldquo;hard requirements&rdquo; (e.g. CPU/memory request values, nodeSelector/nodeAffinity) from the Pod properties, and then a filtering phase occurs, where a candidate list of nodes satisfying the requirements is calculated</li>
<li>retrieves the &ldquo;soft requirements&rdquo; from the Pod property and applies some default &ldquo;soft policies&rdquo; (e.g. Pods tend to be more clustered or spread out on nodes), and finally, it gives a score to each candidate node and selects the final one with the highest score 6.</li>
<li>communicates with the apiserver (sends a binding call) and then sets the Pod&rsquo;s <code>spec.nodeName</code> property to indicate the node to which the Pod will be dispatched.</li>
</ol>
<p>We can specify which parameters the scheduler will use by looking at the <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/">official documentation</a> with the <code>--config</code> parameter, which configuration file should contain a <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration">KubeSchedulerConfiguration</a> object in the following format: (/etc/kubernetes/scheduler-extender.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w"> </span><span class="c"># 通过&#34;--config&#34; 传递文件内容</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span><span class="w"></span><span class="nt">clientConnection</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">kubeconfig</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/kubernetes/scheduler.conf&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">algorithmSource</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">policy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/kubernetes/scheduler-extender-policy.yaml&#34;</span><span class="w">  </span><span class="c"># 指定自定义调度策略文件</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The key parameter we should enter here is <code>algorithmSource.policy</code>, this policy file can be either a local file or a ConfigMap resource object, depending on how the scheduler is deployed, for example, our default scheduler here is started as a static Pod, so we can configure it as a local file.</p>
<p>The policy file <code>/etc/kubernetes/scheduler-extender-policy.yaml</code> should follow <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Policy">kubernetes/pkg/scheduler/apis/config/legacy_types.go#L28</a>, in our v1.16.2 release here we already support both JSON and YAML format policy files, here is a simple example of our definition, you can see the <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#Extender">Extender</a> for a description of the policy file definition specification.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Policy</span><span class="w">
</span><span class="w"></span><span class="nt">extenders</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">urlPrefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://127.0.0.1:8888/&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">filterVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;filter&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">prioritizeVerb</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;prioritize&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">enableHttps</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Our Policy policy file here extends the scheduler by defining <code>extenders</code>, sometimes we don&rsquo;t need to write the code, we can customize it directly in this configuration file by specifying <code>predicates</code> and <code>priorities</code>, if not specified then the default <code>DefaultProvier</code> will be used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;Policy&#34;</span><span class="p">,</span>
    <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
    <span class="nt">&#34;predicates&#34;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;MatchNodeSelector&#34;</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PodFitsResources&#34;</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;PodFitsHostPorts&#34;</span>
    <span class="p">},{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;HostName&#34;</span>
    <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;priorities&#34;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;EqualPriority&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ImageLocalityPriority&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;LeastRequestedPriority&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;BalancedResourceAllocation&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;extenders&#34;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="nt">&#34;urlPrefix&#34;</span><span class="p">:</span> <span class="s2">&#34;/prefix&#34;</span><span class="p">,</span>
        <span class="nt">&#34;filterVerb&#34;</span><span class="p">:</span> <span class="s2">&#34;filter&#34;</span><span class="p">,</span>
        <span class="nt">&#34;prioritizeVerb&#34;</span><span class="p">:</span> <span class="s2">&#34;prioritize&#34;</span><span class="p">,</span>
        <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&#34;bindVerb&#34;</span><span class="p">:</span> <span class="s2">&#34;bind&#34;</span><span class="p">,</span>
        <span class="nt">&#34;enableHttps&#34;</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The policy change file defines an HTTP extender service running under <code>127.0.0.1:8888</code> and has registered the policy with the default scheduler so that at the end of the filtering and scoring phases, the results can be passed to the extender&rsquo;s endpoints <code>&lt;urlPrefix&gt;/&lt;filterVerb&gt;</code> and <code>&lt; urlPrefix&gt;/&lt;prioritizeVerb&gt;</code>, where we can further filter and prioritize in the extender to suit our specific business needs.</p>
<h4 id="example">Example</h4>
<p>Let&rsquo;s implement a simple scheduler extension directly in golang, but of course you can use any other programming language, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">router</span> <span class="o">:=</span> <span class="nx">httprouter</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="nx">router</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">Index</span><span class="p">)</span>
    <span class="nx">router</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/filter&#34;</span><span class="p">,</span> <span class="nx">Filter</span><span class="p">)</span>
    <span class="nx">router</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/prioritize&#34;</span><span class="p">,</span> <span class="nx">Prioritize</span><span class="p">)</span>

    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8888&#34;</span><span class="p">,</span> <span class="nx">router</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then we need to implement the <code>/filter</code> and <code>/prioritize</code> endpoint handlers.</p>
<p>The extension function <code>Filter</code> takes an argument with input type <code>schedulerapi.ExtenderArgs</code> and returns a value of type <code>*schedulerapi.ExtenderFilterResult</code>. In the function, we can further filter the input nodes: the</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// filter 根据扩展程序定义的预选规则来过滤节点
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">filter</span><span class="p">(</span><span class="nx">args</span> <span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">ExtenderArgs</span><span class="p">)</span> <span class="o">*</span><span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">ExtenderFilterResult</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">filteredNodes</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span>
	<span class="nx">failedNodes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">FailedNodesMap</span><span class="p">)</span>
	<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Pod</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">node</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">fits</span><span class="p">,</span> <span class="nx">failReasons</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">podFitsOnNode</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">fits</span> <span class="p">{</span>
			<span class="nx">filteredNodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">filteredNodes</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">failedNodes</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">]</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">failReasons</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">result</span> <span class="o">:=</span> <span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">ExtenderFilterResult</span><span class="p">{</span>
		<span class="nx">Nodes</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">NodeList</span><span class="p">{</span>
			<span class="nx">Items</span><span class="p">:</span> <span class="nx">filteredNodes</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">FailedNodes</span><span class="p">:</span> <span class="nx">failedNodes</span><span class="p">,</span>
		<span class="nx">Error</span><span class="p">:</span>       <span class="s">&#34;&#34;</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">result</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the filter function, we loop through each node and then use our own implemented business logic to determine whether the node should be approved or not, here our implementation is relatively simple, in the <code>podFitsOnNode()</code> function we simply check whether the random number is even to determine, if so we consider it a lucky node, otherwise we refuse to approve the node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">predicatesSorted</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">LuckyPred</span><span class="p">}</span>

<span class="kd">var</span> <span class="nx">predicatesFuncs</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">FitPredicate</span><span class="p">{</span>
    <span class="nx">LuckyPred</span><span class="p">:</span> <span class="nx">LuckyPredicate</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">FitPredicate</span> <span class="kd">func</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">node</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">podFitsOnNode</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">node</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fits</span> <span class="o">:=</span> <span class="kc">true</span>
    <span class="kd">var</span> <span class="nx">failReasons</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">predicateKey</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">predicatesSorted</span> <span class="p">{</span>
        <span class="nx">fit</span><span class="p">,</span> <span class="nx">failures</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">predicatesFuncs</span><span class="p">[</span><span class="nx">predicateKey</span><span class="p">](</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">fits</span> <span class="p">=</span> <span class="nx">fits</span> <span class="o">&amp;&amp;</span> <span class="nx">fit</span>
        <span class="nx">failReasons</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">failReasons</span><span class="p">,</span> <span class="nx">failures</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">fits</span><span class="p">,</span> <span class="nx">failReasons</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">LuckyPredicate</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">node</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lucky</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nx">lucky</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;pod %v/%v is lucky to fit on node %v\n&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;pod %v/%v is unlucky to fit on node %v\n&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">LuckyPredFailMsg</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The same scoring function is implemented in the same way, where we give a random score on each node:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// it&#39;s webhooked to pkg/scheduler/core/generic_scheduler.go#PrioritizeNodes()
</span><span class="c1">// 这个函数输出的分数会被添加会默认的调度器
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">prioritize</span><span class="p">(</span><span class="nx">args</span> <span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">ExtenderArgs</span><span class="p">)</span> <span class="o">*</span><span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">HostPriorityList</span> <span class="p">{</span>
	<span class="nx">pod</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Pod</span>
	<span class="nx">nodes</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">.</span><span class="nx">Items</span>

	<span class="nx">hostPriorityList</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">HostPriorityList</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">nodes</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodes</span> <span class="p">{</span>
		<span class="nx">score</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">MaxPriority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">// 在最大优先级内随机取一个值
</span><span class="c1"></span>		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="nx">luckyPrioMsg</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">score</span><span class="p">)</span>
		<span class="nx">hostPriorityList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">schedulerapi</span><span class="p">.</span><span class="nx">HostPriority</span><span class="p">{</span>
			<span class="nx">Host</span><span class="p">:</span>  <span class="nx">node</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
			<span class="nx">Score</span><span class="p">:</span> <span class="nx">score</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">hostPriorityList</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can then use the following command to compile and package our application.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o app
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>The complete code for this section of the scheduler extension is available at: <a href="https://github.com/cnych/sample-scheduler-extender">https://github.com/cnych/sample-scheduler-extender</a>.</p>
</blockquote>
<p>Once the build is complete, copy the application <code>app</code> to the node where <code>kube-scheduler</code> is located and run it directly. Now we can configure the above policy file into the <code>kube-scheduler</code> component. Our cluster here is built by kubeadm, so we can directly modify the file <code>/etc/kubernetes/manifests/kube-schduler.yaml</code> with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span><span class="w">    </span><span class="nt">tier</span><span class="p">:</span><span class="w"> </span><span class="l">control-plane</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">kube-scheduler</span><span class="w">
</span><span class="w">    </span>- --<span class="l">authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span><span class="w">
</span><span class="w">    </span>- --<span class="l">authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span><span class="w">
</span><span class="w">    </span>- --<span class="l">bind-address=127.0.0.1</span><span class="w">
</span><span class="w">    </span>- --<span class="l">kubeconfig=/etc/kubernetes/scheduler.conf</span><span class="w">
</span><span class="w">    </span>- --<span class="l">leader-elect=true</span><span class="w">
</span><span class="w">    </span>- --<span class="l">config=/etc/kubernetes/scheduler-extender.yaml</span><span class="w">
</span><span class="w">    </span>- --<span class="l">v=9</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.azk8s.cn/google_containers/kube-scheduler:v1.16.2</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w">
</span><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/healthz</span><span class="w">
</span><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10251</span><span class="w">
</span><span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler.conf</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubeconfig</span><span class="w">
</span><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler-extender.yaml</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extender</span><span class="w">
</span><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler-extender-policy.yaml</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extender-policy</span><span class="w">
</span><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="l">system-cluster-critical</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler.conf</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">FileOrCreate</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubeconfig</span><span class="w">
</span><span class="w">  </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler-extender.yaml</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">FileOrCreate</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extender</span><span class="w">
</span><span class="w">  </span>- <span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/scheduler-extender-policy.yaml</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">FileOrCreate</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">extender-policy</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Of course we are configuring this directly on the default <code>kube-scheduler</code>, but we can also copy a YAML file of the scheduler and change the schedulerName to deploy it without affecting the default scheduler, and then specify <code>spec. schedulerName</code> on the Pod that needs to use this test scheduler. For using multiple schedulers, see the official documentation <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/configure-multiple-schedulers/">Configuring Multiple Schedulers</a>.</p>
</blockquote>
<p>After reconfiguring <code>kube-scheduler</code>, you can check the logs to verify that the reboot was successful, but be sure to add <code>/etc/kubernetes/scheduler-extender.yaml</code> and <code>/etc/kubernetes/scheduler-extender- policy.yaml</code> files into the Pod: <code>/etc/kubernetes/scheduler-extender.yaml</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl logs -f kube-scheduler-ydzs-master -n kube-system
I0102 15:17:38.824657       <span class="m">1</span> serving.go:319<span class="o">]</span> Generated self-signed cert in-memory
I0102 15:17:39.472276       <span class="m">1</span> server.go:143<span class="o">]</span> Version: v1.16.2
I0102 15:17:39.472674       <span class="m">1</span> defaults.go:91<span class="o">]</span> TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory
W0102 15:17:39.479704       <span class="m">1</span> authorization.go:47<span class="o">]</span> Authorization is disabled
W0102 15:17:39.479733       <span class="m">1</span> authentication.go:79<span class="o">]</span> Authentication is disabled
I0102 15:17:39.479777       <span class="m">1</span> deprecated_insecure_serving.go:51<span class="o">]</span> Serving healthz insecurely on <span class="o">[</span>::<span class="o">]</span>:10251
I0102 15:17:39.480559       <span class="m">1</span> secure_serving.go:123<span class="o">]</span> Serving securely on 127.0.0.1:10259
I0102 15:17:39.682180       <span class="m">1</span> leaderelection.go:241<span class="o">]</span> attempting to acquire leader lease  kube-system/kube-scheduler...
I0102 15:17:56.500505       <span class="m">1</span> leaderelection.go:251<span class="o">]</span> successfully acquired lease kube-system/kube-scheduler
</code></pre></td></tr></table>
</div>
</div><p>Here we have created and configured a very simple scheduler extension, now let&rsquo;s run a Deployment to see how it works, we prepare a deployment Yaml with 20 copies: (test-scheduler.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pause</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">pause</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">pause</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pause</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.azk8s.cn/google_containers/pause:3.1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Create the above resource object directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kuectl apply -f test-scheduler.yaml
deployment.apps/pause created
</code></pre></td></tr></table>
</div>
</div><p>At this point we go to the log of the scheduler extension we wrote.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ ./app
......
2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is unlucky to fit on node ydzs-node1
2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score <span class="m">7</span>
2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score <span class="m">9</span>
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node3
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node4
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node1
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node2
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score <span class="m">4</span>
2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score <span class="m">8</span>
......
</code></pre></td></tr></table>
</div>
</div><p>We can see the process of Pod scheduling, in addition the default scheduler will periodically retry failed Pods, so they will be re-passed again and again to our scheduler extension, our logic is to check if the random number is even, so eventually all Pods will be in running state.</p>
<p>The scheduler extender may be able to meet our needs in some cases, but he still has some limitations and drawbacks.</p>
<ul>
<li>Communication cost: data is transferred between the default scheduler and the scheduler extender with <code>http(s)</code>, which has some cost when performing serialization and deserialization</li>
<li>Limited extension points: extensions can only participate at the end of certain phases, such as <code>&quot;Filter&quot;</code> and <code>&quot;Prioritize&quot;</code>, and they cannot be called at the beginning or middle of any phase</li>
<li>Subtraction over addition: compared to the node candidate list passed by the default scheduler, we may have some requirements to add a new candidate node list, but this is a riskier operation because there is no guarantee that the new node will pass other requirements, so it is better for the scheduler extensions to perform <code>&quot;Subtraction&quot;</code> (further filtering) rather than <code>&quot;Addition&quot;</code> (adding nodes)</li>
<li>Cache sharing: the above is just a simple test example, but in a real project we are required to make scheduling decisions by looking at the state of the whole cluster. The default scheduler can schedule decisions well, but cannot share its cache, which means we have to build and maintain our own cache</li>
</ul>
<p>Due to these limitations, the Kubernetes scheduling team came up with the fourth method above for better extensions, the <code>Scheduler Framework</code>, which basically solves all the problems we encounter and is now the official recommended extension, so it will be the most mainstream way to extend the scheduler in the future.</p>
<h3 id="scheduling-framework">Scheduling Framework</h3>
<p>The scheduling framework defines a set of extension points. Users can implement the interfaces defined by the extension points to define their own scheduling logic (we call them <strong>extensions</strong>) and register extensions to the extension points. The scheduling framework will call the extensions registered by the user when it encounters the corresponding extension points when executing the scheduling workflow. Scheduling frameworks have a specific purpose when reserving extensions, some extensions on extension points can change the scheduler&rsquo;s decision method, some extensions on extension points just send a notification.</p>
<p>We know that whenever a Pod is scheduled, it is executed according to two processes: the scheduling process and the binding process.</p>
<p>The scheduling process selects a suitable node for the Pod, and the binding process applies the decisions of the scheduling process to the cluster (i.e., runs the Pod on the selected node), combining the scheduling and binding processes in what is called the <strong>scheduling context</strong>. Note that the scheduling process runs `synchronously' (scheduling for only one Pod at the same point in time), and the binding process can run asynchronously (binding for multiple Pods at the same point in time).</p>
<p>The scheduling process and the binding process will exit in the middle of the process when they encounter the following conditions.</p>
<ul>
<li>The scheduler thinks there is no optional node for the Pod</li>
<li>Internal error</li>
</ul>
<p>In this case, the Pod is put back into the <strong>pending queue</strong> and waits for the next retry.</p>
<h4 id="extension-points">Extension Points</h4>
<p>The following diagram shows the scheduling context in the scheduling framework and the extension points in it. An extension can register multiple extension points so that more complex stateful tasks can be executed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/21/55f7455b11d04a6ea5b37bef4c61d7bc.png" alt="image"></p>
<ol>
<li>
<p>The <code>QueueSort</code> extension is used to sort the queue of Pods to be dispatched to decide which Pod to be dispatched first. can only have one <code>QueueSort</code> plugin in effect at the same point in time.</p>
</li>
<li>
<p><code>Pre-filter</code> extension is used to pre-process the Pod information or check some prerequisites that must be met by the cluster or Pod, if <code>pre-filter</code> returns an error, the scheduling process is terminated.</p>
</li>
<li>
<p>The <code>Filter</code> extension is used to exclude nodes that cannot run the Pod. For each node, the scheduler will execute the <code>filter</code> extensions in order; if any of the <code>filter</code>s marks the node as unselectable, the remaining <code>filter</code> extensions will not be executed. The scheduler can execute <code>filter</code> extensions on multiple nodes at the same time.</p>
</li>
<li>
<p><code>Post-filter</code> is a notification type extension point that is called with the argument of a list of nodes that have been filtered as <strong>selectable nodes</strong> at the end of the <code>filter</code> phase, which can be used in the extension to update the internal state, or to generate log or metrics information.</p>
</li>
<li>
<p>The <code>Scoring</code> extension is used to score all the selectable nodes. The scheduler will call the <code>Soring</code> extension for each node, and the scoring result is an integer in a range. During the <code>normalize scoring</code> phase, the scheduler will combine the scoring results of each <code>scoring</code> extension for a specific node with the extension&rsquo;s weight as the final scoring result.</p>
</li>
<li>
<p>The <code>normalize scoring</code> extension modifies the scoring result of each node before the scheduler performs the final sorting of the nodes. scoring` extensions of all plugins once for each scheduling session performed by the scheduling framework. 4.</p>
</li>
<li>
<p><code>Reserve</code> is a notification extension that stateful plugins can use to obtain the resources reserved for Pods on a node. This event occurs before the scheduler binds a Pod to a node, in order to avoid the situation where the actual resources used exceed the resources available when the scheduler schedules a new Pod to the node while waiting for the Pod to be bound to the node. (Because binding a Pod to a node happens asynchronously). This is the last step of the scheduling process, after the Pod enters the reserved state, either the Unreserve extension is triggered when the binding fails or the binding process is ended by the Post-bind extension when the binding succeeds.</p>
</li>
<li>
<p>The <code>Permit</code> extension is used to prevent or delay the binding of a Pod to a node. the Permit extension can do one of the following three things.</p>
</li>
</ol>
<ul>
<li>approve: When all permit extensions have approved the binding of the Pod to the node, the scheduler will continue the binding process</li>
<li>deny: If any of the permit extensions deny the binding of a Pod to a node, the Pod will be put back in the queue to be scheduled and the <code>Unreserve</code> extension will be triggered.</li>
<li>wait: If a permit extension returns wait, the Pod will remain in the permit phase until it is approved by another extension. If a timeout event occurs and the wait state becomes deny, the Pod will be put back in the queue to be dispatched and the Unreserve extension will be triggered.</li>
</ul>
<ol start="9">
<li>
<p>The <code>Pre-bind</code> extension is used to perform certain logic before the Pod is bound. For example, the pre-bind extension can mount a network-based data volume to a node so that the Pod can use it. If any of the <code>pre-bind</code> extensions return an error, the Pod will be put back in the queue to be dispatched, at which point the Unreserve extension will be triggered.</p>
</li>
<li>
<p>The <code>Bind</code> extension is used to bind a Pod to a node.</p>
</li>
</ol>
<ul>
<li>The bind extension is executed only when all pre-bind extensions have been successfully executed</li>
<li>The scheduling framework invokes bind extensions one by one in the order in which they are registered</li>
<li>A specific bind extension can choose to process or not process the Pod</li>
<li>If a bind extension handles the binding of the Pod to a node, the remaining bind extensions will be ignored</li>
</ul>
<ol start="11">
<li><code>Post-bind</code> is a notification extension.</li>
</ol>
<ul>
<li>Post-bind extension is called passively after a Pod is successfully bound to a node</li>
<li>The Post-bind extension is the last step of the binding process and can be used to perform resource cleanup actions</li>
</ul>
<ol start="12">
<li><code>Unreserve</code> is a notification extension that is called if a resource is reserved for a Pod and the Pod is denied binding during the binding process. the unreserve extension should release the compute resources on the node that has been reserved for the Pod. The reserve extension and the unreserve extension should appear in pairs in a plugin.</li>
</ol>
<p>If we want to implement our own plugin, we must register the plugin with the scheduling framework and complete the configuration, in addition to implementing the extension point interface, which corresponds to the extension point interface we can find in the source code <code>pkg/scheduler/framework/v1alpha1/interface.go</code> file, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// PreFilterPlugin is an interface that must be implemented by &#34;prefilter&#34; plugins.
</span><span class="c1">// These plugins are called at the beginning of the scheduling cycle.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PreFilterPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">PreFilter</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// FilterPlugin is an interface for Filter plugins. These plugins are called at the
</span><span class="c1">// filter extension point for filtering out hosts that cannot run a pod.
</span><span class="c1">// This concept used to be called &#39;predicate&#39; in the original scheduler.
</span><span class="c1">// These plugins should return &#34;Success&#34;, &#34;Unschedulable&#34; or &#34;Error&#34; in Status.code.
</span><span class="c1">// However, the scheduler accepts other valid codes as well.
</span><span class="c1">// Anything other than &#34;Success&#34; will lead to exclusion of the given host from
</span><span class="c1">// running the pod.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">FilterPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Filter</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an
</span><span class="c1">// informational extension point. Plugins will be called with a list of nodes
</span><span class="c1">// that passed the filtering phase. A plugin may use this data to update internal
</span><span class="c1">// state or to generate logs/metrics.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PostFilterPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">PostFilter</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodes</span> <span class="p">[]</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">filteredNodesStatuses</span> <span class="nx">NodeToStatusMap</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// ScorePlugin is an interface that must be implemented by &#34;score&#34; plugins to rank
</span><span class="c1">// nodes that passed the filtering phase.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ScorePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Score</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="o">*</span><span class="nx">Status</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ScoreWithNormalizePlugin is an interface that must be implemented by &#34;score&#34;
</span><span class="c1">// plugins that also need to normalize the node scoring results produced by the same
</span><span class="c1">// plugin&#39;s &#34;Score&#34; method.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ScoreWithNormalizePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">ScorePlugin</span>
	<span class="nf">NormalizeScore</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">scores</span> <span class="nx">NodeScoreList</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// ReservePlugin is an interface for Reserve plugins. These plugins are called
</span><span class="c1">// at the reservation point. These are meant to update the state of the plugin.
</span><span class="c1">// This concept used to be called &#39;assume&#39; in the original scheduler.
</span><span class="c1">// These plugins should return only Success or Error in Status.code. However,
</span><span class="c1">// the scheduler accepts other valid codes as well. Anything other than Success
</span><span class="c1">// will lead to rejection of the pod.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ReservePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Reserve</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// PreBindPlugin is an interface that must be implemented by &#34;prebind&#34; plugins.
</span><span class="c1">// These plugins are called before a pod being scheduled.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PreBindPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">PreBind</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>

<span class="c1">// PostBindPlugin is an interface that must be implemented by &#34;postbind&#34; plugins.
</span><span class="c1">// These plugins are called after a pod is successfully bound to a node.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PostBindPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">PostBind</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// UnreservePlugin is an interface for Unreserve plugins. This is an informational
</span><span class="c1">// extension point. If a pod was reserved and then rejected in a later phase, then
</span><span class="c1">// un-reserve plugins will be notified. Un-reserve plugins should clean up state
</span><span class="c1">// associated with the reserved Pod.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">UnreservePlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Unreserve</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// PermitPlugin is an interface that must be implemented by &#34;permit&#34; plugins.
</span><span class="c1">// These plugins are called before a pod is bound to a node.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PermitPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Permit</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// BindPlugin is an interface that must be implemented by &#34;bind&#34; plugins. Bind
</span><span class="c1">// plugins are used to bind a pod to a Node.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">BindPlugin</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">Plugin</span>
	<span class="nf">Bind</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Status</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For enabling or disabling the scheduling framework plugin, we can also use the <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#">KubeSchedulerConfiguration</a> resource object above. KubeSchedulerConfiguration) resource object to configure it. The configuration in the following example enables a plugin that implements the <code>reserve</code> and <code>preBind</code> extension points, and disables another plugin, and provides some configuration information for the plugin foo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">plugins</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">reserve</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">baz</span><span class="w">
</span><span class="w">  </span><span class="nt">preBind</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">baz</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">pluginConfig</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">foo插件可以解析的任意内容</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The order in which extensions are called is as follows.</p>
<ul>
<li>If no corresponding extension is configured for an extension point, the scheduling framework will use the extension from the default plugin</li>
<li>If an extension is configured and activated for an extension point, the scheduling framework will call the extension from the default plugin first, and then the configured extension</li>
<li>The extensions of the default plugin are always called first, and then the extensions of the extension points are called one by one in the order of their activation <code>enabled</code> in <code>KubeSchedulerConfiguration</code>.</li>
<li>You can disable the extensions of the default plugin and then activate the extensions of the default plugin somewhere in the <code>enabled</code> list, which changes the order in which the extensions of the default plugin are called</li>
</ul>
<p>Suppose the default plugin foo implements the <code>reserve</code> extension point, and we want to add a plugin bar, which we want to be called before foo, then we should disable foo first and then activate bar foo in the same order. An example configuration is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubescheduler.config.k8s.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeSchedulerConfiguration</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">plugins</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">reserve</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>In the source code directory <code>pkg/scheduler/framework/plugins/examples</code> there are several demonstration plugins that we can refer to for their implementation.</p>
<h4 id="example-1">example</h4>
<p>In fact, it is not difficult to implement a scheduler framework plugin, we just need to implement the corresponding extension points and then register the plugin to the scheduler, the following is the plugin registered by the default scheduler at initialization time: <code>pkg/scheduler/framework/plugins/examples</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewRegistry</span><span class="p">()</span> <span class="nx">Registry</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">Registry</span><span class="p">{</span>
		<span class="c1">// FactoryMap:
</span><span class="c1"></span>		<span class="c1">// New plugins are registered here.
</span><span class="c1"></span>		<span class="c1">// example:
</span><span class="c1"></span>		<span class="c1">// {
</span><span class="c1"></span>		<span class="c1">//  stateful_plugin.Name: stateful.NewStatefulMultipointExample,
</span><span class="c1"></span>		<span class="c1">//  fooplugin.Name: fooplugin.New,
</span><span class="c1"></span>		<span class="c1">// }
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>But as you can see there are no plugins registered by default, so to make the scheduler recognize our plugin code, we need to implement a scheduler ourselves, but of course we don&rsquo;t need to implement this scheduler at all. In the <code>kube-scheduler</code> source file <code>kubernetes/cmd/kube-scheduler/app/server.go</code> there is a <code>NewSchedulerCommand</code> entry function with a list of arguments of type <code>Option</code>, and this <code>Option </code> happens to be the definition of a plugin configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Option configures a framework.Registry.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">func</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Registry</span><span class="p">)</span> <span class="kt">error</span>

<span class="c1">// NewSchedulerCommand creates a *cobra.Command object with default parameters and registryOptions
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSchedulerCommand</span><span class="p">(</span><span class="nx">registryOptions</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
  <span class="o">......</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>So we can call this function directly as our function entry and pass in our own plug-in as an argument, and there is a function named <code>WithPlugin</code> under the file to create an <code>Option</code> instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WithPlugin creates an Option based on plugin name and factory.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">WithPlugin</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">factory</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">PluginFactory</span><span class="p">)</span> <span class="nx">Option</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">registry</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">Registry</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">registry</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>So we end up with the following entry function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UTC</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">())</span>

	<span class="nx">command</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewSchedulerCommand</span><span class="p">(</span>
		<span class="nx">app</span><span class="p">.</span><span class="nf">WithPlugin</span><span class="p">(</span><span class="nx">sample</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">sample</span><span class="p">.</span><span class="nx">New</span><span class="p">),</span> 
	<span class="p">)</span>

	<span class="nx">logs</span><span class="p">.</span><span class="nf">InitLogs</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">logs</span><span class="p">.</span><span class="nf">FlushLogs</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">command</span><span class="p">.</span><span class="nf">Execute</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>WithPlugin(sample.Name, sample.New)</code> is the next plug-in we want to implement, from the <code>WithPlugin</code> function parameters can also see that we here <code>sample.New</code> must be a <code>framework.PluginFactory</code> type value and the definition of <code>PluginFactory</code> is a function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">PluginFactory</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">configuration</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Unknown</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">FrameworkHandle</span><span class="p">)</span> <span class="p">(</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>So <code>sample.New</code> is actually the above function, in this function we can get some data in the plug-in and then logical processing can be done, plug-in implementation is shown below, we just simply get the data here to print the log, if you have the actual needs of the data can be processed on the basis of the acquisition, we just implement the <code>PreFilter </code>, <code>Filter</code>, <code>PreBind</code> three extension points, the other can be extended in the same way can be.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 插件名称
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;sample-plugin&#34;</span>

<span class="kd">type</span> <span class="nx">Args</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">FavoriteColor</span>  <span class="kt">string</span> <span class="s">`json:&#34;favorite_color,omitempty&#34;`</span>
	<span class="nx">FavoriteNumber</span> <span class="kt">int</span>    <span class="s">`json:&#34;favorite_number,omitempty&#34;`</span>
	<span class="nx">ThanksTo</span>       <span class="kt">string</span> <span class="s">`json:&#34;thanks_to,omitempty&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Sample</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">args</span>   <span class="o">*</span><span class="nx">Args</span>
	<span class="nx">handle</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">FrameworkHandle</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sample</span><span class="p">)</span> <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">Name</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sample</span><span class="p">)</span> <span class="nf">PreFilter</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Status</span> <span class="p">{</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;prefilter pod: %v&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sample</span><span class="p">)</span> <span class="nf">Filter</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Status</span> <span class="p">{</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;filter pod: %v, node: %v&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sample</span><span class="p">)</span> <span class="nf">PreBind</span><span class="p">(</span><span class="nx">pc</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">PluginContext</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Status</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">nodeInfo</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">NodeInfoSnapshot</span><span class="p">().</span><span class="nx">NodeInfoMap</span><span class="p">[</span><span class="nx">nodeName</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Error</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;prebind get node info error: %+v&#34;</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">))</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;prebind node info: %+v&#34;</span><span class="p">,</span> <span class="nx">nodeInfo</span><span class="p">.</span><span class="nf">Node</span><span class="p">())</span>
		<span class="k">return</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">NewStatus</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">configuration</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Unknown</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">framework</span><span class="p">.</span><span class="nx">FrameworkHandle</span><span class="p">)</span> <span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Args</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">framework</span><span class="p">.</span><span class="nf">DecodeInto</span><span class="p">(</span><span class="nx">configuration</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;get plugin config args: %+v&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Sample</span><span class="p">{</span>
		<span class="nx">args</span><span class="p">:</span> <span class="nx">args</span><span class="p">,</span>
		<span class="nx">handle</span><span class="p">:</span> <span class="nx">f</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>The full code can be obtained from the repository <a href="https://github.com/cnych/sample-scheduler-framework">https://github.com/cnych/sample-scheduler-framework</a>.</p>
</blockquote>
<p>After the implementation is complete, we can compile and package it into an image, and then we can deploy it as a normal application with a <code>Deployment</code> controller. KubeSchedulerConfiguration<code>resource object configuration, you can enable or disable our plugins via</code>plugins<code>, and you can pass some parameter values to the plugins via </code>pluginConfig`.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-clusterrole</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">endpoints</span><span class="w">
</span><span class="w">      </span>- <span class="l">events</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">create</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">update</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">nodes</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">pods</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">delete</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">      </span>- <span class="l">update</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">bindings</span><span class="w">
</span><span class="w">      </span>- <span class="l">pods/binding</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">create</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">pods/status</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">patch</span><span class="w">
</span><span class="w">      </span>- <span class="l">update</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">replicationcontrollers</span><span class="w">
</span><span class="w">      </span>- <span class="l">services</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">apps</span><span class="w">
</span><span class="w">      </span>- <span class="l">extensions</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">replicasets</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">apps</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">statefulsets</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">policy</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">poddisruptionbudgets</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">persistentvolumeclaims</span><span class="w">
</span><span class="w">      </span>- <span class="l">persistentvolumes</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">configmaps</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;storage.k8s.io&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">storageclasses</span><span class="w">
</span><span class="w">      </span>- <span class="l">csinodes</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;coordination.k8s.io&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">leases</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">create</span><span class="w">
</span><span class="w">      </span>- <span class="l">get</span><span class="w">
</span><span class="w">      </span>- <span class="l">list</span><span class="w">
</span><span class="w">      </span>- <span class="l">update</span><span class="w">
</span><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;events.k8s.io&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">events</span><span class="w">
</span><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">create</span><span class="w">
</span><span class="w">      </span>- <span class="l">patch</span><span class="w">
</span><span class="w">      </span>- <span class="l">update</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-sa</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-clusterrolebinding</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-clusterrole</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-sa</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler-config</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scheduler-config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    apiVersion: kubescheduler.config.k8s.io/v1alpha1
</span><span class="sd">    kind: KubeSchedulerConfiguration
</span><span class="sd">    schedulerName: sample-scheduler
</span><span class="sd">    leaderElection:
</span><span class="sd">      leaderElect: true
</span><span class="sd">      lockObjectName: sample-scheduler
</span><span class="sd">      lockObjectNamespace: kube-system
</span><span class="sd">    plugins:
</span><span class="sd">      preFilter:
</span><span class="sd">        enabled:
</span><span class="sd">        - name: &#34;sample-plugin&#34;
</span><span class="sd">      filter:
</span><span class="sd">        enabled:
</span><span class="sd">        - name: &#34;sample-plugin&#34;
</span><span class="sd">      preBind:
</span><span class="sd">        enabled:
</span><span class="sd">        - name: &#34;sample-plugin&#34;
</span><span class="sd">    pluginConfig:
</span><span class="sd">    - name: &#34;sample-plugin&#34;
</span><span class="sd">      args:
</span><span class="sd">        favorite_color: &#34;#326CE5&#34;
</span><span class="sd">        favorite_number: 7
</span><span class="sd">        thanks_to: &#34;thockin&#34;</span><span class="w">    
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler-sa</span><span class="w">
</span><span class="w">      </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="l">system-cluster-critical</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler-config</span><span class="w">
</span><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler-config</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler-ctrl</span><span class="w">
</span><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">cnych/sample-scheduler:v0.1.6</span><span class="w">
</span><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">sample-scheduler-framework</span><span class="w">
</span><span class="w">            </span>- --<span class="l">config=/etc/kubernetes/scheduler-config.yaml</span><span class="w">
</span><span class="w">            </span>- --<span class="l">v=3</span><span class="w">
</span><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scheduler-config</span><span class="w">
</span><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>By deploying the above resource object directly, we have deployed a scheduler called <code>sample-scheduler</code>, and we can deploy an application to use this scheduler for scheduling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-scheduler</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">test-scheduler</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">test-scheduler</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l">sample-scheduler</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>For enabling or disabling the scheduling framework plugin, we can also use the <a href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#">KubeSchedulerConfiguration</a> resource object above.</p>
<p>Let&rsquo;s create this resource object directly and check the logging information of our custom scheduler after it is created.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get pods -n kube-system -l <span class="nv">component</span><span class="o">=</span>sample-scheduler
NAME                               READY   STATUS    RESTARTS   AGE
sample-scheduler-7c469787f-rwhhd   1/1     Running   <span class="m">0</span>          13m
$ kubectl logs -f sample-scheduler-7c469787f-rwhhd -n kube-system
I0104 08:24:22.087881       <span class="m">1</span> scheduler.go:530<span class="o">]</span> Attempting to schedule pod: default/test-scheduler-6d779d9465-rq2bb
I0104 08:24:22.087992       <span class="m">1</span> plugins.go:23<span class="o">]</span> prefilter pod: test-scheduler-6d779d9465-rq2bb
I0104 08:24:22.088657       <span class="m">1</span> plugins.go:28<span class="o">]</span> filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node1
I0104 08:24:22.088797       <span class="m">1</span> plugins.go:28<span class="o">]</span> filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node2
I0104 08:24:22.088871       <span class="m">1</span> plugins.go:28<span class="o">]</span> filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node3
I0104 08:24:22.088946       <span class="m">1</span> plugins.go:28<span class="o">]</span> filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node4
I0104 08:24:22.088992       <span class="m">1</span> plugins.go:28<span class="o">]</span> filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-master
I0104 08:24:22.090653       <span class="m">1</span> plugins.go:36<span class="o">]</span> prebind node info: <span class="p">&amp;</span>Node<span class="o">{</span>ObjectMeta:<span class="o">{</span>ydzs-node3   /api/v1/nodes/ydzs-node3 1ff6e228-4d98-4737-b6d3-30a5d55ccdc2 <span class="m">15466372</span> <span class="m">0</span> 2019-11-10 09:05:09 +0000 UTC &lt;nil&gt; &lt;nil&gt; ......<span class="o">}</span>
I0104 08:24:22.091761       <span class="m">1</span> factory.go:610<span class="o">]</span> Attempting to <span class="nb">bind</span> test-scheduler-6d779d9465-rq2bb to ydzs-node3
I0104 08:24:22.104994       <span class="m">1</span> scheduler.go:667<span class="o">]</span> pod default/test-scheduler-6d779d9465-rq2bb is bound successfully on node <span class="s2">&#34;ydzs-node3&#34;</span>, <span class="m">5</span> nodes evaluated, <span class="m">4</span> nodes were found feasible. Bound node resource: <span class="s2">&#34;Capacity: CPU&lt;4&gt;|Memory&lt;8008820Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;17921Mi&gt;; Allocatable: CPU&lt;4&gt;|Memory&lt;7906420Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;16912377419&gt;.&#34;</span>.
</code></pre></td></tr></table>
</div>
</div><p>You can see that after we create the Pod, the corresponding logs appear in our custom scheduler and above the extension points we defined, proving the success of our example, which can also be verified by looking at the Pod&rsquo;s <code>schedulerName</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get pods
NAME                                      READY   STATUS    RESTARTS   AGE
test-scheduler-6d779d9465-rq2bb           1/1     Running   <span class="m">0</span>          22m
$ kubectl get pod test-scheduler-6d779d9465-rq2bb -o yaml
......
restartPolicy: Always
schedulerName: sample-scheduler
securityContext: <span class="o">{}</span>
serviceAccount: default
......
</code></pre></td></tr></table>
</div>
</div><p>In the latest version of Kubernetes v1.17, the Scheduler Framework built-in preselection and preference functions have all been plugged in, so to extend the scheduler we should master and understand the scheduling framework in this way.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/google-log4j/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Google Announces Results of Log4j 2 &#34;Vulnerability&#34; Investigation: Not Affected|Google Workspace Core Service Does Not Use Log4j 2</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/url-rewrite-on-traefik2/">
            <span class="next-text nav-default">Use of URL Rewrite in Traefik version 2.X</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
