<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>NET 6 What&#39;s New -- High Performance Logging - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="If you mention logging in .NET, you will definitely think of ILogger, which is a common way to provide logging in .NET. The following code is the code for the initialization of the .NET Core WebAPI project, which uses ILogger to provide logging Logging. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private readonly ILogger&amp;lt;WeatherForecastController&amp;gt; _logger; public WeatherForecastController(ILogger&amp;lt;WeatherForecastController&amp;gt; logger) { _logger" /><meta name="keywords" content=".net 6, Logging" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/dotnet6-logging/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="NET 6 What&#39;s New -- High Performance Logging" />
<meta property="og:description" content="If you mention logging in .NET, you will definitely think of ILogger, which is a common way to provide logging in .NET. The following code is the code for the initialization of the .NET Core WebAPI project, which uses ILogger to provide logging Logging. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private readonly ILogger&lt;WeatherForecastController&gt; _logger; public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger) { _logger" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/dotnet6-logging/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-19T15:40:12+08:00" />
<meta property="article:modified_time" content="2021-12-19T15:40:12+08:00" />

<meta itemprop="name" content="NET 6 What&#39;s New -- High Performance Logging">
<meta itemprop="description" content="If you mention logging in .NET, you will definitely think of ILogger, which is a common way to provide logging in .NET. The following code is the code for the initialization of the .NET Core WebAPI project, which uses ILogger to provide logging Logging. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private readonly ILogger&lt;WeatherForecastController&gt; _logger; public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger) { _logger"><meta itemprop="datePublished" content="2021-12-19T15:40:12+08:00" />
<meta itemprop="dateModified" content="2021-12-19T15:40:12+08:00" />
<meta itemprop="wordCount" content="503">
<meta itemprop="keywords" content=".net," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NET 6 What&#39;s New -- High Performance Logging"/>
<meta name="twitter:description" content="If you mention logging in .NET, you will definitely think of ILogger, which is a common way to provide logging in .NET. The following code is the code for the initialization of the .NET Core WebAPI project, which uses ILogger to provide logging Logging. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private readonly ILogger&lt;WeatherForecastController&gt; _logger; public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger) { _logger"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">NET 6 What&#39;s New -- High Performance Logging</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-19 15:40:12 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 503 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>If you mention logging in <code>.NET</code>, you will definitely think of ILogger, which is a common way to provide logging in <code>.NET</code>. The following code is the code for the initialization of the .NET Core WebAPI project, which uses ILogger to provide logging Logging.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">private readonly ILogger&lt;WeatherForecastController&gt; _logger;
public WeatherForecastController(ILogger&lt;WeatherForecastController&gt; logger)
{
    _logger = logger;
}
[HttpGet(Name = &#34;GetWeatherForecast&#34;)]
public IEnumerable&lt;WeatherForecast&gt; Get()
{ 
    var result =  Enumerable.Range(1, 5).Select(index =&gt; new WeatherForecast
    {
        TemperatureC = Random.Shared.Next(-20, 55),
    })
    .ToArray();
    _logger.LogInformation(&#34;LogInformation: {0}&#34;, JsonSerializer.Serialize(result));
    return result;
}

</code></pre></td></tr></table>
</div>
</div><p>NET6 Microsoft provides us with a high-performance logging class <strong>LoggerMessage</strong>. Compared to the ILogger logger and its extension methods, LoggerMessage has performance advantages. First, the ILogger logger extension methods require value type conversion to object, but LoggerMessage uses static methods with strongly typed parameters and extension methods to avoid this problem. Also, the ILogger logger and its extension methods must first parse the message template each time the log is written, but LoggerMessage only needs to parse the template once if the message template is already defined. The code used is as follows (modifying the WebAPI project initialization code)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">private static readonly Action&lt;ILogger, IEnumerable&lt;WeatherForecast&gt;, Exception?&gt; _logWeatherForecast =
    LoggerMessage.Define&lt;IEnumerable&lt;WeatherForecast&gt;&gt;(
        logLevel: LogLevel.Information,
        eventId: 0,
        formatString: &#34;LoggerMessage: {aa}&#34;);
_logWeatherForecast(_logger, result, null);

</code></pre></td></tr></table>
</div>
</div><p>Although LoggerMessage provides us with better performance logging, it requires a lot of manual writing of LoggerMessage.Define code, and the parameter placeholders in the formatString message template are not controlled in any way, which may lead to incorrect passing of parameters. NET 6 Microsoft provides Source Generator to help us automatically generate high-performance logging code. It is very simple to use, first you need to create <strong>partial</strong> method and second declare <strong>LoggerMessageAttribute</strong> attribute in the partial method header. The code used is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[LoggerMessage(0, LogLevel.Information, &#34;LoggerMessageAttribute: {weatherForecasts}&#34;)]
partial void LogWeatherForecast(IEnumerable&lt;WeatherForecast&gt; weatherForecasts);
//使用
LogWeatherForecast(result);

</code></pre></td></tr></table>
</div>
</div><p>Once compiled, LoggerMessage automatically generates the code for us.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">partial class WeatherForecastController 
{
[global::System.CodeDom.Compiler.GeneratedCodeAttribute(&#34;Microsoft.Extensions.Logging.Generators&#34;, &#34;6.0.5.2210&#34;)]
    private static readonly global::System.Action&lt;global::Microsoft.Extensions.Logging.ILogger, global::System.Collections.Generic.IEnumerable&lt;global::WebApplication1.WeatherForecast&gt;, global::System.Exception?&gt; __LogWeatherForecastCallback =
        global::Microsoft.Extensions.Logging.LoggerMessage.Define&lt;global::System.Collections.Generic.IEnumerable&lt;global::WebApplication1.WeatherForecast&gt;&gt;(global::Microsoft.Extensions.Logging.LogLevel.Information, new global::Microsoft.Extensions.Logging.EventId(0, nameof(LogWeatherForecast)), &#34;LoggerMessageAttribute: {weatherForecasts}&#34;, new global::Microsoft.Extensions.Logging.LogDefineOptions() { SkipEnabledCheck = true });     [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&#34;Microsoft.Extensions.Logging.Generators&#34;, &#34;6.0.5.2210&#34;)]
    partial void LogWeatherForecast(global::System.Collections.Generic.IEnumerable&lt;global::WebApplication1.WeatherForecast&gt; weatherForecasts)
    {
        if (_logger.IsEnabled(global::Microsoft.Extensions.Logging.LogLevel.Information))
        {
            __LogWeatherForecastCallback(_logger, weatherForecasts, null);
        }
    }
}

</code></pre></td></tr></table>
</div>
</div><p>In the above code, the LogWeatherForecast method directly uses the <code>_logger</code> object declared in the Controller without us passing it in, and also determines _logger.IsEnabled before writing logs, which avoids unnecessary log writing and further improves performance. While using LoggerMessageAttribute can improve logging performance, it also has its disadvantages.</p>
<ol>
<li>using partial method declarations requires that the class also be defined as partial.
2.Logging uses the ToString() method of the parameter object, and for complex types you cannot pass a serialized object into the method LogWeatherForecast(JsonSerializer.Serialize(result)) because it will always be executed and affect the performance, but you can define it as a record class or Custom ToString() method workaround.</li>
</ol>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/.net/">.net</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/serverless/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">With high hopes for Serverless, have the controversies and issues been resolved?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/debian-git-http-nginx/">
            <span class="next-text nav-default">How to Install an HTTP Git Server on Debian 11 Using Nginx</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
