<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Agrona - High performance data structure tool library - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Agrona  is a Java toolkit developed by real-logic that provides a number of high-performance data structures and tooling methods, mainly including.
 Buffers - Thread safe direct and atomic buffers for working with on and off heap memory with memory ordering semantics. Lists - Array backed lists of int/long primitives to avoid boxing. Maps - Open addressing and linear probing with int/long primitive keys to object reference values. Maps - Open addressing and linear probing with int/long primitive keys to int/long values." /><meta name="keywords" content="agrona" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/agrona/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Agrona - High performance data structure tool library" />
<meta property="og:description" content="Agrona  is a Java toolkit developed by real-logic that provides a number of high-performance data structures and tooling methods, mainly including.
 Buffers - Thread safe direct and atomic buffers for working with on and off heap memory with memory ordering semantics. Lists - Array backed lists of int/long primitives to avoid boxing. Maps - Open addressing and linear probing with int/long primitive keys to object reference values. Maps - Open addressing and linear probing with int/long primitive keys to int/long values." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/agrona/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-03T16:16:35+08:00" />
<meta property="article:modified_time" content="2021-12-03T16:16:35+08:00" />

<meta itemprop="name" content="Agrona - High performance data structure tool library">
<meta itemprop="description" content="Agrona  is a Java toolkit developed by real-logic that provides a number of high-performance data structures and tooling methods, mainly including.
 Buffers - Thread safe direct and atomic buffers for working with on and off heap memory with memory ordering semantics. Lists - Array backed lists of int/long primitives to avoid boxing. Maps - Open addressing and linear probing with int/long primitive keys to object reference values. Maps - Open addressing and linear probing with int/long primitive keys to int/long values."><meta itemprop="datePublished" content="2021-12-03T16:16:35+08:00" />
<meta itemprop="dateModified" content="2021-12-03T16:16:35+08:00" />
<meta itemprop="wordCount" content="2504">
<meta itemprop="keywords" content="agrona," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Agrona - High performance data structure tool library"/>
<meta name="twitter:description" content="Agrona  is a Java toolkit developed by real-logic that provides a number of high-performance data structures and tooling methods, mainly including.
 Buffers - Thread safe direct and atomic buffers for working with on and off heap memory with memory ordering semantics. Lists - Array backed lists of int/long primitives to avoid boxing. Maps - Open addressing and linear probing with int/long primitive keys to object reference values. Maps - Open addressing and linear probing with int/long primitive keys to int/long values."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Agrona - High performance data structure tool library</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-03 16:16:35 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2504 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#i-agents">I. Agents</a>
          <ul>
            <li><a href="#11-duty-cycle">1.1 Duty Cycle</a></li>
            <li><a href="#12-agent">1.2 Agent</a></li>
            <li><a href="#13-idle-strategies">1.3 Idle Strategies</a></li>
            <li><a href="#14-agent-runner">1.4 Agent Runner</a></li>
            <li><a href="#15-agent-invoker">1.5 Agent Invoker</a></li>
          </ul>
        </li>
        <li><a href="#ii-clocks">II. Clocks</a></li>
        <li><a href="#iii-ringbuffer">III. RingBuffer</a>
          <ul>
            <li><a href="#31-onetooneringbuffer">3.1 OneToOneRingBuffer</a></li>
            <li><a href="#32-manytooneringbuffer">3.2 ManyToOneRingBuffer</a></li>
            <li><a href="#33-broadcast">3.3 Broadcast</a></li>
          </ul>
        </li>
        <li><a href="#iv-data-structures">IV. Data Structures</a>
          <ul>
            <li><a href="#41-hashmaps">4.1 HashMaps</a></li>
            <li><a href="#42-caches">4.2 Caches</a></li>
            <li><a href="#43-hashsets">4.3 HashSets</a></li>
          </ul>
        </li>
        <li><a href="#v-direct-buffer">V. Direct Buffer</a>
          <ul>
            <li><a href="#51-key-concepts">5.1 Key Concepts</a></li>
            <li><a href="#52-working-with-types">5.2 Working with Types</a></li>
          </ul>
        </li>
        <li><a href="#vi-idgenerator">VI. IdGenerator</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://github.com/real-logic/agrona"> <code>Agrona</code> </a> is a Java toolkit developed by <a href="https://real-logic.co.uk/">real-logic</a> that provides a number of high-performance data structures and tooling methods, mainly including.</p>
<ul>
<li>Buffers - Thread safe direct and atomic buffers for working with on and off heap memory with memory ordering semantics.</li>
<li>Lists - Array backed lists of int/long primitives to avoid boxing.</li>
<li>Maps - Open addressing and linear probing with int/long primitive keys to object reference values.</li>
<li>Maps - Open addressing and linear probing with int/long primitive keys to int/long values.</li>
<li>Sets - Open addressing and linear probing for int/long primitives and object references.</li>
<li>Cache - Set Associative with int/long primitive keys to object reference values.</li>
<li>Clocks - Clock implementations to abstract system clocks, allow caching, and enable testing.</li>
<li>Queues - Lock-less implementations for low-latency applications.</li>
<li>Ring/Broadcast Buffers - implemented off-heap for IPC communication.</li>
<li>Simple Agent framework for concurrent services.</li>
<li>Signal handling to support &ldquo;Ctrl + c&rdquo; in a server application.</li>
<li>Scalable Timer Wheel - For scheduling timers at a given deadline with O(1) register and cancel time.</li>
<li>Code generation from annotated implementations specialised for primitive types.</li>
<li>Off-heap counters implementation for application telemetry, position tracking, and coordination.</li>
<li>Implementations of InputStream and OutputStream that can wrap direct buffers.</li>
<li>DistinctErrorLog - A log of distinct errors to avoid filling disks with existing logging approaches.</li>
<li>IdGenerator - Concurrent and distributed unique id generator employing a lock-less implementation of the Twitter Snowflake algorithm.</li>
</ul>
<h2 id="i-agents">I. Agents</h2>
<h3 id="11-duty-cycle">1.1 Duty Cycle</h3>
<p><code>Duty Cycle</code> is a programming model, it is a dead loop program, in the loop, to execute a certain logic, and according to the result of the execution to decide whether to wait a while for the next cycle. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">doLogic</span><span class="o">();</span>
    <span class="n">doIdleStrategies</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="12-agent">1.2 Agent</h3>
<p>In Agrona, <code>Agents</code> are defined.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Agent</span> <span class="o">{</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="nf">doWork</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="k">default</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="nf">roleName</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>doWork()</code>, which is used to handle the business logic, returns a value that determines whether to execute the idle policy in Agrona.</p>
<ul>
<li>When the return value is greater than 0, the idle policy is not triggered and Agrona executes the next <code>doWork()</code> immediately</li>
<li>When the return value is less than or equal to 0, the specified idle policy is executed</li>
</ul>
<p>In addition, <code>onStart()</code> and <code>onClose()</code> serve as callback hook methods when the Agent is started and closed, and <code>roleName()</code> asserts the name of the Agent.</p>
<h3 id="13-idle-strategies">1.3 Idle Strategies</h3>
<p>Agrona natively provides a number of idle strategies.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Implementation Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>SleepingIdleStrategy</td>
<td>Based on parkNanos for thread suspension</td>
</tr>
<tr>
<td>SleepingMillisIdleStrategy</td>
<td>Based on thread.sleep for local development on low-configuration machines or development with a large number of processes</td>
</tr>
<tr>
<td>YieldingIdleStrategy</td>
<td>Gives control over threads using thread.yield</td>
</tr>
<tr>
<td>BackoffIdleStrategy</td>
<td>An aggressive strategy that uses spinning followed by yield (Thread.yield()) and then parkNanos at the configured time, which is the default strategy for Aeron Cluster</td>
</tr>
<tr>
<td>NoOpIdleStrategy</td>
<td>the most aggressive policy, no processing</td>
</tr>
<tr>
<td>BusySpinIdleStrategy</td>
<td>For Java 9 and above, Thread.onSpinWait() will be used. This provides a hint to the CPU that the thread is in a tight loop but busy waiting for something, and then the CPU may allocate additional resources to another thread without involving the OS scheduler.</td>
</tr>
</tbody>
</table>
<p>If you need to customize the idle strategy, you only need to implement the <code>IdleStrategy</code> interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IdleStrategy</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">idle</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">idle</span><span class="o">();</span>
    <span class="kt">void</span> <span class="nf">reset</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>The idle policy above does not necessarily guarantee thread safety, so it is recommended that each Agent use a separate idle policy.</p>
</blockquote>
<h3 id="14-agent-runner">1.4 Agent Runner</h3>
<p>The <code>Agent Runner</code> is responsible for combining and running the Agent and Idle Strategies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">AgentRunner</span> <span class="n">runner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AgentRunner</span><span class="o">(</span><span class="n">idleStrategy</span><span class="o">,</span> <span class="n">errorHandler</span><span class="o">,</span> <span class="n">errorCounter</span><span class="o">,</span> <span class="n">agent</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Above is the constructor of AgentRunner, where</p>
<table>
<thead>
<tr>
<th>parameters</th>
<th>meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>idleStrategy</td>
<td>IdleStrategy instance object</td>
</tr>
<tr>
<td>errorHandler</td>
<td>The callback handler when an exception occurs during the Agent&rsquo;s execution</td>
</tr>
<tr>
<td>errorCounter</td>
<td>Records the number of exceptions that occurred during the Agent&rsquo;s execution</td>
</tr>
<tr>
<td>agent</td>
<td>Agent instance object</td>
</tr>
</tbody>
</table>
<p>After getting the AgentRunner object, Agrona provides the following three ways to actually start it.</p>
<ol>
<li><code>AgentRunner#startOnThread(AgentRunner)</code> , which will create a thread to run after execution</li>
<li><code>AgentRunner#startOnThread(AgentRunner, ThreadFactory)</code>, which will create a separate thread using the specified threadFactory</li>
<li>form a <code>CompositeAgent</code> with multiple Agents and call the above two methods, these Agents will share a common thread to run</li>
</ol>
<h3 id="15-agent-invoker">1.5 Agent Invoker</h3>
<p>If we want to control the Agent manually, Agrona provides the <code>AgentInvoker</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">AgentInvoker</span> <span class="n">agentInvoker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AgentInvoker</span><span class="o">(</span><span class="n">errorHandle</span><span class="o">,</span> <span class="n">errorCounter</span><span class="o">,</span> <span class="n">agent</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see that the constructor method removes the idle policy compared to AgentRunner, because it is the Agent that needs to be executed manually, so this parameter is not needed.</p>
<h2 id="ii-clocks">II. Clocks</h2>
<p>Agrone provides its own Clock API, first of all it is based on Epoch Time, which is the time difference since 1970-1-1 00:00:00.000 until now. The top-level interface is <code>EpochClock</code> and there are two implementations: <code>SystemEpochClock</code> and <code>CachedEpochClock</code>.</p>
<p>For <code>SystemEpochClock</code>, the millisecond time difference is returned, which is actually a wrapper around <code>System.currentTimeMillis()</code>, providing a static instance for the operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">EpochClock</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">SystemEpochClock</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
<span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="na">time</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>For <code>CachedEpochClock</code>, which is actually a cache, there are several methods.</p>
<ul>
<li><em>update(long timeMs)</em> sets the timeMs directly to the cache</li>
<li><em>advance(long timeMs)</em> adds timeMs to the cache on top of the original value</li>
<li><em>time()</em> Get the result of the cached value</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">CachedEpochClock</span> <span class="n">clock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachedEpochClock</span><span class="o">();</span>
<span class="n">clock</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">1L</span><span class="o">);</span>

<span class="n">assertEquals</span><span class="o">(</span><span class="n">1L</span><span class="o">,</span> <span class="n">clock</span><span class="o">.</span><span class="na">time</span><span class="o">());</span>

<span class="n">clock</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">2L</span><span class="o">);</span>
<span class="n">assertEquals</span><span class="o">(</span><span class="n">2L</span><span class="o">,</span> <span class="n">clock</span><span class="o">.</span><span class="na">time</span><span class="o">());</span>

<span class="n">clock</span><span class="o">.</span><span class="na">advance</span><span class="o">(</span><span class="n">98L</span><span class="o">);</span>
<span class="n">assertEquals</span><span class="o">(</span><span class="n">100L</span><span class="o">,</span> <span class="n">clock</span><span class="o">.</span><span class="na">time</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition, Agrone also provides microsecond and nanosecond APIs:</p>
<ul>
<li><code>SystemEpochMicroClock</code> based on the <code>java.time.Instant</code> API implementation</li>
<li><code>SystemEpochNanoClock</code> is based on the <code>java.time.Instant</code> API implementation</li>
<li><code>OffsetEpochNanoClock</code> calls the <code>System.nanoTime()</code> API in a timed sampling fashion, allowing you to adjust the sampling interval and parameters as needed</li>
</ul>
<h2 id="iii-ringbuffer">III. RingBuffer</h2>
<p>The author of <code>Aeron</code> developed <a href="https://github.com/LMAX-Exchange/disruptor">disruptor</a> during his tenure at LMAX. In Agrona, the authors also provide support for this data structure.</p>
<h3 id="31-onetooneringbuffer">3.1 OneToOneRingBuffer</h3>
<p>For single-producer-single-consumer scenarios, unlike the RingBuffer in Disruptor, an additional <code>RingBufferDescriptor.TRAILER_LENGTH</code> is required to define the RingBuffer size, and the <code>ByteBuffer</code> API determines whether the buffer is allocated inside or outside the heap.</p>
<p>The following code shows the creation of a OneToOneRingBuffer of size 4096, using an off-heap allocation buffer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">int</span> <span class="n">bufferLength</span> <span class="o">=</span> <span class="n">4096</span> <span class="o">+</span> <span class="n">RingBufferDescriptor</span><span class="o">.</span><span class="na">TRAILER_LENGTH</span><span class="o">;</span>
<span class="kd">final</span> <span class="n">UnsafeBuffer</span> <span class="n">internalBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UnsafeBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">bufferLength</span><span class="o">));</span>
<span class="kd">final</span> <span class="n">OneToOneRingBuffer</span> <span class="n">ringBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OneToOneRingBuffer</span><span class="o">(</span><span class="n">internalBuffer</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="messagehandler">MessageHandler</h4>
<p>When consuming data, you need to implement the <code>MessageHandler</code> interface, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageCapture</span> <span class="kd">implements</span> <span class="n">MessageHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">receivedStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">msgTypeId</span><span class="o">,</span> <span class="n">MutableDirectBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">receivedStrings</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getStringWithoutLengthAscii</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">length</span><span class="o">));</span>
        <span class="n">count</span><span class="o">++;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Where the <code>msgType</code> field is the identifier of the message and will be stored in the message header. If this field is not used, it must be set to a value greater than 0.</p>
<h4 id="ringbufferwrite">RingBuffer#write</h4>
<p>When producing data, the RingBuffer&rsquo;s <code>write</code> method needs to be called, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//prepare some data
</span><span class="c1"></span><span class="kd">final</span> <span class="n">String</span> <span class="n">testString</span> <span class="o">=</span> <span class="s">&#34;0123456789&#34;</span><span class="o">;</span>

<span class="kd">final</span> <span class="n">UnsafeBuffer</span> <span class="n">toSend</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UnsafeBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">testString</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
<span class="n">toSend</span><span class="o">.</span><span class="na">putStringWithoutLengthAscii</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">testString</span><span class="o">);</span>

<span class="c1">//write the data
</span><span class="c1"></span><span class="kd">private</span> <span class="n">sentOk</span> <span class="o">=</span> <span class="n">ringBuffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">toSend</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">testString</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</code></pre></td></tr></table>
</div>
</div><p><code>sentOk</code> indicates whether the write was successful or not, and this can be used to perform a backpressure operation to prevent consumers from consuming it. ringBuffer provides the following two methods to show the current production and consumption.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//the current consumer position in the ring buffer
</span><span class="c1"></span><span class="n">ringBuffer</span><span class="o">.</span><span class="na">consumerPosition</span><span class="o">();</span>

<span class="c1">//the current producer position in the ring buffer
</span><span class="c1"></span><span class="n">ringBuffer</span><span class="o">.</span><span class="na">producerPosition</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="controlledmessagehandler">ControlledMessageHandler</h4>
<p>In addition to the MessageHandler interface <code>ControlledMessageHandler</code> can also implement the consumption of RingBuffer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ControlledMessageCapture</span> <span class="kd">implements</span> <span class="n">ControlledMessageHandler</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ControlledMessageHandler</span><span class="o">.</span><span class="na">Action</span> <span class="nf">onMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">msgTypeId</span><span class="o">,</span> <span class="n">MutableDirectBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">..</span><span class="na">do</span> <span class="n">something</span>
        <span class="k">return</span> <span class="n">Action</span><span class="o">.</span><span class="na">COMMIT</span><span class="o">;</span> <span class="c1">//or ABORT, BREAK OR CONTINUE as required.
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The difference is that the <code>onMessage()</code> method returns the `ControlledMessageHandler:</p>
<ul>
<li><em>ABORT</em> : This aborts the read operation for this message. It will be delivered again on next read</li>
<li><em>BREAK</em> : This stops further processing after the current message for this read.</li>
<li><em>COMMIT</em> : Continues processing, but commits at the current message.</li>
<li><em>CONTINUE</em> : Continues processing, committing at the end of the current batch (this is equivalent to the standard handler).</li>
</ul>
<h4 id="tryclaim">TryClaim</h4>
<p>When writing data, you can also use the <code>tryClaim()</code> method to manipulate the underlying RingBuffer data structure directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">claimIndex</span> <span class="o">=</span> <span class="n">ringBuffer</span><span class="o">.</span><span class="na">tryClaim</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">BYTES</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">claimIndex</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">AtomicBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ringBuffer</span><span class="o">.</span><span class="na">buffer</span><span class="o">();</span>
    <span class="n">buffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">claimIndex</span><span class="o">,</span> <span class="n">something</span><span class="o">);</span>
    <span class="n">ringBuffer</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">claimIndex</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</code></pre></td></tr></table>
</div>
</div><p>First, call <code>tryClaim()</code> to get the index that can be written, then get the underlying data structure of the RingBuffer, write data to it, and finally, call <code>commit</code> or <code>abort</code> to finish.</p>
<h3 id="32-manytooneringbuffer">3.2 ManyToOneRingBuffer</h3>
<p>The API is consistent with OneToOneRingBuffer and supports multi-producer scenarios.</p>
<h3 id="33-broadcast">3.3 Broadcast</h3>
<p>OneToOneRingBuffer and ManyToOneRingBuffer are both in single-consumer scenarios. If multiple consumers are needed, Agrona provides <code>BroadcastTransmitter</code> and <code>BroadcastReceiver</code>.</p>
<p>Note in particular that under Broadcast, messages are discarded if the sender is producing faster than the consumer can consume (no backpressure support).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">final</span> <span class="n">BroadcastTransmitter</span> <span class="n">transmitter</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="n">MutableDirectBuffer</span> <span class="n">msgBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExpandableArrayBuffer</span><span class="o">();</span>

<span class="kd">public</span> <span class="nf">SendAgent</span><span class="o">(</span><span class="kd">final</span> <span class="n">AtomicBuffer</span> <span class="n">buffer</span><span class="o">...)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">transmitter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastTransmitter</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">doWork</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">msgBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">lastSend</span><span class="o">);</span>
    <span class="n">transmitter</span><span class="o">.</span><span class="na">transmit</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">msgBuffer</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">BYTES</span><span class="o">);</span>
    <span class="o">...</span>
    <span class="n">lastSend</span><span class="o">++;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReceiveAgent</span> <span class="kd">implements</span> <span class="n">Agent</span><span class="o">,</span> <span class="n">MessageHandler</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BroadcastReceiver</span> <span class="n">broadcastReceiver</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CopyBroadcastReceiver</span> <span class="n">copyBroadcastReceiver</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReceiveAgent</span><span class="o">(</span><span class="kd">final</span> <span class="n">AtomicBuffer</span> <span class="n">atomicBuffer</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">broadcastReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="o">(</span><span class="n">atomicBuffer</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">copyBroadcastReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyBroadcastReceiver</span><span class="o">(</span><span class="n">broadcastReceiver</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">doWork</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">copyBroadcastReceiver</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">onMessage</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="kt">int</span> <span class="n">msgTypeId</span><span class="o">,</span> <span class="n">MutableDirectBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;Received {}&#34;</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="iv-data-structures">IV. Data Structures</h2>
<p>Agrona provides a number of collection data structures for solving the overhead of needing to box and unbox the base data type in a collection.</p>
<h3 id="41-hashmaps">4.1 HashMaps</h3>
<blockquote>
<p>When using the IDE for DEUBG, Agrona HashMaps may have problems with the wrong elements in it. To solve this you can set <code>shouldAvoidAllocation</code> in the constructor to false and Agrona will turn off caching, but this will also result in an increase in GCs.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Int2IntHashMap</td>
<td><code>&lt;int, int&gt;</code> of HashMap</td>
</tr>
<tr>
<td>Int2NullableObjectHashMap</td>
<td><code>&lt;int, nullable object&gt;</code> of HashMap</td>
</tr>
<tr>
<td>HashMap of Int2ObjectHashMap</td>
<td><code>&lt;int, object&gt;</code>.</td>
</tr>
<tr>
<td>Long2LongHashMap</td>
<td>HashMap of <code>&lt;long, long&gt;</code></td>
</tr>
<tr>
<td>The HashMap of Long2NullableObjectHashMap</td>
<td><code>&lt;long, nullable object&gt;</code> is identified by NullReference inside the collection if the value is null.</td>
</tr>
<tr>
<td>Long2ObjectHashMap</td>
<td><code>&lt;long, object&gt;</code> of HashMap</td>
</tr>
<tr>
<td>HashMap of Object2IntHashMap</td>
<td><code>&lt;object, int&gt;</code></td>
</tr>
<tr>
<td>Object2NullableObjectHashMap</td>
<td>HashMap of <code>&lt;object, nullable object&gt;</code></td>
</tr>
<tr>
<td>Object2ObjectHashMap</td>
<td>HashMap of <code>&lt;object, object&gt;</code></td>
</tr>
</tbody>
</table>
<p>When using these HashMaps, you need to make sure that the element <code>hashCode()</code> is correct, and the performance of the collection can be greatly affected if hashCodes are heavily conflicted.</p>
<h3 id="42-caches">4.2 Caches</h3>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Int2ObjectCache</td>
<td>Cache with primitive int lookup to an object. Tuned for very small data structures stored within CPU cache lines. Typical sizes are 2 to 16 entries. Underlying storage is an array.</td>
</tr>
<tr>
<td>IntLruCache</td>
<td>Fixed size cache, use LRU policy to clear expired cache when limit is reached</td>
</tr>
</tbody>
</table>
<h3 id="43-hashsets">4.3 HashSets</h3>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>IntHashSet</td>
<td>HashSet of base int type, automatically expanded.</td>
</tr>
<tr>
<td>ObjectHashSet</td>
<td>HashSet of type object, automatically expanded.</td>
</tr>
</tbody>
</table>
<h2 id="v-direct-buffer">V. Direct Buffer</h2>
<blockquote>
<p>Agrona&rsquo;s use of the <code>sun.misc.Unsafe</code> and <code>sun.nio.ch.SelectedImpl.selectedKeys</code> APIs may cause the JVM to have a warning log printed at startup about illegal reflection accesses. If you want to remove the selections, add the JVM parameters: <code>--add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens jdk.unsupported/sun.misc=ALL-UNNAMED</code></p>
</blockquote>
<p>Agrona defines the <code>DirectBuffer</code> interface for interacting with Aeron, which is somewhat similar to <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/ByteBuffer.html">Java NIO ByteBuffer</a>, but a bit more convenient.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/03/5aded193b7734865a5fa4cda5b286dd2.png" alt=""></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Implementation Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>UnsafeBuffer</td>
<td>A fixed size buffer outside the heap will throw an IndexOutOfBoundsException when the size is exceeded.</td>
</tr>
<tr>
<td>ExpandableDirectByteBuffer</td>
<td>Scalable direct buffer, implemented in the underlying ByteBuffer, defaults to 128 bytes and can be resized via the constructor. When the size is exceeded, a new ByteBuffer is created and the existing contents are copied into it.</td>
</tr>
<tr>
<td>ExpandableArrayBuffer</td>
<td>The underlying direct buffer, which uses a byte array (new byte[size]), defaults to 128 bytes, and when the size is exceeded, a new byte[] is created and the existing contents are copied in.</td>
</tr>
</tbody>
</table>
<h3 id="51-key-concepts">5.1 Key Concepts</h3>
<p>Agrona uses the byte order of <code>ByteOrder.nativeOrder()</code> by default, and using different byte orders for reading and writing can lead to incorrect results. This can occur in cross-OS and cross-platform interactions.</p>
<p>The following figure shows a buffer of size 13 bytes, if we want to extract 4 bytes from it for the highlighted part, we need to set offset to 4 and then set read length to 4.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/03/41a83735e15946b48b4a8e7ca63d843c.png" alt=""></p>
<h3 id="52-working-with-types">5.2 Working with Types</h3>
<h4 id="521-chars--bytes">5.2.1 Chars &amp; Bytes</h4>
<p>DirectBuffer provides methods to read and write single bytes or 16-bit characters.</p>
<h4 id="522-shorts-integers--longs">5.2.2 Shorts, Integers &amp; Longs</h4>
<p>DirectBuffer provides support for reading and writing short, int, and long data. For int and long, additional utility methods are provided for compare-and-set, get-and-add, and get-and-set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//place 41 at index 0
</span><span class="c1"></span><span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">putLong</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">41</span><span class="o">);</span>
<span class="c1">//add 1 to the long at index 0 and return the old value, which is 41
</span><span class="c1"></span><span class="kt">long</span> <span class="n">originalValue</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">getAndAddLong</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
<span class="c1">//read the value of the long at index 0; is now 42
</span><span class="c1"></span><span class="kt">long</span> <span class="n">plus1</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//read current value while writing a new value.
</span><span class="c1">//Assuming code continues from above, oldValue = 42
</span><span class="c1"></span><span class="kt">long</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">getAndSetLong</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">43</span><span class="o">);</span>
<span class="c1">//read the value of the long at index 0, which is now 43
</span><span class="c1"></span><span class="kt">long</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//check the value was what was expected, returning true/false if it was. Then update the value a new value
</span><span class="c1">//Assuming code continues from above, wasExpected = true
</span><span class="c1"></span><span class="kt">boolean</span> <span class="n">wasExpected</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">compareAndSetLong</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">43</span><span class="o">,</span> <span class="n">44</span><span class="o">);</span>
<span class="c1">//read the value of the long at index 0, which is now 44
</span><span class="c1"></span><span class="kt">long</span> <span class="n">updatedValue</span> <span class="o">=</span> <span class="n">unsafeBuffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

</code></pre></td></tr></table>
</div>
</div><h4 id="523-floats--doubles">5.2.3 Floats &amp; Doubles</h4>
<blockquote>
<p>It is generally not recommended to use float and double for data transfer, but either BigDecimal formatted as a string or scaled long.</p>
</blockquote>
<p>DirectBuffer provides methods for reading and writing float and double.</p>
<h4 id="523-strings">5.2.3 Strings</h4>
<ul>
<li><code>putStringAscii</code>, <code>putStringUtf8</code> manipulate non-fixed-length strings, which is less efficient.</li>
<li><code>putStringWithoutLengthAscii</code>, <code>putStringWithoutLengthUtf8</code> manipulate fixed-length strings</li>
</ul>
<h2 id="vi-idgenerator">VI. IdGenerator</h2>
<p>Agrona also implements the snowflake algorithm.</p>
<ul>
<li>the generated result is 64-bit data</li>
<li>The data is roughly ordered</li>
<li>Up to 4096000 can be generated per second. If an attempt is made to generate more than this value, it will spin up to the next available generation time</li>
<li>An <code>IllegalStateException</code> exception can be thrown if the system has a clock rollback</li>
<li>Lock-free and thread-safe</li>
</ul>
<p>When initializing the snowflake algorithm, you need to provide a unique node ID, which supports up to 1024 nodes by default.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">long</span> <span class="n">nodeId</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
<span class="kd">final</span> <span class="n">IdGenerator</span> <span class="n">idGenerator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SnowflakeIdGenerator</span><span class="o">(</span><span class="n">nodeId</span><span class="o">);</span>

<span class="kd">final</span> <span class="kt">long</span> <span class="n">nextId</span> <span class="o">=</span> <span class="n">idGenerator</span><span class="o">.</span><span class="na">nextId</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that by default it uses 1970 as the starting point, so it can only generate up to 2039 (similar to Epoch Time). It provides an overloaded constructor to specify the starting time.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/agrona/">agrona</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/mockito-source-code-analysis-1/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Mockito Source Code Analysis (1) - Basic Concepts</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/whys-the-design-mysql-auto-increment/">
            <span class="next-text nav-default">Why MySQL&#39;s self-incrementing primary keys are not monotonic or continuous</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
