<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Implementation principles of Go language arrays - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Arrays and slices are common data structures in the Go language, and many developers new to Go tend to confuse these two concepts. In addition to arrays, Go introduces another concept - slicing. Slicing has some similarities to arrays, but their differences lead to significant differences in usage. In this section we will introduce the underlying implementation of arrays from the Go compile-time runtime, which will include several common operations for initializing, accessing, and assigning values to arrays." /><meta name="keywords" content="golang, Array" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/golang-array/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Implementation principles of Go language arrays" />
<meta property="og:description" content="Arrays and slices are common data structures in the Go language, and many developers new to Go tend to confuse these two concepts. In addition to arrays, Go introduces another concept - slicing. Slicing has some similarities to arrays, but their differences lead to significant differences in usage. In this section we will introduce the underlying implementation of arrays from the Go compile-time runtime, which will include several common operations for initializing, accessing, and assigning values to arrays." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/golang-array/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-08T15:35:04+08:00" />
<meta property="article:modified_time" content="2021-12-08T15:35:04+08:00" />

<meta itemprop="name" content="Implementation principles of Go language arrays">
<meta itemprop="description" content="Arrays and slices are common data structures in the Go language, and many developers new to Go tend to confuse these two concepts. In addition to arrays, Go introduces another concept - slicing. Slicing has some similarities to arrays, but their differences lead to significant differences in usage. In this section we will introduce the underlying implementation of arrays from the Go compile-time runtime, which will include several common operations for initializing, accessing, and assigning values to arrays."><meta itemprop="datePublished" content="2021-12-08T15:35:04+08:00" />
<meta itemprop="dateModified" content="2021-12-08T15:35:04+08:00" />
<meta itemprop="wordCount" content="2257">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementation principles of Go language arrays"/>
<meta name="twitter:description" content="Arrays and slices are common data structures in the Go language, and many developers new to Go tend to confuse these two concepts. In addition to arrays, Go introduces another concept - slicing. Slicing has some similarities to arrays, but their differences lead to significant differences in usage. In this section we will introduce the underlying implementation of arrays from the Go compile-time runtime, which will include several common operations for initializing, accessing, and assigning values to arrays."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Implementation principles of Go language arrays</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-08 15:35:04 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2257 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#initialization">Initialization</a>
          <ul>
            <li><a href="#upper-bound-derivation">Upper bound derivation</a></li>
            <li><a href="#statement-conversion">Statement conversion</a></li>
          </ul>
        </li>
        <li><a href="#access-and-assignment">Access and assignment</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Arrays and slices are common data structures in the Go language, and many developers new to Go tend to confuse these two concepts. In addition to arrays, Go introduces another concept - slicing. Slicing has some similarities to arrays, but their differences lead to significant differences in usage. In this section we will introduce the underlying implementation of arrays from the Go compile-time runtime, which will include several common operations for initializing, accessing, and assigning values to arrays.</p>
<h2 id="overview">Overview</h2>
<p>An array is a data structure consisting of a collection of elements of the same type. The computer allocates a contiguous piece of memory for the array to hold its elements, and we can use the indexes of the elements in the array to quickly access specific elements. Most common arrays are one-dimensional linear arrays, while multidimensional arrays have more common applications in numerical and graphical computing.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/08/c626be5bfdc7418caca5df2085f30874.png" alt=""></p>
<p>As a basic data type, arrays are usually described in two dimensions, namely the type of elements stored in the array and the maximum number of elements that the array can store. In Go language we tend to use the following representation of array types as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="kt">int</span>
<span class="p">[</span><span class="mi">200</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><p>Go arrays cannot be changed in size after initialization, and arrays that store elements of the same type but different sizes are considered completely different in Go, and are the same type only if both conditions are the same.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewArray</span><span class="p">(</span><span class="nx">elem</span> <span class="o">*</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">bound</span> <span class="kt">int64</span><span class="p">)</span> <span class="o">*</span><span class="nx">Type</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">bound</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;NewArray: invalid bound %v&#34;</span><span class="p">,</span> <span class="nx">bound</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">TARRAY</span><span class="p">)</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">Extra</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Array</span><span class="p">{</span><span class="nx">Elem</span><span class="p">:</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">Bound</span><span class="p">:</span> <span class="nx">bound</span><span class="p">}</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">SetNotInHeap</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nf">NotInHeap</span><span class="p">())</span>
	<span class="k">return</span> <span class="nx">t</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The array type during compilation is generated by the above cmd/compile/internal/types.NewArray function, which contains two fields, the element type Elem and the size of the array Bound, which together form the array type, and whether the current array should be initialized on the stack is determined at compile time.</p>
<h2 id="initialization">Initialization</h2>
<p>Arrays in Go are created in two different ways, either by explicitly specifying the size of the array, or by using [&hellip;] T to declare the array, and Go will derive the size of the array from the source code during compilation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">arr1</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
<span class="nx">arr2</span> <span class="o">:=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above two declaration methods get exactly the same result during runtime. The latter declaration method is converted to the former one during compilation, which is the compiler&rsquo;s derivation of the array size, and we will introduce the compiler&rsquo;s derivation process below.</p>
<h3 id="upper-bound-derivation">Upper bound derivation</h3>
<p>The two different declarations lead to completely different treatment by the compiler. If we use the first way [10]T, then the type of the variable is extracted as soon as the compilation proceeds to the type checking stage, and the cmd/compile/internal/types.NewArray containing the array size is subsequently created using cmd/compile/internal/types. Array structure containing the array size.</p>
<p>When we declare an array using [&hellip;] T, the compiler will derive the size of the array in the cmd/compile/internal/gc.typecheckcomplit function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">typecheckcomplit</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">(</span><span class="nx">res</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Op</span> <span class="o">==</span> <span class="nx">OTARRAY</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Left</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Left</span><span class="p">.</span><span class="nx">Op</span> <span class="o">==</span> <span class="nx">ODDD</span> <span class="p">{</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Right</span> <span class="p">=</span> <span class="nf">typecheck</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Right</span><span class="p">,</span> <span class="nx">ctxType</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">n</span><span class="p">.</span><span class="nx">Type</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="k">return</span> <span class="nx">n</span>
		<span class="p">}</span>
		<span class="nx">elemType</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Type</span>

		<span class="nx">length</span> <span class="o">:=</span> <span class="nf">typecheckarraylit</span><span class="p">(</span><span class="nx">elemType</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Slice</span><span class="p">(),</span> <span class="s">&#34;array literal&#34;</span><span class="p">)</span>

		<span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">=</span> <span class="nx">OARRAYLIT</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Type</span> <span class="p">=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">NewArray</span><span class="p">(</span><span class="nx">elemType</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Right</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="k">return</span> <span class="nx">n</span>
	<span class="p">}</span>
	<span class="o">...</span>

	<span class="k">switch</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Etype</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">TARRAY</span><span class="p">:</span>
		<span class="nf">typecheckarraylit</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">Elem</span><span class="p">(),</span> <span class="nx">t</span><span class="p">.</span><span class="nf">NumElem</span><span class="p">(),</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Slice</span><span class="p">(),</span> <span class="s">&#34;array literal&#34;</span><span class="p">)</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">=</span> <span class="nx">OARRAYLIT</span>
		<span class="nx">n</span><span class="p">.</span><span class="nx">Right</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This truncated cmd/compile/internal/gc.typecheckcomplit calls cmd/compile/internal/gc.typecheckarraylit to count the number of elements in the array by traversing the elements.</p>
<p>So we can see that [&hellip;] T{1, 2, 3} and [3]T{1, 2, 3} are exactly equivalent at runtime, [&hellip;] T initialization is just a kind of syntactic sugar provided by the Go language to reduce the workload when we don&rsquo;t want to count the number of elements in the array.</p>
<h3 id="statement-conversion">Statement conversion</h3>
<p>For an array of literals, depending on the number of array elements, the compiler does two different optimizations in the cmd/compile/internal/gc.anylit function, which is responsible for initializing the literals.</p>
<ol>
<li>when the number of elements is less than or equal to 4, the elements of the array will be placed directly on the stack.</li>
<li>when the number of elements is greater than 4, the elements of the array are placed in the static area and removed at runtime.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">anylit</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">var_</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">init</span> <span class="o">*</span><span class="nx">Nodes</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Type</span>
	<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">OSTRUCTLIT</span><span class="p">,</span> <span class="nx">OARRAYLIT</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Len</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">4</span> <span class="p">{</span>
			<span class="o">...</span>
		<span class="p">}</span>

		<span class="nf">fixedlit</span><span class="p">(</span><span class="nx">inInitFunction</span><span class="p">,</span> <span class="nx">initKindLocalCode</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">var_</span><span class="p">,</span> <span class="nx">init</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When the array has less than or equal to four elements, cmd/compile/internal/gc.fixedlit takes care of converting [3]{1, 2, 3} to a more primitive statement before the function is compiled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">fixedlit</span><span class="p">(</span><span class="nx">ctxt</span> <span class="nx">initContext</span><span class="p">,</span> <span class="nx">kind</span> <span class="nx">initKind</span><span class="p">,</span> <span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">var_</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">init</span> <span class="o">*</span><span class="nx">Nodes</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">splitnode</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">value</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span>
	<span class="o">...</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Slice</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">a</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="nf">splitnode</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
		<span class="nx">a</span> <span class="p">=</span> <span class="nf">nod</span><span class="p">(</span><span class="nx">OAS</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		<span class="nx">a</span> <span class="p">=</span> <span class="nf">typecheck</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">ctxStmt</span><span class="p">)</span>
		<span class="k">switch</span> <span class="nx">kind</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">initKindStatic</span><span class="p">:</span>
			<span class="nf">genAsStatic</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
		<span class="k">case</span> <span class="nx">initKindLocalCode</span><span class="p">:</span>
			<span class="nx">a</span> <span class="p">=</span> <span class="nf">orderStmtInPlace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="o">*</span><span class="nx">Node</span><span class="p">{})</span>
			<span class="nx">a</span> <span class="p">=</span> <span class="nf">walkstmt</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
			<span class="nx">init</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When the number of elements in the array is less than or equal to four and the kind received by the cmd/compile/internal/gc.fixedlit function is initKindLocalCode, the above code splits the original initialization statement [3]int{1, 2, 3} into an expression declaring a variable and several assignment expressions. These expressions will complete the initialization of the array:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">arr</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span>
<span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
<span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">2</span>
<span class="nx">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="mi">3</span>
</code></pre></td></tr></table>
</div>
</div><p>However, if the current array has more than four elements, cmd/compile/internal/gc.anylit will first get a unique staticname and then call the cmd/compile/internal/gc.fixedlit function to initialize the elements of the array in static storage and assign temporary variables to the array :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">anylit</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">var_</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">init</span> <span class="o">*</span><span class="nx">Nodes</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Type</span>
	<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">OSTRUCTLIT</span><span class="p">,</span> <span class="nx">OARRAYLIT</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">List</span><span class="p">.</span><span class="nf">Len</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">4</span> <span class="p">{</span>
			<span class="nx">vstat</span> <span class="o">:=</span> <span class="nf">staticname</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
			<span class="nx">vstat</span><span class="p">.</span><span class="nx">Name</span><span class="p">.</span><span class="nf">SetReadonly</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

			<span class="nf">fixedlit</span><span class="p">(</span><span class="nx">inNonInitFunction</span><span class="p">,</span> <span class="nx">initKindStatic</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">vstat</span><span class="p">,</span> <span class="nx">init</span><span class="p">)</span>

			<span class="nx">a</span> <span class="o">:=</span> <span class="nf">nod</span><span class="p">(</span><span class="nx">OAS</span><span class="p">,</span> <span class="nx">var_</span><span class="p">,</span> <span class="nx">vstat</span><span class="p">)</span>
			<span class="nx">a</span> <span class="p">=</span> <span class="nf">typecheck</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">ctxStmt</span><span class="p">)</span>
			<span class="nx">a</span> <span class="p">=</span> <span class="nf">walkexpr</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">init</span><span class="p">)</span>
			<span class="nx">init</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
			<span class="k">break</span>
		<span class="p">}</span>

		<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Assuming that the code needs to initialize [5]int{1, 2, 3, 4, 5}, then we can interpret the above procedure as the following pseudo-code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">arr</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">int</span>
<span class="nx">statictmp_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
<span class="nx">statictmp_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">2</span>
<span class="nx">statictmp_0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="mi">3</span>
<span class="nx">statictmp_0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="mi">4</span>
<span class="nx">statictmp_0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">=</span> <span class="mi">5</span>
<span class="nx">arr</span> <span class="p">=</span> <span class="nx">statictmp_0</span>
</code></pre></td></tr></table>
</div>
</div><p>To summarize, without considering escape analysis, if the number of elements in the array is less than or equal to 4, then all variables will be initialized directly on the stack, and if the array has more than 4 elements, the variables will be initialized in static storage and then copied to the stack.</p>
<h2 id="access-and-assignment">Access and assignment</h2>
<p>Whether on the stack or in static storage, arrays are a sequence of memory spaces in memory. We represent arrays by a pointer to the beginning of the array, the number of elements, and the size of the space occupied by the element type. If we do not know the number of elements in the array, an out-of-bounds access may occur; and if we do not know the size of the element types in the array, there is no way to know how many bytes of data should be taken out at a time, and whichever information is missing, we have no way of knowing what data is actually stored in this contiguous memory space: the</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/08/2b2c670aa60c4d59801004d08f2f91b2.png" alt=""></p>
<p>Out-of-bounds array access is a very serious error, and can be determined by static type checking during compilation in Go. cmd/compile/internal/gc.typecheck1 verifies that the index of the accessed array.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">typecheck1</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">top</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">res</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">OINDEX</span><span class="p">:</span>
		<span class="nx">ok</span> <span class="o">|=</span> <span class="nx">ctxExpr</span>
		<span class="nx">l</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Left</span>  <span class="c1">// array
</span><span class="c1"></span>		<span class="nx">r</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span> <span class="c1">// index
</span><span class="c1"></span>		<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Left</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Etype</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">TSTRING</span><span class="p">,</span> <span class="nx">TARRAY</span><span class="p">,</span> <span class="nx">TSLICE</span><span class="p">:</span>
			<span class="o">...</span>
			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Type</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nf">IsInteger</span><span class="p">()</span> <span class="p">{</span>
				<span class="nf">yyerror</span><span class="p">(</span><span class="s">&#34;non-integer array index %v&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">)</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nf">Bounded</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nf">Isconst</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">,</span> <span class="nx">CTINT</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">x</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">.</span><span class="nf">Int64</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
					<span class="nf">yyerror</span><span class="p">(</span><span class="s">&#34;invalid array index %v (index must be non-negative)&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">)</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Left</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nf">IsArray</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Left</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nf">NumElem</span><span class="p">()</span> <span class="p">{</span>
					<span class="nf">yyerror</span><span class="p">(</span><span class="s">&#34;invalid array index %v (out of bounds for %d-element array)&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Right</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Left</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nf">NumElem</span><span class="p">())</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>the error &ldquo;non-integer array index %v&rdquo; is reported when accessing an array whose index is a non-integer.</li>
<li>the error &ldquo;invalid array index %v (index must be non-negative)&rdquo; is reported when the index of the accessed array is negative.</li>
<li>the error &ldquo;invalid array index %v (out of bounds for %d-element array)&rdquo; is reported when the index of the accessed array is out of bounds.</li>
</ol>
<p>Some simple out-of-bounds errors for arrays and strings are found during compilation, e.g. accessing an array directly with an integer or constant; however, when accessing an array or string with a variable, the compiler cannot detect the error in advance, and we need the Go runtime to prevent illegal accesses.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nx">invalid</span> <span class="nx">array</span> <span class="nx">index</span> <span class="mi">4</span> <span class="p">(</span><span class="nx">out</span> <span class="nx">of</span> <span class="nx">bounds</span> <span class="k">for</span> <span class="mi">3</span><span class="o">-</span><span class="nx">element</span> <span class="nx">array</span><span class="p">)</span>
<span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]:</span> <span class="nx">panic</span><span class="p">:</span> <span class="nx">runtime</span> <span class="kt">error</span><span class="p">:</span> <span class="nx">index</span> <span class="nx">out</span> <span class="nx">of</span> <span class="k">range</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="nx">with</span> <span class="nx">length</span> <span class="mi">3</span>
</code></pre></td></tr></table>
</div>
</div><p>Out-of-bounds operations on arrays, slices and strings found by the Go runtime are triggered by runtime.panicIndex and runtime.goPanicIndex, which trigger a runtime error and cause a crash and exit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">TEXT</span> <span class="nx">runtime</span><span class="err">·</span><span class="nf">panicIndex</span><span class="p">(</span><span class="nx">SB</span><span class="p">),</span><span class="nx">NOSPLIT</span><span class="p">,</span><span class="err">$</span><span class="mi">0</span><span class="o">-</span><span class="mi">8</span>
	<span class="nx">MOVL</span>	<span class="nx">AX</span><span class="p">,</span> <span class="nx">x</span><span class="o">+</span><span class="mi">0</span><span class="p">(</span><span class="nx">FP</span><span class="p">)</span>
	<span class="nx">MOVL</span>	<span class="nx">CX</span><span class="p">,</span> <span class="nx">y</span><span class="o">+</span><span class="mi">4</span><span class="p">(</span><span class="nx">FP</span><span class="p">)</span>
	<span class="nx">JMP</span>	<span class="nx">runtime</span><span class="err">·</span><span class="nf">goPanicIndex</span><span class="p">(</span><span class="nx">SB</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">goPanicIndex</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">y</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">panicCheck1</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="s">&#34;index out of range&#34;</span><span class="p">)</span>
	<span class="nb">panic</span><span class="p">(</span><span class="nx">boundsError</span><span class="p">{</span><span class="nx">x</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">signed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">y</span><span class="p">:</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">code</span><span class="p">:</span> <span class="nx">boundsIndex</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When the array access operation OINDEX successfully passes the compiler&rsquo;s checks, it is converted into several SSA directives. Suppose we have Go code as shown below, compiling it in the following way will result in the ssa.html file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">check</span>

<span class="kd">func</span> <span class="nf">outOfRange</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">arr</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
	<span class="nx">i</span> <span class="o">:=</span> <span class="mi">4</span>
	<span class="nx">elem</span> <span class="o">:=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
	<span class="k">return</span> <span class="nx">elem</span>
<span class="p">}</span>

<span class="err">$</span> <span class="nx">GOSSAFUNC</span><span class="p">=</span><span class="nx">outOfRange</span> <span class="k">go</span> <span class="nx">build</span> <span class="nx">array</span><span class="p">.</span><span class="k">go</span>
<span class="nx">dumped</span> <span class="nx">SSA</span> <span class="nx">to</span> <span class="p">.</span><span class="o">/</span><span class="nx">ssa</span><span class="p">.</span><span class="nx">html</span>
</code></pre></td></tr></table>
</div>
</div><p>The SSA code generated in the start phase is the first version of the intermediate code before the optimization, which is shown below for elem := arr[i].</p>
<p>In this intermediate code, we find that Go generates the instruction IsInBounds to determine the upper limit of the array and the PanicBounds instruction to crash the program if the condition is not met.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">b1</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="nf">v22</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">LocalAddr</span> <span class="p">&lt;</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span><span class="nx">arr</span><span class="p">}</span> <span class="nx">v2</span> <span class="nx">v20</span>
    <span class="nf">v23</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">IsInBounds</span> <span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nx">v21</span> <span class="nx">v11</span>
<span class="nx">If</span> <span class="nx">v23</span> <span class="err">→</span> <span class="nx">b2</span> <span class="nf">b3</span> <span class="p">(</span><span class="nx">likely</span><span class="p">)</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="nx">b2</span><span class="p">:</span> <span class="err">←</span> <span class="nx">b1</span><span class="o">-</span>
    <span class="nf">v26</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">PtrIndex</span> <span class="p">&lt;</span><span class="o">*</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">v22</span> <span class="nx">v21</span>
    <span class="nf">v27</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">Copy</span> <span class="p">&lt;</span><span class="nx">mem</span><span class="p">&gt;</span> <span class="nx">v20</span>
    <span class="nf">v28</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">Load</span> <span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">v26</span> <span class="nf">v27</span> <span class="p">(</span><span class="nx">elem</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span>
    <span class="o">...</span>
<span class="nx">Ret</span> <span class="nf">v30</span> <span class="p">(</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>

<span class="nx">b3</span><span class="p">:</span> <span class="err">←</span> <span class="nx">b1</span><span class="o">-</span>
    <span class="nf">v24</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">Copy</span> <span class="p">&lt;</span><span class="nx">mem</span><span class="p">&gt;</span> <span class="nx">v20</span>
    <span class="nf">v25</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">=</span> <span class="nx">PanicBounds</span> <span class="p">&lt;</span><span class="nx">mem</span><span class="p">&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="nx">v21</span> <span class="nx">v11</span> <span class="nx">v24</span>
<span class="nx">Exit</span> <span class="nf">v25</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>When the array subscript is not out of bounds, the compiler will first obtain the memory address of the array and the subscript to be accessed, calculate the address of the target element using PtrIndex, and finally load the element in the pointer into memory using the Load operation.</p>
<p>Of course, only when the compiler is unable to make a judgment on whether the array subscript is out of bounds or not, it will add the PanicBounds instruction to the runtime to make a judgment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">b1</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="nf">v21</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">LocalAddr</span> <span class="p">&lt;</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span><span class="nx">arr</span><span class="p">}</span> <span class="nx">v2</span> <span class="nx">v20</span>
    <span class="nf">v22</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">PtrIndex</span> <span class="p">&lt;</span><span class="o">*</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">v21</span> <span class="nx">v14</span>
    <span class="nf">v23</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">Load</span> <span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">v22</span> <span class="nf">v20</span> <span class="p">(</span><span class="nx">elem</span><span class="p">[</span><span class="kt">int</span><span class="p">])</span>
    <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p>It not only finds simple out-of-bounds errors in advance during compilation and inserts function calls to check the upper limit of the array, but also ensures that no out-of-bounds occur during runtime with the inserted functions.</p>
<p>The array assignment and update operation a[i] = 2 also generates the SSA generation which calculates the memory address of the current element of the array during generation and then modifies the contents of the current memory address, these assignment statements are converted into SSA code as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">b1</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="nf">v21</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">LocalAddr</span> <span class="p">&lt;</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">int</span><span class="p">&gt;</span> <span class="p">{</span><span class="nx">arr</span><span class="p">}</span> <span class="nx">v2</span> <span class="nx">v19</span>
    <span class="nf">v22</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">PtrIndex</span> <span class="p">&lt;</span><span class="o">*</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">v21</span> <span class="nx">v13</span>
    <span class="nf">v23</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">=</span> <span class="nx">Store</span> <span class="p">&lt;</span><span class="nx">mem</span><span class="p">&gt;</span> <span class="p">{</span><span class="kt">int</span><span class="p">}</span> <span class="nx">v22</span> <span class="nx">v20</span> <span class="nx">v19</span>
    <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><p>The assignment process will first determine the address of the target array, and then get the address of the target element through PtrIndex.</p>
<p>Finally, the Store instruction is used to store the data into the address. From the above SSA code, we can see that the above array addressing and assignment are done at the compilation stage without any runtime involvement.</p>
<h2 id="summary">Summary</h2>
<p>Arrays are an important data structure in Go, and understanding its implementation can help us understand the language better. Through the analysis of its implementation, we know that accessing and assigning values to arrays depends on both the compiler and the runtime, and most of its operations are converted into direct memory reads and writes during compilation. panicIndex call to prevent out-of-bounds errors from occurring.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/whys-the-design-udp-minimum-header/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Why is the UDP header only 8 bytes long?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/whys-the-design-go-generics/">
            <span class="next-text nav-default">Why the Go language doesn&#39;t have generics</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
