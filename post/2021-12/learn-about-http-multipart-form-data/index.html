<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Understanding multipart/form-data in HTTP protocol - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I encountered the problem of encapsulating the Media type multipart/form-data when writing a generic HTTP component. This article briefly introduces the definition, application and simple implementation of the media type multipart/form-data in the HTTP protocol. Definition of multipart/form-data The media type multipart/form-data follows the multipart MIME data stream definition (which can be found in Section 5.1 - RFC2046), which roughly means that the data body of the media type multipart/form-data" /><meta name="keywords" content="http, Multipart Form Data" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/learn-about-http-multipart-form-data/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Understanding multipart/form-data in HTTP protocol" />
<meta property="og:description" content="I encountered the problem of encapsulating the Media type multipart/form-data when writing a generic HTTP component. This article briefly introduces the definition, application and simple implementation of the media type multipart/form-data in the HTTP protocol. Definition of multipart/form-data The media type multipart/form-data follows the multipart MIME data stream definition (which can be found in Section 5.1 - RFC2046), which roughly means that the data body of the media type multipart/form-data" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/learn-about-http-multipart-form-data/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-30T09:39:40+08:00" />
<meta property="article:modified_time" content="2021-12-30T09:39:40+08:00" />

<meta itemprop="name" content="Understanding multipart/form-data in HTTP protocol">
<meta itemprop="description" content="I encountered the problem of encapsulating the Media type multipart/form-data when writing a generic HTTP component. This article briefly introduces the definition, application and simple implementation of the media type multipart/form-data in the HTTP protocol. Definition of multipart/form-data The media type multipart/form-data follows the multipart MIME data stream definition (which can be found in Section 5.1 - RFC2046), which roughly means that the data body of the media type multipart/form-data"><meta itemprop="datePublished" content="2021-12-30T09:39:40+08:00" />
<meta itemprop="dateModified" content="2021-12-30T09:39:40+08:00" />
<meta itemprop="wordCount" content="2167">
<meta itemprop="keywords" content="http," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Understanding multipart/form-data in HTTP protocol"/>
<meta name="twitter:description" content="I encountered the problem of encapsulating the Media type multipart/form-data when writing a generic HTTP component. This article briefly introduces the definition, application and simple implementation of the media type multipart/form-data in the HTTP protocol. Definition of multipart/form-data The media type multipart/form-data follows the multipart MIME data stream definition (which can be found in Section 5.1 - RFC2046), which roughly means that the data body of the media type multipart/form-data"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Understanding multipart/form-data in HTTP protocol</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-30 09:39:40 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2167 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#definition-of-multipartform-data">Definition of multipart/form-data</a>
          <ul>
            <li><a href="#multipartform-data-request-body-layout">multipart/form-data request body layout</a></li>
            <li><a href="#boundary-parameter-value-statute">Boundary parameter value statute</a></li>
          </ul>
        </li>
        <li><a href="#implementing-post-requests-for-multipartform-data-media-types">Implementing POST requests for multipart/form-data media types</a>
          <ul>
            <li><a href="#module-that-encapsulates-the-conversion-of-request-bodies-into-byte-containers">Module that encapsulates the conversion of request bodies into byte containers</a></li>
            <li><a href="#httpurlconnection-implementation">HttpURLConnection implementation</a></li>
            <li><a href="#jdk-built-in-httpclient-implementation">JDK built-in HttpClient implementation</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I encountered the problem of encapsulating the Media type <code>multipart/form-data</code> when writing a generic HTTP component. This article briefly introduces the definition, application and simple implementation of the media type <code>multipart/form-data</code> in the HTTP protocol.</p>
<h2 id="definition-of-multipartform-data">Definition of multipart/form-data</h2>
<p>The media type <code>multipart/form-data</code> follows the <code>multipart MIME</code> data stream definition (which can be found in <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1">Section 5.1 - RFC2046</a>), which roughly means that the data body of the media type <code>multipart/form-data</code> consists of multiple parts separated by a fixed Boundary.</p>
<h3 id="multipartform-data-request-body-layout">multipart/form-data request body layout</h3>
<p>The layout of the <code>multipart/form-data</code> request body is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># 请求头 - 这个是必须的，需要指定Content-Type为multipart/form-data，指定唯一边界值
Content-Type: multipart/form-data; boundary=${Boundary}

# 请求体
--${Boundary}
Content-Disposition: form-data; name=&#34;name of file&#34;
Content-Type: application/octet-stream

bytes of file
--${Boundary}
Content-Disposition: form-data; name=&#34;name of pdf&#34;; filename=&#34;pdf-file.pdf&#34;
Content-Type: application/octet-stream

bytes of pdf file
--${Boundary}
Content-Disposition: form-data; name=&#34;key&#34;
Content-Type: text/plain;charset=UTF-8

text encoded in UTF-8
--${Boundary}--
</code></pre></td></tr></table>
</div>
</div><p>The most obvious differences between the media type <code>multipart/form-data</code> versus other media types such as <code>application/x-www-form-urlencoded</code> are</p>
<ul>
<li>The Content-Type attribute of the request header, in addition to specifying <code>multipart/form-data</code>, also requires the definition of the boundary parameter</li>
<li>The request line data in the request body is composed of multiple parts, and the value pattern of the boundary parameter - ${Boundary} is used to separate each individual division</li>
<li>The request header <code>Content-Disposition: form-data; name=&quot;${PART_NAME}&quot;;</code> must be present in each section, where ${PART_NAME} needs to be URL encoded, and the filename field can be used to indicate the name of the file, but it is less binding than the name attribute (as there is no confirmation that the local file is available or objectionable)</li>
<li>Each part can define <code>Content-Type</code> and the data body of that part separately</li>
<li>The request body ends with the value pattern <code>-${Boundary}--</code> of the <code>boundary</code> parameter</li>
</ul>
<blockquote>
<p>RFC7578 mentions two multipart/form-data expired use, one is the use of Content-Transfer-Encoding request header, here also do not expand its use, the second is the request body of a single form attribute transmission of multiple binary file way recommended to switch to multipart/mixed (a &ldquo;name&rdquo; corresponds to multiple binary file scenario)</p>
</blockquote>
<p>Special.</p>
<ul>
<li>If the content of a part is text, its Content-Type is text/plain, you can specify the corresponding character set, such as Content-Type: text/plain;charset=UTF-8</li>
<li>The default charset can be specified via the <em>charset</em> attribute, which is used as follows.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Content-Disposition: form-data; name=&#34;_charset_&#34;

UTF-8
--ABCDE--
Content-Disposition: form-data; name=&#34;field&#34;

...text encoded in UTF-8...
ABCDE--
</code></pre></td></tr></table>
</div>
</div><h3 id="boundary-parameter-value-statute">Boundary parameter value statute</h3>
<p>The <code>Boundary</code> parameter takes the following value statute.</p>
<ul>
<li>The value of the Boundary must begin with a double horizontal bar &ndash; in the middle of the English language, this &ndash; is called the leading hyphen</li>
<li>The value of the Boundary must not contain more than 70 characters in addition to the leading hyphen.</li>
<li>The value of the Boundary must not contain characters that are disabled by the HTTP protocol or the URL, such as the colon: etc.</li>
<li>Each &ndash; ${Boundary} before the default mandatory must be CRLF, if a part of the text type request body ends with CRLF, then in the request body of the secondary system format, there must be two CRLF explicitly, if a part of the request body does not end with CRLF, can only exist a CRLF, these two cases are called the separator of the explicit type and implicit type, said more abstract, see the following example.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># 请求头
Content-type: multipart/data; boundary=&#34;--abcdefg&#34;

--abcdefg
Content-Disposition: form-data; name=&#34;x&#34;
Content-type: text/plain; charset=ascii

It does NOT end with a linebreak # &lt;=== 这里没有CRLF，隐式类型
--abcdefg
Content-Disposition: form-data; name=&#34;y&#34;
Content-type: text/plain; charset=ascii

It DOES end with a linebreak # &lt;=== 这里有CRLF，显式类型

--abcdefg

## 直观看隐式类型的CRLF
It does NOT end with a linebreak CRLF --abcdefg

## 直观看显式类型的CRLF
It DOES end with a linebreak CRLF CRLF --abcdefg
</code></pre></td></tr></table>
</div>
</div><h2 id="implementing-post-requests-for-multipartform-data-media-types">Implementing POST requests for multipart/form-data media types</h2>
<p>Here only for the low JDK version of HttpURLConnection and high JDK version of the built-in HttpClient to write multipart/form-data media type of POST requests HTTP client, others such as custom Socket implementation can be completed along similar lines. First introduce org.springframework.boot:spring-boot-starter-web:2.6.0 to do a simple controller method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">&#34;/test&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span> <span class="n">test</span><span class="o">(</span><span class="n">MultipartHttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="s">&#34;ok&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Postman&rsquo;s simulated request is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/30/4622730ff3af4f9a9f8d9d06a5739d49.png" alt="image"></p>
<p>The request parameters obtained by the backend controller are as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/30/5ec98acdbee84ca792ce3587edad8951.png" alt="image"></p>
<p>The client written later can call this interface directly for debugging.</p>
<h3 id="module-that-encapsulates-the-conversion-of-request-bodies-into-byte-containers">Module that encapsulates the conversion of request bodies into byte containers</h3>
<p>Here the boundary values are all implemented explicitly, and the boundary values are generated directly with a fixed prefix plus the UUID. Some simplifications are made in the simple implementation.</p>
<ul>
<li>Only text form data and binary (file) form data are considered for submission</li>
<li>Based on the previous point, each section explicitly specifies Content-Type as the request header</li>
<li>Text encoding is fixed to UTF-8</li>
</ul>
<p>Write a MultipartWriter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultipartWriter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Charset</span> <span class="n">DEFAULT_CHARSET</span> <span class="o">=</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">FIELD_SEP</span> <span class="o">=</span> <span class="s">&#34;: &#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">ISO_8859_1</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">CR_LF</span> <span class="o">=</span> <span class="s">&#34;\r\n&#34;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">ISO_8859_1</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TWO_HYPHENS_TEXT</span> <span class="o">=</span> <span class="s">&#34;--&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">TWO_HYPHENS</span> <span class="o">=</span> <span class="n">TWO_HYPHENS_TEXT</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">ISO_8859_1</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONTENT_DISPOSITION_KEY</span> <span class="o">=</span> <span class="s">&#34;Content-Disposition&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONTENT_TYPE_KEY</span> <span class="o">=</span> <span class="s">&#34;Content-Type&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_CONTENT_TYPE</span> <span class="o">=</span> <span class="s">&#34;multipart/form-data; boundary=&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_BINARY_CONTENT_TYPE</span> <span class="o">=</span> <span class="s">&#34;application/octet-stream&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_TEXT_CONTENT_TYPE</span> <span class="o">=</span> <span class="s">&#34;text/plain;charset=UTF-8&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DEFAULT_CONTENT_DISPOSITION_VALUE</span> <span class="o">=</span> <span class="s">&#34;form-data; name=\&#34;%s\&#34;&#34;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FILE_CONTENT_DISPOSITION_VALUE</span> <span class="o">=</span> <span class="s">&#34;form-data; name=\&#34;%s\&#34;; filename=\&#34;%s\&#34;&#34;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">8</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AbstractMultipartPart</span><span class="o">&gt;</span> <span class="n">parts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">boundary</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MultipartWriter</span><span class="o">(</span><span class="n">String</span> <span class="n">boundary</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">boundary</span> <span class="o">=</span> <span class="n">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">boundary</span><span class="o">)</span> <span class="o">?</span> <span class="n">TWO_HYPHENS_TEXT</span> <span class="o">+</span>
                <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">)</span> <span class="o">:</span> <span class="n">boundary</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">CONTENT_TYPE_KEY</span><span class="o">,</span> <span class="n">DEFAULT_CONTENT_TYPE</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">boundary</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MultipartWriter</span> <span class="nf">newMultipartWriter</span><span class="o">(</span><span class="n">String</span> <span class="n">boundary</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MultipartWriter</span><span class="o">(</span><span class="n">boundary</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MultipartWriter</span> <span class="nf">newMultipartWriter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MultipartWriter</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">MultipartWriter</span> <span class="nf">addHeader</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">CONTENT_TYPE_KEY</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">MultipartWriter</span> <span class="nf">addTextPart</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">TextPart</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">DEFAULT_CONTENT_DISPOSITION_VALUE</span><span class="o">,</span> <span class="n">name</span><span class="o">),</span> <span class="n">DEFAULT_TEXT_CONTENT_TYPE</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">boundary</span><span class="o">,</span> <span class="n">text</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">MultipartWriter</span> <span class="nf">addBinaryPart</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">BinaryPart</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">DEFAULT_CONTENT_DISPOSITION_VALUE</span><span class="o">,</span> <span class="n">name</span><span class="o">),</span> <span class="n">DEFAULT_BINARY_CONTENT_TYPE</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">boundary</span><span class="o">,</span> <span class="n">bytes</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">MultipartWriter</span> <span class="nf">addFilePart</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">parts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">FilePart</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">FILE_CONTENT_DISPOSITION_VALUE</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()),</span> <span class="n">DEFAULT_BINARY_CONTENT_TYPE</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">boundary</span><span class="o">,</span> <span class="n">file</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeHeader</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">FIELD_SEP</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">CR_LF</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeBytes</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">DEFAULT_CHARSET</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeBytes</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">interface</span> <span class="nc">MultipartPart</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">writeBody</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">os</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequiredArgsConstructor</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractMultipartPart</span> <span class="kd">implements</span> <span class="n">MultipartPart</span> <span class="o">{</span>

        <span class="kd">protected</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">contentDispositionValue</span><span class="o">;</span>
        <span class="kd">protected</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">contentTypeValue</span><span class="o">;</span>
        <span class="kd">protected</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">boundary</span><span class="o">;</span>

        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getContentDispositionValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">contentDispositionValue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getContentTypeValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">contentTypeValue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getBoundary</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">boundary</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">writeBytes</span><span class="o">(</span><span class="n">TWO_HYPHENS</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeBytes</span><span class="o">(</span><span class="n">getBoundary</span><span class="o">(),</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeBytes</span><span class="o">(</span><span class="n">CR_LF</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeHeader</span><span class="o">(</span><span class="n">CONTENT_DISPOSITION_KEY</span><span class="o">,</span> <span class="n">getContentDispositionValue</span><span class="o">(),</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeHeader</span><span class="o">(</span><span class="n">CONTENT_TYPE_KEY</span><span class="o">,</span> <span class="n">getContentTypeValue</span><span class="o">(),</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeBytes</span><span class="o">(</span><span class="n">CR_LF</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
            <span class="n">writeBody</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="n">writeBytes</span><span class="o">(</span><span class="n">CR_LF</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TextPart</span> <span class="kd">extends</span> <span class="n">AbstractMultipartPart</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">text</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">TextPart</span><span class="o">(</span><span class="n">String</span> <span class="n">contentDispositionValue</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">contentTypeValue</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">boundary</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">contentDispositionValue</span><span class="o">,</span> <span class="n">contentTypeValue</span><span class="o">,</span> <span class="n">boundary</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeBody</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">os</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">DEFAULT_CHARSET</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getContentDispositionValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">contentDispositionValue</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getContentTypeValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">contentTypeValue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BinaryPart</span> <span class="kd">extends</span> <span class="n">AbstractMultipartPart</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">BinaryPart</span><span class="o">(</span><span class="n">String</span> <span class="n">contentDispositionValue</span><span class="o">,</span>
                          <span class="n">String</span> <span class="n">contentTypeValue</span><span class="o">,</span>
                          <span class="n">String</span> <span class="n">boundary</span><span class="o">,</span>
                          <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">contentDispositionValue</span><span class="o">,</span> <span class="n">contentTypeValue</span><span class="o">,</span> <span class="n">boundary</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeBody</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FilePart</span> <span class="kd">extends</span> <span class="n">AbstractMultipartPart</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="n">File</span> <span class="n">file</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">FilePart</span><span class="o">(</span><span class="n">String</span> <span class="n">contentDispositionValue</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">contentTypeValue</span><span class="o">,</span>
                        <span class="n">String</span> <span class="n">boundary</span><span class="o">,</span>
                        <span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">contentDispositionValue</span><span class="o">,</span> <span class="n">contentTypeValue</span><span class="o">,</span> <span class="n">boundary</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeBody</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">))</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">4096</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">l</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">l</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">l</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachHeader</span><span class="o">(</span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">parts</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">AbstractMultipartPart</span> <span class="n">part</span> <span class="o">:</span> <span class="n">parts</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">part</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">TWO_HYPHENS</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">boundary</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">TWO_HYPHENS</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">writeBytes</span><span class="o">(</span><span class="n">CR_LF</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This class has encapsulated three different types of partial request body implementations. The forEachHeader() method is used to iterate through the request headers, and the final write() method is used to write the request body to the OutputStream.</p>
<h3 id="httpurlconnection-implementation">HttpURLConnection implementation</h3>
<p>The implementation code is as follows (minimal implementation only, without consideration of fault tolerance and exception handling).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpURLConnectionApp</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">URL</span> <span class="o">=</span> <span class="s">&#34;http://localhost:9099/test&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">MultipartWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">MultipartWriter</span><span class="o">.</span><span class="na">newMultipartWriter</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;throwable&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;domain&#34;</span><span class="o">,</span> <span class="s">&#34;vlts.cn&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addFilePart</span><span class="o">(</span><span class="s">&#34;ico&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;I:\\doge_favicon.ico&#34;</span><span class="o">));</span>
        <span class="n">DataOutputStream</span> <span class="n">requestPrinter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">requestPrinter</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">URL</span><span class="o">(</span><span class="n">URL</span><span class="o">).</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&#34;POST&#34;</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">addRequestProperty</span><span class="o">(</span><span class="s">&#34;Connection&#34;</span><span class="o">,</span> <span class="s">&#34;Keep-Alive&#34;</span><span class="o">);</span>
        <span class="c1">// 设置请求头
</span><span class="c1"></span>        <span class="n">writer</span><span class="o">.</span><span class="na">forEachHeader</span><span class="o">(</span><span class="n">connection</span><span class="o">::</span><span class="n">addRequestProperty</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setDoInput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="n">10000</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">10000</span><span class="o">);</span>
        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
        <span class="c1">// 设置请求体
</span><span class="c1"></span>        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">responseCode</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;响应码:%d,响应内容:%s\n&#34;</span><span class="o">,</span> <span class="n">responseCode</span><span class="o">,</span> <span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Implementation response results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">响应码:200,响应内容:ok
</code></pre></td></tr></table>
</div>
</div><p>You can try adding two lines of code to print the request body.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">MultipartWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">MultipartWriter</span><span class="o">.</span><span class="na">newMultipartWriter</span><span class="o">();</span>
<span class="n">writer</span><span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;throwable&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;domain&#34;</span><span class="o">,</span> <span class="s">&#34;vlts.cn&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addFilePart</span><span class="o">(</span><span class="s">&#34;ico&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;I:\\doge_favicon.ico&#34;</span><span class="o">));</span>
<span class="n">DataOutputStream</span> <span class="n">requestPrinter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
<span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">requestPrinter</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Console output as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/30/044e4b40d5c14a98874bb8ecd1a86a42.png" alt="image"></p>
<h3 id="jdk-built-in-httpclient-implementation">JDK built-in HttpClient implementation</h3>
<p>JDK11+ built-in HTTP client implementation, the specific entrance is java.net.http.HttpClient, the implementation code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpClientApp</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">URL</span> <span class="o">=</span> <span class="s">&#34;http://localhost:9099/test&#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">connectTimeout</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">10</span><span class="o">,</span> <span class="n">ChronoUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">MultipartWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">MultipartWriter</span><span class="o">.</span><span class="na">newMultipartWriter</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;throwable&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addTextPart</span><span class="o">(</span><span class="s">&#34;domain&#34;</span><span class="o">,</span> <span class="s">&#34;vlts.cn&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">addFilePart</span><span class="o">(</span><span class="s">&#34;ico&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;I:\\doge_favicon.ico&#34;</span><span class="o">));</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
        <span class="n">HttpRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">forEachHeader</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">::</span><span class="n">header</span><span class="o">);</span>
        <span class="n">HttpRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">requestBuilder</span><span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">URL</span><span class="o">))</span>
                <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">&#34;POST&#34;</span><span class="o">,</span> <span class="n">HttpRequest</span><span class="o">.</span><span class="na">BodyPublishers</span><span class="o">.</span><span class="na">ofByteArray</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">HttpResponse</span><span class="o">.</span><span class="na">BodyHandlers</span><span class="o">.</span><span class="na">ofString</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;响应码:%d,响应内容:%s\n&#34;</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The built-in HTTP components are almost all using Reactive programming model, using a relatively low-level API, which is more flexible but not as easy to use.</p>
<h2 id="summary">Summary</h2>
<p>The media type multipart/form-data is commonly used in HTTP requests under the POST method, and is relatively uncommon as an HTTP response.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/http/">http</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/sliding-captcha/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Deep learning to recognize sliding CAPTCHA</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/fourth-log4j-rce-vulnerability/">
            <span class="next-text nav-default">New remote code execution vulnerability in Apache Log4j</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
