<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Code to determine if IOS is jailbroken - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="&amp;ldquo;Jailbreaking&amp;rdquo; has existed since the Appstore was evaluated, when many people jailbroken in order to install paid applications or games. With the richness of Appstore applications and the increase of free APPs, there are few users who jailbreak their phones in order to sacrifice their security. On the other hand, jailbroken devices can install any software or script at will, which also brings the door of convenience to the black" /><meta name="keywords" content="ios, Jailbreak, Check" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/ios-jailbreak-check/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Code to determine if IOS is jailbroken" />
<meta property="og:description" content="&ldquo;Jailbreaking&rdquo; has existed since the Appstore was evaluated, when many people jailbroken in order to install paid applications or games. With the richness of Appstore applications and the increase of free APPs, there are few users who jailbreak their phones in order to sacrifice their security. On the other hand, jailbroken devices can install any software or script at will, which also brings the door of convenience to the black" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/ios-jailbreak-check/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-31T13:04:08+08:00" />
<meta property="article:modified_time" content="2021-12-31T13:04:08+08:00" />

<meta itemprop="name" content="Code to determine if IOS is jailbroken">
<meta itemprop="description" content="&ldquo;Jailbreaking&rdquo; has existed since the Appstore was evaluated, when many people jailbroken in order to install paid applications or games. With the richness of Appstore applications and the increase of free APPs, there are few users who jailbreak their phones in order to sacrifice their security. On the other hand, jailbroken devices can install any software or script at will, which also brings the door of convenience to the black"><meta itemprop="datePublished" content="2021-12-31T13:04:08+08:00" />
<meta itemprop="dateModified" content="2021-12-31T13:04:08+08:00" />
<meta itemprop="wordCount" content="1669">
<meta itemprop="keywords" content="ios," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Code to determine if IOS is jailbroken"/>
<meta name="twitter:description" content="&ldquo;Jailbreaking&rdquo; has existed since the Appstore was evaluated, when many people jailbroken in order to install paid applications or games. With the richness of Appstore applications and the increase of free APPs, there are few users who jailbreak their phones in order to sacrifice their security. On the other hand, jailbroken devices can install any software or script at will, which also brings the door of convenience to the black"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Code to determine if IOS is jailbroken</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-31 13:04:08 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1669 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#detecting-dynamic-libraries">Detecting dynamic libraries</a></li>
        <li><a href="#determine-if-there-are-jailbreak-related-files-or-permissions">Determine if there are jailbreak related files or permissions</a></li>
        <li><a href="#using-system-commands-to-determine">Using system commands to determine</a></li>
        <li><a href="#check-if-there-are-exception-classes-and-dynamic-libraries-for-exceptions">Check if there are exception classes and dynamic libraries for exceptions</a></li>
        <li><a href="#detect-if-debugging-is-in-progress">Detect if debugging is in progress</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>&ldquo;Jailbreaking&rdquo; has existed since the Appstore was evaluated, when many people jailbroken in order to install paid applications or games. With the richness of Appstore applications and the increase of free APPs, there are few users who jailbreak their phones in order to sacrifice their security. On the other hand, jailbroken devices can install any software or script at will, which also brings the door of convenience to the black market.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/31/7ce41063cee64b68bcd31d330e0bf3e1.png" alt="image"></p>
<p>Sometimes our application wants to know whether the installed device has been jailbroken or not, obviously, Apple will not give the official solution to come, so what do we do? The following are some ways to determine this.</p>
<h2 id="detecting-dynamic-libraries">Detecting dynamic libraries</h2>
<p><strong>1) Determine whether the dynamic library stat is the system library, and use stat to detect some specific file permissions</strong></p>
<p>stat command is used to determine the file information in OS system, but for the private path call command returns -1, if after jailbreak, because the permission changes, you can use <a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/stat.2.html">stat</a> to return the file information in the private directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">BOOL isStatNotSystemLib() {
    if(TARGET_IPHONE_SIMULATOR)return NO;
    int ret ;
    Dl_info dylib_info;
    int (*func_stat)(const char *, struct stat *) = stat;
    if ((ret = dladdr(func_stat, &amp;dylib_info))) {
        NSString *fName = [NSString stringWithUTF8String: dylib_info.dli_fname];
        if(![fName isEqualToString:@&#34;/usr/lib/system/libsystem_kernel.dylib&#34;]){
            return YES;
        }
    }
    
    char *JbPaths[] = {&#34;/Applications/Cydia.app&#34;,
    &#34;/usr/sbin/sshd&#34;,
    &#34;/bin/bash&#34;,
    &#34;/etc/apt&#34;,
    &#34;/Library/MobileSubstrate&#34;,
    &#34;/User/Applications/&#34;};
    
    for (int i = 0;i &lt; sizeof(JbPaths) / sizeof(char *);i++) {
        struct stat stat_info;
        if (0 == stat(JbPaths[i], &amp;stat_info)) {
            return YES;
        }
    }
    
    return NO;
}
</code></pre></td></tr></table>
</div>
</div><p><strong>2) Determine if dynamic libraries are injected</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">BOOL isInjectedWithDynamicLibrary()
{
    int i=0;
    char *substrate = &#34;/Library/MobileSubstrate/MobileSubstrate.dylib&#34;;
    while(true){
        // hook _dyld_get_image_name方法可以绕过
        const char *name = _dyld_get_image_name(i++);
        if(name==NULL){
            break;
        }
        if (name != NULL) {
                    if (strcmp(name,substrate)==0) {
                            return YES;
                    }
        }
    }
    return NO;
}
</code></pre></td></tr></table>
</div>
</div><h2 id="determine-if-there-are-jailbreak-related-files-or-permissions">Determine if there are jailbreak related files or permissions</h2>
<p><strong>1) Determine if you can open jailbreak software</strong></p>
<p>Most jailbreak devices will automatically cydia, use URL Scheme to see if you can open jailbreak software such as cydia.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">- (BOOL)isJailBreak
{
    if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@&#34;cydia://&#34;]]) {
        NSLog(@&#34;The device is jail broken!&#34;);
        return YES;
    }
    NSLog(@&#34;The device is NOT jail broken!&#34;);
    return NO;
}
</code></pre></td></tr></table>
</div>
</div><p><strong>2) Determine if some jailbroken files can be accessed</strong></p>
<p>Jailbreak will generate additional files, and you can determine whether they are jailbroken by judging whether they exist or not, and you can use two different methods to get them, fopen and FileManager.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">BOOL fileExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = NO;
    if([fileManager fileExistsAtPath:path isDirectory:&amp;isDirectory]){
        return YES;
    }
    return NO;
}

BOOL directoryExist(NSString* path)
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    BOOL isDirectory = YES;
    if([fileManager fileExistsAtPath:path isDirectory:&amp;isDirectory]){
        return YES;
    }
    return NO;
}

BOOL canOpen(NSString* path)
{
    FILE *file = fopen([path UTF8String], &#34;r&#34;);
    if(file==nil){
        return fileExist(path) || directoryExist(path);
    }
    fclose(file);
    return YES;
}

NSArray* checks = [[NSArray alloc] initWithObjects:@&#34;/Application/Cydia.app&#34;,
                       @&#34;/Library/MobileSubstrate/MobileSubstrate.dylib&#34;,
                       @&#34;/bin/bash&#34;,
                       @&#34;/usr/sbin/sshd&#34;,
                       @&#34;/etc/apt&#34;,
                       @&#34;/usr/bin/ssh&#34;,
                       @&#34;/private/var/lib/apt&#34;,
                       @&#34;/private/var/lib/cydia&#34;,
                       @&#34;/private/var/tmp/cydia.log&#34;,
                       @&#34;/Applications/WinterBoard.app&#34;,
                       @&#34;/var/lib/cydia&#34;,
                       @&#34;/private/etc/dpkg/origins/debian&#34;,
                       @&#34;/bin.sh&#34;,
                       @&#34;/private/etc/apt&#34;,
                       @&#34;/etc/ssh/sshd_config&#34;,
                       @&#34;/private/etc/ssh/sshd_config&#34;,
                       @&#34;/Applications/SBSetttings.app&#34;,
                       @&#34;/private/var/mobileLibrary/SBSettingsThemes/&#34;,
                       @&#34;/private/var/stash&#34;,
                       @&#34;/usr/libexec/sftp-server&#34;,
                       @&#34;/usr/libexec/cydia/&#34;,
                       @&#34;/usr/sbin/frida-server&#34;,
                       @&#34;/usr/bin/cycript&#34;,
                       @&#34;/usr/local/bin/cycript&#34;,
                       @&#34;/usr/lib/libcycript.dylib&#34;,
                       @&#34;/System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist&#34;,
                       @&#34;/System/Library/LaunchDaemons/com.ikey.bbot.plist&#34;,
                       @&#34;/Applications/FakeCarrier.app&#34;,
                       @&#34;/Library/MobileSubstrate/DynamicLibraries/Veency.plist&#34;,
                       @&#34;/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist&#34;,
                       @&#34;/usr/libexec/ssh-keysign&#34;,
                       @&#34;/usr/libexec/sftp-server&#34;,
                       @&#34;/Applications/blackra1n.app&#34;,
                       @&#34;/Applications/IntelliScreen.app&#34;,
                       @&#34;/Applications/Snoop-itConfig.app&#34;
                       @&#34;/var/lib/dpkg/info&#34;, nil];
    //Check installed app
    for(NSString* check in checks)
    {
        if(canOpen(check))
        {
            return YES;
        }
    }
</code></pre></td></tr></table>
</div>
</div><p><strong>3) Check if you have permission to write to the private directory</strong></p>
<p>Determine if you have permission to write to the private directory by checking if it is jailbroken</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NSString *path = @&#34;/private/avl.txt&#34;;
    NSFileManager *fileManager = [NSFileManager defaultManager];
    @try {
        NSError* error;
        NSString *test = @&#34;AVL was here&#34;;
        [test writeToFile:path atomically:NO encoding:NSStringEncodingConversionAllowLossy error:&amp;error];
        [fileManager removeItemAtPath:path error:nil];
        if(error==nil)
        {
            return YES;
        }

        return NO;
    } @catch (NSException *exception) {
        return NO;
}
</code></pre></td></tr></table>
</div>
</div><h2 id="using-system-commands-to-determine">Using system commands to determine</h2>
<p><strong>1) Use the lstat command to determine whether some directories of the system exist or have become links</strong></p>
<p>Jailbreak will change some files, these file directories will be migrated to other areas, but the original file location must be valid, so it will create symbolic links to link to the original path, we can detect whether these symbolic links exist, the existence of which means it is jailbroken.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">//symlink verification
    struct stat sym;
    // hook lstat可以绕过
    if(lstat(&#34;/Applications&#34;, &amp;sym) || lstat(&#34;/var/stash/Library/Ringtones&#34;, &amp;sym) ||
       lstat(&#34;/var/stash/Library/Wallpaper&#34;, &amp;sym) ||
       lstat(&#34;/var/stash/usr/include&#34;, &amp;sym) ||
       lstat(&#34;/var/stash/usr/libexec&#34;, &amp;sym)  ||
       lstat(&#34;/var/stash/usr/share&#34;, &amp;sym) ||
       lstat(&#34;/var/stash/usr/arm-apple-darwin9&#34;, &amp;sym))
    {
        if(sym.st_mode &amp; S_IFLNK)
        {
            return YES;
        }
}
</code></pre></td></tr></table>
</div>
</div><p><strong>2) Is it possible to fork a child process</strong></p>
<p>Some jailbreak tools will remove the sandbox restrictions so that the program can run without restrictions. fork function allows your program to generate a new process, if the sandbox is broken or the program is running outside the sandbox, then the fork function will be executed successfully, if the sandbox is not tampered with then the fork function will fail. Here we determine the success of the child process by the return value of fork(), the program code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#!c
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sandbox_integrity_compromised</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">always_inline</span><span class="p">));</span>
<span class="kt">int</span> <span class="nf">sandbox_integrity_compromised</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">sandbox_integrity_compromised</span><span class="p">())</span>
    <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Device is JailBroken</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Device is not JailBroken</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="check-if-there-are-exception-classes-and-dynamic-libraries-for-exceptions">Check if there are exception classes and dynamic libraries for exceptions</h2>
<p><strong>1) Check if there are exception classes</strong></p>
<p>Check if there are classes that inject exceptions,for example,HBPreferences is a common class for jailbreaking,there is no way to bypass it here,just look for more feature classes.Note that many anti-jailbreak plugins can be confusing,so you may have to identify them by checking the key methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">NSArray</span> <span class="o">*</span><span class="n">checksClass</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithObjects</span><span class="p">:</span><span class="err">@</span><span class="s">&#34;HBPreferences&#34;</span><span class="p">,</span><span class="n">nil</span><span class="p">];</span>
<span class="k">for</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">className</span> <span class="n">in</span> <span class="n">checksClass</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NSClassFromString</span><span class="p">(</span><span class="n">className</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>2) Detecting the presence of unusual dynamic libraries</strong></p>
<p>The difference between this and detecting the injection of dynamic libraries is that the general anti-jailbreak plug-in will hook_dyld_get_image_name this method to jailbreak the use of some dynamic libraries to shadow away (such as returning other dynamic library names, or return to normal), resulting in a match can not use the image load when the callback to go from MachO Header dynamic library information, it should be noted that when using dladdr to detect library information, may also be forced to return an error, you need to do a little further judgment, see the code below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">load</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
  <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    <span class="n">_dyld_register_func_for_add_image</span><span class="p">(</span><span class="n">_check_image</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// 监听image加载，从这里判断动态库是否加载，因为其他的检测动态库的方案会被hook
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="n">_check_image</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mach_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
                                      <span class="n">intptr_t</span> <span class="n">slide</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// hook Image load
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">SCHECK_USER</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 检测后就不在检测
</span><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 检测的lib
</span><span class="c1"></span>  <span class="n">NSSet</span> <span class="o">*</span><span class="n">dylibSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithObjects</span><span class="p">:</span>
                     <span class="err">@</span><span class="s">&#34;/usr/lib/CepheiUI.framework/CepheiUI&#34;</span><span class="p">,</span>
                     <span class="err">@</span><span class="s">&#34;/usr/lib/libsubstitute.dylib&#34;</span>
                     <span class="err">@</span><span class="s">&#34;/usr/lib/substitute-inserter.dylib&#34;</span><span class="p">,</span>
                     <span class="err">@</span><span class="s">&#34;/usr/lib/substitute-loader.dylib&#34;</span><span class="p">,</span>
                     <span class="n">nil</span><span class="p">];</span>
  
  <span class="n">Dl_info</span> <span class="n">info</span><span class="p">;</span>
  <span class="c1">// 0表示加载失败了，这里大概率是被hook导致的
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dladdr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">dlerro</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
    <span class="c1">// 获取失败了 但是返回了dli_fname, 说明被人hook了，目前看的方案都是直接返回0来绕过的
</span><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">dlerro</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">dli_fname</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NSString</span> <span class="o">*</span><span class="n">libName</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithUTF8String</span><span class="p">:</span><span class="n">info</span><span class="p">.</span><span class="n">dli_fname</span><span class="p">];</span>
      <span class="c1">// 判断有没有在动态列表里面
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">([</span><span class="n">dylibSet</span> <span class="nl">containsObject</span><span class="p">:</span><span class="n">libName</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">SCHECK_USER</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="detect-if-debugging-is-in-progress">Detect if debugging is in progress</h2>
<p><strong>1) Check if the environment variable DYLD_INSERT_LIBRARIES is available</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#pragma mark 通过环境变量DYLD_INSERT_LIBRARIES检测是否越狱
BOOL dyldEnvironmentVariables ()
{
    if(TARGET_IPHONE_SIMULATOR)return NO;
    return !(NULL == getenv(&#34;DYLD_INSERT_LIBRARIES&#34;));
}
</code></pre></td></tr></table>
</div>
</div><p><strong>2) Determine if the current process is in debugging mode</strong></p>
<p>Use the sysctl method to get information about the current process so that it is indeed whether pTraced debugging is going on, refer to <a href="https://developer.apple.com/library/archive/qa/qa1361/_index.html">sysctl</a> for details.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">BOOL isDebugged()
{
    int junk;
    int mib[4];
    struct kinfo_proc info;
    size_t size;
    info.kp_proc.p_flag = 0;
    mib[0] = CTL_KERN;
    mib[1] = KERN_PROC;
    mib[2] = KERN_PROC_PID;
    mib[3] = getpid();
    size = sizeof(info);
    junk = sysctl(mib, sizeof(mib) / sizeof(*mib), &amp;info, &amp;size, NULL, 0);
    assert(junk == 0);
    return ( (info.kp_proc.p_flag &amp; P_TRACED) != 0 );
}
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ios/">ios</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/mysql-insert-into/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">MySQL: Conditional Judgment Based Data Insertion</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/sliding-captcha/">
            <span class="next-text nav-default">Deep learning to recognize sliding CAPTCHA</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
