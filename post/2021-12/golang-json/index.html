<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The principle of JSON implementation in Go language - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="JSON (JavaScript Object Notation), a lightweight data interchange format1, holds almost a majority of the market share today. Although it lacks serialization and deserialization performance compared to more compact data interchange formats, JSON offers good readability and ease of use, and it is a very good choice for using JSON as a serialization format when extreme mechanical performance is not sought.
Design Principles Almost all modern programming languages incorporate functions for handling JSON directly into the standard library, and the Go language is no exception." /><meta name="keywords" content="golang, Json" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/golang-json/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="The principle of JSON implementation in Go language" />
<meta property="og:description" content="JSON (JavaScript Object Notation), a lightweight data interchange format1, holds almost a majority of the market share today. Although it lacks serialization and deserialization performance compared to more compact data interchange formats, JSON offers good readability and ease of use, and it is a very good choice for using JSON as a serialization format when extreme mechanical performance is not sought.
Design Principles Almost all modern programming languages incorporate functions for handling JSON directly into the standard library, and the Go language is no exception." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/golang-json/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-04T11:41:06+08:00" />
<meta property="article:modified_time" content="2021-12-04T11:41:06+08:00" />

<meta itemprop="name" content="The principle of JSON implementation in Go language">
<meta itemprop="description" content="JSON (JavaScript Object Notation), a lightweight data interchange format1, holds almost a majority of the market share today. Although it lacks serialization and deserialization performance compared to more compact data interchange formats, JSON offers good readability and ease of use, and it is a very good choice for using JSON as a serialization format when extreme mechanical performance is not sought.
Design Principles Almost all modern programming languages incorporate functions for handling JSON directly into the standard library, and the Go language is no exception."><meta itemprop="datePublished" content="2021-12-04T11:41:06+08:00" />
<meta itemprop="dateModified" content="2021-12-04T11:41:06+08:00" />
<meta itemprop="wordCount" content="2688">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The principle of JSON implementation in Go language"/>
<meta name="twitter:description" content="JSON (JavaScript Object Notation), a lightweight data interchange format1, holds almost a majority of the market share today. Although it lacks serialization and deserialization performance compared to more compact data interchange formats, JSON offers good readability and ease of use, and it is a very good choice for using JSON as a serialization format when extreme mechanical performance is not sought.
Design Principles Almost all modern programming languages incorporate functions for handling JSON directly into the standard library, and the Go language is no exception."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The principle of JSON implementation in Go language</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-04 11:41:06 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2688 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#design-principles">Design Principles</a>
          <ul>
            <li><a href="#interfaces">Interfaces</a></li>
            <li><a href="#tags">Tags</a></li>
          </ul>
        </li>
        <li><a href="#serialization">Serialization</a></li>
        <li><a href="#deserialization">Deserialization</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>JSON (JavaScript Object Notation), a lightweight data interchange format1, holds almost a majority of the market share today. Although it lacks serialization and deserialization performance compared to more compact data interchange formats, JSON offers good readability and ease of use, and it is a very good choice for using JSON as a serialization format when extreme mechanical performance is not sought.</p>
<h2 id="design-principles">Design Principles</h2>
<p>Almost all modern programming languages incorporate functions for handling JSON directly into the standard library, and the Go language is no exception. It provides standard JSON serialization and deserialization methods to the outside world via encoding/json, namely encoding/json.Marshal and encoding/json.Unmarshal, which are also the Marshal and encoding/json.Unmarshal, which are also the two most commonly used methods in the package.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/791496aa557f47ba8fe3acd322434a10.png" alt=""></p>
<p>The JSON serialization process in the Go language does not require any pre-implementation of the interface by the object being serialized, it takes the values in the structure or array through reflection and encodes them recursively in a tree structure. The standard library also decodes JSON based on the values passed in encoding/json.</p>
<p>The Go JSON library encoding and decoding process makes extensive use of reflection, and you will see a lot of reflection code in the second half of this section, so we won&rsquo;t go into that. Here we will briefly introduce the interfaces and tags in the JSON standard library, which are among the few interfaces it provides for developers to influence the decoding and encoding process.</p>
<h3 id="interfaces">Interfaces</h3>
<p>Marshaler and encoding/json.Unmarshaler interfaces are provided in the JSON standard library to affect the serialization and deserialization results of JSON, respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Marshaler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Unmarshaler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">UnmarshalJSON</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the process of JSON serialization and deserialization, it will use reflection to determine whether the structure type implements the above interface, and if it does, it will give priority to the corresponding method for encoding and decoding operations. TextMarshaler and encoding.TextUnmarshaler.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">TextMarshaler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">MarshalText</span><span class="p">()</span> <span class="p">(</span><span class="nx">text</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">TextUnmarshaler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">UnmarshalText</span><span class="p">(</span><span class="nx">text</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once a JSON-related serialization method is found not to be implemented, the above two methods are called by the JSON standard library as candidates and participate in the coding and decoding process. In summary, we can implement these four methods on any type to customize the end result, with the latter two methods being more general in scope, but not being called by the JSON standard library in preference.</p>
<h3 id="tags">Tags</h3>
<p>The Go language structure tag is also an interesting feature. By default, when we serialize and deserialize structures, the standard library assumes a one-to-one correspondence between field names and keys in JSON, however, Go language fields are generally camel nomenclature, and underscore nomenclature is relatively common in JSON, so it is a very convenient design to use the tag feature to directly establish a mapping between keys and fields.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/278d4d5ff619485b8928b64780eb0d37.png" alt=""></p>
<p>The tag in JSON consists of two parts, as shown below, name and age are tag names, and all the strings after them are tag options, i.e. encoding/json.tagOptions, which establish a one-to-one correspondence between tag names and field names, and the tag options after them will also affect the coding and decoding process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Author</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name,omitempty&#34;`</span>
    <span class="nx">Age</span>  <span class="kt">int32</span>  <span class="s">`json:&#34;age,string,omitempty&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Two common tags are string and omitempty. The former indicates that the current integer or floating point number is represented by a string in JSON, while the other field, omitempty, ignores the corresponding key-value pair directly in the generated JSON when the field has a zero value, e.g., &ldquo;age&rdquo;: 0, &ldquo;author&rdquo;: &ldquo;&rdquo;, etc. The standard library will use encoding/json.parseTag to parse the tag as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">parseTag</span><span class="p">(</span><span class="nx">tag</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">tagOptions</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">idx</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Index</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">);</span> <span class="nx">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">tag</span><span class="p">[:</span><span class="nx">idx</span><span class="p">],</span> <span class="nf">tagOptions</span><span class="p">(</span><span class="nx">tag</span><span class="p">[</span><span class="nx">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">tag</span><span class="p">,</span> <span class="nf">tagOptions</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>From the implementation of this method, we can analyze what form the legal tags in the JSON standard library take: tag names and tag options are concatenated with , and the leading string is the tag name, followed by all the tag options.</p>
<h2 id="serialization">Serialization</h2>
<p>Marshal is the simplest serialization function available in the JSON standard library. It takes a value of type interface{} as an argument, which means that almost all Go language variables can be serialized by the JSON standard library. In order to provide such complex and generic functionality, it is common to use reflection in static languages, so let&rsquo;s take a deeper look at its implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Marshal</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">e</span> <span class="o">:=</span> <span class="nf">newEncodeState</span><span class="p">()</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">encOpts</span><span class="p">{</span><span class="nx">escapeHTML</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="kc">nil</span><span class="p">),</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
	<span class="nx">encodeStatePool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">buf</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above method will call encoding/json.newEncodeState to get encoding/json.encodeState from the global pool of encoding states, which will be used for all subsequent serializations, and the structure will be put back into the pool for reuse after the encoding is done.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/0f7862bc07ed4f9cbc38fc3ee36c780e.png" alt=""></p>
<p>Following the complex call stack shown above, a series of serialization methods at the end get the reflected type of the object and call encoding/json.newTypeEncoder, a core encoding method that recursively finds the corresponding encoding method for all types, although its execution can be divided into two steps as follows.</p>
<ol>
<li>obtaining a user-defined encoding/json.Marshaler or encoding.TextMarshaler encoder.</li>
<li>getting the JSON encoder built into the standard library for the base type.</li>
</ol>
<p>In the first part of the method, we check whether the type of the current value can use the user-defined encoder, and here there are two different ways of determining this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newTypeEncoder</span><span class="p">(</span><span class="nx">t</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">allowAddr</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">encoderFunc</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="o">&amp;&amp;</span> <span class="nx">allowAddr</span> <span class="o">&amp;&amp;</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">PtrTo</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nf">Implements</span><span class="p">(</span><span class="nx">marshalerType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">newCondAddrEncoder</span><span class="p">(</span><span class="nx">addrMarshalerEncoder</span><span class="p">,</span> <span class="nf">newTypeEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Implements</span><span class="p">(</span><span class="nx">marshalerType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">marshalerEncoder</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="o">&amp;&amp;</span> <span class="nx">allowAddr</span> <span class="o">&amp;&amp;</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">PtrTo</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nf">Implements</span><span class="p">(</span><span class="nx">textMarshalerType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">newCondAddrEncoder</span><span class="p">(</span><span class="nx">addrTextMarshalerEncoder</span><span class="p">,</span> <span class="nf">newTypeEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Implements</span><span class="p">(</span><span class="nx">textMarshalerType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">textMarshalerEncoder</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>If the current value is a value type, can take an address and the corresponding pointer type of the value type implements the encoding/json.Marshaler interface, call encoding/json.newCondAddrEncoder to get a conditional encoder, which will reselect a new encoder when encoding/json. addrMarshalerEncoder fails to reselect a new encoder.</p>
</li>
<li>
<p>can be serialized directly using encoding/json.marshalerEncoder if the current type implements the encoding/json.Marshaler interface.</p>
</li>
</ol>
<p>TextMarshaler, except that it first determines the encoding/json.Marshaler interface, which confirms what we speculated in the Design Principles section.</p>
<p>encoding/json.newTypeEncoder will get the corresponding encoder based on the reflected type of the incoming value, including encoders for basic types such as bool, int, float, etc. and complex types such as arrays, structures, slices, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newTypeEncoder</span><span class="p">(</span><span class="nx">t</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">allowAddr</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">encoderFunc</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">switch</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Bool</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">boolEncoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int8</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int16</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int32</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int64</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">intEncoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint8</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint16</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uintptr</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">uintEncoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Float32</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">float32Encoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Float64</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">float64Encoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">String</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">stringEncoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Interface</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">interfaceEncoder</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Struct</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">newStructEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Map</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">newMapEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Slice</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">newSliceEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Array</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">newArrayEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">newPtrEncoder</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">unsupportedTypeEncoder</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We won&rsquo;t cover all the built-in type encoders here, but just a few of them to help you understand the overall design. First, let&rsquo;s look at the boolean JSON encoder, which is a very simple implementation and not even much to cover:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">boolEncoder</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">encodeState</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">encOpts</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">quoted</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Bool</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;true&#34;</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;false&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">quoted</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It will write a different string to the encoding state, i.e. true or false, depending on the current value, in addition to deciding whether to write double quotes around the boolean value depending on the encoding configuration&quot;, while all other encoders of basic types are similar.</p>
<p>Encoders for complex types have a relatively complex control structure, so we will take encoding/json.structEncoder for structures as an example to introduce their principle. encoding/json.newStructEncoder will call encoding/json.typeEncoder for all fields of the current structure. typeEncoder for all fields of the current structure and returns encoding/json.structEncoder.encode.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newStructEncoder</span><span class="p">(</span><span class="nx">t</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span> <span class="nx">encoderFunc</span> <span class="p">{</span>
	<span class="nx">se</span> <span class="o">:=</span> <span class="nx">structEncoder</span><span class="p">{</span><span class="nx">fields</span><span class="p">:</span> <span class="nf">cachedTypeFields</span><span class="p">(</span><span class="nx">t</span><span class="p">)}</span>
	<span class="k">return</span> <span class="nx">se</span><span class="p">.</span><span class="nx">encode</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can see the result of structure serialization from the implementation of encoding/json.structEncoder.encode, which iterates through all the fields in the structure, and after writing the field name, it calls the encoding method of the field&rsquo;s corresponding type to write the JSON corresponding to that field into the buffer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">se</span> <span class="nx">structEncoder</span><span class="p">)</span> <span class="nf">encode</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">encodeState</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">encOpts</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="nb">byte</span><span class="p">(</span><span class="sc">&#39;{&#39;</span><span class="p">)</span>
<span class="nx">FieldLoop</span><span class="p">:</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">se</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">list</span> <span class="p">{</span>
		<span class="nx">f</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">se</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

		<span class="nx">fv</span> <span class="o">:=</span> <span class="nx">v</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">f</span><span class="p">.</span><span class="nx">index</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">fv</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">fv</span><span class="p">.</span><span class="nf">IsNil</span><span class="p">()</span> <span class="p">{</span>
					<span class="k">continue</span> <span class="nx">FieldLoop</span>
				<span class="p">}</span>
				<span class="nx">fv</span> <span class="p">=</span> <span class="nx">fv</span><span class="p">.</span><span class="nf">Elem</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="nx">fv</span> <span class="p">=</span> <span class="nx">fv</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">omitEmpty</span> <span class="o">&amp;&amp;</span> <span class="nf">isEmptyValue</span><span class="p">(</span><span class="nx">fv</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
		<span class="nx">next</span> <span class="p">=</span> <span class="sc">&#39;,&#39;</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">nameNonEsc</span><span class="p">)</span>
		<span class="nx">opts</span><span class="p">.</span><span class="nx">quoted</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">quoted</span>
		<span class="nx">f</span><span class="p">.</span><span class="nf">encoder</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">fv</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">next</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;{}&#34;</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="sc">&#39;}&#39;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The implementation principle of encoders such as arrays and pointers is not much different from this method, as they all recursively call the encoding method holding the field using a similar strategy, which results in a tree structure as shown in the figure below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/310a3f6bfd404bc8b76c818f6e6f2f76.png" alt=""></p>
<p>After getting the encoder of the whole tree, encoding/json.encodeState.reflectValue is called from the root node and the serialization function of the whole tree is called in turn. The whole process of JSON serialization looks up the encoding methods of the types and subtypes and calls them, which makes use of a lot of reflection features to be generic enough.</p>
<h2 id="deserialization">Deserialization</h2>
<p>Unmarshal handles the deserialization of JSON. Compared to serialization where the execution is deterministic, the process of deserialization is a gradual exploration process, so it is much more complex and the overhead is several times higher. Because of the limited expressiveness of the Go language, the use of deserialization is relatively cumbersome, so a variable needs to be passed in to help the standard library perform deserialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">d</span> <span class="nx">decodeState</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkValid</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">scan</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="nx">d</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nf">unmarshal</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Before actually performing the deserialization, we will call encoding/json.checkValid to verify the legitimacy of the incoming JSON to ensure that no syntax errors are encountered during the deserialization process. unmarshal to start the deserialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">unmarshal</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">rv</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">rv</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="o">||</span> <span class="nx">rv</span><span class="p">.</span><span class="nf">IsNil</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">InvalidUnmarshalError</span><span class="p">{</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">v</span><span class="p">)}</span>
	<span class="p">}</span>
	<span class="nx">d</span><span class="p">.</span><span class="nx">scan</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
	<span class="nx">d</span><span class="p">.</span><span class="nf">scanWhile</span><span class="p">(</span><span class="nx">scanSkipSpace</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">value</span><span class="p">(</span><span class="nx">rv</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nf">addErrorContext</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">savedError</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If the value passed in is not a pointer or is a null pointer, the current method will return the error we often see encoding/json.InvalidUnmarshalError, which can be converted to &ldquo;json: Unmarshal(non-pointer xxx)&rdquo; using formatted output . The encoding/json.decodeState.value called by this method is the execution entry point for all deserialization processes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">value</span><span class="p">(</span><span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="p">{</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">scanBeginArray</span><span class="p">:</span>
		<span class="o">...</span>
	<span class="k">case</span> <span class="nx">scanBeginLiteral</span><span class="p">:</span>
		<span class="o">...</span>
	<span class="k">case</span> <span class="nx">scanBeginObject</span><span class="p">:</span>
		<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">IsValid</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">object</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">skip</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="nx">d</span><span class="p">.</span><span class="nf">scanNext</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This method, as the top-level deserialization method, can receive three different types of values, that is, arrays, literals and objects, all three types can be used as the top-level object of JSON, let&rsquo;s first understand how the standard library parses the objects in JSON, the process will use encoding/json.decodeState.object for deserialization. which first calls encoding/json.indirect to find the non-pointer type corresponding to the current type: encoding/json.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">object</span><span class="p">(</span><span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">ut</span><span class="p">,</span> <span class="nx">pv</span> <span class="o">:=</span> <span class="nf">indirect</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">u</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">start</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">()</span>
		<span class="nx">d</span><span class="p">.</span><span class="nf">skip</span><span class="p">()</span>
		<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nf">UnmarshalJSON</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">start</span><span class="p">:</span><span class="nx">d</span><span class="p">.</span><span class="nx">off</span><span class="p">])</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>During the call to encoding/json.indirect, if the current value is of type **Type, it will check if the types **Type, *Type and Type in turn implement the encoding/json.Unmarshal or encoding. interface; if it does, the standard library will call UnmarshalJSON directly to complete the deserialization using a developer-defined method.</p>
<p>In other cases, we still fall back to the default logic for handling key-value pairs in objects, as shown in the code below, which calls encoding/json.decodeState.rescanLiteral to scan the JSON for keys and find the reflected value of the corresponding field in the structure, then continues to scan for symbols : and calls encoding/ json.decodeState.value to parse the corresponding value : and call encoding/json.decodeState.value to parse the corresponding value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">object</span><span class="p">(</span><span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">v</span> <span class="p">=</span> <span class="nx">pv</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span>
	<span class="nx">fields</span> <span class="p">=</span> <span class="nf">cachedTypeFields</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">start</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">()</span>
		<span class="nx">d</span><span class="p">.</span><span class="nf">rescanLiteral</span><span class="p">()</span>
		<span class="nx">item</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">start</span><span class="p">:</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">()]</span>
		<span class="nx">key</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">unquoteBytes</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">subv</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span>
		<span class="kd">var</span> <span class="nx">f</span> <span class="o">*</span><span class="nx">field</span>
		<span class="k">if</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">key</span><span class="p">)];</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">f</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">fields</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">f</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">subv</span> <span class="p">=</span> <span class="nx">v</span>
			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">f</span><span class="p">.</span><span class="nx">index</span> <span class="p">{</span>
				<span class="nx">subv</span> <span class="p">=</span> <span class="nx">subv</span><span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="o">!=</span> <span class="nx">scanObjectKey</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">d</span><span class="p">.</span><span class="nf">scanWhile</span><span class="p">(</span><span class="nx">scanSkipSpace</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">value</span><span class="p">(</span><span class="nx">subv</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="o">==</span> <span class="nx">scanEndObject</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When the above method calls encoding/json.decodeState.value, the method re-determines whether the value corresponding to the key is an object, an array or a literal, because arrays and objects are collection types, so the method scans them recursively. how they are processed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">value</span><span class="p">(</span><span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="p">{</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>

	<span class="k">case</span> <span class="nx">scanBeginArray</span><span class="p">:</span>
		<span class="o">...</span>
	<span class="k">case</span> <span class="nx">scanBeginObject</span><span class="p">:</span>
		<span class="o">...</span>
	<span class="k">case</span> <span class="nx">scanBeginLiteral</span><span class="p">:</span>
		<span class="nx">start</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">()</span>
		<span class="nx">d</span><span class="p">.</span><span class="nf">rescanLiteral</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">IsValid</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">literalStore</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">start</span><span class="p">:</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">()],</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The literal is scanned by encoding/json.decodeState.rescanLiteral, which sequentially scans the buffer for characters and slices the string according to the characters, somewhat like a compiler&rsquo;s lexical analysis:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">rescanLiteral</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">data</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">off</span>
<span class="nx">Switch</span><span class="p">:</span>
	<span class="k">switch</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">:</span> <span class="c1">// string
</span><span class="c1"></span>		<span class="o">...</span>
	<span class="k">case</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">:</span> <span class="c1">// number
</span><span class="c1"></span>		<span class="o">...</span>
	<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="p">:</span> <span class="c1">// true
</span><span class="c1"></span>		<span class="nx">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#34;rue&#34;</span><span class="p">)</span>
	<span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="p">:</span> <span class="c1">// false
</span><span class="c1"></span>		<span class="nx">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#34;alse&#34;</span><span class="p">)</span>
	<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="p">:</span> <span class="c1">// null
</span><span class="c1"></span>		<span class="nx">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#34;ull&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="p">=</span> <span class="nf">stateEndValue</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">.</span><span class="nx">scan</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">d</span><span class="p">.</span><span class="nx">opcode</span> <span class="p">=</span> <span class="nx">scanEnd</span>
	<span class="p">}</span>
	<span class="nx">d</span><span class="p">.</span><span class="nx">off</span> <span class="p">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Because JSON literals are actually only strings, numbers, booleans, and nulls, the implementation of this method is not particularly complicated, because after the method scans for the corresponding literal, it calls encoding/json.decodeState. SetInt, reflect.Value.SetFloat and reflect.Value.SetBool methods are called in the process.</p>
<h2 id="summary">Summary</h2>
<p>JSON itself is a tree-like data structure that follows a top-down encoding and decoding process, whether serialized or deserialized, using a recursive approach to JSON objects. JSON as a standard library provides a very simple interface, and although its performance has been criticized by developers, it provides good generality as a framework. By analyzing the JSON library implementation, we can also learn from it various ways to use reflection.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/golang-net-http/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Principles of the Go language HTTP standard library implementation</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/golang-plugin/">
            <span class="next-text nav-default">Dynamic libraries and plug-in system for Go language</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
