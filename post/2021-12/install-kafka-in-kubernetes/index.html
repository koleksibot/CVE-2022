<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deploying Kafka on a Kubernetes cluster - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Recently, when I was testing log collection, I found that Elasticsearch was a bit overwhelmed by the volume of log data, and the optimization of ES might not be completed overnight, so I planned to add an intermediate layer to export the logs to Kafka, and then consume the logs from Kafka via Logstash and deposit them into Elasticsearch. There is no Kafka cluster in the test environment, so let&amp;rsquo;s" /><meta name="keywords" content="Kafka, K8s" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/install-kafka-in-kubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Deploying Kafka on a Kubernetes cluster" />
<meta property="og:description" content="Recently, when I was testing log collection, I found that Elasticsearch was a bit overwhelmed by the volume of log data, and the optimization of ES might not be completed overnight, so I planned to add an intermediate layer to export the logs to Kafka, and then consume the logs from Kafka via Logstash and deposit them into Elasticsearch. There is no Kafka cluster in the test environment, so let&rsquo;s" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/install-kafka-in-kubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-11T14:59:23+08:00" />
<meta property="article:modified_time" content="2021-12-11T14:59:23+08:00" />

<meta itemprop="name" content="Deploying Kafka on a Kubernetes cluster">
<meta itemprop="description" content="Recently, when I was testing log collection, I found that Elasticsearch was a bit overwhelmed by the volume of log data, and the optimization of ES might not be completed overnight, so I planned to add an intermediate layer to export the logs to Kafka, and then consume the logs from Kafka via Logstash and deposit them into Elasticsearch. There is no Kafka cluster in the test environment, so let&rsquo;s"><meta itemprop="datePublished" content="2021-12-11T14:59:23+08:00" />
<meta itemprop="dateModified" content="2021-12-11T14:59:23+08:00" />
<meta itemprop="wordCount" content="1499">
<meta itemprop="keywords" content="kafka,kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploying Kafka on a Kubernetes cluster"/>
<meta name="twitter:description" content="Recently, when I was testing log collection, I found that Elasticsearch was a bit overwhelmed by the volume of log data, and the optimization of ES might not be completed overnight, so I planned to add an intermediate layer to export the logs to Kafka, and then consume the logs from Kafka via Logstash and deposit them into Elasticsearch. There is no Kafka cluster in the test environment, so let&rsquo;s"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deploying Kafka on a Kubernetes cluster</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-11 14:59:23 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1499 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, when I was testing log collection, I found that Elasticsearch was a bit overwhelmed by the volume of log data, and the optimization of ES might not be completed overnight, so I planned to add an intermediate layer to export the logs to Kafka, and then consume the logs from Kafka via Logstash and deposit them into Elasticsearch. There is no Kafka cluster in the test environment, so let&rsquo;s build a Kafka cluster in the test environment first.</p>
<p>The relevant environment versions used in this article are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl version
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;14&#34;</span>, GitVersion:<span class="s2">&#34;v1.14.2&#34;</span>, GitCommit:<span class="s2">&#34;66049e3b21efe110454d67df4fa62b08ea79a19b&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2019-05-16T18:55:03Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.12.5&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;darwin/amd64&#34;</span><span class="o">}</span>
Server Version: version.Info<span class="o">{</span>Major:<span class="s2">&#34;1&#34;</span>, Minor:<span class="s2">&#34;16&#34;</span>, GitVersion:<span class="s2">&#34;v1.16.2&#34;</span>, GitCommit:<span class="s2">&#34;c97fe5036ef3df2967d086711e6c0c405941e14b&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, BuildDate:<span class="s2">&#34;2019-10-15T19:09:08Z&#34;</span>, GoVersion:<span class="s2">&#34;go1.12.10&#34;</span>, Compiler:<span class="s2">&#34;gc&#34;</span>, Platform:<span class="s2">&#34;linux/amd64&#34;</span><span class="o">}</span>
$ helm version
version.BuildInfo<span class="o">{</span>Version:<span class="s2">&#34;v3.0.1&#34;</span>, GitCommit:<span class="s2">&#34;7c22ef9ce89e0ebeb7125ba2ebf7d421f3e82ffa&#34;</span>, GitTreeState:<span class="s2">&#34;clean&#34;</span>, GoVersion:<span class="s2">&#34;go1.13.4&#34;</span><span class="o">}</span>
$ <span class="c1"># kafka helm chart åŒ…ç‰ˆæœ¬ä¸ºï¼škafka-0.20.8.tgz</span>
</code></pre></td></tr></table>
</div>
</div><p>Again, for simplicity, we use Helm3 to install Kafka, and first we need to add an <code>incubator</code> repository address, since the stable repository does not have a suitable Chart package for Kafka.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm repo add incubator http://mirror.azure.cn/kubernetes/charts-incubator/
$ helm repo update
Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
...Successfully got an update from the <span class="s2">&#34;incubator&#34;</span> chart repository
...Successfully got an update from the <span class="s2">&#34;stable&#34;</span> chart repository
Update Complete. âˆ Happy Helming!âˆ 
</code></pre></td></tr></table>
</div>
</div><p>Download Kafka&rsquo;s Helm Chart package locally, which will help us understand how to use the Chart package, or you can skip this step.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm fetch incubator/kafka
$ ls kafka-0.20.8.tgz 
$ tar -xvf kafka-0.20.8.tgz
</code></pre></td></tr></table>
</div>
</div><p>Then create a new file called kafka-test.yaml with the following contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">200m</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1536Mi</span><span class="w">
</span><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1024Mi</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rook-ceph-block&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Since kafka is slow when it first starts, try to set the initialization time of the health check longer, we set it to <code>livenessProbe.initialDelaySeconds=60</code>, the resource declaration can be declared according to the actual situation of our cluster, and finally if you need to persist kafka data, you also need to provide A StorageClass, we also know that kafka&rsquo;s IO requirements for disk itself is also very high, so it is best to use Local PV, we use here is a ceph rbd StorageClass resource object: (storageclass.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rook-ceph-block</span><span class="w">
</span><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">rook-ceph.rbd.csi.ceph.com</span><span class="w">
</span><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># clusterID æ˜¯ rook é›†ç¾¤è¿è¡Œçš„å‘½åç©ºé—´</span><span class="w">
</span><span class="w">    </span><span class="nt">clusterID</span><span class="p">:</span><span class="w"> </span><span class="l">rook-ceph</span><span class="w">
</span><span class="w">    </span><span class="c"># æŒ‡å®šå­˜å‚¨æ± </span><span class="w">
</span><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-test-pool</span><span class="w">
</span><span class="w">    </span><span class="c"># RBD image (å®é™…çš„å­˜å‚¨ä»‹è´¨) æ ¼å¼. é»˜è®¤ä¸º &#34;2&#34;.</span><span class="w">
</span><span class="w">    </span><span class="nt">imageFormat</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="w">    </span><span class="c"># RBD image ç‰¹æ€§. CSI RBD ç°åœ¨åªæ”¯æŒ `layering` .</span><span class="w">
</span><span class="w">    </span><span class="nt">imageFeatures</span><span class="p">:</span><span class="w"> </span><span class="l">layering</span><span class="w">
</span><span class="w">    </span><span class="c"># Ceph ç®¡ç†å‘˜è®¤è¯ä¿¡æ¯ï¼Œè¿™äº›éƒ½æ˜¯åœ¨ clusterID å‘½åç©ºé—´ä¸‹é¢è‡ªåŠ¨ç”Ÿæˆçš„</span><span class="w">
</span><span class="w">    </span><span class="nt">csi.storage.k8s.io/provisioner-secret-name</span><span class="p">:</span><span class="w"> </span><span class="l">rook-csi-rbd-provisioner</span><span class="w">
</span><span class="w">    </span><span class="nt">csi.storage.k8s.io/provisioner-secret-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">rook-ceph</span><span class="w">
</span><span class="w">    </span><span class="nt">csi.storage.k8s.io/node-stage-secret-name</span><span class="p">:</span><span class="w"> </span><span class="l">rook-csi-rbd-node</span><span class="w">
</span><span class="w">    </span><span class="nt">csi.storage.k8s.io/node-stage-secret-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">rook-ceph</span><span class="w">
</span><span class="w">    </span><span class="c"># æŒ‡å®š volume çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ï¼Œå¦‚æœä¸æŒ‡å®š, csi-provisioner ä¼šé»˜è®¤è®¾ç½®ä¸º `ext4`</span><span class="w">
</span><span class="w">    </span><span class="nt">csi.storage.k8s.io/fstype</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The specific storage solution needs to be selected according to our own actual situation, I use the Rook built Ceph here, relatively simple to use.</p>
<p>Once the custom values file is ready, you can use Helm to install it directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl create ns kafka
$ helm install -f kafka.yaml kfk incubator/kafka --namespace kafka
NAME: kfk
LAST DEPLOYED: Tue Mar <span class="m">17</span> 11:49:51 <span class="m">2020</span>
NAMESPACE: kafka
STATUS: deployed
REVISION: <span class="m">1</span>
NOTES:
<span class="c1">### Connecting to Kafka from inside Kubernetes</span>

You can connect to Kafka by running a simple pod in the K8s cluster like this with a configuration like this:

  apiVersion: v1
  kind: Pod
  metadata:
    name: testclient
    namespace: kafka
  spec:
    containers:
    - name: kafka
      image: confluentinc/cp-kafka:5.0.1
      command:
        - sh
        - -c
        - <span class="s2">&#34;exec tail -f /dev/null&#34;</span>

Once you have the testclient pod above running, you can list all kafka
topics with:

  kubectl -n kafka <span class="nb">exec</span> testclient -- kafka-topics --zookeeper kfk-zookeeper:2181 --list

To create a new topic:

  kubectl -n kafka <span class="nb">exec</span> testclient -- kafka-topics --zookeeper kfk-zookeeper:2181 --topic test1 --create --partitions <span class="m">1</span> --replication-factor <span class="m">1</span>

To listen <span class="k">for</span> messages on a topic:

  kubectl -n kafka <span class="nb">exec</span> -ti testclient -- kafka-console-consumer --bootstrap-server kfk-kafka:9092 --topic test1 --from-beginning

To stop the listener session above press: Ctrl+C

To start an interactive message producer session:
  kubectl -n kafka <span class="nb">exec</span> -ti testclient -- kafka-console-producer --broker-list kfk-kafka-headless:9092 --topic test1

To create a message in the above session, simply <span class="nb">type</span> the message and press <span class="s2">&#34;enter&#34;</span>
To end the producer session try: Ctrl+C

If you specify <span class="s2">&#34;zookeeper.connect&#34;</span> in configurationOverrides, please replace <span class="s2">&#34;kfk-zookeeper:2181&#34;</span> with the value of <span class="s2">&#34;zookeeper.connect&#34;</span>, or you will get error.
</code></pre></td></tr></table>
</div>
</div><p>After successful installation, you can check the status of the Release.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ helm ls -n kafka
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
kfk     kafka           <span class="m">1</span>               2020-03-17 14:50:41.595746 +0800 CST    deployed        kafka-0.20.8    5.0.1  
</code></pre></td></tr></table>
</div>
</div><p>A cluster of 3 instances of kafka and zookeeper is normally deployed every now and then.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get pods -n kafka
NAME              READY   STATUS    RESTARTS   AGE
kfk-kafka-0       1/1     Running   <span class="m">0</span>          3h52m
kfk-kafka-1       1/1     Running   <span class="m">0</span>          3h50m
kfk-kafka-2       1/1     Running   <span class="m">0</span>          3h48m
kfk-zookeeper-0   1/1     Running   <span class="m">0</span>          3h55m
kfk-zookeeper-1   1/1     Running   <span class="m">0</span>          3h54m
kfk-zookeeper-2   1/1     Running   <span class="m">0</span>          3h54m
</code></pre></td></tr></table>
</div>
</div><p>After deployment, create a test client to test if the kafka cluster is working: (testclient.yaml)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">testclient</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kafka</span><span class="w">
</span><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">confluentinc/cp-kafka:5.0.1</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">sh</span><span class="w">
</span><span class="w">        </span>- -<span class="l">c</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;exec tail -f /dev/null&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>It is also straightforward to deploy the resource objects above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">$ kubectl apply -f testclient.yaml
$ kubectl get pods -n kafka
NAME              READY   STATUS    RESTARTS   AGE
testclient        1/1     Running   0          3h44m
......
</code></pre></td></tr></table>
</div>
</div><p>After the test client is created, create a new topic with the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl -n kafka <span class="nb">exec</span> testclient -- kafka-topics --zookeeper kfk-zookeeper:2181 --topic test1 --create --partitions <span class="m">1</span> --replication-factor <span class="m">1</span>
Created topic <span class="s2">&#34;test1&#34;</span>.
</code></pre></td></tr></table>
</div>
</div><p>You can see that the topic <code>test1</code> was created successfully. Then you can run the following command to listen for messages from the topic <code>test1</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl -n kafka <span class="nb">exec</span> -ti testclient -- kafka-console-consumer --bootstrap-server kfk-kafka:9092 --topic test1 --from-beginning
</code></pre></td></tr></table>
</div>
</div><p>Then open a new command line terminal to generate a message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl -n kafka <span class="nb">exec</span> -ti testclient -- kafka-console-producer --broker-list kfk-kafka-headless:9092 --topic test1
&gt;Hello kafka on k8s
&gt;
</code></pre></td></tr></table>
</div>
</div><p>At this time, you can see the corresponding message log in the listener of the topic test1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ kubectl -n kafka <span class="nb">exec</span> -ti testclient -- kafka-console-consumer --bootstrap-server kfk-kafka:9092 --topic test1 --from-beginning
Hello kafka on k8s
</code></pre></td></tr></table>
</div>
</div><p>This shows that our kafka deployment has successfully run on top of a Kubernetes cluster. Of course, we are only using it in a test environment, and there are many things to consider about whether you can deploy kafka on a Kubernetes cluster in a production environment, and it is more recommended to use an Operator for stateful applications, such as <a href="https://www.confluent.io/confluent-operator/">Confluent&rsquo;s Kafka Operator</a>, in short, it doesn&rsquo;t matter if you can hold it, just use it ğŸ¤£</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kafka/">kafka</a>
          <a href="/tags/kubernetes/">kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/k8s-ui-kubevious/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes Dashboard with Time Machine - Kubevious</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/grafana-k8s-plugin-kubegraf/">
            <span class="next-text nav-default">Excellent Grafana K8S Plugin - DevOpsProdigy KubeGraf</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
