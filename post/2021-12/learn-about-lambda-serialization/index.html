<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Serialization of Lambda expressions in the JDK and the clever use of SerializedLambda - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I want to Javassist as the core JDBC-based Javassist in my free time to write a set of lightweight ORM framework to abandon reflection calls, the process of reading mybatis, tk-mapper, mybatis-plus and spring-boot-starter-jdbc source code. Among them, I found that the LambdaQueryWrapper in mybatis-plus can get the method information (actually CallSite information) of the currently called Lambda expression, so here is a complete record. This article is based on" /><meta name="keywords" content="java, Lambda, Serialization" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/learn-about-lambda-serialization/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Serialization of Lambda expressions in the JDK and the clever use of SerializedLambda" />
<meta property="og:description" content="I want to Javassist as the core JDBC-based Javassist in my free time to write a set of lightweight ORM framework to abandon reflection calls, the process of reading mybatis, tk-mapper, mybatis-plus and spring-boot-starter-jdbc source code. Among them, I found that the LambdaQueryWrapper in mybatis-plus can get the method information (actually CallSite information) of the currently called Lambda expression, so here is a complete record. This article is based on" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/learn-about-lambda-serialization/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-14T15:49:05+08:00" />
<meta property="article:modified_time" content="2021-12-14T15:49:05+08:00" />

<meta itemprop="name" content="Serialization of Lambda expressions in the JDK and the clever use of SerializedLambda">
<meta itemprop="description" content="I want to Javassist as the core JDBC-based Javassist in my free time to write a set of lightweight ORM framework to abandon reflection calls, the process of reading mybatis, tk-mapper, mybatis-plus and spring-boot-starter-jdbc source code. Among them, I found that the LambdaQueryWrapper in mybatis-plus can get the method information (actually CallSite information) of the currently called Lambda expression, so here is a complete record. This article is based on"><meta itemprop="datePublished" content="2021-12-14T15:49:05+08:00" />
<meta itemprop="dateModified" content="2021-12-14T15:49:05+08:00" />
<meta itemprop="wordCount" content="2446">
<meta itemprop="keywords" content="java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Serialization of Lambda expressions in the JDK and the clever use of SerializedLambda"/>
<meta name="twitter:description" content="I want to Javassist as the core JDBC-based Javassist in my free time to write a set of lightweight ORM framework to abandon reflection calls, the process of reading mybatis, tk-mapper, mybatis-plus and spring-boot-starter-jdbc source code. Among them, I found that the LambdaQueryWrapper in mybatis-plus can get the method information (actually CallSite information) of the currently called Lambda expression, so here is a complete record. This article is based on"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Serialization of Lambda expressions in the JDK and the clever use of SerializedLambda</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-14 15:49:05 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2446 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#magical-lambda-expression-serialization">Magical Lambda expression serialization</a></li>
        <li><a href="#lambda-expressions-serialization-principle">Lambda expressions serialization principle</a></li>
        <li><a href="#get-serializedlambdas-way">Get SerializedLambda&rsquo;s way</a></li>
        <li><a href="#the-forgotten-deserializelambda-method">The forgotten $deserializeLambda$ method</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I want to Javassist as the core JDBC-based Javassist in my free time to write a set of lightweight ORM framework to abandon reflection calls, the process of reading mybatis, tk-mapper, mybatis-plus and spring-boot-starter-jdbc source code. Among them, I found that the LambdaQueryWrapper in mybatis-plus can get the method information (actually CallSite information) of the currently called Lambda expression, so here is a complete record. This article is based on JDK11, other versions of JDK may not be suitable.</p>
<h2 id="magical-lambda-expression-serialization">Magical Lambda expression serialization</h2>
<p>When I was looking at the source code implementation of Lambda expressions, I didn&rsquo;t look at the comments of LambdaMetafactory, and one of the many comments at the top of this class is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/37df00e6d8ee46f4a912e0c1e9a2239f.png" alt=""></p>
<p>Search for FLAG_SERIALIZABLE again in the comments of LambdaMetafactory and you can see this comment.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/52042372a5734f5d95b0d501592b11d7.png" alt=""></p>
<p>To wit: the function object instances generated after setting the FLAG_SERIALIZABLE flag will implement the Serializable interface, and a method with the name writeReplace will exist with a return value of type SerializedLambda. the methods that call these function objects (the previously mentioned &ldquo;capture class&rdquo;) of the caller must exist for a method with the name $deserializeLambda$, as described by the SerializedLambda class.</p>
<p>Finally, looking at the description of SerializedLambda, the annotation has four major paragraphs, which are posted here and extract the core information per small paragraph.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/28e26a629466400c95ac17959735c323.png" alt=""></p>
<p>The general idea of each paragraph is as follows.</p>
<ul>
<li>Paragraph 1: SerializedLambda is the serialized form of a Lambda expression; this class stores the runtime information of the Lambda expression</li>
<li>Paragraph 2: To ensure that the serialization of a Lambda expression is implemented correctly, one option available to the compiler or language library is to ensure that the writeReplace method returns a SerializedLambda instance</li>
<li>Paragraph 3: SerializedLambda provides a readResolve method that functions similarly to calling the static method $deserializeLambda$(SerializedLambda) in the &ldquo;capture class&rdquo; and using its own instance as an input, which is understood as a deserialization process</li>
<li>Paragraph 4: The identity-sensitive operations of the serialized and deserialized function objects in the form of identifiers (such as System.identityHashCode(), object locking, etc.) are unpredictable.</li>
</ul>
<p>The ultimate conclusion is that if a functional interface implements the Serializable interface, then its instance automatically generates a writeReplace method that returns a SerializedLambda instance from which the runtime information of the functional interface can be retrieved. This runtime information is the property of SerializedLambda.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>capturingClass</td>
<td>&ldquo;Capture class&rdquo;, the class in which the current Lambda expression appears</td>
</tr>
<tr>
<td>functionalInterfaceClass</td>
<td>name, and separated by &ldquo;/&rdquo;, the static type of the returned Lambda object</td>
</tr>
<tr>
<td>functionalInterfaceMethodName</td>
<td>Functional interface method names</td>
</tr>
<tr>
<td>functionalInterfaceMethodSignature</td>
<td>Functional interface method signature (actually the parameter type and return value type, or the type after erasure if a generic type is used)</td>
</tr>
<tr>
<td>implClass</td>
<td>Name, and separated by &ldquo;/&rdquo;, holding the type of the implementation method of the functional interface method (the implementation class that implements the functional interface method)</td>
</tr>
<tr>
<td>implMethodName</td>
<td>Implementation method names for functional interface methods</td>
</tr>
<tr>
<td>implMethodSignature</td>
<td>Method signature of the implementation method of the functional interface method (the real is the parameter type and return value type)</td>
</tr>
<tr>
<td>instantiatedMethodType</td>
<td>Functional interface types after replacement with instance type variables</td>
</tr>
<tr>
<td>capturedArgs</td>
<td>Dynamic parameters captured by Lambda</td>
</tr>
<tr>
<td>implMethodKind</td>
<td>Implement the MethodHandle type of the method</td>
</tr>
</tbody>
</table>
<p>As a practical example, define a functional interface that implements Serializable and call it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerFunction</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="n">T</span> <span class="nf">convert</span><span class="o">(</span><span class="n">S</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">CustomerFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">function</span> <span class="o">=</span> <span class="n">Long</span><span class="o">::</span><span class="n">parseLong</span><span class="o">;</span>
        <span class="n">Long</span> <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="s">&#34;123&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;writeReplace&#34;</span><span class="o">);</span>
        <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">SerializedLambda</span> <span class="n">serializedLambda</span> <span class="o">=</span> <span class="o">(</span><span class="n">SerializedLambda</span><span class="o">)</span><span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">function</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">serializedLambda</span><span class="o">.</span><span class="na">getCapturingClass</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The executed DEBUG message is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/87b57d974e49402d94f7f449c5b9464b.png" alt=""></p>
<p>This gives access to the call point runtime information of the functional interface instance when the method is called, and even the type of the generic parameter before it is erased, then many tricks can be derived. For example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConditionApp</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerFunction</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="n">T</span> <span class="nf">convert</span><span class="o">(</span><span class="n">S</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Data</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">site</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Condition</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">addCondition</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span> <span class="s">&#34;=&#34;</span><span class="o">,</span> <span class="s">&#34;throwable&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;c1 = &#34;</span> <span class="o">+</span> <span class="n">c1</span><span class="o">);</span>
        <span class="n">Condition</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">addCondition</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getSite</span><span class="o">,</span> <span class="s">&#34;IN&#34;</span><span class="o">,</span> <span class="s">&#34;(&#39;throwx.cn&#39;,&#39;vlts.cn&#39;)&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;c1 = &#34;</span> <span class="o">+</span> <span class="n">c2</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span> <span class="n">Condition</span> <span class="nf">addCondition</span><span class="o">(</span><span class="n">CustomerFunction</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">function</span><span class="o">,</span>
                                              <span class="n">String</span> <span class="n">operation</span><span class="o">,</span>
                                              <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Condition</span><span class="o">();</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;writeReplace&#34;</span><span class="o">);</span>
        <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">SerializedLambda</span> <span class="n">serializedLambda</span> <span class="o">=</span> <span class="o">(</span><span class="n">SerializedLambda</span><span class="o">)</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">function</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">implMethodName</span> <span class="o">=</span> <span class="n">serializedLambda</span><span class="o">.</span><span class="na">getImplMethodName</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">idx</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">idx</span> <span class="o">=</span> <span class="n">implMethodName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">&#34;get&#34;</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">condition</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">implMethodName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">3</span><span class="o">))</span> <span class="o">+</span> <span class="n">implMethodName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">4</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">condition</span><span class="o">.</span><span class="na">setEntityKlass</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">serializedLambda</span><span class="o">.</span><span class="na">getImplClass</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="s">&#34;.&#34;</span><span class="o">)));</span>
        <span class="n">condition</span><span class="o">.</span><span class="na">setOperation</span><span class="o">(</span><span class="n">operation</span><span class="o">);</span>
        <span class="n">condition</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">condition</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Data</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Condition</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">entityKlass</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">field</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">operation</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 执行结果
</span><span class="c1"></span><span class="n">c1</span> <span class="o">=</span> <span class="n">ConditionApp</span><span class="o">.</span><span class="na">Condition</span><span class="o">(</span><span class="n">entityKlass</span><span class="o">=</span><span class="kd">class</span> <span class="nc">club</span><span class="o">.</span><span class="na">throwable</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">ConditionApp$User</span><span class="o">,</span> <span class="n">field</span><span class="o">=</span><span class="n">name</span><span class="o">,</span> <span class="n">operation</span><span class="o">==,</span> <span class="n">value</span><span class="o">=</span><span class="n">throwable</span><span class="o">)</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">ConditionApp</span><span class="o">.</span><span class="na">Condition</span><span class="o">(</span><span class="n">entityKlass</span><span class="o">=</span><span class="kd">class</span> <span class="nc">club</span><span class="o">.</span><span class="na">throwable</span><span class="o">.</span><span class="na">lambda</span><span class="o">.</span><span class="na">ConditionApp$User</span><span class="o">,</span> <span class="n">field</span><span class="o">=</span><span class="n">site</span><span class="o">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">IN</span><span class="o">,</span> <span class="n">value</span><span class="o">=(</span><span class="err">&#39;</span><span class="n">throwx</span><span class="o">.</span><span class="na">cn</span><span class="sc">&#39;,&#39;</span><span class="n">vlts</span><span class="o">.</span><span class="na">cn</span><span class="err">&#39;</span><span class="o">))</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Many people will worry about the performance of reflection calls, in fact, in high versions of the JDK, reflection performance has been greatly optimized, very close to the performance of direct calls, not to mention that some scenarios are a small number of reflection calls scenario, you can use with confidence.</p>
</blockquote>
<p>Having spent a lot of time showing the functionality and use of SerializedLambda, let&rsquo;s look at serialization and deserialization of Lambda expressions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializedLambdaApp</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomRunnable</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">invoke</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">CustomRunnable</span> <span class="n">customRunnable</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">customRunnable</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()));</span>
        <span class="n">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The results are shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/c264182392564017a8c163472c7fa94d.png" alt=""></p>
<h2 id="lambda-expressions-serialization-principle">Lambda expressions serialization principle</h2>
<p>Regarding the principle of Lambda expression serialization, you can directly refer to the source code of ObjectStreamClass, ObjectOutputStream and ObjectInputStream, and here is the direct conclusion.</p>
<ul>
<li>prerequisite: the object to be serialized needs to implement the Serializable interface</li>
<li>to be serialized object if there is writeReplace method, then directly based on the incoming instance reflection call this method to get the return value type as the target type of serialization, for Lambda expressions is SerializedLambda type</li>
<li>The process of deserialization happens to be the process of reversal, and the method called is readResolve, which happens to have a private method of the same name as mentioned earlier for SerializedLambda</li>
<li>The implementation type of the Lambda expression is the VM-generated template class, and as observed from the result, the instance before serialization and the instance obtained after deserialization belong to different template classes, for the example in the previous subsection the template class before serialization in the result of a certain run is club.throwable.lambda.SerializedLambdaApp$$ Lambda$$14/0x0000000800065840, and after deserialization the template class is club.throwable.lambda.SerializedLambdaApp$$Lambda$$26/0x00000008000a4040</li>
</ul>
<blockquote>
<p>ObjectStreamClass is the class descriptor for serialization and deserialization implementations. Information about the class descriptor for object serialization and deserialization can be found in the member properties of this class, such as the writeReplace and readResolve methods mentioned here</p>
</blockquote>
<p>The graphical process is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/14/616d2b207a294c19998aa3ca0a9833f7.png" alt=""></p>
<h2 id="get-serializedlambdas-way">Get SerializedLambda&rsquo;s way</h2>
<p>From the previous analysis, it is known that there are two ways to obtain a SerializedLambda instance of a Lambda expression.</p>
<ul>
<li>Way 1: Call the writeReplace method based on the reflection of the Lambda expression instance and the template class of the Lambda expression, and the return value obtained is the SerializedLambda instance</li>
<li>Way 2: Get SerializedLambda instance based on serialization and deserialization</li>
</ul>
<p>Based on these two ways you can write separate examples, for example the reflection way as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 反射方式
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReflectionSolution</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerFunction</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="n">T</span> <span class="nf">convert</span><span class="o">(</span><span class="n">S</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">CustomerFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">function</span> <span class="o">=</span> <span class="n">Long</span><span class="o">::</span><span class="n">parseLong</span><span class="o">;</span>
        <span class="n">SerializedLambda</span> <span class="n">serializedLambda</span> <span class="o">=</span> <span class="n">getSerializedLambda</span><span class="o">(</span><span class="n">function</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">serializedLambda</span><span class="o">.</span><span class="na">getCapturingClass</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SerializedLambda</span> <span class="nf">getSerializedLambda</span><span class="o">(</span><span class="n">Serializable</span> <span class="n">serializable</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Method</span> <span class="n">writeReplaceMethod</span> <span class="o">=</span> <span class="n">serializable</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;writeReplace&#34;</span><span class="o">);</span>
        <span class="n">writeReplaceMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">SerializedLambda</span><span class="o">)</span> <span class="n">writeReplaceMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">serializable</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The serialized and deserialized approach is slightly more complicated because the ObjectInputStream.readObject() method will end up calling back the SerializedLambda.readResolve() method, resulting in the return of a new template class hosting an instance of the Lambda expression, so here we need to find a way to interrupt this The solution is to construct a shadow type similar to SerializedLambda but without the readResolve() method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.vlts</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 这里注意一定要和java.lang.invoke.SerializedLambda同名,可以不同包名,这是为了&#34;欺骗&#34;ObjectStreamClass中有个神奇的类名称判断classNamesEqual()方法
</span><span class="cm"> */</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;ALL&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializedLambda</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">8025925345765570181L</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">capturingClass</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">functionalInterfaceClass</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">functionalInterfaceMethodName</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">functionalInterfaceMethodSignature</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">implClass</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">implMethodName</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">implMethodSignature</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">implMethodKind</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">instantiatedMethodType</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">Object</span><span class="o">[]</span> <span class="n">capturedArgs</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCapturingClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturingClass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFunctionalInterfaceClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">functionalInterfaceClass</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFunctionalInterfaceMethodName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">functionalInterfaceMethodName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getFunctionalInterfaceMethodSignature</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">functionalInterfaceMethodSignature</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getImplClass</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">implClass</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getImplMethodName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">implMethodName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getImplMethodSignature</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">implMethodSignature</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getImplMethodKind</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">implMethodKind</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">getInstantiatedMethodType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">instantiatedMethodType</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCapturedArgCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedArgs</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getCapturedArg</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">capturedArgs</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializationSolution</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomerFunction</span><span class="o">&lt;</span><span class="n">S</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="n">T</span> <span class="nf">convert</span><span class="o">(</span><span class="n">S</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">CustomerFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">function</span> <span class="o">=</span> <span class="n">Long</span><span class="o">::</span><span class="n">parseLong</span><span class="o">;</span>
        <span class="n">cn</span><span class="o">.</span><span class="na">vlts</span><span class="o">.</span><span class="na">SerializedLambda</span> <span class="n">serializedLambda</span> <span class="o">=</span> <span class="n">getSerializedLambda</span><span class="o">(</span><span class="n">function</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">serializedLambda</span><span class="o">.</span><span class="na">getCapturingClass</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">cn</span><span class="o">.</span><span class="na">vlts</span><span class="o">.</span><span class="na">SerializedLambda</span> <span class="nf">getSerializedLambda</span><span class="o">(</span><span class="n">Serializable</span> <span class="n">serializable</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
             <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">serializable</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">protected</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolveClass</span><span class="o">(</span><span class="n">ObjectStreamClass</span> <span class="n">desc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
                    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="n">desc</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">klass</span> <span class="o">==</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">invoke</span><span class="o">.</span><span class="na">SerializedLambda</span><span class="o">.</span><span class="na">class</span> <span class="o">?</span> <span class="n">cn</span><span class="o">.</span><span class="na">vlts</span><span class="o">.</span><span class="na">SerializedLambda</span><span class="o">.</span><span class="na">class</span> <span class="o">:</span> <span class="n">klass</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">})</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">(</span><span class="n">cn</span><span class="o">.</span><span class="na">vlts</span><span class="o">.</span><span class="na">SerializedLambda</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="the-forgotten-deserializelambda-method">The forgotten $deserializeLambda$ method</h2>
<p>As mentioned earlier, the deserialization of a Lambda expression instance calls the java.lang.invoke.SerializedLambda.readResolve() method, which, magically, has the following source code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">Object</span> <span class="nf">readResolve</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ReflectiveOperationException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Method</span> <span class="n">deserialize</span> <span class="o">=</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedExceptionAction</span><span class="o">&lt;&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Method</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="n">Method</span> <span class="n">m</span> <span class="o">=</span> <span class="n">capturingClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;$deserializeLambda$&#34;</span><span class="o">,</span> <span class="n">SerializedLambda</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">m</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="k">return</span> <span class="n">deserialize</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">PrivilegedActionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Exception</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">ReflectiveOperationException</span><span class="o">)</span>
            <span class="k">throw</span> <span class="o">(</span><span class="n">ReflectiveOperationException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">RuntimeException</span><span class="o">)</span>
            <span class="k">throw</span> <span class="o">(</span><span class="n">RuntimeException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Exception in SerializedLambda.readResolve&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It looks like there is a static method in the &ldquo;capture class&rdquo; that says</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">CapturingClass</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">$deserializeLambda$</span><span class="o">(</span><span class="n">SerializedLambda</span> <span class="n">serializedLambda</span><span class="o">){</span>
        <span class="k">return</span> <span class="o">[</span><span class="n">serializedLambda</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="n">Lambda表达式实例</span><span class="o">;</span>
    <span class="o">}</span>  
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can try to retrieve the list of methods in the &ldquo;capture class&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CapturingClassApp</span> <span class="o">{</span>

    <span class="nd">@FunctionalInterface</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CustomRunnable</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">invoke</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">CustomRunnable</span> <span class="n">customRunnable</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Method</span> <span class="n">writeReplaceMethod</span> <span class="o">=</span> <span class="n">customRunnable</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;writeReplace&#34;</span><span class="o">);</span>
        <span class="n">writeReplaceMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">invoke</span><span class="o">.</span><span class="na">SerializedLambda</span> <span class="n">serializedLambda</span> <span class="o">=</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">invoke</span><span class="o">.</span><span class="na">SerializedLambda</span><span class="o">)</span>
                <span class="n">writeReplaceMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">customRunnable</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">capturingClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">serializedLambda</span><span class="o">.</span><span class="na">getCapturingClass</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="s">&#34;.&#34;</span><span class="o">));</span>
        <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">doWithMethods</span><span class="o">(</span><span class="n">capturingClass</span><span class="o">,</span> <span class="n">method</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;方法名:%s,修饰符:%s,方法参数列表:%s,方法返回值类型:%s\n&#34;</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                            <span class="n">Modifier</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()),</span>
                            <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">()),</span>
                            <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                <span class="o">},</span>
                <span class="n">method</span> <span class="o">-&gt;</span> <span class="n">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&#34;$deserializeLambda$&#34;</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 执行结果
</span><span class="c1"></span><span class="nl">方法名:</span><span class="n">$deserializeLambda$</span><span class="o">,</span><span class="n">修饰符</span><span class="o">:</span><span class="kd">private</span> <span class="kd">static</span><span class="o">,</span><span class="n">方法参数列表</span><span class="o">:[</span><span class="kd">class</span> <span class="nc">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">invoke</span><span class="o">.</span><span class="na">SerializedLambda</span><span class="o">],</span><span class="n">方法返回值类型</span><span class="o">:</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span>
</code></pre></td></tr></table>
</div>
</div><p>SerializedLambda annotation description is consistent with the previously mentioned java.lang.invoke. I guess $deserializeLambda$ is a method generated by the VM and can only be called by reflection, so it is a deeper hidden trick.</p>
<h2 id="summary">Summary</h2>
<p>The Lambda expression feature in the JDK has been released for many years, and I can&rsquo;t imagine that it took so many years to figure out its serialization and deserialization methods today. Although this is not a complex problem, it is one of the more interesting points of knowledge that I have seen in recent times.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">java</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/https-ssl-tls/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Understanding HTTPS principles, SSL/TLS protocols in detail</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/resolve-coredns-hosts-invalid/">
            <span class="next-text nav-default">Resolving CoreDNS custom domain name failure issues</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
