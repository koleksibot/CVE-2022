<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Dynamic libraries and plug-in system for Go language - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Developers familiar with the Go language are generally very familiar with the principles of Goroutine and Channel, including how to design applications based on the CSP model, but the Go language&amp;rsquo;s plug-in system is a module that few people know about. With the plug-in system, we can load dynamic libraries at runtime to implement some of the more interesting features.
Design Principles The plug-in system of Go language is implemented based on C dynamic libraries, so it also inherits the advantages and disadvantages of C dynamic libraries." /><meta name="keywords" content="golang, Plugin" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-12/golang-plugin/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Dynamic libraries and plug-in system for Go language" />
<meta property="og:description" content="Developers familiar with the Go language are generally very familiar with the principles of Goroutine and Channel, including how to design applications based on the CSP model, but the Go language&rsquo;s plug-in system is a module that few people know about. With the plug-in system, we can load dynamic libraries at runtime to implement some of the more interesting features.
Design Principles The plug-in system of Go language is implemented based on C dynamic libraries, so it also inherits the advantages and disadvantages of C dynamic libraries." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-12/golang-plugin/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-04T11:23:45+08:00" />
<meta property="article:modified_time" content="2021-12-04T11:23:45+08:00" />

<meta itemprop="name" content="Dynamic libraries and plug-in system for Go language">
<meta itemprop="description" content="Developers familiar with the Go language are generally very familiar with the principles of Goroutine and Channel, including how to design applications based on the CSP model, but the Go language&rsquo;s plug-in system is a module that few people know about. With the plug-in system, we can load dynamic libraries at runtime to implement some of the more interesting features.
Design Principles The plug-in system of Go language is implemented based on C dynamic libraries, so it also inherits the advantages and disadvantages of C dynamic libraries."><meta itemprop="datePublished" content="2021-12-04T11:23:45+08:00" />
<meta itemprop="dateModified" content="2021-12-04T11:23:45+08:00" />
<meta itemprop="wordCount" content="1749">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Dynamic libraries and plug-in system for Go language"/>
<meta name="twitter:description" content="Developers familiar with the Go language are generally very familiar with the principles of Goroutine and Channel, including how to design applications based on the CSP model, but the Go language&rsquo;s plug-in system is a module that few people know about. With the plug-in system, we can load dynamic libraries at runtime to implement some of the more interesting features.
Design Principles The plug-in system of Go language is implemented based on C dynamic libraries, so it also inherits the advantages and disadvantages of C dynamic libraries."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Dynamic libraries and plug-in system for Go language</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-12-04 11:23:45 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1749 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#design-principles">Design Principles</a>
          <ul>
            <li><a href="#plug-in-systems">Plug-in systems</a></li>
            <li><a href="#operating-systems">Operating Systems</a></li>
          </ul>
        </li>
        <li><a href="#dynamic-libraries">Dynamic libraries</a>
          <ul>
            <li><a href="#cgo">CGO</a></li>
            <li><a href="#loading-process">Loading process</a></li>
            <li><a href="#symbol-lookup">Symbol lookup</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Developers familiar with the Go language are generally very familiar with the principles of Goroutine and Channel, including how to design applications based on the CSP model, but the Go language&rsquo;s plug-in system is a module that few people know about. With the plug-in system, we can load dynamic libraries at runtime to implement some of the more interesting features.</p>
<h2 id="design-principles">Design Principles</h2>
<p>The plug-in system of Go language is implemented based on C dynamic libraries, so it also inherits the advantages and disadvantages of C dynamic libraries. We will compare static libraries and dynamic libraries in Linux in this section and analyze their respective features and advantages.</p>
<ul>
<li>Static libraries or static linked libraries are composed of programs, external functions and variables determined at compilation time. The compiler or linker copies the contents of the programs and variables, etc. to the target application and generates a separate executable object file.</li>
<li>dynamic libraries or shared objects can be shared among multiple executables, and the modules used by the program are loaded from the shared objects at runtime rather than packaged into separate executables when the program is compiled.</li>
</ul>
<p>Due to the different characteristics, the advantages and disadvantages of static and dynamic libraries are also obvious; binaries that rely only on static libraries and are generated by static linking can be executed independently because they contain all the dependencies, but the compilation result is also larger; while dynamic libraries can be shared among multiple executables, which can reduce the memory footprint, and their linking process is often triggered during loading or running, so they can contain some modules that can be hot-plugged and reduce the memory footprint.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/46340e07ea914c35991df01bcae2a0cc.png" alt=""></p>
<p>Compiling binaries using static linking has very obvious deployment advantages, and the final compiled product will run directly on most machines. The deployment benefits of static linking are far more important than the lower memory footprint, so many programming languages, including Go, use static linking as the default linking method.</p>
<h3 id="plug-in-systems">Plug-in systems</h3>
<p>Today, the low memory footprint benefits of dynamic linking are no longer very useful, but the mechanism of dynamic linking can provide more flexibility in that the main program can dynamically load shared libraries after compilation to implement a hot-pluggable plugin system.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/12/04/5803d0d98f004a3bb0a28b3117a73bed.png" alt=""></p>
<p>By defining a set of conventions or interfaces directly between the main program and the shared library, we can dynamically load Go shared objects compiled by others with the following code. The advantage of this is that the developers of the main program and the shared library do not need to share code, and there is no need to recompile the main program after modifying the shared library as long as the conventions remain the same for both parties.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Driver</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;driver.so&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	   <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">newDriverSymbol</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;NewDriver&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">newDriverFunc</span> <span class="o">:=</span> <span class="nx">newDriverSymbol</span><span class="p">.(</span><span class="kd">func</span><span class="p">()</span> <span class="nx">Driver</span><span class="p">)</span>
    <span class="nx">newDriver</span> <span class="o">:=</span> <span class="nf">newDriverFunc</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">newDriver</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above code defines the Driver interface and assumes that the shared library must contain the func NewDriver() Driver function. When we read the shared library containing the Go plugin via plugin.Open, we get the NewDriver symbol in the file and convert it to the correct function type, and we can use this function to initialize the new Driver and get its name.</p>
<h3 id="operating-systems">Operating Systems</h3>
<p>Different operating systems implement different dynamic linking mechanisms and shared library formats. The shared objects in Linux use the ELF format and provide a set of interfaces to operate the dynamic linker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">void</span> <span class="o">*</span><span class="nf">dlopen</span><span class="p">(</span><span class="kd">const</span> <span class="nx">char</span> <span class="o">*</span><span class="nx">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="nx">flag</span><span class="p">);</span>
<span class="nx">char</span> <span class="o">*</span><span class="nf">dlerror</span><span class="p">(</span><span class="nx">void</span><span class="p">);</span>
<span class="nx">void</span> <span class="o">*</span><span class="nf">dlsym</span><span class="p">(</span><span class="nx">void</span> <span class="o">*</span><span class="nx">handle</span><span class="p">,</span> <span class="kd">const</span> <span class="nx">char</span> <span class="o">*</span><span class="nx">symbol</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">dlclose</span><span class="p">(</span><span class="nx">void</span> <span class="o">*</span><span class="nx">handle</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><code>dlopen</code> loads the corresponding dynamic library based on the incoming filename and returns a handle; we can search for a specific symbol, i.e. function or variable, in the handle directly using the <code>dlsym</code> function, which returns the address where the symbol was loaded into memory. Since the symbol to be searched may not exist in the target dynamic library, we should call <code>dlerror</code> after each search to see the result of the current search.</p>
<h2 id="dynamic-libraries">Dynamic libraries</h2>
<p>The full implementation of the Go language plug-in system is contained in <code>plugin</code>, a package that implements the loading and resolution of the symbol system. A plugin is a package with public functions and variables, and we need to compile the plugin using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">go build -buildmode<span class="o">=</span>plugin ...
</code></pre></td></tr></table>
</div>
</div><p>This command generates a shared object .so file, which when loaded into the Go program is represented by the following structure plugin.Plugin, which contains information such as the path to the file and the symbols it contains.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Plugin</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">pluginpath</span> <span class="kt">string</span>
	<span class="nx">syms</span>       <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The two core methods related to the plugin system are plugin.Open for loading shared files and plugin.Plugin.Lookup for finding symbols in plugins.</p>
<h3 id="cgo">CGO</h3>
<p>Before analyzing the public methods in the plugin package, we need to understand the two C functions plugin.pluginOpen and plugin.pluginLookup used in the package; plugin.pluginOpen simply wraps the dlopen and dlerror functions from the standard library and returns a handle to the dynamic library when After a successful load, it returns a handle to the dynamic library.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">static</span> <span class="nx">uintptr_t</span> <span class="nf">pluginOpen</span><span class="p">(</span><span class="kd">const</span> <span class="nx">char</span><span class="o">*</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">char</span><span class="o">**</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">void</span><span class="o">*</span> <span class="nx">h</span> <span class="p">=</span> <span class="nf">dlopen</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">RTLD_NOW</span><span class="p">|</span><span class="nx">RTLD_GLOBAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">==</span> <span class="nx">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="nx">err</span> <span class="p">=</span> <span class="p">(</span><span class="nx">char</span><span class="o">*</span><span class="p">)</span><span class="nf">dlerror</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nx">uintptr_t</span><span class="p">)</span><span class="nx">h</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>plugin.pluginLookup uses dlsym and dlerror from the standard library to get specific symbols in dynamic library handles.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">static</span> <span class="nx">void</span><span class="o">*</span> <span class="nf">pluginLookup</span><span class="p">(</span><span class="nx">uintptr_t</span> <span class="nx">h</span><span class="p">,</span> <span class="kd">const</span> <span class="nx">char</span><span class="o">*</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">char</span><span class="o">**</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">void</span><span class="o">*</span> <span class="nx">r</span> <span class="p">=</span> <span class="nf">dlsym</span><span class="p">((</span><span class="nx">void</span><span class="o">*</span><span class="p">)</span><span class="nx">h</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">==</span> <span class="nx">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="nx">err</span> <span class="p">=</span> <span class="p">(</span><span class="nx">char</span><span class="o">*</span><span class="p">)</span><span class="nf">dlerror</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Both of these functions are relatively simple to implement, and they serve to simply encapsulate C functions in the standard library, making their signatures look more like function signatures in Go, and making it easier to call them in Go.</p>
<h3 id="loading-process">Loading process</h3>
<p>The function used to load a shared object, <code>plugin.Open</code>, takes the path to the shared object file as an argument and returns the <code>plugin.Plugin</code> structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Open</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above function will call the private function plugin.open to load the plugin, which is the core function of the plugin loading process, and we can split the function into the following steps.</p>
<ol>
<li>prepare the parameters of the C function plugin.pluginOpen.</li>
<li>calling plugin.pluginOpen via cgo and initializing the loaded module.</li>
<li>finding the init function in the loaded module and calling that function.</li>
<li>building the plugin.Plugin structure from the plugin&rsquo;s filename and symbol list.</li>
</ol>
<p>The first step is to prepare the arguments needed to call plugin.pluginOpen using some of the structures provided by cgo. The following code converts the filename to a variable of type *C.char, which can be passed as an argument to the C function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cPath</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PATH_MAX</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="nx">cRelName</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="nb">copy</span><span class="p">(</span><span class="nx">cRelName</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">C</span><span class="p">.</span><span class="nf">realpath</span><span class="p">(</span>
		<span class="p">(</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cRelName</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
		<span class="p">(</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cPath</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">`plugin.Open(&#34;`</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">`&#34;): realpath failed`</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">filepath</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">((</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cPath</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

	<span class="o">...</span>
	<span class="kd">var</span> <span class="nx">cErr</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span>
	<span class="nx">h</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">pluginOpen</span><span class="p">((</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cPath</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="o">&amp;</span><span class="nx">cErr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">`plugin.Open(&#34;`</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">`&#34;): `</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">cErr</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Once we have a handle to the dynamic library, we call plugin.lastmoduleinit, and the linker links it to the runtime.plugin_lastmoduleinit function, which parses the symbols in the file and returns the directory of the shared file and all the symbols it contains.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">pluginpath</span><span class="p">,</span> <span class="nx">syms</span><span class="p">,</span> <span class="nx">errstr</span> <span class="o">:=</span> <span class="nf">lastmoduleinit</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">errstr</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">plugins</span><span class="p">[</span><span class="nx">filepath</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Plugin</span><span class="p">{</span>
			<span class="nx">pluginpath</span><span class="p">:</span> <span class="nx">pluginpath</span><span class="p">,</span>
			<span class="nx">err</span><span class="p">:</span>        <span class="nx">errstr</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">pluginsMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">`plugin.Open(&#34;`</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">`&#34;): `</span> <span class="o">+</span> <span class="nx">errstr</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>At the end of this function, we build a new plugin.Plugin structure and iterate through all the symbols returned by plugin.lastmoduleinit, calling plugin.pluginLookup for each one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">open</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Plugin</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Plugin</span><span class="p">{</span>
		<span class="nx">pluginpath</span><span class="p">:</span> <span class="nx">pluginpath</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">plugins</span><span class="p">[</span><span class="nx">filepath</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
	<span class="o">...</span>
	<span class="nx">updatedSyms</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{}</span>
	<span class="k">for</span> <span class="nx">symName</span><span class="p">,</span> <span class="nx">sym</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">syms</span> <span class="p">{</span>
		<span class="nx">isFunc</span> <span class="o">:=</span> <span class="nx">symName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span>
		<span class="k">if</span> <span class="nx">isFunc</span> <span class="p">{</span>
			<span class="nb">delete</span><span class="p">(</span><span class="nx">syms</span><span class="p">,</span> <span class="nx">symName</span><span class="p">)</span>
			<span class="nx">symName</span> <span class="p">=</span> <span class="nx">symName</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="p">}</span>

		<span class="nx">fullName</span> <span class="o">:=</span> <span class="nx">pluginpath</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="nx">symName</span>
		<span class="nx">cname</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fullName</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
		<span class="nb">copy</span><span class="p">(</span><span class="nx">cname</span><span class="p">,</span> <span class="nx">fullName</span><span class="p">)</span>

		<span class="nx">p</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">pluginLookup</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">char</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cname</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="o">&amp;</span><span class="nx">cErr</span><span class="p">)</span>
		<span class="nx">valp</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sym</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">isFunc</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="nx">valp</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="nx">valp</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
		<span class="p">}</span>
		<span class="nx">updatedSyms</span><span class="p">[</span><span class="nx">symName</span><span class="p">]</span> <span class="p">=</span> <span class="nx">sym</span>
	<span class="p">}</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">syms</span> <span class="p">=</span> <span class="nx">updatedSyms</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The above function returns a plugin.Plugin structure with a mapping of symbol names to functions or variables, which the caller can use as a handle to look up the symbols in the structure.</p>
<h3 id="symbol-lookup">Symbol lookup</h3>
<p>Plugin.Lookup looks for the symbol plugin.Symbol in the structure returned by plugin.Open, which is an alias of type interface{} that we can convert to the real type of a variable or function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Plugin</span><span class="p">)</span> <span class="nf">Lookup</span><span class="p">(</span><span class="nx">symName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Symbol</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">lookup</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">symName</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">lookup</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Plugin</span><span class="p">,</span> <span class="nx">symName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Symbol</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">s</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">syms</span><span class="p">[</span><span class="nx">symName</span><span class="p">];</span> <span class="nx">s</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;plugin: symbol &#34;</span> <span class="o">+</span> <span class="nx">symName</span> <span class="o">+</span> <span class="s">&#34; not found in plugin &#34;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pluginpath</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The private function plugin.lookup called by the above method is relatively simple to implement, it directly uses the symbol table in the structure and returns an error if the corresponding symbol is not found.</p>
<h2 id="summary">Summary</h2>
<p>The Go language plug-in system makes use of the operating system&rsquo;s dynamic libraries to achieve a modular design, which provides features that are interesting but encounter more restrictions in actual use. The current plug-in system also only supports Linux, Darwin and FreeBSD, and there is no way to use it on Windows. Because the implementation of the plug-in system is based on some black magic, so the cross-platform compilation will also encounter some rather odd problems, the author also encountered a lot of problems when using the plug-in system, if the Go language is not particularly well understood, it is still not recommended to use the module.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-12/golang-json/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The principle of JSON implementation in Go language</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-12/whys-the-design-os-virtual-memory/">
            <span class="next-text nav-default">Why Linux needs virtual memory</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
