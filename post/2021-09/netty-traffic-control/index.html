<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Analyzing Netty Traffic Control from Occasional Downtime Events - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Business Background A large number of messages are currently used in mobile usage scenarios. Push messages can help operators achieve operational goals more efficiently (such as pushing marketing campaigns to users or alerting new APP features). For the push system needs to have the following two characteristics. Messages are delivered to users in seconds with no latency, support for millions of pushes per second, and millions of long connections on" /><meta name="keywords" content="netty, Traffic Controlce" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/netty-traffic-control/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Analyzing Netty Traffic Control from Occasional Downtime Events" />
<meta property="og:description" content="Business Background A large number of messages are currently used in mobile usage scenarios. Push messages can help operators achieve operational goals more efficiently (such as pushing marketing campaigns to users or alerting new APP features). For the push system needs to have the following two characteristics. Messages are delivered to users in seconds with no latency, support for millions of pushes per second, and millions of long connections on" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/netty-traffic-control/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-24T15:13:50+08:00" />
<meta property="article:modified_time" content="2021-09-24T15:13:50+08:00" />

<meta itemprop="name" content="Analyzing Netty Traffic Control from Occasional Downtime Events">
<meta itemprop="description" content="Business Background A large number of messages are currently used in mobile usage scenarios. Push messages can help operators achieve operational goals more efficiently (such as pushing marketing campaigns to users or alerting new APP features). For the push system needs to have the following two characteristics. Messages are delivered to users in seconds with no latency, support for millions of pushes per second, and millions of long connections on"><meta itemprop="datePublished" content="2021-09-24T15:13:50+08:00" />
<meta itemprop="dateModified" content="2021-09-24T15:13:50+08:00" />
<meta itemprop="wordCount" content="1557">
<meta itemprop="keywords" content="netty," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Analyzing Netty Traffic Control from Occasional Downtime Events"/>
<meta name="twitter:description" content="Business Background A large number of messages are currently used in mobile usage scenarios. Push messages can help operators achieve operational goals more efficiently (such as pushing marketing campaigns to users or alerting new APP features). For the push system needs to have the following two characteristics. Messages are delivered to users in seconds with no latency, support for millions of pushes per second, and millions of long connections on"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Analyzing Netty Traffic Control from Occasional Downtime Events</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-24 15:13:50 </span>
        <div class="post-category">
            <a href="/categories/implementation-details/"> implementation-details </a>
            </div>
          <span class="more-meta"> 1557 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#business-background">Business Background</a></li>
        <li><a href="#problem-background">Problem Background</a></li>
        <li><a href="#introduction-to-netty">Introduction to Netty</a></li>
        <li><a href="#problem-analysis">Problem Analysis</a>
          <ul>
            <li><a href="#guessing">Guessing</a></li>
            <li><a href="#view-gc-log">View GC Log</a></li>
            <li><a href="#analyzing-the-heap-memory-situation">Analyzing the heap memory situation</a></li>
            <li><a href="#analysis-of-the-data-from-the-chart-above-is-not-written-out-why-does-this-happen">Analysis of the data from the chart above is not written out, why does this happen?</a></li>
          </ul>
        </li>
        <li><a href="#problem-solving">Problem Solving</a>
          <ul>
            <li><a href="#enable-autoread-mechanism">Enable autoRead mechanism</a></li>
            <li><a href="#set-high-and-low-water-level">Set high and low water level</a></li>
            <li><a href="#add-the-channeliswritable-judgment">Add the channel.isWritable() judgment</a></li>
            <li><a href="#question-validation">Question Validation</a></li>
            <li><a href="#analysis-of-solution-ideas">Analysis of solution ideas</a></li>
          </ul>
        </li>
        <li><a href="#netty-source-code-description">Netty source code description</a>
          <ul>
            <li><a href="#above-high-water-level">Above high water level</a></li>
            <li><a href="#lower-than-low-water-level">Lower than low water level</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="business-background">Business Background</h2>
<p>A large number of messages are currently used in mobile usage scenarios. Push messages can help operators achieve operational goals more efficiently (such as pushing marketing campaigns to users or alerting new APP features).</p>
<p>For the push system needs to have the following two characteristics.</p>
<ul>
<li>
<p>Messages are delivered to users in seconds with no latency, support for millions of pushes per second, and millions of long connections on a single machine.</p>
</li>
<li>
<p>Support for notifications, text, custom message transmissions and other forms of presentation. It is for these reasons that the development and maintenance of the system poses a challenge. The following figure is a brief description of the push system (API-&gt;Push Module-&gt;Mobile).</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/02d4c4d379ed4f93afb3c79b6c42a6c8.png" alt=""></p>
<h2 id="problem-background">Problem Background</h2>
<p>Push system in the long connection cluster in the stability test, stress test stage after running for a period of time sometimes a process will hang, the probability is small (frequency of about once a month), which will affect the timeliness of some client messages delivered.</p>
<p>The long connection node (Broker system) in the push system is based on Netty development, this node maintains a long connection between the server and the cell phone terminal, after the online problem, add Netty memory leak monitoring parameters to troubleshoot the problem, observe for many days but did not troubleshoot the problem.</p>
<p>Since the long connection node is developed by Netty, the following is a brief introduction of Netty for the reader&rsquo;s understanding.</p>
<h2 id="introduction-to-netty">Introduction to Netty</h2>
<p>Netty is a high-performance , asynchronous event-driven NIO framework , based on the API implementation provided by Java NIO . It provides support for TCP, UDP and file transfer. As the most popular NIO framework, Netty is widely used in the Internet field, big data distributed computing, the game industry, the communications industry, etc. Open source components such as HBase, Hadoop, Bees, Dubbo, etc. are also built on Netty&rsquo;s NIO framework.</p>
<h2 id="problem-analysis">Problem Analysis</h2>
<h3 id="guessing">Guessing</h3>
<p>Initially, I guessed that it was caused by the number of long connections, but after troubleshooting the logs and analyzing the code, I found that it was not caused by this reason.</p>
<p>The number of long connections: 390,000, as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/0519bc12187b4b36932adae1262d71f3.png" alt=""></p>
<p>Each channel byte size 1456, based on 400,000 long connections, does not result in memory overload.</p>
<h3 id="view-gc-log">View GC Log</h3>
<p>Checking the GC logs, I found that the process hangs before frequent full GC (frequency 5 minutes once), but the memory is not reduced, suspecting an off-heap memory leak.</p>
<h3 id="analyzing-the-heap-memory-situation">Analyzing the heap memory situation</h3>
<p>ChannelOutboundBuffer object accounts for nearly 5G memory, the cause of the leak can basically be determined: ChannelOutboundBuffer entry number is too much caused by viewing the source code of ChannelOutboundBuffer can be analyzed, is the data in ChannelOutboundBuffer.</p>
<p>Not written out, resulting in a backlog all the time.</p>
<p>ChannelOutboundBuffer internal is a linked table structure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/f8543275e6cf47c9a0bf03d9dc9a0bb7.png" alt=""></p>
<h3 id="analysis-of-the-data-from-the-chart-above-is-not-written-out-why-does-this-happen">Analysis of the data from the chart above is not written out, why does this happen?</h3>
<p>The code actually has a determination of whether the connection is available or not (Channel.isActive) and will close the connection for timeouts. From historical experience, this happens more often when the connection is half open (abnormally closed by the client) - both sides do not communicate data without problems.</p>
<p>The test environment is reproduced and tested as guessed above.</p>
<ol>
<li>
<p>Simulate a client cluster and establish a connection with a long-connected server, set the firewall of the client node, and simulate a scenario where the server and client networks are abnormal (i.e., to simulate a situation where the Channel.isActive call is successful, but the data is not actually sent out).</p>
</li>
<li>
<p>Tune down the out-of-heap memory and keep sending test messages to the previous client. Message size (1K or so).</p>
</li>
<li>
<p>Based on 128M memory, it actually comes up with 9W multiple calls.</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/f57de643edb345fba0c850a2a9bc3037.png" alt=""></p>
<h2 id="problem-solving">Problem Solving</h2>
<h3 id="enable-autoread-mechanism">Enable autoRead mechanism</h3>
<h4 id="turn-off-autoread-when-the-channel-is-not-writable">Turn off autoRead when the channel is not writable.</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
        <span class="n">ChannelInfo</span> <span class="n">channelInfo</span> <span class="o">=</span> <span class="n">ChannelManager</span><span class="o">.</span><span class="na">CHANNEL_CHANNELINFO</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">channelInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">clientId</span> <span class="o">=</span> <span class="n">channelInfo</span><span class="o">.</span><span class="na">getClientId</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;channel is unwritable, turn off autoread, clientId:{}&#34;</span><span class="o">,</span> <span class="n">clientId</span><span class="o">);</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">setAutoRead</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Enable autoRead when data is writable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
<span class="o">{</span>
    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="n">ChannelInfo</span> <span class="n">channelInfo</span> <span class="o">=</span> <span class="n">ChannelManager</span><span class="o">.</span><span class="na">CHANNEL_CHANNELINFO</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">clientId</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">channelInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">clientId</span> <span class="o">=</span> <span class="n">channelInfo</span><span class="o">.</span><span class="na">getClientId</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;channel is writable again, turn on autoread, clientId:{}&#34;</span><span class="o">,</span> <span class="n">clientId</span><span class="o">);</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">setAutoRead</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/1ad5ee09e7d74493bf873ba5793f489f.png" alt=""></p>
<p>The purpose of autoRead is more precise rate control, and Netty will register read events for us if it is turned on. When the read event is registered, Netty will read the data from the channel if the network is readable. If autoread is turned off, then Netty will not register read events.</p>
<p>This way, even if the other side sends data over, the read event will not be triggered and thus no data will be read from the channel. When the recv_buffer is full, no more data will be received.</p>
<h3 id="set-high-and-low-water-level">Set high and low water level</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">serverBootstrap</span><span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">WRITE_BUFFER_WATER_MARK</span><span class="o">,</span> <span class="k">new</span> <span class="n">WriteBufferWaterMark</span><span class="o">(</span><span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">,</span> <span class="n">8</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>High and low water levels are used in conjunction with isWritable later</p>
</blockquote>
<h3 id="add-the-channeliswritable-judgment">Add the channel.isWritable() judgment</h3>
<p>isActive() also needs to be added to channel.isWrite() to determine if the channel is available. isActive only ensures that the connection is active, while isWrite determines if the connection is writable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeBackMessage</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">MqttMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="c1">//增加channel.isWritable()的判断
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">isActive</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cf</span><span class="o">.</span><span class="na">isDone</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">cf</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;channelWrite error!&#34;</span><span class="o">,</span> <span class="n">cf</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>isWritable can be used to control the ChannelOutboundBuffer from expanding indefinitely. The mechanism is to use the set channel high and low water levels to make a determination.</p>
</blockquote>
<h3 id="question-validation">Question Validation</h3>
<p>Modified and then tested and sent to 27W times without reporting an error.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/dde5f960d6b24926b736ada59dcebbdd.png" alt=""></p>
<h3 id="analysis-of-solution-ideas">Analysis of solution ideas</h3>
<p>The general Netty data processing flow is as follows: the read data is handed over to the business thread for processing and then sent out (the whole process is asynchronous), Netty adds a ChannelOutboundBuffer between the business layer and the socket in order to improve the network throughput.</p>
<p>When channel.write is called, all the data written is not actually written to the socket, but to the ChannelOutboundBuffer first, and only when channel.flush is called is it actually written to the socket. Because there is a buffer in the middle, there is a rate match, and this buffer is still unbounded (chained), that is, if you do not control the speed of channel.write, there will be a lot of data piled up in this buffer, and if you encounter the socket can not write data (isActive judgment is invalid at this time) or write is slow.</p>
<p>The likely result is to run out of resources, and if the ChannelOutboundBuffer is a</p>
<p>DirectByteBuffer, this will make the problem even more difficult to troubleshoot.</p>
<p>The process can be abstracted as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/24/a3b89ff6b3c142eb83831f6c306e0ee2.png" alt=""></p>
<p>From the above analysis, we can see that step one is written too fast (too fast to process) or the data is not sent downstream can cause problems, which is actually a rate matching problem.</p>
<h2 id="netty-source-code-description">Netty source code description</h2>
<h3 id="above-high-water-level">Above high water level</h3>
<p>When the capacity of ChannelOutboundBuffer exceeds the high water level setting threshold, isWritable() returns false, sets channelUnwritable, and triggers fireChannelWritabilityChanged().</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">incrementPendingOutboundBytes</span><span class="o">(</span><span class="kt">long</span> <span class="n">size</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">newWriteBufferSize</span> <span class="o">=</span> <span class="n">TOTAL_PENDING_SIZE_UPDATER</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newWriteBufferSize</span> <span class="o">&gt;</span> <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">getWriteBufferHighWaterMark</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">setUnwritable</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setUnwritable</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">unwritable</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">oldValue</span> <span class="o">|</span> <span class="n">1</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">UNWRITABLE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">,</span> <span class="n">newValue</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oldValue</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">newValue</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">fireChannelWritabilityChanged</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="lower-than-low-water-level">Lower than low water level</h3>
<p>When the capacity of ChannelOutboundBuffer falls below the low water level setting threshold, isWritable() returns true, setting the channel writable and triggering fireChannelWritabilityChanged().</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">decrementPendingOutboundBytes</span><span class="o">(</span><span class="kt">long</span> <span class="n">size</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">notifyWritability</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">newWriteBufferSize</span> <span class="o">=</span> <span class="n">TOTAL_PENDING_SIZE_UPDATER</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">-</span><span class="n">size</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">notifyWritability</span> <span class="o">&amp;&amp;</span> <span class="n">newWriteBufferSize</span> <span class="o">&lt;</span> <span class="n">channel</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">getWriteBufferLowWaterMark</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">setWritable</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setWritable</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">invokeLater</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">unwritable</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">oldValue</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">1</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">UNWRITABLE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">,</span> <span class="n">newValue</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oldValue</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">newValue</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">fireChannelWritabilityChanged</span><span class="o">(</span><span class="n">invokeLater</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>When the capacity of ChannelOutboundBuffer exceeds the high water level setting threshold, isWritable() returns false, indicating that the messages are creating a buildup and the write speed needs to be reduced.</p>
<p>When the capacity of ChannelOutboundBuffer is below the low water level threshold, isWritable() returns true, indicating that there are too few messages and the write speed needs to be increased. After the above three steps were modified, the problem was observed on the deployment line for six months without occurrence.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/netty/">netty</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/righting-software-notes/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">《Righting Software》 reading notes</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/web-page-resource-integrity-checks/">
            <span class="next-text nav-default">Detailed Guide to Web Page Sub-resource Integrity Checks</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
