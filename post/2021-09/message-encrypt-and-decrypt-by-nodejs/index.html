<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>NodeJs-based encrypted transport for message exchange combining RSA and AES encryption algorithms - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Sensitive message exchange has relatively strong requirements for correctness and security. Using a message digest algorithm to calculate and verify the digest of the message body prevents the message from being tampered with during transmission as an illegal message value; using an encryption algorithm to encrypt the message body prevents the message from being intercepted and read during transmission. The combination of the two can achieve a strong secure message" /><meta name="keywords" content="nodejs, rsa, aes" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/message-encrypt-and-decrypt-by-nodejs/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="NodeJs-based encrypted transport for message exchange combining RSA and AES encryption algorithms" />
<meta property="og:description" content="Sensitive message exchange has relatively strong requirements for correctness and security. Using a message digest algorithm to calculate and verify the digest of the message body prevents the message from being tampered with during transmission as an illegal message value; using an encryption algorithm to encrypt the message body prevents the message from being intercepted and read during transmission. The combination of the two can achieve a strong secure message" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/message-encrypt-and-decrypt-by-nodejs/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-23T14:09:09+08:00" />
<meta property="article:modified_time" content="2021-09-23T14:09:09+08:00" />

<meta itemprop="name" content="NodeJs-based encrypted transport for message exchange combining RSA and AES encryption algorithms">
<meta itemprop="description" content="Sensitive message exchange has relatively strong requirements for correctness and security. Using a message digest algorithm to calculate and verify the digest of the message body prevents the message from being tampered with during transmission as an illegal message value; using an encryption algorithm to encrypt the message body prevents the message from being intercepted and read during transmission. The combination of the two can achieve a strong secure message"><meta itemprop="datePublished" content="2021-09-23T14:09:09+08:00" />
<meta itemprop="dateModified" content="2021-09-23T14:09:09+08:00" />
<meta itemprop="wordCount" content="2436">
<meta itemprop="keywords" content="nodejs,rsa,aes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NodeJs-based encrypted transport for message exchange combining RSA and AES encryption algorithms"/>
<meta name="twitter:description" content="Sensitive message exchange has relatively strong requirements for correctness and security. Using a message digest algorithm to calculate and verify the digest of the message body prevents the message from being tampered with during transmission as an illegal message value; using an encryption algorithm to encrypt the message body prevents the message from being intercepted and read during transmission. The combination of the two can achieve a strong secure message"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">NodeJs-based encrypted transport for message exchange combining RSA and AES encryption algorithms</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-23 14:09:09 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2436 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ensure-correct-message-exchange">Ensure correct message exchange</a></li>
        <li><a href="#encrypted-transmission-for-message-exchange">Encrypted transmission for message exchange</a></li>
        <li><a href="#example-of-encrypted-transmission-for-nodejs-based-message-exchange">Example of encrypted transmission for nodejs-based message exchange</a>
          <ul>
            <li><a href="#generate-asymmetric-encryption-rsa-algorithm-public-and-private-keys">Generate asymmetric encryption RSA algorithm public and private keys</a></li>
            <li><a href="#rsa-algorithm-encryption-and-decryption">RSA Algorithm Encryption and Decryption</a></li>
            <li><a href="#aes-algorithm-encryption-and-decryption">AES algorithm encryption and decryption</a></li>
            <li><a href="#combine-aes-and-rsa-encryption-algorithms-to-encrypt-and-decrypt-message-bodies">Combine AES and RSA encryption algorithms to encrypt and decrypt message bodies</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Sensitive message exchange has relatively strong requirements for correctness and security.</p>
<p>Using a message digest algorithm to calculate and verify the digest of the message body prevents the message from being tampered with during transmission as an illegal message value; using an encryption algorithm to encrypt the message body prevents the message from being intercepted and read during transmission. The combination of the two can achieve a strong secure message exchange.</p>
<h2 id="ensure-correct-message-exchange">Ensure correct message exchange</h2>
<p>The message may be tampered with by a man-in-the-middle during transmission. For example, if A sends a message to transfer money to B, a man-in-the-middle intercepts the message during transmission, decrypts the message body and tampers with it to transfer money to C, and tampers with the amount of the transfer, resulting in potentially irreversible damage.</p>
<p>Message digest ensures the correctness of the message transmission. The main idea is relatively simple: a message digest algorithm (such as md5, sha256, sha1, hashMAC, etc.) is used to calculate the digest value for the message body to be sent, and the receiver receives the message, uses the same digest algorithm to calculate the digest value for the message body, and compares it with the received digest value to verify if it is consistent.</p>
<p>The key point to note in this process is to guarantee the confidentiality of the digest algorithm.</p>
<h2 id="encrypted-transmission-for-message-exchange">Encrypted transmission for message exchange</h2>
<p>The symmetric encryption algorithm uses a common ciphertext to encrypt the message body, which is characterized by high speed and efficiency, but the disadvantage is that the secret key needs to be shared between the sender and the receiver, and the encryption will be invalid if either party leaks the ciphertext and the encryption algorithm. Asymmetric encryption algorithm uses public-private key pair, the sender uses the public key to encrypt the message body, the receiver uses the private key to decrypt the message body (or vice versa), and the receiver only needs to keep his own unique secret key to protect the encrypted message from being leaked. However, its encryption speed is slow and inefficient, so it is generally not used for encrypting large message bodies.</p>
<p>The combination of symmetric encryption algorithm and asymmetric encryption algorithm can achieve relatively feasible and effective message exchange and encryption transmission. In the following, RSA is used as an example of asymmetric encryption algorithm and AES is used as an example of symmetric encryption algorithm.</p>
<p>The main idea is: encrypt the key used in AES algorithm by RSA algorithm, encrypt the message body by AES algorithm, and then send the encrypted key and message body to the other party; after the other party receives the message, decrypt the AES key by RSA algorithm, decrypt the message body with the decrypted key, and get the decrypted message; the receiver repeats the similar process in the process of replying the message, thus realizing the message exchange and encrypted transmission.</p>
<p>Let&rsquo;s take the client-server message communication as an example, the detailed process is outlined as follows.</p>
<p>Preparation:</p>
<ol>
<li>The client generates the local RSA public-private key clientPublicKey and clientPrivateKey.</li>
<li>the server generates the remote RSA public-private key remotePublicKey and remotePublicKey</li>
</ol>
<p>Message exchange process.</p>
<ol>
<li>public key exchange: the client initiates the request, sends the local RSA public key localPublicKey, and obtains the server&rsquo;s RSA public key remotePublicKey, which is used to encrypt the key of the symmetric algorithm (AES)</li>
<li>the client generates a random 16-bit character aesKey, which is used as the key of the symmetric algorithm (AES)</li>
<li>the client uses the public key remotePublicKey obtained from the server to RSA encrypt the aesKey and obtains the encrypted value aesKeyEncrypted</li>
<li>the client encrypts the body of the message to be sent with the aesKey, and gets the bodyAesEncrypted</li>
<li>The client sends the message body {aesKeyEncrypted, bodyAesEncrypted } using http post method. The localPublicKey is used to encrypt the message returned by the server.</li>
<li>the server receives the message body and decrypts the aesKeyEncrypted with its RSA private key remotePrivateKey to get the AES algorithm key aesKey</li>
<li>the server decrypts the bodyAesEncrypted with the AES key aesKey to get the body, and the encrypted message from the client to the server is transmitted.</li>
<li>The server uses localPublicKey to repeat the above 1-5 process to encrypt and send the reply message, and the client repeats the above 6-7 process to decrypt the received message.</li>
</ol>
<p>Through the above process, the messages are encrypted and unreadable throughout the transmission, provided that the RSA secrets of both parties are not compromised.
In addition, if the message digest algorithm is added to sign the message body, the intermediary cannot forge a valid message without knowing the digest algorithm. Therefore, combining the message digest algorithm and the message encryption algorithm can further enhance the message delivery process. Of course, in peer-to-peer messaging, the other party is not necessarily trusted, and there is still a risk of digest algorithm leakage.</p>
<p>The above process can guarantee the security of the message, but not its authenticity, because the middleman can also send a forged message body (forged message body and sender&rsquo;s public key) without decrypting the message and using the intercepted public key to encrypt the message.
The solution is to introduce a third-party authoritative middleman organization, so that the message receiver can first authenticate the public key from the message sender through the middleman organization when receiving the message.</p>
<p>The above process defaults to a peer-to-peer relationship between the client and the server. In fact, the process can be simplified: the client does not maintain the local RSA public-private key, but caches the randomly generated RES secret key; the server, after getting the message, replies to the message using the same RES algorithm and decrypts the client RES secret key to encrypt the message body, and the client receives the message and decrypts it using the RES secret key. In fact, the simplified process plus the authentication process of the third-party authority that issues the certificate is the basic principle of typical HTTPS message encryption transmission.</p>
<h2 id="example-of-encrypted-transmission-for-nodejs-based-message-exchange">Example of encrypted transmission for nodejs-based message exchange</h2>
<h3 id="generate-asymmetric-encryption-rsa-algorithm-public-and-private-keys">Generate asymmetric encryption RSA algorithm public and private keys</h3>
<p>Using the <code>crypto</code> module.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">crypto</span> <span class="nx">from</span> <span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
 
<span class="cm">/** 使用 crypto 模块生成 RSA 公私钥 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">genRsaKeyByCrypto</span><span class="p">(</span><span class="nx">options</span><span class="o">?:</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">RSAKeyPairOptions</span><span class="o">&lt;</span><span class="s2">&#34;pem&#34;</span><span class="p">,</span> <span class="s2">&#34;pem&#34;</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">modulusLength</span><span class="o">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="nx">publicKeyEncoding</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;pkcs1&#39;</span><span class="p">,</span>
            <span class="nx">format</span><span class="o">:</span> <span class="s1">&#39;pem&#39;</span>
        <span class="p">},</span>
        <span class="nx">privateKeyEncoding</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;pkcs8&#39;</span><span class="p">,</span>
            <span class="nx">format</span><span class="o">:</span> <span class="s1">&#39;pem&#39;</span><span class="p">,</span>
            <span class="nx">cipher</span><span class="o">:</span> <span class="s1">&#39;aes-256-cbc&#39;</span><span class="p">,</span>
            <span class="nx">passphrase</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">generateKeyPairSync</span><span class="p">(</span><span class="s1">&#39;rsa&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
 
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using the <code>node-rsa</code> library.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">NodeRSA</span> <span class="nx">from</span> <span class="s1">&#39;node-rsa&#39;</span><span class="p">;</span>
 
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">genRsaKeyPairByNodeRsa</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeRSA</span><span class="p">({</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>
    <span class="nx">key</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span><span class="nx">encryptionScheme</span><span class="o">:</span> <span class="s1">&#39;pkcs1&#39;</span><span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">publicKey</span><span class="o">:</span> <span class="nx">key</span><span class="p">.</span><span class="nx">exportKey</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">),</span> <span class="nx">privateKey</span><span class="o">:</span> <span class="nx">key</span><span class="p">.</span><span class="nx">exportKey</span><span class="p">(</span><span class="s1">&#39;private&#39;</span><span class="p">)</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Generate and save RSA public and private keys.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">saveRsaKey</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="o">=</span><span class="s1">&#39;public.pem&#39;</span><span class="p">,</span> <span class="nx">privateKeyPath</span><span class="o">=</span><span class="s1">&#39;private.pem&#39;</span><span class="p">,</span> <span class="nx">isForce</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">publicKeyPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">);</span>
    <span class="nx">privateKeyPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">privateKeyPath</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isForce</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// console.log(&#39;公钥文件已存在&#39;);
</span><span class="c1"></span>        <span class="k">return</span> <span class="p">{</span> <span class="nx">publicKey</span><span class="o">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">),</span> <span class="nx">privateKey</span><span class="o">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">privateKeyPath</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;重新生成公私钥文件&#39;</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="c1">// const { publicKey, privateKey } = await genRsaKeyByCrypto();
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">privateKey</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">genRsaKeyPairByNodeRsa</span><span class="p">();</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">)))</span> <span class="nx">mkdirSync</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">),</span> <span class="p">{</span><span class="nx">recursive</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
 
    <span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">publicKeyPath</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;写入公钥文件：&#39;</span><span class="p">,</span> <span class="nx">publicKeyPath</span><span class="p">);</span>
    <span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">privateKeyPath</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;写入私钥文件：&#39;</span><span class="p">,</span> <span class="nx">privateKeyPath</span><span class="p">);</span>
 
    <span class="k">return</span> <span class="p">{</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">privateKey</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rsa-algorithm-encryption-and-decryption">RSA Algorithm Encryption and Decryption</h3>
<p>Example of using the <code>crypto</code> module that comes with Node.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/**
</span><span class="cm"> * RSA最大加密明文大小
</span><span class="cm"> */</span>
<span class="kr">const</span> <span class="nx">MAX_ENCRYPT_BLOCK</span> <span class="o">=</span> <span class="mi">117</span> <span class="o">-</span> <span class="mi">31</span><span class="p">;</span>
<span class="cm">/**
</span><span class="cm"> * RSA最大解密密文大小
</span><span class="cm"> */</span>
<span class="kr">const</span>  <span class="nx">MAX_DECRYPT_BLOCK</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
 
<span class="cm">/**
</span><span class="cm"> * rsa 公钥加密
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">publicEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">outputEncoding</span><span class="o">:</span> <span class="nx">BufferEncoding</span> <span class="o">=</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 加密信息用buf封装
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">inputLen</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">bufs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">offSet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">endOffSet</span> <span class="o">=</span> <span class="nx">MAX_ENCRYPT_BLOCK</span><span class="p">;</span>
    <span class="c1">// 分段加密
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nx">inputLen</span> <span class="o">-</span> <span class="nx">offSet</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inputLen</span> <span class="o">-</span> <span class="nx">offSet</span> <span class="o">&gt;</span> <span class="nx">MAX_ENCRYPT_BLOCK</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">bufTmp</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offSet</span><span class="p">,</span> <span class="nx">endOffSet</span><span class="p">);</span>
            <span class="nx">bufs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">publicEncrypt</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">passphrase</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">padding</span><span class="o">:</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RSA_PKCS1_PADDING</span><span class="p">},</span> <span class="nx">bufTmp</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">bufTmp</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offSet</span><span class="p">,</span> <span class="nx">inputLen</span><span class="p">);</span>
            <span class="nx">bufs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">publicEncrypt</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">passphrase</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">padding</span><span class="o">:</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RSA_PKCS1_PADDING</span><span class="p">},</span> <span class="nx">bufTmp</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nx">offSet</span> <span class="o">+=</span> <span class="nx">MAX_ENCRYPT_BLOCK</span><span class="p">;</span>
        <span class="nx">endOffSet</span> <span class="o">+=</span> <span class="nx">MAX_ENCRYPT_BLOCK</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">bufs</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">outputEncoding</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/**
</span><span class="cm"> * rsa 私钥解密
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">privateDecrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="nx">inputEncoding</span><span class="o">:</span> <span class="nx">BufferEncoding</span> <span class="o">=</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 经过base64编码的密文转成buf
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">Buffer</span> <span class="o">?</span> <span class="nx">data</span> <span class="o">:</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">inputEncoding</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">inputLen</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">bufs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">let</span> <span class="nx">offSet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">endOffSet</span> <span class="o">=</span> <span class="nx">MAX_DECRYPT_BLOCK</span><span class="p">;</span>
    <span class="c1">// 分段加密
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nx">inputLen</span> <span class="o">-</span> <span class="nx">offSet</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inputLen</span> <span class="o">-</span> <span class="nx">offSet</span> <span class="o">&gt;</span> <span class="nx">MAX_DECRYPT_BLOCK</span><span class="p">)</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">bufTmp</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offSet</span><span class="p">,</span> <span class="nx">endOffSet</span><span class="p">);</span>
            <span class="nx">bufs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">privateDecrypt</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="nx">passphrase</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">padding</span><span class="o">:</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RSA_PKCS1_PADDING</span><span class="p">},</span> <span class="nx">bufTmp</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kr">const</span> <span class="nx">bufTmp</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">offSet</span><span class="p">,</span> <span class="nx">inputLen</span><span class="p">);</span>
            <span class="nx">bufs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">privateDecrypt</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="nx">passphrase</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">padding</span><span class="o">:</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RSA_PKCS1_PADDING</span><span class="p">},</span> <span class="nx">bufTmp</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nx">offSet</span> <span class="o">+=</span> <span class="nx">MAX_DECRYPT_BLOCK</span><span class="p">;</span>
        <span class="nx">endOffSet</span> <span class="o">+=</span> <span class="nx">MAX_DECRYPT_BLOCK</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">bufs</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
 
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Using the <code>node-rsa</code> library.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">NodeRSA</span> <span class="nx">from</span> <span class="s1">&#39;node-rsa&#39;</span><span class="p">;</span>
 
<span class="cm">/**
</span><span class="cm"> * rsa 公钥加密
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">rsaEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="nx">outputEncoding</span> <span class="o">=</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeRSA</span><span class="p">({</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>
    <span class="nx">key</span><span class="p">.</span><span class="nx">importKey</span><span class="p">(</span><span class="nx">publicKey</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">encryData</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">encrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">outputEncoding</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">outputEncoding</span> <span class="o">===</span> <span class="s1">&#39;hex&#39;</span> <span class="o">||</span> <span class="nx">outputEncoding</span> <span class="o">===</span> <span class="s1">&#39;binary&#39;</span><span class="p">)</span> <span class="nx">encryData</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">encryData</span><span class="p">,</span> <span class="nx">outputEncoding</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">encryData</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**
</span><span class="cm"> * rsa 私钥解密
</span><span class="cm"> */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">rsaDecrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeRSA</span><span class="p">({</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>
    <span class="nx">key</span><span class="p">.</span><span class="nx">importKey</span><span class="p">(</span><span class="nx">privateKey</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">decryptData</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">decryptData</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="aes-algorithm-encryption-and-decryption">AES algorithm encryption and decryption</h3>
<p>AES encryption and decryption is relatively simple, just pass in the corresponding data and decryption text.</p>
<p>Example of using the <code>crypto</code> module that comes with Node.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">crypto</span> <span class="nx">from</span> <span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
 
<span class="cm">/** aes 加密 */</span>
<span class="kr">export</span> <span class="nx">aesEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">passKey</span><span class="p">,</span> <span class="nx">outputEncoding</span> <span class="o">=</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">cipherChunks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="c1">// const key = Buffer.from(passKey, &#39;utf8&#39;);
</span><span class="c1"></span>    <span class="c1">// 对原始秘钥点加盐
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">scryptSync</span><span class="p">(</span><span class="nx">passKey</span><span class="p">,</span> <span class="s1">&#39;salt&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">iv</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span> <span class="c1">// Buffer.alloc(16, 0);
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">cipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createCipheriv</span><span class="p">(</span><span class="s1">&#39;aes-128-cbc&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span><span class="p">);</span>
 
    <span class="nx">cipher</span><span class="p">.</span><span class="nx">setAutoPadding</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nx">outputEncoding</span> <span class="nx">as</span> <span class="nx">any</span><span class="p">));</span>
    <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="nx">outputEncoding</span> <span class="nx">as</span> <span class="nx">any</span><span class="p">));</span>
 
    <span class="k">return</span> <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/** aes 解密 */</span>
<span class="kr">export</span> <span class="nx">aesDecrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">passKey</span><span class="p">,</span> <span class="nx">inputEncoding</span> <span class="o">=</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">cipherChunks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="c1">// const key = Buffer.from(passKey, &#39;utf8&#39;);
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">scryptSync</span><span class="p">(</span><span class="nx">passKey</span><span class="p">,</span> <span class="s1">&#39;salt&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">iv</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span> <span class="c1">// Buffer.alloc(16, 0);
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">decipher</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createDecipheriv</span><span class="p">(</span><span class="s1">&#39;aes-128-cbc&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span><span class="p">);</span>
 
    <span class="nx">decipher</span><span class="p">.</span><span class="nx">setAutoPadding</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">decipher</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">inputEncoding</span> <span class="nx">as</span> <span class="nx">any</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">));</span>
    <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">decipher</span><span class="p">.</span><span class="kr">final</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">));</span>
 
    <span class="k">return</span> <span class="nx">cipherChunks</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="combine-aes-and-rsa-encryption-algorithms-to-encrypt-and-decrypt-message-bodies">Combine AES and RSA encryption algorithms to encrypt and decrypt message bodies</h3>
<p>Data encryption and decryption implementation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="cm">/** 生成指定长度的字符串 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">genRandomAesKey</span><span class="p">(</span><span class="nx">len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// return crypto.randomBytes(len).toString(&#39;utf-8&#39;);
</span><span class="c1"></span> 
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">126</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">)</span> <span class="nx">code</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">code</span><span class="p">));</span>
    <span class="p">}</span>
 
    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/** （使用对方的公钥）数据加密，返回加密后的 key、data 以及本地公钥（用于给对方加密回据使用） */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">dataEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">remotePublicKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">aesKey</span> <span class="o">=</span> <span class="nx">genRandomAesKey</span><span class="p">();</span>
    <span class="c1">// const localPublicKey = fs.readFileSync(config.publicKeyPath, {encoding: &#39;utf-8&#39;});
</span><span class="c1"></span>    <span class="c1">// if (!remotePublicKey) remotePublicKey = localPublicKey;
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">aesKeyEncrypted</span> <span class="o">=</span> <span class="nx">rsaEncrypt</span><span class="p">(</span><span class="nx">aesKey</span><span class="p">,</span> <span class="nx">remotePublicKey</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">encryptedData</span> <span class="o">=</span> <span class="nx">aesEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">aesKey</span><span class="p">);</span>
 
    <span class="k">return</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">aesKeyEncrypted</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">encryptedData</span><span class="p">,</span> <span class="nx">publicKey</span><span class="o">:</span> <span class="nx">localPublicKey</span><span class="p">};</span>
<span class="p">}</span>
 
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">dataDecrypt</span><span class="p">(</span><span class="nx">encryptedData</span><span class="p">,</span> <span class="nx">aesKeyEncrypted</span><span class="p">,</span> <span class="nx">localPrivateKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if (!localPrivateKey) localPrivateKey = fs.readFileSync(config.privateKeyPath, {encoding: &#39;utf-8&#39;});
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">aesKey</span> <span class="o">=</span> <span class="nx">rsaDecrypt</span><span class="p">(</span><span class="nx">aesKeyEncrypted</span><span class="p">,</span> <span class="nx">localPrivateKey</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">aesDecrypt</span><span class="p">(</span><span class="nx">encryptedData</span><span class="p">,</span> <span class="nx">aesKey</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Encryption of message sender&rsquo;s data and decryption of receiver&rsquo;s data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 发送方加密发送消息
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;lzwme&#39;</span><span class="p">,</span> <span class="nx">pwd</span><span class="o">:</span> <span class="s1">&#39;123456&#39;</span> <span class="p">};</span>
<span class="kr">const</span> <span class="nx">remotePublicKey</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">encryptedInfo</span> <span class="o">=</span> <span class="nx">dataEncrypt</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据加密：&#39;</span><span class="p">,</span> <span class="nx">encryptedInfo</span><span class="p">);</span>
 
<span class="c1">// 接受方收到消息体后解密消息
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">localPrivateKey</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">deCryptedInfo</span> <span class="o">=</span> <span class="nx">dataDecrypt</span><span class="p">(</span><span class="nx">encryptedInfo</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">encryptedInfo</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">localPrivateKey</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据解密：&#39;</span><span class="p">,</span> <span class="nx">deCryptedInfo</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>This article introduces a typical scheme that combines the use of symmetric encryption algorithm (AES) and asymmetric encryption algorithm (RSA) to encrypt the transmission of messages on both sides of the message exchange, and demonstrates the implementation of the main processes using nodejs code. In a browser/server (B/S) based service, there is no <code>nodejs</code> interface capability on the browser side, and the encryption and decryption algorithms can be implemented with the help of APIs provided by third-party libraries such as <code>crypto-js</code> and <code>jsencrypt</code>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nodejs/">nodejs</a>
          <a href="/tags/rsa/">rsa</a>
          <a href="/tags/aes/">aes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/typescript-parameters-and-returntype/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">TypeScript get the parameter type, return value type of the function</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/migrate-from-oh-my-zsh-to-prezto/">
            <span class="next-text nav-default">Migrate From Oh My Zsh to Prezto</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
