<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Etcdraft consensus in Fabric - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Why consensus via etcdraft? I think there are the following reasons solo is not suitable for most scenarios, e.g. organization A, organization B, both want to place consensus nodes in themselves kafka can meet the above requirements, but kafka plus zookeeper requires extra deployment and is too heavy to deploy So here comes the consensus based on etcdraft, which solves the above pain points Say it three times! Don&amp;rsquo;t miss" /><meta name="keywords" content="golang, Fabric, etcdraft" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/etcdraft-exploration-in-fabric-orderer/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Etcdraft consensus in Fabric" />
<meta property="og:description" content="Why consensus via etcdraft? I think there are the following reasons solo is not suitable for most scenarios, e.g. organization A, organization B, both want to place consensus nodes in themselves kafka can meet the above requirements, but kafka plus zookeeper requires extra deployment and is too heavy to deploy So here comes the consensus based on etcdraft, which solves the above pain points Say it three times! Don&rsquo;t miss" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/etcdraft-exploration-in-fabric-orderer/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-10T15:46:09+08:00" />
<meta property="article:modified_time" content="2021-09-10T15:46:09+08:00" />

<meta itemprop="name" content="Etcdraft consensus in Fabric">
<meta itemprop="description" content="Why consensus via etcdraft? I think there are the following reasons solo is not suitable for most scenarios, e.g. organization A, organization B, both want to place consensus nodes in themselves kafka can meet the above requirements, but kafka plus zookeeper requires extra deployment and is too heavy to deploy So here comes the consensus based on etcdraft, which solves the above pain points Say it three times! Don&rsquo;t miss"><meta itemprop="datePublished" content="2021-09-10T15:46:09+08:00" />
<meta itemprop="dateModified" content="2021-09-10T15:46:09+08:00" />
<meta itemprop="wordCount" content="2977">
<meta itemprop="keywords" content="golang,hyperledger fabric," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Etcdraft consensus in Fabric"/>
<meta name="twitter:description" content="Why consensus via etcdraft? I think there are the following reasons solo is not suitable for most scenarios, e.g. organization A, organization B, both want to place consensus nodes in themselves kafka can meet the above requirements, but kafka plus zookeeper requires extra deployment and is too heavy to deploy So here comes the consensus based on etcdraft, which solves the above pain points Say it three times! Don&rsquo;t miss"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Etcdraft consensus in Fabric</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-10 15:46:09 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2977 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#core-interface">Core Interface</a></li>
        <li><a href="#orderer-initialization">Orderer initialization</a></li>
        <li><a href="#etcdraft-initialization">EtcdRaft initialization</a></li>
        <li><a href="#etcdraft-startup">EtcdRaft Startup</a></li>
        <li><a href="#one-transaction">One transaction</a></li>
        <li><a href="#synchronization-of-a-block">Synchronization of a block</a></li>
        <li><a href="#storage-of-a-block">Storage of a block</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Why consensus via <code>etcdraft</code>?</p>
<p>I think there are the following reasons</p>
<ol>
<li><code>solo</code> is not suitable for most scenarios, e.g. organization A, organization B, both want to place consensus nodes in themselves</li>
<li><code>kafka</code> can meet the above requirements, but <code>kafka</code> plus <code>zookeeper</code> requires extra deployment and is too heavy to deploy</li>
</ol>
<p>So here comes the consensus based on <code>etcdraft</code>, which solves the above pain points</p>
<p>Say it three times!</p>
<p>Don&rsquo;t miss the source code part of the article, there are many, many comments in it!!! Don&rsquo;t miss the source code section of the article, there are lots and lots of comments!!!! Do not miss the source code section of the article, there are many, many comments!!!!</p>
<h2 id="core-interface">Core Interface</h2>
<p>Here are the interfaces that I believe implement the etcdraft consensus core</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ClusterServer 集群Server接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ClusterServer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Step</span><span class="p">(</span><span class="nx">Cluster_StepServer</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// ClusterClient 集群Client接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ClusterClient</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Step</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">orderer</span><span class="p">.</span><span class="nx">Cluster_StepClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler 用于共识的两个接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">OnConsensus</span><span class="p">(</span><span class="nx">channel</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">sender</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">orderer</span><span class="p">.</span><span class="nx">ConsensusRequest</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">OnSubmit</span><span class="p">(</span><span class="nx">channel</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">sender</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">orderer</span><span class="p">.</span><span class="nx">SubmitRequest</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// Consenter 共识排序接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Consenter</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">HandleChain</span><span class="p">(</span><span class="nx">support</span> <span class="nx">ConsenterSupport</span><span class="p">,</span> <span class="nx">metadata</span> <span class="o">*</span><span class="nx">cb</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">)</span> <span class="p">(</span><span class="nx">Chain</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Chain 共识核心的接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Chain</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// 接收普通的交易消息
</span><span class="c1"></span>    <span class="nf">Order</span><span class="p">(</span><span class="nx">env</span> <span class="o">*</span><span class="nx">cb</span><span class="p">.</span><span class="nx">Envelope</span><span class="p">,</span> <span class="nx">configSeq</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c1">// 接收配置消息
</span><span class="c1"></span>    <span class="nf">Configure</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">cb</span><span class="p">.</span><span class="nx">Envelope</span><span class="p">,</span> <span class="nx">configSeq</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nf">WaitReady</span><span class="p">()</span> <span class="kt">error</span>
    <span class="nf">Errored</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="nf">Start</span><span class="p">()</span>
    <span class="nf">Halt</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="orderer-initialization">Orderer initialization</h2>
<p>To start the <code>etcd</code> node, you need to set <code>ETCD_NAME</code>, which is the node&rsquo;s <code>ID</code>, but we don&rsquo;t do that when we start <code>Orderer</code>, which I think is a clever design</p>
<p>If you have started <a href="https://github.com/hyperledger/fabric-samples/tree/release-1.4/first-network">fabric-samples/first-network</a> you should know that the <code>configtx.yaml</code> , which is used to generate <code>genesis.blok</code></p>
<p><code>genesis.block</code> where you can set <code>OrdererType</code> , and <code>EtcdRaft</code> related configuration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">...</span><span class="w">
</span><span class="w"></span><span class="nt">Profiles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">SampleMultiNodeEtcdRaft</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="l">...</span><span class="w">
</span><span class="w">        </span><span class="nt">Orderer</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="cp">*OrdererDefaults</span><span class="w">
</span><span class="w">            </span><span class="nt">OrdererType</span><span class="p">:</span><span class="w"> </span><span class="l">etcdraft</span><span class="w">
</span><span class="w">            </span><span class="nt">EtcdRaft</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">Consenters</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">Host</span><span class="p">:</span><span class="w"> </span><span class="l">orderer.example.com</span><span class="w">
</span><span class="w">                  </span><span class="nt">Port</span><span class="p">:</span><span class="w"> </span><span class="m">7050</span><span class="w">
</span><span class="w">                  </span><span class="nt">ClientTLSCert</span><span class="p">:</span><span class="w"> </span><span class="l">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span><span class="w">
</span><span class="w">                  </span><span class="nt">ServerTLSCert</span><span class="p">:</span><span class="w"> </span><span class="l">crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt</span><span class="w">
</span><span class="w">                </span>- <span class="nt">Host</span><span class="p">:</span><span class="w"> </span><span class="l">orderer2.example.com</span><span class="w">
</span><span class="w">                  </span><span class="nt">Port</span><span class="p">:</span><span class="w"> </span><span class="m">7050</span><span class="w">
</span><span class="w">                </span><span class="l">...</span><span class="w">
</span><span class="w">            </span><span class="nt">Addresses</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">orderer.example.com:7050</span><span class="w">
</span><span class="w">                </span>- <span class="l">orderer2.example.com:7050</span><span class="w">
</span><span class="w">                </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>If you&rsquo;ve done the add organization, or deserialized <code>genesis.block</code>, you can see the <code>json</code> data in this <code>block</code>.</p>
<p>The data has been trimmed down, and only the areas that need to be explained are extracted, as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;data&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;data&#34;</span><span class="p">:[</span>
            <span class="p">{</span>
                <span class="nt">&#34;payload&#34;</span><span class="p">:{</span>
                    <span class="nt">&#34;config&#34;</span><span class="p">:{</span>
                        <span class="nt">&#34;channel_group&#34;</span><span class="p">:{</span>
                            <span class="nt">&#34;groups&#34;</span><span class="p">:{</span>
                                <span class="nt">&#34;Orderer&#34;</span><span class="p">:{</span>
                                    <span class="nt">&#34;values&#34;</span><span class="p">:{</span>
                                        <span class="nt">&#34;ConsensusType&#34;</span><span class="p">:{</span>
                                            <span class="nt">&#34;value&#34;</span><span class="p">:{</span>
                                                <span class="nt">&#34;metadata&#34;</span><span class="p">:{</span>
                                                    <span class="nt">&#34;consenters&#34;</span><span class="p">:[</span>
                                                        <span class="p">{</span>
                                                            <span class="nt">&#34;client_tls_cert&#34;</span><span class="p">:</span><span class="s2">&#34;client tls cert&#34;</span><span class="p">,</span>
                                                            <span class="nt">&#34;host&#34;</span><span class="p">:</span><span class="s2">&#34;orderer.example.com&#34;</span><span class="p">,</span>
                                                            <span class="nt">&#34;port&#34;</span><span class="p">:</span><span class="mi">7050</span><span class="p">,</span>
                                                            <span class="nt">&#34;server_tls_cert&#34;</span><span class="p">:</span><span class="s2">&#34;server tls cert&#34;</span>
                                                        <span class="p">},</span>
                                                        <span class="p">{</span>
                                                            <span class="nt">&#34;client_tls_cert&#34;</span><span class="p">:</span><span class="s2">&#34;client tls cert&#34;</span><span class="p">,</span>
                                                            <span class="nt">&#34;host&#34;</span><span class="p">:</span><span class="s2">&#34;orderer2.example.com&#34;</span><span class="p">,</span>
                                                            <span class="nt">&#34;port&#34;</span><span class="p">:</span><span class="mi">7050</span><span class="p">,</span>
                                                            <span class="nt">&#34;server_tls_cert&#34;</span><span class="p">:</span><span class="s2">&#34;server tls cert&#34;</span>
                                                        <span class="p">}</span>
                                                    <span class="p">],</span>
                                                    <span class="nt">&#34;options&#34;</span><span class="p">:{</span>
                                                        <span class="nt">&#34;election_tick&#34;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                                                        <span class="nt">&#34;heartbeat_tick&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                                        <span class="nt">&#34;max_inflight_blocks&#34;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                                                        <span class="nt">&#34;snapshot_interval_size&#34;</span><span class="p">:</span><span class="mi">20971520</span><span class="p">,</span>
                                                        <span class="nt">&#34;tick_interval&#34;</span><span class="p">:</span><span class="s2">&#34;500ms&#34;</span>
                                                    <span class="p">}</span>
                                                <span class="p">},</span>
                                                <span class="nt">&#34;state&#34;</span><span class="p">:</span><span class="s2">&#34;STATE_NORMAL&#34;</span><span class="p">,</span>
                                                <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;etcdraft&#34;</span>
                                            <span class="p">}</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&#34;signature&#34;</span><span class="p">:</span><span class="kc">null</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;header&#34;</span><span class="p">:{</span>

    <span class="p">},</span>
    <span class="nt">&#34;metadata&#34;</span><span class="p">:{</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When <code>Orderer</code> starts, it will read the latest configuration block of <code>system channel</code>, and if not, it will read <code>genesis.blok</code>.</p>
<p>If the <code>ConsensusType</code> is <code>etcdraft</code>, it will use <code>clusterGRPCServer</code> and pass it to <code>initializeMultichannelRegistrar(...)</code> in</p>
<p><code>initializeMultichannelRegistrar(...)</code> will determine <code>ConsensusType</code> again and if it is <code>etcdraft</code> it will pass <code>initializeEtcdraftConsenter(...)</code> initialize the <code>Consenter</code> instance object of <code>etcdraft</code></p>
<p>Service<code>, which implements the</code>ClusterServer` core interface</p>
<p>Finally, all <code>consenters</code> are passed into <code>multichannel.Initialize</code> and initialized there</p>
<p>Initialize<code>calls</code>HandleChain()<code>of</code>etcdraft.Consenter`, the core interface described above</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/common/server/main.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">cmd</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">conf</span> <span class="o">*</span><span class="nx">localconfig</span><span class="p">.</span><span class="nx">TopLevel</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 读取 genesis.blok
</span><span class="c1"></span>    <span class="nx">bootstrapBlock</span> <span class="o">:=</span> <span class="nf">extractBootstrapBlock</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 创建 LedgerFactory, 如果不存在 system channel 的配置块返回 nil
</span><span class="c1"></span>    <span class="nx">lf</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">createLedgerFactory</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">metricsProvider</span><span class="p">)</span>
    <span class="nx">sysChanLastConfigBlock</span> <span class="o">:=</span> <span class="nf">extractSysChanLastConfig</span><span class="p">(</span><span class="nx">lf</span><span class="p">,</span> <span class="nx">bootstrapBlock</span><span class="p">)</span>
    <span class="c1">// 选择引导块, 在 sysChanLastConfigBlock 和 bootstrapBlock 块中选择, 如果 sysChanLastConfigBlock 不为 nil, 则优先返回
</span><span class="c1"></span>    <span class="nx">clusterBootBlock</span> <span class="o">:=</span> <span class="nf">selectClusterBootBlock</span><span class="p">(</span><span class="nx">bootstrapBlock</span><span class="p">,</span> <span class="nx">sysChanLastConfigBlock</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 判断 clusterBootBlock 中的共识类型如果是 `etcdraft` 就进行集群的初始化工作
</span><span class="c1"></span>    <span class="nx">clusterType</span> <span class="o">:=</span> <span class="nf">isClusterType</span><span class="p">(</span><span class="nx">clusterBootBlock</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 初始化多通道
</span><span class="c1"></span>    <span class="nx">manager</span> <span class="o">:=</span> <span class="nf">initializeMultichannelRegistrar</span><span class="p">(</span><span class="nx">clusterBootBlock</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">clusterDialer</span><span class="p">,</span> <span class="nx">clusterServerConfig</span><span class="p">,</span> <span class="nx">clusterGRPCServer</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">signer</span><span class="p">,</span> <span class="nx">metricsProvider</span><span class="p">,</span> <span class="nx">opsSystem</span><span class="p">,</span> <span class="nx">lf</span><span class="p">,</span> <span class="nx">tlsCallback</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// orderer/common/server/main.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">initializeMultichannelRegistrar</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">*</span><span class="nx">multichannel</span><span class="p">.</span><span class="nx">Registrar</span> <span class="p">{</span>
    <span class="nx">genesisBlock</span> <span class="o">:=</span> <span class="nf">extractBootstrapBlock</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="nx">registrar</span> <span class="o">:=</span> <span class="nx">multichannel</span><span class="p">.</span><span class="nf">NewRegistrar</span><span class="p">(</span><span class="o">*</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">lf</span><span class="p">,</span> <span class="nx">signer</span><span class="p">,</span> <span class="nx">metricsProvider</span><span class="p">,</span> <span class="nx">callbacks</span><span class="o">...</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 加载 solo, kafka 共识
</span><span class="c1"></span>    <span class="nx">consenters</span><span class="p">[</span><span class="s">&#34;solo&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">solo</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">kafkaMetrics</span> <span class="o">*</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">Metrics</span>
    <span class="nx">consenters</span><span class="p">[</span><span class="s">&#34;kafka&#34;</span><span class="p">],</span> <span class="nx">kafkaMetrics</span> <span class="p">=</span> <span class="nx">kafka</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Kafka</span><span class="p">,</span> <span class="nx">metricsProvider</span><span class="p">,</span> <span class="nx">healthChecker</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 判断是否是 `etcdraft` 共识, 如果是就将 etcdraft 的实例也加入到 consenters 中
</span><span class="c1"></span>    <span class="k">if</span> <span class="nf">isClusterType</span><span class="p">(</span><span class="nx">bootstrapBlock</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">initializeEtcdraftConsenter</span><span class="p">(</span><span class="nx">consenters</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">lf</span><span class="p">,</span> <span class="nx">clusterDialer</span><span class="p">,</span> <span class="nx">bootstrapBlock</span><span class="p">,</span> <span class="nx">ri</span><span class="p">,</span> <span class="nx">srvConf</span><span class="p">,</span> <span class="nx">srv</span><span class="p">,</span> <span class="nx">registrar</span><span class="p">,</span> <span class="nx">metricsProvider</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">registrar</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="nx">consenters</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">registrar</span>
<span class="p">}</span>

<span class="c1">// orderer/common/multichannel/registrar.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Registrar</span><span class="p">)</span> <span class="nf">Initialize</span><span class="p">(</span><span class="nx">consenters</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">consensus</span><span class="p">.</span><span class="nx">Consenter</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">consenters</span> <span class="p">=</span> <span class="nx">consenters</span>
    <span class="nx">existingChains</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ledgerFactory</span><span class="p">.</span><span class="nf">ChainIDs</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">chainID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">existingChains</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="c1">// 这里判断是否是 system channel
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ledgerResources</span><span class="p">.</span><span class="nf">ConsortiumsConfig</span><span class="p">();</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="o">...</span>
            <span class="nx">chain</span> <span class="o">:=</span> <span class="nf">newChainSupport</span><span class="p">(</span>
                <span class="nx">r</span><span class="p">,</span>
                <span class="nx">ledgerResources</span><span class="p">,</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">consenters</span><span class="p">,</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">signer</span><span class="p">,</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">blockcutterMetrics</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">...</span>
            <span class="k">defer</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span>

<span class="c1">// orderer/common/multichannel/chainsupport.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newChainSupport</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">*</span><span class="nx">ChainSupport</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 这里会根据 ledger 获取 ConsensusType 选择最终要用到的共识算法, 根据本文会选出 `etcdraft`
</span><span class="c1"></span>    <span class="nx">consenterType</span> <span class="o">:=</span> <span class="nx">ledgerResources</span><span class="p">.</span><span class="nf">SharedConfig</span><span class="p">().</span><span class="nf">ConsensusType</span><span class="p">()</span>
    <span class="nx">consenter</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">consenters</span><span class="p">[</span><span class="nx">consenterType</span><span class="p">]</span>
    <span class="o">...</span>
    <span class="c1">// 调用 HandleChain
</span><span class="c1"></span>    <span class="nx">cs</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">consenter</span><span class="p">.</span><span class="nf">HandleChain</span><span class="p">(</span><span class="nx">cs</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="nx">cs</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="etcdraft-initialization">EtcdRaft initialization</h2>
<p>From now on the code enters the core of <code>etcdraft</code>, where you can see how the system automatically sets <code>raftID</code>, starting with <code>HandleChain</code> and ending with&hellip;</p>
<p>In <code>HandleChain</code>, the latest configuration information for the current <code>channel</code>, or <code>system channel</code>, is retrieved and the <code>ConsensusMetadata</code>, or <code>channel_group.groups.Orderer. ConsensusType.value.metadata</code></p>
<p>This is an array, the system will set the <code>raftID</code> according to the <code>index</code> of the certificate set by the current <code>orderer</code> in this array, great, really great!</p>
<p><code>RPC</code>, which implements the<code>ClusterClient</code> core interface described above, which means that <code>ClusterServer</code> and <code>ClusterClient</code> have a one-to-many relationship.</p>
<p>NewChain(&hellip;) ' to create <code>etcdraft.Chain</code>, which implements the core interface <code>Chain</code>.</p>
<p>At this point, all of the core interfaces described above are now present</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/consensus/etcdraft/consenter.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Consenter</span><span class="p">)</span> <span class="nf">HandleChain</span><span class="p">(</span><span class="nx">support</span> <span class="nx">consensus</span><span class="p">.</span><span class="nx">ConsenterSupport</span><span class="p">,</span> <span class="nx">metadata</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">)</span> <span class="p">(</span><span class="nx">consensus</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 获取 ConsensusMetadata
</span><span class="c1"></span>    <span class="nx">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">etcdraft</span><span class="p">.</span><span class="nx">ConfigMetadata</span><span class="p">{}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">support</span><span class="p">.</span><span class="nf">SharedConfig</span><span class="p">().</span><span class="nf">ConsensusMetadata</span><span class="p">(),</span> <span class="nx">m</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to unmarshal consensus metadata&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="nx">consenters</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="o">*</span><span class="nx">etcdraft</span><span class="p">.</span><span class="nx">Consenter</span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">consenter</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Consenters</span> <span class="p">{</span>
        <span class="nx">consenters</span><span class="p">[</span><span class="nx">blockMetadata</span><span class="p">.</span><span class="nx">ConsenterIds</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="p">=</span> <span class="nx">consenter</span>
    <span class="p">}</span>
    <span class="c1">// 设置ID
</span><span class="c1"></span>    <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">detectSelfID</span><span class="p">(</span><span class="nx">consenters</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// 初始化 cluster.RPC 每一个 chan 都会有个 rpc, 也印证了我上面说的, cluster.server 和 cluster.client 是一对一关系
</span><span class="c1"></span>    <span class="nx">rpc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">RPC</span><span class="p">{</span>
        <span class="nx">Timeout</span><span class="p">:</span>       <span class="nx">c</span><span class="p">.</span><span class="nx">OrdererConfig</span><span class="p">.</span><span class="nx">General</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">.</span><span class="nx">RPCTimeout</span><span class="p">,</span>
        <span class="nx">Logger</span><span class="p">:</span>        <span class="nx">c</span><span class="p">.</span><span class="nx">Logger</span><span class="p">,</span>
        <span class="nx">Channel</span><span class="p">:</span>       <span class="nx">support</span><span class="p">.</span><span class="nf">ChainID</span><span class="p">(),</span>
        <span class="nx">Comm</span><span class="p">:</span>          <span class="nx">c</span><span class="p">.</span><span class="nx">Communication</span><span class="p">,</span>
        <span class="nx">StreamsByType</span><span class="p">:</span> <span class="nx">cluster</span><span class="p">.</span><span class="nf">NewStreamsByType</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nf">NewChain</span><span class="p">(</span>
        <span class="nx">support</span><span class="p">,</span>
        <span class="nx">opts</span><span class="p">,</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">Communication</span><span class="p">,</span>
        <span class="nx">rpc</span><span class="p">,</span>
        <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">BlockPuller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nf">newBlockPuller</span><span class="p">(</span><span class="nx">support</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">OrdererConfig</span><span class="p">.</span><span class="nx">General</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">)</span> <span class="p">},</span>
        <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">InactiveChainRegistry</span><span class="p">.</span><span class="nf">TrackChain</span><span class="p">(</span><span class="nx">support</span><span class="p">.</span><span class="nf">ChainID</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CreateChain</span><span class="p">(</span><span class="nx">support</span><span class="p">.</span><span class="nf">ChainID</span><span class="p">())</span> <span class="p">})</span>
        <span class="p">},</span>
        <span class="kc">nil</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// orderer/consensus/etcdraft/chan.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewChain</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Chain</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 此方法基本都是初始化工作, 需要注意的是 rpc 给了 chan
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Chain</span><span class="p">{</span>
        <span class="nx">configurator</span><span class="p">:</span>     <span class="nx">conf</span><span class="p">,</span>
        <span class="nx">rpc</span><span class="p">:</span>              <span class="nx">rpc</span><span class="p">,</span>
        <span class="nx">channelID</span><span class="p">:</span>        <span class="nx">support</span><span class="p">.</span><span class="nf">ChainID</span><span class="p">(),</span>
        <span class="nx">raftID</span><span class="p">:</span>           <span class="nx">opts</span><span class="p">.</span><span class="nx">RaftID</span><span class="p">,</span>
        <span class="o">...</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="c1">// raft 的配置文件, 也是从 block 中获取的.
</span><span class="c1"></span>    <span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">raft</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>
    <span class="c1">// node, 里面有 raft 的 node
</span><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Node</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">node</span><span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="etcdraft-startup">EtcdRaft Startup</h2>
<p>Here we go back to <code>newChainSupport()</code>, where we copy the code from there, and when this function exits <code>defer chain.start()</code> it calls the <code>start</code> method</p>
<p>which will start <code>node.start()</code> in <code>etcdraft</code>, which will in turn start <code>node.start()</code> in <code>etcd</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/consensus/etcdraft/chan.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 启动了 etcdraft.Node
</span><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fresh</span><span class="p">,</span> <span class="nx">isJoin</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c1">// serveRequest 是个核心的函数, 在里面会做 raft 的角色切换等一堆的操作
</span><span class="c1"></span>    <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serveRequest</span><span class="p">()</span>

    <span class="nx">es</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">newEvictionSuspector</span><span class="p">()</span>

    <span class="nx">interval</span> <span class="o">:=</span> <span class="nx">DefaultLeaderlessCheckInterval</span>
    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">LeaderCheckInterval</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">interval</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">LeaderCheckInterval</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">.</span><span class="nx">periodicChecker</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">PeriodicCheck</span><span class="p">{</span>
        <span class="nx">Logger</span><span class="p">:</span>        <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">,</span>
        <span class="nx">Report</span><span class="p">:</span>        <span class="nx">es</span><span class="p">.</span><span class="nx">confirmSuspicion</span><span class="p">,</span>
        <span class="nx">CheckInterval</span><span class="p">:</span> <span class="nx">interval</span><span class="p">,</span>
        <span class="nx">Condition</span><span class="p">:</span>     <span class="nx">c</span><span class="p">.</span><span class="nx">suspectEviction</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">periodicChecker</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// orderer/consensus/etcdraft/node.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">start</span><span class="p">(</span><span class="nx">fresh</span><span class="p">,</span> <span class="nx">join</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="kd">var</span> <span class="nx">campaign</span> <span class="kt">bool</span>
    <span class="c1">// 是否是新节点标记位
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">fresh</span> <span class="p">{</span>
        <span class="c1">// 是否是新加入标记位
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">join</span> <span class="p">{</span>
            <span class="nx">raftPeers</span> <span class="p">=</span> <span class="kc">nil</span>
            <span class="nx">n</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting raft node to join an existing channel&#34;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">n</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting raft node as part of a new channel&#34;</span><span class="p">)</span>

            <span class="c1">// determine the node to start campaign by selecting the node with ID equals to:
</span><span class="c1"></span>            <span class="c1">//                hash(channelID) % cluster_size + 1
</span><span class="c1"></span>            <span class="nx">sha</span> <span class="o">:=</span> <span class="nx">sha256</span><span class="p">.</span><span class="nf">Sum256</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">chainID</span><span class="p">))</span>
            <span class="nx">number</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">proto</span><span class="p">.</span><span class="nf">DecodeVarint</span><span class="p">(</span><span class="nx">sha</span><span class="p">[</span><span class="mi">24</span><span class="p">:])</span>
            <span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ID</span> <span class="o">==</span> <span class="nx">number</span><span class="o">%</span><span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">raftPeers</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span> <span class="p">{</span>
                <span class="nx">campaign</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 最终会启动 raft 的 node.
</span><span class="c1"></span>        <span class="c1">// 有点像设置配置文件.
</span><span class="c1"></span>        <span class="c1">// raftPeers, 对应的就是 ETCD_INITIAL_CLUSTER
</span><span class="c1"></span>        <span class="nx">n</span><span class="p">.</span><span class="nx">Node</span> <span class="p">=</span> <span class="nx">raft</span><span class="p">.</span><span class="nf">StartNode</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">raftPeers</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Restarting raft node&#34;</span><span class="p">)</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">Node</span> <span class="p">=</span> <span class="nx">raft</span><span class="p">.</span><span class="nf">RestartNode</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">go</span> <span class="nx">n</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">campaign</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="one-transaction">One transaction</h2>
<p>The <code>Order(...)</code> method of the <code>Chain</code> interface is used to receive general transaction messages. ' method, which is used to receive ordinary transaction messages</p>
<p>When a message enters the Order method, it is wrapped in an <code>orderer.SubmitRequest</code> and sent</p>
<p>Submit(&hellip;) ' method, the message is encapsulated in <code>orderer.submit</code> and deposited in the <code>chan Chain.submitC</code> channel.</p>
<p>before determining whether <code>leader</code> is the current node, if not, it will send the data to <code>leader</code> via <code>rpc</code></p>
<p><code>Chain.rpc</code> is an implementation of <code>ClusterClient</code> that can be used to send messages to other orderers</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">st=&gt;start
e=&gt;end
opOrder=&gt;operation: Order(...)
condLeader=&gt;condition: IsLeader
opRPC=&gt;operation: rpc.SendSubmit(...)

st-&gt;opOrder-&gt;condLeader(no)-&gt;opRPC-&gt;e
condLeader(yes)-&gt;e
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/consensus/etcdraft/chain.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">Order</span><span class="p">(</span><span class="nx">env</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Envelope</span><span class="p">,</span> <span class="nx">configSeq</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">NormalProposalsReceived</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">// 这里将 env, configSeq 以及 channelID 封装成了 SubmitRequest 并发给了 Submit 方法
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Submit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">orderer</span><span class="p">.</span><span class="nx">SubmitRequest</span><span class="p">{</span><span class="nx">LastValidationSeq</span><span class="p">:</span> <span class="nx">configSeq</span><span class="p">,</span> <span class="nx">Payload</span><span class="p">:</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">Channel</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">channelID</span><span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// orderer/consensus/etcdraft/chain.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">Submit</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">orderer</span><span class="p">.</span><span class="nx">SubmitRequest</span><span class="p">,</span> <span class="nx">sender</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 获取一个 chan 用于接收网络当前的 leader
</span><span class="c1"></span>    <span class="nx">leadC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">uint64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="c1">// 这个 case 就是将 req, 以及用于接收 leader 的 chan, 再次封装发给了 Chain 中的 chan submitC
</span><span class="c1"></span>    <span class="k">case</span> <span class="nx">c</span><span class="p">.</span><span class="nx">submitC</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">submit</span><span class="p">{</span><span class="nx">req</span><span class="p">,</span> <span class="nx">leadC</span><span class="p">}:</span>
        <span class="c1">// 等待 submitC 被处理, 并返回 leader 的 id
</span><span class="c1"></span>        <span class="nx">lead</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">leadC</span>
        <span class="c1">// 如果没有 leader 就报错
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">lead</span> <span class="o">==</span> <span class="nx">raft</span><span class="p">.</span><span class="nx">None</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">ProposalFailures</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no Raft leader&#34;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// 如果自己不是 leader, 就会将消息发给 leader.
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">lead</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">raftID</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rpc</span><span class="p">.</span><span class="nf">SendSubmit</span><span class="p">(</span><span class="nx">lead</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">ProposalFailures</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">err</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="synchronization-of-a-block">Synchronization of a block</h2>
<p>This method, I think is the core method of <code>etcdraft</code>, if you are interested, you can look deeper into this method</p>
<p>It involves <code>Leader</code>, <code>Follower</code> role switching, consensus and other implementations.</p>
<p>Here we continue to follow the previous step, and start consensus after the transaction message reaches the <code>Leader</code>.</p>
<p>If the node is a <code>Leader</code>, it will be sorted</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/consensus/etcdraft/chain.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">serveRequest</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 下方会使用到里面的协程
</span><span class="c1"></span>    <span class="nx">becomeLeader</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kd">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">{</span>
                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
                    <span class="nx">data</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">MarshalOrPanic</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
                    <span class="c1">// 这里会丢给 raft node 进行同步 block, 里面的处理非常复杂.., 属于 raft 中的东西了, 这里就不细追了.
</span><span class="c1"></span>                    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nf">Propose</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to propose block [%d] to raft and discard %d blocks in queue: %s&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="p">}</span>
                    <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Proposed block [%d] to raft consensus&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">)</span>

                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                    <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Quit proposing blocks, discarded %d blocks in the queue&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ch</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">cancel</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">submitC</span><span class="p">:</span>
            <span class="c1">// leader 进行出块操作, 如果未符合要求,比如大小不够, 就会 pending
</span><span class="c1"></span>            <span class="nx">batches</span><span class="p">,</span> <span class="nx">pending</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ordered</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to order message: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">pending</span> <span class="p">{</span>
                <span class="nf">startTimer</span><span class="p">()</span> <span class="c1">// no-op if timer is already started
</span><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">stopTimer</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="c1">// 生成生成 block 并将 block 传给 propC, propC 是一个 chan 结构, 所以会给上面的协程做处理
</span><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nf">propose</span><span class="p">(</span><span class="nx">propC</span><span class="p">,</span> <span class="nx">bc</span><span class="p">,</span> <span class="nx">batches</span><span class="o">...</span><span class="p">)</span>

            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">configInflight</span> <span class="p">{</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Received config transaction, pause accepting transaction till it is committed&#34;</span><span class="p">)</span>
                <span class="nx">submitC</span> <span class="p">=</span> <span class="kc">nil</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">blockInflight</span> <span class="o">&gt;=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">MaxInflightBlocks</span> <span class="p">{</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Number of in-flight blocks (%d) reaches limit (%d), pause accepting transaction&#34;</span><span class="p">,</span>
                    <span class="nx">c</span><span class="p">.</span><span class="nx">blockInflight</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">MaxInflightBlocks</span><span class="p">)</span>
                <span class="nx">submitC</span> <span class="p">=</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="o">...</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nf">C</span><span class="p">():</span>
            <span class="nx">ticking</span> <span class="p">=</span> <span class="kc">false</span>

            <span class="nx">batch</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">support</span><span class="p">.</span><span class="nf">BlockCutter</span><span class="p">().</span><span class="nf">Cut</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Batch timer expired with no pending requests, this might indicate a bug&#34;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="p">}</span>

            <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Batch timer expired, creating block&#34;</span><span class="p">)</span>
            <span class="nx">c</span><span class="p">.</span><span class="nf">propose</span><span class="p">(</span><span class="nx">propC</span><span class="p">,</span> <span class="nx">bc</span><span class="p">,</span> <span class="nx">batch</span><span class="p">)</span> <span class="c1">// we are certain this is normal block, no need to block
</span><span class="c1"></span>        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="storage-of-a-block">Storage of a block</h2>
<p>According to <code>raft</code> the flow of the consensus sync message is <code>uncommitted</code> -&gt; <code>committed</code>, both will be done on top</p>
<p>If it is <code>committed</code>, it will write the block</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// orderer/consensus/etcdraft/chain.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">serveRequest</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="c1">// 下方会使用到里面的协程
</span><span class="c1"></span>    <span class="nx">becomeLeader</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kd">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ch</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">{</span>
                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
                    <span class="nx">data</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">MarshalOrPanic</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
                    <span class="c1">// 这里会丢给 raft node 进行同步 block, 里面的处理非常复杂.., 属于 raft 中的东西了, 这里就不细追了.
</span><span class="c1"></span>                    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nf">Propose</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Failed to propose block [%d] to raft and discard %d blocks in queue: %s&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ch</span><span class="p">),</span> <span class="nx">err</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="p">}</span>
                    <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Proposed block [%d] to raft consensus&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">)</span>

                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                    <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;Quit proposing blocks, discarded %d blocks in the queue&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ch</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">cancel</span>
    <span class="p">}</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="o">...</span>
        <span class="k">case</span> <span class="nx">app</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">applyC</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="c1">// 这里面会讲 raftlog 中的 block 落地.
</span><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// orderer/consensus/etcdraft/chain.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Chain</span><span class="p">)</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">ents</span> <span class="p">[]</span><span class="nx">raftpb</span><span class="p">.</span><span class="nx">Entry</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ents</span> <span class="p">{</span>
        <span class="c1">// 只有两种类型 EntryNormal, EntryConfChange, block 消息是 EntryNormal
</span><span class="c1"></span>        <span class="k">switch</span> <span class="nx">ents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Type</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">raftpb</span><span class="p">.</span><span class="nx">EntryNormal</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="nx">block</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">UnmarshalBlockOrPanic</span><span class="p">(</span><span class="nx">ents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Data</span><span class="p">)</span>
            <span class="c1">// 这里就会写入 block 了
</span><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nf">writeBlock</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">ents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Index</span><span class="p">)</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">CommittedBlockNumber</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">))</span>
        <span class="o">...</span>
        <span class="k">case</span> <span class="nx">raftpb</span><span class="p">.</span><span class="nx">EntryConfChange</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">ents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">appliedIndex</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">appliedIndex</span> <span class="p">=</span> <span class="nx">ents</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Index</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">accDataSize</span> <span class="o">&gt;=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sizeLimit</span> <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">UnmarshalBlockOrPanic</span><span class="p">(</span><span class="nx">ents</span><span class="p">[</span><span class="nx">position</span><span class="p">].</span><span class="nx">Data</span><span class="p">)</span>

        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">c</span><span class="p">.</span><span class="nx">gcC</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">gc</span><span class="p">{</span><span class="nx">index</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">appliedIndex</span><span class="p">,</span> <span class="nx">state</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">confState</span><span class="p">,</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">ents</span><span class="p">[</span><span class="nx">position</span><span class="p">].</span><span class="nx">Data</span><span class="p">}:</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Accumulated %d bytes since last snapshot, exceeding size limit (%d bytes), &#34;</span><span class="o">+</span>
                <span class="s">&#34;taking snapshot at block [%d] (index: %d), last snapshotted block number is %d, current nodes: %+v&#34;</span><span class="p">,</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">accDataSize</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sizeLimit</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">appliedIndex</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lastSnapBlockNum</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">confState</span><span class="p">.</span><span class="nx">Nodes</span><span class="p">)</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">accDataSize</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">lastSnapBlockNum</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">SnapshotBlockNumber</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Number</span><span class="p">))</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;Snapshotting is in progress, it is very likely that SnapshotIntervalSize is too small&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/hyperledger-fabric/">hyperledger fabric</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/amazon-elasticsearch-service-is-now-amazon-opensearch-service/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Amazon Elasticsearch Service is renamed Amazon OpenSearch Service</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/http-response-write-timeout/">
            <span class="next-text nav-default">EOF error caused by Go HTTP Response write timeout</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
