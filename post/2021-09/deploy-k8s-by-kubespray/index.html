<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deploying a kubernetes cluster with Kubespray native development tests - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="The company&amp;rsquo;s PaaS platform uses the open source kubespray for the underlying kubernetes cluster deployment, and I was involved in the kubespray second-opening work. During this period, I mainly completed kubespray automated packaging and release pipeline, private deployment, added self-research CNI deployment, and some bugfixes. I recently took time to organize and summarize some of the pitfalls of using kubespray to deploy kubernetes clusters for local development and testing. Prepare" /><meta name="keywords" content="K8s, Kubespray" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/deploy-k8s-by-kubespray/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Deploying a kubernetes cluster with Kubespray native development tests" />
<meta property="og:description" content="The company&rsquo;s PaaS platform uses the open source kubespray for the underlying kubernetes cluster deployment, and I was involved in the kubespray second-opening work. During this period, I mainly completed kubespray automated packaging and release pipeline, private deployment, added self-research CNI deployment, and some bugfixes. I recently took time to organize and summarize some of the pitfalls of using kubespray to deploy kubernetes clusters for local development and testing. Prepare" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/deploy-k8s-by-kubespray/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-13T19:19:59+08:00" />
<meta property="article:modified_time" content="2021-09-13T19:19:59+08:00" />

<meta itemprop="name" content="Deploying a kubernetes cluster with Kubespray native development tests">
<meta itemprop="description" content="The company&rsquo;s PaaS platform uses the open source kubespray for the underlying kubernetes cluster deployment, and I was involved in the kubespray second-opening work. During this period, I mainly completed kubespray automated packaging and release pipeline, private deployment, added self-research CNI deployment, and some bugfixes. I recently took time to organize and summarize some of the pitfalls of using kubespray to deploy kubernetes clusters for local development and testing. Prepare"><meta itemprop="datePublished" content="2021-09-13T19:19:59+08:00" />
<meta itemprop="dateModified" content="2021-09-13T19:19:59+08:00" />
<meta itemprop="wordCount" content="4145">
<meta itemprop="keywords" content="k8s,kubespray," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploying a kubernetes cluster with Kubespray native development tests"/>
<meta name="twitter:description" content="The company&rsquo;s PaaS platform uses the open source kubespray for the underlying kubernetes cluster deployment, and I was involved in the kubespray second-opening work. During this period, I mainly completed kubespray automated packaging and release pipeline, private deployment, added self-research CNI deployment, and some bugfixes. I recently took time to organize and summarize some of the pitfalls of using kubespray to deploy kubernetes clusters for local development and testing. Prepare"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deploying a kubernetes cluster with Kubespray native development tests</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-13 19:19:59 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 4145 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#prepare">Prepare</a>
          <ul>
            <li><a href="#domain-name-ssl-certificate-creation">Domain Name SSL Certificate Creation</a></li>
            <li><a href="#build-mirror-repository">Build mirror repository</a></li>
            <li><a href="#file-server">File Server</a></li>
            <li><a href="#compile-and-install-skopeo">Compile and install skopeo</a></li>
            <li><a href="#get-the-binaries-needed-for-deployment">Get the binaries needed for deployment</a></li>
            <li><a href="#get-the-images-you-need-for-deployment">Get the images you need for deployment</a></li>
          </ul>
        </li>
        <li><a href="#configuration">Configuration</a>
          <ul>
            <li><a href="#inventory">inventory</a></li>
            <li><a href="#vars">vars</a></li>
            <li><a href="#docker-ce-mirrors">docker-ce mirrors</a></li>
          </ul>
        </li>
        <li><a href="#deployment">Deployment</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The company&rsquo;s PaaS platform uses the open source kubespray for the underlying kubernetes cluster deployment, and I was involved in the kubespray second-opening work. During this period, I mainly completed kubespray automated packaging and release pipeline, private deployment, added self-research CNI deployment, and some bugfixes. I recently took time to organize and summarize some of the pitfalls of using kubespray to deploy kubernetes clusters for local development and testing.</p>
<h2 id="prepare">Prepare</h2>
<ul>
<li>Need a deployment image repository and nginx</li>
<li>A domain name is required, preferably with DNS resolution and SSL certificates already set up</li>
<li>The cluster node needs to have at least two machines with access to the extranet</li>
</ul>
<p>Although I have a large number of development machines on hand, I can&rsquo;t resolve DNS to these Chinese servers because my domain name <code>k8s.li</code> is special and difficult to file in China (and I don&rsquo;t want to file). So I plan to resolve the domain name to a foreign server, and then use nginx rewrite to forward the request to AliCloud OSS; in addition, the backend storage of docker registry can also choose to use AliCloud OSS, so that when the client pulls the image, it will only get the manifest file of the image through my domain name, and the image&rsquo;s During cluster deployment, the most important traffic for downloading files and mirrors will go through AliCloud OSS, which can save cluster deployment time and improve deployment efficiency, while leaving a server traffic cost.</p>
<h3 id="domain-name-ssl-certificate-creation">Domain Name SSL Certificate Creation</h3>
<p>If the certificate is self-signed or the mirror repository uses the HTTP protocol, this will cause docker or containerd to be unable to pull mirrors and require the <code>insecure-registries</code> parameter to be configured for all nodes in the cluster. This is a bit of a pain, so it is recommended to add a non-self-signed SSL certificate to the mirror repository to reduce some of the unnecessary hassles. If you have a ready-made mirror repository with an SSL certificate configured, you can skip this step.</p>
<p>There are many ways to create domain certificates, but I recommend using acme.sh. It implements all the authentication protocols supported by the acme protocol, and supports dozens of domain name resolvers. As my domain is hosted on cloudflare, using acme.sh to issue certificates is particularly convenient, only two parameters need to be configured. The following to k8s.li this domain name issued a pan-domain certificate.</p>
<ul>
<li>
<p>Install acme.sh</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl https://get.acme.sh <span class="p">|</span> sh
~/.acme.sh/acme.sh --help
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Issuing Certificate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">CF_Email</span><span class="o">=</span><span class="s2">&#34;muzi502.li@gmail.com&#34;</span> <span class="c1"># cloudflare 账户的邮箱</span>
<span class="nb">export</span> <span class="nv">CF_Key</span><span class="o">=</span><span class="s2">&#34;xxxxxx&#34;</span> <span class="c1"># &#34;cloudflare中查看你的key&#34;</span>

~/.acme.sh/acme.sh --issue --dns dns_cf -d k8s.li -d *.k8s.li

<span class="o">[</span>Tue Apr <span class="m">27</span> 07:32:52 UTC 2021<span class="o">]</span> Cert success.
<span class="o">[</span>Tue Apr <span class="m">27</span> 07:32:52 UTC 2021<span class="o">]</span> Your cert is in  /root/.acme.sh/k8s.li/k8s.li.cer
<span class="o">[</span>Tue Apr <span class="m">27</span> 07:32:52 UTC 2021<span class="o">]</span> Your cert key is in  /root/.acme.sh/k8s.li/k8s.li.key
<span class="o">[</span>Tue Apr <span class="m">27</span> 07:32:52 UTC 2021<span class="o">]</span> The intermediate CA cert is in  /root/.acme.sh/k8s.li/ca.cer
<span class="o">[</span>Tue Apr <span class="m">27</span> 07:32:52 UTC 2021<span class="o">]</span> And the full chain certs is there:  /root/.acme.sh/k8s.li/fullchain.cer
</code></pre></td></tr></table>
</div>
</div><p>After the previous certificate is generated, you need to copy the certificate to the place where you really need to use it.</p>
<p>Note that the default generated certificates are placed in the installation directory <code>~/.acme.sh/</code>, please do not use the files in this directory directly, e.g. do not let the <code>nginx/apache</code> configuration file use the files under it. The files in this directory are used internally and the directory structure may change.</p>
<p>The correct way to use it is to use the <code>-installcert</code> command and specify the target location, then the certificate file will be copied to the appropriate location</p>
</li>
<li>
<p>Installation certificate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">acme.sh --install-cert -d k8s.li <span class="se">\
</span><span class="se"></span>--cert-file      /etc/nginx/ssl/k8s.li.cer  <span class="se">\
</span><span class="se"></span>--key-file       /etc/nginx/ssl/k8s.li.key  <span class="se">\
</span><span class="se"></span>--fullchain-file /etc/nginx/ssl/fullchain.cer
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="build-mirror-repository">Build mirror repository</h3>
<ul>
<li>
<p>config.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.1</span><span class="w">
</span><span class="w"></span><span class="nt">log</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">fields</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">registry</span><span class="w">
</span><span class="w"></span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">cache</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">blobdescriptor</span><span class="p">:</span><span class="w"> </span><span class="l">inmemory</span><span class="w">
</span><span class="w"></span><span class="nt">oss</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">accesskeyid</span><span class="p">:</span><span class="w"> </span><span class="l">xxxx</span><span class="w"> </span><span class="c"># 这里配置阿里云 OSS 的 accesskeyid</span><span class="w">
</span><span class="w">    </span><span class="nt">accesskeysecret</span><span class="p">:</span><span class="w"> </span><span class="l">xxxx</span><span class="w"> </span><span class="c"># 这里配置阿里云 OSS 的 accesskeysecret</span><span class="w">
</span><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">oss-cn-beijing</span><span class="w"> </span><span class="c"># 配置 OSS bucket 的区域，比如 oss-cn-beijing</span><span class="w">
</span><span class="w">    </span><span class="nt">internal</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">bucket</span><span class="p">:</span><span class="w"> </span><span class="l">fileserver</span><span class="w"> </span><span class="c"># 配置存储 bucket 的名称</span><span class="w">
</span><span class="w">    </span><span class="nt">rootdirectory</span><span class="p">:</span><span class="w"> </span><span class="l">/kubespray/registry</span><span class="w"> </span><span class="c"># 配置路径</span><span class="w">
</span><span class="w"></span><span class="nt">delete</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">http</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">addr</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">5000</span><span class="w">
</span><span class="w"></span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">X-Content-Type-Options</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nosniff]</span><span class="w">
</span><span class="w"></span><span class="nt">health</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">storagedriver</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>docker-compose</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">hub-registry</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry:2.7.1</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">hub-registry</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">./config.yml:/etc/docker/registry/config.yml</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="m">127.0.0.1</span><span class="p">:</span><span class="m">5000</span><span class="p">:</span><span class="m">5000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>nginx.conf</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">listen</span>       <span class="s">[::]:443</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">hub.k8s.li</span><span class="p">;</span>
    <span class="kn">ssl_certificate</span> <span class="s">/etc/nginx/ssl/fullchain.cer</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/nginx/ssl/k8s.li.key</span><span class="p">;</span>
    <span class="kn">gzip_static</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">client_max_body_size</span> <span class="mi">4096m</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="s">!~*</span> <span class="s">GET)</span> <span class="p">{</span>
        <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_pass</span>   <span class="s">http://localhost:5000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="file-server">File Server</h3>
<p>The file server is used to store some binaries such as kubeadm, kubectl, kubelet, etc. The default download address of kubespray is particularly slow in China, so an http/https server needs to be built to download these binaries for cluster deployments.</p>
<ul>
<li>
<p>nginx.conf</p>
<p>Note that the nginx configuration here uses rewrite instead of proxy_pass, so that when the client wants to request a file from my server, it will rewrite the client&rsquo;s request and let the client request the AliCloud OSS address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:443</span><span class="p">;</span>
    <span class="kn">server_name</span>   <span class="s">dl.k8s.li</span><span class="p">;</span>
    <span class="kn">ssl_certificate</span> <span class="s">/etc/nginx/ssl/fullchain.cer</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/nginx/ssl/k8s.li.key</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$ <span class="s">https://fileserver.oss-cn-beijing.aliyuncs.com/kubespray/files/</span><span class="nv">$1</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">Content-Disposition</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-request-id</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-object-type</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-hash-crc64ecma</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-storage-class</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-force-download</span><span class="p">;</span>
        <span class="kn">proxy_hide_header</span> <span class="s">x-oss-server-time</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="compile-and-install-skopeo">Compile and install skopeo</h3>
<p>Installing skopeo to synchronize some used images to a private image repository is much faster than docker, and is highly recommended. skopeo installation can be found in the official documentation <a href="https://github.com/containers/skopeo/blob/master/install.md">Installing from packages</a>. However, I personally use go buid to compile a statically linked executable so that it can be used in all Linux distributions. Otherwise, the executable compiled on Debian cannot be used on CentOS because they use different dynamic link libraries!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root/skopeo git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># git clone https://github.com/containers/skopeo &amp;&amp; cd skopeo</span>

<span class="c1"># 本地开发机器已经安装并配置好了 golang 编译环境</span>
root@debian:/root/skopeo git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor &#34;-buildmode=pie&#34; -ldflags &#39;-extldflags &#34;-static&#34;&#39; -gcflags &#34;&#34; -tags &#34;exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp&#34; -o bin/skopeo ./cmd/skopeo</span>

root@debian:/root/skopeo git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># ldd bin/skopeo</span>
not a dynamic executable
</code></pre></td></tr></table>
</div>
</div><h3 id="get-the-binaries-needed-for-deployment">Get the binaries needed for deployment</h3>
<p>When deploying kubespray, we need to download some binaries from github.com or storage.googleapis.com, which are blocked in China, so we need to upload the files we depend on to our own file server. I wrote a script to get the binaries needed for kubespray deployment, and executed it in the root directory of the kubespray repo, where the downloaded files are stored in the <code>temp/files</code> directory by default. After the download is complete, upload all subdirectories in this directory to your own file server. You can configure some parameters later by adding the URL of your file server in front of this address.</p>
<ul>
<li>
<p>First clone repo to local</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root# git clone https://github.com/kubernetes-sigs/kubespray <span class="o">&amp;&amp;</span> <span class="nb">cd</span> kubespray
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Save the script <code>generate_list.sh</code> to the repo root directory and execute the footer to download the required files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nb">set</span> -eo pipefail

<span class="nv">CURRENT_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span><span class="p">;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TEMP_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CURRENT_DIR</span><span class="si">}</span><span class="s2">/temp&#34;</span>
<span class="nv">REPO_ROOT_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CURRENT_DIR</span><span class="si">}</span><span class="s2">&#34;</span>

: <span class="si">${</span><span class="nv">IMAGE_ARCH</span><span class="p">:=</span><span class="s2">&#34;amd64&#34;</span><span class="si">}</span>
: <span class="si">${</span><span class="nv">ANSIBLE_SYSTEM</span><span class="p">:=</span><span class="s2">&#34;linux&#34;</span><span class="si">}</span>
: <span class="si">${</span><span class="nv">ANSIBLE_ARCHITECTURE</span><span class="p">:=</span><span class="s2">&#34;x86_64&#34;</span><span class="si">}</span>
: <span class="si">${</span><span class="nv">DOWNLOAD_YML</span><span class="p">:=</span><span class="s2">&#34;roles/download/defaults/main.yml&#34;</span><span class="si">}</span>
: <span class="si">${</span><span class="nv">KUBE_VERSION_YAML</span><span class="p">:=</span><span class="s2">&#34;roles/kubespray-defaults/defaults/main.yaml&#34;</span><span class="si">}</span>

mkdir -p <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>
generate_versions<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># ARCH used in convert {%- if image_arch != &#39;amd64&#39; -%}-{{ image_arch }}{%- endif -%} to {{arch}}</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">IMAGE_ARCH</span><span class="si">}</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;amd64&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">ARCH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">IMAGE_ARCH</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">fi</span>

    cat &gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/version.sh <span class="s">&lt;&lt; EOF
</span><span class="s">arch=${ARCH}
</span><span class="s">image_arch=${IMAGE_ARCH}
</span><span class="s">ansible_system=${ANSIBLE_SYSTEM}
</span><span class="s">ansible_architecture=${ANSIBLE_ARCHITECTURE}
</span><span class="s">EOF</span>
    grep <span class="s1">&#39;kube_version:&#39;</span> <span class="si">${</span><span class="nv">REPO_ROOT_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">KUBE_VERSION_YAML</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s1">&#39;s/: /=/g&#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/version.sh
    grep <span class="s1">&#39;_version:&#39;</span> <span class="si">${</span><span class="nv">REPO_ROOT_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DOWNLOAD_YML</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s1">&#39;s/: /=/g;s/{{/${/g;s/}}/}/g&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39; &#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/version.sh
    sed -i <span class="s1">&#39;s/kube_major_version=.*/kube_major_version=${kube_version%.*}/g&#39;</span> <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/version.sh
    sed -i <span class="s1">&#39;s/crictl_version=.*/crictl_version=${kube_version%.*}.0/g&#39;</span> <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/version.sh
<span class="o">}</span>

generate_files_list<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&#34;source </span><span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span><span class="s2">/version.sh&#34;</span> &gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files.sh
    grep <span class="s1">&#39;download_url:&#39;</span> <span class="si">${</span><span class="nv">REPO_ROOT_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DOWNLOAD_YML</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s1">&#39;s/: /=/g;s/ //g;s/{{/${/g;s/}}/}/g;s/|lower//g;s/^.*_url=/echo /g&#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files.sh
    bash <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files.sh <span class="p">|</span> sort &gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files.list
<span class="o">}</span>

generate_images_list<span class="o">()</span> <span class="o">{</span>
    <span class="nv">KUBE_IMAGES</span><span class="o">=</span><span class="s2">&#34;kube-apiserver kube-controller-manager kube-scheduler kube-proxy&#34;</span>
    <span class="nb">echo</span> <span class="s2">&#34;source </span><span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span><span class="s2">/version.sh&#34;</span> &gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.sh
    grep -E <span class="s1">&#39;_repo:|_tag:&#39;</span> <span class="si">${</span><span class="nv">REPO_ROOT_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DOWNLOAD_YML</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s2">&#34;s#{%- if image_arch != &#39;amd64&#39; -%}-{{ image_arch }}{%- endif -%}#{{arch}}#g&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s1">&#39;s/: /=/g;s/{{/${/g;s/}}/}/g&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39; &#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.sh
    sed -n <span class="s1">&#39;/^downloads:/,/download_defaults:/p&#39;</span> <span class="si">${</span><span class="nv">REPO_ROOT_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DOWNLOAD_YML</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed -n <span class="s2">&#34;s/repo: //p;s/tag: //p&#34;</span> <span class="p">|</span> tr -d <span class="s1">&#39; &#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/{{/${/g;s/}}/}/g&#39;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> sed <span class="s1">&#39;N;s#\n# #g&#39;</span> <span class="p">|</span> tr <span class="s1">&#39; &#39;</span> <span class="s1">&#39;:&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/^/echo /g&#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.sh
    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">KUBE_IMAGES</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> tr <span class="s1">&#39; &#39;</span> <span class="s1">&#39;\n&#39;</span> <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> <span class="se">\
</span><span class="se"></span>    <span class="nb">echo</span> <span class="s1">&#39;echo ${kube_image_repo}/{}:${kube_version}&#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.sh
    bash <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.sh <span class="p">|</span> sort &gt; <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/images.list
<span class="o">}</span>

generate_versions
generate_files_list
generate_images_list
wget -x -P <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files -i <span class="si">${</span><span class="nv">TEMP_DIR</span><span class="si">}</span>/files.list
</code></pre></td></tr></table>
</div>
</div><p>The final result of the download is as follows, which basically maintains the original URL path and facilitates subsequent updates and version iterations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">temp/files
├── get.helm.sh
│   └── helm-v3.5.4-linux-amd64.tar.gz
├── github.com
│   ├── containerd
│   │   └── nerdctl
│   │       └── releases
│   │           └── download
│   │               └── v0.8.0
│   │                   └── nerdctl-0.8.0-linux-amd64.tar.gz
│   ├── containernetworking
│   │   └── plugins
│   │       └── releases
│   │           └── download
│   │               └── v0.9.1
│   │                   └── cni-plugins-linux-amd64-v0.9.1.tgz
│   ├── containers
│   │   └── crun
│   │       └── releases
│   │           └── download
│   │               └── 0.19
│   │                   └── crun-0.19-linux-amd64
│   ├── coreos
│   │   └── etcd
│   │       └── releases
│   │           └── download
│   │               └── v3.4.13
│   │                   └── etcd-v3.4.13-linux-amd64.tar.gz
│   ├── kata-containers
│   │   └── runtime
│   │       └── releases
│   │           └── download
│   │               └── 1.12.1
│   │                   └── kata-static-1.12.1-x86_64.tar.xz
│   ├── kubernetes-sigs
│   │   └── cri-tools
│   │       └── releases
│   │           └── download
│   │               └── v1.20.0
│   │                   └── crictl-v1.20.0-linux-amd64.tar.gz
│   └── projectcalico
│       ├── calico
│       │   └── archive
│       │       └── v3.17.3.tar.gz
│       └── calicoctl
│           └── releases
│               └── download
│                   └── v3.17.3
│                       └── calicoctl-linux-amd64
└── storage.googleapis.com
    └── kubernetes-release
        └── release
            └── v1.20.6
                └── bin
                    └── linux
                        └── amd64
                            ├── kubeadm
                            ├── kubectl
                            └── kubelet
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="get-the-images-you-need-for-deployment">Get the images you need for deployment</h3>
<p>For offline deployment, kubespray support is not very friendly. For example, to get the list of mirrors needed for deployment, the current solution is to deploy a cluster first and then get some resources to get the mirrors used by the pod through kubectl. Personally, I think this approach can be modified, for example, by generating a list of mirrors from the kubespray source code. The following is just a simple list of mirrors, with the following content</p>
<ul>
<li>
<p>images.list</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker.io/nginx:1.19.0
docker.io/calico/cni:v3.17.3
docker.io/calico/node:v3.17.3
docker.io/calico/kube-controllers:v3.17.3
quay.io/coreos/flannel:v0.13.0
quay.io/coreos/flannel:v0.13.0-amd64
k8s.gcr.io/pause:3.2
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/kube-apiserver:v1.20.6
k8s.gcr.io/kube-controller-manager:v1.20.6
k8s.gcr.io/kube-proxy:v1.20.6
k8s.gcr.io/kube-scheduler:v1.20.6
k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1
k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3
</code></pre></td></tr></table>
</div>
</div><p>Since the master branch code is always being updated, the current version of the master branch may not be the same as the one here, so you need to change it to the version you need.</p>
</li>
<li>
<p>Based on the list of mirrors above, use skopeo to sync the mirrors to your own mirror repository, such as my <code>hub.k8s.li</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="k">for</span> image in <span class="k">$(</span>cat images.list<span class="k">)</span><span class="p">;</span> <span class="k">do</span> skopeo copy docker://<span class="si">${</span><span class="nv">image</span><span class="si">}</span> docker://hub.k8s.li/<span class="si">${</span><span class="nv">image</span><span class="p">#*/</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>Synced to my mirror repository, the content will be as follows, by modifying the address of some mirror repositories during the deployment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">hub.k8s.li/nginx:1.19.0
hub.k8s.li/calico/cni:v3.17.3
hub.k8s.li/calico/node:v3.17.3
hub.k8s.li/calico/kube-controllers:v3.17.3
hub.k8s.li/coreos/flannel:v0.13.0
hub.k8s.li/coreos/flannel:v0.13.0-amd64
hub.k8s.li/pause:3.2
hub.k8s.li/coredns:1.7.0
hub.k8s.li/kube-apiserver:v1.20.6
hub.k8s.li/kube-controller-manager:v1.20.6
hub.k8s.li/kube-proxy:v1.20.6
hub.k8s.li/kube-scheduler:v1.20.6
hub.k8s.li/dns/k8s-dns-node-cache:1.17.1
hub.k8s.li/cpa/cluster-proportional-autoscaler-amd64:1.8.3
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>The preparations are now largely complete, so let&rsquo;s start configuring some parameters and inventory files for kubespray</p>
<h2 id="configuration">Configuration</h2>
<p>Follow the kubespray documentation to make a copy of the <code>inventory/sample</code> directory and then control the deployment by modifying the parameters there.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root/kubespray git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># cp -rf inventory/sample deploy</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="inventory">inventory</h3>
<ul>
<li>
<p>deploy/inventory</p>
<p>Create a host inventory file in the following format.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="p">[</span><span class="l">all:vars]</span><span class="w">
</span><span class="w"></span><span class="l">ansible_port=22</span><span class="w">
</span><span class="w"></span><span class="l">ansible_user=root</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">ansible_ssh_private_key_file=/kubespray/.ssh/id_rsa</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">all]</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-1 ansible_host=192.168.4.11</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-2 ansible_host=192.168.4.12</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-3 ansible_host=192.168.4.13</span><span class="w">
</span><span class="w"></span><span class="l">kube-node-1 ansible_host=192.168.4.4</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">kube_control_plane]</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-1</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-2</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-3</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">etcd]</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-1</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-2</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-3</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">kube-node]</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-1</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-2</span><span class="w">
</span><span class="w"></span><span class="l">kube-control-3</span><span class="w">
</span><span class="w"></span><span class="l">kube-node-1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">calico-rr]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="l">k8s-cluster:children]</span><span class="w">
</span><span class="w"></span><span class="l">kube_control_plane</span><span class="w">
</span><span class="w"></span><span class="l">kube-node</span><span class="w">
</span><span class="w"></span><span class="l">calico-rr</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ssh mutual trust</p>
<p>Kubespray uses ansible&rsquo;s <a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html">synchronize</a> module to distribute files, based on the rsync protocol, so you must use ssh key pairs to connect to cluster nodes. inventory is configured as a path within the kubespray container, so you need to copy the ssh public and private keys to the repo&rsquo;s .ssh directory. If the node does not have ssh-free login, you can use the authorized_key module of ansible to add the ssh public key to the authorized_key of the host. The procedure is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">root@debian:/root/kubespray git:(master*)</span><span class="w"> </span><span class="c"># mkdir -p .ssh</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 生成 ssh 密钥对</span><span class="w">
</span><span class="w"></span><span class="l">root@debian:/root/kubespray git:(master*)</span><span class="w"> </span><span class="c"># ssh-keygen -t rsa -f .ssh/id_rsa -P &#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 将 ssh 公钥添加到所有主机</span><span class="w">
</span><span class="w"></span><span class="l">root@debian:/root/kubespray git:(master*)</span><span class="w"> </span><span class="c"># ansible -i deploy/inventory all -m authorized_key -a &#34;user={{ ansible_user }} key=&#39;{{ lookup(&#39;file&#39;, &#39;{{ ssh_cert_path }}&#39;) }}&#39;&#34; -e ssh_cert_path=./.ssh/id_rsa.pub -e ansible_ssh_pass=passwd</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="vars">vars</h3>
<p>Create and modify the following configuration file</p>
<ul>
<li>
<p>deploy/env.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># 定义一些组件的版本</span><span class="w">
</span><span class="w"></span><span class="nt">kube_version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.20.6</span><span class="w">
</span><span class="w"></span><span class="nt">calico_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v3.17.3&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">pod_infra_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.2&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">nginx_image_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1.19&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">coredns_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1.7.0&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">image_arch</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;amd64&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># docker registry domain</span><span class="w">
</span><span class="w"></span><span class="nt">registry_domain</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hub.k8s.li&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># file download server url</span><span class="w">
</span><span class="w"></span><span class="nt">download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://dl.k8s.li&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># docker-ce-repo mirrors</span><span class="w">
</span><span class="w"></span><span class="nt">docker_mirrors_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">container_manager</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;containerd&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 由于使用的是 containerd 作为 CRI，目前 etcd 不支持 containerd 容器化部署因此需要将该参数修改为 host ，使用 systemd 来部署</span><span class="w">
</span><span class="w"></span><span class="nt">etcd_deployment_type</span><span class="p">:</span><span class="w"> </span><span class="l">host</span><span class="w">
</span><span class="w"></span><span class="nt">etcd_cluster_setup</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">etcd_events_cluster_setup</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">etcd_events_cluster_enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># kubernetes CNI type 配置集群 CNI 使用的类型</span><span class="w">
</span><span class="w"></span><span class="nt">kube_network_plugin</span><span class="p">:</span><span class="w"> </span><span class="l">canal</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>deploy/group_vars/all/download.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">## Container registry define</span><span class="w">
</span><span class="w"></span><span class="nt">gcr_image_repo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ registry_domain }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kube_image_repo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ registry_domain }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_image_repo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ registry_domain }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">quay_image_repo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ registry_domain }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Download URLs</span><span class="w">
</span><span class="w"></span><span class="nt">kubelet_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/storage.googleapis.com/kubernetes-release/release/{{ kube_version }}/bin/linux/{{ image_arch }}/kubelet&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kubectl_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/storage.googleapis.com/kubernetes-release/release/{{ kube_version }}/bin/linux/{{ image_arch }}/kubectl&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kubeadm_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/storage.googleapis.com/kubernetes-release/release/{{ kubeadm_version }}/bin/linux/{{ image_arch }}/kubeadm&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">etcd_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/coreos/etcd/releases/download/{{ etcd_version }}/etcd-{{ etcd_version }}-linux-{{ image_arch }}.tar.gz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">cni_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/containernetworking/plugins/releases/download/{{ cni_version }}/cni-plugins-linux-{{ image_arch }}-{{ cni_version }}.tgz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">calicoctl_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/projectcalico/calicoctl/releases/download/{{ calico_ctl_version }}/calicoctl-linux-{{ image_arch }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">calico_crds_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/projectcalico/calico/archive/{{ calico_version }}.tar.gz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">crictl_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/kubernetes-sigs/cri-tools/releases/download/{{ crictl_version }}/crictl-{{ crictl_version }}-{{ ansible_system | lower }}-{{ image_arch }}.tar.gz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">helm_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/get.helm.sh/helm-{{ helm_version }}-linux-{{ image_arch }}.tar.gz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">crun_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/containers/crun/releases/download/{{ crun_version }}/crun-{{ crun_version }}-linux-{{ image_arch }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kata_containers_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/kata-containers/runtime/releases/download/{{ kata_containers_version }}/kata-static-{{ kata_containers_version }}-{{ ansible_architecture }}.tar.xz&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">nerdctl_download_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ download_url }}/github.com/containerd/nerdctl/releases/download/v{{ nerdctl_version }}/nerdctl-{{ nerdctl_version }}-{{ ansible_system | lower }}-{{ image_arch }}.tar.gz&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="docker-ce-mirrors">docker-ce mirrors</h3>
<p>When kubespray installs docker or containerd containers to run, you need to use the docker-ce source, and you can use Tsinghua&rsquo;s image source in China. Depending on the Linux distribution, you can add these parameters to the <code>deploy/group_vars/all/offline.yml</code> file. The parameter <code>docker_mirrors_url</code> is the parameter set in <code>env.yml</code>.</p>
<ul>
<li>
<p>CentOS/Redhat</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">## CentOS/Redhat</span><span class="w">
</span><span class="w"></span><span class="c">### For EL7, base and extras repo must be available, for EL8, baseos and appstream</span><span class="w">
</span><span class="w"></span><span class="c">### By default we enable those repo automatically</span><span class="w">
</span><span class="w"></span><span class="c"># rhel_enable_repos: false</span><span class="w">
</span><span class="w"></span><span class="c">### Docker / Containerd</span><span class="w">
</span><span class="w"></span><span class="nt">docker_rh_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/centos/{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/stable&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_rh_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/centos/gpg&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Fedora</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">## Fedora</span><span class="w">
</span><span class="w"></span><span class="c">### Docker</span><span class="w">
</span><span class="w"></span><span class="nt">docker_fedora_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/fedora/{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/stable&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_fedora_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/fedora/gpg&#34;</span><span class="w">
</span><span class="w"></span><span class="c">### Containerd</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_fedora_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/fedora/{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/stable&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_fedora_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/fedora/gpg&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>debian</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">## Debian</span><span class="w">
</span><span class="w"></span><span class="c">### Docker</span><span class="w">
</span><span class="w"></span><span class="nt">docker_debian_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/debian&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_debian_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/debian/gpg&#34;</span><span class="w">
</span><span class="w"></span><span class="c">### Containerd</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_debian_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/debian&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_debian_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/debian/gpg&#34;</span><span class="w">
</span><span class="w"></span><span class="c"># containerd_debian_repo_repokey: &#39;YOURREPOKEY&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ubuntu</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">## Ubuntu</span><span class="w">
</span><span class="w"></span><span class="c">### Docker</span><span class="w">
</span><span class="w"></span><span class="nt">docker_ubuntu_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/ubuntu&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_ubuntu_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/ubuntu/gpg&#34;</span><span class="w">
</span><span class="w"></span><span class="c">### Containerd</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_ubuntu_repo_base_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/ubuntu&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">containerd_ubuntu_repo_gpgkey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ docker_mirrors_url }}/ubuntu/gpg&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>After preparing the configuration above, it&rsquo;s time to start the deployment. When using ansible for deployment, I prefer to operate in a kubespray container rather than installing python3 on the local development machine. For offline deployments, it is more convenient to build the image in advance and use a docker container.</p>
<ul>
<li>
<p>Build Mirror</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root/kubespray git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># docker build -t kubespray:v2.15.1-kube-v1.20.6 .</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Run the kubespray container</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root/kubespray git:<span class="o">(</span>master*<span class="o">)</span> <span class="c1"># docker run --rm -it --net=host -v $PWD:/kubespray kubespray:v2.15.1-kube-v1.20.6 bash</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Test if the host is connected properly</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/kubespray# ansible -i cluster/inventory all -m ping
kube-control-3 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python&#34;</span>
    <span class="o">}</span>,
    <span class="s2">&#34;changed&#34;</span>: false,
    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
<span class="o">}</span>
kube-control-1 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python&#34;</span>
    <span class="o">}</span>,
    <span class="s2">&#34;changed&#34;</span>: false,
    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
<span class="o">}</span>
kube-node-1 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python&#34;</span>
    <span class="o">}</span>,
    <span class="s2">&#34;changed&#34;</span>: false,
    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
<span class="o">}</span>
kube-control-2 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python&#34;</span>
    <span class="o">}</span>,
    <span class="s2">&#34;changed&#34;</span>: false,
    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Start cluster deployment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/kubespray# ansible-playbook -i deploy/inventory -e <span class="s2">&#34;@deploy/env.yml&#34;</span> cluster.yml
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The deployment completion log is as follows, when failed is 0, it means the tasks have been successfully run</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">PLAY RECAP ******************************************************************
kube-control-1             : ok=526  changed=67   unreachable=0    failed=0    skipped=978  rescued=0    ignored=0
kube-control-2             : ok=524  changed=66   unreachable=0    failed=0    skipped=980  rescued=0    ignored=0
kube-control-3             : ok=593  changed=76   unreachable=0    failed=0    skipped=1125 rescued=0    ignored=1
kube-node-1                : ok=366  changed=34   unreachable=0    failed=0    skipped=628  rescued=0    ignored=0
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

Wednesday 28 April 2021  10:57:57 +0000 (0:00:00.115)       0:15:21.190 *******
===============================================================================
kubernetes/control-plane : kubeadm | Initialize first master -------------- 65.88s
kubernetes/control-plane : Joining control plane node to the cluster. ----- 50.05s
kubernetes/kubeadm : Join to cluster -------------------------------------- 31.54s
download_container | Download image if required --------------------------- 24.38s
reload etcd --------------------------------------------------------------- 20.56s
Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 19.32s
Gen_certs | Write node certs to other etcd nodes -------------------------- 19.14s
Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 17.45s
network_plugin/canal : Canal | Create canal node manifests ---------------- 15.41s
kubernetes-apps/ansible : Kubernetes Apps | Lay Down CoreDNS Template ----- 13.27s
kubernetes/control-plane : Master | wait for kube-scheduler --------------- 11.97s
download_container | Download image if required --------------------------- 11.76s
Gen_certs | Write node certs to other etcd nodes -------------------------- 10.50s
kubernetes-apps/ansible : Kubernetes Apps | Start Resources ---------------- 8.28s
policy_controller/calico : Create calico-kube-controllers manifests -------- 7.61s
kubernetes/control-plane : set kubeadm certificate key --------------------- 6.32s
download : extract_file | Unpacking archive -------------------------------- 5.51s
Configure | Check if etcd cluster is healthy ------------------------------- 5.41s
Configure | Check if etcd-events cluster is healthy ------------------------ 5.41s
kubernetes-apps/network_plugin/canal : Canal | Start Resources ------------- 4.85s
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Cluster Status</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[root@kube-control-1 ~]# kubectl get node -o wide
NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
kube-control-1   Ready    control-plane,master   5m24s   v1.20.6   192.168.4.11   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4
kube-control-2   Ready    control-plane,master   5m40s   v1.20.6   192.168.4.12   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4
kube-control-3   Ready    control-plane,master   6m28s   v1.20.6   192.168.4.13   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4
kube-node-1      Ready    &lt;none&gt;                 3m53s   v1.20.6   192.168.4.14   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Cluster Component Status</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[root@kube-control-1 ~]# kubectl get all -n kube-system
NAME                                           READY   STATUS             RESTARTS   AGE
pod/calico-kube-controllers-67d6cdb559-cwf62   0/1     CrashLoopBackOff   5          4m10s
pod/canal-node-46x2b                           2/2     Running            0          4m25s
pod/canal-node-5rkhq                           2/2     Running            0          4m25s
pod/canal-node-fcsgn                           2/2     Running            0          4m25s
pod/canal-node-nhkp8                           2/2     Running            0          4m25s
pod/coredns-5d578c6f84-5nnp8                   1/1     Running            0          3m33s
pod/coredns-5d578c6f84-w2kvf                   1/1     Running            0          3m39s
pod/dns-autoscaler-6b675c8995-vp282            1/1     Running            0          3m34s
pod/kube-apiserver-kube-control-1              1/1     Running            0          6m51s
pod/kube-apiserver-kube-control-2              1/1     Running            0          7m7s
pod/kube-apiserver-kube-control-3              1/1     Running            0          7m41s
pod/kube-controller-manager-kube-control-1     1/1     Running            0          6m52s
pod/kube-controller-manager-kube-control-2     1/1     Running            0          7m7s
pod/kube-controller-manager-kube-control-3     1/1     Running            0          7m41s
pod/kube-proxy-5dfx8                           1/1     Running            0          5m17s
pod/kube-proxy-fvrqk                           1/1     Running            0          5m17s
pod/kube-proxy-jd84p                           1/1     Running            0          5m17s
pod/kube-proxy-l2mjk                           1/1     Running            0          5m17s
pod/kube-scheduler-kube-control-1              1/1     Running            0          6m51s
pod/kube-scheduler-kube-control-2              1/1     Running            0          7m7s
pod/kube-scheduler-kube-control-3              1/1     Running            0          7m41s
pod/nginx-proxy-kube-node-1                    1/1     Running            0          5m20s
pod/nodelocaldns-77kq9                         1/1     Running            0          3m32s
pod/nodelocaldns-fn5pd                         1/1     Running            0          3m32s
pod/nodelocaldns-lfjzb                         1/1     Running            0          3m32s
pod/nodelocaldns-xnc6n                         1/1     Running            0          3m32s

NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
service/coredns   ClusterIP   10.233.0.3   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m38s

NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/canal-node     4         4         4       4            4           &lt;none&gt;                   4m25s
daemonset.apps/kube-proxy     4         4         4       4            4           kubernetes.io/os=linux   7m53s
daemonset.apps/nodelocaldns   4         4         4       4            4           &lt;none&gt;                   3m32s

NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/calico-kube-controllers   0/1     1            0           4m12s
deployment.apps/coredns                   2/2     2            2           3m39s
deployment.apps/dns-autoscaler            1/1     1            1           3m34s

NAME                                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/calico-kube-controllers-67d6cdb559   1         1         0       4m12s
replicaset.apps/coredns-5d578c6f84                   2         2         2       3m39s
replicaset.apps/dns-autoscaler-6b675c8995            1         1         1       3m34s
</code></pre></td></tr></table>
</div>
</div></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          <a href="/tags/kubespray/">kubespray</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/package-manager-for-arch/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to make a package for Arch </span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/microsofts-gpu-accelerated-ml-training-tensorflow-directml/">
            <span class="next-text nav-default">Microsofts Gpu Accelerated Ml Training Tensorflow Directml</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
