<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Solution for websocket service proxy and data mock - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Mocking data is an inevitable requirement in the collaborative development process with separate front and back ends. There are many mature solutions for data mocking in the common http way, but it becomes more complicated for websocket push mode. Here we share the data request mock solution for websocket services with the help of simple-mock plugin library. Introduction to simple-mock In the case that no other roles such as product" /><meta name="keywords" content="websocket, Mock" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/websocket-mock/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Solution for websocket service proxy and data mock" />
<meta property="og:description" content="Mocking data is an inevitable requirement in the collaborative development process with separate front and back ends. There are many mature solutions for data mocking in the common http way, but it becomes more complicated for websocket push mode. Here we share the data request mock solution for websocket services with the help of simple-mock plugin library. Introduction to simple-mock In the case that no other roles such as product" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/websocket-mock/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-23T14:52:51+08:00" />
<meta property="article:modified_time" content="2021-09-23T14:52:51+08:00" />

<meta itemprop="name" content="Solution for websocket service proxy and data mock">
<meta itemprop="description" content="Mocking data is an inevitable requirement in the collaborative development process with separate front and back ends. There are many mature solutions for data mocking in the common http way, but it becomes more complicated for websocket push mode. Here we share the data request mock solution for websocket services with the help of simple-mock plugin library. Introduction to simple-mock In the case that no other roles such as product"><meta itemprop="datePublished" content="2021-09-23T14:52:51+08:00" />
<meta itemprop="dateModified" content="2021-09-23T14:52:51+08:00" />
<meta itemprop="wordCount" content="2287">
<meta itemprop="keywords" content="websocket," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Solution for websocket service proxy and data mock"/>
<meta name="twitter:description" content="Mocking data is an inevitable requirement in the collaborative development process with separate front and back ends. There are many mature solutions for data mocking in the common http way, but it becomes more complicated for websocket push mode. Here we share the data request mock solution for websocket services with the help of simple-mock plugin library. Introduction to simple-mock In the case that no other roles such as product"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Solution for websocket service proxy and data mock</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-23 14:52:51 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2287 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction-to-simple-mock">Introduction to simple-mock</a>
          <ul>
            <li><a href="#can-be-injected-into-an-existing-server">Can be injected into an existing Server</a></li>
            <li><a href="#zerominimal-configuration-to-enable-mock-mode">Zero/minimal configuration to enable mock mode</a></li>
            <li><a href="#real-time-loading-of-configuration-files-custom-mock-files">Real-time loading of configuration files, custom mock files</a></li>
            <li><a href="#define-public-rules-and-design-different-priorities">Define public rules and design different priorities</a></li>
            <li><a href="#mock-for-some-interfaces">mock for some interfaces</a></li>
          </ul>
        </li>
        <li><a href="#ideas-and-solutions-for-implementing-websocket-service-mock-using-simple-mock">Ideas and solutions for implementing websocket service mock using simple-mock</a>
          <ul>
            <li><a href="#simple-mock-basic-strategy-for-handling-websocket-message-mock">Simple-mock Basic strategy for handling websocket message mock</a></li>
            <li><a href="#one-question-one-answer-one-question-multiple-answer-mode">One question, one answer, one question, multiple answer mode</a></li>
            <li><a href="#login-process-information-pre-loading">Login process, information pre-loading</a></li>
            <li><a href="#mock-push-messaging">Mock Push Messaging</a></li>
            <li><a href="#other">Other</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Mocking data is an inevitable requirement in the collaborative development process with separate front and back ends. There are many mature solutions for data mocking in the common http way, but it becomes more complicated for websocket push mode.</p>
<p>Here we share the data request mock solution for websocket services with the help of <code>simple-mock</code> plugin library.</p>
<h2 id="introduction-to-simple-mock">Introduction to simple-mock</h2>
<p>In the case that no other roles such as product and back-end are involved and only front-end development is facilitated, I personally prefer a simple and lightweight data MOCK solution that does not invade the front-end project, so I developed <a href="https://github.com/lzwme/">simple-mock</a> based on the development pattern of front-end business at work. simple-mock) plug-in library. The solution provided by <code>simple-mock</code> is mainly based on the following requirement points.</p>
<ul>
<li>Can be injected into webpack-dev-server (Vue-cli, Angular-cli) or existing servers such as express, Koa, etc.
<ul>
<li>Proxy the backend service and save the results returned by the interface as the base mock data during the proxy process</li>
<li>Write commonjs/esModule style code as <code>js/ts</code> files to customize mock rules.</li>
</ul>
</li>
<li>Front-end development can enable mock mode with minimal configuration</li>
<li>Ability to load configuration files, custom mock files in real time</li>
<li>You can define public rules and design different priorities</li>
<li>You can mock some interfaces</li>
<li>more&hellip;</li>
</ul>
<h3 id="can-be-injected-into-an-existing-server">Can be injected into an existing Server</h3>
<p>The initial purpose of <code>simple-mock</code> is to implement Server-level Mock functionality without changing the existing architectural model. So <code>simple-mock</code> implements and exports two methods <code>simpleMock.render</code> and <code>simpleMock.saveApi</code> for users to call, and implements the specific mock logic framework internally.</p>
<ul>
<li>The <code>simpleMock.render</code> method implements the mock functionality. It should be injected at the request of the interface and decide whether to mock the current request and how to handle it according to the rules of the configuration file. The specific mock rules are written in js/ts files to achieve the most familiar commonjs code for front-end, no complicated rules to master, almost zero learning cost for front-end developers.</li>
<li>The <code>simpleMock.saveApi</code> method automatically saves the data returned by the server-side interface. It should be called when the server-side API proxy data is returned and decides how to save the returned data according to the configuration file rules. In the current mock schemes, the front-end people are required to make their own mock rules, and the existing rules need to be revised when the interface changes. Here, we reduce the manual mock rule making by automatically saving the returned data by proxy mode, and only focus on the current interface to be processed when mock mode is enabled.</li>
</ul>
<p>For the other requirements, where there are differences in the project business, the configuration parameters are written in the configuration file to achieve.</p>
<h3 id="zerominimal-configuration-to-enable-mock-mode">Zero/minimal configuration to enable mock mode</h3>
<p>Currently, various popular mock solutions require front-end staff to make their own mock rules due to their feature-richness, and the initial cost of introducing them in existing projects is relatively high, and there is also a certain learning cost.</p>
<p><code>simple-mock</code> saves the returned data according to the configuration file rules by exporting the <code>simpleMock.saveApi</code> method to the user when the server-side API proxy data is returned.
By automatically saving the returned data from the backend through the proxy mode, manual mock rule making is reduced, which makes the introduction cost relatively low. You only need to write some public correction rules (if there is no special interface logic or even this step can be omitted), you can quickly realize the complete MCOK development of the whole site.</p>
<p>In the MOCK development process, you only need to focus on the business-related data interfaces currently being processed, and write targeted Javascript logic to achieve custom data MOCK.</p>
<h3 id="real-time-loading-of-configuration-files-custom-mock-files">Real-time loading of configuration files, custom mock files</h3>
<p>The configuration file and the mock file both come in as the nodejs module <code>require</code>, because the <code>require</code> mechanism has a cache, which causes the file to be modified only after a restart to take effect, while <code>simple-mock</code>, which only provides an API as a plugin, obviously does not have the ability to restart the server.</p>
<p>In local development mode, the memory consumption requirement is not too high, so <code>simple-mock</code> implements a simple caching mechanism internally, and removes the cache using the <code>delete require.cache[filename]</code> method when the relevant file is found to be modified (note that this approach may lead to memory leaks unless there is a good object release control logic, not recommended in production environments), thus achieving the effect of <code>require</code> taking effect immediately after the file is modified again.</p>
<h3 id="define-public-rules-and-design-different-priorities">Define public rules and design different priorities</h3>
<p><code>simple-mock</code> sets up three directories for defining mock rule files, in descending order of priority: <code>customdata &gt; mockdata &gt; customdata/autosave</code>.</p>
<ul>
<li>The <code>customdata</code> directory is used for custom API rules and is not committed to the GIT repository. This directory has the highest priority</li>
<li><code>mockdata</code> directory is used for common public API rules, which are committed to the GIT repository</li>
<li><code>customdata/autosave</code> directory is used to automatically save the returned data from the backend, and is also a guaranteed mock rule</li>
</ul>
<h3 id="mock-for-some-interfaces">mock for some interfaces</h3>
<p>When the mock function is turned off (setting <code>config.isEnableMock=false</code>), the <code>config.enableMockFilter</code> parameter method can be used to define rules that can still be turned on. This is useful for scenarios where MOCK debugging is only done for a single interface with different parameter values. Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">enableMockFilter</span><span class="o">:</span> <span class="p">(</span><span class="nx">apiPath</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// 示例：按URL 路径匹配，开启部分接口的 mock
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">filterKeyList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/rest/test&#39;</span><span class="p">,</span> <span class="s1">&#39;/rest/abc&#39;</span><span class="p">];</span>
        <span class="kr">const</span> <span class="nx">isMock</span> <span class="o">=</span> <span class="nx">filterKeyList</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">path</span> <span class="p">=&gt;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">apiPath</span><span class="p">).</span><span class="nx">includes</span><span class="p">(</span><span class="nx">path</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">isMock</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When mock is enabled (set <code>config.isEnableMock=true</code>), the <code>config.disableMockFilter</code> parameter method can be used to define rules that still do not use mock. This is useful for scenarios where you need to debug or compare some of the online interfaces in a mock development situation. Example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">disableMockFilter</span><span class="o">:</span> <span class="p">(</span><span class="nx">apiPath</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// 示例：按URL关键字过滤，登陆相关API不mock
</span><span class="c1"></span>        <span class="kr">const</span> <span class="nx">filterKeyList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/rest/auth&#39;</span><span class="p">,</span> <span class="s1">&#39;/rest/logout&#39;</span><span class="p">];</span><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://lzw.me/wp-content/uploads/2020/07/websocket-mock-server-140x100.png&#34;</span> <span class="nx">alt</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&#34;140&#34;</span> <span class="nx">height</span><span class="o">=</span><span class="s2">&#34;100&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;aligncenter size-thumbnail wp-image-2542&#34;</span> <span class="o">/&gt;</span>
 
<span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&#34;https://lzw.me/wp-content/uploads/2020/07/websocket-mock-msg-send-2-140x100.png&#34;</span> <span class="nx">alt</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&#34;140&#34;</span> <span class="nx">height</span><span class="o">=</span><span class="s2">&#34;100&#34;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&#34;aligncenter size-thumbnail wp-image-2541&#34;</span> <span class="o">/&gt;</span>
        <span class="kr">const</span> <span class="nx">isMock</span> <span class="o">=</span> <span class="nx">filterKeyList</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">path</span> <span class="p">=&gt;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">apiPath</span><span class="p">).</span><span class="nx">includes</span><span class="p">(</span><span class="nx">path</span><span class="p">));</span>
        <span class="k">return</span> <span class="nx">isMock</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Of course, when the mock switch is turned on, there are various ways to terminate the mock process. For example, matching the relevant rule in the <code>config.customSaveFileName</code> parameter method and returning filename as null, matching the relevant request in the <code>config.handlerBeforeMockSend</code> parameter method and returning <code>__ignore_mock__</code>, exporting the value to <code>__ignore_mock__</code> in the custom file corresponding to the request, etc. in the custom file corresponding to the request, and exporting the value to <code>__ignore_mock__</code>.</p>
<p>The above briefly describes the main purpose and design idea of <code>simple-mock</code>. For http one-answer requests, <code>simple-mock</code> is a good solution for lightweight mock development patterns.</p>
<h2 id="ideas-and-solutions-for-implementing-websocket-service-mock-using-simple-mock">Ideas and solutions for implementing websocket service mock using simple-mock</h2>
<p>For websocket subscription and push mode, we can also reuse the mock idea of <code>simple-mock</code> in http-oriented one-answer mock, but the difference lies in how to save the data of different subscription requests, how to simulate multiple data sending after one subscription, etc.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/23/4697eba369654910be82345ef3306d5b.png" alt=""></p>
<h3 id="simple-mock-basic-strategy-for-handling-websocket-message-mock">Simple-mock Basic strategy for handling websocket message mock</h3>
<p>Generally speaking, except for the data pushed by the server broadcast mode, for sending requests need to wait for the return of data in common mode, because of the need to distinguish between different data responses, websocket client data sent to the server data returned between the basic need to correlate according to certain field values, based on this correlation rules, you can configure parameters to achieve mock Based on such association rules, mock logic can be implemented by configuring parameters such as file name customization, data generalization, etc., which basically remains unchanged in the specific mock framework. The main points of <code>simple-mock</code> for this logic are.</p>
<ul>
<li>Implementing websocket service mock logic in a one-question, one-answer, and one-question-multiple-answer mode with <code>simple-mock</code>.
<ul>
<li>Define the mock file name rules for client data request and server data return by <code>config.customSaveFileName(req, res, filename, type)</code> parameter method, thus realizing the correspondence between response and answer.</li>
<li>The <code>config.handlerBeforeMockSend(content, reqParams)</code> parameter method adjusts generic information, such as real-time timestamp, uuid replacement corresponding to the request, etc.</li>
</ul>
</li>
<li>For login process, message preload, etc., define public rules to be placed in the <code>mock/mockdata</code> directory (which will be committed to the git repository)</li>
<li>For broadcast push-style messages, define public rules, define timers, etc. It is recommended to manually mock messages and send them by opening a local websocket mock server page after starting a connection</li>
</ul>
<h3 id="one-question-one-answer-one-question-multiple-answer-mode">One question, one answer, one question, multiple answer mode</h3>
<p>One-Question, One-Answer, One-Question, Many In specific business processes, the one-question, one-answer, one-question, many-answer pattern is still more and more predominant, for example, sending a message, the server correspondingly returns one or more messages.</p>
<p>The sent and returned messages need to be matched, which generally sets a uuid unique identifier field in each answer for matching. The <code>config.handlerBeforeMockSend</code> parameter can be used to handle this public logical relationship, and the <code>config.customSaveFileName</code> parameter is used to handle the correspondence between the request and the local file.</p>
<p>The one-response mode is naturally simpler, with the <code>autosave</code> directory landing data satisfying the basic requirements. The one-response-multiple-answer mode requires specific rules to be implemented in the form of written functions. The following is a custom example of the one-response-multiple-answer model: Answer mode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="cm">/**
</span><span class="cm"> * 自定义 MOCK 逻辑示例：查询并要求返回多条信息
</span><span class="cm"> */</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">module</span><span class="nx">.exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">jparams</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">jparams</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">reqmsgid</span> <span class="o">=</span> <span class="nx">jparams</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">reqmsgid</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">totalCounts</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">totalCounts</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">funcid</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">funcid</span><span class="p">;</span>
  <span class="c1">// reqmsgid 是本次请求的 uuid 唯一标识，用于应答匹配
</span><span class="c1"></span>  <span class="c1">// 这种公共约定也可以在 config.handlerBeforeMockSend 参数中进行实现
</span><span class="c1"></span>  <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">reqmsgid</span> <span class="o">=</span> <span class="nx">reqmsgid</span><span class="p">;</span>
 
  <span class="c1">// 将多条保存至本地的数据
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">totalCounts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">totalCounts</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="sb">`../customdata/autosave/</span><span class="si">${</span><span class="nx">funcid</span><span class="si">}</span><span class="sb">_currSno</span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">.js`</span><span class="p">);</span>
 
        <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">reqmsgid</span> <span class="o">=</span> <span class="nx">reqmsgid</span><span class="p">;</span>
            <span class="c1">// 也可以调用 config.handlerBeforeMockSend 进行一下通用处理再发送
</span><span class="c1"></span>            <span class="c1">// const CONFIG = require(&#39;../../simple-mock-config&#39;);
</span><span class="c1"></span>            <span class="c1">// data = CONFIG.handlerBeforeMockSend(data, req, client);
</span><span class="c1"></span> 
            <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                <span class="c1">// client.send(data);
</span><span class="c1"></span>            <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="p">}</span>
 
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">jparams</span> <span class="o">&amp;&amp;</span> <span class="nx">jparams</span><span class="p">.</span><span class="nx">market</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">jparams</span><span class="p">.</span><span class="nx">market</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">===</span> <span class="s1">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">jparams</span><span class="p">.</span><span class="nx">filterstktypes</span><span class="p">)</span> <span class="nx">s</span> <span class="o">+=</span> <span class="s1">&#39;_filterstktypes&#39;</span><span class="p">;</span>
      <span class="kr">const</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="sb">`../customdata/autosave/10001_</span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">.js`</span><span class="p">);</span>
 
      <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
          <span class="c1">// console.log(&#39;data&#39;, data);
</span><span class="c1"></span>          <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="nx">client</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
              <span class="c1">// client.send(data);
</span><span class="c1"></span>          <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 返回 false 则忽略自动应答，在内部自行处理
</span><span class="c1"></span>  <span class="c1">// return result;
</span><span class="c1"></span>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">// 示例基础数据
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">msg</span><span class="o">:</span> <span class="s1">&#39;信息查询成功!&#39;</span><span class="p">,</span>
    <span class="nx">errno</span>: <span class="kt">0</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">currSno</span>: <span class="kt">0</span><span class="p">,</span>
    <span class="nx">totalCounts</span>: <span class="kt">10</span><span class="p">,</span>
    <span class="nx">funcid</span>: <span class="kt">10001</span><span class="p">,</span>
    <span class="nx">reqmsgid</span><span class="o">:</span> <span class="s1">&#39;2da60eda555000000000000000000000&#39;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">topic</span><span class="o">:</span> <span class="s1">&#39;ask&#39;</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>This example shows a scenario where a single request requires multiple messages to be returned. The <code>client</code> is the second parameter passed to the <code>simpleMock.renderWs</code> method, which can be passed directly to the ws client handle, or you can implement its related interface to achieve more customization capabilities.</p>
<h3 id="login-process-information-pre-loading">Login process, information pre-loading</h3>
<p>During the initial login process, you may need to load a lot of information. The logic for receiving this information can be fixed as public rules, which are written in the <code>mock/mockdata</code> directory and then committed to the Git repository to be shared with all developers.</p>
<p>In addition, you may need to write public rules for some public messages to be loaded in order for the application to work properly.</p>
<h3 id="mock-push-messaging">Mock Push Messaging</h3>
<p>For unsolicited, pure push messages, a simple way is to enable a timer (setInterval/setTimeout) at startup to send messages to the client at regular intervals (pay attention to the management of the timer to avoid memory leaks). For example, read the contents of a json file in a specified directory at regular intervals and send it as a message. Only need to delete the file or modify the content of the file to meet the simple needs.</p>
<p>In the development process, the main purpose of Mock for push messages is for functional debugging, so it is more convenient to open a web client to send mock numbers manually. The following example is shown.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/23/80258ba8d2fd44799f2b0421e6ca4858.png" alt=""></p>
<p>Instant pushing of arbitrary messages via the web client can easily meet the development and debugging needs of various data scenarios. An example implementation of this pattern is given in <a href="https://github.com/lzwme/simple-mock/blob/master/ws-proxy-server/mock-client.ts">ws-proxy-server/mock-client.ts</a> of the <code>simple-mock</code> repository. An example implementation of this pattern is given in <a href="">ws-proxy-server/mock-client.ts</a>.</p>
<p>This implements the basic mock logic for the websocket service. A concrete example is available in the <code>simple-mock</code> source repository <a href="https://github.com/lzwme/simple-mock/tree/master/ws-proxy-server">ws-proxy-server</a>.</p>
<h3 id="other">Other</h3>
<ul>
<li>If you are not concerned about logging information, you can turn on the log printing switch parameter <code>slient</code> in the configuration file for <code>simple-mock</code> and <code>ws-proxy-server</code>. Because a lot of log printing may cause the cmd to stall or the process may get stuck and require a manual enter to continue.</li>
<li>more&hellip;</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/websocket/">websocket</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/gin-get-client-real-ip/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to get the client&#39;s real IP, starting with a &#34;bug&#34; in Gin</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/git-rebase-and-merge/">
            <span class="next-text nav-default">Reasonable use of git rebase instead of git merge</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
