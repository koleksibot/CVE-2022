<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Automating yum/apt offline source builds with GitHub Actions - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Offline Deployment For PaaS toB products, customers often require that the deployment solution must be installed offline, i.e., it cannot rely on any online resources during deployment, such as yum/apt sources for installing some OS packages; container images on docker.io, k8s.gcr.io, quay.io; binary downloads of open source software on GitHub, etc. download files, etc. As a developer of platform deployment tools, I am always plagued by the challenge of offline" /><meta name="keywords" content="Github Action, yum/apt" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/make-offline-mirrors/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Automating yum/apt offline source builds with GitHub Actions" />
<meta property="og:description" content="Offline Deployment For PaaS toB products, customers often require that the deployment solution must be installed offline, i.e., it cannot rely on any online resources during deployment, such as yum/apt sources for installing some OS packages; container images on docker.io, k8s.gcr.io, quay.io; binary downloads of open source software on GitHub, etc. download files, etc. As a developer of platform deployment tools, I am always plagued by the challenge of offline" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/make-offline-mirrors/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-11T15:51:49+08:00" />
<meta property="article:modified_time" content="2021-09-11T15:51:49+08:00" />

<meta itemprop="name" content="Automating yum/apt offline source builds with GitHub Actions">
<meta itemprop="description" content="Offline Deployment For PaaS toB products, customers often require that the deployment solution must be installed offline, i.e., it cannot rely on any online resources during deployment, such as yum/apt sources for installing some OS packages; container images on docker.io, k8s.gcr.io, quay.io; binary downloads of open source software on GitHub, etc. download files, etc. As a developer of platform deployment tools, I am always plagued by the challenge of offline"><meta itemprop="datePublished" content="2021-09-11T15:51:49+08:00" />
<meta itemprop="dateModified" content="2021-09-11T15:51:49+08:00" />
<meta itemprop="wordCount" content="4636">
<meta itemprop="keywords" content="github," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automating yum/apt offline source builds with GitHub Actions"/>
<meta name="twitter:description" content="Offline Deployment For PaaS toB products, customers often require that the deployment solution must be installed offline, i.e., it cannot rely on any online resources during deployment, such as yum/apt sources for installing some OS packages; container images on docker.io, k8s.gcr.io, quay.io; binary downloads of open source software on GitHub, etc. download files, etc. As a developer of platform deployment tools, I am always plagued by the challenge of offline"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Automating yum/apt offline source builds with GitHub Actions</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-11 15:51:49 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 4636 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#offline-deployment">Offline Deployment</a></li>
        <li><a href="#docker-build">Docker build</a></li>
        <li><a href="#os-adaptation">OS Adaptation</a></li>
        <li><a href="#build">Build</a>
          <ul>
            <li><a href="#build-process">Build process</a></li>
            <li><a href="#packagesyaml">packages.yaml</a></li>
            <li><a href="#centos7">CentOS7</a></li>
            <li><a href="#debian9">Debian9</a></li>
            <li><a href="#ubuntu">Ubuntu</a></li>
            <li><a href="#all-in-oone">All-in-Oone</a></li>
          </ul>
        </li>
        <li><a href="#use">Use</a></li>
        <li><a href="#github-action-automated-builds">GitHub Action Automated Builds</a>
          <ul>
            <li><a href="#code-structure">Code Structure</a></li>
            <li><a href="#workflow">Workflow</a></li>
          </ul>
        </li>
        <li><a href="#optimization">Optimization</a>
          <ul>
            <li><a href="#dockerfile">Dockerfile</a></li>
            <li><a href="#package-version">Package version</a></li>
          </ul>
        </li>
        <li><a href="#tips">Tips</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="offline-deployment">Offline Deployment</h2>
<p>For PaaS toB products, customers often require that the deployment solution must be installed offline, i.e., it cannot rely on any online resources during deployment, such as yum/apt sources for installing some OS packages; container images on docker.io, k8s.gcr.io, quay.io; binary downloads of open source software on GitHub, etc. download files, etc.</p>
<p>As a developer of platform deployment tools, I am always plagued by the challenge of offline deployment. Online container images and binaries are better to solve, because these resources are OS-independent, just download them into the installation package, and start an HTTP server and mirror repository service to provide the download of these resources when deploying.</p>
<p>But for yum/apt and the like, it&rsquo;s not so simple.</p>
<ul>
<li>Firstly, it is not possible to download the packages directly because of their complex dependencies.</li>
<li>Secondly, even after downloading, it is not possible to install the specified packages directly via yum/apt, although it is possible to copy the packages to the deployment node using scp and install them via rpm or dpkg, but this is not very elegant and the general performance is not very good.</li>
<li>Finally, there are various Linux distributions and package managers that need to be adapted, and some package names or version numbers vary greatly from one package manager to another, making it impossible to manage them uniformly.</li>
<li>It is difficult to adapt both arm64 and amd64 sources.</li>
</ul>
<p>In summary, making offline installers from online yum/apt-type package resources that the platform deployment depends on is a tricky task. I&rsquo;ve been tossing around this problem for a while and finally found a suitable solution: manage the packages with a YAML configuration file and then use Dockerfile to build them as offline tarballs or container images. If you have similar needs, you can take a look at this solution.</p>
<h2 id="docker-build">Docker build</h2>
<p>The traditional way to make offline sources is to find an appropriate Linux machine, download the packages via the package manager on it, and then create repo index files for those packages.</p>
<p>As you can see this is a very inflexible approach, if I want to create apt offline sources for Debian 9, I need a Debian 9 machine. If I want to adapt multiple Linux distributions, I need multiple OS machines. It&rsquo;s not easy to manage and use so many different OSes, and container technology, which is now very common, can help us solve this problem. For example, if I want to run a Debian 9 OS, I can just run a container of the Debian 9 image without any additional management costs and with a very light weight.</p>
<p>We often use containers to build backend components written in Golang in our daily work, so can we do the same for building offline sources? We just need to write a Dockerfile for different OS and package managers. Using the docker build multi-stage build feature, you can merge multiple Dockerfiles into one, and then finally copy that build to the same image using COPY -from, such as the nginx container that provides HTTP, or use the BuildKit feature to export as a tarball or as a local directory.</p>
<h2 id="os-adaptation">OS Adaptation</h2>
<p>Based on my experience in PaaS toB, CentOS is the most popular OS used in the production environment of domestic private cloud customers, followed by Ubuntu and Debian, while RedHat requires a paid subscription, and there are no free images available on DockerHub, so this solution is not guaranteed to work with RedHat. For CentOS, only version 7.9 is required; for Ubuntu, 18.04 and 20.04 are required; for Debian, 9 and 10 are required. 20.04. If you want to support other OS offline sources such as OpenSUSE, you can also refer to this solution to write a Dockerfile file to achieve the adaptation.</p>
<h2 id="build">Build</h2>
<p>The build process is very simple, using a YAML-formatted configuration file to manage the installation of different packages by different package managers or Linux distributions, and doing all the build operations in a single Dockerfile. The source implementation is available at <a href="github.com/muzi502/scripts/build-packages-repo.">github.com/muzi502/scripts/build-packages-repo</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">build
├── Dockerfile
├── Dockerfile.centos
├── Dockerfile.debian
├── Dockerfile.ubuntu
└── packages.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="build-process">Build process</h3>
<p>Building an offline source using docker build can be roughly divided into the following steps.</p>
<ul>
<li>Configuring the yum/apt source inside the build container and installing the tools needed for the build.</li>
<li>Generate a list of rpm/deb packages on the system and a list of packages that need to be downloaded to solve some package dependency problems.</li>
<li>downloading the required packages based on the generated package list using the appropriate package manager tool.</li>
<li>Generate index files for these packages using the appropriate package manager, such as repodata or Packages.gz files.</li>
<li>COPY the above build products into the same container image, such as nginx; you can also export them as tarballs or directories.</li>
</ul>
<h3 id="packagesyaml">packages.yaml</h3>
<p>This file is used to manage the packages that need to be installed by different package managers or Linux distributions. We can divide these packages into 4 categories according to different package managers and distributions.</p>
<ul>
<li>common: for packages that have the same name in all package managers or do not require a version, such as vim, curl, wget and other tools. In general, we don&rsquo;t care about the version of these tools, and the package names of these packages are the same in all package managers, so they can be classified as common packages.</li>
<li>yum/apt/dnf: This applies to different distributions using the same package manager. For example, if the package for nfs is named nfs-utils in yum but nfs-common in apt, this type of package can be classified as a class.</li>
<li>OS: for some packages that are unique to that OS, such as installing a package that is available in Ubuntu but not in Debian (e.g. debian-builder or ubuntu-dev-tools).</li>
<li>OS-distribution codename: The version of such packages is tied to the distribution codename, e.g. `docker-ce=5:19.03.15~3-0~debian-stretch.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">common</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">vim</span><span class="w">
</span><span class="w">  </span>- <span class="l">curl</span><span class="w">
</span><span class="w">  </span>- <span class="l">wget</span><span class="w">
</span><span class="w">  </span>- <span class="l">tree</span><span class="w">
</span><span class="w">  </span>- <span class="l">lvm2</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">nfs-utils</span><span class="w">
</span><span class="w">  </span>- <span class="l">yum-utils</span><span class="w">
</span><span class="w">  </span>- <span class="l">createrepo</span><span class="w">
</span><span class="w">  </span>- <span class="l">centos-release-gluster</span><span class="w">
</span><span class="w">  </span>- <span class="l">epel-release</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">nfs-common</span><span class="w">
</span><span class="w">  </span>- <span class="l">apt-transport-https</span><span class="w">
</span><span class="w">  </span>- <span class="l">ca-certificates</span><span class="w">
</span><span class="w">  </span>- <span class="l">lsb-release</span><span class="w">
</span><span class="w">  </span>- <span class="l">software-properties-common</span><span class="w">
</span><span class="w">  </span>- <span class="l">aptitude</span><span class="w">
</span><span class="w">  </span>- <span class="l">dpkg-dev</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">centos</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">centos-release</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">debian</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">debian-builder</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">debian-buster</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">docker-ce=5:19.03.15~3-0~debian-buster</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">ubuntu</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">ubuntu-dev-tools</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>For example, if you want to install the 19.03.15 version of docker-ce in yum, the package name is <code>docker-ce-19.03.15</code>, while in debian the package name is <code>docker-ce=5:19.03.15~3-0 ~debian-stretch</code> . You can use a package manager to see the differences between the same one package such as docker-ce before different package managers, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@centos:<span class="o">]</span><span class="c1"># yum list docker-ce --showduplicates | grep 19.03.15</span>
docker-ce.x86_64            3:19.03.15-3.el7                    docker-ce-stable

root@debian:/# apt-cache policy docker-ce
docker-ce:
  Installed: <span class="o">(</span>none<span class="o">)</span>
  Candidate: 5:19.03.15~3-0~debian-stretch
  Version table:
     5:19.03.15~3-0~debian-stretch <span class="m">500</span>
        <span class="m">500</span> https://download.docker.com/linux/debian stretch/stable amd64 Packages
</code></pre></td></tr></table>
</div>
</div><p>This version number issue is also specially handled in kubespray&rsquo;s source code, and there is really no good solution to solve it, so we have to maintain this version number manually.</p>
<ul>
<li>
<p>roles/container-engine/docker/vars/redhat.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># https://docs.docker.com/engine/installation/linux/centos/#install-from-a-package</span><span class="w">
</span><span class="w"></span><span class="c"># https://download.docker.com/linux/centos/&lt;centos_version&gt;&gt;/x86_64/stable/Packages/</span><span class="w">
</span><span class="w"></span><span class="c"># or do &#39;yum --showduplicates list docker-engine&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">docker_versioned_pkg</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;latest&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;18.09&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-18.09.9-3.el7</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;19.03&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-19.03.15-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;20.10&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-20.10.5-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;stable&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-19.03.15-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;edge&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-19.03.15-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">docker_cli_versioned_pkg</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;latest&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;18.09&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli-18.09.9-3.el7</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;19.03&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli-19.03.15-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;20.10&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli-20.10.5-3.el{{ ansible_distribution_major_version }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">docker_package_info</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">enablerepo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;docker-ce&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">pkgs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ containerd_versioned_pkg[containerd_version | string] }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ docker_cli_versioned_pkg[docker_cli_version | string] }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ docker_versioned_pkg[docker_version | string] }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>roles/container-engine/docker/vars/ubuntu.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># https://download.docker.com/linux/ubuntu/</span><span class="w">
</span><span class="w"></span><span class="nt">docker_versioned_pkg</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;latest&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;18.09&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce=5:18.09.9~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;19.03&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce=5:19.03.15~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;20.10&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce=5:20.10.5~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;stable&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce=5:19.03.15~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;edge&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce=5:19.03.15~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">docker_cli_versioned_pkg</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;latest&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;18.09&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli=5:18.09.9~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;19.03&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli=5:19.03.15~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w"></span><span class="nt">&#39;20.10&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">docker-ce-cli=5:20.10.5~3-0~ubuntu-{{ ansible_distribution_release|lower }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">docker_package_info</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">pkgs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ containerd_versioned_pkg[containerd_version | string] }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ docker_cli_versioned_pkg[docker_cli_version | string] }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ docker_versioned_pkg[docker_version | string] }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="centos7">CentOS7</h3>
<p>After introducing the package configuration file above, we will then use Dockerfile to build the offline source of these packages based on this packages.yml configuration file. Here is the Dockerfile for building CentOS 7 offline sources.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># 使用 centos 7.9 作为 base 构建镜像</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> centos:7.9.2009 as builder</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 定义 centos 的版本和处理器体系架构</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span><span class="m">7</span>
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>x86_64

<span class="c"># 在这里定义一些构建时需要的软件包</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">BUILD_TOOLS</span><span class="o">=</span><span class="s2">&#34;yum-utils createrepo centos-release-gluster epel-release curl&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 安装构建工具和配置一些软件源 repo</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> yum install -q -y <span class="nv">$BUILD_TOOLS</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> yum makecache <span class="o">&amp;&amp;</span> yum update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 需要安装 yq 个工具来处理 packages.yaml 配置文件</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 解析 packages.yml 配置文件，生成所需要的 packages.list 文件</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /centos/$OS_VERSION/os/$ARCH</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 使用 yq 先将 YAML 文件转换成 json 格式的内容，再使用 jq 过滤出所需要的包，输出为一个列表</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> <span class="s1">&#39;.common[],.yum[],.centos[]&#39;</span> packages.yaml <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rpm -qa &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># 下载 packages.list 中的软件包，并生成 repo 索引文件</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> cat packages.list <span class="p">|</span> xargs yumdownloader --resolve <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> createrepo -d .<span class="err">
</span><span class="err"></span><span class="c"># 将构建产物复制到一层空的镜像中，方便导出为 tar 包或目录的格式</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>centos7 /centos /centos<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>In the last FROM image, <code>scratch</code> is specified here, which is a special image name that represents an empty image layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># 将构建产物复制到一层空的镜像中，方便导出为 tar 包或目录的格式</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>centos7 /centos /centos<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>You can also put the build directly into the nginx container, so that running the nginx container directly will serve the yum/apt sources</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> nginx:1.19</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>centos7 /centos /usr/share/nginx/html<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>To build as a tarball or local directory, you need to enable the <code>DOCKER_BUILDKIT=1</code> feature for Docker</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 构建为本地目录</span>
root@debian: ~ <span class="c1"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile.centos .</span>
<span class="c1"># 构建为 tar 包</span>
root@debian: ~ <span class="c1"># DOCKER_BUILDKIT=1 docker build -o type=tar,dest=$PWD/centos7.tar -f Dockerfile.centos .</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The build log is as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">
[+] Building 30.9s (13/13) FINISHED
=&gt; [internal] load .dockerignore                                                                                                                                            0.0s
=&gt; =&gt; transferring context: 109B                                                                                                                                            0.0s
=&gt; [internal] load build definition from Dockerfile.centos                                                                                                                  0.0s
=&gt; =&gt; transferring dockerfile: 979B                                                                                                                                         0.0s
=&gt; [internal] load metadata for docker.io/library/centos:7.9.2009                                                                                                           2.6s
=&gt; [centos7 1/7] FROM docker.io/library/centos:7.9.2009@sha256:0f4ec88e21daf75124b8a9e5ca03c37a5e937e0e108a255d890492430789b60e                                             0.0s
=&gt; [internal] load build context                                                                                                                                            0.0s
=&gt; =&gt; transferring context: 818B                                                                                                                                            0.0s
=&gt; CACHED [centos7 2/7] RUN yum install -q -y yum-utils createrepo centos-release-gluster epel-release curl     &amp;&amp; yum-config-manager --add-repo https://download.docker.c  0.0s
=&gt; [centos7 3/7] WORKDIR /centos/7/os/x86_64                                                                                                                                0.0s
=&gt; [centos7 4/7] RUN curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64     &amp;&amp; chmod a+x /usr/local/bin/yq     &amp;&amp; curl   3.2s
=&gt; [centos7 5/7] COPY packages.yaml packages.yaml                                                                                                                           0.1s
=&gt; [centos7 6/7] RUN yq eval packages.yaml -j | jq -r &#39;.common[],.yum[],.centos[]&#39; | sort -u &gt; packages.list     &amp;&amp; rpm -qa &gt;&gt; packages.list                                1.0s
=&gt; [centos7 7/7] RUN cat packages.list | xargs yumdownloader --resolve     &amp;&amp; createrepo -d .                                                                              21.6s
=&gt; [stage-1 1/1] COPY --from=centos7 /centos /centos                                                                                                                        0.5s
=&gt; exporting to client                                                                                                                                                      0.7s
=&gt; =&gt; copying files 301.37MB
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The construction products are as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">root@debian:/build # tree centos
centos
└── 7
    └── os
        └── x86_64
            ├── acl-2.2.51-15.el7.x86_64.rpm
            ├── ansible-2.9.21-1.el7.noarch.rpm
            ├── at-3.1.13-24.el7.x86_64.rpm
            ├── attr-2.4.46-13.el7.x86_64.rpm
            ├── audit-libs-2.8.5-4.el7.x86_64.rpm
            ├── audit-libs-python-2.8.5-4.el7.x86_64.rpm
            ├── avahi-libs-0.6.31-20.el7.x86_64.rpm
            ├── basesystem-10.0-7.el7.centos.noarch.rpm
            ├── bash-4.2.46-34.el7.x86_64.rpm
            ……………………………………
            ├── redhat-lsb-submod-security-4.1-27.el7.centos.1.x86_64.rpm
            ├── repodata
            │   ├── 28d2fe2d1dbd9b76d3e5385d42cf628ac9fc34d69e151edfe8d134fe6ac6a6d9-primary.xml.gz
            │   ├── 5264ca1af13ec7c870f25b2a28edb3c2843556ca201d07ac681eb4af7a28b47c-primary.sqlite.bz2
            │   ├── 591d9c2d5be714356e8db39f006d07073f0e1e024a4a811d5960d8e200a874fb-other.xml.gz
            │   ├── c035d2112d55d23a72b6d006b9e86a2f67db78c0de45345e415884aa0782f40c-other.sqlite.bz2
            │   ├── cd756169c3718d77201d08590c0613ebed80053f84a2db7acc719b5b9bca866f-filelists.xml.gz
            │   ├── ed0c5a36b12cf1d4100f90b4825b93dac832e6e21f83b23ae9d9753842801cee-filelists.sqlite.bz2
            │   └── repomd.xml
            ├── yum-utils-1.1.31-54.el7_8.noarch.rpm
            └── zlib-1.2.7-19.el7_9.x86_64.rpm

4 directories, 368 files
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="debian9">Debian9</h3>
<p>The following is a Debian9 build Dockerfile, the process is similar to CentOS, only the package manager is used in a different way, so I won&rsquo;t do a detailed source code introduction here.</p>
<ul>
<li>
<p>Dockerfile.debian</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> debian:stretch-slim as stretch</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span>stretch
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>amd64

<span class="k">ARG</span> <span class="nv">DEP_PACKAGES</span><span class="o">=</span><span class="s2">&#34;apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev&#34;</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update -y -q <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="nv">$DEP_PACKAGES</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian </span><span class="si">${</span><span class="nv">OS_VERSION</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> tee /etc/apt/sources.list.d/docker.list &gt; /dev/null <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /debian/${OS_VERSION}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> <span class="s1">&#39;.common[],.apt[],.debian[]&#39;</span> packages.yaml <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> dpkg --get-selections <span class="p">|</span> grep -v deinstall <span class="p">|</span> cut -f1 &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R _apt /debian/<span class="nv">$OS_VERSION</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cat packages.list <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> apt-cache depends --recurse --no-recommends --no-suggests <span class="se">\
</span><span class="se"></span>    --no-conflicts --no-breaks --no-replaces --no-enhances <span class="o">{}</span>  <span class="p">|</span> grep <span class="s1">&#39;^\w&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> xargs apt-get download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> dpkg-scanpackages <span class="nv">$OS_VERSION</span> <span class="p">|</span> gzip -9c &gt; <span class="nv">$OS_VERSION</span>/Packages.gz<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /debian /debian<span class="err">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="ubuntu">Ubuntu</h3>
<p>The steps to create an Ubuntu offline source are not too different from Debian, just a simple modification of Debian&rsquo;s Dockerfile should be OK, like <code>'s/debian/ubuntu/g'</code>, after all Debian is Ubuntu&rsquo;s father ~~, so apt uses almost the same way and package names, so I won&rsquo;t go into it here.</p>
<h3 id="all-in-oone">All-in-Oone</h3>
<p>By combining the Dockerfile of the above Linux distributions into one, you can build the offline sources for all the OS you need with just one docker build command.</p>
<ul>
<li>Dockerfile</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># CentOS 7.9 2009</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> centos:7.9.2009 as centos7</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span><span class="m">7</span>
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>x86_64
<span class="k">ARG</span> <span class="nv">BUILD_TOOLS</span><span class="o">=</span><span class="s2">&#34;yum-utils createrepo centos-release-gluster epel-release curl&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> yum install -q -y <span class="nv">$BUILD_TOOLS</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> yum makecache <span class="o">&amp;&amp;</span> yum update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/jq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /centos/$OS_VERSION/os/$ARCH</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> packages.yaml -j <span class="p">|</span> jq -r <span class="s1">&#39;.common[],.yum[],.centos[]&#39;</span> <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rpm -qa &gt;&gt; packages.list<span class="err">
</span><span class="err"></span><span class="k">RUN</span> cat packages.list <span class="p">|</span> xargs yumdownloader --resolve <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> createrepo -d .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Debian 9 stretch</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> debian:stretch-slim as stretch</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span>stretch
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>amd64

<span class="k">ARG</span> <span class="nv">DEP_PACKAGES</span><span class="o">=</span><span class="s2">&#34;apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev&#34;</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update -y -q <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="nv">$DEP_PACKAGES</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian </span><span class="si">${</span><span class="nv">OS_VERSION</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> tee /etc/apt/sources.list.d/docker.list &gt; /dev/null <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/jq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /debian/${OS_VERSION}</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> packages.yaml -j <span class="p">|</span> jq -r <span class="s1">&#39;.common[],.apt[],.debian[]&#39;</span> <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> dpkg --get-selections <span class="p">|</span> grep -v deinstall <span class="p">|</span> cut -f1 &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R _apt /debian/<span class="nv">$OS_VERSION</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cat packages.list <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> apt-cache depends --recurse --no-recommends --no-suggests <span class="se">\
</span><span class="se"></span>    --no-conflicts --no-breaks --no-replaces --no-enhances <span class="o">{}</span>  <span class="p">|</span> grep <span class="s1">&#39;^\w&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> xargs apt-get download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> dpkg-scanpackages <span class="nv">$OS_VERSION</span> <span class="p">|</span> gzip -9c &gt; <span class="nv">$OS_VERSION</span>/Packages.gz<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Debian 10 buster</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> debian:buster-slim as buster</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span>buster
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>amd64

<span class="k">ARG</span> <span class="nv">DEP_PACKAGES</span><span class="o">=</span><span class="s2">&#34;apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev&#34;</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update -y -q <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="nv">$DEP_PACKAGES</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian </span><span class="si">${</span><span class="nv">OS_VERSION</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> tee /etc/apt/sources.list.d/docker.list &gt; /dev/null <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/jq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /debian/${OS_VERSION}</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> packages.yaml -j <span class="p">|</span> jq -r <span class="s1">&#39;.common[],.apt[],.debian[]&#39;</span> <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> dpkg --get-selections <span class="p">|</span> grep -v deinstall <span class="p">|</span> cut -f1 &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R _apt /debian/<span class="nv">$OS_VERSION</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cat packages.list <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> apt-cache depends --recurse --no-recommends --no-suggests <span class="se">\
</span><span class="se"></span>    --no-conflicts --no-breaks --no-replaces --no-enhances <span class="o">{}</span>  <span class="p">|</span> grep <span class="s1">&#39;^\w&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> xargs apt-get download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> dpkg-scanpackages <span class="nv">$OS_VERSION</span> <span class="p">|</span> gzip -9c &gt; <span class="nv">$OS_VERSION</span>/Packages.gz<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Ubuntu 18.04 bionic</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:bionic as bionic</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span>bionic
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>amd64

<span class="k">ARG</span> <span class="nv">DEP_PACKAGES</span><span class="o">=</span><span class="s2">&#34;apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev&#34;</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update -y -q <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="nv">$DEP_PACKAGES</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span class="si">${</span><span class="nv">OS_VERSION</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> tee /etc/apt/sources.list.d/docker.list &gt; /dev/null <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/jq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /ubuntu/${OS_VERSION}</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> packages.yaml -j <span class="p">|</span> jq -r <span class="s1">&#39;.common[],.apt[],.ubuntu[]&#39;</span> <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> dpkg --get-selections <span class="p">|</span> grep -v deinstall <span class="p">|</span> cut -f1 &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R _apt /ubuntu/<span class="nv">$OS_VERSION</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cat packages.list <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> apt-cache depends --recurse --no-recommends --no-suggests <span class="se">\
</span><span class="se"></span>    --no-conflicts --no-breaks --no-replaces --no-enhances <span class="o">{}</span>  <span class="p">|</span> grep <span class="s1">&#39;^\w&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> xargs apt-get download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> dpkg-scanpackages <span class="nv">$OS_VERSION</span> <span class="p">|</span> gzip -9c &gt; <span class="nv">$OS_VERSION</span>/Packages.gz<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Ubuntu 20.04 focal</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:focal as focal</span><span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OS_VERSION</span><span class="o">=</span>focal
<span class="k">ARG</span> <span class="nv">ARCH</span><span class="o">=</span>amd64

<span class="k">ARG</span> <span class="nv">DEP_PACKAGES</span><span class="o">=</span><span class="s2">&#34;apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev&#34;</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update -y -q <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="nv">$DEP_PACKAGES</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span class="si">${</span><span class="nv">OS_VERSION</span><span class="si">}</span><span class="s2"> stable&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> tee /etc/apt/sources.list.d/docker.list &gt; /dev/null <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt update -y -q<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/yq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod a+x /usr/local/bin/jq<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /ubuntu/${OS_VERSION}</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> packages.yaml packages.yaml<span class="err">
</span><span class="err"></span><span class="k">RUN</span> yq <span class="nb">eval</span> packages.yaml -j <span class="p">|</span> jq -r <span class="s1">&#39;.common[],.apt[],.ubuntu[]&#39;</span> <span class="p">|</span> sort -u &gt; packages.list <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> dpkg --get-selections <span class="p">|</span> grep -v deinstall <span class="p">|</span> cut -f1 &gt;&gt; packages.list<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> chown -R _apt /ubuntu/<span class="nv">$OS_VERSION</span> <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> cat packages.list <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> apt-cache depends --recurse --no-recommends --no-suggests <span class="se">\
</span><span class="se"></span>    --no-conflicts --no-breaks --no-replaces --no-enhances <span class="o">{}</span>  <span class="p">|</span> grep <span class="s1">&#39;^\w&#39;</span> <span class="p">|</span> sort -u <span class="p">|</span> xargs apt-get download<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> <span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> dpkg-scanpackages <span class="nv">$OS_VERSION</span> <span class="p">|</span> gzip -9c &gt; <span class="nv">$OS_VERSION</span>/Packages.gz<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>centos7 /centos /centos<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>stretch /debian /debian<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>buster /debian /debian<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>bionic /ubuntu /ubuntu<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>focal /ubuntu /ubuntu<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="use">Use</h2>
<p>After building the offline sources, run an Nginx service on the deployed machine to provide HTTP downloads of these packages, and configure the machine&rsquo;s package manager repo configuration file.</p>
<ul>
<li>
<p>CentOS 7</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[Inra-Mirror]</span>
<span class="na">name</span><span class="o">=</span><span class="s">Infra Mirror Repository</span>
<span class="na">baseurl</span><span class="o">=</span><span class="s">http://172.20.0.10/centos/7/</span>
<span class="na">enabled</span><span class="o">=</span><span class="s">1</span>
<span class="na">gpgcheck</span><span class="o">=</span><span class="s">1</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Debian 9 stretch</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">deb <span class="o">[</span><span class="nv">trusted</span><span class="o">=</span>yes<span class="o">]</span> http://172.20.0.10:8080/debian stretch/
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Debian 10 buster</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">deb [trusted=yes] http://172.20.0.10:8080/debian buster/
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Ubuntu 18.04 bionic</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">deb <span class="o">[</span><span class="nv">trusted</span><span class="o">=</span>yes<span class="o">]</span> http://172.20.0.10:8080/ubuntu bionic/
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Ubuntu 20.04 focal</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">deb <span class="o">[</span><span class="nv">trusted</span><span class="o">=</span>yes<span class="o">]</span> http://172.20.0.10:8080/debian focal/
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="github-action-automated-builds">GitHub Action Automated Builds</h2>
<p>Once you have the above Dockerfile ready, it&rsquo;s time to think about the build. For a PaaS or IaaS product, you need to adapt it to mainstream Linux distributions, and sometimes to machines with arm64 architecture. If you build it locally with a manual docker build, it&rsquo;s not very efficient. So we need to use GitHub actions to automatically build the offline source of these rpm/deb packages, as described in <a href="https://github.com/k8sli/os-packages">k8sli/os-packages</a></p>
<h3 id="code-structure">Code Structure</h3>
<p>The build directory holds Dockerfiles for various distributions, and since different distributions and version building methods vary widely for each distribution, each distribution OS is built in a separate Dockerfile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">os-packages/
├── LICENSE
├── Makefile
├── README.md
├── build
│   ├── Dockerfile.os.centos7
│   ├── Dockerfile.os.centos8
│   ├── Dockerfile.os.debian10
│   ├── Dockerfile.os.debian9
│   ├── Dockerfile.os.fedora33
│   ├── Dockerfile.os.fedora34
│   ├── Dockerfile.os.ubuntu1804
│   └── Dockerfile.os.ubuntu2004
├── packages.yaml
└── repos
    ├── CentOS-All-in-One.repo
    ├── Debian-buster-All-in-One.list
    ├── Fedora-All-in-One.repo
    └── Ubuntu-focal-All-in-One.list
</code></pre></td></tr></table>
</div>
</div><h3 id="workflow">Workflow</h3>
<ul>
<li>
<p>Trigger method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build os-packages image</span><span class="w">
</span><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">push</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">tag</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;v*&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">branch</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main, release-*, master]</span><span class="w">
</span><span class="w"></span><span class="nt">workflow_dispatch</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Global Variables</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="c"># 镜像仓库域名</span><span class="w">
</span><span class="w"></span><span class="nt">IMAGE_REGISTRY</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ghcr.io&#34;</span><span class="w">
</span><span class="w"></span><span class="c"># 镜像仓库用户名</span><span class="w">
</span><span class="w"></span><span class="nt">REGISTRY_USER</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${{ github.repository_owner }}&#34;</span><span class="w">
</span><span class="w"></span><span class="c"># 镜像仓库登录凭据</span><span class="w">
</span><span class="w"></span><span class="nt">REGISTRY_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${{ secrets.GITHUB_TOKEN }}&#34;</span><span class="w">
</span><span class="w"></span><span class="c"># 镜像仓库推送 repo</span><span class="w">
</span><span class="w"></span><span class="nt">IMAGE_REPO</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ghcr.io/${{ github.repository_owner }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>To build the matrix, each of these jobs will run a runner to do a parallel build</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20.04</span><span class="w">
</span><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">fail-fast</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">matrix</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-bionic</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-ubuntu1804</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.ubuntu1804</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-focal</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-ubuntu2004</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.ubuntu2004</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">centos-7</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-centos7</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.centos7</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">centos-8</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-centos8</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.centos8</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">debian-buster</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-debian10</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.debian10</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">debian-stretch</span><span class="w">
</span><span class="w">            </span><span class="nt">image_name</span><span class="p">:</span><span class="w"> </span><span class="l">os-packages-debian9</span><span class="w">
</span><span class="w">            </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">build/Dockerfile.os.debian9</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>checkout the code and configure the buildx build environment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># fetch all git repo tag for define image tag</span><span class="w">
</span><span class="w">    </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up QEMU</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-qemu-action@v1</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up Docker Buildx</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-buildx-action@v1</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Log in to GitHub Docker Registry</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/login-action@v1</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.IMAGE_REGISTRY }}</span><span class="w">
</span><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.REGISTRY_USER }}</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.REGISTRY_TOKEN }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Generate a unique mirror tag by using <code>git describe --tags</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">- name: Prepare <span class="k">for</span> build images
shell: bash
run: <span class="p">|</span>
    git describe --tags --always <span class="p">|</span> sed <span class="s1">&#39;s/^/IMAGE_TAG=/&#39;</span> &gt;&gt; <span class="nv">$GITHUB_ENV</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Build the image and push it to the mirror repository, which will be used later when packaging an all-in-one package</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build and push os-package images</span><span class="w">
</span><span class="w"></span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/build-push-action@v2</span><span class="w">
</span><span class="w"></span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w">
</span><span class="w">    </span><span class="nt">push</span><span class="p">:</span><span class="w"> </span><span class="l">${{ github.event_name != &#39;pull_request&#39; }}</span><span class="w">
</span><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.dockerfile }}</span><span class="w">
</span><span class="w">    </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l">linux/amd64,linux/arm64</span><span class="w">
</span><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">${{ env.IMAGE_REPO }}/${{ matrix.image_name }}:${{ env.IMAGE_TAG }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Generate a new Dockerfile and export the image to the local directory</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Gen new Dockerfile</span><span class="w">
</span><span class="w"></span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span><span class="w"></span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">echo -e &#34;FROM scratch\nCOPY --from=${{ env.IMAGE_REPO }}/${{ matrix.image_name }}:${{ env.IMAGE_TAG }} / /&#34; &gt; Dockerfile</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build kubeplay image to local</span><span class="w">
</span><span class="w"></span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/build-push-action@v2</span><span class="w">
</span><span class="w"></span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w">
</span><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span><span class="w">    </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l">linux/amd64,linux/arm64</span><span class="w">
</span><span class="w">    </span><span class="nt">outputs</span><span class="p">:</span><span class="w"> </span><span class="l">type=local,dest=./</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Package and upload the final build to GitHub release</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Prepare for upload package</span><span class="w">
</span><span class="w"></span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span><span class="w"></span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    mv linux_amd64/resources resources
</span><span class="sd">    tar -I pigz -cf resources-${{ matrix.image_name }}-${IMAGE_TAG}-amd64.tar.gz resources --remove-files
</span><span class="sd">    mv linux_arm64/resources resources
</span><span class="sd">    tar -I pigz -cf resources-${{ matrix.image_name }}-${IMAGE_TAG}-arm64.tar.gz resources --remove-files
</span><span class="sd">    sha256sum resources-${{ matrix.image_name }}-${IMAGE_TAG}-{amd64,arm64}.tar.gz &gt; resources-${{ matrix.image_name }}-${IMAGE_TAG}.sha256sum.txt</span><span class="w">    
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Release and upload packages</span><span class="w">
</span><span class="w"></span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">startsWith(github.ref, &#39;refs/tags/&#39;)</span><span class="w">
</span><span class="w"></span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">softprops/action-gh-release@v1</span><span class="w">
</span><span class="w"></span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">GITHUB_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.GITHUB_TOKEN }}</span><span class="w">
</span><span class="w"></span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    resources-${{ matrix.image_name }}-${{ env.IMAGE_TAG }}.sha256sum.txt
</span><span class="sd">    resources-${{ matrix.image_name }}-${{ env.IMAGE_TAG }}-amd64.tar.gz
</span><span class="sd">    resources-${{ matrix.image_name }}-${{ env.IMAGE_TAG }}-arm64.tar.gz</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>All-in-one merges all built images</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">upload</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">build]</span><span class="w">
</span><span class="w"></span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20.04</span><span class="w">
</span><span class="w"></span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># fetch all git repo tag for define image tag</span><span class="w">
</span><span class="w">        </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up QEMU</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-qemu-action@v1</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set up Docker Buildx</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/setup-buildx-action@v1</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Log in to GitHub Docker Registry</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/login-action@v1</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.IMAGE_REGISTRY }}</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.REGISTRY_USER }}</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">${{ env.REGISTRY_TOKEN }}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Prepare for build images</span><span class="w">
</span><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        git describe --tags --always | sed &#39;s/^/IMAGE_TAG=/&#39; &gt;&gt; $GITHUB_ENV
</span><span class="sd">        source $GITHUB_ENV
</span><span class="sd">        echo &#34;FROM scratch&#34; &gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-ubuntu1804:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-ubuntu2004:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-centos7:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-centos8:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-debian9:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile
</span><span class="sd">        echo &#34;COPY --from=${{ env.IMAGE_REPO }}/os-packages-debian10:${IMAGE_TAG} / /&#34; &gt;&gt; Dockerfile</span><span class="w">        
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build os-packages images to local</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">docker/build-push-action@v2</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">.</span><span class="w">
</span><span class="w">        </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span><span class="w">        </span><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="l">linux/amd64,linux/arm64</span><span class="w">
</span><span class="w">        </span><span class="nt">outputs</span><span class="p">:</span><span class="w"> </span><span class="l">type=local,dest=./</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Prepare for upload package</span><span class="w">
</span><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        mv linux_amd64/resources resources
</span><span class="sd">        tar -I pigz -cf resources-os-packages-all-${IMAGE_TAG}-amd64.tar.gz resources --remove-files
</span><span class="sd">        mv linux_arm64/resources resources
</span><span class="sd">        tar -I pigz -cf resources-os-packages-all-${IMAGE_TAG}-arm64.tar.gz resources --remove-files
</span><span class="sd">        sha256sum resources-os-packages-all-${IMAGE_TAG}-{amd64,arm64}.tar.gz &gt; resources-os-packages-all-${IMAGE_TAG}.sha256sum.txt</span><span class="w">        
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Release and upload packages</span><span class="w">
</span><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">startsWith(github.ref, &#39;refs/tags/&#39;)</span><span class="w">
</span><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">softprops/action-gh-release@v1</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">GITHUB_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.GITHUB_TOKEN }}</span><span class="w">
</span><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        resources-os-packages-all-${{ env.IMAGE_TAG }}.sha256sum.txt
</span><span class="sd">        resources-os-packages-all-${{ env.IMAGE_TAG }}-amd64.tar.gz
</span><span class="sd">        resources-os-packages-all-${{ env.IMAGE_TAG }}-arm64.tar.gz</span><span class="w">        
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="optimization">Optimization</h2>
<h3 id="dockerfile">Dockerfile</h3>
<p>You can consider merging the build process in Dockerfile into a shell script, and then call this script in Dockerfile, which can optimize the maintainability of Dockerfile code and reuse some of the same code when adapting to multiple OSes, but this may lead to invalidation of the docker build cache.</p>
<p>Of course, you can also use a script to merge multiple Dockerfiles into one, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Merge all Dockerfile.xx to an all-in-one file</span>
ls Dockerfile.* <span class="p">|</span> xargs -L1 grep -Ev <span class="s1">&#39;FROM scratch|COPY --from=&#39;</span> &gt; Dockerfile
<span class="nb">echo</span> <span class="s2">&#34;FROM scratch&#34;</span> &gt;&gt; Dockerfile
ls Dockerfile.* <span class="p">|</span> xargs -L1 grep <span class="s1">&#39;COPY --from=&#39;</span> &gt;&gt; Dockerfile
</code></pre></td></tr></table>
</div>
</div><p>In fact, if you use GitHub actions to build, you don&rsquo;t need to merge, you can build in parallel using the actions matrix build feature.</p>
<h3 id="package-version">Package version</h3>
<p>For some packages that contain Linux distribution designators, it is not convenient to maintain the designators manually, so you can consider changing them to placeholder variables by using sed to replace them after the package.list file is generated in the build container, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apt</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">docker-ce=5:19.03.15~3-0~__ID__-__VERSION_CODENAME__</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Use sed to process these placeholder variables in the resulting packages.list</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sed -i <span class="s2">&#34;s|__ID__|</span><span class="k">$(</span>sed -n <span class="s1">&#39;s|^ID=||p&#39;</span> /etc/os-release<span class="k">)</span><span class="s2">|;s|__VERSION_CODENAME__|</span><span class="k">$(</span>sed -n <span class="s1">&#39;s|^VERSION_CODENAME=||p&#39;</span> /etc/os-release<span class="k">)</span><span class="s2">|&#34;</span> packages.list
</code></pre></td></tr></table>
</div>
</div><p>Although this is unsightly, it does work 😂 and eventually we get the correct version number. Anyway, we try to maintain as few package versions as possible, for example, by putting a certain version of the docker-ce package in apt in the configuration file instead of debian/ubuntu, and adding these special items automatically through some environment variables or shell scripts, which can reduce some maintenance costs.</p>
<h2 id="tips">Tips</h2>
<ul>
<li>When Fedora specifies the package version, you also need to add the version of Fedora</li>
<li>Some packages in CentOS 7 and CentOS 8 have different package names, so you need to deal with them separately.</li>
<li>CentOS 7 and CentOS 8 build method is different, the final generation of repodata when CentOS 8 need to deal with a separate</li>
<li>Fedora 33 and Fedora 34 using GitHub actions build when the arm64 architecture will always be stuck, is due to the buildx bug caused, so only gave the Dockerfile, not put in the GitHub actions build pipeline.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/github/">github</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/ubuntu-21-10-performance-windows-10-11/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Ubuntu 21 10 Performance Windows 10 11</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/rust-1-55-0-released/">
            <span class="next-text nav-default">Rust 1.55.0 is officially released</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
