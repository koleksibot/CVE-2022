<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How do I collect and manage multi-line logs? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Multi-line logs (e.g. exception messages) provide a lot of very valuable information for debugging application problems, and today&amp;rsquo;s distributed microservices are popular basically collect the logs uniformly, such as the common ELK, EFK and other schemes, but these schemes do not look at multi-line logs as a whole without proper configuration, but each line is treated as a separate line of logs. This is difficult for us to accept.
In this article, we will describe the strategies of some common log collection tools for handling multi-line logs." /><meta name="keywords" content="Java, Multiline Logs" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/collect-multiline-logs/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How do I collect and manage multi-line logs?" />
<meta property="og:description" content="Multi-line logs (e.g. exception messages) provide a lot of very valuable information for debugging application problems, and today&rsquo;s distributed microservices are popular basically collect the logs uniformly, such as the common ELK, EFK and other schemes, but these schemes do not look at multi-line logs as a whole without proper configuration, but each line is treated as a separate line of logs. This is difficult for us to accept.
In this article, we will describe the strategies of some common log collection tools for handling multi-line logs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/collect-multiline-logs/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-27T15:17:30+08:00" />
<meta property="article:modified_time" content="2021-09-27T15:17:30+08:00" />

<meta itemprop="name" content="How do I collect and manage multi-line logs?">
<meta itemprop="description" content="Multi-line logs (e.g. exception messages) provide a lot of very valuable information for debugging application problems, and today&rsquo;s distributed microservices are popular basically collect the logs uniformly, such as the common ELK, EFK and other schemes, but these schemes do not look at multi-line logs as a whole without proper configuration, but each line is treated as a separate line of logs. This is difficult for us to accept.
In this article, we will describe the strategies of some common log collection tools for handling multi-line logs."><meta itemprop="datePublished" content="2021-09-27T15:17:30+08:00" />
<meta itemprop="dateModified" content="2021-09-27T15:17:30+08:00" />
<meta itemprop="wordCount" content="1328">
<meta itemprop="keywords" content="java,logstash,fluentd," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How do I collect and manage multi-line logs?"/>
<meta name="twitter:description" content="Multi-line logs (e.g. exception messages) provide a lot of very valuable information for debugging application problems, and today&rsquo;s distributed microservices are popular basically collect the logs uniformly, such as the common ELK, EFK and other schemes, but these schemes do not look at multi-line logs as a whole without proper configuration, but each line is treated as a separate line of logs. This is difficult for us to accept.
In this article, we will describe the strategies of some common log collection tools for handling multi-line logs."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How do I collect and manage multi-line logs?</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-27 15:17:30 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1328 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#json">JSON</a></li>
        <li><a href="#logstash">Logstash</a></li>
        <li><a href="#fluentd">Fluentd</a>
          <ul>
            <li><a href="#rails-logs">Rails Logs</a></li>
            <li><a href="#java-stack-logging">Java Stack Logging</a></li>
          </ul>
        </li>
        <li><a href="#fluent-bit">Fluent Bit</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Multi-line logs (e.g. exception messages) provide a lot of very valuable information for debugging application problems, and today&rsquo;s distributed microservices are popular basically collect the logs uniformly, such as the common ELK, EFK and other schemes, but these schemes do not look at multi-line logs as a whole without proper configuration, but each line is treated as a separate line of logs. This is difficult for us to accept.</p>
<p>In this article, we will describe the strategies of some common log collection tools for handling multi-line logs.</p>
<h2 id="json">JSON</h2>
<p>The easiest way to ensure that multiple lines of logging are processed as a single event is to record the log in JSON format, such as the following example of a regular Java daily log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="err">#</span> <span class="n">javaApp</span><span class="o">.</span><span class="na">log</span>
<span class="n">2019</span><span class="o">-</span><span class="n">08</span><span class="o">-</span><span class="n">14</span> <span class="n">14</span><span class="o">:</span><span class="n">51</span><span class="o">:</span><span class="n">22</span><span class="o">,</span><span class="n">299</span> <span class="n">ERROR</span> <span class="o">[</span><span class="n">http</span><span class="o">-</span><span class="n">nio</span><span class="o">-</span><span class="n">8080</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">8</span><span class="o">]</span> <span class="n">classOne</span><span class="o">:</span> <span class="n">Index</span> <span class="n">out</span> <span class="n">of</span> <span class="n">range</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">StringIndexOutOfBoundsException</span><span class="o">:</span> <span class="n">String</span> <span class="n">index</span> <span class="n">out</span> <span class="n">of</span> <span class="n">range</span><span class="o">:</span> <span class="n">18</span>
 <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">658</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">loggingApp</span><span class="o">.</span><span class="na">classOne</span><span class="o">.</span><span class="na">getResult</span><span class="o">(</span><span class="n">classOne</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">15</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">loggingApp</span><span class="o">.</span><span class="na">AppController</span><span class="o">.</span><span class="na">tester</span><span class="o">(</span><span class="n">AppController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">27</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke0</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">62</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">DelegatingMethodAccessorImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">43</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">Method</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">498</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">InvocableHandlerMethod</span><span class="o">.</span><span class="na">doInvoke</span><span class="o">(</span><span class="n">InvocableHandlerMethod</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">190</span><span class="o">)</span>
 <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">InvocableHandlerMethod</span><span class="o">.</span><span class="na">invokeForRequest</span><span class="o">(</span><span class="n">InvocableHandlerMethod</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="n">138</span><span class="o">)</span>
<span class="o">[...]</span>
</code></pre></td></tr></table>
</div>
</div><p>If the above logs are collected directly they will be recognized as multi-line logs, it is much easier to record these logs in JSON format and then introduce the JSON data, for example by using Log4J2 to record them in the following format.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;@timestamp&#34;</span><span class="p">:</span><span class="s2">&#34;2019-08-14T18:46:04.449+00:00&#34;</span><span class="p">,</span><span class="nt">&#34;@version&#34;</span><span class="p">:</span><span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34;Index out of range&#34;</span><span class="p">,</span><span class="nt">&#34;logger_name&#34;</span><span class="p">:</span><span class="s2">&#34;com.example.app.loggingApp.classOne&#34;</span><span class="p">,</span><span class="nt">&#34;thread_name&#34;</span><span class="p">:</span><span class="s2">&#34;http-nio-5000-exec-6&#34;</span><span class="p">,</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;ERROR&#34;</span><span class="p">,</span><span class="nt">&#34;level_value&#34;</span><span class="p">:</span><span class="mi">40000</span><span class="p">,</span><span class="nt">&#34;stack_trace&#34;</span><span class="p">:</span><span class="err">&#34;java.lang.StringIndexOutOfBoundsException</span><span class="p">:</span> <span class="err">String</span> <span class="err">index</span> <span class="err">out</span> <span class="err">of</span> <span class="err">range</span><span class="p">:</span> <span class="mi">18</span><span class="err">\n\tat</span> <span class="err">java.lang.String.charAt(String.java</span><span class="p">:</span><span class="mi">658</span><span class="err">)\n\tat</span> <span class="err">com.example.app.loggingApp.classOne.getResult(classOne.java</span><span class="p">:</span><span class="mi">15</span><span class="err">)\n\tat</span> <span class="err">com.example.app.loggingApp.AppController.tester(AppController.java</span><span class="p">:</span><span class="mi">27</span><span class="err">)\n\tat</span> <span class="err">sun.reflect.NativeMethodAccessorImpl.invoke</span><span class="mi">0</span><span class="err">(Native</span> <span class="err">Method)\n\tat</span> <span class="err">sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java</span><span class="p">:</span><span class="mi">62</span><span class="err">)\n\tat</span> <span class="err">sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java</span><span class="p">:</span><span class="mi">43</span><span class="err">)\n\tat</span> <span class="err">java.lang.reflect.Method.invoke(Method.java</span><span class="p">:</span><span class="mi">498</span><span class="err">)\n\tat</span> <span class="err">org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java</span><span class="p">:</span><span class="mi">190</span><span class="err">)\n\tat</span> <span class="err">org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java</span><span class="p">:</span><span class="mi">138</span><span class="err">)\n\tat</span>
<span class="p">[</span><span class="err">...</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This entire log message is contained in a single JSON object summary, which contains the complete exception stack information, most tools support direct parsing of JSON log data, which is the simplest way for the same operation and maintenance is also the most worry-free, but most developers are resistant to using JSON format to record logs ~ ~ ~ ~</p>
<h2 id="logstash">Logstash</h2>
<p>For those using Logstash, it is not difficult to support multi-line logs, Logstash can parse multi-line logs using a plugin that is configured in the <code>input</code> section of the logging pipeline. For example, the following configuration indicates that Logstash is told to match the timestamp of the <code>ISO8601</code> format in your log file, and when it matches that timestamp, it collapses everything that did not previously begin with the timestamp into the previous log entry.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">input {
  file {
    path =&gt; &#34;/var/app/current/logs/javaApp.log&#34;
    mode =&gt; &#34;tail&#34;
    codec =&gt; multiline {
      pattern =&gt; &#34;^%{TIMESTAMP_ISO8601} &#34;
      negate =&gt; true
      what =&gt; &#34;previous&#34;
    }
  }
}
</code></pre></td></tr></table>
</div>
</div><h2 id="fluentd">Fluentd</h2>
<p>Similar to Logstash, Fluentd allows us to use a plugin to handle multi-line logs, and we can configure the plugin to accept one or more regular expressions, as exemplified by the following Python multi-line log</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2019-08-01 18:58:05,898 ERROR:Exception on main handler
Traceback (most recent call last):
  File &#34;python-logger.py&#34;, line 9, in make_log
    return word[13]
IndexError: string index out of range
</code></pre></td></tr></table>
</div>
</div><p>Without the <code>multiline</code> multiline parser, Fluentd will treat each line as a complete log. We can add a <code>multiline</code> parsing rule to the <code>&lt;source&gt;</code> module, which must include a <code>format_firstline</code> parameter to specify what a new log entry starts with, in addition to You can use regular grouping and capturing to parse the attributes in the log, as configured below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;source&gt;</span>
  @type tail
  path /path/to/pythonApp.log
  tag sample.tag
  <span class="nt">&lt;parse&gt;</span>
    @type multiline
    format_firstline /\d{4}-\d{1,2}-\d{1,2}/
    format1 /(?<span class="nt">&lt;timestamp&gt;</span>[^ ]* [^ ]*) (?<span class="nt">&lt;level&gt;</span>[^\s]+:)(?<span class="nt">&lt;message&gt;</span>[\s\S]*)/
  <span class="nt">&lt;/parse&gt;</span>
<span class="nt">&lt;/source&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>In the parsing section we specified the multiline parser using <code>@type multiline</code>, then used <code>format_firstline</code> to specify our rules for the beginning of the multiline log, here we just used a simple regular match date, then specified the matching pattern for the other sections and assigned labels to them, here we split the log into <code>timestamp</code>, <code>level</code>, <code>message</code> fields.</p>
<p>After parsing the rules above, Fluentd will now see each traceback log as a single log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-08-01 19:22:14,196&#34;</span><span class="p">,</span>
  <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;ERROR:&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;Exception on main handler\nTraceback (most recent call last):\n  File \&#34;python-logger.py\&#34;, line 9, in make_log\n    return word[13]\nIndexError: string index out of range&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The log has been formatted as JSON and the tag we matched has been set to Key.</p>
<p>There are also several example instructions in the official Fluentd documentation.</p>
<h3 id="rails-logs">Rails Logs</h3>
<p>For example, the entered Rails logs look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">Started GET <span class="s2">&#34;/users/123/&#34;</span> <span class="k">for</span> 127.0.0.1 at 2013-06-14 12:00:11 +0900
Processing by UsersController#show as HTML
  Parameters: <span class="o">{</span><span class="s2">&#34;user_id&#34;</span><span class="o">=</span>&gt;<span class="s2">&#34;123&#34;</span><span class="o">}</span>
  Rendered users/show.html.erb within layouts/application <span class="o">(</span>0.3ms<span class="o">)</span>
Completed <span class="m">200</span> OK in 4ms <span class="o">(</span>Views: 3.2ms <span class="p">|</span> ActiveRecord: 0.0ms<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>We can use the following parsing configuration for multi-line matching.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;parse&gt;</span>
  @type multiline
  format_firstline /^Started/
  format1 /Started (?<span class="nt">&lt;method&gt;</span>[^ ]+) &#34;(?<span class="nt">&lt;path&gt;</span>[^&#34;]+)&#34; for (?<span class="nt">&lt;host&gt;</span>[^ ]+) at (?<span class="nt">&lt;time&gt;</span>[^ ]+ [^ ]+ [^ ]+)\n/
  format2 /Processing by (?<span class="nt">&lt;controller&gt;</span>[^\u0023]+)\u0023(?<span class="nt">&lt;controller_method&gt;</span>[^ ]+) as (?<span class="nt">&lt;format&gt;</span>[^ ]+?)\n/
  format3 /(  Parameters: (?<span class="nt">&lt;parameters&gt;</span>[^ ]+)\n)?/
  format4 /  Rendered (?<span class="nt">&lt;template&gt;</span>[^ ]+) within (?<span class="nt">&lt;layout&gt;</span>.+) \([\d\.]+ms\)\n/
  format5 /Completed (?<span class="nt">&lt;code&gt;</span>[^ ]+) [^ ]+ in (?<span class="nt">&lt;runtime&gt;</span>[\d\.]+)ms \(Views: (?<span class="nt">&lt;view_runtime&gt;</span>[\d\.]+)ms \| ActiveRecord: (?<span class="nt">&lt;ar_runtime&gt;</span>[\d\.]+)ms\)/
<span class="nt">&lt;/parse&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>The logs obtained after parsing are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;method&#34;</span>           <span class="p">:</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span>
  <span class="nt">&#34;path&#34;</span>             <span class="p">:</span><span class="s2">&#34;/users/123/&#34;</span><span class="p">,</span>
  <span class="nt">&#34;host&#34;</span>             <span class="p">:</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
  <span class="nt">&#34;controller&#34;</span>       <span class="p">:</span><span class="s2">&#34;UsersController&#34;</span><span class="p">,</span>
  <span class="nt">&#34;controller_method&#34;</span><span class="p">:</span><span class="s2">&#34;show&#34;</span><span class="p">,</span>
  <span class="nt">&#34;format&#34;</span>           <span class="p">:</span><span class="s2">&#34;HTML&#34;</span><span class="p">,</span>
  <span class="nt">&#34;parameters&#34;</span>       <span class="p">:</span><span class="s2">&#34;{ \&#34;user_id\&#34;:\&#34;123\&#34;}&#34;</span><span class="p">,</span>
  <span class="err">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="java-stack-logging">Java Stack Logging</h3>
<p>For example, the log we are now parsing is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2013-3-03 14:27:33 [main] INFO  Main - Start
2013-3-03 14:27:33 [main] ERROR Main - Exception
javax.management.RuntimeErrorException: null
    at Main.main(Main.java:16) ~[bin/:na]
2013-3-03 14:27:33 [main] INFO  Main - End
</code></pre></td></tr></table>
</div>
</div><p>Then we can use the following parsing rule for multi-line matching.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;parse&gt;</span>
  @type multiline
  format_firstline /\d{4}-\d{1,2}-\d{1,2}/
  format1 /^(?<span class="nt">&lt;time&gt;</span>\d{4}-\d{1,2}-\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}) \[(?<span class="nt">&lt;thread&gt;</span>.*)\] (?<span class="nt">&lt;level&gt;</span>[^\s]+)(?<span class="nt">&lt;message&gt;</span>.*)/
<span class="nt">&lt;/parse&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>The parsed log is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;thread&#34;</span> <span class="p">:</span><span class="s2">&#34;main&#34;</span><span class="p">,</span>
  <span class="nt">&#34;level&#34;</span>  <span class="p">:</span><span class="s2">&#34;INFO&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34;  Main - Start&#34;</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&#34;thread&#34;</span> <span class="p">:</span><span class="s2">&#34;main&#34;</span><span class="p">,</span>
  <span class="nt">&#34;level&#34;</span>  <span class="p">:</span><span class="s2">&#34;ERROR&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34; Main - Exception\njavax.management.RuntimeErrorException: null\n    at Main.main(Main.java:16) ~[bin/:na]&#34;</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&#34;thread&#34;</span> <span class="p">:</span><span class="s2">&#34;main&#34;</span><span class="p">,</span>
  <span class="nt">&#34;level&#34;</span>  <span class="p">:</span><span class="s2">&#34;INFO&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34;  Main - End&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In addition to <code>format_firstline</code>, which specifies the start line of the multi-line log, the above multi-line parsing configuration also uses <code>format1</code>, <code>format2</code> &hellip; <code>formatN</code>, where N ranges from <code>1...20</code>, which is the Regexp format list of the multi-line log. .20, which is a list of Regexp formats for multi-line logs. For the sake of the band, you can split the Regexp pattern into multiple <code>regexpN</code> parameters, and connect these matching patterns to construct a regular match for multi-line patterns.</p>
<h2 id="fluent-bit">Fluent Bit</h2>
<p>Fluent Bit&rsquo;s <code>tail input</code> plugin also provides configuration options for handling multi-line logs, for example, let&rsquo;s now work with the previous Python multi-line logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">2019-08-01 18:58:05,898 ERROR:Exception on main handler
Traceback (most recent call last):
  File &#34;python-logger.py&#34;, line 9, in make_log
    return word[13]
IndexError: string index out of range
</code></pre></td></tr></table>
</div>
</div><p>If we don&rsquo;t use the multiline parser Fluent Bit will also treat each line as a log, and we can configure the multiline log to be structured using Fluent Bit&rsquo;s built-in regex parser plugin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">  [PARSER]
      Name         log_date
      Format       regex
      Regex        /\d{4}-\d{1,2}-\d{1,2}/

  [PARSER]
      Name        log_attributes
      Format      regex
      Regex       /(?&lt;timestamp&gt;[^ ]* [^ ]*) (?&lt;level&gt;[^\s]+:)(?&lt;message&gt;[\s\S]*)/

   [INPUT]
      Name              tail
      tag               sample.tag
      path              /path/to/pythonApp.log
      Multiline         On
      Parser_Firstline  log_date
      Parser_1          log_attributes
</code></pre></td></tr></table>
</div>
</div><p>Similar to Fluentd, the <code>Parser_Firstline</code> parameter specifies the name of the parser that matches the beginning of a multi-line log, although we can include additional parsers to further structure your logs. Here we have configured the <code>Parser_Firstline</code> parameter to first match log lines starting with the <code>ISO8601</code> date, and then used the <code>Parser_1</code> parameter to specify a matching pattern to match the rest of the log messages, assigning them the <code>timestamp</code>, <code>level</code>, and <code>message</code> tags.</p>
<p>After the final conversion our logs become in the format shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-08-01 19:22:14,196&#34;</span><span class="p">,</span>
  <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;ERROR:&#34;</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;Exception on main handler\nTraceback (most recent call last):\n  File \&#34;python-logger.py\&#34;, line 9, in make_log\n    return word[13]\nIndexError: string index out of range&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java/">java</a>
          <a href="/tags/logstash/">logstash</a>
          <a href="/tags/fluentd/">fluentd</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/use-kubernetes-service-apis-with-traefik/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Traffic routing with Kubernetes Service APIs via Traefik</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/use-kube-vip-ha-k8s-lb/">
            <span class="next-text nav-default">Building a Highly Available Kubernetes Cluster with kube-vip</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
