<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to use the registry storage features - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="I am currently responsible for the packaging and release of the company&amp;rsquo;s PaaS toB product. One of my daily tasks is to run the automated packaging pipeline, and then update the installation packages to the QA test environment. Since the packaging and testing environments are located in two different server rooms, the product installation packages need to be synchronized across the public network from the packaging machine to the QA" /><meta name="keywords" content="k8s, registry storage features" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/skopeo-to-registry/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How to use the registry storage features" />
<meta property="og:description" content="I am currently responsible for the packaging and release of the company&rsquo;s PaaS toB product. One of my daily tasks is to run the automated packaging pipeline, and then update the installation packages to the QA test environment. Since the packaging and testing environments are located in two different server rooms, the product installation packages need to be synchronized across the public network from the packaging machine to the QA" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/skopeo-to-registry/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-16T14:32:01+08:00" />
<meta property="article:modified_time" content="2021-09-16T14:32:01+08:00" />

<meta itemprop="name" content="How to use the registry storage features">
<meta itemprop="description" content="I am currently responsible for the packaging and release of the company&rsquo;s PaaS toB product. One of my daily tasks is to run the automated packaging pipeline, and then update the installation packages to the QA test environment. Since the packaging and testing environments are located in two different server rooms, the product installation packages need to be synchronized across the public network from the packaging machine to the QA"><meta itemprop="datePublished" content="2021-09-16T14:32:01+08:00" />
<meta itemprop="dateModified" content="2021-09-16T14:32:01+08:00" />
<meta itemprop="wordCount" content="2490">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use the registry storage features"/>
<meta name="twitter:description" content="I am currently responsible for the packaging and release of the company&rsquo;s PaaS toB product. One of my daily tasks is to run the automated packaging pipeline, and then update the installation packages to the QA test environment. Since the packaging and testing environments are located in two different server rooms, the product installation packages need to be synchronized across the public network from the packaging machine to the QA"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to use the registry storage features</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-16 14:32:01 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 2490 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#optimize-again">Optimize again</a></li>
        <li><a href="#build-skopeo-dir-mirror-storage">Build skopeo dir mirror storage</a></li>
        <li><a href="#convert-to-registry-storage-directory">Convert to registry storage directory</a></li>
        <li><a href="#revert-back-to-dir-format">Revert back to Dir format</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I am currently responsible for the packaging and release of the company&rsquo;s PaaS toB product. One of my daily tasks is to run the automated packaging pipeline, and then update the installation packages to the QA test environment. Since the packaging and testing environments are located in two different server rooms, the product installation packages need to be synchronized across the public network from the packaging machine to the QA environment, so the size of the product installation packages determines the time consuming synchronization between the two. Optimizing and reducing the size of product installers is one of the ways to improve the efficiency of the pipeline. One of the recent efforts was to reduce the size of product patch packages by 30% to 60%, which greatly saved the time spent on uploading, downloading and installing patches, and improved the efficiency of the product packaging pipeline. So today we will summarize what we have learned from this experience.</p>
<h2 id="optimize-again">Optimize again</h2>
<p>Because all the components of the product are deployed in containerized form, the most important thing in the patch package of the product is the image file and some deployment scripts. As we all know, the docker image is composed of layers + metadata information of the image, where the metadata information of the image is the image config + manifests, which are text contents in json format, and these text contents are often negligible compared to the size of the layer of the image.</p>
<p>In fact, an optimization was done last year, replacing the way the patch package image is packaged from the original docker save to the skopeo copy to directory. Although the first time has been so obvious optimization, we still think there is room for optimization.</p>
<p>After the first optimization, the image in the product patch package exists in the following form.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">root@debian:/root/kube # tree images -h
images
├── [4.0K]  kube-apiserver:v1.20.5
│   ├── [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722
│   ├── [ 28M]  98d681774b176bb2fd6b3499377d63ff4b1b040886dd9d3641bb93840815a1e7
│   ├── [2.6K]  d7e24aeb3b10210bf6a2dc39f77c1ea835b22af06dfd2933c06e0421ed6d35ac
│   ├── [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9
│   ├── [ 949]  manifest.json
│   └── [  33]  version
├── [4.0K]  kube-controller-manager:v1.20.5
│   ├── [ 27M]  454a7944c47b608efb657a1bef7f4093f63ceb2db14fd78c5ecd2a08333da7cf
│   ├── [2.6K]  6f0c3da8c99e99bbe82920a35653f286bd8130f0662884e77fa9fcdca079c07f
│   ├── [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722
│   ├── [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9
│   ├── [ 949]  manifest.json
│   └── [  33]  version
└── [4.0K]  kube-scheduler:v1.20.5
    ├── [ 12M]  565677e452d17c4e2841250bbf0cc010d906fbf7877569bb2d69bfb4e68db1b5
    ├── [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722
    ├── [2.6K]  8d13f1db8bfb498afb0caff6bf3f8c599ecc2ace74275f69886067f6af8ffdf6
    ├── [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9
    ├── [ 949]  manifest.json
    └── [  33]  version
</code></pre></td></tr></table>
</div>
</div><p>For example, <code>kube-apiserver</code>, <code>kube-controller-manager</code>, and <code>kube-scheduler</code> are all base images that use <code>k8s.gcr.io/build-image/go-runner</code>. controller-manager<code>and</code>kube-scheduler<code>all use the</code>k8s.gcr.io/build-image/go-runner<code>base image. In the registry, it only needs to store one copy of the</code>go-runner` base image. If you use skopeo copy to store it in a directory, you need to store a separate copy of the base image.</p>
<p>From the file names and file sizes, we can roughly deduce that the <code>707K</code> size 742efefc8a is the root filesystem of the <code>go-runner</code> image; the <code>642K</code> size fefd47533 is the go-runner binary; the <code>2.x</code> size should be the image config file of the image; the remaining The remaining ones are the binary files of <code>kube-apiserver</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code>, and the manifest.json file is the manifest of the image in the registry storage.</p>
<ul>
<li>Using find to count the number of these files, the total number of layer files and config files in the mirror is reduced from 12 to 8 after de-duplication. A simple addition calculation is: 3 image config files + 3 binary files + 1 base image layer file + 1 go-runner binary file, which is exactly 8 😂</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root/kube <span class="c1"># find images -type f | grep -Eo &#34;\b[a-f0-9]{64}\b&#34; | wc</span>
<span class="m">12</span>
root@debian:/root/kube <span class="c1"># find images -type f | grep -Eo &#34;\b[a-f0-9]{64}\b&#34; | sort -u | wc -l</span>
<span class="m">8</span>
</code></pre></td></tr></table>
</div>
</div><p>Since the image files in the patch package have some of the same layers, wouldn&rsquo;t it be possible to reduce the size of the patch package by removing these same layer files? So I took a historical patch package and tested it out.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root $ du -sh images
3.3G	images
root@debian:/root $ find images -type f ! -name <span class="s1">&#39;version&#39;</span> ! -name <span class="s1">&#39;manifest.json&#39;</span> <span class="p">|</span> wc -l
<span class="m">279</span>
root@debian:/root $ mkdir -p images2
root@debian:/root $ find images -type f -exec mv <span class="o">{}</span> images2 <span class="se">\;</span>
root@debian:/root $ du -sh images2
1.3G	images2
root@debian:/root $ $ find images2 -type f ! -name <span class="s1">&#39;version&#39;</span> ! -name <span class="s1">&#39;manifest.json&#39;</span> <span class="p">|</span> wc -l
<span class="m">187</span>
</code></pre></td></tr></table>
</div>
</div><p>After testing, I found that the total number of image files in the patch package was reduced from 279 to 187, and the total size was reduced from 3.3G to 1.3G, a 60% reduction! I was so excited at that time that I was like a treasure. In fact, this is because the base images used by our product components are basically the same, so many of the same base image layer files can be eliminated.</p>
<p>Now that we have found a way to reduce the size of the mirrors in the patch package, we just need to find a way to de-duplicate these mirror layers. The first idea is to use registry storage: according to the nature of registry storage, mirrors can reuse the same layer in the registry. So the general idea is to convert the mirrors in these patch packages to the registry storage format, and then convert the registry storage format to the dir format supported by skopeo copy during installation.</p>
<h2 id="build-skopeo-dir-mirror-storage">Build skopeo dir mirror storage</h2>
<ul>
<li>In order to facilitate the demonstration, we need to find a suitable mirror list, after looking at the <a href="https://github.com/kubesphere/ks-installer">ks-installer</a> project there is a mirror list, it looks more suitable then use it 😃</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># curl -L -O https://github.com/kubesphere/ks-installer/releases/download/v3.0.0/images-list.txt</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>First synchronize the image to the local directory using skopeo sync and count the size of the image and the number of files</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># for img in $(cat cat images-list.txt | grep -v &#34;#&#34;);do skopeo sync --insecure-policy --src docker --dest dir ${img} images; done</span>

root@debian:/root <span class="c1"># tree images -d -L 1</span>
images
├── alpine:3.10.4
├── busybox:1.31.1
├── calico
├── coredns
├── csiplugin
├── docker:19.03
├── elastic
├── fluent
├── haproxy:2.0.4
├── istio
├── jaegertracing
├── java:openjdk-8-jre-alpine
├── jenkins
├── jimmidyson
├── joosthofman
├── kubesphere
├── minio
├── mirrorgooglecontainers
├── mysql:8.0.11
├── nginx:1.14-alpine
├── nginxdemos
├── openpitrix
├── osixia
├── perl:latest
├── prom
├── redis:5.0.5-alpine
└── wordpress:4.8-apache
</code></pre></td></tr></table>
</div>
</div><ul>
<li>After using skopeo sync to sync the images to the local images directory, the size of all the images is 11G and the total number of files is 1264.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># du -sh images</span>
11G	images
root@debian:/root <span class="c1"># find images -type f ! -name &#34;version&#34; | wc -l</span>
<span class="m">1264</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="convert-to-registry-storage-directory">Convert to registry storage directory</h2>
<p>According to the registry storage structure shown below, we have to store the image layer, image config, and manifests in the blobs/sha256 directory according to their sha256 values, and then create the corresponding link files in the repositories directory, so that the image can be converted to the registry storage format.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/16/f9aa3b69e60d4bcfb7f9bbecbf4ec470.png" alt=""></p>
<p>For demonstration purposes, let&rsquo;s take a single image and convert the image <code>images/alpine:3.10.4</code> into a docker registry storage directory</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># tree -h images/alpine:3.10.4</span>
images/alpine:3.10.4
└── <span class="o">[</span>4.0K<span class="o">]</span>  alpine:3.10.4
    ├── <span class="o">[</span>2.7M<span class="o">]</span>  4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98
    ├── <span class="o">[</span>1.5K<span class="o">]</span>  af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e
    ├── <span class="o">[</span> 528<span class="o">]</span>  manifest.json
    └── <span class="o">[</span>  33<span class="o">]</span>  version
</code></pre></td></tr></table>
</div>
</div><p>According to the image file size we can know that: <code>2.7M</code> size <code>4167d3e1497......</code> file is the layer file of the image, since alpine is a base image, the layer is the root file system of alpine; <code>1.5K</code> size <code>af341ccd2......</code> is obviously the images config file of the image; the <code>manifest.json</code> file is the manifest.json file of the image in the registry storage.</p>
<ul>
<li>First create the directory structure of the image in registry storage</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># mkdir -p docker/registry/v2/{blobs/sha256,repositories/alpine}</span>
root@debian:/root <span class="c1"># tree docker</span>
docker
└── registry
    └── v2
        ├── blobs
        │   └── sha256
        └── repositories
            └── alpine
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Build the link file for the mirror layer</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">grep -Eo <span class="s2">&#34;\b[a-f0-9]{64}\b&#34;</span> images/alpine:3.10.4/manifest.json <span class="p">|</span> sort -u <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> mkdir -p docker/registry/v2/repositories/alpine/_layers/sha256/<span class="o">{}</span>

grep -Eo <span class="s2">&#34;\b[a-f0-9]{64}\b&#34;</span> images/alpine:3.10.4/manifest.json <span class="p">|</span> sort -u <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> sh -c <span class="s2">&#34;echo -n &#39;sha256:{}&#39; &gt; docker/registry/v2/repositories/alpine/_layers/sha256/{}/link&#34;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Build the link file for the mirror tag</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">manifests_sha256</span><span class="o">=</span><span class="k">$(</span>sha256sum images/alpine:3.10.4/manifest.json <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
mkdir -p docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>/link

mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/index/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/index/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>/link

mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/current
<span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/current/link
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Build the blobs directory of the image</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">mkdir -p docker/registry/v2/blobs/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>
ln -f images/alpine:3.10.4/manifest.json docker/registry/v2/blobs/sha256/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">manifests_sha256</span><span class="si">}</span>/data

<span class="k">for</span> layer in <span class="k">$(</span>grep -Eo <span class="s2">&#34;\b[a-f0-9]{64}\b&#34;</span> images/alpine:3.10.4/manifest.json<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    mkdir -p docker/registry/v2/blobs/sha256/<span class="si">${</span><span class="nv">layer</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>
    ln -f  images/alpine:3.10.4/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span> docker/registry/v2/blobs/sha256/<span class="si">${</span><span class="nv">layer</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>/data
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The resulting registry storage directory is as follows</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">docker
└── registry
    └── v2
        ├── blobs
        │   └── sha256
        │       ├── 41
        │       │   └── 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98
        │       │       └── data
        │       ├── af
        │       │   └── af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e
        │       │       └── data
        │       └── de
        │           └── de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8
        │               └── data
        └── repositories
            └── alpine
                ├── _layers
                │   └── sha256
                │       ├── 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98
                │       │   └── link
                │       └── af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e
                │           └── link
                └── _manifests
                    ├── revisions
                    │   └── sha256
                    │       └── de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8
                    │           └── link
                    └── tags
                        └── 3.10.4
                            ├── current
                            │   └── link
                            └── index
                                └── sha256
                                    └── de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8
                                        └── link
</code></pre></td></tr></table>
</div>
</div><ul>
<li>To test if it works, locally docker run a registry container, mount the registry storage directory you just converted to /var/lib/registry of the container, then pull the image using docker pull and test if it works using docker run. If you can verify that it works, then the conversion is fine 😊.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># docker pull localhost/alpine:3.10.4</span>
3.10.4: Pulling from alpine
4167d3e14976: Pull <span class="nb">complete</span>
Digest: sha256:de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8
Status: Downloaded newer image <span class="k">for</span> localhost/alpine:3.10.4
root@debian:/root <span class="c1"># docker run --rm -it localhost/alpine:3.10.4 cat /etc/os-release</span>
<span class="nv">NAME</span><span class="o">=</span><span class="s2">&#34;Alpine Linux&#34;</span>
<span class="nv">ID</span><span class="o">=</span>alpine
<span class="nv">VERSION_ID</span><span class="o">=</span>3.10.4
<span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">&#34;Alpine Linux v3.10&#34;</span>
<span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">&#34;https://alpinelinux.org/&#34;</span>
<span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">&#34;https://bugs.alpinelinux.org/&#34;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Combine the above steps into a shell script that reads</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nb">set</span> -eo pipefail

<span class="nv">IMAGES_DIR</span><span class="o">=</span><span class="s2">&#34;images&#34;</span>
<span class="nv">REGISTRY_DIR</span><span class="o">=</span><span class="s2">&#34;docker&#34;</span>

rm -rf <span class="si">${</span><span class="nv">REGISTRY_DIR</span><span class="si">}</span>
<span class="nv">BLOBS_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">REGISTRY_DIR</span><span class="si">}</span><span class="s2">/registry/v2/blobs&#34;</span>
<span class="nv">REPO_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">REGISTRY_DIR</span><span class="si">}</span><span class="s2">/registry/v2/repositories&#34;</span>

<span class="k">for</span> image in <span class="k">$(</span>find <span class="si">${</span><span class="nv">IMAGES_DIR</span><span class="si">}</span> -type f <span class="p">|</span> sed -n <span class="s1">&#39;s|/manifest.json||p&#39;</span> <span class="p">|</span> sort -u<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">image</span><span class="p">%%:*</span><span class="si">}</span> <span class="p">|</span> sed <span class="s2">&#34;s|</span><span class="si">${</span><span class="nv">IMAGES_DIR</span><span class="si">}</span><span class="s2">/||g&#34;</span><span class="k">)</span>
    <span class="nv">image_tag</span><span class="o">=</span><span class="si">${</span><span class="nv">image</span><span class="p">##*:</span><span class="si">}</span><span class="p">;</span> <span class="nv">mfs</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">image</span><span class="si">}</span><span class="s2">/manifest.json&#34;</span>
    <span class="nv">mfs_sha256</span><span class="o">=</span><span class="k">$(</span>sha256sum <span class="si">${</span><span class="nv">image</span><span class="si">}</span>/manifest.json <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
    mkdir -p <span class="si">${</span><span class="nv">BLOBS_PATH</span><span class="si">}</span>/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>
    ln -f <span class="si">${</span><span class="nv">mfs</span><span class="si">}</span> <span class="si">${</span><span class="nv">BLOBS_PATH</span><span class="si">}</span>/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>/data

    <span class="c1"># make image repositories dir</span>
    mkdir -p <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/<span class="o">{</span>_layers,_manifests/revisions<span class="o">}</span>/sha256
    mkdir -p <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/revisions/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>
    mkdir -p <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/tags/<span class="si">${</span><span class="nv">image_tag</span><span class="si">}</span>/<span class="o">{</span>current,index/sha256<span class="o">}</span>
    mkdir -p <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/tags/<span class="si">${</span><span class="nv">image_tag</span><span class="si">}</span>/index/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>

    <span class="c1"># create image tag manifest link file</span>
    <span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/tags/<span class="si">${</span><span class="nv">image_tag</span><span class="si">}</span>/current/link
    <span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/revisions/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>/link
    <span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span><span class="s2">&#34;</span> &gt; <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_manifests/tags/<span class="si">${</span><span class="nv">image_tag</span><span class="si">}</span>/index/sha256/<span class="si">${</span><span class="nv">mfs_sha256</span><span class="si">}</span>/link

    <span class="c1"># link image layers file to registry blobs file</span>
    <span class="k">for</span> layer in <span class="k">$(</span>grep -Eo <span class="s2">&#34;\b[a-f0-9]{64}\b&#34;</span> <span class="si">${</span><span class="nv">mfs</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        mkdir -p <span class="si">${</span><span class="nv">BLOBS_PATH</span><span class="si">}</span>/sha256/<span class="si">${</span><span class="nv">layer</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>
        mkdir -p <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_layers/sha256/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>
        <span class="nb">echo</span> -n <span class="s2">&#34;sha256:</span><span class="si">${</span><span class="nv">layer</span><span class="si">}</span><span class="s2">&#34;</span> &gt; <span class="si">${</span><span class="nv">REPO_PATH</span><span class="si">}</span>/<span class="si">${</span><span class="nv">image_name</span><span class="si">}</span>/_layers/sha256/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>/link
        ln -f <span class="si">${</span><span class="nv">image</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span> <span class="si">${</span><span class="nv">BLOBS_PATH</span><span class="si">}</span>/sha256/<span class="si">${</span><span class="nv">layer</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>/data
    <span class="k">done</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Using this script to convert all images in images, the final registry storage size is 8.3 G, which is 2.7 G less than before.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">root@debian:/root <span class="c1"># du -sh docker</span>
8.3G	docker
root@debian:/root <span class="c1"># find docker -type f -name &#34;data&#34; | wc -l</span>
<span class="m">1046</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="revert-back-to-dir-format">Revert back to Dir format</h2>
<p>After the above steps, the total size of the image files in the patch package is indeed reduced, but another problem is introduced: skopeo cannot use the registry storage format directly. So we need to do another conversion to restore the image from the registry storage format back to the dir format supported by skopeo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nv">REGISTRY_DOMAIN</span><span class="o">=</span><span class="s2">&#34;harbor.k8s.li&#34;</span>
<span class="nv">REGISTRY_PATH</span><span class="o">=</span><span class="s2">&#34;/var/lib/registry&#34;</span>

<span class="c1"># 切换到 registry 存储主目录下</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">REGISTRY_PATH</span><span class="si">}</span>

gen_skopeo_dir<span class="o">()</span> <span class="o">{</span>
   <span class="c1"># 定义 registry 存储的 blob 目录 和 repositories 目录，方便后面使用</span>
    <span class="nv">BLOB_DIR</span><span class="o">=</span><span class="s2">&#34;docker/registry/v2/blobs/sha256&#34;</span>
    <span class="nv">REPO_DIR</span><span class="o">=</span><span class="s2">&#34;docker/registry/v2/repositories&#34;</span>
    <span class="c1"># 定义生成 skopeo 目录</span>
    <span class="nv">SKOPEO_DIR</span><span class="o">=</span><span class="s2">&#34;docker/skopeo&#34;</span>
    <span class="c1"># 通过 find 出 current 文件夹可以得到所有带 tag 的镜像，因为一个 tag 对应一个 current 目录</span>
    <span class="k">for</span> image in <span class="k">$(</span>find <span class="si">${</span><span class="nv">REPO_DIR</span><span class="si">}</span> -type d -name <span class="s2">&#34;current&#34;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        <span class="c1"># 根据镜像的 tag 提取镜像的名字</span>
        <span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">image</span><span class="si">}</span> <span class="p">|</span> awk -F <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $5&#34;/&#34;$6&#34;:&#34;$9}&#39;</span><span class="k">)</span>
        <span class="nv">link</span><span class="o">=</span><span class="k">$(</span>cat <span class="si">${</span><span class="nv">image</span><span class="si">}</span>/link <span class="p">|</span> sed <span class="s1">&#39;s/sha256://&#39;</span><span class="k">)</span>
        <span class="nv">mfs</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">BLOB_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">link</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">link</span><span class="si">}</span><span class="s2">/data&#34;</span>
        <span class="c1"># 创建镜像的硬链接需要的目录</span>
        mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SKOPEO_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">name</span><span class="si">}</span><span class="s2">&#34;</span>
        <span class="c1"># 硬链接镜像的 manifests 文件到目录的 manifest 文件</span>
        ln <span class="si">${</span><span class="nv">mfs</span><span class="si">}</span> <span class="si">${</span><span class="nv">SKOPEO_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span>/manifest.json
        <span class="c1"># 使用正则匹配出所有的 sha256 值，然后排序去重</span>
        <span class="nv">layers</span><span class="o">=</span><span class="k">$(</span>grep -Eo <span class="s2">&#34;\b[a-f0-9]{64}\b&#34;</span> <span class="si">${</span><span class="nv">mfs</span><span class="si">}</span> <span class="p">|</span> sort -u<span class="k">)</span>
        <span class="k">for</span> layer in <span class="si">${</span><span class="nv">layers</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
          <span class="c1"># 硬链接 registry 存储目录里的镜像 layer 和 images config 到镜像的 dir 目录</span>
            ln <span class="si">${</span><span class="nv">BLOB_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>/data <span class="si">${</span><span class="nv">SKOPEO_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span>/<span class="si">${</span><span class="nv">layer</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">done</span>
<span class="o">}</span>

sync_image<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># 使用 skopeo sync 将 dir 格式的镜像同步到 harbor</span>
    <span class="k">for</span> project in <span class="k">$(</span>ls <span class="si">${</span><span class="nv">SKOPEO_DIR</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        skopeo sync --insecure-policy --src-tls-verify<span class="o">=</span><span class="nb">false</span> --dest-tls-verify<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>        --src dir --dest docker <span class="si">${</span><span class="nv">SKOPEO_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">project</span><span class="si">}</span> <span class="si">${</span><span class="nv">REGISTRY_DOMAIN</span><span class="si">}</span>/<span class="si">${</span><span class="nv">project</span><span class="si">}</span>
    <span class="k">done</span>
<span class="o">}</span>

gen_skopeo_dir
sync_image
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/microsoft-announce-win11-dont-support-most-vm/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Microsoft confirms Windows 11 will not support most virtual machines</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/cpp-sort/">
            <span class="next-text nav-default">Sorting using the standard library std::sort function </span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
