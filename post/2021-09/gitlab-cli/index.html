<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>python-gitlab CLI Usage Notes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="It took us about two weeks to migrate our GitHub code to Gitlab, and the biggest impact was on our product release pipeline, which needed to be adapted to Gitlab and some services on our intranet environment. Basically, we had to rewrite the entire product release pipeline, and it was exhausting 🥺. At the time, I thought migrating the code to Gitlab was purely backwards 😅, but after" /><meta name="keywords" content="python-gitlab, CLI " />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/gitlab-cli/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="python-gitlab CLI Usage Notes" />
<meta property="og:description" content="It took us about two weeks to migrate our GitHub code to Gitlab, and the biggest impact was on our product release pipeline, which needed to be adapted to Gitlab and some services on our intranet environment. Basically, we had to rewrite the entire product release pipeline, and it was exhausting 🥺. At the time, I thought migrating the code to Gitlab was purely backwards 😅, but after" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/gitlab-cli/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-18T11:08:02+08:00" />
<meta property="article:modified_time" content="2021-09-18T11:08:02+08:00" />

<meta itemprop="name" content="python-gitlab CLI Usage Notes">
<meta itemprop="description" content="It took us about two weeks to migrate our GitHub code to Gitlab, and the biggest impact was on our product release pipeline, which needed to be adapted to Gitlab and some services on our intranet environment. Basically, we had to rewrite the entire product release pipeline, and it was exhausting 🥺. At the time, I thought migrating the code to Gitlab was purely backwards 😅, but after"><meta itemprop="datePublished" content="2021-09-18T11:08:02+08:00" />
<meta itemprop="dateModified" content="2021-09-18T11:08:02+08:00" />
<meta itemprop="wordCount" content="3159">
<meta itemprop="keywords" content="gitlab,python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="python-gitlab CLI Usage Notes"/>
<meta name="twitter:description" content="It took us about two weeks to migrate our GitHub code to Gitlab, and the biggest impact was on our product release pipeline, which needed to be adapted to Gitlab and some services on our intranet environment. Basically, we had to rewrite the entire product release pipeline, and it was exhausting 🥺. At the time, I thought migrating the code to Gitlab was purely backwards 😅, but after"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">python-gitlab CLI Usage Notes</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-18 11:08:02 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 3159 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#gitlab">Gitlab</a></li>
        <li><a href="#gitlab-workflow">Gitlab workflow</a>
          <ul>
            <li><a href="#pr">PR</a></li>
            <li><a href="#mr">MR</a></li>
          </ul>
        </li>
        <li><a href="#gitlab-api">Gitlab API</a></li>
        <li><a href="#python-gitlab-cli">python-gitlab CLI</a>
          <ul>
            <li><a href="#安装">安装</a></li>
            <li><a href="#configuration">Configuration</a></li>
            <li><a href="#basic-use">Basic Use</a></li>
            <li><a href="#project">project</a></li>
            <li><a href="#file">file</a></li>
            <li><a href="#mr-1">MR</a></li>
            <li><a href="#tag">Tag</a></li>
          </ul>
        </li>
        <li><a href="#lint-flow-line">Lint flow line</a></li>
        <li><a href="#other">Other</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>It took us about two weeks to migrate our GitHub code to Gitlab, and the biggest impact was on our product release pipeline, which needed to be adapted to Gitlab and some services on our intranet environment. Basically, we had to rewrite the entire product release pipeline, and it was exhausting 🥺. At the time, I thought migrating the code to Gitlab was purely backwards 😅, but after all the adaptations were done, I suddenly realized that Gitlab was really good!</p>
<p>Ultimately, the Gitlab network on the intranet is ten times better than GitHub. As we all know, GitHub&rsquo;s direct connection speed and stability is very poor in learning wall countries. That&rsquo;s why the GitHub pipeline was often disturbed by network jitter, sometimes fetching a repo for 10 or 20 minutes! After migrating to Gitlab, it&rsquo;s been a blast! It used to take at least 10 minutes to complete the pipeline, but now it takes less than 5 minutes to complete 😂.</p>
<p>So today I&rsquo;m going to write a blog about what I&rsquo;ve learned while tossing around Gitlab 👓.</p>
<h2 id="gitlab">Gitlab</h2>
<p>Documentation and tools for Gitlab used in the tossing process.</p>
<ul>
<li><a href="https://about.gitlab.com/topics/version-control/what-is-gitlab-workflow/">Gitlab workflow</a>: learn about Gitlab&rsquo;s workflow, which is different from GitHub&rsquo;s PR, in that Gitlab uses the MR approach.</li>
<li><a href="https://docs.gitlab.com/ee/api/README.html">Gitlab API</a>: the official documentation for the Gitlab API, which you can use with the following tools.</li>
<li><a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html">python-gitlab</a> API client: A Python implementation of the Gitlab API client, which you can use for specific needs tools, such as getting a file or directory in a repo based on a tag or branch.</li>
<li><a href="https://python-gitlab.readthedocs.io/">python-gitlab</a> CLI: based on the <a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html">python-gitlab</a> API client wrapped into a command-line tool that can be easily integrated into some pipeline scripts because it is a CLI tool.</li>
<li><a href="https://github.com/xanzy/go-gitlab">go-gitlab</a> API client: A Gitlab API client implemented in Golang. Since one of the phases of the release pipeline is to collect specific files and directories from other repo&rsquo;s based on a list, the tools used are written in golang. The tools are written in golang, and go-gitlab is used instead of python-gitlab to reduce the amount of code changes.</li>
</ul>
<h2 id="gitlab-workflow">Gitlab workflow</h2>
<h3 id="pr">PR</h3>
<p>On GitHub, we generally use PR to merge code, and the process is as follows.</p>
<ul>
<li>clone the Fork repository to the local repository</li>
<li>Create a new branch locally, make changes and commits based on the new branch, and push the new branch to the Fork repository</li>
<li>Launch a Pull Request to the target branch of the original repository based on the new branch in the Fork repository</li>
<li>@ Reviewer in the comments of the PR, requesting review changes</li>
<li>The reviewer receives the request email, reviews the code, and comments directly at the suggestion</li>
<li>The committer continues to commit changes based on the suggestions and responds to the comments</li>
<li>After the reviewer has no objections, @ admin in the comments of the PR, request to merge the code, the admin accepts the PR, and the code is merged into the master branch</li>
</ul>
<h3 id="mr">MR</h3>
<p>But when we got to Gitlab, we used MR to do the code merge, and the process was as follows.</p>
<ul>
<li>member Clone the original repository locally, create a new branch based on the branch you want to modify</li>
<li>local changes and commits, pushing the new branch to the original repository</li>
<li>Merge Request is launched in the original repository to the target protected branch based on the new branch.</li>
<li>Reviewers review code, administrators merge code</li>
</ul>
<p>In comparison, the MR and approach are more suitable for collaborative development within a team, and the PR approach is suitable for collaborative development of open source projects.</p>
<h2 id="gitlab-api">Gitlab API</h2>
<blockquote>
<p>The main GitLab API is a <a href="http://spec.openapis.org/oas/v3.0.3">REST</a> API. Because of this, the documentation in this section assumes that you’re familiar with REST concepts.</p>
</blockquote>
<p>Referring to the official document <a href="https://docs.gitlab.com/ee/api/api_resources.html">API resources</a>, we can see that there are three API groups, Projects, Groups, and Standalone.</p>
<ul>
<li>Projects: These are repo-related APIs, such as tag, commit, branch, MR, and Issue.</li>
<li>Groups: This is similar to Organizations on GitHub. Generally speaking, repo&rsquo;s in a company are organized by team, and repo&rsquo;s in the same team are placed under the same Groups in gitlab, rather than being stored as individuals.</li>
<li>Standalone: API resources other than Projects and Groups, such as user</li>
</ul>
<p>Most of the time, we use the Projects API to add, delete, and check repo&rsquo;s. After a brief introduction to the Gitlab API types, this article will introduce a few tools for using the Gitlab API. If you encounter any errors while using these tools, you can use the <a href="https://docs.gitlab.com/ee/api/README.html#status-codes">Status codes</a> API to return status codes to troubleshoot the problem.</p>
<h2 id="python-gitlab-cli">python-gitlab CLI</h2>
<p>This is a gitlab command-line tool wrapped with the <a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html">python-gitlab</a> API client, and you can use it to do most of the operations supported by the Gitlab API. Because many of the operations in the previous pipeline were accessed from GitHub, such as committing PRs, getting repo tags, viewing PR labels, etc., they were written in Jenkinsfile and called with various scripts and tools. If you switch to Gitlab, you&rsquo;ll need a tool to do the same thing. The python-gitlab CLI is a great tool for this, and it&rsquo;s even more convenient than the previous tool. I haven&rsquo;t seen anything like python-gitlab on GitHub so far. Anyway, for anyone who uses Gitlab and wants to automate some of the work you do with your repo, this CLI tool is highly recommended, and it can be easily integrated into your pipeline.</p>
<h3 id="安装">安装</h3>
<p>The python-gitlab CLI relies on Python 2.7 or 3.4+, so don&rsquo;t use Python 2.7 in 2021 😊. After installing python3 and pip3 locally, use the following command to install it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 在这里使用清华的 pypi 源来加速安装，毕竟是墙🧱国</span>
$ sudo pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple requests PyYAML python-gitlab
</code></pre></td></tr></table>
</div>
</div><p>Since most of the scenarios using this tool are executed in the slave pod created by Jenkins, it is also possible to build a docker image with the following <code>Dockerfile</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> debian:buster</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apt update <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> apt install -y --no-install-recommends <span class="se">\
</span><span class="se"></span>        git <span class="se">\
</span><span class="se"></span>        python3 <span class="se">\
</span><span class="se"></span>        python3-pip <span class="se">\
</span><span class="se"></span>        jq <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple requests PyYAML python-gitlab<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> python-gitlab.cfg /etc/python-gitlab.cfg<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="configuration">Configuration</h3>
<p>The Gitlab CLI tool requires a <code>python-gitlab.cfg</code> configuration file to connect to the Gitlab server and to complete some authentication, in the form of an <code>ini</code> file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="k">[global]</span>
<span class="na">default</span> <span class="o">=</span> <span class="s">gitlab.com</span>
<span class="na">ssl_verify</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">timeout</span> <span class="o">=</span> <span class="s">5</span>
<span class="na">per_page</span> <span class="o">=</span> <span class="s">100</span>
<span class="na">api_version</span> <span class="o">=</span> <span class="s">4</span>

<span class="k">[gitlab.com]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">https://gitlab.com</span>
<span class="na">private_token</span> <span class="o">=</span> <span class="s">xxxxxxxxx</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="global-connection-parameters">Global connection parameters</h4>
<table>
<thead>
<tr>
<th>Option</th>
<th>Possible values</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ssl_verify</td>
<td>True or False</td>
<td>Whether to enable SSL encryption authentication</td>
</tr>
<tr>
<td>timeout</td>
<td>Certificates</td>
<td>Connection timeout time</td>
</tr>
<tr>
<td>api_version</td>
<td>4</td>
<td>API version, the default is 4, refer to API V3 to API V4</td>
</tr>
<tr>
<td>per_page</td>
<td>1 ～ 100</td>
<td>The number of elements returned at a time is limited to 100 by Gitlab, and you can get all of them with the &ndash;all parameter</td>
</tr>
</tbody>
</table>
<h4 id="customizing-gitlab-server-parameters">Customizing GitLab server parameters</h4>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>url</td>
<td>GitLab server URL</td>
</tr>
<tr>
<td>private_token</td>
<td>Generate tokens by accessing -/profile/personal_access_tokens on the gitlab server</td>
</tr>
<tr>
<td>oauth_token</td>
<td></td>
</tr>
<tr>
<td>job_token</td>
<td></td>
</tr>
<tr>
<td>api_version</td>
<td>API version, the default is 4, or you can leave it undefined and use the global parameters</td>
</tr>
<tr>
<td>http_username</td>
<td>Gitlab username, which is not recommended for connecting to the Gitlab server</td>
</tr>
<tr>
<td>http_password</td>
<td>Gitlab password, which is not recommended for connecting to the Gitlab server</td>
</tr>
</tbody>
</table>
<p>Save the file in <code>~/.python-gitlab.cfg</code> or <code>/etc/python-gitlab.cfg</code>, or you can use the environment variable <code>PYTHON_GITLAB_CFG</code> or <code>-config-file</code> to execute the path to the configuration file, but to save yourself the trouble put it in <code>~/. python-gitlab.cfg</code>.</p>
<p>Once the configuration is done, you can use the <code>-gitlab current-user get</code> command to test if the connection is working, and if it returns the correct username, the configuration is successful.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab current-user get
username: muzi502
</code></pre></td></tr></table>
</div>
</div><h3 id="basic-use">Basic Use</h3>
<p>The gitlab command line tool is used to add, delete, and update various objects on the Gitlab server, such as user, project, file, repo, mr, tag, commit, and so on (get, list, create, delete, and update). The command line format used is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab &lt;option&gt; <span class="o">[</span>object<span class="o">]</span> <span class="o">[</span>action<span class="o">]</span> &lt;option&gt;
</code></pre></td></tr></table>
</div>
</div><p>In general, only 4 parameters are needed.</p>
<ul>
<li>The first argument is the one immediately following the gitlab command. It is the output and configuration argument for the gitlab command line, such as the <code>-o</code> argument specifies the format of the output; the <code>-f</code> argument stores the output to a file; and the <code>-g</code> argument enforces which Gitlab server to connect to.</li>
<li>The second parameter specifies the object you want to operate on, such as project-merge-request, project-tag, etc. There are a number of supported objects, which basically cover all of the objects supported by the Gitlab API, as follows.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -h
usage: gitlab <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--version<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-c CONFIG_FILE<span class="o">]</span> <span class="o">[</span>-g GITLAB<span class="o">]</span> <span class="o">[</span>-o <span class="o">{</span>json,legacy,yaml<span class="o">}]</span> <span class="o">[</span>-f FIELDS<span class="o">]</span>
<span class="o">{</span>application,application-appearance,application-settings,audit-event,broadcast-message,current-user,current-user-email,current-user-gp-gkey,current-user-key,current-user-status,deploy-key,deploy-token,dockerfile,event,feature,geo-node,gitignore,gitlabciyml,group,group-access-request,group-badge,group-board,group-board-list,group-cluster,group-custom-attribute,group-deploy-token,group-epic,group-epic-issue,group-epic-resource-label-event,group-export,group-import,group-issue,group-label,group-member,group-merge-request,group-milestone,group-notification-settings,group-package,group-project,group-runner,group-subgroup,group-variable,hook,issue,l-da-pgroup,license,merge-request,namespace,notification-settings,pages-domain,project,project-access-request,project-additional-statistics,project-approval,project-approval-rule,project-badge,project-board,project-board-list,project-branch,project-cluster,project-commit,project-commit-comment,project-commit-discussion,project-commit-discussion-note,project-commit-status,project-custom-attribute,project-deploy-token,project-deployment,project-environment,project-event,project-export,project-file,project-fork,project-hook,project-import,project-issue,project-issue-award-emoji,project-issue-discussion,project-issue-discussion-note,project-issue-link,project-issue-note,project-issue-note-award-emoji,project-issue-resource-label-event,project-issue-resource-milestone-event,project-issues-statistics,project-job,project-key,project-label,project-member,project-merge-request,project-merge-request-approval,project-merge-request-approval-rule,project-merge-request-award-emoji,project-merge-request-diff,project-merge-request-discussion,project-merge-request-discussion-note,project-merge-request-note,project-merge-request-note-award-emoji,project-merge-request-resource-label-event,project-merge-request-resource-milestone-event,project-milestone,project-note,project-notification-settings,project-package,project-pages-domain,project-pipeline,project-pipeline-bridge,project-pipeline-job,project-pipeline-schedule,project-pipeline-schedule-variable,project-pipeline-variable,project-protected-branch,project-protected-tag,project-push-rules,project-registry-repository,project-registry-tag,project-release,project-remote-mirror,project-runner,project-service,project-snippet,project-snippet-award-emoji,project-snippet-discussion,project-snippet-discussion-note,project-snippet-note,project-snippet-note-award-emoji,project-tag,project-trigger,project-user,project-variable,project-wiki,runner,runner-job,snippet,todo,user,user-activities,user-custom-attribute,user-email,user-event,user-gp-gkey,user-impersonation-token,user-key,user-membership,user-project,user-status,variable<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The third argument is the action argument, which specifies what kind of operation is to be performed on the object being operated on, and generally supports add, delete, change and check operations (get, list, create, update, delete)
$ gitlab project-tag
usage: gitlab project-tag [-h] {list,get,create,delete,set-release-description} &hellip;</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-tag
usage: gitlab project-tag <span class="o">[</span>-h<span class="o">]</span> <span class="o">{</span>list,get,create,delete,set-release-description<span class="o">}</span> ...
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The fourth parameter is the parameter on which the object + action depends, for example, specifying the project id</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-tag list
usage: gitlab project-tag list --project-id PROJECT_ID <span class="o">[</span>--page PAGE<span class="o">]</span> <span class="o">[</span>--per-page PER_PAGE<span class="o">]</span> <span class="o">[</span>--all<span class="o">]</span>
gitlab project-tag list: error: the following arguments are required: --project-id
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Project-ID: is the unique ID of the repo on gitlab, there are two types, one is in the form of <code>group/project</code>, where <code>/</code> should be translated to <code>%2F</code> like: <code>muzi502%2Fkubespray</code>; the other is in the form of numbers, which can be seen on the web page of the repo, the second one is recommended.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/18/b25bf12ff65f42b280e99e05d11a2ea1.png" alt=""></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 也可以使用gitlab 命令获取 repo 的 id</span>
$ gitlab project get --id muzi502%2Fkubespray
id: <span class="m">25099880</span>
path: kubespray
</code></pre></td></tr></table>
</div>
</div><ul>
<li>In the pipeline you can get the user&rsquo;s username and email based on the token, which can be used to configure the repo git information in the pipeline to avoid failing due to CLA.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">gitlab -o json current-user get <span class="p">|</span> jq <span class="s1">&#39;.id&#39;</span>
git config --global user.email <span class="k">$(</span>gitlab -o json current-user get <span class="p">|</span> jq -r <span class="s1">&#39;.email&#39;</span><span class="k">)</span>
git config --global user.name <span class="k">$(</span>gitlab -o json current-user get <span class="p">|</span> jq -r <span class="s1">&#39;.username&#39;</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="project">project</h3>
<ul>
<li>Get repo ssh url address</li>
</ul>
<p>Since the repo url for clone in the Jenkins pipeline uses token+ https, if you want to push code to the repo in the pipeline, you need to change it to ssh, and you can use the following method to get the ssh url of the repo based on the project id.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -o json  project get --id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> <span class="p">|</span> jq -r <span class="s1">&#39;.ssh_url_to_repo&#39;</span>
$ git remote remove origin
$ git remote add origin <span class="k">$(</span>gitlab -o json  project get --id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> <span class="p">|</span> jq -r <span class="s1">&#39;.ssh_url_to_repo&#39;</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="file">file</h3>
<p>For manipulation of files in the repo use project-file</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-file
usage: gitlab project-file <span class="o">[</span>-h<span class="o">]</span> <span class="o">{</span>get,create,update,delete,raw,blame<span class="o">}</span> ...
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Get the file, via the get operation of the <code>project-file</code> object</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -o json project-file get --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --file-path .gitignore --ref master  <span class="p">|</span> jq <span class="s1">&#39;.&#39;</span>
<span class="o">{</span>
  <span class="s2">&#34;file_name&#34;</span>: <span class="s2">&#34;.gitignore&#34;</span>,
  <span class="s2">&#34;file_path&#34;</span>: <span class="s2">&#34;.gitignore&#34;</span>,
  <span class="s2">&#34;size&#34;</span>: 1208,
  <span class="s2">&#34;encoding&#34;</span>: <span class="s2">&#34;base64&#34;</span>,
  <span class="s2">&#34;content_sha256&#34;</span>: <span class="s2">&#34;91f1d50ba3a4f79f96d9371afc70b389f75dfb2ac5190b8fb01051aa8679fd04&#34;</span>,
  <span class="s2">&#34;ref&#34;</span>: <span class="s2">&#34;master&#34;</span>,
  <span class="s2">&#34;blob_id&#34;</span>: <span class="s2">&#34;b09ca9d3b101034c7e34430177c1d64738df5fbb&#34;</span>,
  <span class="s2">&#34;commit_id&#34;</span>: <span class="s2">&#34;a9c97e5253c455546c2c7fdd794147eeb9b8ab7a&#34;</span>,
  <span class="s2">&#34;last_commit_id&#34;</span>: <span class="s2">&#34;4ffc106c58fc5865b6d72a52365e25b8c268d4d8&#34;</span>,
  <span class="s2">&#34;content&#34;</span>: <span class="s2">&#34;LnZhZ3JhbnQKKi5yZXRyeQoqKi92YWdyYW50X2Fuc2libGVfaW52ZW50b3J5CiouaW1sCnRlbXAKLmlkZWEKLnRveAouY2FjaGUKKi5iYWsKKi50ZnN0YXRlCioudGZzdGF0ZS5iYWNrdXAKLnRlcnJhZm9ybS8KY29udHJpYi90ZXJyYWZvcm0vYXdzL2NyZWRlbnRpYWxzLnRmdmFycwovc3NoLWJhc3Rpb24uY29uZgoqKi8qLnN3W3Bvbl0KKn4KdmFncmFudC8KcGx1Z2lucy9taXRvZ2VuCgojIEFuc2libGUgaW52ZW50b3J5CmludmVudG9yeS8qCiFpbnZlbnRvcnkvbG9jYWwKIWludmVudG9yeS9zYW1wbGUKaW52ZW50b3J5LyovYXJ0aWZhY3RzLwoKIyBCeXRlLWNvbXBpbGVkIC8gb3B0aW1pemVkIC8gRExMIGZpbGVzCl9fcHljYWNoZV9fLwoqLnB5W2NvZF0KKiRweS5jbGFzcwoKIyBEaXN0cmlidXRpb24gLyBwYWNrYWdpbmcKLlB5dGhvbgplbnYvCmJ1aWxkLwpjcmVkZW50aWFscy8KZGV2ZWxvcC1lZ2dzLwpkaXN0Lwpkb3dubG9hZHMvCmVnZ3MvCi5lZ2dzLwpwYXJ0cy8Kc2Rpc3QvCnZhci8KKi5lZ2ctaW5mby8KLmluc3RhbGxlZC5jZmcKKi5lZ2cKCiMgUHlJbnN0YWxsZXIKIyAgVXN1YWxseSB0aGVzZSBmaWxlcyBhcmUgd3JpdHRlbiBieSBhIHB5dGhvbiBzY3JpcHQgZnJvbSBhIHRlbXBsYXRlCiMgIGJlZm9yZSBQeUluc3RhbGxlciBidWlsZHMgdGhlIGV4ZSwgc28gYXMgdG8gaW5qZWN0IGRhdGUvb3RoZXIgaW5mb3MgaW50byBpdC4KKi5tYW5pZmVzdAoqLnNwZWMKCiMgSW5zdGFsbGVyIGxvZ3MKcGlwLWxvZy50eHQKcGlwLWRlbGV0ZS10aGlzLWRpcmVjdG9yeS50eHQKCiMgVW5pdCB0ZXN0IC8gY292ZXJhZ2UgcmVwb3J0cwpodG1sY292LwoudG94LwouY292ZXJhZ2UKLmNvdmVyYWdlLioKLmNhY2hlCm5vc2V0ZXN0cy54bWwKY292ZXJhZ2UueG1sCiosY292ZXIKLmh5cG90aGVzaXMvCgojIFRyYW5zbGF0aW9ucwoqLm1vCioucG90CgojIERqYW5nbyBzdHVmZjoKKi5sb2cKbG9jYWxfc2V0dGluZ3MucHkKCiMgRmxhc2sgc3R1ZmY6Cmluc3RhbmNlLwoud2ViYXNzZXRzLWNhY2hlCgojIFNjcmFweSBzdHVmZjoKLnNjcmFweQoKIyBTcGhpbnggZG9jdW1lbnRhdGlvbgpkb2NzL19idWlsZC8KCiMgUHlCdWlsZGVyCnRhcmdldC8KCiMgSVB5dGhvbiBOb3RlYm9vawouaXB5bmJfY2hlY2twb2ludHMKCiMgcHllbnYKLnB5dGhvbi12ZXJzaW9uCgojIGRvdGVudgouZW52CgojIHZpcnR1YWxlbnYKdmVudi8KRU5WLwo=&#34;</span>
<span class="o">}</span>

<span class="c1"># The content of the file is base64 encoded and needs to be decoded using base64 to get the original content.</span>
$ gitlab -g gitlab -o json project-file get --project-id <span class="m">25099880</span> --file-path .gitignore --ref master  <span class="p">|</span> jq -r <span class="s1">&#39;.content&#39;</span> <span class="p">|</span> base64 -d
.vagrant
*.retry
**/vagrant_ansible_inventory
*.iml
temp
.idea
.tox
…………
</code></pre></td></tr></table>
</div>
</div><ul>
<li>The raw method of project-file can get the raw content of the file without base64 decoding</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-file get --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --file-path .gitignore --ref master
</code></pre></td></tr></table>
</div>
</div><ul>
<li>To create a file, add, delete, or change it, you need to commit it, so you need to specify the branch you want to operate on and the commit-message. In addition, if the file to be operated is a master branch to get other protected branches, make sure the current user has write permission, otherwise the following error will be prompted.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">gitlab project-file update
Impossible to update object <span class="o">(</span>400: You are not allowed to push into this branch<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>There was a set of CIs on GitHub that didn&rsquo;t work for Gitlab, so you need to create CI flowlines for all branches to check if the code is in spec, and you can create files to all branches in bulk by doing the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ID</span><span class="o">=</span><span class="m">123456</span>
<span class="nv">BRANCHS</span><span class="o">=</span><span class="k">$(</span>gitlab -o json project-branch list --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --all <span class="p">|</span> jq -r <span class="s2">&#34;.[].name&#34;</span><span class="k">)</span>
<span class="k">for</span> branch in <span class="si">${</span><span class="nv">BRANCHS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
	gitlab project-file create --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --file-path .gitlab-ci.yml --branch <span class="si">${</span><span class="nv">branch</span><span class="si">}</span> --content @.gitlab-ci.yml --commit-message <span class="s2">&#34;feat(gitlab-ci): add gitlab-ci.yml for ci&#34;</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Update files</li>
</ul>
<p>For example, bulk update <code>github.com</code> to <code>gitlab.com</code> in the <code>Makefile</code> of all branches</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ID</span><span class="o">=</span><span class="m">123456</span>
<span class="nv">BRANCHS</span><span class="o">=</span><span class="k">$(</span>gitlab -o json project-branch list --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --all <span class="p">|</span> jq -r <span class="s2">&#34;.[].name&#34;</span><span class="k">)</span>
<span class="k">for</span> branch in <span class="si">${</span><span class="nv">BRANCHS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    rm -f Makefile Makefile-
    gitlab project-file raw --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --file-path Makefile --ref <span class="si">${</span><span class="nv">branch</span><span class="si">}</span> &gt; Makefile
    sed -i- <span class="s2">&#34;s|github.com/muzi502|gitlab.com/muzi502&#34;</span> Makefile
    gitlab project-file update --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --file-path Makefile --branch <span class="si">${</span><span class="nv">branch</span><span class="si">}</span> --content @Makefile <span class="se">\
</span><span class="se"></span>    --commit-message <span class="s2">&#34;chore(Makefile): update repo url in Makefile for migrate gitlab&#34;</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Delete files</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-file delete --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --file-path .gitignore --ref master <span class="se">\
</span><span class="se"></span>--commit-message <span class="s2">&#34;test delete file&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="mr-1">MR</h3>
<ul>
<li>Create MR, specifying the source branch and target branch and the title of the mr. It is better to add -o json parameter in front to get the iid of the mr, which can be used to add, delete and check the mr.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -o json project-merge-request create --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --source-branch --target-branch <span class="si">${</span><span class="nv">BASE_BRANCH</span><span class="si">}</span> --title <span class="s2">&#34;</span><span class="si">${</span><span class="nv">MR_TITLE</span><span class="si">}</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>The -o json parameter returns information about this mr, where <code>iid</code> is the unique identifier of this mr in this repo</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -g gitlab -o json project-merge-request create --project-id <span class="m">25099880</span> --source-branch release-2.14 --target-branch  master --title <span class="s2">&#34;mr create test&#34;</span>
<span class="o">{</span>
  <span class="s2">&#34;id&#34;</span>: 92872102,
  <span class="s2">&#34;iid&#34;</span>: 1,
  <span class="s2">&#34;project_id&#34;</span>: 25099880,
  <span class="s2">&#34;title&#34;</span>: <span class="s2">&#34;mr create test&#34;</span>,
  <span class="s2">&#34;description&#34;</span>: null,
  <span class="s2">&#34;state&#34;</span>: <span class="s2">&#34;opened&#34;</span>,
  <span class="s2">&#34;created_at&#34;</span>: <span class="s2">&#34;2021-03-21T12:42:52.893Z&#34;</span>,
  <span class="s2">&#34;updated_at&#34;</span>: <span class="s2">&#34;2021-03-21T12:42:52.893Z&#34;</span>,
  <span class="s2">&#34;merged_by&#34;</span>: null,
  <span class="s2">&#34;merged_at&#34;</span>: null,
  <span class="s2">&#34;closed_by&#34;</span>: null,
  <span class="s2">&#34;closed_at&#34;</span>: null,
  <span class="s2">&#34;target_branch&#34;</span>: <span class="s2">&#34;master&#34;</span>,
  <span class="s2">&#34;source_branch&#34;</span>: <span class="s2">&#34;release-2.14&#34;</span>,
  <span class="s2">&#34;user_notes_count&#34;</span>: 0,
  <span class="s2">&#34;upvotes&#34;</span>: 0,
  <span class="s2">&#34;downvotes&#34;</span>: 0,
  <span class="s2">&#34;author&#34;</span>: <span class="o">{</span>
    <span class="s2">&#34;id&#34;</span>: 5599205,
    <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;muzi502&#34;</span>,
    <span class="s2">&#34;username&#34;</span>: <span class="s2">&#34;muzi502&#34;</span>,
    <span class="s2">&#34;state&#34;</span>: <span class="s2">&#34;active&#34;</span>,
    <span class="s2">&#34;avatar_url&#34;</span>: <span class="s2">&#34;https://secure.gravatar.com/avatar/f91578ffea9a538eedd8fbaf3007289b?s=80&amp;d=identicon&#34;</span>,
    <span class="s2">&#34;web_url&#34;</span>: <span class="s2">&#34;https://gitlab.com/muzi502&#34;</span>
  <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Merge MR</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-merge-request merge --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --iid @mr_iid
</code></pre></td></tr></table>
</div>
</div><ul>
<li>View MR Status</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -o json project-merge-request get --project-id <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --iid @mr_iid <span class="p">|</span> jq -r <span class="s2">&#34;.state&#34;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Integrating in Jenkinsfile to create MRs, merge MRs, and check MRs</li>
</ul>
<p>When you call it, you only need to pass the parameters SOURCE_BRANCH, TARGET_BRANCH, MR_TITLE.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="k">def</span> <span class="nf">makeMR</span><span class="p">(</span><span class="n">SOURCE_BRANCH</span><span class="p">,</span> <span class="n">TARGET_BRANCH</span><span class="p">,</span> <span class="n">MR_TITLE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">container</span><span class="p">(</span><span class="s2">&#34;debian&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sh</span> <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        gitlab -o json project-merge-request create --project-id $</span><span class="si">{PROJECT_ID}</span><span class="s2">  --title </span><span class="se">\&#34;</span><span class="s2">$</span><span class="si">{MR_TITLE}</span><span class="se">\&#34;</span><span class="s2"> </span><span class="se">\
</span><span class="se"></span><span class="s2">        --source-branch $</span><span class="si">{SOURCE_BRANCH}</span><span class="s2"> --target-branch $</span><span class="si">{TARGET_BRANCH}</span><span class="s2"> &gt; mr_info.json
</span><span class="s2">
</span><span class="s2">        jq -r &#39;.iid&#39; mr_info.json &gt; mr_iid
</span><span class="s2">        jq -r &#39;.web_url&#39; mr_info.json &gt; mr_url
</span><span class="s2">        &#34;&#34;&#34;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">checkMR</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">container</span><span class="p">(</span><span class="s2">&#34;debian&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retry</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sh</span> <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        if [ ! -s mr_iid ]; then exit 0; else sleep 60s; fi
</span><span class="s2">        gitlab -o json project-merge-request get --project-id $</span><span class="si">{PROJECT_ID}</span><span class="s2"> --iid @mr_iid | jq -r &#34;.labels[]&#34; | grep &#39;approve&#39;
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">mergeMR</span><span class="p">(){</span>
    <span class="n">container</span><span class="p">(</span><span class="s2">&#34;debian&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">retry</span><span class="p">(</span><span class="mi">10</span><span class="p">){</span>
        <span class="n">sh</span> <span class="s2">&#34;&#34;&#34;
</span><span class="s2">        if [ ! -s mr_iid ]; then exit 0; else sleep 60s; fi
</span><span class="s2">        if gitlab project-merge-request merge --project-id $</span><span class="si">{PROJECT_ID}</span><span class="s2"> --iid @mr_iid; then sleep 10s; fi
</span><span class="s2">        gitlab -o json project-merge-request get --project-id $</span><span class="si">{PROJECT_ID}</span><span class="s2"> --iid @mr_iid | jq -r &#34;.state&#34; | grep &#39;merged&#39;
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="tag">Tag</h3>
<ul>
<li>List repo tags</li>
</ul>
<p>We recommend using the git tag method to get the repo tag, because the Gitlab API is limited to 100 values per request, so you can add the <code>-all</code> argument to return all the values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab -o json project-tag list --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> <span class="p">|</span> jq -r <span class="s1">&#39;.[].name&#39;</span>
$ gitlab -o json project-tag list --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --all <span class="p">|</span> jq -r <span class="s1">&#39;.[].name&#39;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Create tag</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-tag create --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --tag-name v1.0.0-rc.2 --ref master
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Delete tag</li>
</ul>
<p>The upstream repo tag can only be deleted from Gitlab, but not from the local repo, so you can delete the Gitlab repo tag with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ gitlab project-tag delete --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --tag-name v1.0.0-rc.2
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Create a protected repo tag</li>
</ul>
<p>Since our pipeline tasks rely on repo tags to do versioning, we need to protect each repo tag, but there are special cases where we need to overwrite repo tags, so there is no suitable method for protected repo tags yet, so we have to create them manually first and then delete them when we need to. You can use the following command to create protected repo tags in bulk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">$ git tag <span class="p">|</span> xargs -L1 -I <span class="o">{}</span> gitlab project-protected-tag create --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --name <span class="o">{}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="lint-flow-line">Lint flow line</h2>
<p>After migrating to Gitlab, I couldn&rsquo;t use my old pipeline on Gitlab&rsquo;s intranet, so I used Gitlab&rsquo;s own CI to reduce maintenance costs. The repo I maintain only uses Gitlab CI to do a few lint checks, so the CI configuration is very simple. For example, the CI configuration for kubespray is</p>
<ul>
<li><code>.gitlab-ci.yml</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">lint</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;quay.io/kubespray/kubespray:v2.15.0&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">chmod -R o-w .</span><span class="w">
</span><span class="w">    </span>- <span class="l">make lint</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">shared</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Add a <code>.gitlab-ci.yml</code> file to all branches using the gitlab CLI tool</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">ID</span><span class="o">=</span><span class="m">123456</span>
<span class="nv">BRANCHS</span><span class="o">=</span><span class="k">$(</span>gitlab -o json project-branch list --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --all <span class="p">|</span> jq -r <span class="s2">&#34;.[].name&#34;</span><span class="k">)</span>
<span class="k">for</span> branch in <span class="si">${</span><span class="nv">BRANCHS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
	gitlab project-file create --project-id <span class="si">${</span><span class="nv">ID</span><span class="si">}</span> --file-path .gitlab-ci.yml --branch <span class="si">${</span><span class="nv">branch</span><span class="si">}</span> --content @.gitlab-ci.yml --commit-message <span class="s2">&#34;feat(gitlab-ci): add gitlab-ci.yml for ci&#34;</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="other">Other</h2>
<ul>
<li>repo migration</li>
</ul>
<p>Since Gitlab doesn&rsquo;t support importing git URLs internally, you have to manually clone your GitHub repo locally and then push it to Gitlab. If you use git clone, you will only have one master branch locally, so you have to track all the branches of the repo on GitHub and then push it to Gitlab.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 使用 git clone 下来的 repo 默认为 master 分支</span>
$ git clone git@gitlab.com/muzi502/kubespray.git
<span class="c1"># track 出 origin 上的所有分支</span>
$ git branch -r <span class="p">|</span> grep -v <span class="s1">&#39;\-&gt;&#39;</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> remote<span class="p">;</span> <span class="k">do</span> git branch --track <span class="s2">&#34;</span><span class="si">${</span><span class="nv">remote</span><span class="p">#origin/</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$remote</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">done</span>
$ git fetch --all
$ git pull --all
$ git remote remove origin
$ git remote add origin git@gitlab/gitlab502/kubespray.git
$ git push origin --all
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/gitlab/">gitlab</a>
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/mysql-paging-sorting-data-duplicates/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue)</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/microsoft-announce-win11-dont-support-most-vm/">
            <span class="next-text nav-default">Microsoft confirms Windows 11 will not support most virtual machines</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
