<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue) - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="MySQL Version: 5.7.18
Problem Assuming that the field category is not indexed and has duplicate values, the combination of order by category and limit will not work as expected.
Scene Reproduction Table structure (reproduce the problem, two fields are enough ~)
1  Tablestructure(reproducetheproblem,twofieldsareenough~)  Sort all data by the category field: select * from ratings order by category ;
   id category     1 1   5 1   10 1   3 2   4 2   6 2   9 2   2 3   7 3   8 3    When we want to paginate the first 5 items use select * from ratings order by category limit 5 ;" /><meta name="keywords" content="mysql" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/mysql-paging-sorting-data-duplicates/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue)" />
<meta property="og:description" content="MySQL Version: 5.7.18
Problem Assuming that the field category is not indexed and has duplicate values, the combination of order by category and limit will not work as expected.
Scene Reproduction Table structure (reproduce the problem, two fields are enough ~)
1  Tablestructure(reproducetheproblem,twofieldsareenough~)  Sort all data by the category field: select * from ratings order by category ;
   id category     1 1   5 1   10 1   3 2   4 2   6 2   9 2   2 3   7 3   8 3    When we want to paginate the first 5 items use select * from ratings order by category limit 5 ;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/mysql-paging-sorting-data-duplicates/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-19T16:01:59+08:00" />
<meta property="article:modified_time" content="2021-09-19T16:01:59+08:00" />

<meta itemprop="name" content="MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue)">
<meta itemprop="description" content="MySQL Version: 5.7.18
Problem Assuming that the field category is not indexed and has duplicate values, the combination of order by category and limit will not work as expected.
Scene Reproduction Table structure (reproduce the problem, two fields are enough ~)
1  Tablestructure(reproducetheproblem,twofieldsareenough~)  Sort all data by the category field: select * from ratings order by category ;
   id category     1 1   5 1   10 1   3 2   4 2   6 2   9 2   2 3   7 3   8 3    When we want to paginate the first 5 items use select * from ratings order by category limit 5 ;"><meta itemprop="datePublished" content="2021-09-19T16:01:59+08:00" />
<meta itemprop="dateModified" content="2021-09-19T16:01:59+08:00" />
<meta itemprop="wordCount" content="1329">
<meta itemprop="keywords" content="mysql," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue)"/>
<meta name="twitter:description" content="MySQL Version: 5.7.18
Problem Assuming that the field category is not indexed and has duplicate values, the combination of order by category and limit will not work as expected.
Scene Reproduction Table structure (reproduce the problem, two fields are enough ~)
1  Tablestructure(reproducetheproblem,twofieldsareenough~)  Sort all data by the category field: select * from ratings order by category ;
   id category     1 1   5 1   10 1   3 2   4 2   6 2   9 2   2 3   7 3   8 3    When we want to paginate the first 5 items use select * from ratings order by category limit 5 ;"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">MySQL Paging Sorting with Data Duplication Problem (MySQL Priority Queue)</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-19 16:01:59 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            <a href="/categories/database/"> database </a>
            </div>
          <span class="more-meta"> 1329 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#problem">Problem</a></li>
        <li><a href="#scene-reproduction">Scene Reproduction</a></li>
        <li><a href="#finding-the-optimal-solution">Finding the optimal solution</a></li>
        <li><a href="#mysqls-order-by-logic">MySQL&rsquo;s ORDER BY Logic</a></li>
        <li><a href="#priority-queue">priority queue</a></li>
        <li><a href="#why-indexing-is-a-suboptimal-solution">Why indexing is a suboptimal solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>MySQL Version: 5.7.18</p>
<h2 id="problem">Problem</h2>
<p>Assuming that the field <code>category</code> is not indexed and has duplicate values, the combination of <code>order by category</code> and <code>limit</code> will not work as expected.</p>
<h2 id="scene-reproduction">Scene Reproduction</h2>
<p>Table structure (reproduce the problem, two fields are enough ~)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">Table</span><span class="w"> </span><span class="k">structure</span><span class="w"> </span><span class="p">(</span><span class="n">reproduce</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">problem</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">enough</span><span class="w"> </span><span class="o">~</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Sort all data by the <code>category</code> field: <code>select * from ratings order by category</code> ;</p>
<table>
<thead>
<tr>
<th>id</th>
<th>category</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>10</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>2</td>
</tr>
<tr>
<td>9</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>7</td>
<td>3</td>
</tr>
<tr>
<td>8</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>When we want to paginate the first 5 items use <code>select * from ratings order by category limit 5</code> ;</p>
<p>The expected order of <code>ID</code> is <code>1 5 10 3 4</code>.</p>
<p>But the actual result is as follows.</p>
<table>
<thead>
<tr>
<th>id</th>
<th>category</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>10</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Maybe some friends have encountered this problem, through the search engine to solve a little, have you ever thought, you find the solution is the optimal solution? How did others arrive at this solution? <code>MySQL</code> Why would they do this, is it related to the version?</p>
<p>First throw the conclusion.</p>
<ul>
<li>The optimal solution is to add a sort field with a unique column value after it, such as: <code>order by category,id</code></li>
<li>Why does MySQL do this? The answer is for speed! (This optimization is available in <code>MySQL 5.6</code> and later)</li>
<li>The suboptimal solution is to index the <code>category</code> after <code>order by</code> (why is it suboptimal?). You will have the answer after reading this article)</li>
</ul>
<h2 id="finding-the-optimal-solution">Finding the optimal solution</h2>
<p>The scenario is described in the <code>MySQL</code> documentation <a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html">8.2.1.19 LIMIT Query Optimization</a> as follows.</p>
<blockquote>
<p>If multiple rows have identical values in the <code>ORDER BY</code> columns, the server is free to return those rows in any order, and may do so differently depending on the overall execution plan. In other words, the sort order of those rows is nondeterministic with respect to the nonordered columns.</p>
<p>One factor that affects the execution plan is <code>LIMIT</code> , so an <code>ORDER BY</code> query with and without <code>LIMIT</code> may return rows in different orders.</p>
</blockquote>
<p>To summarize, when there are duplicate field values in the <code>ORDER BY</code> column, the order of the data returned by the <code>ORDER BY</code> statement will be different due to the presence of <code>LIMIT</code>.</p>
<p>This is the default <code>MySQL</code> optimization for this scenario, but if you need to ensure that the order is consistent with or without <code>LIMIT</code>, there is an official way to do this.</p>
<blockquote>
<p>If it is important to ensure the same row order with and without <code>LIMIT</code> , include additional columns in the <code>ORDER BY</code> clause to make the order deterministic.</p>
</blockquote>
<p>This is where an additional sort field (such as an <code>ID</code> field) is added after <code>ORDER BY</code>.</p>
<p>The above description first appeared in the <code>MySQL 5.6</code> documentation, and this optimization for <code>ORDER BY LIMIT</code> has been introduced since this version.</p>
<p>Well, for the scenario in the article, we just need <code>select * from ratings order by category,id;</code> to solve it.</p>
<p>So the question is, why did <code>MySQL</code> make such a seemingly <code>buggy</code> optimization?</p>
<h2 id="mysqls-order-by-logic">MySQL&rsquo;s ORDER BY Logic</h2>
<p><code>ORDER BY</code> is the sort.</p>
<p>Do an <code>explain select * from ratings order by category limit 5</code> ;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span><span class="w">           </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w">  </span><span class="n">select_type</span><span class="p">:</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">
</span><span class="w">        </span><span class="k">table</span><span class="p">:</span><span class="w"> </span><span class="n">ratings</span><span class="w">
</span><span class="w">   </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">         </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span><span class="w"></span><span class="n">possible_keys</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">          </span><span class="k">key</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">      </span><span class="n">key_len</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">          </span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span><span class="w">         </span><span class="k">rows</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span><span class="w">     </span><span class="n">filtered</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w">
</span><span class="w">        </span><span class="n">Extra</span><span class="p">:</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">filesort</span><span class="w">
</span><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can see that <code>Extra: Using filesort</code> indicates that sorting is required.</p>
<p>Under normal circumstances, <code>MySQL</code> will have both in-memory and external sorting.</p>
<p>If the amount of data to be sorted is less than the <code>sort buffer size</code>, the sort is done in memory ( <code>quick sort</code>)</p>
<p>If the amount of data to be sorted is larger than the <code>sort buffer size</code>, the sort is done externally using a temporary file ( <code>combine sort</code>)</p>
<p>Obviously, these two kinds of sorting are to sort all the results, and reasonably, regardless of whether there is <code>LIMIT</code> or not, the number of items needed is taken from the sorted results in order, and whether there is <code>LIMIT</code> or not will not affect the order of the returned results.</p>
<p>However, <code>MySQL 5.6</code> has a small optimization for <code>ORDER BY LIMIT</code> (<strong>when the sorted field is not indexed and the column value is not unique</strong>): the optimizer uses <code>priority queue</code> when it encounters an <code>ORDER BY LIMIT</code> statement.</p>
<p>The optimization is described by the following pseudo-code in <code>filesort.cc</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">while</span><span class="w"> </span><span class="p">(</span><span class="n">get_next_sortkey</span><span class="p">())</span><span class="w">
</span><span class="w">   </span><span class="err">{</span><span class="w">
</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">using</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="n">queue</span><span class="p">)</span><span class="w">
</span><span class="w">       </span><span class="n">push</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">queue</span><span class="w">
</span><span class="w">     </span><span class="k">else</span><span class="w">
</span><span class="w">     </span><span class="err">{</span><span class="w">
</span><span class="w">       </span><span class="n">try</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w">
</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="k">free</span><span class="w"> </span><span class="k">space</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w">
</span><span class="w">       </span><span class="err">{</span><span class="w">
</span><span class="w">         </span><span class="k">do</span><span class="w"> </span><span class="err">{</span><span class="w">
</span><span class="w">           </span><span class="k">allocate</span><span class="w"> </span><span class="k">new</span><span class="p">,</span><span class="w"> </span><span class="n">larger</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w">
</span><span class="w">           </span><span class="n">retry</span><span class="w"> </span><span class="n">putting</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w">
</span><span class="w">         </span><span class="err">}</span><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="n">fits</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="k">space</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w">
</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="k">space</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w">
</span><span class="w">         </span><span class="err">{</span><span class="w">
</span><span class="w">           </span><span class="n">sort</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="n">pointers</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="w"> </span><span class="n">buffers</span><span class="p">);</span><span class="w">
</span><span class="w">           </span><span class="n">dump</span><span class="w"> </span><span class="n">sorted</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;tempfile&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">           </span><span class="n">dump</span><span class="w"> </span><span class="n">Merge_chunk</span><span class="w"> </span><span class="n">describing</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="k">location</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="s1">&#39;chunk_file&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">         </span><span class="err">}</span><span class="w">
</span><span class="w">       </span><span class="err">}</span><span class="w">
</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">key</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">packed</span><span class="p">)</span><span class="w">
</span><span class="w">         </span><span class="n">tell</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">used</span><span class="p">;</span><span class="w">
</span><span class="w">     </span><span class="err">}</span><span class="w">
</span><span class="w">   </span><span class="err">}</span><span class="w">
</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="k">some</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dumped</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">once</span><span class="p">)</span><span class="w">
</span><span class="w">     </span><span class="n">sort</span><span class="o">-</span><span class="n">dump</span><span class="o">-</span><span class="n">dump</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">above</span><span class="p">;</span><span class="w">
</span><span class="w">   </span><span class="k">else</span><span class="w">
</span><span class="w">     </span><span class="n">don</span><span class="s1">&#39;t sort, leave sort buffer to be sorted by caller.
</span></code></pre></td></tr></table>
</div>
</div><p>The optimization logic is described in <a href="https://dev.mysql.com/worklog/task/?id=1393">WL#1393: Optimizing filesort with small limit</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">Many</span><span class="w"> </span><span class="n">web</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">do</span><span class="w">
</span><span class="w"></span><span class="s2">&#34;SELECT ... ORDER BY non_index_column LIMIT X&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">When</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="k">is</span><span class="w"> </span><span class="n">smaller</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">sort_buff_size</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">use</span><span class="w">
</span><span class="w"></span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">algoritm</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">speed</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sort</span><span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">-</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">hold</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="w"> </span><span class="n">keys</span><span class="p">.</span><span class="w">
</span><span class="w"></span><span class="o">-</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="p">(</span><span class="k">last</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">queue</span><span class="w">
</span><span class="w"></span><span class="o">-</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">queue</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">algoritm</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">works</span><span class="w"> </span><span class="k">as</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>The result of the optimization is documented in the <code>WorkLog</code>: <code>10 to 20 times faster than a quicksort</code> (for those interested, go read the original article).</p>
<p>So, it&rsquo;s all about speed!</p>
<p><code>MySQL</code> thinks this scenario is a <code>TOP N</code> problem, which can be solved by using <code>priority queue</code>.</p>
<h2 id="priority-queue">priority queue</h2>
<p><code>priority queue</code> is actually a heap, <code>Java</code> has <code>java.util.PriorityQueue</code> class, the essence of which is <code>heap</code> this data structure.</p>
<p>A brief explanation of what a heap is.</p>
<blockquote>
<p>A heap is a complete binary tree.</p>
<p>Each node in the heap must have a value greater than or equal to (big top heap) or less than or equal to (little top heap) the value of each node in its subtree.</p>
</blockquote>
<p>If <code>MySQL</code> uses merge or fast-ranking, you need to sort all the data and then take the first few entries of <code>LIMIT</code>, and the remaining sorted data will be wasted.</p>
<p>If you use <code>priority queue</code>, you can maintain a heap based on the number of <code>LIMIT</code> items, and you only need to go through all the data in this heap to get the result.</p>
<p>You can verify that <code>MySQL</code> is using <code>priority queue</code> by using the following statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SET</span><span class="w"> </span><span class="n">optimizer_trace</span><span class="o">=</span><span class="s1">&#39;enabled=on&#39;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">ratings</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">category</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">information_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">OPTIMIZER_TRACE</span><span class="o">`</span><span class="err">\</span><span class="k">G</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="w"> </span><span class="s2">&#34;filesort_priority_queue_optimization&#34;</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w">
</span><span class="w">              </span><span class="s2">&#34;limit&#34;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
</span><span class="w">              </span><span class="s2">&#34;chosen&#34;</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="w">
</span><span class="w">            </span><span class="err">}</span><span class="p">,</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>You can see that <code>filesort_priority_queue_optimization.chosen = true</code>.</p>
<p>Here is a flowchart to restore the execution logic of the <code>priority queue</code> (using <code>LIMIT 5</code> as an example):</p>
<p>tip: the small top heap in the diagram is sorted by the size of the <code>category</code> value</p>
<ol>
<li>
<p>Take the first five data items to form a small top stack.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/19/a4f076aa7ed845ef9d66c487a936c8af.png" alt=""></p>
</li>
<li>
<p>Take the next row of data (6,2) and find that 2 is smaller than the largest <code>category</code> 3 in the current heap, so delete (2,3) from the heap and add (6,2) to the heap.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/19/7cba23cc412e4f4c9f4e0ac3363b6202.png" alt=""></p>
</li>
<li>
<p>Repeat step 2 until all the data that meet the query criteria have been compared into the heap, and the final data in the heap is as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/19/0e5349a145954cc7967a1a7a5205436d.png" alt=""></p>
</li>
</ol>
<p>The above is the process of finding the smallest 5 rows of <code>category</code> data by <code>priority queue</code>.</p>
<p>Finally, we can get the result by taking it out of the heap and putting the last element into the top of the heap each time after the smallest element is taken out, and re-stacking it according to the small top heap.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/19/c98b60fde50e429c8971a9bc44f72882.png" alt=""></p>
<p>As you can see, this result is consistent with the output of <code>select * from ratings order by category limit 5;</code></p>
<h2 id="why-indexing-is-a-suboptimal-solution">Why indexing is a suboptimal solution</h2>
<p>Obviously, according to the logic of <code>ORDER BY</code>, adding indexes to sorted fields directly can also eliminate the in-memory sorting step, thus solving the problem.</p>
<p>But indexing is not a silver bullet, and the extra <code>category</code> index will increase the maintenance cost of the table. If there is no obvious business need to add indexes simply to bypass the optimization of this <code>priority queue</code>, it is not worth the loss.</p>
<p>Especially when the table data volume is very large, the volume of indexes can be substantial. Moreover, for the scenario in the article, <code>category</code> as a category field, the duplication rate will be relatively high, even if there is a business <code>SQL</code> query by category, <code>MySQL</code> will not necessarily pick this index.</p>
<p>To sum up, I think <code>order by category,id</code> is the optimal solution for this scenario.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/mysql/">mysql</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/navicat-database-account-password-decryption/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Navicat Premium Database Account Password Decryption</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/gitlab-cli/">
            <span class="next-text nav-default">python-gitlab CLI Usage Notes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
