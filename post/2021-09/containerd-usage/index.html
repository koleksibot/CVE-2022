<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Understanding the Container Runtime Containerd in one article - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Before learning Containerd we need to do a brief review of Docker&amp;rsquo;s development history, because it involves a bit more components in practice, there are many we will often hear, but it is not clear what these components are really for, such as libcontainer, runc, containerd, CRI, OCI and so on. Docker Since Docker 1.11, Docker containers are not simply started by Docker Daemon, but by integrating containerd, runc and" /><meta name="keywords" content="docker, Containerd" />






<meta name="generator" content="Hugo 0.92.2 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/containerd-usage/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Understanding the Container Runtime Containerd in one article" />
<meta property="og:description" content="Before learning Containerd we need to do a brief review of Docker&rsquo;s development history, because it involves a bit more components in practice, there are many we will often hear, but it is not clear what these components are really for, such as libcontainer, runc, containerd, CRI, OCI and so on. Docker Since Docker 1.11, Docker containers are not simply started by Docker Daemon, but by integrating containerd, runc and" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/containerd-usage/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-27T14:38:27+08:00" />
<meta property="article:modified_time" content="2021-09-27T14:38:27+08:00" />

<meta itemprop="name" content="Understanding the Container Runtime Containerd in one article">
<meta itemprop="description" content="Before learning Containerd we need to do a brief review of Docker&rsquo;s development history, because it involves a bit more components in practice, there are many we will often hear, but it is not clear what these components are really for, such as libcontainer, runc, containerd, CRI, OCI and so on. Docker Since Docker 1.11, Docker containers are not simply started by Docker Daemon, but by integrating containerd, runc and"><meta itemprop="datePublished" content="2021-09-27T14:38:27+08:00" />
<meta itemprop="dateModified" content="2021-09-27T14:38:27+08:00" />
<meta itemprop="wordCount" content="5587">
<meta itemprop="keywords" content="docker,k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Understanding the Container Runtime Containerd in one article"/>
<meta name="twitter:description" content="Before learning Containerd we need to do a brief review of Docker&rsquo;s development history, because it involves a bit more components in practice, there are many we will often hear, but it is not clear what these components are really for, such as libcontainer, runc, containerd, CRI, OCI and so on. Docker Since Docker 1.11, Docker containers are not simply started by Docker Daemon, but by integrating containerd, runc and"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SoByte</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SoByte</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Understanding the Container Runtime Containerd in one article</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-27 14:38:27 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 5587 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#docker">Docker</a></li>
        <li><a href="#cri">CRI</a></li>
        <li><a href="#containerd">Containerd</a>
          <ul>
            <li><a href="#architecture">Architecture</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#configuration">Configuration</a></li>
            <li><a href="#using">Using</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Before learning Containerd we need to do a brief review of Docker&rsquo;s development history, because it involves a bit more components in practice, there are many we will often hear, but it is not clear what these components are really for, such as <code>libcontainer</code>, <code>runc</code>, <code>containerd</code>, <code>CRI</code>, <code>OCI</code> and so on.</p>
<h2 id="docker">Docker</h2>
<p>Since Docker 1.11, Docker containers are not simply started by Docker Daemon, but by integrating containerd, runc and other components to complete. Although the Docker Daemon daemon module has been constantly refactored, the basic functions and positioning have not changed much, and it has always been a CS architecture, where the daemon is responsible for interacting with the Docker Client side and managing Docker images and containers. In the current architecture, the component containerd is responsible for the lifecycle management of containers on cluster nodes and provides a gRPC interface to the Docker Daemon.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/01f175c1580842dd8fe71f89459a2d4d.png" alt=""></p>
<p>When we want to create a container, now Docker Daemon can&rsquo;t create it for us directly, but request <code>containerd</code> to create a container, after containerd receives the request, it doesn&rsquo;t operate the container directly, but creates a process called <code>containerd-shim</code>, and let this process operate the container. We specify that the container process needs a parent process to do state collection, maintain stdin and other fd open, etc. If the parent process is containerd, then if containerd hangs, all the containers on the whole host will have to exit, and the introduction of the <code>containerd-shim</code> shim can be used to circumvent this This problem can be circumvented by introducing the <code>containerd-shim</code> shim.</p>
<p>Then you need to do some configuration of namespaces and cgroups to create containers, and mount the root filesystem, etc. These operations actually have a standard specification, that is, OCI (Open Container Standard), <code>runc</code> is a reference implementation of it (Docker was forced to donate <code>libcontainer</code> and rename it to <code>runc</code>). <code>runc</code>, the standard is actually a document that specifies the structure of container images and the commands that containers need to receive, such as create, start, stop, delete, etc. <code>runc</code> can follow this OCI document to create a container in line with the specification, since it is a standard there must be other OCI implementations, such as Kata, gVisor, these containers runtime are in line with the OCI standard.</p>
<p>So the real start container is through <code>containerd-shim</code> to call <code>runc</code> to start the container, <code>runc</code> will exit directly after starting the container itself, <code>containerd-shim</code> will become the parent process of the container process, responsible for collecting the status of the container process, report to containerd, and take over the container&rsquo;s child processes to clean up after the exit of the process with pid 1, to ensure that no zombie processes.</p>
<p>Docker will migrate container operations to <code>containerd</code> because the current do Swarm, want to enter the PaaS market, do this architecture cut, let Docker Daemon is responsible for the upper layer of packaging orchestration, of course, the results we know Swarm in front of Kubernetes is a fiasco, and then Docker company <code>containerd</code> project donated to the CNCF Foundation, this is also the current Docker architecture.</p>
<h2 id="cri">CRI</h2>
<p>We know that Kubernetes provides a CRI container runtime interface, so what exactly is this CRI? This is actually closely related to the development of Docker.</p>
<p>In the early days of Kubernetes, when Docker was really hot, Kubernetes would of course choose to support Docker first, and call the Docker API directly by hard-coding. To support more and more streamlined container runtimes, Google and Red Hat led the introduction of the CRI standard to decouple the Kubernetes platform from specific container runtimes (mainly to kill Docker, of course).</p>
<p>The <code>CRI</code> (Container Runtime Interface) is essentially a set of interfaces defined by Kubernetes to interact with the container runtime, so any container runtime that implements this set of interfaces can be docked to the Kubernetes platform. However, when Kubernetes introduced the CRI standard, it was not as dominant as it is now, so some container runtimes may not implement the CRI interface themselves, so there is <code>shim (shim)</code>, a shim whose role is to act as an adapter to adapt various container runtimes' own interfaces to Kubernetes' CRI interface, where <code>dockershim</code> is a shim implementation for Kubernetes to adapt Docker to the CRI interface.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/75f708fe7ee44d0882f85969534d7752.png" alt=""></p>
<p>Kubelet communicates with the container runtime or shim through a gRPC framework, where kubelet acts as the client and CRI shim (and possibly the container runtime itself) acts as the server.</p>
<p>The CRI-defined API (<a href="https://github.com/kubernetes/kubernetes/blob/release-1.5/pkg/kubelet/api/v1alpha1/runtime/api.proto">https://github.com/kubernetes/kubernetes/blob/release-1.5/pkg/kubelet/api/v1alpha1/runtime/api.proto</a>) consists mainly of two gRPC services, <code>ImageService</code> and <code>RuntimeService</code>. The <code>ImageService</code> service is mainly used for operations such as pulling images, viewing and deleting images, while the <code>RuntimeService</code> is used for managing the lifecycle of Pods and containers, and for calls to interact with containers (exec/attach/port- forward), you can configure the sockets of these two services by using the flags <code>--container-runtime-endpoint</code> and <code>--image-service-endpoint</code> in the kubelet.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/c8229811d4584921a51d99d725c2ca6d.png" alt=""></p>
<p>However, there is also an exception here, that is, Docker, because Docker was a very high status, Kubernetes is directly built-in <code>dockershim</code> in the kubelet, so if you are using a container runtime such as Docker, you do not need to install a separate configuration adapter and so on, of course, this move also seems to paralyze the Docker company.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/4bff62f9ce2c47939235d51fee4b1b9a.png" alt=""></p>
<p>Now if we are using Docker, when we create a Pod in Kubernetes, the first thing that happens is that the kubelet calls <code>dockershim</code> through the CRI interface, requesting the creation of a container. kubelet can be seen as a simple CRI Client, and dockershim is the Server that receives the request, but they are both built into kubelet.</p>
<p>After <code>dockershim</code> receives the request, it is converted into a request that Docker Daemon can recognize, and sent to Docker Daemon to request the creation of a container, and after the request reaches Docker Daemon, it is the process of Docker creating a container, calling <code>containerd</code>, and then creating the <code>containerd-shim</code> process, which will call <code>runc</code> to actually create the container.</p>
<p>In fact, if we look closely, it is not difficult to find that the use of Docker is actually a long call chain, the real container-related operations in fact, containerd is completely sufficient, Docker is too complex and bulky, of course, Docker is popular for a large reason is to provide a lot of user-friendly features, but for Kubernetes to say that these features are not needed, because they are through the interface to operate the container, so naturally, you can switch the container runtime to containerd to.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/f89c3da91f4a4bb38ec0048ff830d3a2.png" alt=""></p>
<p>Switching to containerd eliminates the middle ground and the experience is the same as before, but because containers are dispatched directly with the container runtime, they are not visible to Docker. As a result, the Docker tools you used to inspect these containers are no longer available.</p>
<p>You can no longer use the <code>docker ps</code> or <code>docker inspect</code> commands to get container information. Since you can&rsquo;t list containers, you also can&rsquo;t get logs, stop containers, or even execute commands in containers with <code>docker exec</code>.</p>
<p>Of course, we can still download images or build images with the <code>docker build</code> command, but images built or downloaded with Docker are not visible to the container runtime or to Kubernetes. In order to use it in Kubernetes, the image needs to be pushed to the image repository.</p>
<p>As you can see above, in containerd 1.0, the adaptation of CRI is done through a separate <code>CRI-Containerd</code> process, because at the beginning containerd will also adapt other systems (such as swarm), so there is no direct implementation of CRI, so the interfacing is left to the <code>CRI-Containerd</code> shim. Containerd` shim.</p>
<p>Then after containerd 1.1, the <code>CRI-Containerd</code> shim was removed and the adaptation logic was integrated directly into the main containerd process as a plugin, which is now much cleaner to call.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/34612ffb005e432491d44b62abcaec93.png" alt=""></p>
<p>At the same time the Kubernetes community has made a CRI runtime <a href="https://cri-o.io/">CRI-O</a> specifically for Kubernetes that is directly compatible with the CRI and OCI specifications.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/f75649613fce4886ac4dcb4da9e69e6d.png" alt=""></p>
<p>This scheme and containerd&rsquo;s scheme are obviously much simpler than the default dockershim, but since most users are more used to using Docker, people still prefer to use the <code>dockershim</code> scheme.</p>
<p>However, as the CRI scheme evolved and other container runtimes became better at supporting CRI, the Kubernetes community started to remove the dockershim scheme in July 2020: <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2221-remove-dockershim">https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2221-remove-dockershim</a>, the removal plan is now to separate the built-in kubelet The goal is to release 1.23⁄1.24 without dockershim (the code is still there, but to support out-of-the-box docker by default you need to build it yourself). kubelet, which will remove the built-in dockershim generation from the kubelet after a grace period.</p>
<p>So does this mean that Kubernetes no longer supports Docker? Of course not, this is just a deprecation of the built-in <code>dockershim</code> function, Docker and other container runtime will be treated the same, will not treat the built-in support separately, if we still want to use the Docker container runtime directly what should we do? We can extract the dockershim function and maintain a separate <code>cri-dockerd</code>, similar to the <code>CRI-Containerd</code> provided in containerd version 1.0, and of course, there is another way to implement the CRI interface built into Dockerd by the official Docker community.</p>
<p>But we also know that Dockerd is also to directly call the Containerd, and containerd 1.1 version after the built-in implementation of CRI, so Docker is no longer necessary to implement CRI alone, when Kubernetes is no longer built-in support for out-of-the-box Docker, the best way is of course to directly use the When Kubernetes no longer supports Docker out-of-the-box, the best way is to use the container runtime Containerd, which has also been practiced in production environments, so let&rsquo;s learn how to use Containerd.</p>
<h2 id="containerd">Containerd</h2>
<p>We know that containerd has been part of the Docker Engine for a long time, but now it is separated from the Docker Engine as a separate open source project with the goal of providing a more open and stable container runtime infrastructure. The separated containerd will have more features, cover all the needs of the entire container runtime management, and provide more powerful support.</p>
<p>containerd is an industry standard container runtime that emphasizes <strong>simplicity</strong>, <strong>robustness</strong> and <strong>portability</strong>. containerd can be responsible for doing the following.</p>
<ul>
<li>Manage the container lifecycle (from container creation to container destruction)</li>
<li>Pulling/pushing container images</li>
<li>Storage management (managing the storage of images and container data)</li>
<li>Calling runc to run containers (interacting with container runtimes such as runc)</li>
<li>Managing container network interfaces and networks</li>
</ul>
<h3 id="architecture">Architecture</h3>
<p>containerd can be used as a daemon for Linux and Windows, managing the complete container lifecycle of its host system, from image transfer and storage to container execution and monitoring, to underlying storage to network attachments and more.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/02cb7ee710fa48309dd4f3cf9a4faf7f.png" alt=""></p>
<p>The above diagram is the official architecture provided by containerd, you can see that containerd is also using C/S architecture, the server side through the unix domain socket to expose the low-level gRPC API interface out, the client through these APIs to manage the containers on the node, each containerd is responsible for only one machine, Pull image Each containerd is responsible for only one machine, Pull image, operation of the container (start, stop, etc.), network, storage are all done by containerd. The specific running containers are runc&rsquo;s responsibility, and in fact any container that conforms to the OCI specification can be supported.</p>
<p>In order to decouple, containerd divides the system into different components, each of which is completed by one or more modules in collaboration (the Core part), each type of module is integrated into Containerd in the form of plugins, and the plugins are interdependent, for example, each long dashed box in the above figure indicates a type of plugin, including Each small box indicates a subdivision of the plugins, for example Metadata Plugin relies on Containers Plugin, Content Plugin, etc. For example:</p>
<ul>
<li><code>Content Plugin</code> : Provides access to addressable content in the image, where all immutable content is stored.</li>
<li><code>Snapshot Plugin</code> : Used to manage file system snapshots of container images, each layer of the image is decompressed into a file system snapshot, similar to the graphdriver in Docker.</li>
</ul>
<p>Overall containerd can be divided into three big blocks: Storage, Metadata and Runtime.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/6bb0c3b545aa4880b299808b8bb0a692.png" alt=""></p>
<h3 id="installation">Installation</h3>
<p>Here I am using <code>Linux Mint 20.2</code> and first need to install the <code>seccomp</code> dependency.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ apt-get update
➜  ~ apt-get install libseccomp2 -y
</code></pre></td></tr></table>
</div>
</div><p>Since containerd needs to call runc, we also need to install runc first, but containerd provides a zip archive containing the relevant dependencies <code>cri-containerd-cni-${VERSION}. ${OS}-${ARCH}.tar.gz</code>, which can be used directly for installation. First download the latest version of the archive from the <a href="https://github.com/containerd/containerd/releases">release page</a>, which is currently at version 1.5.5.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ wget https://github.com/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz
<span class="c1"># 如果有限制，也可以替换成下面的 URL 加速下载</span>
<span class="c1"># wget https://download.fastgit.org/containerd/containerd/releases/download/v1.5.5/cri-containerd-cni-1.5.5-linux-amd64.tar.gz</span>
</code></pre></td></tr></table>
</div>
</div><p>You can see directly which files are contained in the tarball with the <code>-t</code> option.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ tar -tf cri-containerd-cni-1.4.3-linux-amd64.tar.gz
etc/
etc/cni/
etc/cni/net.d/
etc/cni/net.d/10-containerd-net.conflist
etc/crictl.yaml
etc/systemd/
etc/systemd/system/
etc/systemd/system/containerd.service
usr/
usr/local/
usr/local/bin/
usr/local/bin/containerd-shim-runc-v2
usr/local/bin/ctr
usr/local/bin/containerd-shim
usr/local/bin/containerd-shim-runc-v1
usr/local/bin/crictl
usr/local/bin/critest
usr/local/bin/containerd
usr/local/sbin/
usr/local/sbin/runc
opt/
opt/cni/
opt/cni/bin/
opt/cni/bin/vlan
opt/cni/bin/host-local
opt/cni/bin/flannel
opt/cni/bin/bridge
opt/cni/bin/host-device
opt/cni/bin/tuning
opt/cni/bin/firewall
opt/cni/bin/bandwidth
opt/cni/bin/ipvlan
opt/cni/bin/sbr
opt/cni/bin/dhcp
opt/cni/bin/portmap
opt/cni/bin/ptp
opt/cni/bin/static
opt/cni/bin/macvlan
opt/cni/bin/loopback
opt/containerd/
opt/containerd/cluster/
opt/containerd/cluster/version
opt/containerd/cluster/gce/
opt/containerd/cluster/gce/cni.template
opt/containerd/cluster/gce/configure.sh
opt/containerd/cluster/gce/cloud-init/
opt/containerd/cluster/gce/cloud-init/master.yaml
opt/containerd/cluster/gce/cloud-init/node.yaml
opt/containerd/cluster/gce/env
</code></pre></td></tr></table>
</div>
</div><p>Unzip the package directly into each directory of the system</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ tar -C / -xzf cri-containerd-cni-1.5.5-linux-amd64.tar.gz
</code></pre></td></tr></table>
</div>
</div><p>Of course, remember to append <code>/usr/local/bin</code> and <code>/usr/local/sbin</code> to the <code>PATH</code> environment variable in the <code>~/.bashrc</code> file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/bin:/usr/local/sbin
</code></pre></td></tr></table>
</div>
</div><p>Then execute the following command to make it effective immediately.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ <span class="nb">source</span> ~/.bashrc
</code></pre></td></tr></table>
</div>
</div><p>The default configuration file for containerd is <code>/etc/containerd/config.toml</code> and we can generate a default configuration with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ mkdir /etc/containerd
➜  ~ containerd config default &gt; /etc/containerd/config.toml
</code></pre></td></tr></table>
</div>
</div><p>Since the containerd archive we downloaded above contains an <code>etc/systemd/system/containerd.service</code> file, we can configure containerd to run as a daemon via systemd, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">➜  ~ cat /etc/systemd/system/containerd.service
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd

Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
# Comment TasksMax if your systemd version does not supports it.
# Only systemd 226 and above support this version.
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
</code></pre></td></tr></table>
</div>
</div><p>There are two important parameters here.</p>
<ul>
<li><code>Delegate</code> : This option allows containerd as well as the runtime to manage its own cgroups for creating containers. if this option is not set, systemd will move the process to its own cgroups, which will result in containerd not getting the container&rsquo;s resource usage correctly.</li>
<li><code>KillMode</code> : This option is used to handle the way containerd processes are killed. By default, systemd will look in the process&rsquo;s cgroup and kill all of containerd&rsquo;s child processes. the values that can be set for the KillMode field are as follows.
<ul>
<li><code>control-group</code> (default): All child processes in the current control group will be killed.</li>
<li><code>process</code> : Only the main process will be killed.</li>
<li><code>mixed</code> : The main process will receive a SIGTERM signal and the child processes will receive a SIGKILL signal.</li>
<li><code>none</code> : no process will be killed, only the stop command of the service will be executed</li>
</ul>
</li>
</ul>
<p>We need to set the KillMode value to process to ensure that upgrading or restarting containerd does not kill the existing containers.</p>
<p>Now we can start containerd, just execute the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ systemctl <span class="nb">enable</span> containerd --now
</code></pre></td></tr></table>
</div>
</div><p>Once started, you can use containerd&rsquo;s native CLI tool <code>ctr</code>, for example to view the version</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/27/020c050abb22418b98fb7f6f07c78e32.png" alt=""></p>
<h3 id="configuration">Configuration</h3>
<p>Let&rsquo;s first look at the configuration file <code>/etc/containerd/config.toml</code> generated by default above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="nx">disabled_plugins</span> <span class="p">=</span> <span class="p">[]</span>
<span class="nx">imports</span> <span class="p">=</span> <span class="p">[]</span>
<span class="nx">oom_score</span> <span class="p">=</span> <span class="mi">0</span>
<span class="nx">plugin_dir</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
<span class="nx">required_plugins</span> <span class="p">=</span> <span class="p">[]</span>
<span class="nx">root</span> <span class="p">=</span> <span class="s2">&#34;/var/lib/containerd&#34;</span>
<span class="nx">state</span> <span class="p">=</span> <span class="s2">&#34;/run/containerd&#34;</span>
<span class="nx">version</span> <span class="p">=</span> <span class="mi">2</span>

<span class="p">[</span><span class="nx">cgroup</span><span class="p">]</span>
  <span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

<span class="p">[</span><span class="nx">debug</span><span class="p">]</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">gid</span> <span class="p">=</span> <span class="mi">0</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">uid</span> <span class="p">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="nx">grpc</span><span class="p">]</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;/run/containerd/containerd.sock&#34;</span>
  <span class="nx">gid</span> <span class="p">=</span> <span class="mi">0</span>
  <span class="nx">max_recv_message_size</span> <span class="p">=</span> <span class="mi">16777216</span>
  <span class="nx">max_send_message_size</span> <span class="p">=</span> <span class="mi">16777216</span>
  <span class="nx">tcp_address</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">tcp_tls_cert</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">tcp_tls_key</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">uid</span> <span class="p">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="nx">metrics</span><span class="p">]</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">grpc_histogram</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">plugins</span><span class="p">]</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.gc.v1.scheduler&#34;</span><span class="p">]</span>
    <span class="nx">deletion_threshold</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">mutation_threshold</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="nx">pause_threshold</span> <span class="p">=</span> <span class="mf">0.02</span>
    <span class="nx">schedule_delay</span> <span class="p">=</span> <span class="s2">&#34;0s&#34;</span>
    <span class="nx">startup_delay</span> <span class="p">=</span> <span class="s2">&#34;100ms&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">]</span>
    <span class="nx">disable_apparmor</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">disable_cgroup</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">disable_hugetlb_controller</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">disable_proc_mount</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">disable_tcp_service</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">enable_selinux</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">enable_tls_streaming</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">ignore_image_defined_volumes</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">max_concurrent_downloads</span> <span class="p">=</span> <span class="mi">3</span>
    <span class="nx">max_container_log_line_size</span> <span class="p">=</span> <span class="mi">16384</span>
    <span class="nx">netns_mounts_under_state_dir</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">restrict_oom_score_adj</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">sandbox_image</span> <span class="p">=</span> <span class="s2">&#34;k8s.gcr.io/pause:3.5&#34;</span>
    <span class="nx">selinux_category_range</span> <span class="p">=</span> <span class="mi">1024</span>
    <span class="nx">stats_collect_period</span> <span class="p">=</span> <span class="mi">10</span>
    <span class="nx">stream_idle_timeout</span> <span class="p">=</span> <span class="s2">&#34;4h0m0s&#34;</span>
    <span class="nx">stream_server_address</span> <span class="p">=</span> <span class="s2">&#34;127.0.0.1&#34;</span>
    <span class="nx">stream_server_port</span> <span class="p">=</span> <span class="s2">&#34;0&#34;</span>
    <span class="nx">systemd_cgroup</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">tolerate_missing_hugetlb_controller</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">unset_seccomp_profile</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">cni</span><span class="p">]</span>
      <span class="nx">bin_dir</span> <span class="p">=</span> <span class="s2">&#34;/opt/cni/bin&#34;</span>
      <span class="nx">conf_dir</span> <span class="p">=</span> <span class="s2">&#34;/etc/cni/net.d&#34;</span>
      <span class="nx">conf_template</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
      <span class="nx">max_conf_num</span> <span class="p">=</span> <span class="mi">1</span>

    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">]</span>
      <span class="nx">default_runtime_name</span> <span class="p">=</span> <span class="s2">&#34;runc&#34;</span>
      <span class="nx">disable_snapshot_annotations</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="nx">discard_unpacked_layers</span> <span class="p">=</span> <span class="kc">false</span>
      <span class="nx">no_pivot</span> <span class="p">=</span> <span class="kc">false</span>
      <span class="nx">snapshotter</span> <span class="p">=</span> <span class="s2">&#34;overlayfs&#34;</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">default_runtime</span><span class="p">]</span>
        <span class="nx">base_runtime_spec</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">container_annotations</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="nx">pod_annotations</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="nx">privileged_without_host_devices</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="nx">runtime_engine</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">runtime_root</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">runtime_type</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

        <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">default_runtime</span><span class="p">.</span><span class="nx">options</span><span class="p">]</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtimes</span><span class="p">]</span>

        <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtimes</span><span class="p">.</span><span class="nx">runc</span><span class="p">]</span>
          <span class="nx">base_runtime_spec</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
          <span class="nx">container_annotations</span> <span class="p">=</span> <span class="p">[]</span>
          <span class="nx">pod_annotations</span> <span class="p">=</span> <span class="p">[]</span>
          <span class="nx">privileged_without_host_devices</span> <span class="p">=</span> <span class="kc">false</span>
          <span class="nx">runtime_engine</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
          <span class="nx">runtime_root</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
          <span class="nx">runtime_type</span> <span class="p">=</span> <span class="s2">&#34;io.containerd.runc.v2&#34;</span>

          <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtimes</span><span class="p">.</span><span class="nx">runc</span><span class="p">.</span><span class="nx">options</span><span class="p">]</span>
            <span class="nx">BinaryName</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">CriuImagePath</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">CriuPath</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">CriuWorkPath</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">IoGid</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="nx">IoUid</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="nx">NoNewKeyring</span> <span class="p">=</span> <span class="kc">false</span>
            <span class="nx">NoPivotRoot</span> <span class="p">=</span> <span class="kc">false</span>
            <span class="nx">Root</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">ShimCgroup</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
            <span class="nx">SystemdCgroup</span> <span class="p">=</span> <span class="kc">false</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">untrusted_workload_runtime</span><span class="p">]</span>
        <span class="nx">base_runtime_spec</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">container_annotations</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="nx">pod_annotations</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="nx">privileged_without_host_devices</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="nx">runtime_engine</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">runtime_root</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
        <span class="nx">runtime_type</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

        <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">untrusted_workload_runtime</span><span class="p">.</span><span class="nx">options</span><span class="p">]</span>

    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">image_decryption</span><span class="p">]</span>
      <span class="nx">key_model</span> <span class="p">=</span> <span class="s2">&#34;node&#34;</span>

    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">]</span>
      <span class="nx">config_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">auths</span><span class="p">]</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">]</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">headers</span><span class="p">]</span>

      <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">]</span>

    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">x509_key_pair_streaming</span><span class="p">]</span>
      <span class="nx">tls_cert_file</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
      <span class="nx">tls_key_file</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.internal.v1.opt&#34;</span><span class="p">]</span>
    <span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;/opt/containerd&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.internal.v1.restart&#34;</span><span class="p">]</span>
    <span class="nx">interval</span> <span class="p">=</span> <span class="s2">&#34;10s&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.metadata.v1.bolt&#34;</span><span class="p">]</span>
    <span class="nx">content_sharing_policy</span> <span class="p">=</span> <span class="s2">&#34;shared&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.monitor.v1.cgroups&#34;</span><span class="p">]</span>
    <span class="nx">no_prometheus</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.runtime.v1.linux&#34;</span><span class="p">]</span>
    <span class="nx">no_shim</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">runtime</span> <span class="p">=</span> <span class="s2">&#34;runc&#34;</span>
    <span class="nx">runtime_root</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
    <span class="nx">shim</span> <span class="p">=</span> <span class="s2">&#34;containerd-shim&#34;</span>
    <span class="nx">shim_debug</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.runtime.v2.task&#34;</span><span class="p">]</span>
    <span class="nx">platforms</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;linux/amd64&#34;</span><span class="p">]</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.service.v1.diff-service&#34;</span><span class="p">]</span>
    <span class="nx">default</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;walking&#34;</span><span class="p">]</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.aufs&#34;</span><span class="p">]</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.btrfs&#34;</span><span class="p">]</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.devmapper&#34;</span><span class="p">]</span>
    <span class="nx">async_remove</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="nx">base_image_size</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
    <span class="nx">pool_name</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.native&#34;</span><span class="p">]</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.overlayfs&#34;</span><span class="p">]</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.snapshotter.v1.zfs&#34;</span><span class="p">]</span>
    <span class="nx">root_path</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>

<span class="p">[</span><span class="nx">proxy_plugins</span><span class="p">]</span>

<span class="p">[</span><span class="nx">stream_processors</span><span class="p">]</span>

  <span class="p">[</span><span class="nx">stream_processors</span><span class="p">.</span><span class="s2">&#34;io.containerd.ocicrypt.decoder.v1.tar&#34;</span><span class="p">]</span>
    <span class="nx">accepts</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;application/vnd.oci.image.layer.v1.tar+encrypted&#34;</span><span class="p">]</span>
    <span class="nx">args</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;--decryption-keys-path&#34;</span><span class="p">,</span> <span class="s2">&#34;/etc/containerd/ocicrypt/keys&#34;</span><span class="p">]</span>
    <span class="nx">env</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#34;</span><span class="p">]</span>
    <span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;ctd-decoder&#34;</span>
    <span class="nx">returns</span> <span class="p">=</span> <span class="s2">&#34;application/vnd.oci.image.layer.v1.tar&#34;</span>

  <span class="p">[</span><span class="nx">stream_processors</span><span class="p">.</span><span class="s2">&#34;io.containerd.ocicrypt.decoder.v1.tar.gzip&#34;</span><span class="p">]</span>
    <span class="nx">accepts</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&#34;</span><span class="p">]</span>
    <span class="nx">args</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;--decryption-keys-path&#34;</span><span class="p">,</span> <span class="s2">&#34;/etc/containerd/ocicrypt/keys&#34;</span><span class="p">]</span>
    <span class="nx">env</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#34;</span><span class="p">]</span>
    <span class="nx">path</span> <span class="p">=</span> <span class="s2">&#34;ctd-decoder&#34;</span>
    <span class="nx">returns</span> <span class="p">=</span> <span class="s2">&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span>

<span class="p">[</span><span class="nx">timeouts</span><span class="p">]</span>
  <span class="s2">&#34;io.containerd.timeout.shim.cleanup&#34;</span> <span class="p">=</span> <span class="s2">&#34;5s&#34;</span>
  <span class="s2">&#34;io.containerd.timeout.shim.load&#34;</span> <span class="p">=</span> <span class="s2">&#34;5s&#34;</span>
  <span class="s2">&#34;io.containerd.timeout.shim.shutdown&#34;</span> <span class="p">=</span> <span class="s2">&#34;3s&#34;</span>
  <span class="s2">&#34;io.containerd.timeout.task.state&#34;</span> <span class="p">=</span> <span class="s2">&#34;2s&#34;</span>

<span class="p">[</span><span class="nx">ttrpc</span><span class="p">]</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
  <span class="nx">gid</span> <span class="p">=</span> <span class="mi">0</span>
  <span class="nx">uid</span> <span class="p">=</span> <span class="mi">0</span>
</code></pre></td></tr></table>
</div>
</div><p>This configuration file is rather complicated, we can focus on the <code>plugins</code> configuration, look carefully we can find that each top configuration block is named in the form of <code>plugins. containerd.xxx.vx</code> indicates the type of the plugin, and <code>xxx</code> after <code>vx</code> indicates the ID of the plugin, and we can view the list of plugins via <code>ctr</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="err">➜</span>  <span class="err">~</span> <span class="nx">ctr</span> <span class="nx">plugin</span> <span class="nx">ls</span>
<span class="nx">ctr</span> <span class="nx">plugin</span> <span class="nx">ls</span>
<span class="nx">TYPE</span>                            <span class="nx">ID</span>                       <span class="nx">PLATFORMS</span>      <span class="nx">STATUS</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">content</span>                  <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">aufs</span>                     <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">btrfs</span>                    <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">skip</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">devmapper</span>                <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">error</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">native</span>                   <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">overlayfs</span>                <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">snapshotter</span><span class="p">.</span><span class="nx">v1</span>    <span class="nx">zfs</span>                      <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">skip</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">v1</span>       <span class="nx">bolt</span>                     <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">differ</span><span class="p">.</span><span class="nx">v1</span>         <span class="nx">walking</span>                  <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">gc</span><span class="p">.</span><span class="nx">v1</span>             <span class="nx">scheduler</span>                <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">introspection-service</span>    <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">containers-service</span>       <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">content-service</span>          <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">diff-service</span>             <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">images-service</span>           <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">leases-service</span>           <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">namespaces-service</span>       <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">snapshots-service</span>        <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">linux</span>                    <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">v2</span>        <span class="nx">task</span>                     <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">monitor</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">cgroups</span>                  <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">v1</span>        <span class="nx">tasks-service</span>            <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">v1</span>       <span class="nx">restart</span>                  <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">containers</span>               <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">content</span>                  <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">diff</span>                     <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">events</span>                   <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">healthcheck</span>              <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">images</span>                   <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">leases</span>                   <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">namespaces</span>               <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">internal</span><span class="p">.</span><span class="nx">v1</span>       <span class="nx">opt</span>                      <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">snapshots</span>                <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">tasks</span>                    <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">version</span>                  <span class="nx">-</span>              <span class="nx">ok</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">v1</span>           <span class="nx">cri</span>                      <span class="nx">linux</span><span class="err">/</span><span class="nx">amd64</span>    <span class="nx">ok</span>
</code></pre></td></tr></table>
</div>
</div><p>The sub-configuration blocks below the top-level configuration block represent various configurations of the plugin, for example, under the cri plugin there are configurations for containerd, cni and registry, and under containerd there are various runtimes that can be configured, as well as the default runtime. For example, if we want to configure an accelerator for a mirror, we need to configure <code>registry.mirrors</code> under the <code>registry</code> configuration block under the cri configuration block.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">.</span><span class="s2">&#34;docker.io&#34;</span><span class="p">]</span>
      <span class="nx">endpoint</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;https://bqr1dr1n.mirror.aliyuncs.com&#34;</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">.</span><span class="s2">&#34;k8s.gcr.io&#34;</span><span class="p">]</span>
      <span class="nx">endpoint</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;https://registry.aliyuncs.com/k8sxio&#34;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>egistry.mirrors. &quot;xxx&quot;</code> : Indicates the mirror repository that needs to be configured for mirror, e.g. <code>registry.mirrors. &quot;docker.io&quot;</code> means configure mirror for docker.io.</li>
<li><code>endpoint</code> : Indicates a mirror acceleration service that provides mirror, e.g. we can register an Aliyun mirror service as a mirror for docker.io.</li>
</ul>
<p>There are also two other configuration paths for storage in the default configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">root = &#34;/var/lib/containerd&#34;
state = &#34;/run/containerd&#34;
</code></pre></td></tr></table>
</div>
</div><p>Where <code>root</code> is used to store persistent data, including Snapshots, Content, Metadata and various plugin data, each plugin has its own separate directory, Containerd itself does not store any data, all its functions come from the loaded plugins.</p>
<p>The other <code>state</code> is used to store temporary runtime data, including sockets, pids, mount points, runtime state, and plugin data that does not need to be persisted.</p>
<h3 id="using">Using</h3>
<p>We know that the Docker CLI tool provides features to enhance the user experience, containerd also provides a corresponding CLI tool: <code>ctr</code>, but ctr is not as complete as docker, but the basic features about images and containers are there. Let&rsquo;s start with a brief introduction to the use of <code>ctr</code>.</p>
<h4 id="help">Help</h4>
<p>Directly enter the <code>ctr</code> command to get all the relevant operation command usage.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr
NAME:
   ctr -
        __
  _____/ /______
 / ___/ __/ ___/
/ /__/ /_/ /
<span class="se">\_</span>__/<span class="se">\_</span>_/_/

containerd CLI


USAGE:
   ctr <span class="o">[</span>global options<span class="o">]</span> <span class="nb">command</span> <span class="o">[</span><span class="nb">command</span> options<span class="o">]</span> <span class="o">[</span>arguments...<span class="o">]</span>

VERSION:
   v1.5.5

DESCRIPTION:

ctr is an unsupported debug and administrative client <span class="k">for</span> interacting
with the containerd daemon. Because it is unsupported, the commands,
options, and operations are not guaranteed to be backward compatible or
stable from release to release of the containerd project.

COMMANDS:
   plugins, plugin            provides information about containerd plugins
   version                    print the client and server versions
   containers, c, container   manage containers
   content                    manage content
   events, event              display containerd events
   images, image, i           manage images
   leases                     manage leases
   namespaces, namespace, ns  manage namespaces
   pprof                      provide golang pprof outputs <span class="k">for</span> containerd
   run                        run a container
   snapshots, snapshot        manage snapshots
   tasks, t, task             manage tasks
   install                    install a new package
   oci                        OCI tools
   shim                       interact with a shim directly
   help, h                    Shows a list of commands or <span class="nb">help</span> <span class="k">for</span> one <span class="nb">command</span>

GLOBAL OPTIONS:
   --debug                      <span class="nb">enable</span> debug output in logs
   --address value, -a value    address <span class="k">for</span> containerd<span class="err">&#39;</span>s GRPC server <span class="o">(</span>default: <span class="s2">&#34;/run/containerd/containerd.sock&#34;</span><span class="o">)</span> <span class="o">[</span><span class="nv">$CONTAINERD_ADDRESS</span><span class="o">]</span>
   --timeout value              total timeout <span class="k">for</span> ctr commands <span class="o">(</span>default: 0s<span class="o">)</span>
   --connect-timeout value      timeout <span class="k">for</span> connecting to containerd <span class="o">(</span>default: 0s<span class="o">)</span>
   --namespace value, -n value  namespace to use with commands <span class="o">(</span>default: <span class="s2">&#34;default&#34;</span><span class="o">)</span> <span class="o">[</span><span class="nv">$CONTAINERD_NAMESPACE</span><span class="o">]</span>
   --help, -h                   show <span class="nb">help</span>
   --version, -v                print the version
</code></pre></td></tr></table>
</div>
</div><h4 id="mirror-operation">Mirror operation</h4>
<h5 id="pull-mirror">Pull Mirror</h5>
<p>Pulling an image can be done using <code>ctr image pull</code>, for example, pulling the official Docker Hub image <code>nginx:alpine</code>, it should be noted that the image address needs to be added to the <code>docker.io</code> Host address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image pull docker.io/library/nginx:alpine
docker.io/library/nginx:alpine:                                                   resolved       <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
index-sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce:    exists         <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
manifest-sha256:ce6ca11a3fa7e0e6b44813901e3289212fc2f327ee8b1366176666e8fb470f24: <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:9a6ac07b84eb50935293bb185d0a8696d03247f74fd7d43ea6161dc0f293f81f:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:e82f830de071ebcda58148003698f32205b7970b01c58a197ac60d6bb79241b0:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:d7c9fa7589ae28cd3306b204d5dd9a539612593e35df70f7a1d69ff7548e74cf:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:bf2b3ee132db5b4c65432e53aca69da4e609c6cb154e0d0e14b2b02259e9c1e3:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
config-sha256:7ce0143dee376bfd2937b499a46fb110bda3c629c195b84b1cf6e19be1a9e23b:   <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:3c1eaf69ff492177c34bdbf1735b6f2e5400e417f8f11b98b0da878f4ecad5fb:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
layer-sha256:29291e31a76a7e560b9b7ad3cada56e8c18d50a96cca8a2573e4f4689d7aca77:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
elapsed: 11.9s                                                                    total:  8.7 Mi <span class="o">(</span>748.1 KiB/s<span class="o">)</span>
unpacking linux/amd64 sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce...
<span class="k">done</span>: 410.86624ms
</code></pre></td></tr></table>
</div>
</div><p>You can also use the <code>--platform</code> option to specify the image for the corresponding platform. Of course, there is also a command to push the image <code>ctr image push</code>, and if it is a private image, you can use <code>--user</code> to customize the username and password of the repository when pushing.</p>
<h5 id="list-local-mirrors">List local mirrors</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image ls
REF                            TYPE                                                      DIGEST                                                                  SIZE    PLATFORMS                                                                                LABELS
docker.io/library/nginx:alpine application/vnd.docker.distribution.manifest.list.v2+json sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce 9.5 MiB linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/ppc64le,linux/s390x -
➜  ~ ctr image ls -q
docker.io/library/nginx:alpine
</code></pre></td></tr></table>
</div>
</div><p>Use the <code>-q (--quiet)</code> option to print only the mirror name.</p>
<h5 id="detecting-local-mirrors">Detecting local mirrors</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image check
REF                            TYPE                                                      DIGEST                                                                  STATUS         SIZE            UNPACKED
docker.io/library/nginx:alpine application/vnd.docker.distribution.manifest.list.v2+json sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce <span class="nb">complete</span> <span class="o">(</span>7/7<span class="o">)</span> 9.5 MiB/9.5 MiB <span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><p>The main thing to look for is <code>STATUS</code>, where <code>complete</code> indicates that the image is in a fully available state.</p>
<h5 id="re-tagging">Re-tagging</h5>
<p>Similarly we can also re-tag the specified mirror with a Tag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image tag docker.io/library/nginx:alpine harbor.k8s.local/course/nginx:alpine
harbor.k8s.local/course/nginx:alpine
➜  ~ ctr image ls -q
docker.io/library/nginx:alpine
harbor.k8s.local/course/nginx:alpine
</code></pre></td></tr></table>
</div>
</div><h5 id="delete-mirror">Delete Mirror</h5>
<p>Images that are not needed can also be deleted using <code>ctr image rm</code>: <code>ctr image rm</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image rm harbor.k8s.local/course/nginx:alpine
harbor.k8s.local/course/nginx:alpine
➜  ~ ctr image ls -q
docker.io/library/nginx:alpine
</code></pre></td></tr></table>
</div>
</div><p>Adding the <code>-sync</code> option will synchronize the deletion of the image and all associated resources.</p>
<h5 id="mount-the-image-to-the-host-directory">Mount the image to the host directory</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image mount docker.io/library/nginx:alpine /mnt
sha256:c3554b2d61e3c1cffcaba4b4fa7651c644a3354efaafa2f22cb53542f6c600dc
/mnt
➜  ~ tree -L <span class="m">1</span> /mnt
/mnt
├── bin
├── dev
├── docker-entrypoint.d
├── docker-entrypoint.sh
├── etc
├── home
├── lib
├── media
├── mnt
├── opt
├── proc
├── root
├── run
├── sbin
├── srv
├── sys
├── tmp
├── usr
└── var

<span class="m">18</span> directories, <span class="m">1</span> file
</code></pre></td></tr></table>
</div>
</div><h5 id="uninstall-the-image-from-the-host-directory">Uninstall the image from the host directory</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image unmount /mnt
/mnt
</code></pre></td></tr></table>
</div>
</div><h5 id="export-the-image-as-a-zip-archive">Export the image as a zip archive</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image <span class="nb">export</span> nginx.tar.gz docker.io/library/nginx:alpine
</code></pre></td></tr></table>
</div>
</div><h5 id="importing-images-from-a-zip-archive">Importing images from a zip archive</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr image import nginx.tar.gz
</code></pre></td></tr></table>
</div>
</div><h4 id="container-operation">Container operation</h4>
<p>Container-related operations can be obtained with <code>ctr container</code>.</p>
<h5 id="create-container">Create container</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr container create docker.io/library/nginx:alpine nginx
</code></pre></td></tr></table>
</div>
</div><h5 id="list-containers">List containers</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr container ls
CONTAINER    IMAGE                             RUNTIME
nginx        docker.io/library/nginx:alpine    io.containerd.runc.v2
</code></pre></td></tr></table>
</div>
</div><p>The list can also be streamlined by adding the <code>-q</code> option.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr container ls -q
nginx
</code></pre></td></tr></table>
</div>
</div><h5 id="view-detailed-container-configuration">View detailed container configuration</h5>
<p>Similar to the <code>docker inspect</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr container info nginx
<span class="o">{</span>
    <span class="s2">&#34;ID&#34;</span>: <span class="s2">&#34;nginx&#34;</span>,
    <span class="s2">&#34;Labels&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;io.containerd.image.config.stop-signal&#34;</span>: <span class="s2">&#34;SIGQUIT&#34;</span>
    <span class="o">}</span>,
    <span class="s2">&#34;Image&#34;</span>: <span class="s2">&#34;docker.io/library/nginx:alpine&#34;</span>,
    <span class="s2">&#34;Runtime&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;Name&#34;</span>: <span class="s2">&#34;io.containerd.runc.v2&#34;</span>,
        <span class="s2">&#34;Options&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;type_url&#34;</span>: <span class="s2">&#34;containerd.runc.v1.Options&#34;</span>
        <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&#34;SnapshotKey&#34;</span>: <span class="s2">&#34;nginx&#34;</span>,
    <span class="s2">&#34;Snapshotter&#34;</span>: <span class="s2">&#34;overlayfs&#34;</span>,
    <span class="s2">&#34;CreatedAt&#34;</span>: <span class="s2">&#34;2021-08-12T08:23:13.792871558Z&#34;</span>,
    <span class="s2">&#34;UpdatedAt&#34;</span>: <span class="s2">&#34;2021-08-12T08:23:13.792871558Z&#34;</span>,
    <span class="s2">&#34;Extensions&#34;</span>: null,
    <span class="s2">&#34;Spec&#34;</span>: <span class="o">{</span>
......
</code></pre></td></tr></table>
</div>
</div><h5 id="delete-container">Delete container</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr container rm nginx
➜  ~ ctr container ls
CONTAINER    IMAGE    RUNTIME
</code></pre></td></tr></table>
</div>
</div><p>In addition to the <code>rm</code> subcommand, you can also use <code>delete</code> or <code>del</code> to delete containers.</p>
<h4 id="task">Task</h4>
<p>The container we created above with the <code>container create</code> command is not in a running state, it is just a static container. A container object only contains the resources and related configuration data needed to run a container, which means that namespaces, rootfs and container configuration have been initialized successfully, but the user process has not been started yet.</p>
<p>A container is really running by Task tasks, Task can set up the NIC for the container, and can also configure tools to monitor the container, etc.</p>
<p>Task related operations can be obtained through <code>ctr task</code>, as follows we start the container through Task.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task start -d nginx
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking <span class="k">for</span> shell scripts in /docker-entrypoint.d/
</code></pre></td></tr></table>
</div>
</div><p>After starting the container, you can view the running containers via <code>task ls</code>: <code>task ls</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task ls
TASK     PID     STATUS
nginx    <span class="m">3630</span>    RUNNING
</code></pre></td></tr></table>
</div>
</div><p>The same can be done with the <code>exec</code> command to access the container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task <span class="nb">exec</span> --exec-id <span class="m">0</span> -t nginx sh
/ <span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div><p>However, you should note that you must specify the <code>-exec-id</code> parameter, which can be written in any way you like, as long as it is unique.</p>
<p>Pause the container, similar to <code>-docker pause</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task pause nginx
</code></pre></td></tr></table>
</div>
</div><p>After the pause, the container status becomes <code>PAUSED</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task ls
TASK     PID     STATUS
nginx    <span class="m">3630</span>    PAUSED
</code></pre></td></tr></table>
</div>
</div><p>The container can also be restored using the <code>resume</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task resume nginx
➜  ~ ctr task ls
TASK     PID     STATUS
nginx    <span class="m">3630</span>    RUNNING
</code></pre></td></tr></table>
</div>
</div><p>However, it should be noted that ctr does not have the ability to stop containers, it can only pause or kill them. To kill a container, you can use the <code>task kill</code> command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task <span class="nb">kill</span> nginx
➜  ~ ctr task ls
TASK     PID     STATUS
nginx    <span class="m">3630</span>    STOPPED
</code></pre></td></tr></table>
</div>
</div><p>After killing the container, you can see that the status of the container has changed to <code>STOPPED</code>. You can also delete Task by using the <code>task rm</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task rm nginx
➜  ~ ctr task ls
TASK    PID    STATUS
</code></pre></td></tr></table>
</div>
</div><p>In addition, we can also get information about the container&rsquo;s cgroup, which can be used to get the container&rsquo;s memory, CPU and PID limits and usage using the <code>task metrics</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 重新启动容器</span>
➜  ~ ctr task metrics nginx
ID       TIMESTAMP
nginx    2021-08-12 08:50:46.952769941 +0000 UTC

METRIC                   VALUE
memory.usage_in_bytes    <span class="m">8855552</span>
memory.limit_in_bytes    <span class="m">9223372036854771712</span>
memory.stat.cache        <span class="m">0</span>
cpuacct.usage            <span class="m">22467106</span>
cpuacct.usage_percpu     <span class="o">[</span><span class="m">2962708</span> <span class="m">860891</span> <span class="m">1163413</span> <span class="m">1915748</span> <span class="m">1058868</span> <span class="m">2888139</span> <span class="m">6159277</span> 5458062<span class="o">]</span>
pids.current             <span class="m">9</span>
pids.limit               <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><p>You can also use the <code>task ps</code> command to view the PIDs of all processes in the container on the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr task ps nginx
PID     INFO
<span class="m">3984</span>    -
<span class="m">4029</span>    -
<span class="m">4030</span>    -
<span class="m">4031</span>    -
<span class="m">4032</span>    -
<span class="m">4033</span>    -
<span class="m">4034</span>    -
<span class="m">4035</span>    -
<span class="m">4036</span>    -
➜  ~ ctr task ls
TASK     PID     STATUS
nginx    <span class="m">3984</span>    RUNNING
</code></pre></td></tr></table>
</div>
</div><p>The first of these PIDs <code>3984</code> is process #1 in our container.</p>
<h4 id="namespace">Namespace</h4>
<p>Also the concept of namespaces is supported in Containerd, e.g. to view namespaces.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr ns ls
NAME    LABELS
default
</code></pre></td></tr></table>
</div>
</div><p>If not specified, ctr defaults to using the <code>default</code> space. A namespace can also be created using the <code>ns create</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr ns create <span class="nb">test</span>
➜  ~ ctr ns ls
NAME    LABELS
default
<span class="nb">test</span>
</code></pre></td></tr></table>
</div>
</div><p>Namespace can be deleted using <code>remove</code> or <code>rm</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr ns rm <span class="nb">test</span>
<span class="nb">test</span>
➜  ~ ctr ns ls
NAME    LABELS
default
</code></pre></td></tr></table>
</div>
</div><p>With namespaces you can specify namespace when manipulating resources, for example, to view a mirror of the test namespace, you can add the <code>-n test</code> option to the action command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr -n <span class="nb">test</span> image ls
REF TYPE DIGEST SIZE PLATFORMS LABELS
</code></pre></td></tr></table>
</div>
</div><p>We know that Docker actually calls containerd by default, and in fact the namespace under containerd used by Docker is <code>moby</code> by default, not <code>default</code>, so if we start a container with docker, we can also use <code>ctr -n moby</code> to locate the following container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">➜  ~ ctr -n moby container ls
</code></pre></td></tr></table>
</div>
</div><p>Also the default namespace for containerd used under Kubernetes is <code>k8s.io</code>, so we can use <code>ctr -n k8s.io</code> to see the containers created under Kubernetes. We&rsquo;ll cover how to switch the container runtime of a Kubernetes cluster to <code>containerd</code> later.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/use-kube-vip-ha-k8s-lb/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Building a Highly Available Kubernetes Cluster with kube-vip</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/overlay2-on-package-pipline/">
            <span class="next-text nav-default">Application of overlay2 in a packaged release pipeline</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
